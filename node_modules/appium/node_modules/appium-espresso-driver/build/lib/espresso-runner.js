"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.TEST_APK_PKG = exports.REQUIRED_PARAMS = exports.EspressoRunner = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("./logger"));

var _serverBuilder = _interopRequireDefault(require("./server-builder"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _package = require("../../package.json");

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

var _utils = require("./utils");

const TEST_SERVER_ROOT = _path.default.resolve(__dirname, '..', '..', 'espresso-server');

const TEST_MANIFEST_PATH = _path.default.resolve(TEST_SERVER_ROOT, 'AndroidManifest-test.xml');

const TEST_APK_PKG = 'io.appium.espressoserver.test';
exports.TEST_APK_PKG = TEST_APK_PKG;
const REQUIRED_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort', 'appPackage', 'forceEspressoRebuild'];
exports.REQUIRED_PARAMS = REQUIRED_PARAMS;
const ESPRESSO_SERVER_LAUNCH_TIMEOUT = 30000;
const TARGET_PACKAGE_CONTAINER = '/data/local/tmp/espresso.apppackage';

class EspressoRunner {
  constructor(opts = {}) {
    for (let req of REQUIRED_PARAMS) {
      if (!opts || !_appiumSupport.util.hasValue(opts[req])) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.host,
      port: this.systemPort,
      base: '',
      keepAlive: true
    });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    this.modServerPath = _path.default.resolve(this.tmpDir, `${TEST_APK_PKG}_${_package.version}_${this.appPackage}.apk`);
    this.showGradleLog = opts.showGradleLog;
    this.espressoBuildConfig = opts.espressoBuildConfig;
    this.serverLaunchTimeout = opts.serverLaunchTimeout || ESPRESSO_SERVER_LAUNCH_TIMEOUT;
    this.androidInstallTimeout = opts.androidInstallTimeout;
  }

  async isAppPackageChanged() {
    if (!(await this.adb.fileExists(TARGET_PACKAGE_CONTAINER))) {
      _logger.default.debug('The previous target application package is unknown');

      return true;
    }

    const previousAppPackage = (await this.adb.shell(['cat', TARGET_PACKAGE_CONTAINER])).trim();

    _logger.default.debug(`The previous target application package was '${previousAppPackage}'. ` + `The current package is '${this.appPackage}'`);

    return previousAppPackage !== this.appPackage;
  }

  async installServer() {
    const appState = await this.adb.getApplicationInstallState(this.modServerPath, TEST_APK_PKG);
    const shouldUninstallApp = [this.adb.APP_INSTALL_STATE.OLDER_VERSION_INSTALLED, this.adb.APP_INSTALL_STATE.NEWER_VERSION_INSTALLED].includes(appState);
    const shouldInstallApp = shouldUninstallApp || [this.adb.APP_INSTALL_STATE.NOT_INSTALLED].includes(appState);

    if (shouldUninstallApp) {
      _logger.default.info(`Uninstalling Espresso Test Server apk from the target device (pkg: '${TEST_APK_PKG}')`);

      try {
        await this.adb.uninstallApk(TEST_APK_PKG);
      } catch (err) {
        _logger.default.warn(`Error uninstalling '${TEST_APK_PKG}': ${err.message}`);
      }
    }

    if (shouldInstallApp) {
      _logger.default.info(`Installing Espresso Test Server apk from the target device (path: '${this.modServerPath}')`);

      try {
        await this.adb.install(this.modServerPath, {
          replace: false,
          timeout: this.androidInstallTimeout
        });

        _logger.default.info(`Installed Espresso Test Server apk '${this.modServerPath}' (pkg: '${TEST_APK_PKG}')`);
      } catch (err) {
        _logger.default.errorAndThrow(`Cannot install '${this.modServerPath}' because of '${err.message}'`);
      }
    }
  }

  async installTestApk() {
    let rebuild = this.forceEspressoRebuild;

    if (rebuild) {
      _logger.default.debug(`'forceEspressoRebuild' capability is enabled`);
    } else if (await this.isAppPackageChanged()) {
      _logger.default.info(`Forcing Espresso server rebuild because of changed application package`);

      rebuild = true;
    }

    if (rebuild && (await _appiumSupport.fs.exists(this.modServerPath))) {
      _logger.default.debug(`Deleting the obsolete Espresso server package '${this.modServerPath}'`);

      await _appiumSupport.fs.unlink(this.modServerPath);
    }

    if (!(await _appiumSupport.fs.exists(this.modServerPath))) {
      await this.buildNewModServer();
    }

    const isSigned = await this.adb.checkApkCert(this.modServerPath, TEST_APK_PKG);

    if (!isSigned) {
      await this.adb.sign(this.modServerPath);
    }

    if ((rebuild || !isSigned) && (await this.adb.uninstallApk(TEST_APK_PKG))) {
      _logger.default.info('Uninstalled the obsolete Espresso server package from the device under test');
    }

    await this.installServer();
  }

  async buildNewModServer() {
    let buildConfiguration = {};

    if (this.espressoBuildConfig) {
      _logger.default.info(`Using build configuration JSON from: '${this.espressoBuildConfig}'`);

      try {
        buildConfiguration = JSON.parse((await _appiumSupport.fs.readFile(this.espressoBuildConfig, 'utf8')));
      } catch (e) {
        _logger.default.error('Failed to parse build configuration JSON', e);

        throw e;
      }
    }

    _logger.default.info('Building espresso server');

    const serverPath = _path.default.resolve(this.tmpDir, 'espresso-server');

    _logger.default.debug(`build dir: ${serverPath}`);

    await _appiumSupport.fs.rimraf(serverPath);
    await (0, _appiumSupport.mkdirp)(serverPath);

    _logger.default.debug(`Copying espresso server template from (${TEST_SERVER_ROOT} to ${serverPath})`);

    await (0, _utils.copyGradleProjectRecursively)(TEST_SERVER_ROOT, serverPath);
    await new _serverBuilder.default({
      serverPath,
      buildConfiguration,
      showGradleLog: this.showGradleLog
    }).build();

    const apkPath = _path.default.resolve(serverPath, 'app', 'build', 'outputs', 'apk', 'androidTest', 'debug', 'app-debug-androidTest.apk');

    _logger.default.info(`Repackaging espresso server for: '${this.appPackage}'`);

    const packageTmpDir = _path.default.resolve(this.tmpDir, this.appPackage);

    const newManifestPath = _path.default.resolve(this.tmpDir, 'AndroidManifest.xml');

    await _appiumSupport.fs.rimraf(newManifestPath);

    _logger.default.info(`Creating new manifest: '${newManifestPath}'`);

    await (0, _appiumSupport.mkdirp)(packageTmpDir);
    await _appiumSupport.fs.copyFile(TEST_MANIFEST_PATH, newManifestPath);
    await this.adb.compileManifest(newManifestPath, TEST_APK_PKG, this.appPackage);
    await this.adb.insertManifest(newManifestPath, apkPath, this.modServerPath);

    _logger.default.info(`Repackaged espresso server ready: '${this.modServerPath}'`);
  }

  async cleanupSessionLeftovers() {
    _logger.default.debug('Performing cleanup of automation leftovers');

    try {
      const {
        value
      } = await _requestPromise.default.get({
        url: `http://${this.host}:${this.systemPort}/sessions`,
        timeout: 500,
        json: true
      });
      const activeSessionIds = value.map(sess => sess.id);

      if (activeSessionIds.length) {
        _logger.default.debug(`The following obsolete sessions are still running: ${JSON.stringify(activeSessionIds)}`);

        _logger.default.debug('Cleaning up the obsolete sessions');

        await _bluebird.default.all(activeSessionIds.map(id => _requestPromise.default.delete({
          url: `http://${this.host}:${this.systemPort}/session/${id}`
        })));
        await _bluebird.default.delay(1000);
      } else {
        _logger.default.debug('No obsolete sessions have been detected');
      }
    } catch (e) {
      _logger.default.debug(`No obsolete sessions have been detected (${e.message})`);
    }
  }

  async startSession(caps) {
    await this.cleanupSessionLeftovers();
    const cmd = ['shell', 'am', 'instrument', '-w', '-e', 'debug', process.env.ESPRESSO_JAVA_DEBUG === 'true' ? 'true' : 'false', `${TEST_APK_PKG}/androidx.test.runner.AndroidJUnitRunner`];

    _logger.default.info(`Starting Espresso Server v${_package.version} with cmd: adb ${cmd.join(' ')}`);

    let hasSocketError = false;
    this.instProcess = this.adb.createSubProcess(cmd);
    this.instProcess.on('exit', (code, signal) => {
      _logger.default.info(`Instrumentation process exited with code ${code} from signal ${signal}`);
    });
    this.instProcess.on('die', (code, signal) => {
      _logger.default.error(`Instrumentation process died with code ${code} and signal ${signal}`);
    });
    this.instProcess.on('stream-line', line => {
      if (_lodash.default.isEmpty(line.trim())) {
        return;
      }

      _logger.default.debug(`[Instrumentation] ${line.trim()}`);

      if (line.toLowerCase().includes('java.net.socketexception')) {
        hasSocketError = true;
      }
    });
    await this.instProcess.start((stdout, stderr) => {
      const out = stdout.trim() || stderr.trim();

      if (out.includes('io.appium.espressoserver.EspressoServerRunnerTest:')) {
        return true;
      }

      if (out.toLowerCase().includes('exception')) {
        throw new Error(out);
      }
    }, this.serverLaunchTimeout);

    _logger.default.info('Waiting for Espresso to be online...');

    try {
      await (0, _asyncbox.retryInterval)(20, 1000, async () => {
        await this.jwproxy.command('/status', 'GET');
      });
    } catch (e) {
      if (hasSocketError) {
        _logger.default.errorAndThrow(`Timed out waiting for Espresso Server to start due to Socket exception. Espresso Server requires the 'INTERNET' permission to be set in the Android manifest for the app-under-test (<uses-permission android:name="android.permission.INTERNET" />)`);
      } else {
        _logger.default.errorAndThrow(`Timed out waiting for Espresso Server to start. Original error: ${e.message}`);
      }
    }

    await this.jwproxy.command('/session', 'POST', {
      capabilities: {
        firstMatch: [caps],
        alwaysMatch: {}
      }
    });
    await this.recordTargetAppPackage();
  }

  async recordTargetAppPackage() {
    await this.adb.shell([`echo "${this.appPackage}" > "${TARGET_PACKAGE_CONTAINER}"`]);

    _logger.default.info(`Recorded the target application package '${this.appPackage}' to ${TARGET_PACKAGE_CONTAINER}`);
  }

  async deleteSession() {
    _logger.default.debug('Deleting Espresso server session');

    try {
      await this.jwproxy.command('/', 'DELETE');
    } catch (err) {
      _logger.default.warn(`Did not get confirmation Espresso deleteSession worked; ` + `Error was: ${err}`);
    }

    if (this.instProcess && this.instProcess.isRunning) {
      await this.instProcess.stop();
    }
  }

}

exports.EspressoRunner = EspressoRunner;
var _default = EspressoRunner;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9lc3ByZXNzby1ydW5uZXIuanMiXSwibmFtZXMiOlsiVEVTVF9TRVJWRVJfUk9PVCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiVEVTVF9NQU5JRkVTVF9QQVRIIiwiVEVTVF9BUEtfUEtHIiwiUkVRVUlSRURfUEFSQU1TIiwiRVNQUkVTU09fU0VSVkVSX0xBVU5DSF9USU1FT1VUIiwiVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSIiwiRXNwcmVzc29SdW5uZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJyZXEiLCJ1dGlsIiwiaGFzVmFsdWUiLCJFcnJvciIsImp3cHJveHkiLCJKV1Byb3h5Iiwic2VydmVyIiwiaG9zdCIsInBvcnQiLCJzeXN0ZW1Qb3J0IiwiYmFzZSIsImtlZXBBbGl2ZSIsInByb3h5UmVxUmVzIiwiYmluZCIsIm1vZFNlcnZlclBhdGgiLCJ0bXBEaXIiLCJ2ZXJzaW9uIiwiYXBwUGFja2FnZSIsInNob3dHcmFkbGVMb2ciLCJlc3ByZXNzb0J1aWxkQ29uZmlnIiwic2VydmVyTGF1bmNoVGltZW91dCIsImFuZHJvaWRJbnN0YWxsVGltZW91dCIsImlzQXBwUGFja2FnZUNoYW5nZWQiLCJhZGIiLCJmaWxlRXhpc3RzIiwibG9nZ2VyIiwiZGVidWciLCJwcmV2aW91c0FwcFBhY2thZ2UiLCJzaGVsbCIsInRyaW0iLCJpbnN0YWxsU2VydmVyIiwiYXBwU3RhdGUiLCJnZXRBcHBsaWNhdGlvbkluc3RhbGxTdGF0ZSIsInNob3VsZFVuaW5zdGFsbEFwcCIsIkFQUF9JTlNUQUxMX1NUQVRFIiwiT0xERVJfVkVSU0lPTl9JTlNUQUxMRUQiLCJORVdFUl9WRVJTSU9OX0lOU1RBTExFRCIsImluY2x1ZGVzIiwic2hvdWxkSW5zdGFsbEFwcCIsIk5PVF9JTlNUQUxMRUQiLCJpbmZvIiwidW5pbnN0YWxsQXBrIiwiZXJyIiwid2FybiIsIm1lc3NhZ2UiLCJpbnN0YWxsIiwicmVwbGFjZSIsInRpbWVvdXQiLCJlcnJvckFuZFRocm93IiwiaW5zdGFsbFRlc3RBcGsiLCJyZWJ1aWxkIiwiZm9yY2VFc3ByZXNzb1JlYnVpbGQiLCJmcyIsImV4aXN0cyIsInVubGluayIsImJ1aWxkTmV3TW9kU2VydmVyIiwiaXNTaWduZWQiLCJjaGVja0Fwa0NlcnQiLCJzaWduIiwiYnVpbGRDb25maWd1cmF0aW9uIiwiSlNPTiIsInBhcnNlIiwicmVhZEZpbGUiLCJlIiwiZXJyb3IiLCJzZXJ2ZXJQYXRoIiwicmltcmFmIiwiU2VydmVyQnVpbGRlciIsImJ1aWxkIiwiYXBrUGF0aCIsInBhY2thZ2VUbXBEaXIiLCJuZXdNYW5pZmVzdFBhdGgiLCJjb3B5RmlsZSIsImNvbXBpbGVNYW5pZmVzdCIsImluc2VydE1hbmlmZXN0IiwiY2xlYW51cFNlc3Npb25MZWZ0b3ZlcnMiLCJ2YWx1ZSIsInJlcXVlc3QiLCJnZXQiLCJ1cmwiLCJqc29uIiwiYWN0aXZlU2Vzc2lvbklkcyIsIm1hcCIsInNlc3MiLCJpZCIsImxlbmd0aCIsInN0cmluZ2lmeSIsIkIiLCJhbGwiLCJkZWxldGUiLCJkZWxheSIsInN0YXJ0U2Vzc2lvbiIsImNhcHMiLCJjbWQiLCJwcm9jZXNzIiwiZW52IiwiRVNQUkVTU09fSkFWQV9ERUJVRyIsImpvaW4iLCJoYXNTb2NrZXRFcnJvciIsImluc3RQcm9jZXNzIiwiY3JlYXRlU3ViUHJvY2VzcyIsIm9uIiwiY29kZSIsInNpZ25hbCIsImxpbmUiLCJfIiwiaXNFbXB0eSIsInRvTG93ZXJDYXNlIiwic3RhcnQiLCJzdGRvdXQiLCJzdGRlcnIiLCJvdXQiLCJjb21tYW5kIiwiY2FwYWJpbGl0aWVzIiwiZmlyc3RNYXRjaCIsImFsd2F5c01hdGNoIiwicmVjb3JkVGFyZ2V0QXBwUGFja2FnZSIsImRlbGV0ZVNlc3Npb24iLCJpc1J1bm5pbmciLCJzdG9wIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLGdCQUFnQixH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R0FBSSxFQUR0QjtBQUVEOztBQUVELFFBQUksS0FBS3lELFdBQUwsSUFBb0IsS0FBS0EsV0FBTCxDQUFpQm1CLFNBQXpDLEVBQW9EO0FBQ2xELFlBQU0sS0FBS25CLFdBQUwsQ0FBaUJvQixJQUFqQixFQUFOO0FBQ0Q7QUFDRjs7QUE3UGtCOzs7ZUFpUU4xSCxjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSldQcm94eSB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgU2VydmVyQnVpbGRlciBmcm9tICcuL3NlcnZlci1idWlsZGVyJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZnMsIHV0aWwsIG1rZGlycCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IHZlcnNpb24gfSBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGltcG9ydC9uby11bnJlc29sdmVkXG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGNvcHlHcmFkbGVQcm9qZWN0UmVjdXJzaXZlbHkgfSBmcm9tICcuL3V0aWxzJztcblxuXG5jb25zdCBURVNUX1NFUlZFUl9ST09UID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ2VzcHJlc3NvLXNlcnZlcicpO1xuY29uc3QgVEVTVF9NQU5JRkVTVF9QQVRIID0gcGF0aC5yZXNvbHZlKFRFU1RfU0VSVkVSX1JPT1QsICdBbmRyb2lkTWFuaWZlc3QtdGVzdC54bWwnKTtcbmNvbnN0IFRFU1RfQVBLX1BLRyA9ICdpby5hcHBpdW0uZXNwcmVzc29zZXJ2ZXIudGVzdCc7XG5jb25zdCBSRVFVSVJFRF9QQVJBTVMgPSBbJ2FkYicsICd0bXBEaXInLCAnaG9zdCcsICdzeXN0ZW1Qb3J0JywgJ2RldmljZVBvcnQnLCAnYXBwUGFja2FnZScsICdmb3JjZUVzcHJlc3NvUmVidWlsZCddO1xuY29uc3QgRVNQUkVTU09fU0VSVkVSX0xBVU5DSF9USU1FT1VUID0gMzAwMDA7XG5jb25zdCBUQVJHRVRfUEFDS0FHRV9DT05UQUlORVIgPSAnL2RhdGEvbG9jYWwvdG1wL2VzcHJlc3NvLmFwcHBhY2thZ2UnO1xuXG5jbGFzcyBFc3ByZXNzb1J1bm5lciB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBmb3IgKGxldCByZXEgb2YgUkVRVUlSRURfUEFSQU1TKSB7XG4gICAgICBpZiAoIW9wdHMgfHwgIXV0aWwuaGFzVmFsdWUob3B0c1tyZXFdKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE9wdGlvbiAnJHtyZXF9JyBpcyByZXF1aXJlZCFgKTtcbiAgICAgIH1cbiAgICAgIHRoaXNbcmVxXSA9IG9wdHNbcmVxXTtcbiAgICB9XG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEpXUHJveHkoe1xuICAgICAgc2VydmVyOiB0aGlzLmhvc3QsXG4gICAgICBwb3J0OiB0aGlzLnN5c3RlbVBvcnQsXG4gICAgICBiYXNlOiAnJyxcbiAgICAgIGtlZXBBbGl2ZTogdHJ1ZSxcbiAgICB9KTtcbiAgICB0aGlzLnByb3h5UmVxUmVzID0gdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzLmJpbmQodGhpcy5qd3Byb3h5KTtcblxuICAgIHRoaXMubW9kU2VydmVyUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLnRtcERpciwgYCR7VEVTVF9BUEtfUEtHfV8ke3ZlcnNpb259XyR7dGhpcy5hcHBQYWNrYWdlfS5hcGtgKTtcbiAgICB0aGlzLnNob3dHcmFkbGVMb2cgPSBvcHRzLnNob3dHcmFkbGVMb2c7XG4gICAgdGhpcy5lc3ByZXNzb0J1aWxkQ29uZmlnID0gb3B0cy5lc3ByZXNzb0J1aWxkQ29uZmlnO1xuXG4gICAgdGhpcy5zZXJ2ZXJMYXVuY2hUaW1lb3V0ID0gb3B0cy5zZXJ2ZXJMYXVuY2hUaW1lb3V0IHx8IEVTUFJFU1NPX1NFUlZFUl9MQVVOQ0hfVElNRU9VVDtcbiAgICB0aGlzLmFuZHJvaWRJbnN0YWxsVGltZW91dCA9IG9wdHMuYW5kcm9pZEluc3RhbGxUaW1lb3V0O1xuICB9XG5cbiAgYXN5bmMgaXNBcHBQYWNrYWdlQ2hhbmdlZCAoKSB7XG4gICAgaWYgKCFhd2FpdCB0aGlzLmFkYi5maWxlRXhpc3RzKFRBUkdFVF9QQUNLQUdFX0NPTlRBSU5FUikpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZygnVGhlIHByZXZpb3VzIHRhcmdldCBhcHBsaWNhdGlvbiBwYWNrYWdlIGlzIHVua25vd24nKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBjb25zdCBwcmV2aW91c0FwcFBhY2thZ2UgPSAoYXdhaXQgdGhpcy5hZGIuc2hlbGwoWydjYXQnLCBUQVJHRVRfUEFDS0FHRV9DT05UQUlORVJdKSkudHJpbSgpO1xuICAgIGxvZ2dlci5kZWJ1ZyhgVGhlIHByZXZpb3VzIHRhcmdldCBhcHBsaWNhdGlvbiBwYWNrYWdlIHdhcyAnJHtwcmV2aW91c0FwcFBhY2thZ2V9Jy4gYCArXG4gICAgICBgVGhlIGN1cnJlbnQgcGFja2FnZSBpcyAnJHt0aGlzLmFwcFBhY2thZ2V9J2ApO1xuICAgIHJldHVybiBwcmV2aW91c0FwcFBhY2thZ2UgIT09IHRoaXMuYXBwUGFja2FnZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnN0YWxscyBFc3ByZXNzbyBzZXJ2ZXIgYXBrIG9uIHRvIHRoZSBkZXZpY2Ugb3IgZW11bGF0b3IuXG4gICAqIEVhY2ggYWRiIGNvbW1hbmQgdXNlcyBkZWZhdWx0IHRpbWVvdXQgYnkgdGhlbS5cbiAgICovXG4gIGFzeW5jIGluc3RhbGxTZXJ2ZXIgKCkge1xuICAgIGNvbnN0IGFwcFN0YXRlID0gYXdhaXQgdGhpcy5hZGIuZ2V0QXBwbGljYXRpb25JbnN0YWxsU3RhdGUodGhpcy5tb2RTZXJ2ZXJQYXRoLCBURVNUX0FQS19QS0cpO1xuXG4gICAgY29uc3Qgc2hvdWxkVW5pbnN0YWxsQXBwID0gW1xuICAgICAgdGhpcy5hZGIuQVBQX0lOU1RBTExfU1RBVEUuT0xERVJfVkVSU0lPTl9JTlNUQUxMRUQsXG4gICAgICB0aGlzLmFkYi5BUFBfSU5TVEFMTF9TVEFURS5ORVdFUl9WRVJTSU9OX0lOU1RBTExFRFxuICAgIF0uaW5jbHVkZXMoYXBwU3RhdGUpO1xuICAgIGNvbnN0IHNob3VsZEluc3RhbGxBcHAgPSBzaG91bGRVbmluc3RhbGxBcHAgfHwgW1xuICAgICAgdGhpcy5hZGIuQVBQX0lOU1RBTExfU1RBVEUuTk9UX0lOU1RBTExFRFxuICAgIF0uaW5jbHVkZXMoYXBwU3RhdGUpO1xuXG4gICAgaWYgKHNob3VsZFVuaW5zdGFsbEFwcCkge1xuICAgICAgbG9nZ2VyLmluZm8oYFVuaW5zdGFsbGluZyBFc3ByZXNzbyBUZXN0IFNlcnZlciBhcGsgZnJvbSB0aGUgdGFyZ2V0IGRldmljZSAocGtnOiAnJHtURVNUX0FQS19QS0d9JylgKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYWRiLnVuaW5zdGFsbEFwayhURVNUX0FQS19QS0cpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxvZ2dlci53YXJuKGBFcnJvciB1bmluc3RhbGxpbmcgJyR7VEVTVF9BUEtfUEtHfSc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHNob3VsZEluc3RhbGxBcHApIHtcbiAgICAgIGxvZ2dlci5pbmZvKGBJbnN0YWxsaW5nIEVzcHJlc3NvIFRlc3QgU2VydmVyIGFwayBmcm9tIHRoZSB0YXJnZXQgZGV2aWNlIChwYXRoOiAnJHt0aGlzLm1vZFNlcnZlclBhdGh9JylgKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYWRiLmluc3RhbGwodGhpcy5tb2RTZXJ2ZXJQYXRoLCB7IHJlcGxhY2U6IGZhbHNlLCB0aW1lb3V0OiB0aGlzLmFuZHJvaWRJbnN0YWxsVGltZW91dCB9KTtcbiAgICAgICAgbG9nZ2VyLmluZm8oYEluc3RhbGxlZCBFc3ByZXNzbyBUZXN0IFNlcnZlciBhcGsgJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofScgKHBrZzogJyR7VEVTVF9BUEtfUEtHfScpYCk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coYENhbm5vdCBpbnN0YWxsICcke3RoaXMubW9kU2VydmVyUGF0aH0nIGJlY2F1c2Ugb2YgJyR7ZXJyLm1lc3NhZ2V9J2ApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxUZXN0QXBrICgpIHtcbiAgICBsZXQgcmVidWlsZCA9IHRoaXMuZm9yY2VFc3ByZXNzb1JlYnVpbGQ7XG4gICAgaWYgKHJlYnVpbGQpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgJ2ZvcmNlRXNwcmVzc29SZWJ1aWxkJyBjYXBhYmlsaXR5IGlzIGVuYWJsZWRgKTtcbiAgICB9IGVsc2UgaWYgKGF3YWl0IHRoaXMuaXNBcHBQYWNrYWdlQ2hhbmdlZCgpKSB7XG4gICAgICBsb2dnZXIuaW5mbyhgRm9yY2luZyBFc3ByZXNzbyBzZXJ2ZXIgcmVidWlsZCBiZWNhdXNlIG9mIGNoYW5nZWQgYXBwbGljYXRpb24gcGFja2FnZWApO1xuICAgICAgcmVidWlsZCA9IHRydWU7XG4gICAgfVxuXG4gICAgaWYgKHJlYnVpbGQgJiYgYXdhaXQgZnMuZXhpc3RzKHRoaXMubW9kU2VydmVyUGF0aCkpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgRGVsZXRpbmcgdGhlIG9ic29sZXRlIEVzcHJlc3NvIHNlcnZlciBwYWNrYWdlICcke3RoaXMubW9kU2VydmVyUGF0aH0nYCk7XG4gICAgICBhd2FpdCBmcy51bmxpbmsodGhpcy5tb2RTZXJ2ZXJQYXRoKTtcbiAgICB9XG4gICAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKHRoaXMubW9kU2VydmVyUGF0aCkpKSB7XG4gICAgICBhd2FpdCB0aGlzLmJ1aWxkTmV3TW9kU2VydmVyKCk7XG4gICAgfVxuICAgIGNvbnN0IGlzU2lnbmVkID0gYXdhaXQgdGhpcy5hZGIuY2hlY2tBcGtDZXJ0KHRoaXMubW9kU2VydmVyUGF0aCwgVEVTVF9BUEtfUEtHKTtcbiAgICBpZiAoIWlzU2lnbmVkKSB7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5zaWduKHRoaXMubW9kU2VydmVyUGF0aCk7XG4gICAgfVxuICAgIGlmICgocmVidWlsZCB8fCAhaXNTaWduZWQpICYmIGF3YWl0IHRoaXMuYWRiLnVuaW5zdGFsbEFwayhURVNUX0FQS19QS0cpKSB7XG4gICAgICBsb2dnZXIuaW5mbygnVW5pbnN0YWxsZWQgdGhlIG9ic29sZXRlIEVzcHJlc3NvIHNlcnZlciBwYWNrYWdlIGZyb20gdGhlIGRldmljZSB1bmRlciB0ZXN0Jyk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5pbnN0YWxsU2VydmVyKCk7XG4gIH1cblxuICBhc3luYyBidWlsZE5ld01vZFNlcnZlciAoKSB7XG4gICAgbGV0IGJ1aWxkQ29uZmlndXJhdGlvbiA9IHt9O1xuICAgIGlmICh0aGlzLmVzcHJlc3NvQnVpbGRDb25maWcpIHtcbiAgICAgIGxvZ2dlci5pbmZvKGBVc2luZyBidWlsZCBjb25maWd1cmF0aW9uIEpTT04gZnJvbTogJyR7dGhpcy5lc3ByZXNzb0J1aWxkQ29uZmlnfSdgKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGJ1aWxkQ29uZmlndXJhdGlvbiA9IEpTT04ucGFyc2UoYXdhaXQgZnMucmVhZEZpbGUodGhpcy5lc3ByZXNzb0J1aWxkQ29uZmlnLCAndXRmOCcpKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gcGFyc2UgYnVpbGQgY29uZmlndXJhdGlvbiBKU09OJywgZSk7XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgfVxuICAgIGxvZ2dlci5pbmZvKCdCdWlsZGluZyBlc3ByZXNzbyBzZXJ2ZXInKTtcbiAgICBjb25zdCBzZXJ2ZXJQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCAnZXNwcmVzc28tc2VydmVyJyk7XG4gICAgbG9nZ2VyLmRlYnVnKGBidWlsZCBkaXI6ICR7c2VydmVyUGF0aH1gKTtcbiAgICBhd2FpdCBmcy5yaW1yYWYoc2VydmVyUGF0aCk7XG4gICAgYXdhaXQgbWtkaXJwKHNlcnZlclBhdGgpO1xuICAgIGxvZ2dlci5kZWJ1ZyhgQ29weWluZyBlc3ByZXNzbyBzZXJ2ZXIgdGVtcGxhdGUgZnJvbSAoJHtURVNUX1NFUlZFUl9ST09UfSB0byAke3NlcnZlclBhdGh9KWApO1xuICAgIGF3YWl0IGNvcHlHcmFkbGVQcm9qZWN0UmVjdXJzaXZlbHkoVEVTVF9TRVJWRVJfUk9PVCwgc2VydmVyUGF0aCk7XG4gICAgYXdhaXQgbmV3IFNlcnZlckJ1aWxkZXIoe3NlcnZlclBhdGgsIGJ1aWxkQ29uZmlndXJhdGlvbiwgc2hvd0dyYWRsZUxvZzogdGhpcy5zaG93R3JhZGxlTG9nfSkuYnVpbGQoKTtcbiAgICBjb25zdCBhcGtQYXRoID0gcGF0aC5yZXNvbHZlKHNlcnZlclBhdGgsICdhcHAnLCAnYnVpbGQnLCAnb3V0cHV0cycsICdhcGsnLCAnYW5kcm9pZFRlc3QnLCAnZGVidWcnLCAnYXBwLWRlYnVnLWFuZHJvaWRUZXN0LmFwaycpO1xuXG4gICAgbG9nZ2VyLmluZm8oYFJlcGFja2FnaW5nIGVzcHJlc3NvIHNlcnZlciBmb3I6ICcke3RoaXMuYXBwUGFja2FnZX0nYCk7XG4gICAgY29uc3QgcGFja2FnZVRtcERpciA9IHBhdGgucmVzb2x2ZSh0aGlzLnRtcERpciwgdGhpcy5hcHBQYWNrYWdlKTtcbiAgICBjb25zdCBuZXdNYW5pZmVzdFBhdGggPSBwYXRoLnJlc29sdmUodGhpcy50bXBEaXIsICdBbmRyb2lkTWFuaWZlc3QueG1sJyk7XG4gICAgYXdhaXQgZnMucmltcmFmKG5ld01hbmlmZXN0UGF0aCk7XG5cbiAgICBsb2dnZXIuaW5mbyhgQ3JlYXRpbmcgbmV3IG1hbmlmZXN0OiAnJHtuZXdNYW5pZmVzdFBhdGh9J2ApO1xuICAgIGF3YWl0IG1rZGlycChwYWNrYWdlVG1wRGlyKTtcbiAgICBhd2FpdCBmcy5jb3B5RmlsZShURVNUX01BTklGRVNUX1BBVEgsIG5ld01hbmlmZXN0UGF0aCk7XG4gICAgYXdhaXQgdGhpcy5hZGIuY29tcGlsZU1hbmlmZXN0KG5ld01hbmlmZXN0UGF0aCwgVEVTVF9BUEtfUEtHLCB0aGlzLmFwcFBhY2thZ2UpOyAvLyBjcmVhdGVzIGEgZmlsZSBgJHtuZXdNYW5pZmVzdFBhdGh9LmFwa2BcbiAgICBhd2FpdCB0aGlzLmFkYi5pbnNlcnRNYW5pZmVzdChuZXdNYW5pZmVzdFBhdGgsIGFwa1BhdGgsIHRoaXMubW9kU2VydmVyUGF0aCk7IC8vIGNvcGllcyBmcm9tIHNlY29uZCB0byB0aGlyZCBhbmQgYWRkIG1hbmlmZXN0XG4gICAgbG9nZ2VyLmluZm8oYFJlcGFja2FnZWQgZXNwcmVzc28gc2VydmVyIHJlYWR5OiAnJHt0aGlzLm1vZFNlcnZlclBhdGh9J2ApO1xuICB9XG5cbiAgYXN5bmMgY2xlYW51cFNlc3Npb25MZWZ0b3ZlcnMgKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnUGVyZm9ybWluZyBjbGVhbnVwIG9mIGF1dG9tYXRpb24gbGVmdG92ZXJzJyk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3Qge3ZhbHVlfSA9IGF3YWl0IHJlcXVlc3QuZ2V0KHtcbiAgICAgICAgdXJsOiBgaHR0cDovLyR7dGhpcy5ob3N0fToke3RoaXMuc3lzdGVtUG9ydH0vc2Vzc2lvbnNgLFxuICAgICAgICB0aW1lb3V0OiA1MDAsXG4gICAgICAgIGpzb246IHRydWUsXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IGFjdGl2ZVNlc3Npb25JZHMgPSB2YWx1ZS5tYXAoKHNlc3MpID0+IHNlc3MuaWQpO1xuICAgICAgaWYgKGFjdGl2ZVNlc3Npb25JZHMubGVuZ3RoKSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgVGhlIGZvbGxvd2luZyBvYnNvbGV0ZSBzZXNzaW9ucyBhcmUgc3RpbGwgcnVubmluZzogJHtKU09OLnN0cmluZ2lmeShhY3RpdmVTZXNzaW9uSWRzKX1gKTtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKCdDbGVhbmluZyB1cCB0aGUgb2Jzb2xldGUgc2Vzc2lvbnMnKTtcbiAgICAgICAgYXdhaXQgQi5hbGwoYWN0aXZlU2Vzc2lvbklkcy5tYXAoKGlkKSA9PlxuICAgICAgICAgIHJlcXVlc3QuZGVsZXRlKHtcbiAgICAgICAgICAgIHVybDogYGh0dHA6Ly8ke3RoaXMuaG9zdH06JHt0aGlzLnN5c3RlbVBvcnR9L3Nlc3Npb24vJHtpZH1gLFxuICAgICAgICAgIH0pXG4gICAgICAgICkpO1xuICAgICAgICAvLyBMZXQgYWxsIHNlc3Npb25zIHRvIGJlIHByb3Blcmx5IHRlcm1pbmF0ZWQgYmVmb3JlIGNvbnRpbnVpbmdcbiAgICAgICAgYXdhaXQgQi5kZWxheSgxMDAwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZygnTm8gb2Jzb2xldGUgc2Vzc2lvbnMgaGF2ZSBiZWVuIGRldGVjdGVkJyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBObyBvYnNvbGV0ZSBzZXNzaW9ucyBoYXZlIGJlZW4gZGV0ZWN0ZWQgKCR7ZS5tZXNzYWdlfSlgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzdGFydFNlc3Npb24gKGNhcHMpIHtcbiAgICBhd2FpdCB0aGlzLmNsZWFudXBTZXNzaW9uTGVmdG92ZXJzKCk7XG5cbiAgICBjb25zdCBjbWQgPSBbXG4gICAgICAnc2hlbGwnLFxuICAgICAgJ2FtJywgJ2luc3RydW1lbnQnLFxuICAgICAgJy13JyxcbiAgICAgICctZScsICdkZWJ1ZycsIHByb2Nlc3MuZW52LkVTUFJFU1NPX0pBVkFfREVCVUcgPT09ICd0cnVlJyA/ICd0cnVlJyA6ICdmYWxzZScsXG4gICAgICBgJHtURVNUX0FQS19QS0d9L2FuZHJvaWR4LnRlc3QucnVubmVyLkFuZHJvaWRKVW5pdFJ1bm5lcmAsXG4gICAgXTtcblxuICAgIGxvZ2dlci5pbmZvKGBTdGFydGluZyBFc3ByZXNzbyBTZXJ2ZXIgdiR7dmVyc2lvbn0gd2l0aCBjbWQ6IGFkYiAke2NtZC5qb2luKCcgJyl9YCk7XG5cbiAgICBsZXQgaGFzU29ja2V0RXJyb3IgPSBmYWxzZTtcblxuICAgIC8vIHN0YXJ0IHRoZSBpbnN0cnVtZW50YXRpb24gcHJvY2Vzc1xuICAgIHRoaXMuaW5zdFByb2Nlc3MgPSB0aGlzLmFkYi5jcmVhdGVTdWJQcm9jZXNzKGNtZCk7XG4gICAgdGhpcy5pbnN0UHJvY2Vzcy5vbignZXhpdCcsIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgIGxvZ2dlci5pbmZvKGBJbnN0cnVtZW50YXRpb24gcHJvY2VzcyBleGl0ZWQgd2l0aCBjb2RlICR7Y29kZX0gZnJvbSBzaWduYWwgJHtzaWduYWx9YCk7XG4gICAgfSk7XG4gICAgdGhpcy5pbnN0UHJvY2Vzcy5vbignZGllJywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgbG9nZ2VyLmVycm9yKGBJbnN0cnVtZW50YXRpb24gcHJvY2VzcyBkaWVkIHdpdGggY29kZSAke2NvZGV9IGFuZCBzaWduYWwgJHtzaWduYWx9YCk7XG4gICAgfSk7XG4gICAgdGhpcy5pbnN0UHJvY2Vzcy5vbignc3RyZWFtLWxpbmUnLCAobGluZSkgPT4ge1xuICAgICAgaWYgKF8uaXNFbXB0eShsaW5lLnRyaW0oKSkpIHtcbiAgICAgICAgLy8gRG8gbm90IHByaW50IGVtcHR5IGxpbmVzIGludG8gdGhlIHN5c3RlbSBsb2dcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBsb2dnZXIuZGVidWcoYFtJbnN0cnVtZW50YXRpb25dICR7bGluZS50cmltKCl9YCk7XG4gICAgICAvLyBBICdTb2NrZXRFeGNlcHRpb24nIGluZGljYXRlcyB0aGF0IHdlIGNvdWxkbid0IGNvbm5lY3QgdG8gdGhlIEVzcHJlc3NvIFNlcnZlciwgYmVjYXVzZSB0aGUgSU5URVJORVQgcGVybWlzc2lvbiBpcyBub3Qgc2V0XG4gICAgICBpZiAobGluZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdqYXZhLm5ldC5zb2NrZXRleGNlcHRpb24nKSkge1xuICAgICAgICBoYXNTb2NrZXRFcnJvciA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBhd2FpdCB0aGlzLmluc3RQcm9jZXNzLnN0YXJ0KChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgLy8gZm9yIGFueSBjYWxsIHRvIHRoZSBzdGFydCBkZXRlY3Rvciwgb25lIG9mIHN0ZG91dCBvciBzdGRlcnIgd2lsbCBoYXZlXG4gICAgICAvLyBjb250ZW50LCBzbyBtZXJnZSBmb3IgY2hlY2tzIGhlcmVcbiAgICAgIGNvbnN0IG91dCA9IHN0ZG91dC50cmltKCkgfHwgc3RkZXJyLnRyaW0oKTtcblxuICAgICAgLy8gYWRiIGFsd2F5cyBwcmludHMgdGhpcyBvdXQgb24gc3VjY2Vzcy4gSWYgdGhpcyBpcyBmb3VuZCBub3QgdG8gYmUgdGhlXG4gICAgICAvLyBjYXNlLCBhZGQgb3RoZXIgY29uZGl0aW9uc1xuICAgICAgaWYgKG91dC5pbmNsdWRlcygnaW8uYXBwaXVtLmVzcHJlc3Nvc2VydmVyLkVzcHJlc3NvU2VydmVyUnVubmVyVGVzdDonKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGlmIChvdXQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnZXhjZXB0aW9uJykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKG91dCk7XG4gICAgICB9XG4gICAgfSwgdGhpcy5zZXJ2ZXJMYXVuY2hUaW1lb3V0KTtcblxuICAgIGxvZ2dlci5pbmZvKCdXYWl0aW5nIGZvciBFc3ByZXNzbyB0byBiZSBvbmxpbmUuLi4nKTtcblxuICAgIC8vIHdhaXQgMjBzIGZvciBlc3ByZXNzbyB0byBiZSBvbmxpbmVcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcmV0cnlJbnRlcnZhbCgyMCwgMTAwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChoYXNTb2NrZXRFcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgVGltZWQgb3V0IHdhaXRpbmcgZm9yIEVzcHJlc3NvIFNlcnZlciB0byBzdGFydCBkdWUgdG8gU29ja2V0IGV4Y2VwdGlvbi4gRXNwcmVzc28gU2VydmVyIHJlcXVpcmVzIHRoZSAnSU5URVJORVQnIHBlcm1pc3Npb24gdG8gYmUgc2V0IGluIHRoZSBBbmRyb2lkIG1hbmlmZXN0IGZvciB0aGUgYXBwLXVuZGVyLXRlc3QgKDx1c2VzLXBlcm1pc3Npb24gYW5kcm9pZDpuYW1lPVwiYW5kcm9pZC5wZXJtaXNzaW9uLklOVEVSTkVUXCIgLz4pYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgVGltZWQgb3V0IHdhaXRpbmcgZm9yIEVzcHJlc3NvIFNlcnZlciB0byBzdGFydC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywge1xuICAgICAgY2FwYWJpbGl0aWVzOiB7XG4gICAgICAgIGZpcnN0TWF0Y2g6IFtjYXBzXSxcbiAgICAgICAgYWx3YXlzTWF0Y2g6IHt9XG4gICAgICB9XG4gICAgfSk7XG4gICAgYXdhaXQgdGhpcy5yZWNvcmRUYXJnZXRBcHBQYWNrYWdlKCk7XG4gIH1cblxuICBhc3luYyByZWNvcmRUYXJnZXRBcHBQYWNrYWdlICgpIHtcbiAgICBhd2FpdCB0aGlzLmFkYi5zaGVsbChbYGVjaG8gXCIke3RoaXMuYXBwUGFja2FnZX1cIiA+IFwiJHtUQVJHRVRfUEFDS0FHRV9DT05UQUlORVJ9XCJgXSk7XG4gICAgbG9nZ2VyLmluZm8oYFJlY29yZGVkIHRoZSB0YXJnZXQgYXBwbGljYXRpb24gcGFja2FnZSAnJHt0aGlzLmFwcFBhY2thZ2V9JyB0byAke1RBUkdFVF9QQUNLQUdFX0NPTlRBSU5FUn1gKTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnRGVsZXRpbmcgRXNwcmVzc28gc2VydmVyIHNlc3Npb24nKTtcbiAgICAvLyByZWx5IG9uIGp3cHJveHkncyBpbnRlbGxpZ2VuY2UgdG8ga25vdyB3aGF0IHdlJ3JlIHRhbGtpbmcgYWJvdXQgYW5kXG4gICAgLy8gZGVsZXRlIHRoZSBjdXJyZW50IHNlc3Npb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy8nLCAnREVMRVRFJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIud2FybihgRGlkIG5vdCBnZXQgY29uZmlybWF0aW9uIEVzcHJlc3NvIGRlbGV0ZVNlc3Npb24gd29ya2VkOyBgICtcbiAgICAgICAgICBgRXJyb3Igd2FzOiAke2Vycn1gKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pbnN0UHJvY2VzcyAmJiB0aGlzLmluc3RQcm9jZXNzLmlzUnVubmluZykge1xuICAgICAgYXdhaXQgdGhpcy5pbnN0UHJvY2Vzcy5zdG9wKCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCB7IEVzcHJlc3NvUnVubmVyLCBSRVFVSVJFRF9QQVJBTVMsIFRFU1RfQVBLX1BLRyB9O1xuZXhwb3J0IGRlZmF1bHQgRXNwcmVzc29SdW5uZXI7XG4iXSwiZmlsZSI6ImxpYi9lc3ByZXNzby1ydW5uZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
