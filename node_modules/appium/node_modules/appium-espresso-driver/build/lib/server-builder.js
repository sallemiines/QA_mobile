"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.GRADLE_DEPENDENCIES_PLACEHOLDER = exports.GRADLE_URL_TEMPLATE = exports.VERSION_KEYS = exports.ServerBuilder = void 0;

require("source-map-support/register");

var _teen_process = require("teen_process");

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _path = _interopRequireDefault(require("path"));

var _os = require("os");

const GRADLE_VERSION_KEY = 'gradle';
const GRADLE_URL_PREFIX = 'distributionUrl=';
const GRADLE_URL_TEMPLATE = 'https\\://services.gradle.org/distributions/gradle-VERSION-all.zip';
exports.GRADLE_URL_TEMPLATE = GRADLE_URL_TEMPLATE;
const GRADLE_MAX_ERROR_LOG_LINES = 15;
const GRADLE_DEPENDENCIES_PLACEHOLDER = '// additionalAppDependencies placeholder (don\'t change or delete this line)';
exports.GRADLE_DEPENDENCIES_PLACEHOLDER = GRADLE_DEPENDENCIES_PLACEHOLDER;
const VERSION_KEYS = [GRADLE_VERSION_KEY, 'androidGradlePlugin', 'compileSdk', 'buildTools', 'minSdk', 'targetSdk', 'kotlin'];
exports.VERSION_KEYS = VERSION_KEYS;

const gradleLog = _appiumSupport.logger.getLogger('Gradle');

class ServerBuilder {
  constructor(args = {}) {
    this.serverPath = args.serverPath;
    this.showGradleLog = args.showGradleLog;
    const buildConfiguration = args.buildConfiguration || {};
    const versionConfiguration = buildConfiguration.toolsVersions || {};
    this.serverVersions = _lodash.default.reduce(versionConfiguration, (acc, value, key) => {
      if (VERSION_KEYS.includes(key)) {
        acc[key] = value;
      } else {
        _logger.default.warn(`Got unexpected '${key}' in toolsVersion block of the build configuration`);
      }

      return acc;
    }, {});
    this.additionalAppDependencies = buildConfiguration.additionalAppDependencies || [];
  }

  async build() {
    if (this.serverVersions[GRADLE_VERSION_KEY]) {
      await this.setGradleWrapperVersion(this.serverVersions[GRADLE_VERSION_KEY]);
    }

    if (!Array.isArray(this.additionalAppDependencies)) {
      throw new Error('additionalAppDependencies must be an array');
    }

    if (!_lodash.default.isEmpty(this.additionalAppDependencies)) {
      await this.insertAdditionalAppDependencies(this.additionalAppDependencies);
    }

    await this.runBuildProcess();
  }

  getCommand() {
    const cmd = _appiumSupport.system.isWindows() ? 'gradlew.bat' : './gradlew';
    let args = VERSION_KEYS.filter(key => key !== GRADLE_VERSION_KEY).map(key => {
      const serverVersion = this.serverVersions[key];
      const gradleProperty = `appium${key.charAt(0).toUpperCase()}${key.slice(1)}`;
      return serverVersion ? `-P${gradleProperty}=${serverVersion}` : null;
    }).filter(Boolean);
    args.push('assembleAndroidTest');
    return {
      cmd,
      args
    };
  }

  async setGradleWrapperVersion(version) {
    const propertiesPath = _path.default.resolve(this.serverPath, 'gradle', 'wrapper', 'gradle-wrapper.properties');

    const originalProperties = await _appiumSupport.fs.readFile(propertiesPath, 'utf8');
    const newProperties = this.updateGradleDistUrl(originalProperties, version);
    await _appiumSupport.fs.writeFile(propertiesPath, newProperties, 'utf8');
  }

  updateGradleDistUrl(propertiesContent, version) {
    return propertiesContent.replace(new RegExp(`^(${_lodash.default.escapeRegExp(GRADLE_URL_PREFIX)}).+$`, 'gm'), `$1${GRADLE_URL_TEMPLATE.replace('VERSION', version)}`);
  }

  async insertAdditionalAppDependencies(additionalAppDependencies) {
    const buildPath = _path.default.resolve(this.serverPath, 'app', 'build.gradle');

    const originalConfiguration = await _appiumSupport.fs.readFile(buildPath, 'utf8');
    const newConfiguration = this.updateDependencyLines(originalConfiguration, additionalAppDependencies);
    await _appiumSupport.fs.writeFile(buildPath, newConfiguration, 'utf8');
  }

  updateDependencyLines(configurationContent, additionalAppDependencies) {
    const dependencyLines = additionalAppDependencies.map(function (dependency) {
      if (/[\s'\\$]/.test(dependency)) {
        throw new Error('Single quotes, dollar characters and whitespace characters' + ` are disallowed in additional dependencies: ${dependency}`);
      }

      return `implementation '${dependency}'`;
    }).join('$1');
    return configurationContent.replace(new RegExp(`(\\s*^\\s*)${_lodash.default.escapeRegExp(GRADLE_DEPENDENCIES_PLACEHOLDER)}\\s*$`, 'gm'), `$1${dependencyLines}`);
  }

  async runBuildProcess() {
    const {
      cmd,
      args
    } = this.getCommand();

    _logger.default.debug(`Beginning build with command '${cmd} ${args.join(' ')}' ` + `in directory '${this.serverPath}'`);

    const gradlebuild = new _teen_process.SubProcess(cmd, args, {
      cwd: this.serverPath,
      stdio: ['ignore', 'pipe', 'pipe']
    });
    let buildLastLines = [];
    const logMsg = `Output from Gradle ${this.showGradleLog ? 'will' : 'will not'} be logged`;

    _logger.default.debug(`${logMsg}. To change this, use 'showGradleLog' desired capability`);

    gradlebuild.on('stream-line', line => {
      if (this.showGradleLog) {
        if (line.startsWith('[STDERR]')) {
          gradleLog.warn(line);
        } else {
          gradleLog.info(line);
        }
      }

      buildLastLines.push(`${_os.EOL}${line}`);

      if (buildLastLines.length > GRADLE_MAX_ERROR_LOG_LINES) {
        buildLastLines = buildLastLines.slice(-GRADLE_MAX_ERROR_LOG_LINES);
      }
    });

    try {
      await gradlebuild.start();
      await gradlebuild.join();
    } catch (err) {
      let msg = `Unable to build Espresso server - ${err.message}\n` + `Gradle error message:${_os.EOL}${buildLastLines}`;

      _logger.default.errorAndThrow(msg);
    }
  }

}

exports.ServerBuilder = ServerBuilder;
var _default = ServerBuilder;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zZXJ2ZXItYnVpbGRlci5qcyJdLCJuYW1lcyI6WyJHUkFETEVfVkVSU0lPTl9LRVkiLCJHUkFETEVfVVJMX1BSRUZJWCIsIkdSQURMRV9VUkxfVEVNUExBVEUiLCJHUkFETEVfTUFYX0VSUk9SX0xPR19MSU5FUyIsIkdSQURMRV9ERVBFTkRFTkNJRVNfUExBQ0VIT0xERVIiLCJWRVJTSU9OX0tFWVMiLCJncmFkbGVMb2ciLCJsb2dnZXIiLCJnZXRMb2dnZXIiLCJTZXJ2ZXJCdWlsZGVyIiwiY29uc3RydWN0b3IiLCJhcmdzIiwic2VydmVyUGF0aCIsInNob3dHcmFkbGVMb2ciLCJidWlsZENvbmZpZ3VyYXRpb24iLCJ2ZXJzaW9uQ29uZmlndXJhdGlvbiIsInRvb2xzVmVyc2lvbnMiLCJzZXJ2ZXJWZXJzaW9ucyIsIl8iLCJyZWR1Y2UiLCJhY2MiLCJ2YWx1ZSIsImtleSIsImluY2x1ZGVzIiwibG9nIiwid2FybiIsImFkZGl0aW9uYWxBcHBEZXBlbmRlbmNpZXMiLCJidWlsZCIsInNldEdyYWRsZVdyYXBwZXJWZXJzaW9uIiwiQXJyYXkiLCJpc0FycmF5IiwiRXJyb3IiLCJpc0VtcHR5IiwiaW5zZXJ0QWRkaXRpb25hbEFwcERlcGVuZGVuY2llcyIsInJ1bkJ1aWxkUHJvY2VzcyIsImdldENvbW1hbmQiLCJjbWQiLCJzeXN0ZW0iLCJpc1dpbmRvd3MiLCJmaWx0ZXIiLCJtYXAiLCJzZXJ2ZXJWZXJzaW9uIiwiZ3JhZGxlUHJvcGVydHkiLCJjaGFyQXQiLCJ0b1VwcGVyQ2FzZSIsInNsaWNlIiwiQm9vbGVhbiIsInB1c2giLCJ2ZXJzaW9uIiwicHJvcGVydGllc1BhdGgiLCJwYXRoIiwicmVzb2x2ZSIsIm9yaWdpbmFsUHJvcGVydGllcyIsImZzIiwicmVhZEZpbGUiLCJuZXdQcm9wZXJ0aWVzIiwidXBkYXRlR3JhZGxlRGlzdFVybCIsIndyaXRlRmlsZSIsInByb3BlcnRpZXNDb250ZW50IiwicmVwbGFjZSIsIlJlZ0V4cCIsImVzY2FwZVJlZ0V4cCIsImJ1aWxkUGF0aCIsIm9yaWdpbmFsQ29uZmlndXJhdGlvbiIsIm5ld0NvbmZpZ3VyYXRpb24iLCJ1cGRhdGVEZXBlbmRlbmN5TGluZXMiLCJjb25maWd1cmF0aW9uQ29udGVudCIsImRlcGVuZGVuY3lMaW5lcyIsImRlcGVuZGVuY3kiLCJ0ZXN0Iiwiam9pbiIsImRlYnVnIiwiZ3JhZGxlYnVpbGQiLCJTdWJQcm9jZXNzIiwiY3dkIiwic3RkaW8iLCJidWlsZExhc3RMaW5lcyIsImxvZ01zZyIsIm9uIiwibGluZSIsInN0YXJ0c1dpdGgiLCJpbmZvIiwiRU9MIiwibGVuZ3RoIiwic3RhcnQiLCJlcnIiLCJtc2ciLCJtZXNzYWdlIiwiZXJyb3JBbmRUaHJvdyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxrQkFBa0IsR0FBRyxRQUEzQjtBQUNBLE1BQU1DLGlCQUFpQixHQUFHLGtCQUExQjtBQUNBLE1BQU1DLG1CQUFtQixHQUFHLG9FQUE1Qjs7QUFDQSxNQUFNQywwQkFBMEIsR0FBRyxFQUFuQztBQUVBLE1BQU1DLCtCQUErQixHQUFHLDhFQUF4Qzs7QUFFQSxNQUFNQyxZQUFZLEdBQUcsQ0FDbkJMLGtCQURtQixFQUVuQixxQkFGbUIsRUFHbkIsWUFIbUIsRUFJbkIsWUFKbUIsRUFLbkIsUUFMbUIsRUFNbkIsV0FObUIsRUFPbkIsUUFQbUIsQ0FBckI7OztBQVVBLE1BQU1NLFNBQVMsR0FBR0Msc0JBQU9DLFNBQVAsQ0FBaUIsUUFBakIsQ0FBbEI7O0FBRUEsTUFBTUMsYUFBTixDQUFvQjtBQUNsQkMsRUFBQUEsV0FBVyxDQUFFQyxJQUFJLEdBQUcsRUFBVCxFQUFhO0FBQ3RCLFNBQUtDLFVBQUwsR0FBa0JELElBQUksQ0FBQ0MsVUFBdkI7QUFDQSxTQUFLQyxhQUFMLEdBQXFCRixJQUFJLENBQUNFLGFBQTFCO0FBRUEsVUFBTUMsa0JBQWtCLEdBQUdILElBQUksQ0FBQ0csa0JBQUwsSUFBMkIsRUFBdEQ7QUFFQSxVQUFNQyxvQkFBb0IsR0FBR0Qsa0JBQWtCLENBQUNFLGFBQW5CLElBQW9DLEVBQWpFO0FBQ0EsU0FBS0MsY0FBTCxHQUFzQkMsZ0JBQUVDLE1BQUYsQ0FBU0osb0JBQVQsRUFBK0IsQ0FBQ0ssR0FBRCxFQUFNQyxLQUFOLEVBQWFDLEdBQWIsS0FBcUI7QUFDeEUsVUFBSWpCLFlBQVksQ0FBQ2tCLFFBQWIsQ0FBc0JELEdBQXRCLENBQUosRUFBZ0M7QUFDOUJGLFFBQUFBLEdBQUcsQ0FBQ0UsR0FBRCxDQUFILEdBQVdELEtBQVg7QUFDRCxPQUZELE1BRU87QUFDTEcsd0JBQUlDLElBQUosQ0FBVSxtQkFBa0JILEdBQUksb0RBQWhDO0FBQ0Q7O0FBQ0QsYUFBT0YsR0FBUDtBQUNELEtBUHFCLEVBT25CLEVBUG1CLENBQXRCO0FBU0EsU0FBS00seUJBQUwsR0FBaUNaLGtCQUFrQixDQUFDWSx5QkFBbkIsSUFBZ0QsRUFBakY7QUFDRDs7QUFFRCxRQUFNQyxLQUFOLEdBQWU7QUFDYixRQUFJLEtBQUtWLGNBQUwsQ0FBb0JqQixrQkFBcEIsQ0FBSixFQUE2QztBQUMzQyxZQUFNLEtBQUs0Qix1QkFBTCxDQUE2QixLQUFLWCxjQUFMLENBQW9CakIsa0JBQXBCLENBQTdCLENBQU47QUFDRDs7QUFFRCxRQUFJLENBQUM2QixLQUFLLENBQUNDLE9BQU4sQ0FBYyxLQUFLSix5QkFBbkIsQ0FBTCxFQUFvRDtBQUNsRCxZQUFNLElBQUlLLEtBQUosQ0FBVSw0Q0FBVixDQUFOO0FBQ0Q7O0FBQ0QsUUFBSSxDQUFDYixnQkFBRWMsT0FBRixDQUFVLEtBQUtOLHlCQUFmLENBQUwsRUFBZ0Q7QUFDOUMsWUFBTSxLQUFLTywrQkFBTCxDQUFxQyxLQUFLUCx5QkFBMUMsQ0FBTjtBQUNEOztBQUVELFVBQU0sS0FBS1EsZUFBTCxFQUFOO0FBQ0Q7O0FBRURDLEVBQUFBLFVBQVUsR0FBSTtBQUNaLFVBQU1DLEdBQUcsR0FBR0Msc0JBQU9DLFNBQVAsS0FBcUIsYUFBckIsR0FBcUMsV0FBakQ7QUFDQSxRQUFJM0IsSUFBSSxHQUFHTixZQUFZLENBQ3BCa0MsTUFEUSxDQUNEakIsR0FBRyxJQUFJQSxHQUFHLEtBQUt0QixrQkFEZCxFQUVSd0MsR0FGUSxDQUVKbEIsR0FBRyxJQUFJO0FBQ1YsWUFBTW1CLGFBQWEsR0FBRyxLQUFLeEIsY0FBTCxDQUFvQkssR0FBcEIsQ0FBdEI7QUFDQSxZQUFNb0IsY0FBYyxHQUFJLFNBQVFwQixHQUFHLENBQUNxQixNQUFKLENBQVcsQ0FBWCxFQUFjQyxXQUFkLEVBQTRCLEdBQUV0QixHQUFHLENBQUN1QixLQUFKLENBQVUsQ0FBVixDQUFhLEVBQTNFO0FBQ0EsYUFBT0osYUFBYSxHQUFJLEtBQUlDLGNBQWUsSUFBR0QsYUFBYyxFQUF4QyxHQUE0QyxJQUFoRTtBQUNELEtBTlEsRUFPUkYsTUFQUSxDQU9ETyxPQVBDLENBQVg7QUFTQW5DLElBQUFBLElBQUksQ0FBQ29DLElBQUwsQ0FBVSxxQkFBVjtBQUVBLFdBQU87QUFBQ1gsTUFBQUEsR0FBRDtBQUFNekIsTUFBQUE7QUFBTixLQUFQO0FBQ0Q7O0FBRUQsUUFBTWlCLHVCQUFOLENBQStCb0IsT0FBL0IsRUFBd0M7QUFDdEMsVUFBTUMsY0FBYyxHQUFHQyxjQUFLQyxPQUFMLENBQWEsS0FBS3ZDLFVBQWxCLEVBQThCLFFBQTlCLEVBQXdDLFNBQXhDLEVBQW1ELDJCQUFuRCxDQUF2Qjs7QUFDQSxVQUFNd0Msa0JBQWtCLEdBQUcsTUFBTUMsa0JBQUdDLFFBQUgsQ0FBWUwsY0FBWixFQUE0QixNQUE1QixDQUFqQztBQUNBLFVBQU1NLGFBQWEsR0FBRyxLQUFLQyxtQkFBTCxDQUF5Qkosa0JBQXpCLEVBQTZDSixPQUE3QyxDQUF0QjtBQUNBLFVBQU1LLGtCQUFHSSxTQUFILENBQWFSLGNBQWIsRUFBNkJNLGFBQTdCLEVBQTRDLE1BQTVDLENBQU47QUFDRDs7QUFFREMsRUFBQUEsbUJBQW1CLENBQUVFLGlCQUFGLEVBQXFCVixPQUFyQixFQUE4QjtBQUMvQyxXQUFPVSxpQkFBaUIsQ0FBQ0MsT0FBbEIsQ0FDTCxJQUFJQyxNQUFKLENBQVksS0FBSTFDLGdCQUFFMkMsWUFBRixDQUFlNUQsaUJBQWYsQ0FBa0MsTUFBbEQsRUFBeUQsSUFBekQsQ0FESyxFQUVKLEtBQUlDLG1CQUFtQixDQUFDeUQsT0FBcEIsQ0FBNEIsU0FBNUIsRUFBdUNYLE9BQXZDLENBQWdELEVBRmhELENBQVA7QUFJRDs7QUFFRCxRQUFNZiwrQkFBTixDQUF1Q1AseUJBQXZDLEVBQWtFO0FBQ2hFLFVBQU1vQyxTQUFTLEdBQUdaLGNBQUtDLE9BQUwsQ0FBYSxLQUFLdkMsVUFBbEIsRUFBOEIsS0FBOUIsRUFBcUMsY0FBckMsQ0FBbEI7O0FBQ0EsVUFBTW1ELHFCQUFxQixHQUFHLE1BQU1WLGtCQUFHQyxRQUFILENBQVlRLFNBQVosRUFBdUIsTUFBdkIsQ0FBcEM7QUFDQSxVQUFNRSxnQkFBZ0IsR0FBRyxLQUFLQyxxQkFBTCxDQUEyQkYscUJBQTNCLEVBQWtEckMseUJBQWxELENBQXpCO0FBQ0EsVUFBTTJCLGtCQUFHSSxTQUFILENBQWFLLFNBQWIsRUFBd0JFLGdCQUF4QixFQUEwQyxNQUExQyxDQUFOO0FBQ0Q7O0FBRURDLEVBQUFBLHFCQUFxQixDQUFFQyxvQkFBRixFQUF3QnhDLHlCQUF4QixFQUFtRDtBQUN0RSxVQUFNeUMsZUFBZSxHQUFHekMseUJBQXlCLENBQzlDYyxHQURxQixDQUNqQixVQUFVNEIsVUFBVixFQUFzQjtBQUd6QixVQUFJLFdBQVdDLElBQVgsQ0FBZ0JELFVBQWhCLENBQUosRUFBaUM7QUFDL0IsY0FBTSxJQUFJckMsS0FBSixDQUFVLCtEQUNiLCtDQUE4Q3FDLFVBQVcsRUFEdEQsQ0FBTjtBQUVEOztBQUNELGFBQVEsbUJBQWtCQSxVQUFXLEdBQXJDO0FBQ0QsS0FUcUIsRUFVckJFLElBVnFCLENBVWhCLElBVmdCLENBQXhCO0FBWUEsV0FBT0osb0JBQW9CLENBQUNQLE9BQXJCLENBR0wsSUFBSUMsTUFBSixDQUFZLGNBQWExQyxnQkFBRTJDLFlBQUYsQ0FBZXpELCtCQUFmLENBQWdELE9BQXpFLEVBQWlGLElBQWpGLENBSEssRUFJSixLQUFJK0QsZUFBZ0IsRUFKaEIsQ0FBUDtBQU1EOztBQUVELFFBQU1qQyxlQUFOLEdBQXlCO0FBQ3ZCLFVBQU07QUFBQ0UsTUFBQUEsR0FBRDtBQUFNekIsTUFBQUE7QUFBTixRQUFjLEtBQUt3QixVQUFMLEVBQXBCOztBQUNBWCxvQkFBSStDLEtBQUosQ0FBVyxpQ0FBZ0NuQyxHQUFJLElBQUd6QixJQUFJLENBQUMyRCxJQUFMLENBQVUsR0FBVixDQUFlLElBQXZELEdBQ1AsaUJBQWdCLEtBQUsxRCxVQUFXLEdBRG5DOztBQUVBLFVBQU00RCxXQUFXLEdBQUcsSUFBSUMsd0JBQUosQ0FBZXJDLEdBQWYsRUFBb0J6QixJQUFwQixFQUEwQjtBQUM1QytELE1BQUFBLEdBQUcsRUFBRSxLQUFLOUQsVUFEa0M7QUFFNUMrRCxNQUFBQSxLQUFLLEVBQUUsQ0FBQyxRQUFELEVBQVcsTUFBWCxFQUFtQixNQUFuQjtBQUZxQyxLQUExQixDQUFwQjtBQUlBLFFBQUlDLGNBQWMsR0FBRyxFQUFyQjtBQUVBLFVBQU1DLE1BQU0sR0FBSSxzQkFBcUIsS0FBS2hFLGFBQUwsR0FBcUIsTUFBckIsR0FBOEIsVUFBVyxZQUE5RTs7QUFDQVcsb0JBQUkrQyxLQUFKLENBQVcsR0FBRU0sTUFBTywwREFBcEI7O0FBQ0FMLElBQUFBLFdBQVcsQ0FBQ00sRUFBWixDQUFlLGFBQWYsRUFBOEJDLElBQUksSUFBSTtBQUNwQyxVQUFJLEtBQUtsRSxhQUFULEVBQXdCO0FBQ3RCLFlBQUlrRSxJQUFJLENBQUNDLFVBQUwsQ0FBZ0IsVUFBaEIsQ0FBSixFQUFpQztBQUMvQjFFLFVBQUFBLFNBQVMsQ0FBQ21CLElBQVYsQ0FBZXNELElBQWY7QUFDRCxTQUZELE1BRU87QUFDTHpFLFVBQUFBLFNBQVMsQ0FBQzJFLElBQVYsQ0FBZUYsSUFBZjtBQUNEO0FBQ0Y7O0FBQ0RILE1BQUFBLGNBQWMsQ0FBQzdCLElBQWYsQ0FBcUIsR0FBRW1DLE9BQUksR0FBRUgsSUFBSyxFQUFsQzs7QUFDQSxVQUFJSCxjQUFjLENBQUNPLE1BQWYsR0FBd0JoRiwwQkFBNUIsRUFBd0Q7QUFDdER5RSxRQUFBQSxjQUFjLEdBQUdBLGNBQWMsQ0FBQy9CLEtBQWYsQ0FBcUIsQ0FBQzFDLDBCQUF0QixDQUFqQjtBQUNEO0FBQ0YsS0FaRDs7QUFjQSxRQUFJO0FBQ0YsWUFBTXFFLFdBQVcsQ0FBQ1ksS0FBWixFQUFOO0FBQ0EsWUFBTVosV0FBVyxDQUFDRixJQUFaLEVBQU47QUFDRCxLQUhELENBR0UsT0FBT2UsR0FBUCxFQUFZO0FBQ1osVUFBSUMsR0FBRyxHQUFJLHFDQUFvQ0QsR0FBRyxDQUFDRSxPQUFRLElBQWpELEdBQ1Asd0JBQXVCTCxPQUFJLEdBQUVOLGNBQWUsRUFEL0M7O0FBRUFwRCxzQkFBSWdFLGFBQUosQ0FBa0JGLEdBQWxCO0FBQ0Q7QUFDRjs7QUEvSGlCOzs7ZUFtSUw3RSxhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3ViUHJvY2VzcyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBmcywgbG9nZ2VyLCBzeXN0ZW0gfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IEVPTCB9IGZyb20gJ29zJztcblxuY29uc3QgR1JBRExFX1ZFUlNJT05fS0VZID0gJ2dyYWRsZSc7XG5jb25zdCBHUkFETEVfVVJMX1BSRUZJWCA9ICdkaXN0cmlidXRpb25Vcmw9JztcbmNvbnN0IEdSQURMRV9VUkxfVEVNUExBVEUgPSAnaHR0cHNcXFxcOi8vc2VydmljZXMuZ3JhZGxlLm9yZy9kaXN0cmlidXRpb25zL2dyYWRsZS1WRVJTSU9OLWFsbC56aXAnO1xuY29uc3QgR1JBRExFX01BWF9FUlJPUl9MT0dfTElORVMgPSAxNTtcblxuY29uc3QgR1JBRExFX0RFUEVOREVOQ0lFU19QTEFDRUhPTERFUiA9ICcvLyBhZGRpdGlvbmFsQXBwRGVwZW5kZW5jaWVzIHBsYWNlaG9sZGVyIChkb25cXCd0IGNoYW5nZSBvciBkZWxldGUgdGhpcyBsaW5lKSc7XG5cbmNvbnN0IFZFUlNJT05fS0VZUyA9IFtcbiAgR1JBRExFX1ZFUlNJT05fS0VZLFxuICAnYW5kcm9pZEdyYWRsZVBsdWdpbicsXG4gICdjb21waWxlU2RrJyxcbiAgJ2J1aWxkVG9vbHMnLFxuICAnbWluU2RrJyxcbiAgJ3RhcmdldFNkaycsXG4gICdrb3RsaW4nXG5dO1xuXG5jb25zdCBncmFkbGVMb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKCdHcmFkbGUnKTtcblxuY2xhc3MgU2VydmVyQnVpbGRlciB7XG4gIGNvbnN0cnVjdG9yIChhcmdzID0ge30pIHtcbiAgICB0aGlzLnNlcnZlclBhdGggPSBhcmdzLnNlcnZlclBhdGg7XG4gICAgdGhpcy5zaG93R3JhZGxlTG9nID0gYXJncy5zaG93R3JhZGxlTG9nO1xuXG4gICAgY29uc3QgYnVpbGRDb25maWd1cmF0aW9uID0gYXJncy5idWlsZENvbmZpZ3VyYXRpb24gfHwge307XG5cbiAgICBjb25zdCB2ZXJzaW9uQ29uZmlndXJhdGlvbiA9IGJ1aWxkQ29uZmlndXJhdGlvbi50b29sc1ZlcnNpb25zIHx8IHt9O1xuICAgIHRoaXMuc2VydmVyVmVyc2lvbnMgPSBfLnJlZHVjZSh2ZXJzaW9uQ29uZmlndXJhdGlvbiwgKGFjYywgdmFsdWUsIGtleSkgPT4ge1xuICAgICAgaWYgKFZFUlNJT05fS0VZUy5pbmNsdWRlcyhrZXkpKSB7XG4gICAgICAgIGFjY1trZXldID0gdmFsdWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cud2FybihgR290IHVuZXhwZWN0ZWQgJyR7a2V5fScgaW4gdG9vbHNWZXJzaW9uIGJsb2NrIG9mIHRoZSBidWlsZCBjb25maWd1cmF0aW9uYCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHt9KTtcblxuICAgIHRoaXMuYWRkaXRpb25hbEFwcERlcGVuZGVuY2llcyA9IGJ1aWxkQ29uZmlndXJhdGlvbi5hZGRpdGlvbmFsQXBwRGVwZW5kZW5jaWVzIHx8IFtdO1xuICB9XG5cbiAgYXN5bmMgYnVpbGQgKCkge1xuICAgIGlmICh0aGlzLnNlcnZlclZlcnNpb25zW0dSQURMRV9WRVJTSU9OX0tFWV0pIHtcbiAgICAgIGF3YWl0IHRoaXMuc2V0R3JhZGxlV3JhcHBlclZlcnNpb24odGhpcy5zZXJ2ZXJWZXJzaW9uc1tHUkFETEVfVkVSU0lPTl9LRVldKTtcbiAgICB9XG5cbiAgICBpZiAoIUFycmF5LmlzQXJyYXkodGhpcy5hZGRpdGlvbmFsQXBwRGVwZW5kZW5jaWVzKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdhZGRpdGlvbmFsQXBwRGVwZW5kZW5jaWVzIG11c3QgYmUgYW4gYXJyYXknKTtcbiAgICB9XG4gICAgaWYgKCFfLmlzRW1wdHkodGhpcy5hZGRpdGlvbmFsQXBwRGVwZW5kZW5jaWVzKSkge1xuICAgICAgYXdhaXQgdGhpcy5pbnNlcnRBZGRpdGlvbmFsQXBwRGVwZW5kZW5jaWVzKHRoaXMuYWRkaXRpb25hbEFwcERlcGVuZGVuY2llcyk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5ydW5CdWlsZFByb2Nlc3MoKTtcbiAgfVxuXG4gIGdldENvbW1hbmQgKCkge1xuICAgIGNvbnN0IGNtZCA9IHN5c3RlbS5pc1dpbmRvd3MoKSA/ICdncmFkbGV3LmJhdCcgOiAnLi9ncmFkbGV3JztcbiAgICBsZXQgYXJncyA9IFZFUlNJT05fS0VZU1xuICAgICAgLmZpbHRlcihrZXkgPT4ga2V5ICE9PSBHUkFETEVfVkVSU0lPTl9LRVkpXG4gICAgICAubWFwKGtleSA9PiB7XG4gICAgICAgIGNvbnN0IHNlcnZlclZlcnNpb24gPSB0aGlzLnNlcnZlclZlcnNpb25zW2tleV07XG4gICAgICAgIGNvbnN0IGdyYWRsZVByb3BlcnR5ID0gYGFwcGl1bSR7a2V5LmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpfSR7a2V5LnNsaWNlKDEpfWA7XG4gICAgICAgIHJldHVybiBzZXJ2ZXJWZXJzaW9uID8gYC1QJHtncmFkbGVQcm9wZXJ0eX09JHtzZXJ2ZXJWZXJzaW9ufWAgOiBudWxsO1xuICAgICAgfSlcbiAgICAgIC5maWx0ZXIoQm9vbGVhbik7XG5cbiAgICBhcmdzLnB1c2goJ2Fzc2VtYmxlQW5kcm9pZFRlc3QnKTtcblxuICAgIHJldHVybiB7Y21kLCBhcmdzfTtcbiAgfVxuXG4gIGFzeW5jIHNldEdyYWRsZVdyYXBwZXJWZXJzaW9uICh2ZXJzaW9uKSB7XG4gICAgY29uc3QgcHJvcGVydGllc1BhdGggPSBwYXRoLnJlc29sdmUodGhpcy5zZXJ2ZXJQYXRoLCAnZ3JhZGxlJywgJ3dyYXBwZXInLCAnZ3JhZGxlLXdyYXBwZXIucHJvcGVydGllcycpO1xuICAgIGNvbnN0IG9yaWdpbmFsUHJvcGVydGllcyA9IGF3YWl0IGZzLnJlYWRGaWxlKHByb3BlcnRpZXNQYXRoLCAndXRmOCcpO1xuICAgIGNvbnN0IG5ld1Byb3BlcnRpZXMgPSB0aGlzLnVwZGF0ZUdyYWRsZURpc3RVcmwob3JpZ2luYWxQcm9wZXJ0aWVzLCB2ZXJzaW9uKTtcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUocHJvcGVydGllc1BhdGgsIG5ld1Byb3BlcnRpZXMsICd1dGY4Jyk7XG4gIH1cblxuICB1cGRhdGVHcmFkbGVEaXN0VXJsIChwcm9wZXJ0aWVzQ29udGVudCwgdmVyc2lvbikge1xuICAgIHJldHVybiBwcm9wZXJ0aWVzQ29udGVudC5yZXBsYWNlKFxuICAgICAgbmV3IFJlZ0V4cChgXigke18uZXNjYXBlUmVnRXhwKEdSQURMRV9VUkxfUFJFRklYKX0pLiskYCwgJ2dtJyksXG4gICAgICBgJDEke0dSQURMRV9VUkxfVEVNUExBVEUucmVwbGFjZSgnVkVSU0lPTicsIHZlcnNpb24pfWBcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgaW5zZXJ0QWRkaXRpb25hbEFwcERlcGVuZGVuY2llcyAoYWRkaXRpb25hbEFwcERlcGVuZGVuY2llcykge1xuICAgIGNvbnN0IGJ1aWxkUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLnNlcnZlclBhdGgsICdhcHAnLCAnYnVpbGQuZ3JhZGxlJyk7XG4gICAgY29uc3Qgb3JpZ2luYWxDb25maWd1cmF0aW9uID0gYXdhaXQgZnMucmVhZEZpbGUoYnVpbGRQYXRoLCAndXRmOCcpO1xuICAgIGNvbnN0IG5ld0NvbmZpZ3VyYXRpb24gPSB0aGlzLnVwZGF0ZURlcGVuZGVuY3lMaW5lcyhvcmlnaW5hbENvbmZpZ3VyYXRpb24sIGFkZGl0aW9uYWxBcHBEZXBlbmRlbmNpZXMpO1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZShidWlsZFBhdGgsIG5ld0NvbmZpZ3VyYXRpb24sICd1dGY4Jyk7XG4gIH1cblxuICB1cGRhdGVEZXBlbmRlbmN5TGluZXMgKGNvbmZpZ3VyYXRpb25Db250ZW50LCBhZGRpdGlvbmFsQXBwRGVwZW5kZW5jaWVzKSB7XG4gICAgY29uc3QgZGVwZW5kZW5jeUxpbmVzID0gYWRkaXRpb25hbEFwcERlcGVuZGVuY2llc1xuICAgICAgLm1hcChmdW5jdGlvbiAoZGVwZW5kZW5jeSkge1xuICAgICAgICAvLyBEaXNhbGxvdyB3aGl0ZXNwYWNlIGFuZCBxdW90ZSBjaGFyYWN0ZXJzIHRoYXQgY2FuIGJyZWFrIHN0cmluZyBsaXRlcmFscyBpbiBhIHBhdGNoZWQgYnVpbGQuZ3JhZGxlXG4gICAgICAgIC8vIGFuZCBkb2xsYXIgY2hhcmFjdGVycyB0aGF0IG90aGVyd2lzZSB3b3VsZCBiZSBpbnRlcnByZXRlZCBieSBTdHJpbmcucmVwbGFjZSBiZWxvd1xuICAgICAgICBpZiAoL1tcXHMnXFxcXCRdLy50ZXN0KGRlcGVuZGVuY3kpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTaW5nbGUgcXVvdGVzLCBkb2xsYXIgY2hhcmFjdGVycyBhbmQgd2hpdGVzcGFjZSBjaGFyYWN0ZXJzJyArXG4gICAgICAgICAgICBgIGFyZSBkaXNhbGxvd2VkIGluIGFkZGl0aW9uYWwgZGVwZW5kZW5jaWVzOiAke2RlcGVuZGVuY3l9YCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGBpbXBsZW1lbnRhdGlvbiAnJHtkZXBlbmRlbmN5fSdgO1xuICAgICAgfSlcbiAgICAgIC5qb2luKCckMScpOyAvLyBpbnRlcnByZXRlZCBhcyBHcm91cCAxIGZyb20gdGhlIHBhdHRlcm4gYmVsb3dcblxuICAgIHJldHVybiBjb25maWd1cmF0aW9uQ29udGVudC5yZXBsYWNlKFxuICAgICAgLy8gR3JvdXAgMSBjYXB0dXJlcyBuZXcgbGluZSBjaGFyYWN0ZXJzIGFuZCBpbmRlbnRhdGlvbiAoZWcuICdcXG5cXHQnKSB1c2VkIGluIGJ1aWxkLmdyYWRsZSBmaWxlXG4gICAgICAvLyBUaGlzIGVuc3VyZXMgdGhhdCBhIHBhdGNoZWQgYnVpbGQuZ3JhZGxlIHdpbGwgaGF2ZSBjb3JyZWN0IG5ldyBsaW5lcyBhbmQgaW5kZW50YXRpb25cbiAgICAgIG5ldyBSZWdFeHAoYChcXFxccypeXFxcXHMqKSR7Xy5lc2NhcGVSZWdFeHAoR1JBRExFX0RFUEVOREVOQ0lFU19QTEFDRUhPTERFUil9XFxcXHMqJGAsICdnbScpLFxuICAgICAgYCQxJHtkZXBlbmRlbmN5TGluZXN9YFxuICAgICk7XG4gIH1cblxuICBhc3luYyBydW5CdWlsZFByb2Nlc3MgKCkge1xuICAgIGNvbnN0IHtjbWQsIGFyZ3N9ID0gdGhpcy5nZXRDb21tYW5kKCk7XG4gICAgbG9nLmRlYnVnKGBCZWdpbm5pbmcgYnVpbGQgd2l0aCBjb21tYW5kICcke2NtZH0gJHthcmdzLmpvaW4oJyAnKX0nIGAgK1xuICAgICAgYGluIGRpcmVjdG9yeSAnJHt0aGlzLnNlcnZlclBhdGh9J2ApO1xuICAgIGNvbnN0IGdyYWRsZWJ1aWxkID0gbmV3IFN1YlByb2Nlc3MoY21kLCBhcmdzLCB7XG4gICAgICBjd2Q6IHRoaXMuc2VydmVyUGF0aCxcbiAgICAgIHN0ZGlvOiBbJ2lnbm9yZScsICdwaXBlJywgJ3BpcGUnXSxcbiAgICB9KTtcbiAgICBsZXQgYnVpbGRMYXN0TGluZXMgPSBbXTtcblxuICAgIGNvbnN0IGxvZ01zZyA9IGBPdXRwdXQgZnJvbSBHcmFkbGUgJHt0aGlzLnNob3dHcmFkbGVMb2cgPyAnd2lsbCcgOiAnd2lsbCBub3QnfSBiZSBsb2dnZWRgO1xuICAgIGxvZy5kZWJ1ZyhgJHtsb2dNc2d9LiBUbyBjaGFuZ2UgdGhpcywgdXNlICdzaG93R3JhZGxlTG9nJyBkZXNpcmVkIGNhcGFiaWxpdHlgKTtcbiAgICBncmFkbGVidWlsZC5vbignc3RyZWFtLWxpbmUnLCBsaW5lID0+IHtcbiAgICAgIGlmICh0aGlzLnNob3dHcmFkbGVMb2cpIHtcbiAgICAgICAgaWYgKGxpbmUuc3RhcnRzV2l0aCgnW1NUREVSUl0nKSkge1xuICAgICAgICAgIGdyYWRsZUxvZy53YXJuKGxpbmUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGdyYWRsZUxvZy5pbmZvKGxpbmUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBidWlsZExhc3RMaW5lcy5wdXNoKGAke0VPTH0ke2xpbmV9YCk7XG4gICAgICBpZiAoYnVpbGRMYXN0TGluZXMubGVuZ3RoID4gR1JBRExFX01BWF9FUlJPUl9MT0dfTElORVMpIHtcbiAgICAgICAgYnVpbGRMYXN0TGluZXMgPSBidWlsZExhc3RMaW5lcy5zbGljZSgtR1JBRExFX01BWF9FUlJPUl9MT0dfTElORVMpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGdyYWRsZWJ1aWxkLnN0YXJ0KCk7XG4gICAgICBhd2FpdCBncmFkbGVidWlsZC5qb2luKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsZXQgbXNnID0gYFVuYWJsZSB0byBidWlsZCBFc3ByZXNzbyBzZXJ2ZXIgLSAke2Vyci5tZXNzYWdlfVxcbmAgK1xuICAgICAgICBgR3JhZGxlIGVycm9yIG1lc3NhZ2U6JHtFT0x9JHtidWlsZExhc3RMaW5lc31gO1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3cobXNnKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IHsgU2VydmVyQnVpbGRlciwgVkVSU0lPTl9LRVlTLCBHUkFETEVfVVJMX1RFTVBMQVRFLCBHUkFETEVfREVQRU5ERU5DSUVTX1BMQUNFSE9MREVSIH07XG5leHBvcnQgZGVmYXVsdCBTZXJ2ZXJCdWlsZGVyOyJdLCJmaWxlIjoibGliL3NlcnZlci1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
