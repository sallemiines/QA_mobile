"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.detectUdid = detectUdid;
exports.getAndCheckXcodeVersion = getAndCheckXcodeVersion;
exports.getAndCheckIosSdkVersion = getAndCheckIosSdkVersion;
exports.getGenericSimulatorForIosVersion = getGenericSimulatorForIosVersion;
exports.checkAppPresent = checkAppPresent;
exports.getDriverInfo = getDriverInfo;
exports.clearSystemFiles = clearSystemFiles;
exports.translateDeviceName = translateDeviceName;
exports.normalizeCommandTimeouts = normalizeCommandTimeouts;
exports.resetXCTestProcesses = resetXCTestProcesses;
exports.getPIDsUsingPattern = getPIDsUsingPattern;
exports.markSystemFilesForCleanup = markSystemFilesForCleanup;
exports.printUser = printUser;
exports.getPIDsListeningOnPort = getPIDsListeningOnPort;
exports.encodeBase64OrUpload = encodeBase64OrUpload;
exports.removeAllSessionWebSocketHandlers = removeAllSessionWebSocketHandlers;
exports.verifyApplicationPlatform = verifyApplicationPlatform;
exports.isTvOS = isTvOS;
exports.isLocalHost = isLocalHost;
exports.normalizePlatformVersion = normalizePlatformVersion;
exports.DEFAULT_TIMEOUT_KEY = void 0;

require("source-map-support/register");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumIosDevice = require("appium-ios-device");

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _appiumIosDriver = require("appium-ios-driver");

var _teen_process = require("teen_process");

var _appiumXcode = _interopRequireDefault(require("appium-xcode"));

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _iosGenericSimulators = _interopRequireDefault(require("./ios-generic-simulators"));

var _fs2 = _interopRequireDefault(require("fs"));

var _url = _interopRequireDefault(require("url"));

var _v = _interopRequireDefault(require("v8"));

var _desiredCaps = require("./desired-caps");

var _semver = _interopRequireDefault(require("semver"));

const DEFAULT_TIMEOUT_KEY = 'default';
exports.DEFAULT_TIMEOUT_KEY = DEFAULT_TIMEOUT_KEY;

async function detectUdid() {
  _logger.default.debug('Auto-detecting real device udid...');

  const udids = await _appiumIosDevice.utilities.getConnectedDevices();

  if (_lodash.default.isEmpty(udids)) {
    throw new Error('No device is connected to the host');
  }

  const udid = _lodash.default.last(udids);

  if (udids.length > 1) {
    _logger.default.warn(`Multiple devices found: ${udids.join(', ')}`);

    _logger.default.warn(`Choosing '${udid}'. If this is wrong, manually set with 'udid' desired capability`);
  }

  _logger.default.debug(`Detected real device udid: '${udid}'`);

  return udid;
}

async function getAndCheckXcodeVersion() {
  let version;

  try {
    version = await _appiumXcode.default.getVersion(true);
  } catch (err) {
    _logger.default.debug(err);

    _logger.default.errorAndThrow(`Could not determine Xcode version: ${err.message}`);
  }

  if (version.versionFloat < 7.3) {
    _logger.default.errorAndThrow(`Xcode version '${version.versionString}'. Support for ` + `Xcode ${version.versionString} is not supported. ` + `Please upgrade to version 7.3 or higher`);
  }

  return version;
}

async function getAndCheckIosSdkVersion() {
  try {
    return await _appiumXcode.default.getMaxIOSSDK();
  } catch (err) {
    _logger.default.errorAndThrow(`Could not determine iOS SDK version: ${err.message}`);
  }
}

function getGenericSimulatorForIosVersion(platformVersion, deviceName) {
  let genericSimulators = _iosGenericSimulators.default[deviceName];

  if (genericSimulators) {
    genericSimulators = genericSimulators.sort(([simOne], [simTwo]) => _appiumSupport.util.compareVersions(simOne, '<', simTwo) ? -1 : 1);
    let genericIosSimulator;

    for (const [platformVersionFromList, iosSimulator] of genericSimulators) {
      if (_appiumSupport.util.compareVersions(platformVersionFromList, '>', platformVersion)) {
        break;
      }

      genericIosSimulator = iosSimulator;
    }

    return genericIosSimulator;
  }
}

function translateDeviceName(platformVersion, deviceName = '') {
  const deviceNameTranslated = getGenericSimulatorForIosVersion(platformVersion, deviceName.toLowerCase().trim());

  if (deviceNameTranslated) {
    _logger.default.debug(`Changing deviceName from '${deviceName}' to '${deviceNameTranslated}'`);

    return deviceNameTranslated;
  }

  return deviceName;
}

const derivedDataCleanupMarkers = new Map();

async function markSystemFilesForCleanup(wda) {
  if (!wda || !(await wda.retrieveDerivedDataPath())) {
    _logger.default.warn('No WebDriverAgent derived data available, so unable to mark system files for cleanup');

    return;
  }

  const logsRoot = _path.default.resolve((await wda.retrieveDerivedDataPath()), 'Logs');

  let markersCount = 0;

  if (derivedDataCleanupMarkers.has(logsRoot)) {
    markersCount = derivedDataCleanupMarkers.get(logsRoot);
  }

  derivedDataCleanupMarkers.set(logsRoot, ++markersCount);
}

async function clearSystemFiles(wda) {
  if (!wda || !(await wda.retrieveDerivedDataPath())) {
    _logger.default.warn('No WebDriverAgent derived data available, so unable to clear system files');

    return;
  }

  const logsRoot = _path.default.resolve((await wda.retrieveDerivedDataPath()), 'Logs');

  if (derivedDataCleanupMarkers.has(logsRoot)) {
    let markersCount = derivedDataCleanupMarkers.get(logsRoot);
    derivedDataCleanupMarkers.set(logsRoot, --markersCount);

    if (markersCount > 0) {
      _logger.default.info(`Not cleaning '${logsRoot}' folder, because the other session does not expect it to be cleaned`);

      return;
    }
  }

  derivedDataCleanupMarkers.set(logsRoot, 0);
  const cleanupCmd = `find -E /private/var/folders ` + `-regex '.*/Session-WebDriverAgentRunner.*\\.log$|.*/StandardOutputAndStandardError\\.txt$' ` + `-type f -exec sh -c 'echo "" > "{}"' \\;`;
  const cleanupTask = new _teen_process.SubProcess('bash', ['-c', cleanupCmd], {
    detached: true,
    stdio: ['ignore', 'pipe', 'pipe']
  });
  await cleanupTask.start(0, true);

  _logger.default.debug(`Started background XCTest logs cleanup: ${cleanupCmd}`);

  if (await _appiumSupport.fs.exists(logsRoot)) {
    _logger.default.info(`Cleaning test logs in '${logsRoot}' folder`);

    await _appiumIosDriver.utils.clearLogs([logsRoot]);
    return;
  }

  _logger.default.info(`There is no ${logsRoot} folder, so not cleaning files`);
}

async function checkAppPresent(app) {
  _logger.default.debug(`Checking whether app '${app}' is actually present on file system`);

  if (!(await _appiumSupport.fs.exists(app))) {
    _logger.default.errorAndThrow(`Could not find app at '${app}'`);
  }

  _logger.default.debug('App is present');
}

async function getDriverInfo() {
  const stat = await _appiumSupport.fs.stat(_path.default.resolve(__dirname, '..'));
  const built = stat.mtime.getTime();

  const pkg = require(__filename.includes('build/lib/utils') ? '../../package.json' : '../package.json');

  const version = pkg.version;
  return {
    built,
    version
  };
}

function normalizeCommandTimeouts(value) {
  if (typeof value !== 'string') {
    return value;
  }

  let result = {};

  if (!isNaN(value)) {
    result[DEFAULT_TIMEOUT_KEY] = _lodash.default.toInteger(value);
    return result;
  }

  try {
    result = JSON.parse(value);

    if (!_lodash.default.isPlainObject(result)) {
      throw new Error();
    }
  } catch (err) {
    _logger.default.errorAndThrow(`"commandTimeouts" capability should be a valid JSON object. "${value}" was given instead`);
  }

  for (let [cmd, timeout] of _lodash.default.toPairs(result)) {
    if (!_lodash.default.isInteger(timeout) || timeout <= 0) {
      _logger.default.errorAndThrow(`The timeout for "${cmd}" should be a valid natural number of milliseconds. "${timeout}" was given instead`);
    }
  }

  return result;
}

async function getPIDsUsingPattern(pattern, opts = {}) {
  const {
    multi = false,
    ignoreCase = true
  } = opts;
  const args = [`-${ignoreCase ? 'i' : ''}f${multi ? '' : 'n'}`, pattern];

  try {
    const {
      stdout
    } = await (0, _teen_process.exec)('pgrep', args);

    if (multi) {
      const result = stdout.split('\n').filter(x => parseInt(x, 10)).map(x => `${parseInt(x, 10)}`);
      return _lodash.default.isEmpty(result) ? null : result;
    }

    const pid = parseInt(stdout, 10);
    return isNaN(pid) ? null : `${pid}`;
  } catch (err) {
    _logger.default.debug(`'pgrep ${args.join(' ')}' didn't detect any matching processes. Return code: ${err.code}`);

    return null;
  }
}

async function killAppUsingPattern(pgrepPattern) {
  for (const signal of [2, 15, 9]) {
    if (!(await getPIDsUsingPattern(pgrepPattern))) {
      return;
    }

    const args = [`-${signal}`, '-if', pgrepPattern];

    try {
      await (0, _teen_process.exec)('pkill', args);
    } catch (err) {
      _logger.default.debug(`pkill ${args.join(' ')} -> ${err.message}`);
    }

    await _bluebird.default.delay(100);
  }
}

async function resetXCTestProcesses(udid, isSimulator) {
  const processPatterns = [`xcodebuild.*${udid}`];

  if (isSimulator) {
    processPatterns.push(`${udid}.*XCTRunner`);
    processPatterns.push(`xctest.*${udid}`);
  }

  _logger.default.debug(`Killing running processes '${processPatterns.join(', ')}' for the device ${udid}...`);

  for (const pgrepPattern of processPatterns) {
    await killAppUsingPattern(pgrepPattern);
  }
}

async function printUser() {
  try {
    let {
      stdout
    } = await (0, _teen_process.exec)('whoami');

    _logger.default.debug(`Current user: '${stdout.trim()}'`);
  } catch (err) {
    _logger.default.debug(`Unable to get username running server: ${err.message}`);
  }
}

async function getPIDsListeningOnPort(port, filteringFunc = null) {
  const result = [];

  try {
    const {
      stdout
    } = await (0, _teen_process.exec)('lsof', ['-ti', `tcp:${port}`]);
    result.push(...stdout.trim().split(/\n+/));
  } catch (e) {
    return result;
  }

  if (!_lodash.default.isFunction(filteringFunc)) {
    return result;
  }

  return await _bluebird.default.filter(result, async x => {
    const {
      stdout
    } = await (0, _teen_process.exec)('ps', ['-p', x, '-o', 'command']);
    return await filteringFunc(stdout);
  });
}

async function encodeBase64OrUpload(localFile, remotePath = null, uploadOptions = {}) {
  if (!(await _appiumSupport.fs.exists(localFile))) {
    _logger.default.errorAndThrow(`The file at '${localFile}' does not exist or is not accessible`);
  }

  const {
    size
  } = await _appiumSupport.fs.stat(localFile);

  _logger.default.debug(`The size of the file is ${_appiumSupport.util.toReadableSizeString(size)}`);

  if (_lodash.default.isEmpty(remotePath)) {
    const maxMemoryLimit = _v.default.getHeapStatistics().total_available_size / 2;

    if (size >= maxMemoryLimit) {
      _logger.default.info(`The file might be too large to fit into the process memory ` + `(${_appiumSupport.util.toReadableSizeString(size)} >= ${_appiumSupport.util.toReadableSizeString(maxMemoryLimit)}). ` + `Provide a link to a remote writable location for video upload ` + `(http(s) and ftp protocols are supported) if you experience Out Of Memory errors`);
    }

    const content = await _appiumSupport.fs.readFile(localFile);
    return content.toString('base64');
  }

  const remoteUrl = _url.default.parse(remotePath);

  let options = {};
  const {
    user,
    pass,
    method
  } = uploadOptions;

  if (remoteUrl.protocol.startsWith('http')) {
    options = {
      url: remoteUrl.href,
      method: method || 'PUT',
      multipart: [{
        body: _fs2.default.createReadStream(localFile)
      }]
    };

    if (user && pass) {
      options.auth = {
        user,
        pass
      };
    }
  } else if (remoteUrl.protocol === 'ftp:') {
    options = {
      host: remoteUrl.hostname,
      port: remoteUrl.port || 21
    };

    if (user && pass) {
      options.user = user;
      options.pass = pass;
    }
  }

  await _appiumSupport.net.uploadFile(localFile, remotePath, options);
  return '';
}

async function removeAllSessionWebSocketHandlers(server, sessionId) {
  if (!server || !_lodash.default.isFunction(server.getWebSocketHandlers)) {
    return;
  }

  const activeHandlers = await server.getWebSocketHandlers(sessionId);

  for (const pathname of _lodash.default.keys(activeHandlers)) {
    await server.removeWebSocketHandler(pathname);
  }
}

async function verifyApplicationPlatform(app, isSimulator, isTvOS) {
  _logger.default.debug('Verifying application platform');

  const infoPlist = _path.default.resolve(app, 'Info.plist');

  if (!(await _appiumSupport.fs.exists(infoPlist))) {
    _logger.default.debug(`'${infoPlist}' does not exist`);

    return null;
  }

  const {
    CFBundleSupportedPlatforms
  } = await _appiumSupport.plist.parsePlistFile(infoPlist);

  _logger.default.debug(`CFBundleSupportedPlatforms: ${JSON.stringify(CFBundleSupportedPlatforms)}`);

  if (!_lodash.default.isArray(CFBundleSupportedPlatforms)) {
    _logger.default.debug(`CFBundleSupportedPlatforms key does not exist in '${infoPlist}'`);

    return null;
  }

  const expectedPlatform = isSimulator ? isTvOS ? 'AppleTVSimulator' : 'iPhoneSimulator' : isTvOS ? 'AppleTVOS' : 'iPhoneOS';
  const isAppSupported = CFBundleSupportedPlatforms.includes(expectedPlatform);

  if (isAppSupported) {
    return true;
  }

  throw new Error(`${isSimulator ? 'Simulator' : 'Real device'} architecture is unsupported by the '${app}' application. ` + `Make sure the correct deployment target has been selected for its compilation in Xcode.`);
}

function isTvOS(platformName) {
  return _lodash.default.toLower(platformName) === _lodash.default.toLower(_desiredCaps.PLATFORM_NAME_TVOS);
}

function isLocalHost(urlString) {
  try {
    const {
      hostname
    } = _url.default.parse(urlString);

    return ['localhost', '127.0.0.1', '::1', '::ffff:127.0.0.1'].includes(hostname);
  } catch (ign) {
    _logger.default.warn(`'${urlString}' cannot be parsed as a valid URL`);
  }

  return false;
}

function normalizePlatformVersion(originalVersion) {
  const normalizedVersion = _appiumSupport.util.coerceVersion(originalVersion, false);

  if (!normalizedVersion) {
    throw new Error(`The platform version '${originalVersion}' should be a valid version number`);
  }

  const {
    major,
    minor
  } = new _semver.default.SemVer(normalizedVersion);
  return `${major}.${minor}`;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91dGlscy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1RJTUVPVVRfS0VZIiwiZGV0ZWN0VWRpZCIsImxvZyIsImRlYnVnIiwidWRpZHMiLCJ1dGlsaXRpZXMiLCJnZXRDb25uZWN0ZWREZXZpY2VzIiwiXyIsImlzRW1wdHkiLCJFcnJvciIsInVkaWQiLCJsYXN0IiwibGVuZ3RoIiwid2FybiIsImpvaW4iLCJnZXRBbmRDaGVja1hjb2RlVmVyc2lvbiIsInZlcnNpb24iLCJ4Y29kZSIsImdldFZlcnNpb24iLCJlcnIiLCJlcnJvckFuZFRocm93IiwibWVzc2FnZSIsInZlcnNpb25GbG9hdCIsInZlcnNpb25TdHJpbmciLCJnZXRBbmRDaGVja0lvc1Nka1ZlcnNpb24iLCJnZXRNYXhJT1NTREsiLCJnZXRHZW5lcmljU2ltdWxhdG9yRm9ySW9zVmVyc2lvbiIsInBsYXRmb3JtVmVyc2lvbiIsImRldmljZU5hbWUiLCJnZW5lcmljU2ltdWxhdG9ycyIsImlvc0dlbmVyaWNTaW11bGF0b3JzIiwic29ydCIsInNpbU9uZSIsInNpbVR3byIsInV0aWwiLCJjb21wYXJlVmVyc2lvbnMiLCJnZW5lcmljSW9zU2ltdWxhdG9yIiwicGxhdGZvcm1WZXJzaW9uRnJvbUxpc3QiLCJpb3NTaW11bGF0b3IiLCJ0cmFuc2xhdGVEZXZpY2VOYW1lIiwiZGV2aWNlTmFtZVRyYW5zbGF0ZWQiLCJ0b0xvd2VyQ2FzZSIsInRyaW0iLCJkZXJpdmVkRGF0YUNsZWFudXBNYXJrZXJzIiwiTWFwIiwibWFya1N5c3RlbUZpbGVzRm9yQ2xlYW51cCIsIndkYSIsInJldHJpZXZlRGVyaXZlZERhdGFQYXRoIiwibG9nc1Jvb3QiLCJwYXRoIiwicmVzb2x2ZSIsIm1hcmtlcnNDb3VudCIsImhhcyIsImdldCIsInNldCIsImNsZWFyU3lzdGVtRmlsZXMiLCJpbmZvIiwiY2xlYW51cENtZCIsImNsZWFudXBUYXNrIiwiU3ViUHJvY2VzcyIsImRldGFjaGVkIiwic3RkaW8iLCJzdGFydCIsImZzIiwiZXhpc3RzIiwiaW9zVXRpbHMiLCJjbGVhckxvZ3MiLCJjaGVja0FwcFByZXNlbnQiLCJhcHAiLCJnZXREcml2ZXJJbmZvIiwic3RhdCIsIl9fZGlybmFtZSIsImJ1aWx0IiwibXRpbWUiLCJnZXRUaW1lIiwicGtnIiwicmVxdWlyZSIsIl9fZmlsZW5hbWUiLCJpbmNsdWRlcyIsIm5vcm1hbGl6ZUNvbW1hbmRUaW1lb3V0cyIsInZhbHVlIiwicmVzdWx0IiwiaXNOYU4iLCJ0b0ludGVnZXIiLCJKU09OIiwicGFyc2UiLCJpc1BsYWluT2JqZWN0IiwiY21kIiwidGltZW91dCIsInRvUGFpcnMiLCJpc0ludGVnZXIiLCJnZXRQSURzVXNpbmdQYXR0ZXJuIiwicGF0dGVybiIsIm9wdHMiLCJtdWx0aSIsImlnbm9yZUNhc2UiLCJhcmdzIiwic3Rkb3V0Iiwic3BsaXQiLCJmaWx0ZXIiLCJ4IiwicGFyc2VJbnQiLCJtYXAiLCJwaWQiLCJjb2RlIiwia2lsbEFwcFVzaW5nUGF0dGVybiIsInBncmVwUGF0dGVybiIsInNpZ25hbCIsIkIiLCJkZWxheSIsInJlc2V0WENUZXN0UHJvY2Vzc2VzIiwiaXNTaW11bGF0b3IiLCJwcm9jZXNzUGF0dGVybnMiLCJwdXNoIiwicHJpbnRVc2VyIiwiZ2V0UElEc0xpc3RlbmluZ09uUG9ydCIsInBvcnQiLCJmaWx0ZXJpbmdGdW5jIiwiZSIsImlzRnVuY3Rpb24iLCJlbmNvZGVCYXNlNjRPclVwbG9hZCIsImxvY2FsRmlsZSIsInJlbW90ZVBhdGgiLCJ1cGxvYWRPcHRpb25zIiwic2l6ZSIsInRvUmVhZGFibGVTaXplU3RyaW5nIiwibWF4TWVtb3J5TGltaXQiLCJ2OCIsImdldEhlYXBTdGF0aXN0aWNzIiwidG90YWxfYXZhaWxhYmxlX3NpemUiLCJjb250ZW50IiwicmVhZEZpbGUiLCJ0b1N0cmluZyIsInJlbW90ZVVybCIsInVybCIsIm9wdGlvbnMiLCJ1c2VyIiwicGFzcyIsIm1ldGhvZCIsInByb3RvY29sIiwic3RhcnRzV2l0aCIsImhyZWYiLCJtdWx0aXBhcnQiLCJib2R5IiwiX2ZzIiwiY3JlYXRlUmVhZFN0cmVhbSIsImF1dGgiLCJob3N0IiwiaG9zdG5hbWUiLCJuZXQiLCJ1cGxvYWRGaWxlIiwicmVtb3ZlQWxsU2Vzc2lvbldlYlNvY2tldEhhbmRsZXJzIiwic2VydmVyIiwic2Vzc2lvbklkIiwiZ2V0V2ViU29ja2V0SGFuZGxlcnMiLCJhY3RpdmVIYW5kbGVycyIsInBhdGhuYW1lIiwia2V5cyIsInJlbW92ZVdlYlNvY2tldEhhbmRsZXIiLCJ2ZXJpZnlBcHBsaWNhdGlvblBsYXRmb3JtIiwiaXNUdk9TIiwiaW5mb1BsaXN0IiwiQ0ZCdW5kbGVTdXBwb3J0ZWRQbGF0Zm9ybXMiLCJwbGlzdCIsInBhcnNlUGxpc3RGaWxlIiwic3RyaW5naWZ5IiwiaXNBcnJheSIsImV4cGVjdGVkUGxhdGZvcm0iLCJpc0FwcFN1cHBvcnRlZCIsInBsYXRmb3JtTmFtZSIsInRvTG93ZXIiLCJQTEFURk9STV9OQU1FX1RWT1MiLCJpc0xvY2FsSG9zdCIsInVybFN0cmluZyIsImlnbiIsIm5vcm1hbGl6ZVBsYXRmb3JtVmVyc2lvbiIsIm9yaWdpbmFsVmVyc2lvbiIsIm5vcm1hbGl6ZWRWZXJzaW9uIiwiY29lcmNlVmVyc2lvbiIsIm1ham9yIiwibWlub3IiLCJzZW12ZXIiLCJTZW1WZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxtQkFBbUIsR0FBRyxTQUE1Qjs7O0FBR0EsZUFBZUMsVUFBZixHQUE2QjtBQUMzQkMsa0JBQUlDLEtBQUosQ0FBVSxvQ0FBVjs7QUFDQSxRQUFNQyxLQUFLLEdBQUcsTUFBTUMsMkJBQVVDLG1CQUFWLEVBQXBCOztBQUNBLE1BQUlDLGdCQUFFQyxPQUFGLENBQVVKLEtBQVYsQ0FBSixFQUFzQjtBQUNwQixVQUFNLElBQUlLLEtB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Q0csSUFBQUEsS0FBRDtBQUFRQyxJQUFBQTtBQUFSLE1BQWlCLElBQUlDLGdCQUFPQyxNQUFYLENBQWtCTCxpQkFBbEIsQ0FBdkI7QUFDQSxTQUFRLEdBQUVFLEtBQU0sSUFBR0MsS0FBTSxFQUF6QjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgdXRpbGl0aWVzIH0gZnJvbSAnYXBwaXVtLWlvcy1kZXZpY2UnO1xuaW1wb3J0IHsgZnMsIHV0aWwsIG5ldCwgcGxpc3QgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHV0aWxzIGFzIGlvc1V0aWxzIH0gZnJvbSAnYXBwaXVtLWlvcy1kcml2ZXInO1xuaW1wb3J0IHsgU3ViUHJvY2VzcywgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeGNvZGUgZnJvbSAnYXBwaXVtLXhjb2RlJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBpb3NHZW5lcmljU2ltdWxhdG9ycyBmcm9tICcuL2lvcy1nZW5lcmljLXNpbXVsYXRvcnMnO1xuaW1wb3J0IF9mcyBmcm9tICdmcyc7XG5pbXBvcnQgdXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgdjggZnJvbSAndjgnO1xuaW1wb3J0IHsgUExBVEZPUk1fTkFNRV9UVk9TIH0gZnJvbSAnLi9kZXNpcmVkLWNhcHMnO1xuaW1wb3J0IHNlbXZlciBmcm9tICdzZW12ZXInO1xuXG5jb25zdCBERUZBVUxUX1RJTUVPVVRfS0VZID0gJ2RlZmF1bHQnO1xuXG5cbmFzeW5jIGZ1bmN0aW9uIGRldGVjdFVkaWQgKCkge1xuICBsb2cuZGVidWcoJ0F1dG8tZGV0ZWN0aW5nIHJlYWwgZGV2aWNlIHVkaWQuLi4nKTtcbiAgY29uc3QgdWRpZHMgPSBhd2FpdCB1dGlsaXRpZXMuZ2V0Q29ubmVjdGVkRGV2aWNlcygpO1xuICBpZiAoXy5pc0VtcHR5KHVkaWRzKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignTm8gZGV2aWNlIGlzIGNvbm5lY3RlZCB0byB0aGUgaG9zdCcpO1xuICB9XG4gIGNvbnN0IHVkaWQgPSBfLmxhc3QodWRpZHMpO1xuICBpZiAodWRpZHMubGVuZ3RoID4gMSkge1xuICAgIGxvZy53YXJuKGBNdWx0aXBsZSBkZXZpY2VzIGZvdW5kOiAke3VkaWRzLmpvaW4oJywgJyl9YCk7XG4gICAgbG9nLndhcm4oYENob29zaW5nICcke3VkaWR9Jy4gSWYgdGhpcyBpcyB3cm9uZywgbWFudWFsbHkgc2V0IHdpdGggJ3VkaWQnIGRlc2lyZWQgY2FwYWJpbGl0eWApO1xuICB9XG4gIGxvZy5kZWJ1ZyhgRGV0ZWN0ZWQgcmVhbCBkZXZpY2UgdWRpZDogJyR7dWRpZH0nYCk7XG4gIHJldHVybiB1ZGlkO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBbmRDaGVja1hjb2RlVmVyc2lvbiAoKSB7XG4gIGxldCB2ZXJzaW9uO1xuICB0cnkge1xuICAgIHZlcnNpb24gPSBhd2FpdCB4Y29kZS5nZXRWZXJzaW9uKHRydWUpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoZXJyKTtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ291bGQgbm90IGRldGVybWluZSBYY29kZSB2ZXJzaW9uOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG5cbiAgLy8gd2UgZG8gbm90IHN1cHBvcnQgWGNvZGVzIDwgNy4zLFxuICBpZiAodmVyc2lvbi52ZXJzaW9uRmxvYXQgPCA3LjMpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgWGNvZGUgdmVyc2lvbiAnJHt2ZXJzaW9uLnZlcnNpb25TdHJpbmd9Jy4gU3VwcG9ydCBmb3IgYCArXG4gICAgICAgICAgICAgICAgICAgICAgYFhjb2RlICR7dmVyc2lvbi52ZXJzaW9uU3RyaW5nfSBpcyBub3Qgc3VwcG9ydGVkLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgUGxlYXNlIHVwZ3JhZGUgdG8gdmVyc2lvbiA3LjMgb3IgaGlnaGVyYCk7XG4gIH1cbiAgcmV0dXJuIHZlcnNpb247XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFuZENoZWNrSW9zU2RrVmVyc2lvbiAoKSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IHhjb2RlLmdldE1heElPU1NESygpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ291bGQgbm90IGRldGVybWluZSBpT1MgU0RLIHZlcnNpb246ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cbn1cblxuLyoqXG4gKiBHZXQgdGhlIGdlbmVyaWMgc2ltdWxhdG9yIGZvciBhIGdpdmVuIElPUyB2ZXJzaW9uIGFuZCBkZXZpY2UgdHlwZSAoaVBob25lLCBpUGFkKVxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gcGxhdGZvcm1WZXJzaW9uIElPUyB2ZXJzaW9uLiBlLmcuKSAxMy4wXG4gKiBAcGFyYW0ge3N0cmluZ30gZGV2aWNlTmFtZSBUeXBlIG9mIElPUyBkZXZpY2UuIENhbiBiZSBpUGhvbmUsIGlQYWQgKHBvc3NpYmx5IG1vcmUgaW4gdGhlIGZ1dHVyZSlcbiAqXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBHZW5lcmljIGlQaG9uZSBvciBpUGFkIHNpbXVsYXRvciAoaWYgYXBwbGljYWJsZSlcbiAqL1xuZnVuY3Rpb24gZ2V0R2VuZXJpY1NpbXVsYXRvckZvcklvc1ZlcnNpb24gKHBsYXRmb3JtVmVyc2lvbiwgZGV2aWNlTmFtZSkge1xuICBsZXQgZ2VuZXJpY1NpbXVsYXRvcnMgPSBpb3NHZW5lcmljU2ltdWxhdG9yc1tkZXZpY2VOYW1lXTtcblxuICBpZiAoZ2VuZXJpY1NpbXVsYXRvcnMpIHtcbiAgICBnZW5lcmljU2ltdWxhdG9ycyA9IGdlbmVyaWNTaW11bGF0b3JzLnNvcnQoKFtzaW1PbmVdLCBbc2ltVHdvXSkgPT4gdXRpbC5jb21wYXJlVmVyc2lvbnMoc2ltT25lLCAnPCcsIHNpbVR3bykgPyAtMSA6IDEpO1xuXG4gICAgLy8gRmluZCB0aGUgaGlnaGVzdCBpT1MgdmVyc2lvbiBpbiB0aGUgbGlzdCB0aGF0IGlzIGJlbG93IHRoZSBwcm92aWRlZCB2ZXJzaW9uXG4gICAgbGV0IGdlbmVyaWNJb3NTaW11bGF0b3I7XG4gICAgZm9yIChjb25zdCBbcGxhdGZvcm1WZXJzaW9uRnJvbUxpc3QsIGlvc1NpbXVsYXRvcl0gb2YgZ2VuZXJpY1NpbXVsYXRvcnMpIHtcbiAgICAgIGlmICh1dGlsLmNvbXBhcmVWZXJzaW9ucyhwbGF0Zm9ybVZlcnNpb25Gcm9tTGlzdCwgJz4nLCBwbGF0Zm9ybVZlcnNpb24pKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgZ2VuZXJpY0lvc1NpbXVsYXRvciA9IGlvc1NpbXVsYXRvcjtcbiAgICB9XG4gICAgcmV0dXJuIGdlbmVyaWNJb3NTaW11bGF0b3I7XG4gIH1cbn1cblxuZnVuY3Rpb24gdHJhbnNsYXRlRGV2aWNlTmFtZSAocGxhdGZvcm1WZXJzaW9uLCBkZXZpY2VOYW1lID0gJycpIHtcbiAgY29uc3QgZGV2aWNlTmFtZVRyYW5zbGF0ZWQgPSBnZXRHZW5lcmljU2ltdWxhdG9yRm9ySW9zVmVyc2lvbihwbGF0Zm9ybVZlcnNpb24sIGRldmljZU5hbWUudG9Mb3dlckNhc2UoKS50cmltKCkpO1xuICBpZiAoZGV2aWNlTmFtZVRyYW5zbGF0ZWQpIHtcbiAgICBsb2cuZGVidWcoYENoYW5naW5nIGRldmljZU5hbWUgZnJvbSAnJHtkZXZpY2VOYW1lfScgdG8gJyR7ZGV2aWNlTmFtZVRyYW5zbGF0ZWR9J2ApO1xuICAgIHJldHVybiBkZXZpY2VOYW1lVHJhbnNsYXRlZDtcbiAgfVxuICByZXR1cm4gZGV2aWNlTmFtZTtcbn1cblxuLy8gVGhpcyBtYXAgY29udGFpbnMgZGVyaXZlZCBkYXRhIGxvZ3MgZm9sZGVycyBhcyBrZXlzXG4vLyBhbmQgdmFsdWVzIGFyZSB0aGUgY291bnQgb2YgdGltZXMgdGhlIHBhcnRpY3VsYXJcbi8vIGZvbGRlciBoYXMgYmVlbiBzY2hlZHVsZWQgZm9yIHJlbW92YWxcbmNvbnN0IGRlcml2ZWREYXRhQ2xlYW51cE1hcmtlcnMgPSBuZXcgTWFwKCk7XG5cbmFzeW5jIGZ1bmN0aW9uIG1hcmtTeXN0ZW1GaWxlc0ZvckNsZWFudXAgKHdkYSkge1xuICBpZiAoIXdkYSB8fCAhYXdhaXQgd2RhLnJldHJpZXZlRGVyaXZlZERhdGFQYXRoKCkpIHtcbiAgICBsb2cud2FybignTm8gV2ViRHJpdmVyQWdlbnQgZGVyaXZlZCBkYXRhIGF2YWlsYWJsZSwgc28gdW5hYmxlIHRvIG1hcmsgc3lzdGVtIGZpbGVzIGZvciBjbGVhbnVwJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgbG9nc1Jvb3QgPSBwYXRoLnJlc29sdmUoYXdhaXQgd2RhLnJldHJpZXZlRGVyaXZlZERhdGFQYXRoKCksICdMb2dzJyk7XG4gIGxldCBtYXJrZXJzQ291bnQgPSAwO1xuICBpZiAoZGVyaXZlZERhdGFDbGVhbnVwTWFya2Vycy5oYXMobG9nc1Jvb3QpKSB7XG4gICAgbWFya2Vyc0NvdW50ID0gZGVyaXZlZERhdGFDbGVhbnVwTWFya2Vycy5nZXQobG9nc1Jvb3QpO1xuICB9XG4gIGRlcml2ZWREYXRhQ2xlYW51cE1hcmtlcnMuc2V0KGxvZ3NSb290LCArK21hcmtlcnNDb3VudCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNsZWFyU3lzdGVtRmlsZXMgKHdkYSkge1xuICAvLyBvbmx5IHdhbnQgdG8gY2xlYXIgdGhlIHN5c3RlbSBmaWxlcyBmb3IgdGhlIHBhcnRpY3VsYXIgV0RBIHhjb2RlIHJ1blxuICBpZiAoIXdkYSB8fCAhYXdhaXQgd2RhLnJldHJpZXZlRGVyaXZlZERhdGFQYXRoKCkpIHtcbiAgICBsb2cud2FybignTm8gV2ViRHJpdmVyQWdlbnQgZGVyaXZlZCBkYXRhIGF2YWlsYWJsZSwgc28gdW5hYmxlIHRvIGNsZWFyIHN5c3RlbSBmaWxlcycpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IGxvZ3NSb290ID0gcGF0aC5yZXNvbHZlKGF3YWl0IHdkYS5yZXRyaWV2ZURlcml2ZWREYXRhUGF0aCgpLCAnTG9ncycpO1xuICBpZiAoZGVyaXZlZERhdGFDbGVhbnVwTWFya2Vycy5oYXMobG9nc1Jvb3QpKSB7XG4gICAgbGV0IG1hcmtlcnNDb3VudCA9IGRlcml2ZWREYXRhQ2xlYW51cE1hcmtlcnMuZ2V0KGxvZ3NSb290KTtcbiAgICBkZXJpdmVkRGF0YUNsZWFudXBNYXJrZXJzLnNldChsb2dzUm9vdCwgLS1tYXJrZXJzQ291bnQpO1xuICAgIGlmIChtYXJrZXJzQ291bnQgPiAwKSB7XG4gICAgICBsb2cuaW5mbyhgTm90IGNsZWFuaW5nICcke2xvZ3NSb290fScgZm9sZGVyLCBiZWNhdXNlIHRoZSBvdGhlciBzZXNzaW9uIGRvZXMgbm90IGV4cGVjdCBpdCB0byBiZSBjbGVhbmVkYCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG4gIGRlcml2ZWREYXRhQ2xlYW51cE1hcmtlcnMuc2V0KGxvZ3NSb290LCAwKTtcblxuICAvLyBDbGVhbmluZyB1cCBiaWcgdGVtcG9yYXJ5IGZpbGVzIGNyZWF0ZWQgYnkgWENUZXN0OiBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9pc3N1ZXMvOTQxMFxuICBjb25zdCBjbGVhbnVwQ21kID0gYGZpbmQgLUUgL3ByaXZhdGUvdmFyL2ZvbGRlcnMgYCArXG4gICAgYC1yZWdleCAnLiovU2Vzc2lvbi1XZWJEcml2ZXJBZ2VudFJ1bm5lci4qXFxcXC5sb2ckfC4qL1N0YW5kYXJkT3V0cHV0QW5kU3RhbmRhcmRFcnJvclxcXFwudHh0JCcgYCArXG4gICAgYC10eXBlIGYgLWV4ZWMgc2ggLWMgJ2VjaG8gXCJcIiA+IFwie31cIicgXFxcXDtgO1xuICBjb25zdCBjbGVhbnVwVGFzayA9IG5ldyBTdWJQcm9jZXNzKCdiYXNoJywgWyctYycsIGNsZWFudXBDbWRdLCB7XG4gICAgZGV0YWNoZWQ6IHRydWUsXG4gICAgc3RkaW86IFsnaWdub3JlJywgJ3BpcGUnLCAncGlwZSddLFxuICB9KTtcbiAgLy8gRG8gbm90IHdhaXQgZm9yIHRoZSB0YXNrIHRvIGJlIGNvbXBsZXRlZCwgc2luY2UgaXQgbWlnaHQgdGFrZSBhIGxvdCBvZiB0aW1lXG4gIC8vIFdlIGtlZXAgaXQgcnVubmluZyBhZnRlciBBcHBpdW0gcHJvY2VzcyBpcyBraWxsZWRcbiAgYXdhaXQgY2xlYW51cFRhc2suc3RhcnQoMCwgdHJ1ZSk7XG4gIGxvZy5kZWJ1ZyhgU3RhcnRlZCBiYWNrZ3JvdW5kIFhDVGVzdCBsb2dzIGNsZWFudXA6ICR7Y2xlYW51cENtZH1gKTtcblxuICBpZiAoYXdhaXQgZnMuZXhpc3RzKGxvZ3NSb290KSkge1xuICAgIGxvZy5pbmZvKGBDbGVhbmluZyB0ZXN0IGxvZ3MgaW4gJyR7bG9nc1Jvb3R9JyBmb2xkZXJgKTtcbiAgICBhd2FpdCBpb3NVdGlscy5jbGVhckxvZ3MoW2xvZ3NSb290XSk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGxvZy5pbmZvKGBUaGVyZSBpcyBubyAke2xvZ3NSb290fSBmb2xkZXIsIHNvIG5vdCBjbGVhbmluZyBmaWxlc2ApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjaGVja0FwcFByZXNlbnQgKGFwcCkge1xuICBsb2cuZGVidWcoYENoZWNraW5nIHdoZXRoZXIgYXBwICcke2FwcH0nIGlzIGFjdHVhbGx5IHByZXNlbnQgb24gZmlsZSBzeXN0ZW1gKTtcbiAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKGFwcCkpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYENvdWxkIG5vdCBmaW5kIGFwcCBhdCAnJHthcHB9J2ApO1xuICB9XG4gIGxvZy5kZWJ1ZygnQXBwIGlzIHByZXNlbnQnKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RHJpdmVySW5mbyAoKSB7XG4gIGNvbnN0IHN0YXQgPSBhd2FpdCBmcy5zdGF0KHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicpKTtcbiAgY29uc3QgYnVpbHQgPSBzdGF0Lm10aW1lLmdldFRpbWUoKTtcblxuICAvLyBnZXQgdGhlIHBhY2thZ2UuanNvbiBhbmQgdGhlIHZlcnNpb24gZnJvbSBpdFxuICBjb25zdCBwa2cgPSByZXF1aXJlKF9fZmlsZW5hbWUuaW5jbHVkZXMoJ2J1aWxkL2xpYi91dGlscycpID8gJy4uLy4uL3BhY2thZ2UuanNvbicgOiAnLi4vcGFja2FnZS5qc29uJyk7XG4gIGNvbnN0IHZlcnNpb24gPSBwa2cudmVyc2lvbjtcblxuICByZXR1cm4ge1xuICAgIGJ1aWx0LFxuICAgIHZlcnNpb24sXG4gIH07XG59XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZUNvbW1hbmRUaW1lb3V0cyAodmFsdWUpIHtcbiAgLy8gVGhlIHZhbHVlIGlzIG5vcm1hbGl6ZWQgYWxyZWFkeVxuICBpZiAodHlwZW9mIHZhbHVlICE9PSAnc3RyaW5nJykge1xuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIGxldCByZXN1bHQgPSB7fTtcbiAgLy8gVXNlIGFzIGRlZmF1bHQgdGltZW91dCBmb3IgYWxsIGNvbW1hbmRzIGlmIGEgc2luZ2xlIGludGVnZXIgdmFsdWUgaXMgcHJvdmlkZWRcbiAgaWYgKCFpc05hTih2YWx1ZSkpIHtcbiAgICByZXN1bHRbREVGQVVMVF9USU1FT1VUX0tFWV0gPSBfLnRvSW50ZWdlcih2YWx1ZSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8vIEpTT04gb2JqZWN0IGhhcyBiZWVuIHByb3ZpZGVkLiBMZXQncyBwYXJzZSBpdFxuICB0cnkge1xuICAgIHJlc3VsdCA9IEpTT04ucGFyc2UodmFsdWUpO1xuICAgIGlmICghXy5pc1BsYWluT2JqZWN0KHJlc3VsdCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcigpO1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFwiY29tbWFuZFRpbWVvdXRzXCIgY2FwYWJpbGl0eSBzaG91bGQgYmUgYSB2YWxpZCBKU09OIG9iamVjdC4gXCIke3ZhbHVlfVwiIHdhcyBnaXZlbiBpbnN0ZWFkYCk7XG4gIH1cbiAgZm9yIChsZXQgW2NtZCwgdGltZW91dF0gb2YgXy50b1BhaXJzKHJlc3VsdCkpIHtcbiAgICBpZiAoIV8uaXNJbnRlZ2VyKHRpbWVvdXQpIHx8IHRpbWVvdXQgPD0gMCkge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSB0aW1lb3V0IGZvciBcIiR7Y21kfVwiIHNob3VsZCBiZSBhIHZhbGlkIG5hdHVyYWwgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcy4gXCIke3RpbWVvdXR9XCIgd2FzIGdpdmVuIGluc3RlYWRgKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBQaWRMb29rdXBPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/Ym9vbGVhbn0gbXVsdGkgW2ZhbHNlXSAtIFNldCBpdCB0byB0cnVlIGlmIG11bHRpcGxlIG1hdGNoaW5nXG4gKiBwaWRzIGFyZSBleHBlY3RlZCB0byBiZSBmb3VuZC4gT25seSB0aGUgbmV3ZXN0IHByb2Nlc3MgaWQgaXMgZ29pbmcgdG9cbiAqIGJlIHJldHVybmVkIGluc3RlYWRcbiAqIEBwcm9wZXJ0eSB7P2Jvb2xlYW59IGlnbm9yZUNhc2UgW3RydWVdIC0gU2V0IGl0IHRvIGZhbHNlIHRvIG1ha2UgdGhlIHNlYXJjaFxuICogY2FzZS1zZW5zaXRpdmVcbiAqL1xuXG4vKipcbiAqIEdldCB0aGUgcHJvY2VzcyBpZCBvZiB0aGUgbW9zdCByZWNlbnQgcnVubmluZyBhcHBsaWNhdGlvblxuICogaGF2aW5nIHRoZSBwYXJ0aWN1bGFyIGNvbW1hbmQgbGluZSBwYXR0ZXJuLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBwYXR0ZXJuIC0gcGdyZXAtY29tcGF0aWJsZSBzZWFyY2ggcGF0dGVybi5cbiAqIEBwYXJhbSB7P1BpZExvb2t1cE9wdGlvbnN9IG9wdHNcbiAqIEByZXR1cm4gez9zdHJpbmd8QXJyYXk8c3RyaW5nPn0gRWl0aGVyIGEgcHJvY2VzcyBpZCBvciBudWxsIGlmIG5vIG1hdGNoZXMgd2VyZSBmb3VuZC5cbiAqIEFuIGFycmF5IG9mIHN0cmluZ3MgaXMgZ29pbmcgdG8gYmUgcmV0dXJuZWQgaWYgYG9wdHMubXVsdGlgIGlzIHNldCB0byB0cnVlXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGdldFBJRHNVc2luZ1BhdHRlcm4gKHBhdHRlcm4sIG9wdHMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgbXVsdGkgPSBmYWxzZSxcbiAgICBpZ25vcmVDYXNlID0gdHJ1ZSxcbiAgfSA9IG9wdHM7XG4gIGNvbnN0IGFyZ3MgPSBbYC0ke2lnbm9yZUNhc2UgPyAnaScgOiAnJ31mJHttdWx0aSA/ICcnIDogJ24nfWAsIHBhdHRlcm5dO1xuICB0cnkge1xuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygncGdyZXAnLCBhcmdzKTtcbiAgICBpZiAobXVsdGkpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHN0ZG91dC5zcGxpdCgnXFxuJylcbiAgICAgICAgLmZpbHRlcigoeCkgPT4gcGFyc2VJbnQoeCwgMTApKVxuICAgICAgICAubWFwKCh4KSA9PiBgJHtwYXJzZUludCh4LCAxMCl9YCk7XG4gICAgICByZXR1cm4gXy5pc0VtcHR5KHJlc3VsdCkgPyBudWxsIDogcmVzdWx0O1xuICAgIH1cbiAgICBjb25zdCBwaWQgPSBwYXJzZUludChzdGRvdXQsIDEwKTtcbiAgICByZXR1cm4gaXNOYU4ocGlkKSA/IG51bGwgOiBgJHtwaWR9YDtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmRlYnVnKGAncGdyZXAgJHthcmdzLmpvaW4oJyAnKX0nIGRpZG4ndCBkZXRlY3QgYW55IG1hdGNoaW5nIHByb2Nlc3Nlcy4gUmV0dXJuIGNvZGU6ICR7ZXJyLmNvZGV9YCk7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuLyoqXG4gKiBLaWxsIGEgcHJvY2VzcyBoYXZpbmcgdGhlIHBhcnRpY3VsYXIgY29tbWFuZCBsaW5lIHBhdHRlcm4uXG4gKiBUaGlzIG1ldGhvZCB0cmllcyB0byBzZW5kIFNJR0lOVCwgU0lHVEVSTSBhbmQgU0lHS0lMTCB0byB0aGVcbiAqIG1hdGNoZWQgcHJvY2Vzc2VzIGluIHRoaXMgb3JkZXIgaWYgdGhlIHByb2Nlc3MgaXMgc3RpbGwgcnVubmluZy5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gcGdyZXBQYXR0ZXJuIC0gcGdyZXAtY29tcGF0aWJsZSBzZWFyY2ggcGF0dGVybi5cbiAqL1xuYXN5bmMgZnVuY3Rpb24ga2lsbEFwcFVzaW5nUGF0dGVybiAocGdyZXBQYXR0ZXJuKSB7XG4gIGZvciAoY29uc3Qgc2lnbmFsIG9mIFsyLCAxNSwgOV0pIHtcbiAgICBpZiAoIWF3YWl0IGdldFBJRHNVc2luZ1BhdHRlcm4ocGdyZXBQYXR0ZXJuKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBhcmdzID0gW2AtJHtzaWduYWx9YCwgJy1pZicsIHBncmVwUGF0dGVybl07XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4ZWMoJ3BraWxsJywgYXJncyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZGVidWcoYHBraWxsICR7YXJncy5qb2luKCcgJyl9IC0+ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgfVxuICAgIGF3YWl0IEIuZGVsYXkoMTAwKTtcbiAgfVxufVxuXG4vKipcbiAqIEtpbGxzIHJ1bm5pbmcgWENUZXN0IHByb2Nlc3NlcyBmb3IgdGhlIHBhcnRpY3VsYXIgZGV2aWNlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSB1ZGlkIC0gVGhlIGRldmljZSBVRElELlxuICogQHBhcmFtIHtib29sZWFufSBpc1NpbXVsYXRvciAtIEVxdWFscyB0byB0cnVlIGlmIHRoZSBjdXJyZW50IGRldmljZSBpcyBhIFNpbXVsYXRvclxuICovXG5hc3luYyBmdW5jdGlvbiByZXNldFhDVGVzdFByb2Nlc3NlcyAodWRpZCwgaXNTaW11bGF0b3IpIHtcbiAgY29uc3QgcHJvY2Vzc1BhdHRlcm5zID0gW2B4Y29kZWJ1aWxkLioke3VkaWR9YF07XG4gIGlmIChpc1NpbXVsYXRvcikge1xuICAgIHByb2Nlc3NQYXR0ZXJucy5wdXNoKGAke3VkaWR9LipYQ1RSdW5uZXJgKTtcbiAgICAvLyBUaGUgcGF0dGVybiB0byBmaW5kIGluIGNhc2UgaWRiIHdhcyB1c2VkXG4gICAgcHJvY2Vzc1BhdHRlcm5zLnB1c2goYHhjdGVzdC4qJHt1ZGlkfWApO1xuICB9XG4gIGxvZy5kZWJ1ZyhgS2lsbGluZyBydW5uaW5nIHByb2Nlc3NlcyAnJHtwcm9jZXNzUGF0dGVybnMuam9pbignLCAnKX0nIGZvciB0aGUgZGV2aWNlICR7dWRpZH0uLi5gKTtcbiAgZm9yIChjb25zdCBwZ3JlcFBhdHRlcm4gb2YgcHJvY2Vzc1BhdHRlcm5zKSB7XG4gICAgYXdhaXQga2lsbEFwcFVzaW5nUGF0dGVybihwZ3JlcFBhdHRlcm4pO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHByaW50VXNlciAoKSB7XG4gIHRyeSB7XG4gICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygnd2hvYW1pJyk7XG4gICAgbG9nLmRlYnVnKGBDdXJyZW50IHVzZXI6ICcke3N0ZG91dC50cmltKCl9J2ApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoYFVuYWJsZSB0byBnZXQgdXNlcm5hbWUgcnVubmluZyBzZXJ2ZXI6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cbn1cblxuLyoqXG4gKiBHZXQgdGhlIElEcyBvZiBwcm9jZXNzZXMgbGlzdGVuaW5nIG9uIHRoZSBwYXJ0aWN1bGFyIHN5c3RlbSBwb3J0LlxuICogSXQgaXMgYWxzbyBwb3NzaWJsZSB0byBhcHBseSBhZGRpdGlvbmFsIGZpbHRlcmluZyBiYXNlZCBvbiB0aGVcbiAqIHByb2Nlc3MgY29tbWFuZCBsaW5lLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gcG9ydCAtIFRoZSBwb3J0IG51bWJlci5cbiAqIEBwYXJhbSB7P0Z1bmN0aW9ufSBmaWx0ZXJpbmdGdW5jIC0gT3B0aW9uYWwgbGFtYmRhIGZ1bmN0aW9uLCB3aGljaFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNlaXZlcyBjb21tYW5kIGxpbmUgc3RyaW5nIG9mIHRoZSBwYXJ0aWN1bGFyIHByb2Nlc3NcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuaW5nIG9uIGdpdmVuIHBvcnQsIGFuZCBpcyBleHBlY3RlZCB0byByZXR1cm5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWl0aGVyIHRydWUgb3IgZmFsc2UgdG8gaW5jbHVkZS9leGNsdWRlIHRoZSBjb3JyZXNwb25kaW5nIFBJRFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tIHRoZSByZXN1bHRpbmcgYXJyYXkuXG4gKiBAcmV0dXJucyB7QXJyYXk8c3RyaW5nPn0gLSB0aGUgbGlzdCBvZiBtYXRjaGVkIHByb2Nlc3MgaWRzLlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRQSURzTGlzdGVuaW5nT25Qb3J0IChwb3J0LCBmaWx0ZXJpbmdGdW5jID0gbnVsbCkge1xuICBjb25zdCByZXN1bHQgPSBbXTtcbiAgdHJ5IHtcbiAgICAvLyBUaGlzIG9ubHkgd29ya3Mgc2luY2UgTWFjIE9TIFggRWwgQ2FwaXRhblxuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygnbHNvZicsIFsnLXRpJywgYHRjcDoke3BvcnR9YF0pO1xuICAgIHJlc3VsdC5wdXNoKC4uLihzdGRvdXQudHJpbSgpLnNwbGl0KC9cXG4rLykpKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBpZiAoIV8uaXNGdW5jdGlvbihmaWx0ZXJpbmdGdW5jKSkge1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IEIuZmlsdGVyKHJlc3VsdCwgYXN5bmMgKHgpID0+IHtcbiAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ3BzJywgWyctcCcsIHgsICctbycsICdjb21tYW5kJ10pO1xuICAgIHJldHVybiBhd2FpdCBmaWx0ZXJpbmdGdW5jKHN0ZG91dCk7XG4gIH0pO1xufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFVwbG9hZE9wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHVzZXIgLSBUaGUgbmFtZSBvZiB0aGUgdXNlciBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHBhc3MgLSBUaGUgcGFzc3dvcmQgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBtZXRob2QgLSBUaGUgaHR0cCBtdWx0aXBhcnQgdXBsb2FkIG1ldGhvZCBuYW1lLiBUaGUgJ1BVVCcgb25lIGlzIHVzZWQgYnkgZGVmYXVsdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKi9cblxuXG4vKipcbiAqIEVuY29kZXMgdGhlIGdpdmVuIGxvY2FsIGZpbGUgdG8gYmFzZTY0IGFuZCByZXR1cm5zIHRoZSByZXN1bHRpbmcgc3RyaW5nXG4gKiBvciB1cGxvYWRzIGl0IHRvIGEgcmVtb3RlIHNlcnZlciB1c2luZyBodHRwL2h0dHBzIG9yIGZ0cCBwcm90b2NvbHNcbiAqIGlmIGByZW1vdGVQYXRoYCBpcyBzZXRcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gbG9jYWxGaWxlIC0gVGhlIHBhdGggdG8gYW4gZXhpc3RpbmcgbG9jYWwgZmlsZVxuICogQHBhcmFtIHs/c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHBhdGggdG8gdGhlIHJlbW90ZSBsb2NhdGlvbiwgd2hlcmVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMgZmlsZSBzaG91bGQgYmUgdXBsb2FkZWRcbiAqIEBwYXJhbSB7P1VwbG9hZE9wdGlvbnN9IHVwbG9hZE9wdGlvbnMgLSBTZXQgb2YgdXBsb2FkIG9wdGlvbnNcbiAqIEByZXR1cm5zIHtzdHJpbmd9IEVpdGhlciBhbiBlbXB0eSBzdHJpbmcgaWYgdGhlIHVwbG9hZCB3YXMgc3VjY2Vzc2Z1bCBvclxuICogYmFzZTY0LWVuY29kZWQgZmlsZSByZXByZXNlbnRhdGlvbiBpZiBgcmVtb3RlUGF0aGAgaXMgZmFsc3lcbiAqL1xuYXN5bmMgZnVuY3Rpb24gZW5jb2RlQmFzZTY0T3JVcGxvYWQgKGxvY2FsRmlsZSwgcmVtb3RlUGF0aCA9IG51bGwsIHVwbG9hZE9wdGlvbnMgPSB7fSkge1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhsb2NhbEZpbGUpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSBmaWxlIGF0ICcke2xvY2FsRmlsZX0nIGRvZXMgbm90IGV4aXN0IG9yIGlzIG5vdCBhY2Nlc3NpYmxlYCk7XG4gIH1cblxuICBjb25zdCB7c2l6ZX0gPSBhd2FpdCBmcy5zdGF0KGxvY2FsRmlsZSk7XG4gIGxvZy5kZWJ1ZyhgVGhlIHNpemUgb2YgdGhlIGZpbGUgaXMgJHt1dGlsLnRvUmVhZGFibGVTaXplU3RyaW5nKHNpemUpfWApO1xuICBpZiAoXy5pc0VtcHR5KHJlbW90ZVBhdGgpKSB7XG4gICAgY29uc3QgbWF4TWVtb3J5TGltaXQgPSB2OC5nZXRIZWFwU3RhdGlzdGljcygpLnRvdGFsX2F2YWlsYWJsZV9zaXplIC8gMjtcbiAgICBpZiAoc2l6ZSA+PSBtYXhNZW1vcnlMaW1pdCkge1xuICAgICAgbG9nLmluZm8oYFRoZSBmaWxlIG1pZ2h0IGJlIHRvbyBsYXJnZSB0byBmaXQgaW50byB0aGUgcHJvY2VzcyBtZW1vcnkgYCArXG4gICAgICAgIGAoJHt1dGlsLnRvUmVhZGFibGVTaXplU3RyaW5nKHNpemUpfSA+PSAke3V0aWwudG9SZWFkYWJsZVNpemVTdHJpbmcobWF4TWVtb3J5TGltaXQpfSkuIGAgK1xuICAgICAgICBgUHJvdmlkZSBhIGxpbmsgdG8gYSByZW1vdGUgd3JpdGFibGUgbG9jYXRpb24gZm9yIHZpZGVvIHVwbG9hZCBgICtcbiAgICAgICAgYChodHRwKHMpIGFuZCBmdHAgcHJvdG9jb2xzIGFyZSBzdXBwb3J0ZWQpIGlmIHlvdSBleHBlcmllbmNlIE91dCBPZiBNZW1vcnkgZXJyb3JzYCk7XG4gICAgfVxuICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCBmcy5yZWFkRmlsZShsb2NhbEZpbGUpO1xuICAgIHJldHVybiBjb250ZW50LnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgfVxuXG4gIGNvbnN0IHJlbW90ZVVybCA9IHVybC5wYXJzZShyZW1vdGVQYXRoKTtcbiAgbGV0IG9wdGlvbnMgPSB7fTtcbiAgY29uc3Qge3VzZXIsIHBhc3MsIG1ldGhvZH0gPSB1cGxvYWRPcHRpb25zO1xuICBpZiAocmVtb3RlVXJsLnByb3RvY29sLnN0YXJ0c1dpdGgoJ2h0dHAnKSkge1xuICAgIG9wdGlvbnMgPSB7XG4gICAgICB1cmw6IHJlbW90ZVVybC5ocmVmLFxuICAgICAgbWV0aG9kOiBtZXRob2QgfHwgJ1BVVCcsXG4gICAgICBtdWx0aXBhcnQ6IFt7IGJvZHk6IF9mcy5jcmVhdGVSZWFkU3RyZWFtKGxvY2FsRmlsZSkgfV0sXG4gICAgfTtcbiAgICBpZiAodXNlciAmJiBwYXNzKSB7XG4gICAgICBvcHRpb25zLmF1dGggPSB7dXNlciwgcGFzc307XG4gICAgfVxuICB9IGVsc2UgaWYgKHJlbW90ZVVybC5wcm90b2NvbCA9PT0gJ2Z0cDonKSB7XG4gICAgb3B0aW9ucyA9IHtcbiAgICAgIGhvc3Q6IHJlbW90ZVVybC5ob3N0bmFtZSxcbiAgICAgIHBvcnQ6IHJlbW90ZVVybC5wb3J0IHx8IDIxLFxuICAgIH07XG4gICAgaWYgKHVzZXIgJiYgcGFzcykge1xuICAgICAgb3B0aW9ucy51c2VyID0gdXNlcjtcbiAgICAgIG9wdGlvbnMucGFzcyA9IHBhc3M7XG4gICAgfVxuICB9XG4gIGF3YWl0IG5ldC51cGxvYWRGaWxlKGxvY2FsRmlsZSwgcmVtb3RlUGF0aCwgb3B0aW9ucyk7XG4gIHJldHVybiAnJztcbn1cblxuLyoqXG4gKiBTdG9wcyBhbmQgcmVtb3ZlcyBhbGwgd2ViIHNvY2tldCBoYW5kbGVycyB0aGF0IGFyZSBsaXN0ZW5pbmdcbiAqIGluIHNjb3BlIG9mIHRoZSBjdXJyZWN0IHNlc3Npb24uXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IHNlcnZlciAtIFRoZSBpbnN0YW5jZSBvZiBOb2RlSnMgSFRUUCBzZXJ2ZXIsXG4gKiB3aGljaCBob3N0cyBBcHBpdW1cbiAqIEBwYXJhbSB7c3RyaW5nfSBzZXNzaW9uSWQgLSBUaGUgaWQgb2YgdGhlIGN1cnJlbnQgc2Vzc2lvblxuICovXG5hc3luYyBmdW5jdGlvbiByZW1vdmVBbGxTZXNzaW9uV2ViU29ja2V0SGFuZGxlcnMgKHNlcnZlciwgc2Vzc2lvbklkKSB7XG4gIGlmICghc2VydmVyIHx8ICFfLmlzRnVuY3Rpb24oc2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzKSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IGFjdGl2ZUhhbmRsZXJzID0gYXdhaXQgc2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzKHNlc3Npb25JZCk7XG4gIGZvciAoY29uc3QgcGF0aG5hbWUgb2YgXy5rZXlzKGFjdGl2ZUhhbmRsZXJzKSkge1xuICAgIGF3YWl0IHNlcnZlci5yZW1vdmVXZWJTb2NrZXRIYW5kbGVyKHBhdGhuYW1lKTtcbiAgfVxufVxuXG4vKipcbiAqIFZlcmlmeSB3aGV0aGVyIHRoZSBnaXZlbiBhcHBsaWNhdGlvbiBpcyBjb21wYXRpYmxlIHRvIHRoZVxuICogcGxhdGZvcm0gd2hlcmUgaXQgaXMgZ29pbmcgdG8gYmUgaW5zdGFsbGVkIGFuZCB0ZXN0ZWQuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwcCAtIFRoZSBhY3R1YWwgcGF0aCB0byB0aGUgYXBwbGljYXRpb24gYnVuZGxlXG4gKiBAcGFyYW0ge2Jvb2xlYW59IGlzU2ltdWxhdG9yIC0gU2hvdWxkIGJlIHNldCB0byBgdHJ1ZWAgaWYgdGhlIHRlc3Qgd2lsbCBiZSBleGVjdXRlZCBvbiBTaW11bGF0b3JcbiAqIEByZXR1cm5zIHs/Ym9vbGVhbn0gVGhlIGZ1bmN0aW9uIHJldHVybnMgYG51bGxgIGlmIHRoZSBhcHBsaWNhdGlvbiBkb2VzIG5vdCBleGlzdCBvciB0aGVyZSBpcyBub1xuICogYENGQnVuZGxlU3VwcG9ydGVkUGxhdGZvcm1zYCBrZXkgaW4gaXRzIEluZm8ucGxpc3QgbWFuaWZlc3QuXG4gKiBgdHJ1ZWAgaXMgcmV0dXJuZWQgaWYgdGhlIGJ1bmRsZSBhcmNoaXRlY3R1cmUgbWF0Y2hlcyB0aGUgZGV2aWNlIGFyY2hpdGVjdHVyZS5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBidW5kbGUgYXJjaGl0ZWN0dXJlIGRvZXMgbm90IG1hdGNoIHRoZSBkZXZpY2UgYXJjaGl0ZWN0dXJlLlxuICovXG5hc3luYyBmdW5jdGlvbiB2ZXJpZnlBcHBsaWNhdGlvblBsYXRmb3JtIChhcHAsIGlzU2ltdWxhdG9yLCBpc1R2T1MpIHtcbiAgbG9nLmRlYnVnKCdWZXJpZnlpbmcgYXBwbGljYXRpb24gcGxhdGZvcm0nKTtcblxuICBjb25zdCBpbmZvUGxpc3QgPSBwYXRoLnJlc29sdmUoYXBwLCAnSW5mby5wbGlzdCcpO1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhpbmZvUGxpc3QpKSB7XG4gICAgbG9nLmRlYnVnKGAnJHtpbmZvUGxpc3R9JyBkb2VzIG5vdCBleGlzdGApO1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgY29uc3Qge0NGQnVuZGxlU3VwcG9ydGVkUGxhdGZvcm1zfSA9IGF3YWl0IHBsaXN0LnBhcnNlUGxpc3RGaWxlKGluZm9QbGlzdCk7XG4gIGxvZy5kZWJ1ZyhgQ0ZCdW5kbGVTdXBwb3J0ZWRQbGF0Zm9ybXM6ICR7SlNPTi5zdHJpbmdpZnkoQ0ZCdW5kbGVTdXBwb3J0ZWRQbGF0Zm9ybXMpfWApO1xuICBpZiAoIV8uaXNBcnJheShDRkJ1bmRsZVN1cHBvcnRlZFBsYXRmb3JtcykpIHtcbiAgICBsb2cuZGVidWcoYENGQnVuZGxlU3VwcG9ydGVkUGxhdGZvcm1zIGtleSBkb2VzIG5vdCBleGlzdCBpbiAnJHtpbmZvUGxpc3R9J2ApO1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgY29uc3QgZXhwZWN0ZWRQbGF0Zm9ybSA9IGlzU2ltdWxhdG9yXG4gICAgPyBpc1R2T1MgPyAnQXBwbGVUVlNpbXVsYXRvcicgOiAnaVBob25lU2ltdWxhdG9yJ1xuICAgIDogaXNUdk9TID8gJ0FwcGxlVFZPUycgOiAnaVBob25lT1MnO1xuXG4gIGNvbnN0IGlzQXBwU3VwcG9ydGVkID0gQ0ZCdW5kbGVTdXBwb3J0ZWRQbGF0Zm9ybXMuaW5jbHVkZXMoZXhwZWN0ZWRQbGF0Zm9ybSk7XG4gIGlmIChpc0FwcFN1cHBvcnRlZCkge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIHRocm93IG5ldyBFcnJvcihgJHtpc1NpbXVsYXRvciA/ICdTaW11bGF0b3InIDogJ1JlYWwgZGV2aWNlJ30gYXJjaGl0ZWN0dXJlIGlzIHVuc3VwcG9ydGVkIGJ5IHRoZSAnJHthcHB9JyBhcHBsaWNhdGlvbi4gYCArXG4gICAgICAgICAgICAgICAgICBgTWFrZSBzdXJlIHRoZSBjb3JyZWN0IGRlcGxveW1lbnQgdGFyZ2V0IGhhcyBiZWVuIHNlbGVjdGVkIGZvciBpdHMgY29tcGlsYXRpb24gaW4gWGNvZGUuYCk7XG59XG5cbi8qKlxuICogUmV0dXJuIHRydWUgaWYgdGhlIHBsYXRmb3JtTmFtZSBpcyB0dk9TXG4gKiBAcGFyYW0ge3N0cmluZ30gcGxhdGZvcm1OYW1lIFRoZSBuYW1lIG9mIHRoZSBwbGF0b3JtXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJuIHRydWUgaWYgdGhlIHBsYXRmb3JtTmFtZSBpcyB0dk9TXG4gKi9cbmZ1bmN0aW9uIGlzVHZPUyAocGxhdGZvcm1OYW1lKSB7XG4gIHJldHVybiBfLnRvTG93ZXIocGxhdGZvcm1OYW1lKSA9PT0gXy50b0xvd2VyKFBMQVRGT1JNX05BTUVfVFZPUyk7XG59XG5cbi8qKlxuICogUmV0dXJucyB0cnVlIGlmIHRoZSB1cmxTdHJpbmcgaXMgbG9jYWxob3N0XG4gKiBAcGFyYW0gez9zdHJpbmd9IHVybFN0cmluZ1xuICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybiB0cnVlIGlmIHRoZSB1cmxTdHJpbmcgaXMgbG9jYWxob3N0XG4gKi9cbmZ1bmN0aW9uIGlzTG9jYWxIb3N0ICh1cmxTdHJpbmcpIHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7aG9zdG5hbWV9ID0gdXJsLnBhcnNlKHVybFN0cmluZyk7XG4gICAgcmV0dXJuIFsnbG9jYWxob3N0JywgJzEyNy4wLjAuMScsICc6OjEnLCAnOjpmZmZmOjEyNy4wLjAuMSddLmluY2x1ZGVzKGhvc3RuYW1lKTtcbiAgfSBjYXRjaCAoaWduKSB7XG4gICAgbG9nLndhcm4oYCcke3VybFN0cmluZ30nIGNhbm5vdCBiZSBwYXJzZWQgYXMgYSB2YWxpZCBVUkxgKTtcbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbi8qKlxuICogTm9ybWFsaXplcyBwbGF0Zm9ybVZlcnNpb24gdG8gYSB2YWxpZCBpT1MgdmVyc2lvbiBzdHJpbmdcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gb3JpZ2luYWxWZXJzaW9uIC0gTG9vc2UgdmVyc2lvbiBudW1iZXIsIHRoYXQgY2FuIGJlIHBhcnNlZCBieSBzZW12ZXJcbiAqIEByZXR1cm4ge3N0cmluZ30gaU9TIHZlcnNpb24gbnVtYmVyIGluIDxtYWpvcj4uPG1pbm9yPiBmb3JtYXRcbiAqIEB0aHJvd3Mge0Vycm9yfSBpZiB0aGUgdmVyc2lvbiBudW1iZXIgY2Fubm90IGJlIHBhcnNlZFxuICovXG5mdW5jdGlvbiBub3JtYWxpemVQbGF0Zm9ybVZlcnNpb24gKG9yaWdpbmFsVmVyc2lvbikge1xuICBjb25zdCBub3JtYWxpemVkVmVyc2lvbiA9IHV0aWwuY29lcmNlVmVyc2lvbihvcmlnaW5hbFZlcnNpb24sIGZhbHNlKTtcbiAgaWYgKCFub3JtYWxpemVkVmVyc2lvbikge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHBsYXRmb3JtIHZlcnNpb24gJyR7b3JpZ2luYWxWZXJzaW9ufScgc2hvdWxkIGJlIGEgdmFsaWQgdmVyc2lvbiBudW1iZXJgKTtcbiAgfVxuICBjb25zdCB7bWFqb3IsIG1pbm9yfSA9IG5ldyBzZW12ZXIuU2VtVmVyKG5vcm1hbGl6ZWRWZXJzaW9uKTtcbiAgcmV0dXJuIGAke21ham9yfS4ke21pbm9yfWA7XG59XG5cbmV4cG9ydCB7IGRldGVjdFVkaWQsIGdldEFuZENoZWNrWGNvZGVWZXJzaW9uLCBnZXRBbmRDaGVja0lvc1Nka1ZlcnNpb24sIGdldEdlbmVyaWNTaW11bGF0b3JGb3JJb3NWZXJzaW9uLFxuICBjaGVja0FwcFByZXNlbnQsIGdldERyaXZlckluZm8sXG4gIGNsZWFyU3lzdGVtRmlsZXMsIHRyYW5zbGF0ZURldmljZU5hbWUsIG5vcm1hbGl6ZUNvbW1hbmRUaW1lb3V0cyxcbiAgREVGQVVMVF9USU1FT1VUX0tFWSwgcmVzZXRYQ1Rlc3RQcm9jZXNzZXMsIGdldFBJRHNVc2luZ1BhdHRlcm4sXG4gIG1hcmtTeXN0ZW1GaWxlc0ZvckNsZWFudXAsIHByaW50VXNlcixcbiAgZ2V0UElEc0xpc3RlbmluZ09uUG9ydCwgZW5jb2RlQmFzZTY0T3JVcGxvYWQsIHJlbW92ZUFsbFNlc3Npb25XZWJTb2NrZXRIYW5kbGVycyxcbiAgdmVyaWZ5QXBwbGljYXRpb25QbGF0Zm9ybSwgaXNUdk9TLCBpc0xvY2FsSG9zdCwgbm9ybWFsaXplUGxhdGZvcm1WZXJzaW9uIH07XG4iXSwiZmlsZSI6ImxpYi91dGlscy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
