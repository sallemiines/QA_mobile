"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getAvailableBundleIds = getAvailableBundleIds;
exports.parseContainerPath = parseContainerPath;
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _appiumIosDriver = require("appium-ios-driver");

var _logger = _interopRequireDefault(require("../logger"));

var _teen_process = require("teen_process");

var _nodeSimctl = require("node-simctl");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumIosDevice = require("appium-ios-device");

const CONTAINER_PATH_MARKER = '@';
const CONTAINER_PATH_PATTERN = new RegExp(`^${CONTAINER_PATH_MARKER}([^/]+)/(.*)`);
const CONTAINER_TYPE_SEPARATOR = ':';
const IFUSE_CONTAINER_DOCUMENTS = 'documents';
const CONTAINER_DOCUMENTS_PATH = 'Documents';
const IO_TIMEOUT = 30000;
const OBJECT_NOT_FOUND_ERROR_MESSAGE = 'OBJECT_NOT_FOUND';
let commands = _appiumIosDriver.iosCommands.file;
exports.commands = commands;

function verifyIsSubPath(originalPath, root) {
  const normalizedRoot = _path.default.normalize(root);

  const normalizedPath = _path.default.normalize(_path.default.dirname(originalPath));

  if (normalizedRoot !== originalPath && !normalizedPath.startsWith(normalizedRoot)) {
    _logger.default.errorAndThrow(`'${normalizedPath}' is expected to be a subpath of '${normalizedRoot}'`);
  }
}

async function createAfcClient(udid, bundleId, containerType) {
  if (!bundleId) {
    return await _appiumIosDevice.services.startAfcService(udid);
  }

  const service = await _appiumIosDevice.services.startHouseArrestService(udid);

  if (isDocuments(containerType)) {
    return await service.vendDocuments(bundleId);
  } else {
    return await service.vendContainer(bundleId);
  }
}

function isDocuments(containerType) {
  return _lodash.default.toLower(containerType) === IFUSE_CONTAINER_DOCUMENTS;
}

async function mkdirpDevice(service, dir) {
  if (dir === '.' || dir === '/') {
    return;
  }

  try {
    await service.listDirectory(dir);
    return;
  } catch (e) {
    await mkdirpDevice(service, _path.default.dirname(dir));
  }

  await service.createDirectory(dir);
}

async function createService(udid, remotePath) {
  if (CONTAINER_PATH_PATTERN.test(remotePath)) {
    const {
      bundleId,
      pathInContainer,
      containerType
    } = await parseContainerPath(remotePath);
    const service = await createAfcClient(udid, bundleId, containerType);
    const relativePath = isDocuments(containerType) ? _path.default.join(CONTAINER_DOCUMENTS_PATH, pathInContainer) : pathInContainer;
    return {
      service,
      relativePath
    };
  } else {
    const service = await createAfcClient(udid);
    const relativePath = remotePath;
    return {
      service,
      relativePath
    };
  }
}

async function pullFileFromRealDevice(service, relativePath) {
  const stream = await service.createReadStream(relativePath, {
    autoDestroy: true
  });
  const closeEvent = new _bluebird.default(resolve => stream.on('close', resolve)).timeout(IO_TIMEOUT);
  const buffer = [];
  stream.on('data', data => buffer.push(data));

  try {
    await closeEvent;
  } catch (e) {
    throw new Error(`Couldn't pull the file '${relativePath}' ` + `within the given timeout ${IO_TIMEOUT}ms. Original error: ${e.message}`);
  }

  return Buffer.concat(buffer).toString('base64');
}

async function pullFolderFromRealDevice(service, relativePath) {
  const tmpFolder = await _appiumSupport.tempDir.openDir();

  try {
    const folderPath = _path.default.join(tmpFolder, relativePath);

    await (0, _appiumSupport.mkdirp)(folderPath);
    const promises = [];
    await service.walkDir(relativePath, true, async (itemPath, isDir) => {
      const pathOnServer = _path.default.join(tmpFolder, itemPath);

      if (isDir) {
        await _appiumSupport.fs.mkdir(pathOnServer);
      } else {
        const readStream = await service.createReadStream(itemPath, {
          autoDestroy: true
        });

        const writeStream = _appiumSupport.fs.createWriteStream(pathOnServer, {
          autoClose: true
        });

        promises.push(new _bluebird.default(resolve => writeStream.on('close', resolve)));
        readStream.pipe(writeStream);
      }
    });

    try {
      await _bluebird.default.all(promises).timeout(IO_TIMEOUT);
    } catch (e) {
      throw new Error(`Couldn't pull all items in the folder '${relativePath}' ` + `within the given timeout ${IO_TIMEOUT}ms. Original error: ${e.message}`);
    }

    return Buffer.from((await _appiumSupport.zip.toInMemoryZip(folderPath))).toString('base64');
  } finally {
    await _appiumSupport.fs.rimraf(tmpFolder);
  }
}

async function parseContainerPath(remotePath, containerRootSupplier) {
  const match = CONTAINER_PATH_PATTERN.exec(remotePath);

  if (!match) {
    _logger.default.errorAndThrow(`It is expected that package identifier ` + `starts with '${CONTAINER_PATH_MARKER}' and is separated from the ` + `relative path with a single slash. '${remotePath}' is given instead`);
  }

  let [, bundleId, relativePath] = match;
  let containerType = null;
  const typeSeparatorPos = bundleId.indexOf(CONTAINER_TYPE_SEPARATOR);

  if (typeSeparatorPos > 0 && typeSeparatorPos < bundleId.length - 1) {
    containerType = bundleId.substring(typeSeparatorPos + 1);

    _logger.default.debug(`Parsed container type: ${containerType}`);

    bundleId = bundleId.substring(0, typeSeparatorPos);
  }

  if (_lodash.default.isNil(containerRootSupplier)) {
    const pathInContainer = relativePath;
    return {
      bundleId,
      pathInContainer,
      containerType
    };
  }

  const containerRoot = _lodash.default.isFunction(containerRootSupplier) ? await containerRootSupplier(bundleId, containerType) : containerRootSupplier;

  const pathInContainer = _path.default.posix.resolve(containerRoot, relativePath);

  verifyIsSubPath(pathInContainer, containerRoot);
  return {
    bundleId,
    pathInContainer,
    containerType
  };
}

async function pushFileToSimulator(device, remotePath, base64Data) {
  const buffer = Buffer.from(base64Data, 'base64');

  if (CONTAINER_PATH_PATTERN.test(remotePath)) {
    const {
      bundleId,
      pathInContainer: dstPath
    } = await parseContainerPath(remotePath, async (appBundle, containerType) => await (0, _nodeSimctl.getAppContainer)(device.udid, appBundle, null, containerType));

    _logger.default.info(`Parsed bundle identifier '${bundleId}' from '${remotePath}'. ` + `Will put the data into '${dstPath}'`);

    if (!(await _appiumSupport.fs.exists(_path.default.dirname(dstPath)))) {
      _logger.default.debug(`The destination folder '${_path.default.dirname(dstPath)}' does not exist. Creating...`);

      await (0, _appiumSupport.mkdirp)(_path.default.dirname(dstPath));
    }

    await _appiumSupport.fs.writeFile(dstPath, buffer);
    return;
  }

  const dstFolder = await _appiumSupport.tempDir.openDir();

  const dstPath = _path.default.resolve(dstFolder, _path.default.basename(remotePath));

  try {
    await _appiumSupport.fs.writeFile(dstPath, buffer);
    await (0, _nodeSimctl.addMedia)(device.udid, dstPath);
  } finally {
    await _appiumSupport.fs.rimraf(dstFolder);
  }
}

async function pushFileToRealDevice(device, remotePath, base64Data) {
  const {
    service,
    relativePath
  } = await createService(device.udid, remotePath);

  try {
    await mkdirpDevice(service, _path.default.dirname(relativePath));
    const stream = await service.createWriteStream(relativePath, {
      autoClose: true
    });
    stream.write(Buffer.from(base64Data, 'base64'));
    const closeEvent = new _bluebird.default(resolve => stream.on('close', resolve)).timeout(IO_TIMEOUT);
    stream.destroy();

    try {
      await closeEvent;
    } catch (e) {
      throw new Error(`Could not push the file within the given timeout ${IO_TIMEOUT}ms. ` + `Original error: ${e.message}`);
    }
  } finally {
    service.close();
  }
}

async function pullFromSimulator(device, remotePath, isFile) {
  let pathOnServer;

  if (CONTAINER_PATH_PATTERN.test(remotePath)) {
    const {
      bundleId,
      pathInContainer: dstPath
    } = await parseContainerPath(remotePath, async (appBundle, containerType) => await (0, _nodeSimctl.getAppContainer)(device.udid, appBundle, null, containerType));

    _logger.default.info(`Parsed bundle identifier '${bundleId}' from '${remotePath}'. ` + `Will get the data from '${dstPath}'`);

    pathOnServer = dstPath;
  } else {
    const simRoot = device.getDir();
    pathOnServer = _path.default.posix.join(simRoot, remotePath);
    verifyIsSubPath(pathOnServer, simRoot);

    _logger.default.info(`Got the full item path: ${pathOnServer}`);
  }

  if (!(await _appiumSupport.fs.exists(pathOnServer))) {
    _logger.default.errorAndThrow(`The remote ${isFile ? 'file' : 'folder'} at '${pathOnServer}' does not exist`);
  }

  const buffer = isFile ? await _appiumSupport.fs.readFile(pathOnServer) : await _appiumSupport.zip.toInMemoryZip(pathOnServer);
  return Buffer.from(buffer).toString('base64');
}

async function pullFromRealDevice(device, remotePath, isFile) {
  const {
    service,
    relativePath
  } = await createService(device.udid, remotePath);

  try {
    const fileInfo = await service.getFileInfo(relativePath);

    if (isFile && fileInfo.isDirectory()) {
      throw new Error(`The requested path is not a file. Path: '${remotePath}'`);
    }

    if (!isFile && !fileInfo.isDirectory()) {
      throw new Error(`The requested path is not a folder. Path: '${remotePath}'`);
    }

    if (fileInfo.isFile()) {
      return await pullFileFromRealDevice(service, relativePath);
    } else {
      return await pullFolderFromRealDevice(service, relativePath);
    }
  } catch (e) {
    if (e.message.includes(OBJECT_NOT_FOUND_ERROR_MESSAGE)) {
      throw new Error(`Path '${remotePath}' does not exist on the device`);
    }

    throw e;
  } finally {
    service.close();
  }
}

async function deleteFromSimulator(device, remotePath) {
  let pathOnServer;

  if (CONTAINER_PATH_PATTERN.test(remotePath)) {
    const {
      bundleId,
      pathInContainer: dstPath
    } = await parseContainerPath(remotePath, async (appBundle, containerType) => await (0, _nodeSimctl.getAppContainer)(device.udid, appBundle, null, containerType));

    _logger.default.info(`Parsed bundle identifier '${bundleId}' from '${remotePath}'. ` + `'${dstPath}' will be deleted`);

    pathOnServer = dstPath;
  } else {
    const simRoot = device.getDir();
    pathOnServer = _path.default.posix.join(simRoot, remotePath);
    verifyIsSubPath(pathOnServer, simRoot);

    _logger.default.info(`Got the full path: ${pathOnServer}`);
  }

  if (!(await _appiumSupport.fs.exists(pathOnServer))) {
    _logger.default.errorAndThrow(`The remote path at '${pathOnServer}' does not exist`);
  }

  await _appiumSupport.fs.rimraf(pathOnServer);
}

async function deleteFromRealDevice(device, remotePath) {
  const {
    service,
    relativePath
  } = await createService(device.udid, remotePath);

  try {
    await service.deleteDirectory(relativePath);
  } catch (e) {
    if (e.message.includes(OBJECT_NOT_FOUND_ERROR_MESSAGE)) {
      throw new Error(`Path '${remotePath}' does not exist on the device`);
    }

    throw e;
  } finally {
    service.close();
  }
}

async function getAvailableBundleIds(udid) {
  const service = await _appiumIosDevice.services.startInstallationProxyService(udid);

  try {
    const applications = await service.listApplications({
      applicationType: 'User'
    });
    const bundleIds = [];

    for (const [key, value] of Object.entries(applications)) {
      if (!value.UIFileSharingEnabled) {
        continue;
      }

      bundleIds.push(key);
    }

    return bundleIds;
  } finally {
    service.close();
  }
}

commands.pushFile = async function pushFile(remotePath, base64Data) {
  if (remotePath.endsWith('/')) {
    _logger.default.errorAndThrow(`It is expected that remote path points to a file and not to a folder. ` + `'${remotePath}' is given instead`);
  }

  if (_lodash.default.isArray(base64Data)) {
    base64Data = Buffer.from(base64Data).toString('utf8');
  }

  return this.isSimulator() ? await pushFileToSimulator(this.opts.device, remotePath, base64Data) : await pushFileToRealDevice(this.opts.device, remotePath, base64Data);
};

commands.pullFile = async function pullFile(remotePath) {
  if (remotePath.endsWith('/')) {
    _logger.default.errorAndThrow(`It is expected that remote path points to a file and not to a folder. ` + `'${remotePath}' is given instead`);
  }

  return this.isSimulator() ? await pullFromSimulator(this.opts.device, remotePath, true) : await pullFromRealDevice(this.opts.device, remotePath, true);
};

async function deleteFileOrFolder(device, remotePath, isSimulator) {
  return isSimulator ? await deleteFromSimulator(device, remotePath) : await deleteFromRealDevice(device, remotePath);
}

commands.mobileDeleteFolder = async function mobileDeleteFolder(opts = {}) {
  let {
    remotePath
  } = opts;

  if (!remotePath.endsWith('/')) {
    remotePath = `${remotePath}/`;
  }

  return await deleteFileOrFolder(this.opts.device, remotePath, this.isSimulator());
};

commands.mobileDeleteFile = async function mobileDeleteFile(opts = {}) {
  const {
    remotePath
  } = opts;

  if (remotePath.endsWith('/')) {
    _logger.default.errorAndThrow(`It is expected that remote path points to a file and not to a folder. ` + `'${remotePath}' is given instead`);
  }

  return await deleteFileOrFolder(this.opts.device, remotePath, this.isSimulator());
};

commands.getSimFileFullPath = async function getSimFileFullPath(remotePath) {
  let basePath = this.opts.device.getDir();
  let appName = null;

  if (this.opts.app) {
    let appNameRegex = new RegExp(`\\${_path.default.sep}([\\w-]+\\.app)`);
    let appNameMatches = appNameRegex.exec(this.opts.app);

    if (appNameMatches) {
      appName = appNameMatches[1];
    }
  }

  if (_appiumSupport.system.isWindows()) {
    if (remotePath.indexof('://') === 1) {
      remotePath = remotePath.slice(4);
    }
  } else {
    if (remotePath.indexOf('/') === 0) {
      remotePath = remotePath.slice(1);
    }
  }

  if (remotePath.startsWith(appName)) {
    let findPath = basePath;

    if (!this.opts.platformVersion || _appiumSupport.util.compareVersions(this.opts.platformVersion, '>=', '8.0')) {
      findPath = _path.default.resolve(basePath, 'Containers', 'Bundle');
    }

    findPath = findPath.replace(/\s/g, '\\ ');
    let {
      stdout
    } = await (0, _teen_process.exec)('find', [findPath, '-name', appName]);
    let appRoot = stdout.replace(/\n$/, '');
    let subPath = remotePath.substring(appName.length + 1);

    let fullPath = _path.default.resolve(appRoot, subPath);

    _logger.default.debug(`Finding app-relative file: '${fullPath}'`);

    return fullPath;
  }

  let fullPath = _path.default.resolve(basePath, remotePath);

  _logger.default.debug(`Finding sim-relative file: ${fullPath}`);

  return fullPath;
};

commands.pullFolder = async function pullFolder(remotePath) {
  if (!remotePath.endsWith('/')) {
    remotePath = `${remotePath}/`;
  }

  return this.isSimulator() ? await pullFromSimulator(this.opts.device, remotePath, false) : await pullFromRealDevice(this.opts.device, remotePath, false);
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maWxlLW1vdmVtZW50LmpzIl0sIm5hbWVzIjpbIkNPTlRBSU5FUl9QQVRIX01BUktFUiIsIkNPTlRBSU5FUl9QQVRIX1BBVFRFUk4iLCJSZWdFeHAiLCJDT05UQUlORVJfVFlQRV9TRVBBUkFUT1IiLCJJRlVTRV9DT05UQUlORVJfRE9DVU1FTlRTIiwiQ09OVEFJTkVSX0RPQ1VNRU5UU19QQVRIIiwiSU9fVElNRU9VVCIsIk9CSkVDVF9OT1RfRk9VTkRfRVJST1JfTUVTU0FHRSIsImNvbW1hbmRzIiwiaW9zQ29tbWFuZHMiLCJmaWxlIiwidmVyaWZ5SXNTdWJQYXRoIiwib3JpZ2luYWxQYXRoIiwicm9vdCIsIm5vcm1hbGl6ZWRSb290IiwicGF0aCIsIm5vcm1hbGl6ZSIsIm5vcm1hbGl6ZWRQYXRoIiwiZGlybmFtZSIsInN0YXJ0c1dpdGgiLCJsb2ciLCJlcnJvckFuZFRocm93IiwiY3JlYXRlQWZjQ2xpZW50IiwidWRpZCIsImJ1bmRsZUlkIiwiY29udGFpbmVyVHlwZSIsInNlcnZpY2VzIiwic3RhcnRBZmNTZXJ2aWNlIiwic2VydmljZSIsInN0YXJ0SG91c2VBcnJlc3RTZXJ2aWNlIiwiaXNEb2N1bWVudHMiLCJ2ZW5kRG9jdW1lbnRzIiwidmVuZENvbnRhaW5lciIsIl8iLCJ0b0xvd2VyIiwibWtkaXJwRGV2aWNlIiwiZGlyIiwibGlzdERpcmVjdG9yeSIsImUiLCJjcmVhdGVEaXJlY3RvcnkiLCJjcmVhdGVTZXJ2aWNlIiwicmVtb3RlUGF0aCIsInRlc3QiLCJwYXRoSW5Db250YWluZXIiLCJwYXJzZUNvbnRhaW5lclBhdGgiLCJyZWxhdGl2ZVBhdGgiLCJqb2luIiwicHVsbEZpbGVGcm9tUmVhbERldmljZSIsInN0cmVhbSIsImNyZWF0ZVJlYWRTdHJlYW0iLCJhdXRvRGVzdHJveSIsImNsb3NlRXZlbnQiLCJCIiwicmVzb2x2ZSIsIm9uIiwidGltZW91dCIsImJ1ZmZlciIsImRhdGEiLCJwdXNoIiwiRXJyb3IiLCJtZXNzYWdlIiwiQnVmZmVyIiwiY29uY2F0IiwidG9TdHJpbmciLCJwdWxsRm9sZGVyRnJvbVJlYWxEZXZpY2UiLCJ0bXBGb2xkZXIiLCJ0ZW1wRGlyIiwib3BlbkRpciIsImZvbGRlclBhdGgiLCJwcm9taXNlcyIsIndhbGtEaXIiLCJpdGVtUGF0aCIsImlzRGlyIiwicGF0aE9uU2VydmVyIiwiZnMiLCJta2RpciIsInJlYWRTdHJlYW0iLCJ3cml0ZVN0cmVhbSIsImNyZWF0ZVdyaXRlU3RyZWFtIiwiYXV0b0Nsb3NlIiwicGlwZSIsImFsbCIsImZyb20iLCJ6aXAiLCJ0b0luTWVtb3J5WmlwIiwicmltcmFmIiwiY29udGFpbmVyUm9vdFN1cHBsaWVyIiwibWF0Y2giLCJleGVjIiwidHlwZVNlcGFyYXRvclBvcyIsImluZGV4T2YiLCJsZW5ndGgiLCJzdWJzdHJpbmciLCJkZWJ1ZyIsImlzTmlsIiwiY29udGFpbmVyUm9vdCIsImlzRnVuY3Rpb24iLCJwb3NpeCIsInB1c2hGaWxlVG9TaW11bGF0b3IiLCJkZXZpY2UiLCJiYXNlNjREYXRhIiwiZHN0UGF0aCIsImFwcEJ1bmRsZSIsImluZm8iLCJleGlzdHMiLCJ3cml0ZUZpbGUiLCJkc3RGb2xkZXIiLCJiYXNlbmFtZSIsInB1c2hGaWxlVG9SZWFsRGV2aWNlIiwid3JpdGUiLCJkZXN0cm95IiwiY2xvc2UiLCJwdWxsRnJvbVNpbXVsYXRvciIsImlzRmlsZSIsInNpbVJvb3QiLCJnZXREaXIiLCJyZWFkRmlsZSIsInB1bGxGcm9tUmVhbERldmljZSIsImZpbGVJbmZvIiwiZ2V0RmlsZUluZm8iLCJpc0RpcmVjdG9yeSIsImluY2x1ZGVzIiwiZGVsZXRlRnJvbVNpbXVsYXRvciIsImRlbGV0ZUZyb21SZWFsRGV2aWNlIiwiZGVsZXRlRGlyZWN0b3J5IiwiZ2V0QXZhaWxhYmxlQnVuZGxlSWRzIiwic3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UiLCJhcHBsaWNhdGlvbnMiLCJsaXN0QXBwbGljYXRpb25zIiwiYXBwbGljYXRpb25UeXBlIiwiYnVuZGxlSWRzIiwia2V5IiwidmFsdWUiLCJPYmplY3QiLCJlbnRyaWVzIiwiVUlGaWxlU2hhcmluZ0VuYWJsZWQiLCJwdXNoRmlsZSIsImVuZHNXaXRoIiwiaXNBcnJheSIsImlzU2ltdWxhdG9yIiwib3B0cyIsInB1bGxGaWxlIiwiZGVsZXRlRmlsZU9yRm9sZGVyIiwibW9iaWxlRGVsZXRlRm9sZGVyIiwibW9iaWxlRGVsZXRlRmlsZSIsImdldFNpbUZpbGVGdWxsUGF0aCIsImJhc2VQYXRoIiwiYXBwTmFtZSIsImFwcCIsImFwcE5hbWVSZWdleCIsInNlcCIsImFwcE5hbWVNYXRjaGVzIiwic3lzdGVtIiwiaXNXaW5kb3dzIiwiaW5kZXhvZiIsInNsaWNlIiwiZmluZFBhdGgiLCJwbGF0Zm9ybVZlcnNpb24iLCJ1dGlsIiwiY29tcGFyZVZlcnNpb25zIiwicmVwbGFjZSIsInN0ZG91dCIsImFwcFJvb3QiLCJzdWJQYXRoIiwiZnVsbFBhdGgiLCJwdWxsRm9sZGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEscUJBQXFCLEdBQUcsR0FBOUI7QUFFQSxNQUFNQyxzQkFBc0IsR0FBRyxJQUFJQyxNQUFKLENBQVksSUFBR0YscUJBQXNCLGNBQXJDLENBQS9CO0FBQ0EsTUFBTUcsd0JBQXdCLEdBQUcsR0FBakM7QUFDQSxNQUFNQyx5QkFBeUIsR0FBRyxXQUFsQztBQUNBLE1BQU1DLHdCQUF3QixHQUFHLFdBQWpDO0FBQ0EsTUFBTUMsVUFBVSxHQUFHLEtBQW5CO0FBQ0EsTUFBTUMsOEJBQThCLEdBQUcsa0JBQXZDO0FBRUEsSUFBSUMsUUFBUSxHQUFHQyw2QkFBWUMsSUFBM0I7OztBQUVBLFNBQVNDLGVBQVQsQ0FBMEJDLFlBQTFCLEVBQXdDQyxJQUF4QyxFQUE4QztBQUM1QyxRQUFNQyxjQUFjLEdBQUdDLGNBQUtDLFNBQUwsQ0FBZUgsSUFBZixDQUF2Qjs7QUFDQSxRQUFNSSxjQUFjLEdB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QUFTLEVBQWpEOztBQUNBLFNBQU9BLFFBQVA7QUFDRCxDQXpDRDs7QUEyQ0E1SixRQUFRLENBQUM2SixVQUFULEdBQXNCLGVBQWVBLFVBQWYsQ0FBMkI1SCxVQUEzQixFQUF1QztBQUMzRCxNQUFJLENBQUNBLFVBQVUsQ0FBQ2dHLFFBQVgsQ0FBb0IsR0FBcEIsQ0FBTCxFQUErQjtBQUM3QmhHLElBQUFBLFVBQVUsR0FBSSxHQUFFQSxVQUFXLEdBQTNCO0FBQ0Q7O0FBQ0QsU0FBTyxLQUFLa0csV0FBTCxLQUNILE1BQU0zQixpQkFBaUIsQ0FBQyxLQUFLNEIsSUFBTCxDQUFVekMsTUFBWCxFQUFtQjFELFVBQW5CLEVBQStCLEtBQS9CLENBRHBCLEdBRUgsTUFBTTRFLGtCQUFrQixDQUFDLEtBQUt1QixJQUFMLENBQVV6QyxNQUFYLEVBQW1CMUQsVUFBbkIsRUFBK0IsS0FBL0IsQ0FGNUI7QUFHRCxDQVBEOztlQVdlakMsUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBzeXN0ZW0sIGZzLCB0ZW1wRGlyLCBta2RpcnAsIHppcCwgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgaW9zQ29tbWFuZHMgfSBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IGFkZE1lZGlhLCBnZXRBcHBDb250YWluZXIgfSBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBzZXJ2aWNlcyB9IGZyb20gJ2FwcGl1bS1pb3MtZGV2aWNlJztcblxuY29uc3QgQ09OVEFJTkVSX1BBVEhfTUFSS0VSID0gJ0AnO1xuLy8gaHR0cHM6Ly9yZWdleDEwMS5jb20vci9QTGRCMEcvMlxuY29uc3QgQ09OVEFJTkVSX1BBVEhfUEFUVEVSTiA9IG5ldyBSZWdFeHAoYF4ke0NPTlRBSU5FUl9QQVRIX01BUktFUn0oW14vXSspLyguKilgKTtcbmNvbnN0IENPTlRBSU5FUl9UWVBFX1NFUEFSQVRPUiA9ICc6JztcbmNvbnN0IElGVVNFX0NPTlRBSU5FUl9ET0NVTUVOVFMgPSAnZG9jdW1lbnRzJztcbmNvbnN0IENPTlRBSU5FUl9ET0NVTUVOVFNfUEFUSCA9ICdEb2N1bWVudHMnO1xuY29uc3QgSU9fVElNRU9VVCA9IDMwMDAwO1xuY29uc3QgT0JKRUNUX05PVF9GT1VORF9FUlJPUl9NRVNTQUdFID0gJ09CSkVDVF9OT1RfRk9VTkQnO1xuXG5sZXQgY29tbWFuZHMgPSBpb3NDb21tYW5kcy5maWxlO1xuXG5mdW5jdGlvbiB2ZXJpZnlJc1N1YlBhdGggKG9yaWdpbmFsUGF0aCwgcm9vdCkge1xuICBjb25zdCBub3JtYWxpemVkUm9vdCA9IHBhdGgubm9ybWFsaXplKHJvb3QpO1xuICBjb25zdCBub3JtYWxpemVkUGF0aCA9IHBhdGgubm9ybWFsaXplKHBhdGguZGlybmFtZShvcmlnaW5hbFBhdGgpKTtcbiAgLy8gSWYgb3JpZ2luYWxQYXRoIGlzIHJvb3QsIGAvYCwgb3JpZ2luYWxQYXRoIHNob3VsZCBlcXVhbCB0byBub3JtYWxpemVkUm9vdFxuICBpZiAobm9ybWFsaXplZFJvb3QgIT09IG9yaWdpbmFsUGF0aCAmJiAhbm9ybWFsaXplZFBhdGguc3RhcnRzV2l0aChub3JtYWxpemVkUm9vdCkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgJyR7bm9ybWFsaXplZFBhdGh9JyBpcyBleHBlY3RlZCB0byBiZSBhIHN1YnBhdGggb2YgJyR7bm9ybWFsaXplZFJvb3R9J2ApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUFmY0NsaWVudCAodWRpZCwgYnVuZGxlSWQsIGNvbnRhaW5lclR5cGUpIHtcbiAgaWYgKCFidW5kbGVJZCkge1xuICAgIHJldHVybiBhd2FpdCBzZXJ2aWNlcy5zdGFydEFmY1NlcnZpY2UodWRpZCk7XG4gIH1cbiAgY29uc3Qgc2VydmljZSA9IGF3YWl0IHNlcnZpY2VzLnN0YXJ0SG91c2VBcnJlc3RTZXJ2aWNlKHVkaWQpO1xuICBpZiAoaXNEb2N1bWVudHMoY29udGFpbmVyVHlwZSkpIHtcbiAgICByZXR1cm4gYXdhaXQgc2VydmljZS52ZW5kRG9jdW1lbnRzKGJ1bmRsZUlkKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXdhaXQgc2VydmljZS52ZW5kQ29udGFpbmVyKGJ1bmRsZUlkKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpc0RvY3VtZW50cyAoY29udGFpbmVyVHlwZSkge1xuICByZXR1cm4gXy50b0xvd2VyKGNvbnRhaW5lclR5cGUpID09PSBJRlVTRV9DT05UQUlORVJfRE9DVU1FTlRTO1xufVxuXG5hc3luYyBmdW5jdGlvbiBta2RpcnBEZXZpY2UgKHNlcnZpY2UsIGRpcikge1xuICBpZiAoZGlyID09PSAnLicgfHwgZGlyID09PSAnLycpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgdHJ5IHtcbiAgICBhd2FpdCBzZXJ2aWNlLmxpc3REaXJlY3RvcnkoZGlyKTtcbiAgICByZXR1cm47XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICAvLyBUaGlzIG1lYW5zIHRoYXQgdGhlIGRpcmVjdG9yeSBpcyBtaXNzaW5nIGFuZCB3ZSBnb3QgYW4gb2JqZWN0IG5vdCBmb3VuZCBlcnJvci4gVGhlcmVmb3JlLCB3ZSBhcmUgZ29pbmcgdG8gdGhlIHBhcmVudFxuICAgIGF3YWl0IG1rZGlycERldmljZShzZXJ2aWNlLCBwYXRoLmRpcm5hbWUoZGlyKSk7XG4gIH1cbiAgYXdhaXQgc2VydmljZS5jcmVhdGVEaXJlY3RvcnkoZGlyKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlU2VydmljZSAodWRpZCwgcmVtb3RlUGF0aCkge1xuICBpZiAoQ09OVEFJTkVSX1BBVEhfUEFUVEVSTi50ZXN0KHJlbW90ZVBhdGgpKSB7XG4gICAgY29uc3Qge2J1bmRsZUlkLCBwYXRoSW5Db250YWluZXIsIGNvbnRhaW5lclR5cGV9ID0gYXdhaXQgcGFyc2VDb250YWluZXJQYXRoKHJlbW90ZVBhdGgpO1xuICAgIGNvbnN0IHNlcnZpY2UgPSBhd2FpdCBjcmVhdGVBZmNDbGllbnQodWRpZCwgYnVuZGxlSWQsIGNvbnRhaW5lclR5cGUpO1xuICAgIGNvbnN0IHJlbGF0aXZlUGF0aCA9IGlzRG9jdW1lbnRzKGNvbnRhaW5lclR5cGUpID8gcGF0aC5qb2luKENPTlRBSU5FUl9ET0NVTUVOVFNfUEFUSCwgcGF0aEluQ29udGFpbmVyKSA6IHBhdGhJbkNvbnRhaW5lcjtcbiAgICByZXR1cm4ge3NlcnZpY2UsIHJlbGF0aXZlUGF0aH07XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgc2VydmljZSA9IGF3YWl0IGNyZWF0ZUFmY0NsaWVudCh1ZGlkKTtcbiAgICBjb25zdCByZWxhdGl2ZVBhdGggPSByZW1vdGVQYXRoO1xuICAgIHJldHVybiB7c2VydmljZSwgcmVsYXRpdmVQYXRofTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBwdWxsRmlsZUZyb21SZWFsRGV2aWNlIChzZXJ2aWNlLCByZWxhdGl2ZVBhdGgpIHtcbiAgY29uc3Qgc3RyZWFtID0gYXdhaXQgc2VydmljZS5jcmVhdGVSZWFkU3RyZWFtKHJlbGF0aXZlUGF0aCwgeyBhdXRvRGVzdHJveTogdHJ1ZSB9KTtcbiAgY29uc3QgY2xvc2VFdmVudCA9IG5ldyBCKChyZXNvbHZlKSA9PiBzdHJlYW0ub24oJ2Nsb3NlJywgcmVzb2x2ZSkpLnRpbWVvdXQoSU9fVElNRU9VVCk7XG4gIGNvbnN0IGJ1ZmZlciA9IFtdO1xuICBzdHJlYW0ub24oJ2RhdGEnLCAoZGF0YSkgPT4gYnVmZmVyLnB1c2goZGF0YSkpO1xuICB0cnkge1xuICAgIGF3YWl0IGNsb3NlRXZlbnQ7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkbid0IHB1bGwgdGhlIGZpbGUgJyR7cmVsYXRpdmVQYXRofScgYCArXG4gICAgICBgd2l0aGluIHRoZSBnaXZlbiB0aW1lb3V0ICR7SU9fVElNRU9VVH1tcy4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICB9XG4gIHJldHVybiBCdWZmZXIuY29uY2F0KGJ1ZmZlcikudG9TdHJpbmcoJ2Jhc2U2NCcpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwdWxsRm9sZGVyRnJvbVJlYWxEZXZpY2UgKHNlcnZpY2UsIHJlbGF0aXZlUGF0aCkge1xuICBjb25zdCB0bXBGb2xkZXIgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgdHJ5IHtcbiAgICBjb25zdCBmb2xkZXJQYXRoID0gcGF0aC5qb2luKHRtcEZvbGRlciwgcmVsYXRpdmVQYXRoKTtcbiAgICBhd2FpdCBta2RpcnAoZm9sZGVyUGF0aCk7XG4gICAgY29uc3QgcHJvbWlzZXMgPSBbXTtcbiAgICBhd2FpdCBzZXJ2aWNlLndhbGtEaXIocmVsYXRpdmVQYXRoLCB0cnVlLCBhc3luYyAoaXRlbVBhdGgsIGlzRGlyKSA9PiB7XG4gICAgICBjb25zdCBwYXRoT25TZXJ2ZXIgPSBwYXRoLmpvaW4odG1wRm9sZGVyLCBpdGVtUGF0aCk7XG4gICAgICBpZiAoaXNEaXIpIHtcbiAgICAgICAgYXdhaXQgZnMubWtkaXIocGF0aE9uU2VydmVyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJlYWRTdHJlYW0gPSBhd2FpdCBzZXJ2aWNlLmNyZWF0ZVJlYWRTdHJlYW0oaXRlbVBhdGgsIHthdXRvRGVzdHJveTogdHJ1ZSB9KTtcbiAgICAgICAgY29uc3Qgd3JpdGVTdHJlYW0gPSBmcy5jcmVhdGVXcml0ZVN0cmVhbShwYXRoT25TZXJ2ZXIsIHthdXRvQ2xvc2U6IHRydWV9KTtcbiAgICAgICAgcHJvbWlzZXMucHVzaChuZXcgQigocmVzb2x2ZSkgPT4gd3JpdGVTdHJlYW0ub24oJ2Nsb3NlJywgcmVzb2x2ZSkpKTtcbiAgICAgICAgcmVhZFN0cmVhbS5waXBlKHdyaXRlU3RyZWFtKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgQi5hbGwocHJvbWlzZXMpLnRpbWVvdXQoSU9fVElNRU9VVCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZG4ndCBwdWxsIGFsbCBpdGVtcyBpbiB0aGUgZm9sZGVyICcke3JlbGF0aXZlUGF0aH0nIGAgK1xuICAgICAgICBgd2l0aGluIHRoZSBnaXZlbiB0aW1lb3V0ICR7SU9fVElNRU9VVH1tcy4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgICByZXR1cm4gQnVmZmVyLmZyb20oYXdhaXQgemlwLnRvSW5NZW1vcnlaaXAoZm9sZGVyUGF0aCkpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yaW1yYWYodG1wRm9sZGVyKTtcbiAgfVxufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IENvbnRhaW5lck9iamVjdFxuICpcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBidW5kbGVJZCAtIFRoZSBwYXJzZWQgYnVuZGxlIGlkZW50aWZpZXJcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBwYXRoSW5Db250YWluZXIgLSBUaGUgYWJzb2x1dGUgZnVsbCBwYXRoIG9mIHRoZSBpdGVtIG9uIHRoZSBsb2NhbCBmaWxlIHN5c3RlbVxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBjb250YWluZXJUeXBlIC0gVGhlIGNvbnRhaW5lciB0eXBlXG4gKi9cblxuLyoqXG4gKiBQYXJzZXMgdGhlIGFjdHVhbCBwYXRoIGFuZCB0aGUgYnVuZGxlIGlkZW50aWZpZXIgZnJvbSB0aGUgZ2l2ZW4gcGF0aCBzdHJpbmdcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBnaXZlbiBwYXRoIHN0cmluZy4gVGhlIHN0cmluZyBzaG91bGRcbiAqIG1hdGNoIGBDT05UQUlORVJfUEFUSF9QQVRURVJOYCByZWdleHAsIG90aGVyd2lzZSBhbiBlcnJvciBpcyBnb2luZ1xuICogdG8gYmUgdGhyb3duLiBBIHZhbGlkIHN0cmluZyBleGFtcGxlOiBgQGJ1bmRsZS5pZGVudGlmaWVyOmNvbnRhaW5lcl90eXBlL3JlbGF0aXZlX3BhdGhfaW5fY29udGFpbmVyYFxuICogQHBhcmFtIHtGdW5jdGlvbnxzdHJpbmd9IGNvbnRhaW5lclJvb3RTdXBwbGllciAtIEVpdGhlciBhIHN0cmluZywgdGhhdCBjb250YWluc1xuICogZnVsbCBwYXRoIHRvIHRoZSBtb3VudCByb290IGZvciByZWFsIGRldmljZXMgb3IgYSBmdW5jdGlvbiwgd2hpY2ggYWNjZXB0cyB0d28gcGFyYW1ldGVyc1xuICogKGJ1bmRsZSBpZGVudGlmaWVyIGFuZCBvcHRpb25hbCBjb250YWluZXIgdHlwZSkgYW5kIHJldHVybnMgZnVsbCBwYXRoIHRvIGNvbnRhaW5lclxuICogcm9vdCBmb2xkZXIgb24gdGhlIGxvY2FsIGZpbGUgc3lzdGVtLCBmb3IgU2ltdWxhdG9yXG4gKiBAcmV0dXJucyB7Q29udGFpbmVyT2JqZWN0fVxuICovXG5hc3luYyBmdW5jdGlvbiBwYXJzZUNvbnRhaW5lclBhdGggKHJlbW90ZVBhdGgsIGNvbnRhaW5lclJvb3RTdXBwbGllcikge1xuICBjb25zdCBtYXRjaCA9IENPTlRBSU5FUl9QQVRIX1BBVFRFUk4uZXhlYyhyZW1vdGVQYXRoKTtcbiAgaWYgKCFtYXRjaCkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBJdCBpcyBleHBlY3RlZCB0aGF0IHBhY2thZ2UgaWRlbnRpZmllciBgICtcbiAgICAgIGBzdGFydHMgd2l0aCAnJHtDT05UQUlORVJfUEFUSF9NQVJLRVJ9JyBhbmQgaXMgc2VwYXJhdGVkIGZyb20gdGhlIGAgK1xuICAgICAgYHJlbGF0aXZlIHBhdGggd2l0aCBhIHNpbmdsZSBzbGFzaC4gJyR7cmVtb3RlUGF0aH0nIGlzIGdpdmVuIGluc3RlYWRgKTtcbiAgfVxuICBsZXQgWywgYnVuZGxlSWQsIHJlbGF0aXZlUGF0aF0gPSBtYXRjaDtcbiAgbGV0IGNvbnRhaW5lclR5cGUgPSBudWxsO1xuICBjb25zdCB0eXBlU2VwYXJhdG9yUG9zID0gYnVuZGxlSWQuaW5kZXhPZihDT05UQUlORVJfVFlQRV9TRVBBUkFUT1IpO1xuICAvLyBXZSBvbmx5IGNvbnNpZGVyIGNvbnRhaW5lciB0eXBlIGV4aXN0cyBpZiBpdHMgbGVuZ3RoIGlzIGdyZWF0ZXIgdGhhbiB6ZXJvXG4gIC8vIG5vdCBjb3VudGluZyB0aGUgY29sb25cbiAgaWYgKHR5cGVTZXBhcmF0b3JQb3MgPiAwICYmIHR5cGVTZXBhcmF0b3JQb3MgPCBidW5kbGVJZC5sZW5ndGggLSAxKSB7XG4gICAgY29udGFpbmVyVHlwZSA9IGJ1bmRsZUlkLnN1YnN0cmluZyh0eXBlU2VwYXJhdG9yUG9zICsgMSk7XG4gICAgbG9nLmRlYnVnKGBQYXJzZWQgY29udGFpbmVyIHR5cGU6ICR7Y29udGFpbmVyVHlwZX1gKTtcbiAgICBidW5kbGVJZCA9IGJ1bmRsZUlkLnN1YnN0cmluZygwLCB0eXBlU2VwYXJhdG9yUG9zKTtcbiAgfVxuICBpZiAoXy5pc05pbChjb250YWluZXJSb290U3VwcGxpZXIpKSB7XG4gICAgY29uc3QgcGF0aEluQ29udGFpbmVyID0gcmVsYXRpdmVQYXRoO1xuICAgIHJldHVybiB7IGJ1bmRsZUlkLCBwYXRoSW5Db250YWluZXIsIGNvbnRhaW5lclR5cGUgfTtcbiAgfVxuICBjb25zdCBjb250YWluZXJSb290ID0gXy5pc0Z1bmN0aW9uKGNvbnRhaW5lclJvb3RTdXBwbGllcilcbiAgICA/IGF3YWl0IGNvbnRhaW5lclJvb3RTdXBwbGllcihidW5kbGVJZCwgY29udGFpbmVyVHlwZSlcbiAgICA6IGNvbnRhaW5lclJvb3RTdXBwbGllcjtcbiAgY29uc3QgcGF0aEluQ29udGFpbmVyID0gcGF0aC5wb3NpeC5yZXNvbHZlKGNvbnRhaW5lclJvb3QsIHJlbGF0aXZlUGF0aCk7XG4gIHZlcmlmeUlzU3ViUGF0aChwYXRoSW5Db250YWluZXIsIGNvbnRhaW5lclJvb3QpO1xuICByZXR1cm4ge2J1bmRsZUlkLCBwYXRoSW5Db250YWluZXIsIGNvbnRhaW5lclR5cGV9O1xufVxuXG4vKipcbiAqIFNhdmUgdGhlIGdpdmVuIGJhc2U2NCBkYXRhIGNodW5rIGFzIGEgYmluYXJ5IGZpbGUgb24gdGhlIFNpbXVsYXRvciB1bmRlciB0ZXN0LlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBkZXZpY2UgLSBUaGUgZGV2aWNlIG9iamVjdCwgd2hpY2ggcmVwcmVzZW50cyB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgVGhpcyBvYmplY3QgaXMgZXhwZWN0ZWQgdG8gaGF2ZSB0aGUgYHVkaWRgIHByb3BlcnR5IGNvbnRhaW5pbmcgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWQgZGV2aWNlIElELlxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgcmVtb3RlIHBhdGggb24gdGhlIGRldmljZS4gVGhpcyB2YXJpYWJsZSBjYW4gYmUgcHJlZml4ZWQgd2l0aFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidW5kbGUgaWQsIHNvIHRoZW4gdGhlIGZpbGUgd2lsbCBiZSB1cGxvYWRlZCB0byB0aGUgY29ycmVzcG9uZGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbiBjb250YWluZXIgaW5zdGVhZCBvZiB0aGUgZGVmYXVsdCBtZWRpYSBmb2xkZXIsIGZvciBleGFtcGxlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdAY29tLm15YXBwLmJsYTpkYXRhL1JlbGF0aXZlUGF0aEluQ29udGFpbmVyLzExMS5wbmcnLiBUaGUgJ0AnIGNoYXJhY3RlciBhdCB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVnaW5uaW5nIG9mIHRoZSBhcmd1bWVudCBpcyBtYW5kYXRvcnkgaW4gc3VjaCBjYXNlLiBUaGUgY29sb24gYXQgdGhlIGVuZCBvZiBidW5kbGUgaWRlbnRpZmllclxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpcyBvcHRpb25hbCBhbmQgaXMgdXNlZCB0byBkaXN0aW5ndWlzaCB0aGUgY29udGFpbmVyIHR5cGUuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBvc3NpYmxlIHZhbHVlcyB0aGVyZSBhcmUgJ2FwcCcsICdkYXRhJywgJ2dyb3VwcycsICc8QSBzcGVjaWZpYyBBcHAgR3JvdXAgY29udGFpbmVyPicuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBkZWZhdWx0IHZhbHVlIGlzICdhcHAnLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgcmVsYXRpdmUgZm9sZGVyIHBhdGggaXMgaWdub3JlZCBpZiB0aGUgZmlsZSBpcyBnb2luZyB0byBiZSB1cGxvYWRlZFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0byB0aGUgZGVmYXVsdCBtZWRpYSBmb2xkZXIgYW5kIG9ubHkgdGhlIGZpbGUgbmFtZSBpcyBjb25zaWRlcmVkIGltcG9ydGFudC5cbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlNjREYXRhIC0gQmFzZS02NCBlbmNvZGVkIGNvbnRlbnQgb2YgdGhlIGZpbGUgdG8gYmUgdXBsb2FkZWQuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHB1c2hGaWxlVG9TaW11bGF0b3IgKGRldmljZSwgcmVtb3RlUGF0aCwgYmFzZTY0RGF0YSkge1xuICBjb25zdCBidWZmZXIgPSBCdWZmZXIuZnJvbShiYXNlNjREYXRhLCAnYmFzZTY0Jyk7XG4gIGlmIChDT05UQUlORVJfUEFUSF9QQVRURVJOLnRlc3QocmVtb3RlUGF0aCkpIHtcbiAgICBjb25zdCB7YnVuZGxlSWQsIHBhdGhJbkNvbnRhaW5lcjogZHN0UGF0aH0gPSBhd2FpdCBwYXJzZUNvbnRhaW5lclBhdGgocmVtb3RlUGF0aCxcbiAgICAgIGFzeW5jIChhcHBCdW5kbGUsIGNvbnRhaW5lclR5cGUpID0+IGF3YWl0IGdldEFwcENvbnRhaW5lcihkZXZpY2UudWRpZCwgYXBwQnVuZGxlLCBudWxsLCBjb250YWluZXJUeXBlKSk7XG4gICAgbG9nLmluZm8oYFBhcnNlZCBidW5kbGUgaWRlbnRpZmllciAnJHtidW5kbGVJZH0nIGZyb20gJyR7cmVtb3RlUGF0aH0nLiBgICtcbiAgICAgIGBXaWxsIHB1dCB0aGUgZGF0YSBpbnRvICcke2RzdFBhdGh9J2ApO1xuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHBhdGguZGlybmFtZShkc3RQYXRoKSkpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgVGhlIGRlc3RpbmF0aW9uIGZvbGRlciAnJHtwYXRoLmRpcm5hbWUoZHN0UGF0aCl9JyBkb2VzIG5vdCBleGlzdC4gQ3JlYXRpbmcuLi5gKTtcbiAgICAgIGF3YWl0IG1rZGlycChwYXRoLmRpcm5hbWUoZHN0UGF0aCkpO1xuICAgIH1cbiAgICBhd2FpdCBmcy53cml0ZUZpbGUoZHN0UGF0aCwgYnVmZmVyKTtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgZHN0Rm9sZGVyID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gIGNvbnN0IGRzdFBhdGggPSBwYXRoLnJlc29sdmUoZHN0Rm9sZGVyLCBwYXRoLmJhc2VuYW1lKHJlbW90ZVBhdGgpKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUoZHN0UGF0aCwgYnVmZmVyKTtcbiAgICBhd2FpdCBhZGRNZWRpYShkZXZpY2UudWRpZCwgZHN0UGF0aCk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgZnMucmltcmFmKGRzdEZvbGRlcik7XG4gIH1cbn1cblxuLyoqXG4gKiBTYXZlIHRoZSBnaXZlbiBiYXNlNjQgZGF0YSBjaHVuayBhcyBhIGJpbmFyeSBmaWxlIG9uIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gZGV2aWNlIC0gVGhlIGRldmljZSBvYmplY3QsIHdoaWNoIHJlcHJlc2VudHMgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgIFRoaXMgb2JqZWN0IGlzIGV4cGVjdGVkIHRvIGhhdmUgdGhlIGB1ZGlkYCBwcm9wZXJ0eSBjb250YWluaW5nIHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkIGRldmljZSBJRC5cbiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHJlbW90ZSBwYXRoIG9uIHRoZSBkZXZpY2UuIFRoaXMgdmFyaWFibGUgY2FuIGJlIHByZWZpeGVkIHdpdGhcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVuZGxlIGlkLCBzbyB0aGVuIHRoZSBmaWxlIHdpbGwgYmUgdXBsb2FkZWQgdG8gdGhlIGNvcnJlc3BvbmRpbmdcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGljYXRpb24gY29udGFpbmVyIGluc3RlYWQgb2YgdGhlIGRlZmF1bHQgbWVkaWEgZm9sZGVyLiBVc2VcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQDxhcHBfYnVuZGxlX2lkPjo8b3B0aW9uYWxfY29udGFpbmVyX3R5cGU+LzxwYXRoX3RvX3RoZV9maWxlX29yX2ZvbGRlcl9pbnNpZGVfY29udGFpbmVyPlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXQgdG8gcHVsbCBhIGZpbGUgb3IgYSBmb2xkZXIgZnJvbSBhbiBhcHBsaWNhdGlvbiBjb250YWluZXIgb2YgdGhlIGdpdmVuIHR5cGUuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBvbmx5IHN1cHBvcnRlZCBjb250YWluZXIgdHlwZSBpcyAnZG9jdW1lbnRzJy4gSWYgdGhlIGNvbnRhaW5lciB0eXBlIGlzIG5vdCBzZXRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhwbGljaXRseSBmb3IgYSBidW5kbGUgaWQsIHRoZW4gdGhlIGRlZmF1bHQgYXBwbGljYXRpb24gY29udGFpbmVyIGlzIGdvaW5nIHRvIGJlIG1vdW50ZWRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGFrYSAtLWNvbnRhaW5lciBpZnVzZSBhcmd1bWVudClcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZS5nLiBJZiBgQGNvbS5teWFwcC5ibGE6ZG9jdW1lbnRzLzExMS5wbmdgIGlzIHByb3ZpZGVkLFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBPbiBNeSBpUGhvbmUvPGFwcCBuYW1lPmAgaW4gRmlsZXMgYXBwIHdpbGwgYmUgbW91bnRlZCBpbiB0aGUgaG9zdCBtYWNoaW5lLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEJhc2U2NCBlbmNvZGVkIGAxMTEucG5nYCB3aWxsIGJlIHB1c2hlZCBpbnRvIGBPbiBNeSBpUGhvbmUvPGFwcCBuYW1lPi8xMTEucG5nYFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzIGJhc2U2NCBkZWNvZGVkIGRhdGEuXG4gKiBAcGFyYW0ge3N0cmluZ30gYmFzZTY0RGF0YSAtIEJhc2UtNjQgZW5jb2RlZCBjb250ZW50IG9mIHRoZSBmaWxlIHRvIGJlIHVwbG9hZGVkLlxuICovXG5hc3luYyBmdW5jdGlvbiBwdXNoRmlsZVRvUmVhbERldmljZSAoZGV2aWNlLCByZW1vdGVQYXRoLCBiYXNlNjREYXRhKSB7XG4gIGNvbnN0IHtzZXJ2aWNlLCByZWxhdGl2ZVBhdGh9ID0gYXdhaXQgY3JlYXRlU2VydmljZShkZXZpY2UudWRpZCwgcmVtb3RlUGF0aCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgbWtkaXJwRGV2aWNlKHNlcnZpY2UsIHBhdGguZGlybmFtZShyZWxhdGl2ZVBhdGgpKTtcbiAgICBjb25zdCBzdHJlYW0gPSBhd2FpdCBzZXJ2aWNlLmNyZWF0ZVdyaXRlU3RyZWFtKHJlbGF0aXZlUGF0aCwgeyBhdXRvQ2xvc2U6IHRydWUgfSk7XG4gICAgc3RyZWFtLndyaXRlKEJ1ZmZlci5mcm9tKGJhc2U2NERhdGEsICdiYXNlNjQnKSk7XG4gICAgY29uc3QgY2xvc2VFdmVudCA9IG5ldyBCKChyZXNvbHZlKSA9PiBzdHJlYW0ub24oJ2Nsb3NlJywgcmVzb2x2ZSkpLnRpbWVvdXQoSU9fVElNRU9VVCk7XG4gICAgc3RyZWFtLmRlc3Ryb3koKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgY2xvc2VFdmVudDtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBwdXNoIHRoZSBmaWxlIHdpdGhpbiB0aGUgZ2l2ZW4gdGltZW91dCAke0lPX1RJTUVPVVR9bXMuIGAgK1xuICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfSBmaW5hbGx5IHtcbiAgICBzZXJ2aWNlLmNsb3NlKCk7XG4gIH1cbn1cblxuLyoqXG4gKiBHZXQgdGhlIGNvbnRlbnQgb2YgZ2l2ZW4gZmlsZSBvciBmb2xkZXIgZnJvbSBpT1MgU2ltdWxhdG9yIGFuZCByZXR1cm4gaXQgYXMgYmFzZS02NCBlbmNvZGVkIHN0cmluZy5cbiAqIEZvbGRlciBjb250ZW50IGlzIHJlY3Vyc2l2ZWx5IHBhY2tlZCBpbnRvIGEgemlwIGFyY2hpdmUuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IGRldmljZSAtIFRoZSBkZXZpY2Ugb2JqZWN0LCB3aGljaCByZXByZXNlbnRzIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBUaGlzIG9iamVjdCBpcyBleHBlY3RlZCB0byBoYXZlIHRoZSBgdWRpZGAgcHJvcGVydHkgY29udGFpbmluZyB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZCBkZXZpY2UgSUQuXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIGEgZmlsZSBvciBhIGZvbGRlciwgd2hpY2ggZXhpc3RzIGluIHRoZSBjb3JyZXNwb25kaW5nIGFwcGxpY2F0aW9uXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lciBvbiBTaW11bGF0b3IuIFVzZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBAPGFwcF9idW5kbGVfaWQ+OjxvcHRpb25hbF9jb250YWluZXJfdHlwZT4vPHBhdGhfdG9fdGhlX2ZpbGVfb3JfZm9sZGVyX2luc2lkZV9jb250YWluZXI+XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdCB0byBwdWxsIGEgZmlsZSBvciBhIGZvbGRlciBmcm9tIGFuIGFwcGxpY2F0aW9uIGNvbnRhaW5lciBvZiB0aGUgZ2l2ZW4gdHlwZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUG9zc2libGUgY29udGFpbmVyIHR5cGVzIGFyZSAnYXBwJywgJ2RhdGEnLCAnZ3JvdXBzJywgJzxBIHNwZWNpZmljIEFwcCBHcm91cCBjb250YWluZXI+Jy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGRlZmF1bHQgdHlwZSBpcyAnYXBwJy5cbiAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNGaWxlIC0gV2hldGhlciB0aGUgZGVzdGluYXRpb24gaXRlbSBpcyBhIGZpbGUgb3IgYSBmb2xkZXJcbiAqIEByZXR1cm5zIHtzdHJpbmd9IEJhc2UtNjQgZW5jb2RlZCBjb250ZW50IG9mIHRoZSBmaWxlLlxuICovXG5hc3luYyBmdW5jdGlvbiBwdWxsRnJvbVNpbXVsYXRvciAoZGV2aWNlLCByZW1vdGVQYXRoLCBpc0ZpbGUpIHtcbiAgbGV0IHBhdGhPblNlcnZlcjtcbiAgaWYgKENPTlRBSU5FUl9QQVRIX1BBVFRFUk4udGVzdChyZW1vdGVQYXRoKSkge1xuICAgIGNvbnN0IHtidW5kbGVJZCwgcGF0aEluQ29udGFpbmVyOiBkc3RQYXRofSA9IGF3YWl0IHBhcnNlQ29udGFpbmVyUGF0aChyZW1vdGVQYXRoLFxuICAgICAgYXN5bmMgKGFwcEJ1bmRsZSwgY29udGFpbmVyVHlwZSkgPT4gYXdhaXQgZ2V0QXBwQ29udGFpbmVyKGRldmljZS51ZGlkLCBhcHBCdW5kbGUsIG51bGwsIGNvbnRhaW5lclR5cGUpKTtcbiAgICBsb2cuaW5mbyhgUGFyc2VkIGJ1bmRsZSBpZGVudGlmaWVyICcke2J1bmRsZUlkfScgZnJvbSAnJHtyZW1vdGVQYXRofScuIGAgK1xuICAgICAgYFdpbGwgZ2V0IHRoZSBkYXRhIGZyb20gJyR7ZHN0UGF0aH0nYCk7XG4gICAgcGF0aE9uU2VydmVyID0gZHN0UGF0aDtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBzaW1Sb290ID0gZGV2aWNlLmdldERpcigpO1xuICAgIHBhdGhPblNlcnZlciA9IHBhdGgucG9zaXguam9pbihzaW1Sb290LCByZW1vdGVQYXRoKTtcbiAgICB2ZXJpZnlJc1N1YlBhdGgocGF0aE9uU2VydmVyLCBzaW1Sb290KTtcbiAgICBsb2cuaW5mbyhgR290IHRoZSBmdWxsIGl0ZW0gcGF0aDogJHtwYXRoT25TZXJ2ZXJ9YCk7XG4gIH1cbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMocGF0aE9uU2VydmVyKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgcmVtb3RlICR7aXNGaWxlID8gJ2ZpbGUnIDogJ2ZvbGRlcid9IGF0ICcke3BhdGhPblNlcnZlcn0nIGRvZXMgbm90IGV4aXN0YCk7XG4gIH1cbiAgY29uc3QgYnVmZmVyID0gaXNGaWxlXG4gICAgPyBhd2FpdCBmcy5yZWFkRmlsZShwYXRoT25TZXJ2ZXIpXG4gICAgOiBhd2FpdCB6aXAudG9Jbk1lbW9yeVppcChwYXRoT25TZXJ2ZXIpO1xuICByZXR1cm4gQnVmZmVyLmZyb20oYnVmZmVyKS50b1N0cmluZygnYmFzZTY0Jyk7XG59XG5cbi8qKlxuICogR2V0IHRoZSBjb250ZW50IG9mIGdpdmVuIGZpbGUgb3IgZm9sZGVyIGZyb20gdGhlIHJlYWwgZGV2aWNlIHVuZGVyIHRlc3QgYW5kIHJldHVybiBpdCBhcyBiYXNlLTY0IGVuY29kZWQgc3RyaW5nLlxuICogRm9sZGVyIGNvbnRlbnQgaXMgcmVjdXJzaXZlbHkgcGFja2VkIGludG8gYSB6aXAgYXJjaGl2ZS5cbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gZGV2aWNlIC0gVGhlIGRldmljZSBvYmplY3QsIHdoaWNoIHJlcHJlc2VudHMgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgIFRoaXMgb2JqZWN0IGlzIGV4cGVjdGVkIHRvIGhhdmUgdGhlIGB1ZGlkYCBwcm9wZXJ0eSBjb250YWluaW5nIHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkIGRldmljZSBJRC5cbiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHBhdGggdG8gYW4gZXhpc3RpbmcgcmVtb3RlIGZpbGUgb24gdGhlIGRldmljZS4gVGhpcyB2YXJpYWJsZSBjYW4gYmUgcHJlZml4ZWQgd2l0aFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidW5kbGUgaWQsIHNvIHRoZW4gdGhlIGZpbGUgd2lsbCBiZSBkb3dubG9hZGVkIGZyb20gdGhlIGNvcnJlc3BvbmRpbmdcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGljYXRpb24gY29udGFpbmVyIGluc3RlYWQgb2YgdGhlIGRlZmF1bHQgbWVkaWEgZm9sZGVyLiBVc2VcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQDxhcHBfYnVuZGxlX2lkPjo8b3B0aW9uYWxfY29udGFpbmVyX3R5cGU+LzxwYXRoX3RvX3RoZV9maWxlX29yX2ZvbGRlcl9pbnNpZGVfY29udGFpbmVyPlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXQgdG8gcHVsbCBhIGZpbGUgb3IgYSBmb2xkZXIgZnJvbSBhbiBhcHBsaWNhdGlvbiBjb250YWluZXIgb2YgdGhlIGdpdmVuIHR5cGUuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBvbmx5IHN1cHBvcnRlZCBjb250YWluZXIgdHlwZSBpcyAnZG9jdW1lbnRzJy4gSWYgdGhlIGNvbnRhaW5lciB0eXBlIGlzIG5vdCBzZXRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhwbGljaXRseSBmb3IgYSBidW5kbGUgaWQsIHRoZW4gdGhlIGRlZmF1bHQgYXBwbGljYXRpb24gY29udGFpbmVyIGlzIGdvaW5nIHRvIGJlIG1vdW50ZWRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGFrYSAtLWNvbnRhaW5lciBpZnVzZSBhcmd1bWVudClcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZS5nLiBJZiBgQGNvbS5teWFwcC5ibGE6ZG9jdW1lbnRzLzExMS5wbmdgIGlzIHByb3ZpZGVkLFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBPbiBNeSBpUGhvbmUvPGFwcCBuYW1lPmAgaW4gRmlsZXMgYXBwIHdpbGwgYmUgbW91bnRlZCBpbiB0aGUgaG9zdCBtYWNoaW5lLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBPbiBNeSBpUGhvbmUvPGFwcCBuYW1lPi8xMTEucG5nYCB3aWwgYmUgcHVsbGVkIGludG8gdGhlIG1vdW50ZWQgaG9zdCBtYWNoaW5lXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5kIEFwcGl1bSByZXR1cm5zIHRoZSBkYXRhIGFzIGJhc2U2NC1lbmNvZGVkIHN0cmluZyB0byBjbGllbnQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYEBjb20ubXlhcHAuYmxhOmRvY3VtZW50cy9gIG1lYW5zIGBPbiBNeSBpUGhvbmUvPGFwcCBuYW1lPmAuXG4gKiBAcGFyYW0ge2Jvb2xlYW59IGlzRmlsZSAtIFdoZXRoZXIgdGhlIGRlc3RpbmF0aW9uIGl0ZW0gaXMgYSBmaWxlIG9yIGEgZm9sZGVyXG4gKiBAcmV0dXJuIHtzdHJpbmd9IEJhc2UtNjQgZW5jb2RlZCBjb250ZW50IG9mIHRoZSByZW1vdGUgZmlsZVxuICovXG5hc3luYyBmdW5jdGlvbiBwdWxsRnJvbVJlYWxEZXZpY2UgKGRldmljZSwgcmVtb3RlUGF0aCwgaXNGaWxlKSB7XG4gIGNvbnN0IHtzZXJ2aWNlLCByZWxhdGl2ZVBhdGh9ID0gYXdhaXQgY3JlYXRlU2VydmljZShkZXZpY2UudWRpZCwgcmVtb3RlUGF0aCk7XG4gIHRyeSB7XG4gICAgY29uc3QgZmlsZUluZm8gPSBhd2FpdCBzZXJ2aWNlLmdldEZpbGVJbmZvKHJlbGF0aXZlUGF0aCk7XG4gICAgaWYgKGlzRmlsZSAmJiBmaWxlSW5mby5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSByZXF1ZXN0ZWQgcGF0aCBpcyBub3QgYSBmaWxlLiBQYXRoOiAnJHtyZW1vdGVQYXRofSdgKTtcbiAgICB9XG4gICAgaWYgKCFpc0ZpbGUgJiYgIWZpbGVJbmZvLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHJlcXVlc3RlZCBwYXRoIGlzIG5vdCBhIGZvbGRlci4gUGF0aDogJyR7cmVtb3RlUGF0aH0nYCk7XG4gICAgfVxuXG4gICAgaWYgKGZpbGVJbmZvLmlzRmlsZSgpKSB7XG4gICAgICByZXR1cm4gYXdhaXQgcHVsbEZpbGVGcm9tUmVhbERldmljZShzZXJ2aWNlLCByZWxhdGl2ZVBhdGgpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gYXdhaXQgcHVsbEZvbGRlckZyb21SZWFsRGV2aWNlKHNlcnZpY2UsIHJlbGF0aXZlUGF0aCk7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGUubWVzc2FnZS5pbmNsdWRlcyhPQkpFQ1RfTk9UX0ZPVU5EX0VSUk9SX01FU1NBR0UpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFBhdGggJyR7cmVtb3RlUGF0aH0nIGRvZXMgbm90IGV4aXN0IG9uIHRoZSBkZXZpY2VgKTtcbiAgICB9XG4gICAgdGhyb3cgZTtcbiAgfSBmaW5hbGx5IHtcbiAgICBzZXJ2aWNlLmNsb3NlKCk7XG4gIH1cbn1cblxuLyoqXG4gKiBSZW1vdmUgdGhlIGZpbGUgb3IgZm9sZGVyIGZyb20gdGhlIGRldmljZVxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBkZXZpY2UgLSBUaGUgZGV2aWNlIG9iamVjdCwgd2hpY2ggcmVwcmVzZW50cyB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgVGhpcyBvYmplY3QgaXMgZXhwZWN0ZWQgdG8gaGF2ZSB0aGUgYHVkaWRgIHByb3BlcnR5IGNvbnRhaW5pbmcgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWQgZGV2aWNlIElELlxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgcGF0aCB0byBhIGZpbGUgb3IgYSBmb2xkZXIsIHdoaWNoIGV4aXN0cyBpbiB0aGUgY29ycmVzcG9uZGluZyBhcHBsaWNhdGlvblxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXIgb24gU2ltdWxhdG9yLiBVc2VcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQDxhcHBfYnVuZGxlX2lkPjo8b3B0aW9uYWxfY29udGFpbmVyX3R5cGU+LzxwYXRoX3RvX3RoZV9maWxlX29yX2ZvbGRlcl9pbnNpZGVfY29udGFpbmVyPlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXQgdG8gcHVsbCBhIGZpbGUgb3IgYSBmb2xkZXIgZnJvbSBhbiBhcHBsaWNhdGlvbiBjb250YWluZXIgb2YgdGhlIGdpdmVuIHR5cGUuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBvc3NpYmxlIGNvbnRhaW5lciB0eXBlcyBhcmUgJ2FwcCcsICdkYXRhJywgJ2dyb3VwcycsICc8QSBzcGVjaWZpYyBBcHAgR3JvdXAgY29udGFpbmVyPicuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBkZWZhdWx0IHR5cGUgaXMgJ2FwcCcuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGRlbGV0ZUZyb21TaW11bGF0b3IgKGRldmljZSwgcmVtb3RlUGF0aCkge1xuICBsZXQgcGF0aE9uU2VydmVyO1xuICBpZiAoQ09OVEFJTkVSX1BBVEhfUEFUVEVSTi50ZXN0KHJlbW90ZVBhdGgpKSB7XG4gICAgY29uc3Qge2J1bmRsZUlkLCBwYXRoSW5Db250YWluZXI6IGRzdFBhdGh9ID0gYXdhaXQgcGFyc2VDb250YWluZXJQYXRoKHJlbW90ZVBhdGgsXG4gICAgICBhc3luYyAoYXBwQnVuZGxlLCBjb250YWluZXJUeXBlKSA9PiBhd2FpdCBnZXRBcHBDb250YWluZXIoZGV2aWNlLnVkaWQsIGFwcEJ1bmRsZSwgbnVsbCwgY29udGFpbmVyVHlwZSkpO1xuICAgIGxvZy5pbmZvKGBQYXJzZWQgYnVuZGxlIGlkZW50aWZpZXIgJyR7YnVuZGxlSWR9JyBmcm9tICcke3JlbW90ZVBhdGh9Jy4gYCArXG4gICAgICBgJyR7ZHN0UGF0aH0nIHdpbGwgYmUgZGVsZXRlZGApO1xuICAgIHBhdGhPblNlcnZlciA9IGRzdFBhdGg7XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgc2ltUm9vdCA9IGRldmljZS5nZXREaXIoKTtcbiAgICBwYXRoT25TZXJ2ZXIgPSBwYXRoLnBvc2l4LmpvaW4oc2ltUm9vdCwgcmVtb3RlUGF0aCk7XG4gICAgdmVyaWZ5SXNTdWJQYXRoKHBhdGhPblNlcnZlciwgc2ltUm9vdCk7XG4gICAgbG9nLmluZm8oYEdvdCB0aGUgZnVsbCBwYXRoOiAke3BhdGhPblNlcnZlcn1gKTtcbiAgfVxuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhwYXRoT25TZXJ2ZXIpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSByZW1vdGUgcGF0aCBhdCAnJHtwYXRoT25TZXJ2ZXJ9JyBkb2VzIG5vdCBleGlzdGApO1xuICB9XG4gIGF3YWl0IGZzLnJpbXJhZihwYXRoT25TZXJ2ZXIpO1xufVxuXG4vKipcbiAqIFJlbW92ZSB0aGUgZmlsZSBvciBmb2xkZXIgZnJvbSB0aGUgZGV2aWNlXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IGRldmljZSAtIFRoZSBkZXZpY2Ugb2JqZWN0LCB3aGljaCByZXByZXNlbnRzIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBUaGlzIG9iamVjdCBpcyBleHBlY3RlZCB0byBoYXZlIHRoZSBgdWRpZGAgcHJvcGVydHkgY29udGFpbmluZyB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZCBkZXZpY2UgSUQuXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIGFuIGV4aXN0aW5nIHJlbW90ZSBmaWxlIG9uIHRoZSBkZXZpY2UuIFRoaXMgdmFyaWFibGUgY2FuIGJlIHByZWZpeGVkIHdpdGhcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVuZGxlIGlkLCBzbyB0aGVuIHRoZSBmaWxlIHdpbGwgYmUgZG93bmxvYWRlZCBmcm9tIHRoZSBjb3JyZXNwb25kaW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uIGNvbnRhaW5lciBpbnN0ZWFkIG9mIHRoZSBkZWZhdWx0IG1lZGlhIGZvbGRlci4gVXNlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEA8YXBwX2J1bmRsZV9pZD46PG9wdGlvbmFsX2NvbnRhaW5lcl90eXBlPi88cGF0aF90b190aGVfZmlsZV9vcl9mb2xkZXJfaW5zaWRlX2NvbnRhaW5lcj5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0IHRvIHB1bGwgYSBmaWxlIG9yIGEgZm9sZGVyIGZyb20gYW4gYXBwbGljYXRpb24gY29udGFpbmVyIG9mIHRoZSBnaXZlbiB0eXBlLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgb25seSBzdXBwb3J0ZWQgY29udGFpbmVyIHR5cGUgaXMgJ2RvY3VtZW50cycuIElmIHRoZSBjb250YWluZXIgdHlwZSBpcyBub3Qgc2V0XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGxpY2l0bHkgZm9yIGEgYnVuZGxlIGlkLCB0aGVuIHRoZSBkZWZhdWx0IGFwcGxpY2F0aW9uIGNvbnRhaW5lciBpcyBnb2luZyB0byBiZSBtb3VudGVkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChha2EgLS1jb250YWluZXIgaWZ1c2UgYXJndW1lbnQpXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUuZy4gSWYgYEBjb20ubXlhcHAuYmxhOmRvY3VtZW50cy8xMTEucG5nYCBpcyBwcm92aWRlZCxcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgT24gTXkgaVBob25lLzxhcHAgbmFtZT5gIGluIEZpbGVzIGFwcCB3aWxsIGJlIG1vdW50ZWQgaW4gdGhlIGhvc3QgbWFjaGluZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgT24gTXkgaVBob25lLzxhcHAgbmFtZT4vMTExLnBuZ2Agd2lsIGJlIHB1bGxlZCBpbnRvIHRoZSBtb3VudGVkIGhvc3QgbWFjaGluZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZCBBcHBpdW0gcmV0dXJucyB0aGUgZGF0YSBhcyBiYXNlNjQtZW5jb2RlZCBzdHJpbmcgdG8gY2xpZW50LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBAY29tLm15YXBwLmJsYTpkb2N1bWVudHMvYCBtZWFucyBgT24gTXkgaVBob25lLzxhcHAgbmFtZT5gLlxuICovXG5hc3luYyBmdW5jdGlvbiBkZWxldGVGcm9tUmVhbERldmljZSAoZGV2aWNlLCByZW1vdGVQYXRoKSB7XG4gIGNvbnN0IHsgc2VydmljZSwgcmVsYXRpdmVQYXRoIH0gPSBhd2FpdCBjcmVhdGVTZXJ2aWNlKGRldmljZS51ZGlkLCByZW1vdGVQYXRoKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBzZXJ2aWNlLmRlbGV0ZURpcmVjdG9yeShyZWxhdGl2ZVBhdGgpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGUubWVzc2FnZS5pbmNsdWRlcyhPQkpFQ1RfTk9UX0ZPVU5EX0VSUk9SX01FU1NBR0UpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFBhdGggJyR7cmVtb3RlUGF0aH0nIGRvZXMgbm90IGV4aXN0IG9uIHRoZSBkZXZpY2VgKTtcbiAgICB9XG4gICAgdGhyb3cgZTtcbiAgfSBmaW5hbGx5IHtcbiAgICBzZXJ2aWNlLmNsb3NlKCk7XG4gIH1cbn1cblxuLyoqXG4gKiBHZXQgYnVuZGxlSWRzIHdoaWNoIGNhbiBtb3VudCBieSBgLS1kb2N1bWVudHNgIGZsYWdcbiAqXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IHVkaWQgLSBUaGUgdWRpZCBvZiB0aGUgdGFyZ2V0IGRldmljZVxuICogQHJldHVybnMge0FycmF5PHN0cmluZz59IEEgbGlzdCBvZiBVc2VyIGxldmVsIGFwcHMnIGJ1bmRsZSBpZHMgd2hpY2ggaGFzXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgJ1VJRmlsZVNoYXJpbmdFbmFibGVkJyBhdHRyaWJ1dGUuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgT25seSB1c2VyIGFwcHMgbWlnaHQgaGF2ZSBpdC5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gZ2V0QXZhaWxhYmxlQnVuZGxlSWRzICh1ZGlkKSB7XG4gIGNvbnN0IHNlcnZpY2UgPSBhd2FpdCBzZXJ2aWNlcy5zdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSh1ZGlkKTtcbiAgdHJ5IHtcbiAgICBjb25zdCBhcHBsaWNhdGlvbnMgPSBhd2FpdCBzZXJ2aWNlLmxpc3RBcHBsaWNhdGlvbnMoe2FwcGxpY2F0aW9uVHlwZTogJ1VzZXInfSk7XG4gICAgY29uc3QgYnVuZGxlSWRzID0gW107XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoYXBwbGljYXRpb25zKSkge1xuICAgICAgaWYgKCF2YWx1ZS5VSUZpbGVTaGFyaW5nRW5hYmxlZCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGJ1bmRsZUlkcy5wdXNoKGtleSk7XG4gICAgfVxuICAgIHJldHVybiBidW5kbGVJZHM7XG4gIH0gZmluYWxseSB7XG4gICAgc2VydmljZS5jbG9zZSgpO1xuICB9XG59XG5cblxuY29tbWFuZHMucHVzaEZpbGUgPSBhc3luYyBmdW5jdGlvbiBwdXNoRmlsZSAocmVtb3RlUGF0aCwgYmFzZTY0RGF0YSkge1xuICBpZiAocmVtb3RlUGF0aC5lbmRzV2l0aCgnLycpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEl0IGlzIGV4cGVjdGVkIHRoYXQgcmVtb3RlIHBhdGggcG9pbnRzIHRvIGEgZmlsZSBhbmQgbm90IHRvIGEgZm9sZGVyLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgJyR7cmVtb3RlUGF0aH0nIGlzIGdpdmVuIGluc3RlYWRgKTtcbiAgfVxuICBpZiAoXy5pc0FycmF5KGJhc2U2NERhdGEpKSB7XG4gICAgLy8gc29tZSBjbGllbnRzIChhaGVtKSBqYXZhLCBzZW5kIGEgYnl0ZSBhcnJheSBlbmNvZGluZyB1dGY4IGNoYXJhY3RlcnNcbiAgICAvLyBpbnN0ZWFkIG9mIGEgc3RyaW5nLCB3aGljaCB3b3VsZCBiZSBpbmZpbml0ZWx5IGJldHRlciFcbiAgICBiYXNlNjREYXRhID0gQnVmZmVyLmZyb20oYmFzZTY0RGF0YSkudG9TdHJpbmcoJ3V0ZjgnKTtcbiAgfVxuICByZXR1cm4gdGhpcy5pc1NpbXVsYXRvcigpXG4gICAgPyBhd2FpdCBwdXNoRmlsZVRvU2ltdWxhdG9yKHRoaXMub3B0cy5kZXZpY2UsIHJlbW90ZVBhdGgsIGJhc2U2NERhdGEpXG4gICAgOiBhd2FpdCBwdXNoRmlsZVRvUmVhbERldmljZSh0aGlzLm9wdHMuZGV2aWNlLCByZW1vdGVQYXRoLCBiYXNlNjREYXRhKTtcbn07XG5cbmNvbW1hbmRzLnB1bGxGaWxlID0gYXN5bmMgZnVuY3Rpb24gcHVsbEZpbGUgKHJlbW90ZVBhdGgpIHtcbiAgaWYgKHJlbW90ZVBhdGguZW5kc1dpdGgoJy8nKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBJdCBpcyBleHBlY3RlZCB0aGF0IHJlbW90ZSBwYXRoIHBvaW50cyB0byBhIGZpbGUgYW5kIG5vdCB0byBhIGZvbGRlci4gYCArXG4gICAgICAgICAgICAgICAgICAgICAgYCcke3JlbW90ZVBhdGh9JyBpcyBnaXZlbiBpbnN0ZWFkYCk7XG4gIH1cbiAgcmV0dXJuIHRoaXMuaXNTaW11bGF0b3IoKVxuICAgID8gYXdhaXQgcHVsbEZyb21TaW11bGF0b3IodGhpcy5vcHRzLmRldmljZSwgcmVtb3RlUGF0aCwgdHJ1ZSlcbiAgICA6IGF3YWl0IHB1bGxGcm9tUmVhbERldmljZSh0aGlzLm9wdHMuZGV2aWNlLCByZW1vdGVQYXRoLCB0cnVlKTtcbn07XG5cbmFzeW5jIGZ1bmN0aW9uIGRlbGV0ZUZpbGVPckZvbGRlciAoZGV2aWNlLCByZW1vdGVQYXRoLCBpc1NpbXVsYXRvcikge1xuICByZXR1cm4gaXNTaW11bGF0b3JcbiAgICA/IGF3YWl0IGRlbGV0ZUZyb21TaW11bGF0b3IoZGV2aWNlLCByZW1vdGVQYXRoKVxuICAgIDogYXdhaXQgZGVsZXRlRnJvbVJlYWxEZXZpY2UoZGV2aWNlLCByZW1vdGVQYXRoKTtcbn1cblxuY29tbWFuZHMubW9iaWxlRGVsZXRlRm9sZGVyID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlRGVsZXRlRm9sZGVyIChvcHRzID0ge30pIHtcbiAgbGV0IHtyZW1vdGVQYXRofSA9IG9wdHM7XG4gIGlmICghcmVtb3RlUGF0aC5lbmRzV2l0aCgnLycpKSB7XG4gICAgcmVtb3RlUGF0aCA9IGAke3JlbW90ZVBhdGh9L2A7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IGRlbGV0ZUZpbGVPckZvbGRlcih0aGlzLm9wdHMuZGV2aWNlLCByZW1vdGVQYXRoLCB0aGlzLmlzU2ltdWxhdG9yKCkpO1xufTtcblxuY29tbWFuZHMubW9iaWxlRGVsZXRlRmlsZSA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZURlbGV0ZUZpbGUgKG9wdHMgPSB7fSkge1xuICBjb25zdCB7cmVtb3RlUGF0aH0gPSBvcHRzO1xuICBpZiAocmVtb3RlUGF0aC5lbmRzV2l0aCgnLycpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEl0IGlzIGV4cGVjdGVkIHRoYXQgcmVtb3RlIHBhdGggcG9pbnRzIHRvIGEgZmlsZSBhbmQgbm90IHRvIGEgZm9sZGVyLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgJyR7cmVtb3RlUGF0aH0nIGlzIGdpdmVuIGluc3RlYWRgKTtcbiAgfVxuICByZXR1cm4gYXdhaXQgZGVsZXRlRmlsZU9yRm9sZGVyKHRoaXMub3B0cy5kZXZpY2UsIHJlbW90ZVBhdGgsIHRoaXMuaXNTaW11bGF0b3IoKSk7XG59O1xuXG5jb21tYW5kcy5nZXRTaW1GaWxlRnVsbFBhdGggPSBhc3luYyBmdW5jdGlvbiBnZXRTaW1GaWxlRnVsbFBhdGggKHJlbW90ZVBhdGgpIHtcbiAgbGV0IGJhc2VQYXRoID0gdGhpcy5vcHRzLmRldmljZS5nZXREaXIoKTtcbiAgbGV0IGFwcE5hbWUgPSBudWxsO1xuXG4gIGlmICh0aGlzLm9wdHMuYXBwKSB7XG4gICAgbGV0IGFwcE5hbWVSZWdleCA9IG5ldyBSZWdFeHAoYFxcXFwke3BhdGguc2VwfShbXFxcXHctXStcXFxcLmFwcClgKTtcbiAgICBsZXQgYXBwTmFtZU1hdGNoZXMgPSBhcHBOYW1lUmVnZXguZXhlYyh0aGlzLm9wdHMuYXBwKTtcbiAgICBpZiAoYXBwTmFtZU1hdGNoZXMpIHtcbiAgICAgIGFwcE5hbWUgPSBhcHBOYW1lTWF0Y2hlc1sxXTtcbiAgICB9XG4gIH1cbiAgLy8gZGUtYWJzb2x1dGl6ZSB0aGUgcGF0aFxuICBpZiAoc3lzdGVtLmlzV2luZG93cygpKSB7XG4gICAgaWYgKHJlbW90ZVBhdGguaW5kZXhvZignOi8vJykgPT09IDEpIHtcbiAgICAgIHJlbW90ZVBhdGggPSByZW1vdGVQYXRoLnNsaWNlKDQpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZiAocmVtb3RlUGF0aC5pbmRleE9mKCcvJykgPT09IDApIHtcbiAgICAgIHJlbW90ZVBhdGggPSByZW1vdGVQYXRoLnNsaWNlKDEpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChyZW1vdGVQYXRoLnN0YXJ0c1dpdGgoYXBwTmFtZSkpIHtcbiAgICBsZXQgZmluZFBhdGggPSBiYXNlUGF0aDtcbiAgICBpZiAoIXRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24gfHwgdXRpbC5jb21wYXJlVmVyc2lvbnModGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbiwgJz49JywgJzguMCcpKSB7XG4gICAgICAvLyB0aGUgLmFwcCBmaWxlIGFwcGVhcnMgaW4gL0NvbnRhaW5lcnMvRGF0YSBhbmQgL0NvbnRhaW5lcnMvQnVuZGxlIGJvdGguIFdlIG9ubHkgd2FudCAvQnVuZGxlXG4gICAgICBmaW5kUGF0aCA9IHBhdGgucmVzb2x2ZShiYXNlUGF0aCwgJ0NvbnRhaW5lcnMnLCAnQnVuZGxlJyk7XG4gICAgfVxuICAgIGZpbmRQYXRoID0gZmluZFBhdGgucmVwbGFjZSgvXFxzL2csICdcXFxcICcpO1xuXG4gICAgbGV0IHsgc3Rkb3V0IH0gPSBhd2FpdCBleGVjKCdmaW5kJywgW2ZpbmRQYXRoLCAnLW5hbWUnLCBhcHBOYW1lXSk7XG4gICAgbGV0IGFwcFJvb3QgPSBzdGRvdXQucmVwbGFjZSgvXFxuJC8sICcnKTtcbiAgICBsZXQgc3ViUGF0aCA9IHJlbW90ZVBhdGguc3Vic3RyaW5nKGFwcE5hbWUubGVuZ3RoICsgMSk7XG4gICAgbGV0IGZ1bGxQYXRoID0gcGF0aC5yZXNvbHZlKGFwcFJvb3QsIHN1YlBhdGgpO1xuICAgIGxvZy5kZWJ1ZyhgRmluZGluZyBhcHAtcmVsYXRpdmUgZmlsZTogJyR7ZnVsbFBhdGh9J2ApO1xuICAgIHJldHVybiBmdWxsUGF0aDtcbiAgfVxuXG4gIGxldCBmdWxsUGF0aCA9IHBhdGgucmVzb2x2ZShiYXNlUGF0aCwgcmVtb3RlUGF0aCk7XG4gIGxvZy5kZWJ1ZyhgRmluZGluZyBzaW0tcmVsYXRpdmUgZmlsZTogJHtmdWxsUGF0aH1gKTtcbiAgcmV0dXJuIGZ1bGxQYXRoO1xufTtcblxuY29tbWFuZHMucHVsbEZvbGRlciA9IGFzeW5jIGZ1bmN0aW9uIHB1bGxGb2xkZXIgKHJlbW90ZVBhdGgpIHtcbiAgaWYgKCFyZW1vdGVQYXRoLmVuZHNXaXRoKCcvJykpIHtcbiAgICByZW1vdGVQYXRoID0gYCR7cmVtb3RlUGF0aH0vYDtcbiAgfVxuICByZXR1cm4gdGhpcy5pc1NpbXVsYXRvcigpXG4gICAgPyBhd2FpdCBwdWxsRnJvbVNpbXVsYXRvcih0aGlzLm9wdHMuZGV2aWNlLCByZW1vdGVQYXRoLCBmYWxzZSlcbiAgICA6IGF3YWl0IHB1bGxGcm9tUmVhbERldmljZSh0aGlzLm9wdHMuZGV2aWNlLCByZW1vdGVQYXRoLCBmYWxzZSk7XG59O1xuXG5leHBvcnQgeyBjb21tYW5kcywgLyogZm9yIHRlc3RpbmcgKi8gZ2V0QXZhaWxhYmxlQnVuZGxlSWRzLFxuICAvKiBmb3IgdGVzdGluZyAqLyBwYXJzZUNvbnRhaW5lclBhdGggfTtcbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvZmlsZS1tb3ZlbWVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
