"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

commands.getAlertText = async function getAlertText() {
  try {
    return await this.proxyCommand('/alert/text', 'GET');
  } catch (err) {
    if (this.isWebContext()) {
      const alert = await this.getAlert();
      return await alert.getText();
    }

    throw err;
  }
};

commands.setAlertText = async function setAlertText(value) {
  if (_lodash.default.isString(value)) {
    value = value.split('');
  }

  try {
    return await this.proxyCommand('/alert/text', 'POST', {
      value
    });
  } catch (err) {
    if (this.isWebContext()) {
      const alert = await this.getAlert();
      return await alert.setText(value);
    }

    throw err;
  }
};

commands.postAcceptAlert = async function postAcceptAlert(opts = {}) {
  try {
    let params = {};

    if (opts.buttonLabel) {
      params.name = opts.buttonLabel;
    }

    return await this.proxyCommand('/alert/accept', 'POST', params);
  } catch (err) {
    if (!this.isWebContext()) {
      throw new _appiumBaseDriver.errors.NoAlertOpenError();
    }

    let alert = await this.getAlert();

    if (alert.close) {
      return await alert.close();
    }

    await alert.ok();
  }
};

commands.postDismissAlert = async function postDismissAlert(opts = {}) {
  try {
    let params = {};

    if (opts.buttonLabel) {
      params.name = opts.buttonLabel;
    }

    return await this.proxyCommand('/alert/dismiss', 'POST', params);
  } catch (err) {
    if (!this.isWebContext()) {
      throw new _appiumBaseDriver.errors.NoAlertOpenError();
    }

    let alert = await this.getAlert();

    if (alert.close) {
      return await alert.close();
    }

    await alert.cancel();
  }
};

commands.getAlertButtons = async function getAlertButtons() {
  try {
    return await this.proxyCommand('/wda/alert/buttons', 'GET');
  } catch (err) {
    throw new _appiumBaseDriver.errors.NoAlertOpenError();
  }
};

commands.mobileHandleAlert = async function mobileHandleAlert(opts = {}) {
  switch (opts.action) {
    case 'accept':
      return await this.postAcceptAlert(opts);

    case 'dismiss':
      return await this.postDismissAlert(opts);

    case 'getButtons':
      return await this.getAlertButtons();

    default:
      throw new Error(`The 'action' value should be either 'accept', 'dismiss' or 'getButtons'. ` + `'${opts.action}' is provided instead.`);
  }
};

helpers.getAlert = async function getAlert() {
  const possibleAlert = await this.findNativeElementOrElements('class name', 'XCUIElementTypeScrollView', true);

  if (possibleAlert.length !== 1) {
    throw new _appiumBaseDriver.errors.NoAlertOpenError();
  }

  const possibleAlertButtons = await this.findNativeElementOrElements('class name', 'XCUIElementTypeButton', true, _appiumSupport.util.unwrapElement(possibleAlert[0]));

  if (possibleAlertButtons.length < 1 || possibleAlertButtons.length > 2) {
    throw new _appiumBaseDriver.errors.NoAlertOpenError();
  }

  const assertButtonName = async (button, expectedName) => {
    button = _appiumSupport.util.unwrapElement(button);
    const name = await this.proxyCommand(`/element/${button}/attribute/name`, 'GET');

    if (_lodash.default.isNil(name) || name.toLowerCase() !== expectedName) {
      throw new _appiumBaseDriver.errors.NoAlertOpenError();
    }
  };

  const alert = possibleAlert[0];

  if (possibleAlertButtons.length === 1) {
    const closeButton = possibleAlertButtons[0];
    await assertButtonName(closeButton, 'close');

    alert.close = async () => {
      await this.proxyCommand(`/element/${_appiumSupport.util.unwrapElement(closeButton)}/click`, 'POST');
    };
  } else {
    const cancelButton = possibleAlertButtons[0];
    await assertButtonName(cancelButton, 'cancel');
    const okButton = possibleAlertButtons[1];
    await assertButtonName(okButton, 'ok');

    alert.cancel = async () => {
      await this.proxyCommand(`/element/${_appiumSupport.util.unwrapElement(cancelButton)}/click`, 'POST');
    };

    alert.ok = async () => {
      await this.proxyCommand(`/element/${_appiumSupport.util.unwrapElement(okButton)}/click`, 'POST');
    };
  }

  alert.getText = async () => {
    let textView = await this.findNativeElementOrElements('class name', 'XCUIElementTypeTextView', false, _appiumSupport.util.unwrapElement(alert));
    return await this.proxyCommand(`/element/${_appiumSupport.util.unwrapElement(textView)}/attribute/value`, 'GET');
  };

  alert.setText = async value => {
    try {
      let textView = await this.findNativeElementOrElements('class name', 'XCUIElementTypeTextField', false, _appiumSupport.util.unwrapElement(alert));
      await this.proxyCommand(`/element/${_appiumSupport.util.unwrapElement(textView)}/value `, 'POST', {
        value
      });
    } catch (err) {
      if ((0, _appiumBaseDriver.isErrorType)(err, _appiumBaseDriver.errors.NoSuchElementError)) {
        throw new Error('Tried to set text of an alert that was not a prompt');
      }

      throw err;
    }
  };

  return alert;
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9hbGVydC5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsImhlbHBlcnMiLCJleHRlbnNpb25zIiwiZ2V0QWxlcnRUZXh0IiwicHJveHlDb21tYW5kIiwiZXJyIiwiaXNXZWJDb250ZXh0IiwiYWxlcnQiLCJnZXRBbGVydCIsImdldFRleHQiLCJzZXRBbGVydFRleHQiLCJ2YWx1ZSIsIl8iLCJpc1N0cmluZyIsInNwbGl0Iiwic2V0VGV4dCIsInBvc3RBY2NlcHRBbGVydCIsIm9wdHMiLCJwYXJhbXMiLCJidXR0b25MYWJlbCIsIm5hbWUiLCJlcnJvcnMiLCJOb0FsZXJ0T3BlbkVycm9yIiwiY2xvc2UiLCJvayIsInBvc3REaXNtaXNzQWxlcnQiLCJjYW5jZWwiLCJnZXRBbGVydEJ1dHRvbnMiLCJtb2JpbGVIYW5kbGVBbGVydCIsImFjdGlvbiIsIkVycm9yIiwicG9zc2libGVBbGVydCIsImZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyIsImxlbmd0aCIsInBvc3NpYmxlQWxlcnRCdXR0b25zIiwidXRpbCIsInVud3JhcEVsZW1lbnQiLCJhc3NlcnRCdXR0b25OYW1lIiwiYnV0dG9uIiwiZXhwZWN0ZWROYW1lIiwiaXNOaWwiLCJ0b0xvd2VyQ2FzZSIsImNsb3NlQnV0dG9uIiwiY2FuY2VsQnV0dG9uIiwib2tCdXR0b24iLCJ0ZXh0VmlldyIsIk5vU3VjaEVsZW1lbnRFcnJvciIsIk9iamVjdCIsImFzc2lnbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFJQSxRQUFRLEdBQUcsRUFBZjtBQUFBLElBQW1CQyxPQUFPLEdBQUcsRUFBN0I7QUFBQSxJQUFpQ0MsVUFBVSxHQUFHLEVBQTlDOzs7O0FBRUFGLFFBQVEsQ0FBQ0csWUFBVCxHQUF3QixlQUFlQSxZQUFmLEdBQStCO0FBQ3JELE1BQUk7QUFDRixXQUFPLE1BQU0sS0FBS0MsWUFBTCxDQUFrQixhQUFsQixFQUFpQyxLQUFqQyxDQUFiO0FBQ0QsR0FGRCxDQUVFLE9BQU9DLEdBQVAsRUFBWTtBQUNaLFFBQUksS0FBS0MsWUFBTCxFQUFKLEVBQXlCO0FBQ3ZCLFlBQU1DLEtBQUssR0FBRyxNQUFNLEtBQUtDLFFBQUwsRUFBcEI7QUFDQSxhQUFPLE1BQU1ELEtBQUssQ0FBQ0UsT0FBTixFQUFiO0FBQ0Q7O0FBQ0QsVUFBTUosR0FBTjtBQUNEO0FBQ0YsQ0FWRDs7QUFZQUwsUUFBUSxDQUFDVSxZQUFULEdBQXdCLGVBQWVBLFlBQWYsQ0FBNkJDLEtBQTdCLEVBQW9DO0FBQzFELE1BQUlDLGdCQUFFQyxRQUFGLENBQVdGLEtBQVgsQ0FBSixFQUF1QjtBQUNyQkEsSUFBQUEsS0FBSyxHQUFHQSxLQUFLLENBQUNHLEtBQU4sQ0FBWSxFQUFaLENBQVI7QUFDRDs7QUFDRCxNQUFJO0FBQ0YsV0FBTyxNQUFNLEtBQUtWLFlBQUwsQ0FBa0IsYUFBbEIsRUFBaUMsTUFBakMsRUFBeUM7QUFBQ08sTUFBQUE7QUFBRCxLQUF6QyxDQUFiO0FBQ0QsR0FGRCxDQUVFLE9BQU9OLEdBQVAsRUFBWTtBQUNaLFFBQUksS0FBS0MsWUFBTCxFQUFKLEVBQXlCO0FBQ3ZCLFlBQU1DLEtBQUssR0FBRyxNQUFNLEtBQUtDLFFBQUwsRUFBcEI7QUFDQSxhQUFPLE1BQU1ELEtBQUssQ0FBQ1EsT0FBTixDQUFjSixLQUFkLENBQWI7QUFDRDs7QUFDRCxVQUFNTixHQUFOO0FBQ0Q7QUFDRixDQWJEOztBQWVBTCxRQUFRLENBQUNnQixlQUFULEdBQTJCLGVBQWVBLGVBQWYsQ0FBZ0NDLElBQUksR0FBRyxFQUF2QyxFQUEyQztBQUNwRSxNQUFJO0FBQ0YsUUFBSUMsTUFBTSxHQUFHLEVBQWI7O0FBQ0EsUUFBSUQsSUFBSSxDQUFDRSxXQUFULEVBQXNCO0FBQ3BCRCxNQUFBQSxNQUFNLENBQUNFLElBQVAsR0FBY0gsSUFBSSxDQUFDRSxXQUFuQjtBQUNEOztBQUNELFdBQU8sTUFBTSxLQUFLZixZQUFMLENBQWtCLGVBQWxCLEVBQW1DLE1BQW5DLEVBQTJDYyxNQUEzQyxDQUFiO0FBQ0QsR0FORCxDQU1FLE9BQU9iLEdBQVAsRUFBWTtBQUNaLFFBQUksQ0FBQyxLQUFLQyxZQUFMLEVBQUwsRUFBMEI7QUFDeEIsWUFBTSxJQUFJZSx5QkFBT0MsZ0JBQVgsRUFBTjtBQUNEOztBQUVELFFBQUlmLEtBQUssR0FBRyxNQUFNLEtBQUtDLFFBQUwsRUFBbEI7O0FBQ0EsUUFBSUQsS0FBSyxDQUFDZ0IsS0FBVixFQUFpQjtBQUNmLGFBQU8sTUFBTWhCLEtBQUssQ0FBQ2dCLEtBQU4sRUFBYjtBQUNEOztBQUNELFVBQU1oQixLQUFLLENBQUNpQixFQUFOLEVBQU47QUFDRDtBQUNGLENBbEJEOztBQW9CQXhCLFFBQVEsQ0FBQ3lCLGdCQUFULEdBQTRCLGVBQWVBLGdCQUFmLENBQWlDUixJQUFJLEdBQUcsRUFBeEMsRUFBNEM7QUFDdEUsTUFBSTtBQUNGLFFBQUlDLE1BQU0sR0FBRyxFQUFiOztBQUNBLFFBQUlELElBQUksQ0FBQ0UsV0FBVCxFQUFzQjtBQUNwQkQsTUFBQUEsTUFBTSxDQUFDRSxJQUFQLEdBQWNILElBQUksQ0FBQ0UsV0FBbkI7QUFDRDs7QUFDRCxXQUFPLE1BQU0sS0FBS2YsWUFBTCxDQUFrQixnQkFBbEIsRUFBb0MsTUFBcEMsRUFBNENjLE1BQTVDLENBQWI7QUFDRCxHQU5ELENBTUUsT0FBT2IsR0FBUCxFQUFZO0FBQ1osUUFBSSxDQUFDLEtBQUtDLFlBQUwsRUFBTCxFQUEwQjtBQUN4QixZQUFNLElBQUllLHlCQUFPQyxnQkFBWCxFQUFOO0FBQ0Q7O0FBRUQsUUFBSWYsS0FBSyxHQUFHLE1BQU0sS0FBS0MsUUFBTCxFQUFsQjs7QUFDQSxRQUFJRCxLQUFLLENBQUNnQixLQUFWLEVBQWlCO0FBQ2YsYUFBTyxNQUFNaEIsS0FBSyxDQUFDZ0IsS0FBTixFQUFiO0FBQ0Q7O0FBQ0QsVUFBTWhCLEtBQUssQ0FBQ21CLE1BQU4sRUFBTjtBQUNEO0FBQ0YsQ0FsQkQ7O0FBb0JBMUIsUUFBUSxDQUFDMkIsZUFBVCxHQUEyQixlQUFlQSxlQUFmLEdBQWtDO0FBQzNELE1BQUk7QUFDRixXQUFPLE1BQU0sS0FBS3ZCLFlBQUwsQ0FBa0Isb0JBQWxCLEVBQXdDLEtBQXhDLENBQWI7QUFDRCxHQUZELENBRUUsT0FBT0MsR0FBUCxFQUFZO0FBQ1osVUFBTSxJQUFJZ0IseUJBQU9DLGdCQUFYLEVBQU47QUFDRDtBQUNGLENBTkQ7O0FBUUF0QixRQUFRLENBQUM0QixpQkFBVCxHQUE2QixlQUFlQSxpQkFBZixDQUFrQ1gsSUFBSSxHQUFHLEVBQXpDLEVBQTZDO0FBQ3hFLFVBQVFBLElBQUksQ0FBQ1ksTUFBYjtBQUNFLFNBQUssUUFBTDtBQUNFLGFBQU8sTUFBTSxLQUFLYixlQUFMLENBQXFCQyxJQUFyQixDQUFiOztBQUNGLFNBQUssU0FBTDtBQUNFLGFBQU8sTUFBTSxLQUFLUSxnQkFBTCxDQUFzQlIsSUFBdEIsQ0FBYjs7QUFDRixTQUFLLFlBQUw7QUFDRSxhQUFPLE1BQU0sS0FBS1UsZUFBTCxFQUFiOztBQUNGO0FBQ0UsWUFBTSxJQUFJRyxLQUFKLENBQVcsMkVBQUQsR0FDQyxJQUFHYixJQUFJLENBQUNZLE1BQU8sd0JBRDFCLENBQU47QUFSSjtBQVdELENBWkQ7O0FBY0E1QixPQUFPLENBQUNPLFFBQVIsR0FBbUIsZUFBZUEsUUFBZixHQUEyQjtBQUM1QyxRQUFNdUIsYUFBYSxHQUFHLE1BQU0sS0FBS0MsMkJBQUwsQ0FBaUMsWUFBakMsRUFDMUIsMkJBRDBCLEVBQ0csSUFESCxDQUE1Qjs7QUFFQSxNQUFJRCxhQUFhLENBQUNFLE1BQWQsS0FBeUIsQ0FBN0IsRUFBZ0M7QUFDOUIsVUFBTSxJQUFJWix5QkFBT0MsZ0JBQVgsRUFBTjtBQUNEOztBQUVELFFBQU1ZLG9CQUFvQixHQUFHLE1BQU0sS0FBS0YsMkJBQUwsQ0FBaUMsWUFBakMsRUFDakMsdUJBRGlDLEVBQ1IsSUFEUSxFQUNGRyxvQkFBS0MsYUFBTCxDQUFtQkwsYUFBYSxDQUFDLENBQUQsQ0FBaEMsQ0FERSxDQUFuQzs7QUFFQSxNQUFJRyxvQkFBb0IsQ0FBQ0QsTUFBckIsR0FBOEIsQ0FBOUIsSUFBbUNDLG9CQUFvQixDQUFDRCxNQUFyQixHQUE4QixDQUFyRSxFQUF3RTtBQUN0RSxVQUFNLElBQUlaLHlCQUFPQyxnQkFBWCxFQUFOO0FBQ0Q7O0FBRUQsUUFBTWUsZ0JBQWdCLEdBQUcsT0FBT0MsTUFBUCxFQUFlQyxZQUFmLEtBQWdDO0FBQ3ZERCxJQUFBQSxNQUFNLEdBQUdILG9CQUFLQyxhQUFMLENBQW1CRSxNQUFuQixDQUFUO0FBQ0EsVUFBTWxCLElBQUksR0FBRyxNQUFNLEtBQUtoQixZQUFMLENBQW1CLFlBQVdrQyxNQUFPLGlCQUFyQyxFQUF1RCxLQUF2RCxDQUFuQjs7QUFDQSxRQUFJMUIsZ0JBQUU0QixLQUFGLENBQVFwQixJQUFSLEtBQWlCQSxJQUFJLENBQUNxQixXQUFMLE9BQXVCRixZQUE1QyxFQUEwRDtBQUN4RCxZQUFNLElBQUlsQix5QkFBT0MsZ0JBQVgsRUFBTjtBQUNEO0FBQ0YsR0FORDs7QUFRQSxRQUFNZixLQUFLLEdBQUd3QixhQUFhLENBQUMsQ0FBRCxDQUEzQjs7QUFDQSxNQUFJRyxvQkFBb0IsQ0FBQ0QsTUFBckIsS0FBZ0MsQ0FBcEMsRUFBdUM7QUFFckMsVUFBTVMsV0FBVyxHQUFHUixvQkFBb0IsQ0FBQyxDQUFELENBQXhDO0FBQ0EsVUFBTUcsZ0JBQWdCLENBQUNLLFdBQUQsRUFBYyxPQUFkLENBQXRCOztBQUVBbkMsSUFBQUEsS0FBSyxDQUFDZ0IsS0FBTixHQUFjLFlBQVk7QUFDeEIsWUFBTSxLQUFLbkIsWUFBTCxDQUFtQixZQUFXK0Isb0JBQUtDLGFBQUwsQ0FBbUJNLFdBQW5CLENBQWdDLFFBQTlELEVBQXVFLE1BQXZFLENBQU47QUFDRCxLQUZEO0FBR0QsR0FSRCxNQVFPO0FBRUwsVUFBTUMsWUFBWSxHQUFHVCxvQkFBb0IsQ0FBQyxDQUFELENBQXpDO0FBQ0EsVUFBTUcsZ0JBQWdCLENBQUNNLFlBQUQsRUFBZSxRQUFmLENBQXRCO0FBQ0EsVUFBTUMsUUFBUSxHQUFHVixvQkFBb0IsQ0FBQyxDQUFELENBQXJDO0FBQ0EsVUFBTUcsZ0JBQWdCLENBQUNPLFFBQUQsRUFBVyxJQUFYLENBQXRCOztBQUVBckMsSUFBQUEsS0FBSyxDQUFDbUIsTUFBTixHQUFlLFlBQVk7QUFDekIsWUFBTSxLQUFLdEIsWUFBTCxDQUFtQixZQUFXK0Isb0JBQUtDLGFBQUwsQ0FBbUJPLFlBQW5CLENBQWlDLFFBQS9ELEVBQXdFLE1BQXhFLENBQU47QUFDRCxLQUZEOztBQUdBcEMsSUFBQUEsS0FBSyxDQUFDaUIsRUFBTixHQUFXLFlBQVk7QUFDckIsWUFBTSxLQUFLcEIsWUFBTCxDQUFtQixZQUFXK0Isb0JBQUtDLGFBQUwsQ0FBbUJRLFFBQW5CLENBQTZCLFFBQTNELEVBQW9FLE1BQXBFLENBQU47QUFDRCxLQUZEO0FBR0Q7O0FBRURyQyxFQUFBQSxLQUFLLENBQUNFLE9BQU4sR0FBZ0IsWUFBWTtBQUMxQixRQUFJb0MsUUFBUSxHQUFHLE1BQU0sS0FBS2IsMkJBQUwsQ0FBaUMsWUFBakMsRUFBK0MseUJBQS9DLEVBQTBFLEtBQTFFLEVBQWlGRyxvQkFBS0MsYUFBTCxDQUFtQjdCLEtBQW5CLENBQWpGLENBQXJCO0FBQ0EsV0FBTyxNQUFNLEtBQUtILFlBQUwsQ0FBbUIsWUFBVytCLG9CQUFLQyxhQUFMLENBQW1CUyxRQUFuQixDQUE2QixrQkFBM0QsRUFBOEUsS0FBOUUsQ0FBYjtBQUNELEdBSEQ7O0FBSUF0QyxFQUFBQSxLQUFLLENBQUNRLE9BQU4sR0FBZ0IsTUFBT0osS0FBUCxJQUFpQjtBQUMvQixRQUFJO0FBQ0YsVUFBSWtDLFFBQVEsR0FBRyxNQUFNLEtBQUtiLDJCQUFMLENBQWlDLFlBQWpDLEVBQStDLDBCQUEvQyxFQUEyRSxLQUEzRSxFQUFrRkcsb0JBQUtDLGFBQUwsQ0FBbUI3QixLQUFuQixDQUFsRixDQUFyQjtBQUNBLFlBQU0sS0FBS0gsWUFBTCxDQUFtQixZQUFXK0Isb0JBQUtDLGFBQUwsQ0FBbUJTLFFBQW5CLENBQTZCLFNBQTNELEVBQXFFLE1BQXJFLEVBQTZFO0FBQUNsQyxRQUFBQTtBQUFELE9BQTdFLENBQU47QUFDRCxLQUhELENBR0UsT0FBT04sR0FBUCxFQUFZO0FBQ1osVUFBSSxtQ0FBWUEsR0FBWixFQUFpQmdCLHlCQUFPeUIsa0JBQXhCLENBQUosRUFBaUQ7QUFDL0MsY0FBTSxJQUFJaEIsS0FBSixDQUFVLHFEQUFWLENBQU47QUFDRDs7QUFDRCxZQUFNekIsR0FBTjtBQUNEO0FBQ0YsR0FWRDs7QUFZQSxTQUFPRSxLQUFQO0FBQ0QsQ0E5REQ7O0FBaUVBd0MsTUFBTSxDQUFDQyxNQUFQLENBQWM5QyxVQUFkLEVBQTBCRixRQUExQixFQUFvQ0MsT0FBcEM7ZUFFZUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGVycm9ycywgaXNFcnJvclR5cGUgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29tbWFuZHMuZ2V0QWxlcnRUZXh0ID0gYXN5bmMgZnVuY3Rpb24gZ2V0QWxlcnRUZXh0ICgpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9hbGVydC90ZXh0JywgJ0dFVCcpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgICAgY29uc3QgYWxlcnQgPSBhd2FpdCB0aGlzLmdldEFsZXJ0KCk7XG4gICAgICByZXR1cm4gYXdhaXQgYWxlcnQuZ2V0VGV4dCgpO1xuICAgIH1cbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnNldEFsZXJ0VGV4dCA9IGFzeW5jIGZ1bmN0aW9uIHNldEFsZXJ0VGV4dCAodmFsdWUpIHtcbiAgaWYgKF8uaXNTdHJpbmcodmFsdWUpKSB7XG4gICAgdmFsdWUgPSB2YWx1ZS5zcGxpdCgnJyk7XG4gIH1cbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9hbGVydC90ZXh0JywgJ1BPU1QnLCB7dmFsdWV9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICAgIGNvbnN0IGFsZXJ0ID0gYXdhaXQgdGhpcy5nZXRBbGVydCgpO1xuICAgICAgcmV0dXJuIGF3YWl0IGFsZXJ0LnNldFRleHQodmFsdWUpO1xuICAgIH1cbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnBvc3RBY2NlcHRBbGVydCA9IGFzeW5jIGZ1bmN0aW9uIHBvc3RBY2NlcHRBbGVydCAob3B0cyA9IHt9KSB7XG4gIHRyeSB7XG4gICAgbGV0IHBhcmFtcyA9IHt9O1xuICAgIGlmIChvcHRzLmJ1dHRvbkxhYmVsKSB7XG4gICAgICBwYXJhbXMubmFtZSA9IG9wdHMuYnV0dG9uTGFiZWw7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL2FsZXJ0L2FjY2VwdCcsICdQT1NUJywgcGFyYW1zKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vQWxlcnRPcGVuRXJyb3IoKTtcbiAgICB9XG5cbiAgICBsZXQgYWxlcnQgPSBhd2FpdCB0aGlzLmdldEFsZXJ0KCk7XG4gICAgaWYgKGFsZXJ0LmNsb3NlKSB7XG4gICAgICByZXR1cm4gYXdhaXQgYWxlcnQuY2xvc2UoKTtcbiAgICB9XG4gICAgYXdhaXQgYWxlcnQub2soKTtcbiAgfVxufTtcblxuY29tbWFuZHMucG9zdERpc21pc3NBbGVydCA9IGFzeW5jIGZ1bmN0aW9uIHBvc3REaXNtaXNzQWxlcnQgKG9wdHMgPSB7fSkge1xuICB0cnkge1xuICAgIGxldCBwYXJhbXMgPSB7fTtcbiAgICBpZiAob3B0cy5idXR0b25MYWJlbCkge1xuICAgICAgcGFyYW1zLm5hbWUgPSBvcHRzLmJ1dHRvbkxhYmVsO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9hbGVydC9kaXNtaXNzJywgJ1BPU1QnLCBwYXJhbXMpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9BbGVydE9wZW5FcnJvcigpO1xuICAgIH1cblxuICAgIGxldCBhbGVydCA9IGF3YWl0IHRoaXMuZ2V0QWxlcnQoKTtcbiAgICBpZiAoYWxlcnQuY2xvc2UpIHtcbiAgICAgIHJldHVybiBhd2FpdCBhbGVydC5jbG9zZSgpO1xuICAgIH1cbiAgICBhd2FpdCBhbGVydC5jYW5jZWwoKTtcbiAgfVxufTtcblxuY29tbWFuZHMuZ2V0QWxlcnRCdXR0b25zID0gYXN5bmMgZnVuY3Rpb24gZ2V0QWxlcnRCdXR0b25zICgpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvYWxlcnQvYnV0dG9ucycsICdHRVQnKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob0FsZXJ0T3BlbkVycm9yKCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLm1vYmlsZUhhbmRsZUFsZXJ0ID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlSGFuZGxlQWxlcnQgKG9wdHMgPSB7fSkge1xuICBzd2l0Y2ggKG9wdHMuYWN0aW9uKSB7XG4gICAgY2FzZSAnYWNjZXB0JzpcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnBvc3RBY2NlcHRBbGVydChvcHRzKTtcbiAgICBjYXNlICdkaXNtaXNzJzpcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnBvc3REaXNtaXNzQWxlcnQob3B0cyk7XG4gICAgY2FzZSAnZ2V0QnV0dG9ucyc6XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRBbGVydEJ1dHRvbnMoKTtcbiAgICBkZWZhdWx0OlxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgJ2FjdGlvbicgdmFsdWUgc2hvdWxkIGJlIGVpdGhlciAnYWNjZXB0JywgJ2Rpc21pc3MnIG9yICdnZXRCdXR0b25zJy4gYCArXG4gICAgICAgICAgICAgICAgICAgICAgYCcke29wdHMuYWN0aW9ufScgaXMgcHJvdmlkZWQgaW5zdGVhZC5gKTtcbiAgfVxufTtcblxuaGVscGVycy5nZXRBbGVydCA9IGFzeW5jIGZ1bmN0aW9uIGdldEFsZXJ0ICgpIHtcbiAgY29uc3QgcG9zc2libGVBbGVydCA9IGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdjbGFzcyBuYW1lJyxcbiAgICAnWENVSUVsZW1lbnRUeXBlU2Nyb2xsVmlldycsIHRydWUpO1xuICBpZiAocG9zc2libGVBbGVydC5sZW5ndGggIT09IDEpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vQWxlcnRPcGVuRXJyb3IoKTtcbiAgfVxuXG4gIGNvbnN0IHBvc3NpYmxlQWxlcnRCdXR0b25zID0gYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2NsYXNzIG5hbWUnLFxuICAgICdYQ1VJRWxlbWVudFR5cGVCdXR0b24nLCB0cnVlLCB1dGlsLnVud3JhcEVsZW1lbnQocG9zc2libGVBbGVydFswXSkpO1xuICBpZiAocG9zc2libGVBbGVydEJ1dHRvbnMubGVuZ3RoIDwgMSB8fCBwb3NzaWJsZUFsZXJ0QnV0dG9ucy5sZW5ndGggPiAyKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob0FsZXJ0T3BlbkVycm9yKCk7XG4gIH1cblxuICBjb25zdCBhc3NlcnRCdXR0b25OYW1lID0gYXN5bmMgKGJ1dHRvbiwgZXhwZWN0ZWROYW1lKSA9PiB7XG4gICAgYnV0dG9uID0gdXRpbC51bndyYXBFbGVtZW50KGJ1dHRvbik7XG4gICAgY29uc3QgbmFtZSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke2J1dHRvbn0vYXR0cmlidXRlL25hbWVgLCAnR0VUJyk7XG4gICAgaWYgKF8uaXNOaWwobmFtZSkgfHwgbmFtZS50b0xvd2VyQ2FzZSgpICE9PSBleHBlY3RlZE5hbWUpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9BbGVydE9wZW5FcnJvcigpO1xuICAgIH1cbiAgfTtcblxuICBjb25zdCBhbGVydCA9IHBvc3NpYmxlQWxlcnRbMF07XG4gIGlmIChwb3NzaWJsZUFsZXJ0QnV0dG9ucy5sZW5ndGggPT09IDEpIHtcbiAgICAvLyBtYWtlIHN1cmUgdGhlIGJ1dHRvbiBpcyAnQ2xvc2UnXG4gICAgY29uc3QgY2xvc2VCdXR0b24gPSBwb3NzaWJsZUFsZXJ0QnV0dG9uc1swXTtcbiAgICBhd2FpdCBhc3NlcnRCdXR0b25OYW1lKGNsb3NlQnV0dG9uLCAnY2xvc2UnKTtcblxuICAgIGFsZXJ0LmNsb3NlID0gYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7dXRpbC51bndyYXBFbGVtZW50KGNsb3NlQnV0dG9uKX0vY2xpY2tgLCAnUE9TVCcpO1xuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgLy8gZW5zdXJlIHRoZSBidXR0b25zIGFyZSAnQ2FuY2VsJyBhbmQgJ09LJ1xuICAgIGNvbnN0IGNhbmNlbEJ1dHRvbiA9IHBvc3NpYmxlQWxlcnRCdXR0b25zWzBdO1xuICAgIGF3YWl0IGFzc2VydEJ1dHRvbk5hbWUoY2FuY2VsQnV0dG9uLCAnY2FuY2VsJyk7XG4gICAgY29uc3Qgb2tCdXR0b24gPSBwb3NzaWJsZUFsZXJ0QnV0dG9uc1sxXTtcbiAgICBhd2FpdCBhc3NlcnRCdXR0b25OYW1lKG9rQnV0dG9uLCAnb2snKTtcblxuICAgIGFsZXJ0LmNhbmNlbCA9IGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke3V0aWwudW53cmFwRWxlbWVudChjYW5jZWxCdXR0b24pfS9jbGlja2AsICdQT1NUJyk7XG4gICAgfTtcbiAgICBhbGVydC5vayA9IGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke3V0aWwudW53cmFwRWxlbWVudChva0J1dHRvbil9L2NsaWNrYCwgJ1BPU1QnKTtcbiAgICB9O1xuICB9XG5cbiAgYWxlcnQuZ2V0VGV4dCA9IGFzeW5jICgpID0+IHtcbiAgICBsZXQgdGV4dFZpZXcgPSBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnY2xhc3MgbmFtZScsICdYQ1VJRWxlbWVudFR5cGVUZXh0VmlldycsIGZhbHNlLCB1dGlsLnVud3JhcEVsZW1lbnQoYWxlcnQpKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7dXRpbC51bndyYXBFbGVtZW50KHRleHRWaWV3KX0vYXR0cmlidXRlL3ZhbHVlYCwgJ0dFVCcpO1xuICB9O1xuICBhbGVydC5zZXRUZXh0ID0gYXN5bmMgKHZhbHVlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCB0ZXh0VmlldyA9IGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdjbGFzcyBuYW1lJywgJ1hDVUlFbGVtZW50VHlwZVRleHRGaWVsZCcsIGZhbHNlLCB1dGlsLnVud3JhcEVsZW1lbnQoYWxlcnQpKTtcbiAgICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke3V0aWwudW53cmFwRWxlbWVudCh0ZXh0Vmlldyl9L3ZhbHVlIGAsICdQT1NUJywge3ZhbHVlfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoaXNFcnJvclR5cGUoZXJyLCBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyaWVkIHRvIHNldCB0ZXh0IG9mIGFuIGFsZXJ0IHRoYXQgd2FzIG5vdCBhIHByb21wdCcpO1xuICAgICAgfVxuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfTtcblxuICByZXR1cm4gYWxlcnQ7XG59O1xuXG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9hbGVydC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
