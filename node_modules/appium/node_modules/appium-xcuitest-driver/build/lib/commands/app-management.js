"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

let commands = {};

function extractMandatoryOptions(opts = {}, keys) {
  const result = {};

  for (const key of keys) {
    const value = opts[key];

    if (!_lodash.default.isString(value) || _lodash.default.isEmpty(value)) {
      _logger.default.errorAndThrow(`'${key}' is expected to be a valid string. '${value}' is given instead`);
    }

    result[key] = value;
  }

  return result;
}

commands.mobileInstallApp = async function mobileInstallApp(opts = {}) {
  const {
    app
  } = extractMandatoryOptions(opts, ['app']);
  const dstPath = await this.helpers.configureApp(app, '.app');

  _logger.default.info(`Installing '${dstPath}' to the ${this.isRealDevice() ? 'real device' : 'Simulator'} ` + `with UDID ${this.opts.device.udid}`);

  if (!(await _appiumSupport.fs.exists(dstPath))) {
    _logger.default.errorAndThrow(`The application at '${dstPath}' does not exist or is not accessible`);
  }

  await this.opts.device.installApp(dstPath);

  _logger.default.info(`Installation of '${dstPath}' succeeded`);
};

commands.mobileIsAppInstalled = async function mobileIsAppInstalled(opts = {}) {
  const {
    bundleId
  } = extractMandatoryOptions(opts, ['bundleId']);
  const installed = await this.opts.device.isAppInstalled(bundleId);

  _logger.default.info(`App '${bundleId}' is${installed ? '' : ' not'} installed`);

  return installed;
};

commands.mobileRemoveApp = async function mobileRemoveApp(opts = {}) {
  const {
    bundleId
  } = extractMandatoryOptions(opts, ['bundleId']);

  _logger.default.info(`Uninstalling the application with bundle identifier '${bundleId}' ` + `from the ${this.isRealDevice() ? 'real device' : 'Simulator'} with UDID ${this.opts.device.udid}`);

  try {
    await this.opts.device.removeApp(bundleId);

    _logger.default.info(`Removal of '${bundleId}' succeeded`);

    return true;
  } catch (err) {
    _logger.default.warn(`Cannot remove '${bundleId}'. Original error: ${err.message}`);

    return false;
  }
};

commands.mobileLaunchApp = async function mobileLaunchApp(opts = {}) {
  const wdaOpts = extractMandatoryOptions(opts, ['bundleId']);

  if (opts.arguments) {
    wdaOpts.arguments = _lodash.default.isArray(opts.arguments) ? opts.arguments : [opts.arguments];
  }

  if (opts.environment) {
    wdaOpts.environment = opts.environment;
  }

  return await this.proxyCommand('/wda/apps/launch', 'POST', wdaOpts);
};

commands.mobileTerminateApp = async function mobileTerminateApp(opts = {}) {
  return await this.proxyCommand('/wda/apps/terminate', 'POST', extractMandatoryOptions(opts, ['bundleId']));
};

commands.mobileActivateApp = async function mobileActivateApp(opts = {}) {
  return await this.proxyCommand('/wda/apps/activate', 'POST', extractMandatoryOptions(opts, ['bundleId']));
};

commands.mobileQueryAppState = async function mobileQueryAppState(opts = {}) {
  return await this.proxyCommand('/wda/apps/state', 'POST', extractMandatoryOptions(opts, ['bundleId']));
};

commands.installApp = async function installApp(appPath) {
  await this.mobileInstallApp({
    app: appPath
  });
};

commands.activateApp = async function activateApp(bundleId, opts = {}) {
  return await this.mobileLaunchApp(Object.assign({}, opts, {
    bundleId
  }));
};

commands.isAppInstalled = async function isAppInstalled(bundleId) {
  return await this.mobileIsAppInstalled({
    bundleId
  });
};

commands.terminateApp = async function terminateApp(bundleId) {
  return await this.mobileTerminateApp({
    bundleId
  });
};

commands.queryAppState = async function queryAppState(bundleId) {
  return await this.mobileQueryAppState({
    bundleId
  });
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9hcHAtbWFuYWdlbWVudC5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsImV4dHJhY3RNYW5kYXRvcnlPcHRpb25zIiwib3B0cyIsImtleXMiLCJyZXN1bHQiLCJrZXkiLCJ2YWx1ZSIsIl8iLCJpc1N0cmluZyIsImlzRW1wdHkiLCJsb2ciLCJlcnJvckFuZFRocm93IiwibW9iaWxlSW5zdGFsbEFwcCIsImFwcCIsImRzdFBhdGgiLCJoZWxwZXJzIiwiY29uZmlndXJlQXBwIiwiaW5mbyIsImlzUmVhbERldmljZSIsImRldmljZSIsInVkaWQiLCJmcyIsImV4aXN0cyIsImluc3RhbGxBcHAiLCJtb2JpbGVJc0FwcEluc3RhbGxlZCIsImJ1bmRsZUlkIiwiaW5zdGFsbGVkIiwiaXNBcHBJbnN0YWxsZWQiLCJtb2JpbGVSZW1vdmVBcHAiLCJyZW1vdmVBcHAiLCJlcnIiLCJ3YXJuIiwibWVzc2FnZSIsIm1vYmlsZUxhdW5jaEFwcCIsIndkYU9wdHMiLCJhcmd1bWVudHMiLCJpc0FycmF5IiwiZW52aXJvbm1lbnQiLCJwcm94eUNvbW1hbmQiLCJtb2JpbGVUZXJtaW5hdGVBcHAiLCJtb2JpbGVBY3RpdmF0ZUFwcCIsIm1vYmlsZVF1ZXJ5QXBwU3RhdGUiLCJhcHBQYXRoIiwiYWN0aXZhdGVBcHAiLCJPYmplY3QiLCJhc3NpZ24iLCJ0ZXJtaW5hdGVBcHAiLCJxdWVyeUFwcFN0YXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmOztBQUVBLFNBQVNDLHVCQUFULENBQWtDQyxJQUFJLEdBQUcsRUFBekMsRUFBNkNDLElBQTdDLEVBQW1EO0FBQ2pELFFBQU1DLE1BQU0sR0FBRyxFQUFmOztBQUNBLE9BQUssTUFBTUMsR0FBWCxJQUFrQkYsSUFBbEIsRUFBd0I7QUFDdEIsVUFBTUcsS0FBSyxHQUFHSixJQUFJLENBQUNHLEdBQUQsQ0FBbEI7O0FBQ0EsUUFBSSxDQUFD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QUFDQyxJQUFELEVBQU8sQ0FBQyxVQUFELENBQVAsQ0FBcEUsQ0FBYjtBQUNELENBRkQ7O0FBSUFGLFFBQVEsQ0FBQ3VCLFVBQVQsR0FBc0IsZUFBZUEsVUFBZixDQUEyQm1CLE9BQTNCLEVBQW9DO0FBQ3hELFFBQU0sS0FBSzlCLGdCQUFMLENBQXNCO0FBQUNDLElBQUFBLEdBQUcsRUFBRTZCO0FBQU4sR0FBdEIsQ0FBTjtBQUNELENBRkQ7O0FBSUExQyxRQUFRLENBQUMyQyxXQUFULEdBQXVCLGVBQWVBLFdBQWYsQ0FBNEJsQixRQUE1QixFQUFzQ3ZCLElBQUksR0FBRyxFQUE3QyxFQUFpRDtBQUN0RSxTQUFPLE1BQU0sS0FBSytCLGVBQUwsQ0FBcUJXLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEVBQWQsRUFBa0IzQyxJQUFsQixFQUF3QjtBQUFDdUIsSUFBQUE7QUFBRCxHQUF4QixDQUFyQixDQUFiO0FBQ0QsQ0FGRDs7QUFJQXpCLFFBQVEsQ0FBQzJCLGNBQVQsR0FBMEIsZUFBZUEsY0FBZixDQUErQkYsUUFBL0IsRUFBeUM7QUFDakUsU0FBTyxNQUFNLEtBQUtELG9CQUFMLENBQTBCO0FBQUNDLElBQUFBO0FBQUQsR0FBMUIsQ0FBYjtBQUNELENBRkQ7O0FBSUF6QixRQUFRLENBQUM4QyxZQUFULEdBQXdCLGVBQWVBLFlBQWYsQ0FBNkJyQixRQUE3QixFQUF1QztBQUM3RCxTQUFPLE1BQU0sS0FBS2Msa0JBQUwsQ0FBd0I7QUFBQ2QsSUFBQUE7QUFBRCxHQUF4QixDQUFiO0FBQ0QsQ0FGRDs7QUFJQXpCLFFBQVEsQ0FBQytDLGFBQVQsR0FBeUIsZUFBZUEsYUFBZixDQUE4QnRCLFFBQTlCLEVBQXdDO0FBQy9ELFNBQU8sTUFBTSxLQUFLZ0IsbUJBQUwsQ0FBeUI7QUFBQ2hCLElBQUFBO0FBQUQsR0FBekIsQ0FBYjtBQUNELENBRkQ7O2VBSWV6QixRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuXG5sZXQgY29tbWFuZHMgPSB7fTtcblxuZnVuY3Rpb24gZXh0cmFjdE1hbmRhdG9yeU9wdGlvbnMgKG9wdHMgPSB7fSwga2V5cykge1xuICBjb25zdCByZXN1bHQgPSB7fTtcbiAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykge1xuICAgIGNvbnN0IHZhbHVlID0gb3B0c1trZXldO1xuICAgIGlmICghXy5pc1N0cmluZyh2YWx1ZSkgfHwgXy5pc0VtcHR5KHZhbHVlKSkge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYCcke2tleX0nIGlzIGV4cGVjdGVkIHRvIGJlIGEgdmFsaWQgc3RyaW5nLiAnJHt2YWx1ZX0nIGlzIGdpdmVuIGluc3RlYWRgKTtcbiAgICB9XG4gICAgcmVzdWx0W2tleV0gPSB2YWx1ZTtcbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5jb21tYW5kcy5tb2JpbGVJbnN0YWxsQXBwID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlSW5zdGFsbEFwcCAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHthcHB9ID0gZXh0cmFjdE1hbmRhdG9yeU9wdGlvbnMob3B0cywgWydhcHAnXSk7XG4gIGNvbnN0IGRzdFBhdGggPSBhd2FpdCB0aGlzLmhlbHBlcnMuY29uZmlndXJlQXBwKGFwcCwgJy5hcHAnKTtcbiAgbG9nLmluZm8oYEluc3RhbGxpbmcgJyR7ZHN0UGF0aH0nIHRvIHRoZSAke3RoaXMuaXNSZWFsRGV2aWNlKCkgPyAncmVhbCBkZXZpY2UnIDogJ1NpbXVsYXRvcid9IGAgK1xuICAgIGB3aXRoIFVESUQgJHt0aGlzLm9wdHMuZGV2aWNlLnVkaWR9YCk7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKGRzdFBhdGgpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSBhcHBsaWNhdGlvbiBhdCAnJHtkc3RQYXRofScgZG9lcyBub3QgZXhpc3Qgb3IgaXMgbm90IGFjY2Vzc2libGVgKTtcbiAgfVxuICBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLmluc3RhbGxBcHAoZHN0UGF0aCk7XG4gIGxvZy5pbmZvKGBJbnN0YWxsYXRpb24gb2YgJyR7ZHN0UGF0aH0nIHN1Y2NlZWRlZGApO1xufTtcblxuY29tbWFuZHMubW9iaWxlSXNBcHBJbnN0YWxsZWQgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVJc0FwcEluc3RhbGxlZCAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtidW5kbGVJZH0gPSBleHRyYWN0TWFuZGF0b3J5T3B0aW9ucyhvcHRzLCBbJ2J1bmRsZUlkJ10pO1xuICBjb25zdCBpbnN0YWxsZWQgPSBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLmlzQXBwSW5zdGFsbGVkKGJ1bmRsZUlkKTtcbiAgbG9nLmluZm8oYEFwcCAnJHtidW5kbGVJZH0nIGlzJHtpbnN0YWxsZWQgPyAnJyA6ICcgbm90J30gaW5zdGFsbGVkYCk7XG4gIHJldHVybiBpbnN0YWxsZWQ7XG59O1xuXG5jb21tYW5kcy5tb2JpbGVSZW1vdmVBcHAgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVSZW1vdmVBcHAgKG9wdHMgPSB7fSkge1xuICBjb25zdCB7YnVuZGxlSWR9ID0gZXh0cmFjdE1hbmRhdG9yeU9wdGlvbnMob3B0cywgWydidW5kbGVJZCddKTtcbiAgbG9nLmluZm8oYFVuaW5zdGFsbGluZyB0aGUgYXBwbGljYXRpb24gd2l0aCBidW5kbGUgaWRlbnRpZmllciAnJHtidW5kbGVJZH0nIGAgK1xuICAgIGBmcm9tIHRoZSAke3RoaXMuaXNSZWFsRGV2aWNlKCkgPyAncmVhbCBkZXZpY2UnIDogJ1NpbXVsYXRvcid9IHdpdGggVURJRCAke3RoaXMub3B0cy5kZXZpY2UudWRpZH1gKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLnJlbW92ZUFwcChidW5kbGVJZCk7XG4gICAgbG9nLmluZm8oYFJlbW92YWwgb2YgJyR7YnVuZGxlSWR9JyBzdWNjZWVkZWRgKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYENhbm5vdCByZW1vdmUgJyR7YnVuZGxlSWR9Jy4gT3JpZ2luYWwgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59O1xuXG5jb21tYW5kcy5tb2JpbGVMYXVuY2hBcHAgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVMYXVuY2hBcHAgKG9wdHMgPSB7fSkge1xuICBjb25zdCB3ZGFPcHRzID0gZXh0cmFjdE1hbmRhdG9yeU9wdGlvbnMob3B0cywgWydidW5kbGVJZCddKTtcbiAgaWYgKG9wdHMuYXJndW1lbnRzKSB7XG4gICAgd2RhT3B0cy5hcmd1bWVudHMgPSBfLmlzQXJyYXkob3B0cy5hcmd1bWVudHMpID8gb3B0cy5hcmd1bWVudHMgOiBbb3B0cy5hcmd1bWVudHNdO1xuICB9XG4gIGlmIChvcHRzLmVudmlyb25tZW50KSB7XG4gICAgd2RhT3B0cy5lbnZpcm9ubWVudCA9IG9wdHMuZW52aXJvbm1lbnQ7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvd2RhL2FwcHMvbGF1bmNoJywgJ1BPU1QnLCB3ZGFPcHRzKTtcbn07XG5cbmNvbW1hbmRzLm1vYmlsZVRlcm1pbmF0ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVRlcm1pbmF0ZUFwcCAob3B0cyA9IHt9KSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3dkYS9hcHBzL3Rlcm1pbmF0ZScsICdQT1NUJywgZXh0cmFjdE1hbmRhdG9yeU9wdGlvbnMob3B0cywgWydidW5kbGVJZCddKSk7XG59O1xuXG5jb21tYW5kcy5tb2JpbGVBY3RpdmF0ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZUFjdGl2YXRlQXBwIChvcHRzID0ge30pIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvd2RhL2FwcHMvYWN0aXZhdGUnLCAnUE9TVCcsIGV4dHJhY3RNYW5kYXRvcnlPcHRpb25zKG9wdHMsIFsnYnVuZGxlSWQnXSkpO1xufTtcblxuLyoqXG4gKiBSZXR1cm5zIHRoZSBjdXJyZW50IGFwcGxpY2F0aW9uIHN0YXRlXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IG9wdHMgLSBPcHRpb25zIHNldCwgd2hpY2ggbXVzdCBjb250YWluIGBidW5kbGVJZGAgcHJvcGVydHlcbiAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBhY3R1YWwgYXBwbGljYXRpb24gc3RhdGUgY29kZS4gU2VlXG4gKiBodHRwczovL2RldmVsb3Blci5hcHBsZS5jb20vZG9jdW1lbnRhdGlvbi94Y3Rlc3QveGN1aWFwcGxpY2F0aW9uc3RhdGU/bGFuZ3VhZ2U9b2JqY1xuICogdG8gZ2V0IHRoZSBsaXN0IG9mIHBvc3NpYmxlIHZhbHVlcy5cbiAqL1xuY29tbWFuZHMubW9iaWxlUXVlcnlBcHBTdGF0ZSA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVF1ZXJ5QXBwU3RhdGUgKG9wdHMgPSB7fSkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvYXBwcy9zdGF0ZScsICdQT1NUJywgZXh0cmFjdE1hbmRhdG9yeU9wdGlvbnMob3B0cywgWydidW5kbGVJZCddKSk7XG59O1xuXG5jb21tYW5kcy5pbnN0YWxsQXBwID0gYXN5bmMgZnVuY3Rpb24gaW5zdGFsbEFwcCAoYXBwUGF0aCkge1xuICBhd2FpdCB0aGlzLm1vYmlsZUluc3RhbGxBcHAoe2FwcDogYXBwUGF0aH0pO1xufTtcblxuY29tbWFuZHMuYWN0aXZhdGVBcHAgPSBhc3luYyBmdW5jdGlvbiBhY3RpdmF0ZUFwcCAoYnVuZGxlSWQsIG9wdHMgPSB7fSkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5tb2JpbGVMYXVuY2hBcHAoT2JqZWN0LmFzc2lnbih7fSwgb3B0cywge2J1bmRsZUlkfSkpO1xufTtcblxuY29tbWFuZHMuaXNBcHBJbnN0YWxsZWQgPSBhc3luYyBmdW5jdGlvbiBpc0FwcEluc3RhbGxlZCAoYnVuZGxlSWQpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMubW9iaWxlSXNBcHBJbnN0YWxsZWQoe2J1bmRsZUlkfSk7XG59O1xuXG5jb21tYW5kcy50ZXJtaW5hdGVBcHAgPSBhc3luYyBmdW5jdGlvbiB0ZXJtaW5hdGVBcHAgKGJ1bmRsZUlkKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLm1vYmlsZVRlcm1pbmF0ZUFwcCh7YnVuZGxlSWR9KTtcbn07XG5cbmNvbW1hbmRzLnF1ZXJ5QXBwU3RhdGUgPSBhc3luYyBmdW5jdGlvbiBxdWVyeUFwcFN0YXRlIChidW5kbGVJZCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5tb2JpbGVRdWVyeUFwcFN0YXRlKHtidW5kbGVJZH0pO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9hcHAtbWFuYWdlbWVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
