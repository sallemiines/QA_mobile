"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.SafariConsoleLog = void 0;

require("source-map-support/register");

var _rotatingLog = require("./rotating-log");

var _lodash = _interopRequireDefault(require("lodash"));

class SafariConsoleLog extends _rotatingLog.RotatingLog {
  constructor(showLogs) {
    super(showLogs, 'SafariConsole');
    this.log.warning = this.log.warn;
  }

  addLogLine(out) {
    if (this.isCapturing) {
      this.logs = this.logs || [];

      while (this.logs.length >= _rotatingLog.MAX_LOG_ENTRIES_COUNT) {
        this.logs.shift();

        if (this.logIdxSinceLastRequest > 0) {
          this.logIdxSinceLastRequest--;
        }
      }

      const entry = {
        level: {
          error: 'SEVERE',
          warning: 'WARNING',
          log: 'FINE'
        }[out.level] || 'INFO',
        timestamp: Date.now(),
        message: JSON.stringify(out)
      };
      this.logs.push(entry);
    }

    if (_lodash.default.has(out, 'count')) {
      const count = out.count;
      out = this._previousOutput || {};
      out.text = `Previous message repeated ${count} time${count === 1 ? '' : 's'}`;
    } else {
      this._previousOutput = out;
    }

    if (this.showLogs) {
      let level = 'debug';

      if (out.level === 'warning' || out.level === 'error') {
        level = out.level;
      }

      for (const line of out.text.split('\n')) {
        const url = out.url ? `${out.url} ` : '';
        this.log[level](`[${level.toUpperCase()}][${url}${out.line}:${out.column}] ${line}`);
      }
    }
  }

}

exports.SafariConsoleLog = SafariConsoleLog;
var _default = SafariConsoleLog;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZXZpY2UtbG9nL3NhZmFyaS1jb25zb2xlLWxvZy5qcyJdLCJuYW1lcyI6WyJTYWZhcmlDb25zb2xlTG9nIiwiUm90YXRpbmdMb2ciLCJjb25zdHJ1Y3RvciIsInNob3dMb2dzIiwibG9nIiwid2FybmluZyIsIndhcm4iLCJhZGRMb2dMaW5lIiwib3V0IiwiaXNDYXB0dXJpbmciLCJsb2dzIiwibGVuZ3RoIiwiTUFYX0xPR19FTlRSSUVTX0NPVU5UIiwic2hpZnQiLCJsb2dJZHhTaW5jZUxhc3RSZXF1ZXN0IiwiZW50cnkiLCJsZXZlbCIsImVycm9yIiwidGltZXN0YW1wIiwiRGF0ZSIsIm5vdyIsIm1lc3NhZ2UiLCJKU09OIiwic3RyaW5naWZ5IiwicHVzaCIsIl8iLCJoYXMiLCJjb3VudCIsIl9wcmV2aW91c091dHB1dCIsInRleHQiLCJsaW5lIiwic3BsaXQiLCJ1cmwiLCJ0b1VwcGVyQ2FzZSIsImNvbHVtbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFHQSxNQUFNQSxnQkFBTixTQUErQkMsd0JBQS9CLENBQTJDO0FBQ3pDQyxFQUFBQSxXQUFXLENBQUVDLFFBQUYsRUFBWTtBQUNyQixVQUFNQSxRQUFOLEVBQWdCLGVBQWhCO0FBR0EsU0FBS0MsR0FBTCxDQUFTQyxPQUFULEdBQW1CLEtBQUtELEdBQUwsQ0FBU0UsSUFBNUI7QUFDRDs7QUFFREMsRUFBQUEsVUFBVSxDQUFFQyxHQUFGLEVBQU87QUFDZixRQUFJLEtBQUtDLFdBQVQsRUFBc0I7QUFDcEIsV0FBS0MsSUFBTCxHQUFZLEtBQUtBLElBQUwsSUFBYSxFQUF6Qjs7QUFDQSxhQUFPLEtBQUtBLElBQUwsQ0FBVUMsTUFBVixJQUFvQkMsa0NBQTNCLEVBQWtEO0FBQ2hELGFBQUtGLElBQUwsQ0FBVUcsS0FBVjs7QUFDQSxZQUFJLEtBQUtDLHNCQUFMLEdBQThCLENBQWxDLEVBQXFDO0FBQ25DLGVBQUtBLHNCQUFMO0FBQ0Q7QUFDRjs7QUE0QkQsWUFBTUMsS0FBSyxHQUFHO0FBQ1pDLFFBQUFBLEtBQUssRUFBRTtBQUNMQyxVQUFBQSxLQUFLLEVBQUUsUUFERjtBQUVMWixVQUFBQSxPQUFPLEVBQUUsU0FGSjtBQUdMRCxVQUFBQSxHQUFHLEVBQUU7QUFIQSxVQUlMSSxHQUFHLENBQUNRLEtBSkMsS0FJUyxNQUxKO0FBTVpFLFFBQUFBLFNBQVMsRUFBRUMsSUFBSSxDQUFDQyxHQUFMLEVBTkM7QUFPWkMsUUFBQUEsT0FBTyxFQUFFQyxJQUFJLENBQUNDLFNBQUwsQ0FBZWYsR0FBZjtBQVBHLE9BQWQ7QUFTQSxXQUFLRSxJQUFMLENBQVVjLElBQVYsQ0FBZVQsS0FBZjtBQUNEOztBQUVELFFBQUlVLGdCQUFFQyxHQUFGLENBQU1sQixHQUFOLEVBQVcsT0FBWCxDQUFKLEVBQXlCO0FBS3ZCLFlBQU1tQixLQUFLLEdBQUduQixHQUFHLENBQUNtQixLQUFsQjtBQUNBbkIsTUFBQUEsR0FBRyxHQUFHLEtBQUtvQixlQUFMLElBQXdCLEVBQTlCO0FBQ0FwQixNQUFBQSxHQUFHLENBQUNxQixJQUFKLEdBQVksNkJBQTRCRixLQUFNLFFBQU9BLEtBQUssS0FBSyxDQUFWLEdBQWMsRUFBZCxHQUFtQixHQUFJLEVBQTVFO0FBQ0QsS0FSRCxNQVFPO0FBRUwsV0FBS0MsZUFBTCxHQUF1QnBCLEdBQXZCO0FBQ0Q7O0FBSUQsUUFBSSxLQUFLTCxRQUFULEVBQW1CO0FBQ2pCLFVBQUlhLEtBQUssR0FBRyxPQUFaOztBQUNBLFVBQUlSLEdBQUcsQ0FBQ1EsS0FBSixLQUFjLFNBQWQsSUFBMkJSLEdBQUcsQ0FBQ1EsS0FBSixLQUFjLE9BQTdDLEVBQXNEO0FBQ3BEQSxRQUFBQSxLQUFLLEdBQUdSLEdBQUcsQ0FBQ1EsS0FBWjtBQUNEOztBQUNELFdBQUssTUFBTWMsSUFBWCxJQUFtQnRCLEdBQUcsQ0FBQ3FCLElBQUosQ0FBU0UsS0FBVCxDQUFlLElBQWYsQ0FBbkIsRUFBeUM7QUFFdkMsY0FBTUMsR0FBRyxHQUFHeEIsR0FBRyxDQUFDd0IsR0FBSixHQUFXLEdBQUV4QixHQUFHLENBQUN3QixHQUFJLEdBQXJCLEdBQTBCLEVBQXRDO0FBQ0EsYUFBSzVCLEdBQUwsQ0FBU1ksS0FBVCxFQUFpQixJQUFHQSxLQUFLLENBQUNpQixXQUFOLEVBQW9CLEtBQUlELEdBQUksR0FBRXhCLEdBQUcsQ0FBQ3NCLElBQUssSUFBR3RCLEdBQUcsQ0FBQzBCLE1BQU8sS0FBSUosSUFBSyxFQUFsRjtBQUNEO0FBQ0Y7QUFDRjs7QUFsRndDOzs7ZUFzRjVCOUIsZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSb3RhdGluZ0xvZywgTUFYX0xPR19FTlRSSUVTX0NPVU5UIH0gZnJvbSAnLi9yb3RhdGluZy1sb2cnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG5jbGFzcyBTYWZhcmlDb25zb2xlTG9nIGV4dGVuZHMgUm90YXRpbmdMb2cge1xuICBjb25zdHJ1Y3RvciAoc2hvd0xvZ3MpIHtcbiAgICBzdXBlcihzaG93TG9ncywgJ1NhZmFyaUNvbnNvbGUnKTtcblxuICAgIC8vIGpzIGNvbnNvbGUgaGFzIGB3YXJuaW5nYCBsZXZlbCwgc28gbWFwIHRvIGB3YXJuYFxuICAgIHRoaXMubG9nLndhcm5pbmcgPSB0aGlzLmxvZy53YXJuO1xuICB9XG5cbiAgYWRkTG9nTGluZSAob3V0KSB7XG4gICAgaWYgKHRoaXMuaXNDYXB0dXJpbmcpIHtcbiAgICAgIHRoaXMubG9ncyA9IHRoaXMubG9ncyB8fCBbXTtcbiAgICAgIHdoaWxlICh0aGlzLmxvZ3MubGVuZ3RoID49IE1BWF9MT0dfRU5UUklFU19DT1VOVCkge1xuICAgICAgICB0aGlzLmxvZ3Muc2hpZnQoKTtcbiAgICAgICAgaWYgKHRoaXMubG9nSWR4U2luY2VMYXN0UmVxdWVzdCA+IDApIHtcbiAgICAgICAgICB0aGlzLmxvZ0lkeFNpbmNlTGFzdFJlcXVlc3QtLTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvKlxuICAgICAgICogVGhlIG91dHB1dCB3aWxsIGJlIGxpa2U6XG4gICAgICAgKiAgIHtcbiAgICAgICAqICAgICBcInNvdXJjZVwiOiBcImphdmFzY3JpcHRcIixcbiAgICAgICAqICAgICBcImxldmVsXCI6XCJlcnJvclwiLFxuICAgICAgICogICAgIFwidGV4dFwiOlwiUmVmZXJlbmNlRXJyb3I6IENhbid0IGZpbmQgdmFyaWFibGU6IHNfYWNjb3VudFwiLFxuICAgICAgICogICAgIFwidHlwZVwiOlwibG9nXCIsXG4gICAgICAgKiAgICAgXCJsaW5lXCI6MixcbiAgICAgICAqICAgICBcImNvbHVtblwiOjIxLFxuICAgICAgICogICAgIFwidXJsXCI6XCJodHRwczovL2Fzc2V0cy5hZG9iZWR0bS5jb20vYjQ2ZTMxOGQ4NDUyNTA4MzRlZGExMGM1YTIwODI3YzA0NWE0ZDc2Zi9zY3JpcHRzL3NhdGVsbGl0ZS01Nzg2NmY4YjY0NzQ2ZDUzYTgwMDAxMDQtc3RhZ2luZy5qc1wiLFxuICAgICAgICogICAgIFwicmVwZWF0Q291bnRcIjoxLFxuICAgICAgICogICAgIFwic3RhY2tUcmFjZVwiOlt7XG4gICAgICAgKiAgICAgICBcImZ1bmN0aW9uTmFtZVwiOlwiZ2xvYmFsIGNvZGVcIixcbiAgICAgICAqICAgICAgIFwidXJsXCI6XCJodHRwczovL2Fzc2V0cy5hZG9iZWR0bS5jb20vYjQ2ZTMxOGQ4NDUyNTA4MzRlZGExMGM1YTIwODI3YzA0NWE0ZDc2Zi9zY3JpcHRzL3NhdGVsbGl0ZS01Nzg2NmY4YjY0NzQ2ZDUzYTgwMDAxMDQtc3RhZ2luZy5qc1wiLFxuICAgICAgICogICAgICAgXCJzY3JpcHRJZFwiOlwiNlwiLFxuICAgICAgICogICAgICAgXCJsaW5lTnVtYmVyXCI6MixcbiAgICAgICAqICAgICAgIFwiY29sdW1uTnVtYmVyXCI6MjFcbiAgICAgICAqICAgICB9XVxuICAgICAgICogIH1cbiAgICAgICAqXG4gICAgICAgKiB3ZSBuZWVkLCBhdCBsZWFzdCwgYGxldmVsYCAoaW4gYWNjb3JkYW5jZSB3aXRoIEphdmEgbGV2ZWxzXG4gICAgICAgKiAoaHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vamF2YXNlLzcvZG9jcy9hcGkvamF2YS91dGlsL2xvZ2dpbmcvTGV2ZWwuaHRtbCkpLFxuICAgICAgICogYHRpbWVzdGFtcGAsIGFuZCBgbWVzc2FnZWAgdG8gc2F0aXNmeSB0aGUgamF2YSBjbGllbnQuIEluIG9yZGVyIHRvXG4gICAgICAgKiBwcm92aWRlIGFsbCB0aGUgaW5mb3JtYXRpb24gdG8gdGhlIGNsaWVudCwgYG1lc3NhZ2VgIGlzIHRoZSBmdWxsXG4gICAgICAgKiBvYmplY3QsIHN0cmluZ2lmaWVkLlxuICAgICAgICovXG4gICAgICBjb25zdCBlbnRyeSA9IHtcbiAgICAgICAgbGV2ZWw6IHtcbiAgICAgICAgICBlcnJvcjogJ1NFVkVSRScsXG4gICAgICAgICAgd2FybmluZzogJ1dBUk5JTkcnLFxuICAgICAgICAgIGxvZzogJ0ZJTkUnLFxuICAgICAgICB9W291dC5sZXZlbF0gfHwgJ0lORk8nLFxuICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgIG1lc3NhZ2U6IEpTT04uc3RyaW5naWZ5KG91dCksXG4gICAgICB9O1xuICAgICAgdGhpcy5sb2dzLnB1c2goZW50cnkpO1xuICAgIH1cblxuICAgIGlmIChfLmhhcyhvdXQsICdjb3VudCcpKSB7XG4gICAgICAvLyB0aGlzIGlzIGEgbm90aWZpY2F0aW9uIG9mIHRoZSBwcmV2aW91cyBtZXNzYWdlIGJlaW5nIHJlcGVhdGVkXG4gICAgICAvLyB0aGlzIHNob3VsZCBfbmV2ZXJfIGJlIHRoZSBmaXJzdCBtZXNzYWdlLCBzbyB0aGUgcHJldmlvdXMgb25lIG91Z2h0IHRvXG4gICAgICAvLyBiZSBwb3B1bGF0ZWQuIElmIGl0IGlzIG5vdCwgbm90aGluZyB3aWxsIGJyZWFrLCBpdCB3aWxsIGp1c3QgbG9vayBvZGRcbiAgICAgIC8vIGluIHRoZSBvdXRwdXQgYmVsb3cgKG5vIHVybCBvciBsaW5lIG51bWJlcnMpXG4gICAgICBjb25zdCBjb3VudCA9IG91dC5jb3VudDtcbiAgICAgIG91dCA9IHRoaXMuX3ByZXZpb3VzT3V0cHV0IHx8IHt9O1xuICAgICAgb3V0LnRleHQgPSBgUHJldmlvdXMgbWVzc2FnZSByZXBlYXRlZCAke2NvdW50fSB0aW1lJHtjb3VudCA9PT0gMSA/ICcnIDogJ3MnfWA7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIHNhdmUgdGhlIG1vc3QgcmVjZW50IG91dHB1dFxuICAgICAgdGhpcy5fcHJldmlvdXNPdXRwdXQgPSBvdXQ7XG4gICAgfVxuXG4gICAgLy8gZm9ybWF0IG91dHB1dCBsaWtlXG4gICAgLy8gICAgIFNhZmFyaUNvbnNvbGUgW1dBUk5JTkddW2h0dHA6Ly9hcHBpdW0uaW8gMjoxM10gTG9nIHNvbWV0aGluZyB0byB3YXJuXG4gICAgaWYgKHRoaXMuc2hvd0xvZ3MpIHtcbiAgICAgIGxldCBsZXZlbCA9ICdkZWJ1Zyc7XG4gICAgICBpZiAob3V0LmxldmVsID09PSAnd2FybmluZycgfHwgb3V0LmxldmVsID09PSAnZXJyb3InKSB7XG4gICAgICAgIGxldmVsID0gb3V0LmxldmVsO1xuICAgICAgfVxuICAgICAgZm9yIChjb25zdCBsaW5lIG9mIG91dC50ZXh0LnNwbGl0KCdcXG4nKSkge1xuICAgICAgICAvLyB1cmwgaXMgb3B0aW9uYWwsIHNvIGdldCBmb3JtYXR0aW5nIGhlcmVcbiAgICAgICAgY29uc3QgdXJsID0gb3V0LnVybCA/IGAke291dC51cmx9IGAgOiAnJztcbiAgICAgICAgdGhpcy5sb2dbbGV2ZWxdKGBbJHtsZXZlbC50b1VwcGVyQ2FzZSgpfV1bJHt1cmx9JHtvdXQubGluZX06JHtvdXQuY29sdW1ufV0gJHtsaW5lfWApO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgeyBTYWZhcmlDb25zb2xlTG9nIH07XG5leHBvcnQgZGVmYXVsdCBTYWZhcmlDb25zb2xlTG9nO1xuIl0sImZpbGUiOiJsaWIvZGV2aWNlLWxvZy9zYWZhcmktY29uc29sZS1sb2cuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
