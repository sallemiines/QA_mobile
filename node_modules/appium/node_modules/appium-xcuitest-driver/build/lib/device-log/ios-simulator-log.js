"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.IOSSimulatorLog = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _iosLog = require("./ios-log");

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

const log = _appiumSupport.logger.getLogger('IOSSimulatorLog');

const START_TIMEOUT = 10000;

class IOSSimulatorLog extends _iosLog.IOSLog {
  constructor({
    sim,
    showLogs,
    xcodeVersion,
    iosSimulatorLogsPredicate
  }) {
    super();
    this.sim = sim;
    this.showLogs = !!showLogs;
    this.xcodeVersion = xcodeVersion;
    this.predicate = iosSimulatorLogsPredicate;
    this.proc = null;
  }

  async startCapture() {
    if (_lodash.default.isUndefined(this.sim.udid)) {
      throw new Error(`Log capture requires a sim udid`);
    }

    if (!(await this.sim.isRunning())) {
      throw new Error(`iOS Simulator with udid ${this.sim.udid} is not running`);
    }

    const tool = 'xcrun';
    let args = ['simctl', 'spawn', this.sim.udid, 'log', 'stream', '--style', 'compact'];

    if (this.predicate) {
      args.push('--predicate', this.predicate);
    }

    log.debug(`Starting log capture for iOS Simulator with udid '${this.sim.udid}', ` + `using '${tool} ${args.join(' ')}'`);

    try {
      await (0, _teen_process.exec)('pkill', ['-xf', [tool, ...args].join(' ')]);
    } catch (ign) {}

    try {
      this.proc = new _teen_process.SubProcess(tool, args);
      await this.finishStartingLogCapture();
    } catch (e) {
      throw new Error(`Simulator log capture failed. Original error: ${e.message}`);
    }
  }

  async finishStartingLogCapture() {
    if (!this.proc) {
      log.errorAndThrow('Could not capture simulator log');
    }

    let firstLine = true;
    let logRow = '';
    this.proc.on('output', (stdout, stderr) => {
      if (stdout) {
        if (firstLine) {
          if (stdout.endsWith('\n')) {
            firstLine = false;
          }
        } else {
          logRow += stdout;

          if (stdout.endsWith('\n')) {
            this.onOutput(logRow);
            logRow = '';
          }
        }
      }

      if (stderr) {
        this.onOutput(logRow, 'STDERR');
      }
    });

    let sd = (stdout, stderr) => {
      if (/execvp\(\)/.test(stderr)) {
        throw new Error('iOS log capture process failed to start');
      }

      return stdout || stderr;
    };

    await this.proc.start(sd, START_TIMEOUT);
  }

  async stopCapture() {
    if (!this.proc) {
      return;
    }

    await this.killLogSubProcess();
    this.proc = null;
  }

  async killLogSubProcess() {
    if (!this.proc.isRunning) {
      return;
    }

    log.debug('Stopping iOS log capture');

    try {
      await this.proc.stop('SIGTERM', 1000);
    } catch (e) {
      if (!this.proc.isRunning) {
        return;
      }

      _appiumSupport.logger.warn('Cannot stop log capture process. Sending SIGKILL...');

      await this.proc.stop('SIGKILL');
    }
  }

  get isCapturing() {
    return this.proc && this.proc.isRunning;
  }

  onOutput(logRow, prefix = '') {
    const logs = _lodash.default.cloneDeep(logRow.split('\n'));

    for (const logLine of logs) {
      if (!logLine) continue;
      this.broadcast(logLine);

      if (this.showLogs) {
        const space = prefix.length > 0 ? ' ' : '';
        log.info(`[IOS_SYSLOG_ROW${space}${prefix}] ${logLine}`);
      }
    }
  }

}

exports.IOSSimulatorLog = IOSSimulatorLog;
var _default = IOSSimulatorLog;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZXZpY2UtbG9nL2lvcy1zaW11bGF0b3ItbG9nLmpzIl0sIm5hbWVzIjpbImxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsIlNUQVJUX1RJTUVPVVQiLCJJT1NTaW11bGF0b3JMb2ciLCJJT1NMb2ciLCJjb25zdHJ1Y3RvciIsInNpbSIsInNob3dMb2dzIiwieGNvZGVWZXJzaW9uIiwiaW9zU2ltdWxhdG9yTG9nc1ByZWRpY2F0ZSIsInByZWRpY2F0ZSIsInByb2MiLCJzdGFydENhcHR1cmUiLCJfIiwiaXNVbmRlZmluZWQiLCJ1ZGlkIiwiRXJyb3IiLCJpc1J1bm5pbmciLCJ0b29sIiwiYXJncyIsInB1c2giLCJkZWJ1ZyIsImpvaW4iLCJpZ24iLCJTdWJQcm9jZXNzIiwiZmluaXNoU3RhcnRpbmdMb2dDYXB0dXJlIiwiZSIsIm1lc3NhZ2UiLCJlcnJvckFuZFRocm93IiwiZmlyc3RMaW5lIiwibG9nUm93Iiwib24iLCJzdGRvdXQiLCJzdGRlcnIiLCJlbmRzV2l0aCIsIm9uT3V0cHV0Iiwic2QiLCJ0ZXN0Iiwic3RhcnQiLCJzdG9wQ2FwdHVyZSIsImtpbGxMb2dTdWJQcm9jZXNzIiwic3RvcCIsIndhcm4iLCJpc0NhcHR1cmluZyIsInByZWZpeCIsImxvZ3MiLCJjbG9uZURlZXAiLCJzcGxpdCIsImxvZ0xpbmUiLCJicm9hZGNhc3QiLCJzcGFjZSIsImxlbmd0aCIsImluZm8iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsR0FBRyxHQUFHQyxzQkFBT0MsU0FBUCxDQUFpQixpQkFBakIsQ0FBWjs7QUFFQSxNQUFNQyxhQUFhLEdBQUcsS0FBdEI7O0FBRUEsTUFBTUMsZUFBTixTQUE4QkMsY0FBOUIsQ0FBcUM7QUFDbkNDLEVBQUFBLFdBQVcsQ0FBRTtBQUFDQyxJQUFBQSxHQUFEO0FBQU1DLElBQUFBLFFBQU47QUFBZ0JDLElBQUFBLFlBQWhCO0FBQThCQyxJQUFBQTtBQUE5QixHQUFG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YSxJQUFiLENBQVosQ0FBYjs7QUFDQSxTQUFLLE1BQU1DLE9BQVgsSUFBc0JILElBQXRCLEVBQTRCO0FBQzFCLFVBQUksQ0FBQ0csT0FBTCxFQUFjO0FBQ2QsV0FBS0MsU0FBTCxDQUFlRCxPQUFmOztBQUNBLFVBQUksS0FBS3pDLFFBQVQsRUFBbUI7QUFDakIsY0FBTTJDLEtBQUssR0FBR04sTUFBTSxDQUFDTyxNQUFQLEdBQWdCLENBQWhCLEdBQW9CLEdBQXBCLEdBQTBCLEVBQXhDO0FBQ0FwRCxRQUFBQSxHQUFHLENBQUNxRCxJQUFKLENBQVUsa0JBQWlCRixLQUFNLEdBQUVOLE1BQU8sS0FBSUksT0FBUSxFQUF0RDtBQUNEO0FBQ0Y7QUFDRjs7QUFwSGtDOzs7ZUF3SHRCN0MsZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBJT1NMb2cgfSBmcm9tICcuL2lvcy1sb2cnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgU3ViUHJvY2VzcywgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5cbmNvbnN0IGxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ0lPU1NpbXVsYXRvckxvZycpO1xuXG5jb25zdCBTVEFSVF9USU1FT1VUID0gMTAwMDA7XG5cbmNsYXNzIElPU1NpbXVsYXRvckxvZyBleHRlbmRzIElPU0xvZyB7XG4gIGNvbnN0cnVjdG9yICh7c2ltLCBzaG93TG9ncywgeGNvZGVWZXJzaW9uLCBpb3NTaW11bGF0b3JMb2dzUHJlZGljYXRlfSkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5zaW0gPSBzaW07XG4gICAgdGhpcy5zaG93TG9ncyA9ICEhc2hvd0xvZ3M7XG4gICAgdGhpcy54Y29kZVZlcnNpb24gPSB4Y29kZVZlcnNpb247XG4gICAgdGhpcy5wcmVkaWNhdGUgPSBpb3NTaW11bGF0b3JMb2dzUHJlZGljYXRlO1xuICAgIHRoaXMucHJvYyA9IG51bGw7XG4gIH1cblxuICBhc3luYyBzdGFydENhcHR1cmUgKCkge1xuICAgIGlmIChfLmlzVW5kZWZpbmVkKHRoaXMuc2ltLnVkaWQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYExvZyBjYXB0dXJlIHJlcXVpcmVzIGEgc2ltIHVkaWRgKTtcbiAgICB9XG5cbiAgICBpZiAoIWF3YWl0IHRoaXMuc2ltLmlzUnVubmluZygpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGlPUyBTaW11bGF0b3Igd2l0aCB1ZGlkICR7dGhpcy5zaW0udWRpZH0gaXMgbm90IHJ1bm5pbmdgKTtcbiAgICB9XG4gICAgY29uc3QgdG9vbCA9ICd4Y3J1bic7XG4gICAgbGV0IGFyZ3MgPSBbXG4gICAgICAnc2ltY3RsJyxcbiAgICAgICdzcGF3bicsIHRoaXMuc2ltLnVkaWQsXG4gICAgICAnbG9nJyxcbiAgICAgICdzdHJlYW0nLFxuICAgICAgJy0tc3R5bGUnLCAnY29tcGFjdCcsXG4gICAgXTtcbiAgICBpZiAodGhpcy5wcmVkaWNhdGUpIHtcbiAgICAgIGFyZ3MucHVzaCgnLS1wcmVkaWNhdGUnLCB0aGlzLnByZWRpY2F0ZSk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgbG9nIGNhcHR1cmUgZm9yIGlPUyBTaW11bGF0b3Igd2l0aCB1ZGlkICcke3RoaXMuc2ltLnVkaWR9JywgYCArXG4gICAgICAgICAgICAgICAgYHVzaW5nICcke3Rvb2x9ICR7YXJncy5qb2luKCcgJyl9J2ApO1xuICAgIHRyeSB7XG4gICAgICAvLyBjbGVhbnVwIGV4aXN0aW5nIGxpc3RlbmVycyBpZiB0aGUgcHJldmlvdXMgc2Vzc2lvbiBoYXMgbm90IGJlZW4gdGVybWluYXRlZCBwcm9wZXJseVxuICAgICAgYXdhaXQgZXhlYygncGtpbGwnLCBbJy14ZicsIFt0b29sLCAuLi5hcmdzXS5qb2luKCcgJyldKTtcbiAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMucHJvYyA9IG5ldyBTdWJQcm9jZXNzKHRvb2wsIGFyZ3MpO1xuICAgICAgYXdhaXQgdGhpcy5maW5pc2hTdGFydGluZ0xvZ0NhcHR1cmUoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFNpbXVsYXRvciBsb2cgY2FwdHVyZSBmYWlsZWQuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBmaW5pc2hTdGFydGluZ0xvZ0NhcHR1cmUgKCkge1xuICAgIGlmICghdGhpcy5wcm9jKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdygnQ291bGQgbm90IGNhcHR1cmUgc2ltdWxhdG9yIGxvZycpO1xuICAgIH1cbiAgICBsZXQgZmlyc3RMaW5lID0gdHJ1ZTtcbiAgICBsZXQgbG9nUm93ID0gJyc7XG4gICAgdGhpcy5wcm9jLm9uKCdvdXRwdXQnLCAoc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgIGlmIChzdGRvdXQpIHtcbiAgICAgICAgaWYgKGZpcnN0TGluZSkge1xuICAgICAgICAgIGlmIChzdGRvdXQuZW5kc1dpdGgoJ1xcbicpKSB7XG4gICAgICAgICAgICAvLyBkb24ndCBzdG9yZSB0aGUgZmlyc3QgbGluZSBvZiB0aGUgbG9nIGJlY2F1c2UgaXQgY2FtZSBiZWZvcmUgdGhlIHNpbSB3YXMgbGF1bmNoZWRcbiAgICAgICAgICAgIGZpcnN0TGluZSA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsb2dSb3cgKz0gc3Rkb3V0O1xuICAgICAgICAgIGlmIChzdGRvdXQuZW5kc1dpdGgoJ1xcbicpKSB7XG4gICAgICAgICAgICB0aGlzLm9uT3V0cHV0KGxvZ1Jvdyk7XG4gICAgICAgICAgICBsb2dSb3cgPSAnJztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChzdGRlcnIpIHtcbiAgICAgICAgdGhpcy5vbk91dHB1dChsb2dSb3csICdTVERFUlInKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGxldCBzZCA9IChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgaWYgKC9leGVjdnBcXChcXCkvLnRlc3Qoc3RkZXJyKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2lPUyBsb2cgY2FwdHVyZSBwcm9jZXNzIGZhaWxlZCB0byBzdGFydCcpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHN0ZG91dCB8fCBzdGRlcnI7XG4gICAgfTtcbiAgICBhd2FpdCB0aGlzLnByb2Muc3RhcnQoc2QsIFNUQVJUX1RJTUVPVVQpO1xuICB9XG5cbiAgYXN5bmMgc3RvcENhcHR1cmUgKCkge1xuICAgIGlmICghdGhpcy5wcm9jKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGF3YWl0IHRoaXMua2lsbExvZ1N1YlByb2Nlc3MoKTtcbiAgICB0aGlzLnByb2MgPSBudWxsO1xuICB9XG5cbiAgYXN5bmMga2lsbExvZ1N1YlByb2Nlc3MgKCkge1xuICAgIGlmICghdGhpcy5wcm9jLmlzUnVubmluZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsb2cuZGVidWcoJ1N0b3BwaW5nIGlPUyBsb2cgY2FwdHVyZScpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnByb2Muc3RvcCgnU0lHVEVSTScsIDEwMDApO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmICghdGhpcy5wcm9jLmlzUnVubmluZykge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBsb2dnZXIud2FybignQ2Fubm90IHN0b3AgbG9nIGNhcHR1cmUgcHJvY2Vzcy4gU2VuZGluZyBTSUdLSUxMLi4uJyk7XG4gICAgICBhd2FpdCB0aGlzLnByb2Muc3RvcCgnU0lHS0lMTCcpO1xuICAgIH1cbiAgfVxuXG4gIGdldCBpc0NhcHR1cmluZyAoKSB7XG4gICAgcmV0dXJuIHRoaXMucHJvYyAmJiB0aGlzLnByb2MuaXNSdW5uaW5nO1xuICB9XG5cbiAgb25PdXRwdXQgKGxvZ1JvdywgcHJlZml4ID0gJycpIHtcbiAgICBjb25zdCBsb2dzID0gXy5jbG9uZURlZXAobG9nUm93LnNwbGl0KCdcXG4nKSk7XG4gICAgZm9yIChjb25zdCBsb2dMaW5lIG9mIGxvZ3MpIHtcbiAgICAgIGlmICghbG9nTGluZSkgY29udGludWU7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICAgIHRoaXMuYnJvYWRjYXN0KGxvZ0xpbmUpO1xuICAgICAgaWYgKHRoaXMuc2hvd0xvZ3MpIHtcbiAgICAgICAgY29uc3Qgc3BhY2UgPSBwcmVmaXgubGVuZ3RoID4gMCA/ICcgJyA6ICcnO1xuICAgICAgICBsb2cuaW5mbyhgW0lPU19TWVNMT0dfUk9XJHtzcGFjZX0ke3ByZWZpeH1dICR7bG9nTGluZX1gKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IHsgSU9TU2ltdWxhdG9yTG9nIH07XG5leHBvcnQgZGVmYXVsdCBJT1NTaW11bGF0b3JMb2c7Il0sImZpbGUiOiJsaWIvZGV2aWNlLWxvZy9pb3Mtc2ltdWxhdG9yLWxvZy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
