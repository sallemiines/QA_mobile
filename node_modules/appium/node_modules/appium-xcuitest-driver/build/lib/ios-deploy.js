"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _appiumIosDevice = require("appium-ios-device");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

const APPLICATION_INSTALLED_NOTIFICATION = 'com.apple.mobile.application_installed';
const INSTALLATION_STAGING_DIR = 'PublicStaging';
const DEFAULT_ITEM_PUSH_TIMEOUT = 30 * 1000;
const APPLICATION_NOTIFICATION_TIMEOUT = 30 * 1000;
const IOS_DEPLOY = 'ios-deploy';

class IOSDeploy {
  constructor(udid) {
    this.udid = udid;
  }

  async remove(bundleid) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);

    try {
      await service.uninstallApplication(bundleid);
    } finally {
      service.close();
    }
  }

  async removeApp(bundleId) {
    await this.remove(bundleId);
  }

  async install(app, timeout) {
    const start = process.hrtime();

    try {
      const bundlePathOnPhone = await this.pushAppBundle(app, timeout);
      await this.installApplication(bundlePathOnPhone);
    } catch (e) {
      _logger.default.warn(`Falling back to ${IOS_DEPLOY} usage`, e);

      try {
        await _appiumSupport.fs.which(IOS_DEPLOY);
      } catch (e1) {
        throw new Error(`Could not install '${app}':\n` + `  - ${e.message}\n` + `  - ${IOS_DEPLOY} utility has not been found in PATH. Is it installed?`);
      }

      try {
        await (0, _teen_process.exec)(IOS_DEPLOY, ['--id', this.udid, '--bundle', app]);
      } catch (e1) {
        throw new Error(`Could not install '${app}':\n` + `  - ${e.message}\n` + `  - ${e1.stderr || e1.stdout || e1.message}`);
      }
    }

    const [seconds, nanos] = process.hrtime(start);

    _logger.default.info(`App installation succeeded after ${(seconds + nanos / 1e9).toFixed(3)}s`);
  }

  async installApplication(bundlePathOnPhone) {
    const notificationService = await _appiumIosDevice.services.startNotificationProxyService(this.udid);
    const installationService = await _appiumIosDevice.services.startInstallationProxyService(this.udid);
    const appInstalledNotification = new _bluebird.default(resolve => {
      notificationService.observeNotification(APPLICATION_INSTALLED_NOTIFICATION, {
        notification: resolve
      });
    });

    try {
      await installationService.installApplication(bundlePathOnPhone, {
        PackageType: 'Developer'
      });

      try {
        await appInstalledNotification.timeout(APPLICATION_NOTIFICATION_TIMEOUT, `Couldn't get the application installed notification within ${APPLICATION_NOTIFICATION_TIMEOUT}ms but we will continue`);
      } catch (e) {
        _logger.default.warn(`Failed to receive the notification. Error: ${e.message}`);
      }
    } finally {
      installationService.close();
      notificationService.close();
    }
  }

  async pushAppBundle(app, timeout = DEFAULT_ITEM_PUSH_TIMEOUT) {
    const start = new Date();
    const afcService = await _appiumIosDevice.services.startAfcService(this.udid);

    try {
      const bundlePathOnPhone = await this.createAppPath(afcService, app);
      await _appiumSupport.fs.walkDir(app, true, async (itemPath, isDir) => {
        const pathOnPhone = _path.default.join(bundlePathOnPhone, _path.default.relative(app, itemPath));

        if (isDir) {
          await afcService.createDirectory(pathOnPhone);
        } else {
          const readStream = _appiumSupport.fs.createReadStream(itemPath, {
            autoClose: true
          });

          const writeStream = await afcService.createWriteStream(pathOnPhone, {
            autoDestroy: true
          });
          writeStream.on('finish', writeStream.destroy);
          const itemPushWait = new _bluebird.default((resolve, reject) => {
            writeStream.on('close', resolve);
            writeStream.on('error', reject);
          });
          readStream.pipe(writeStream);
          await itemPushWait.timeout(timeout, `Couldn't push '${itemPath}' within the timeout of ${timeout}ms. ` + `Consider increasing the value of 'appPushTimeout' capability.`);
        }
      });

      _logger.default.debug(`Pushed the app files successfully after ${new Date() - start}ms`);

      return bundlePathOnPhone;
    } finally {
      afcService.close();
    }
  }

  async createAppPath(afcService, localAppPath) {
    const basename = _path.default.basename(localAppPath);

    const relativePath = _path.default.join(INSTALLATION_STAGING_DIR, basename);

    try {
      await afcService.deleteDirectory(relativePath);
    } catch (ign) {}

    await afcService.createDirectory(relativePath);
    return relativePath;
  }

  async installApp(app, timeout) {
    await this.install(app, timeout);
  }

  async isAppInstalled(bundleid) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);

    try {
      const applications = await service.lookupApplications({
        bundleIds: bundleid
      });
      return !!applications[bundleid];
    } finally {
      service.close();
    }
  }

  async getUserInstalledBundleIdsByBundleName(bundleName) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);

    try {
      const applications = await service.listApplications({
        applicationType: 'User'
      });
      return _lodash.default.reduce(applications, (acc, {
        CFBundleName
      }, key) => {
        if (CFBundleName === bundleName) {
          acc.push(key);
        }

        return acc;
      }, []);
    } finally {
      service.close();
    }
  }

  async getPlatformVersion() {
    return await _appiumIosDevice.utilities.getOSVersion(this.udid);
  }

}

var _default = IOSDeploy;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pb3MtZGVwbG95LmpzIl0sIm5hbWVzIjpbIkFQUExJQ0FUSU9OX0lOU1RBTExFRF9OT1RJRklDQVRJT04iLCJJTlNUQUxMQVRJT05fU1RBR0lOR19ESVIiLCJERUZBVUxUX0lURU1fUFVTSF9USU1FT1VUIiwiQVBQTElDQVRJT05fTk9USUZJQ0FUSU9OX1RJTUVPVVQiLCJJT1NfREVQTE9ZIiwiSU9TRGVwbG95IiwiY29uc3RydWN0b3IiLCJ1ZGlkIiwicmVtb3ZlIiwiYnVuZGxlaWQiLCJzZXJ2aWNlIiwic2VydmljZXMiLCJzdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSIsInVuaW5zdGFsbEFwcGxpY2F0aW9uIiwiY2xvc2UiLCJyZW1vdmVBcHAiLCJidW5kbGVJZCIsImluc3RhbGwiLCJhcHAiLCJ0aW1lb3V0Iiwic3RhcnQiLCJwcm9jZXNzIiwiaHJ0aW1lIiwiYnVuZGxlUGF0aE9uUGhvbmUiLCJwdXNoQXBwQnVuZGxlIiwiaW5zdGFsbEFwcGxpY2F0aW9uIiwiZSIsImxvZyIsIndhcm4iLCJmcyIsIndoaWNoIiwiZTEiLCJFcnJvciIsIm1lc3NhZ2UiLCJzdGRlcnIiLCJzdGRvdXQiLCJzZWNvbmRzIiwibmFub3MiLCJpbmZvIiwidG9GaXhlZCIsIm5vdGlmaWNhdGlvblNlcnZpY2UiLCJzdGFydE5vdGlmaWNhdGlvblByb3h5U2VydmljZSIsImluc3RhbGxhdGlvblNlcnZpY2UiLCJhcHBJbnN0YWxsZWROb3RpZmljYXRpb24iLCJCIiwicmVzb2x2ZSIsIm9ic2VydmVOb3RpZmljYXRpb24iLCJub3RpZmljYXRpb24iLCJQYWNrYWdlVHlwZSIsIkRhdGUiLCJhZmNTZXJ2aWNlIiwic3RhcnRBZmNTZXJ2aWNlIiwiY3JlYXRlQXBwUGF0aCIsIndhbGtEaXIiLCJpdGVtUGF0aCIsImlzRGlyIiwicGF0aE9uUGhvbmUiLCJwYXRoIiwiam9pbiIsInJlbGF0aXZlIiwiY3JlYXRlRGlyZWN0b3J5IiwicmVhZFN0cmVhbSIsImNyZWF0ZVJlYWRTdHJlYW0iLCJhdXRvQ2xvc2UiLCJ3cml0ZVN0cmVhbSIsImNyZWF0ZVdyaXRlU3RyZWFtIiwiYXV0b0Rlc3Ryb3kiLCJvbiIsImRlc3Ryb3kiLCJpdGVtUHVzaFdhaXQiLCJyZWplY3QiLCJwaXBlIiwiZGVidWciLCJsb2NhbEFwcFBhdGgiLCJiYXNlbmFtZSIsInJlbGF0aXZlUGF0aCIsImRlbGV0ZURpcmVjdG9yeSIsImlnbiIsImluc3RhbGxBcHAiLCJpc0FwcEluc3RhbGxlZCIsImFwcGxpY2F0aW9ucyIsImxvb2t1cEFwcGxpY2F0aW9ucyIsImJ1bmRsZUlkcyIsImdldFVzZXJJbnN0YWxsZWRCdW5kbGVJZHNCeUJ1bmRsZU5hbWUiLCJidW5kbGVOYW1lIiwibGlzdEFwcGxpY2F0aW9ucyIsImFwcGxpY2F0aW9uVHlwZSIsIl8iLCJyZWR1Y2UiLCJhY2MiLCJDRkJ1bmRsZU5hbWUiLCJrZXkiLCJwdXNoIiwiZ2V0UGxhdGZvcm1WZXJzaW9uIiwidXRpbGl0aWVzIiwiZ2V0T1NWZXJzaW9uIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLGtDQUFrQyxHQUFHLHdDQUEzQztBQUNBLE1BQU1DLHdCQUF3QixHQUFHLGVBQWpDO0FBQ0EsTUFBTUMseUJBQXlCLEdBQUcsS0FBSyxJQUF2QztBQUNBLE1BQU1DLGdDQUFnQyxHQUFHLEtBQUssSUFBOUM7QUFDQSxNQUFNQyxVQUFVLEdBQUcsWUFBbkI7O0FBRUEsTUFBTUMsU0FBTixDQUFnQjtBQUVkQyxFQUFBQSxXQUFXLENBQUVDLElBQUYsRUFBUTtBQUNqQixTQUFLQSxJQUFMLEdBQVlBLElBQVo7QUFDRDs7QUFFRCxRQUFNQyxNQUFOLENBQWNDLFFBQWQsRUFBd0I7QUFDdEIsVUFBTUMsT0FBTyxHQUFHLE1BQU1DLDBCQUFTQyw2QkFBVCxDQUF1QyxLQUFLTCxJQUE1QyxDQUF0Qjs7QUFDQSxRQUFJO0FBQ0YsWUFBTUcsT0FBTyxDQUFDRyxvQkFBUixDQUE2QkosUUFBN0IsQ0FBTjtBQUNELEtBRkQsU0FFVTtBQUNSQyxNQUFBQSxPQUFPLENBQUNJLEtBQVI7QUFDRDtBQUNGOztBQUVELFFBQU1DLFNBQU4sQ0FBaUJDLFFBQWpCLEVBQTJCO0FBQ3pCLFVBQU0sS0FBS1IsTUFBTCxDQUFZUSxRQUFaLENBQU47QUFDRDs7QUFFRCxRQUFNQyxPQUFOLENBQWVDLEdBQWYsRUFBb0JDLE9BQXBCLEVBQTZCO0FBQzNCLFVBQU1DLEtBQUssR0FBR0MsT0FBTyxDQUFDQyxNQUFSLEVBQWQ7O0FBQ0EsUUFBSTtBQUNGLFlBQU1DLGlCQUFpQixHQUFHLE1BQU0sS0FBS0MsYUFBTCxDQUFtQk4sR0FBbkIsRUFBd0JDLE9BQXhCLENBQWhDO0FBQ0EsWUFBTSxLQUFLTSxrQkFBTCxDQUF3QkYsaUJBQXhCLENBQU47QUFDRCxLQUhELENBR0UsT0FBT0csQ0FBUCxFQUFVO0FBQ1ZDLHNCQUFJQyxJQUFKLENBQVUsbUJBQWtCeEIsVUFBVyxRQUF2QyxFQUFnRHNCLENBQWhEOztBQUNBLFVBQUk7QUFDRixjQUFNRyxrQkFBR0MsS0FBSCxDQUFTMUIsVUFBVCxDQUFOO0FBQ0QsT0FGRCxDQUVFLE9BQU8yQixFQUFQLEVBQVc7QUFDWCxjQUFNLElBQUlDLEtBQUosQ0FBVyxzQkFBcUJkLEdBQUksTUFBMUIsR0FDYixPQUFNUSxDQUFDLENBQUNPLE9BQVEsSUFESCxHQUViLE9BQU03QixVQUFXLHVEQUZkLENBQU47QUFHRDs7QUFDRCxVQUFJO0FBQ0YsY0FBTSx3QkFBS0EsVUFBTCxFQUFpQixDQUNyQixNQURxQixFQUNiLEtBQUtHLElBRFEsRUFFckIsVUFGcUIsRUFFVFcsR0FGUyxDQUFqQixDQUFOO0FBSUQsT0FMRCxDQUtFLE9BQU9hLEVBQVAsRUFBVztBQUNYLGNBQU0sSUFBSUMsS0FBSixDQUFXLHNCQUFxQmQsR0FBSSxNQUExQixHQUNiLE9BQU1RLENBQUMsQ0FBQ08sT0FBUSxJQURILEdBRWIsT0FBTUYsRUFBRSxDQUFDRyxNQUFILElBQWFILEVBQUUsQ0FBQ0ksTUFBaEIsSUFBMEJKLEVBQUUsQ0FBQ0UsT0FBUSxFQUZ4QyxDQUFOO0FBR0Q7QUFDRjs7QUFDRCxVQUFNLENBQUNHLE9BQUQsRUFBVUMsS0FBVixJQUFtQmhCLE9BQU8sQ0FBQ0MsTUFBUixDQUFlRixLQUFmLENBQXpCOztBQUNBTyxvQkFBSVcsSUFBSixDQUFVLG9DQUFtQyxDQUFDRixPQUFPLEdBQUdDLEtBQUssR0FBRyxHQUFuQixFQUF3QkUsT0FBeEIsQ0FBZ0MsQ0FBaEMsQ0FBbUMsR0FBaEY7QUFDRDs7QUFFRCxRQUFNZCxrQkFBTixDQUEwQkYsaUJBQTFCLEVBQTZDO0FBQzNDLFVBQU1pQixtQkFBbUIsR0FBRyxNQUFNN0IsMEJBQVM4Qiw2QkFBVCxDQUF1QyxLQUFLbEMsSUFBNUMsQ0FBbEM7QUFDQSxVQUFNbUMsbUJBQW1CLEdBQUcsTUFBTS9CLDBCQUFTQyw2QkFBVCxDQUF1QyxLQUFLTCxJQUE1QyxDQUFsQztBQUNBLFVBQU1vQyx3QkFBd0IsR0FBRyxJQUFJQyxpQkFBSixDQUFPQyxPQUFELElBQWE7QUFDbERMLE1BQUFBLG1CQUFtQixDQUFDTSxtQkFBcEIsQ0FBd0M5QyxrQ0FBeEMsRUFBNEU7QUFBRStDLFFBQUFBLFlBQVksRUFBRUY7QUFBaEIsT0FBNUU7QUFDRCxLQUZnQyxDQUFqQzs7QUFHQSxRQUFJO0FBQ0YsWUFBTUgsbUJBQW1CLENBQUNqQixrQkFBcEIsQ0FBdUNGLGlCQUF2QyxFQUEwRDtBQUFFeUIsUUFBQUEsV0FBVyxFQUFFO0FBQWYsT0FBMUQsQ0FBTjs7QUFDQSxVQUFJO0FBQ0YsY0FBTUwsd0JBQXdCLENBQUN4QixPQUF6QixDQUFpQ2hCLGdDQUFqQyxFQUFvRSw4REFBNkRBLGdDQUFpQyx5QkFBbEssQ0FBTjtBQUNELE9BRkQsQ0FFRSxPQUFPdUIsQ0FBUCxFQUFVO0FBQ1ZDLHdCQUFJQyxJQUFKLENBQVUsOENBQTZDRixDQUFDLENBQUNPLE9BQVEsRUFBakU7QUFDRDtBQUNGLEtBUEQsU0FPVTtBQUNSUyxNQUFBQSxtQkFBbUIsQ0FBQzVCLEtBQXBCO0FBQ0EwQixNQUFBQSxtQkFBbUIsQ0FBQzFCLEtBQXBCO0FBQ0Q7QUFDRjs7QUFFRCxRQUFNVSxhQUFOLENBQXFCTixHQUFyQixFQUEwQkMsT0FBTyxHQUFHakIseUJBQXBDLEVBQStEO0FBQzdELFVBQU1rQixLQUFLLEdBQUcsSUFBSTZCLElBQUosRUFBZDtBQUNBLFVBQU1DLFVBQVUsR0FBRyxNQUFNdkMsMEJBQVN3QyxlQUFULENBQXlCLEtBQUs1QyxJQUE5QixDQUF6Qjs7QUFFQSxRQUFJO0FBQ0YsWUFBTWdCLGlCQUFpQixHQUFHLE1BQU0sS0FBSzZCLGFBQUwsQ0FBbUJGLFVBQW5CLEVBQStCaEMsR0FBL0IsQ0FBaEM7QUFDQSxZQUFNVyxrQkFBR3dCLE9BQUgsQ0FBV25DLEdBQVgsRUFBZ0IsSUFBaEIsRUFBc0IsT0FBT29DLFFBQVAsRUFBaUJDLEtBQWpCLEtBQTJCO0FBQ3JELGNBQU1DLFdBQVcsR0FBR0MsY0FBS0MsSUFBTCxDQUFVbkMsaUJBQVYsRUFBNkJrQyxjQUFLRSxRQUFMLENBQWN6QyxHQUFkLEVBQW1Cb0MsUUFBbkIsQ0FBN0IsQ0FBcEI7O0FBQ0EsWUFBSUMsS0FBSixFQUFXO0FBQ1QsZ0JBQU1MLFVBQVUsQ0FBQ1UsZUFBWCxDQUEyQkosV0FBM0IsQ0FBTjtBQUNELFNBRkQsTUFFTztBQUNMLGdCQUFNSyxVQUFVLEdBQUdoQyxrQkFBR2lDLGdCQUFILENBQW9CUixRQUFwQixFQUE4QjtBQUFDUyxZQUFBQSxTQUFTLEVBQUU7QUFBWixXQUE5QixDQUFuQjs7QUFDQSxnQkFBTUMsV0FBVyxHQUFHLE1BQU1kLFVBQVUsQ0FBQ2UsaUJBQVgsQ0FBNkJULFdBQTdCLEVBQTBDO0FBQUNVLFlBQUFBLFdBQVcsRUFBRTtBQUFkLFdBQTFDLENBQTFCO0FBQ0FGLFVBQUFBLFdBQVcsQ0FBQ0csRUFBWixDQUFlLFFBQWYsRUFBeUJILFdBQVcsQ0FBQ0ksT0FBckM7QUFDQSxnQkFBTUMsWUFBWSxHQUFHLElBQUl6QixpQkFBSixDQUFNLENBQUNDLE9BQUQsRUFBVXlCLE1BQVYsS0FBcUI7QUFDOUNOLFlBQUFBLFdBQVcsQ0FBQ0csRUFBWixDQUFlLE9BQWYsRUFBd0J0QixPQUF4QjtBQUNBbUIsWUFBQUEsV0FBVyxDQUFDRyxFQUFaLENBQWUsT0FBZixFQUF3QkcsTUFBeEI7QUFDRCxXQUhvQixDQUFyQjtBQUlBVCxVQUFBQSxVQUFVLENBQUNVLElBQVgsQ0FBZ0JQLFdBQWhCO0FBQ0EsZ0JBQU1LLFlBQVksQ0FBQ2xELE9BQWIsQ0FBcUJBLE9BQXJCLEVBQ0gsa0JBQWlCbUMsUUFBUywyQkFBMEJuQyxPQUFRLE1BQTdELEdBQ0MsK0RBRkcsQ0FBTjtBQUdEO0FBQ0YsT0FqQkssQ0FBTjs7QUFrQkFRLHNCQUFJNkMsS0FBSixDQUFXLDJDQUEwQyxJQUFJdkIsSUFBSixLQUFhN0IsS0FBTSxJQUF4RTs7QUFDQSxhQUFPRyxpQkFBUDtBQUNELEtBdEJELFNBc0JVO0FBQ1IyQixNQUFBQSxVQUFVLENBQUNwQyxLQUFYO0FBQ0Q7QUFDRjs7QUFFRCxRQUFNc0MsYUFBTixDQUFxQkYsVUFBckIsRUFBaUN1QixZQUFqQyxFQUErQztBQUM3QyxVQUFNQyxRQUFRLEdBQUdqQixjQUFLaUIsUUFBTCxDQUFjRCxZQUFkLENBQWpCOztBQUNBLFVBQU1FLFlBQVksR0FBR2xCLGNBQUtDLElBQUwsQ0FBVXpELHdCQUFWLEVBQW9DeUUsUUFBcEMsQ0FBckI7O0FBQ0EsUUFBSTtBQUNGLFlBQU14QixVQUFVLENBQUMwQixlQUFYLENBQTJCRCxZQUEzQixDQUFOO0FBQ0QsS0FGRCxDQUVFLE9BQU9FLEdBQVAsRUFBWSxDQUFFOztBQUNoQixVQUFNM0IsVUFBVSxDQUFDVSxlQUFYLENBQTJCZSxZQUEzQixDQUFOO0FBQ0EsV0FBT0EsWUFBUDtBQUNEOztBQUVELFFBQU1HLFVBQU4sQ0FBa0I1RCxHQUFsQixFQUF1QkMsT0FBdkIsRUFBZ0M7QUFDOUIsVUFBTSxLQUFLRixPQUFMLENBQWFDLEdBQWIsRUFBa0JDLE9BQWxCLENBQU47QUFDRDs7QUFjRCxRQUFNNEQsY0FBTixDQUFzQnRFLFFBQXRCLEVBQWdDO0FBQzlCLFVBQU1DLE9BQU8sR0FBRyxNQUFNQywwQkFBU0MsNkJBQVQsQ0FBdUMsS0FBS0wsSUFBNUMsQ0FBdEI7O0FBQ0EsUUFBSTtBQUNGLFlBQU15RSxZQUFZLEdBQUcsTUFBTXRFLE9BQU8sQ0FBQ3VFLGtCQUFSLENBQTJCO0FBQUVDLFFBQUFBLFNBQVMsRUFBRXpFO0FBQWIsT0FBM0IsQ0FBM0I7QUFDQSxhQUFPLENBQUMsQ0FBQ3VFLFlBQVksQ0FBQ3ZFLFFBQUQsQ0FBckI7QUFDRCxLQUhELFNBR1U7QUFDUkMsTUFBQUEsT0FBTyxDQUFDSSxLQUFSO0FBQ0Q7QUFDRjs7QUFRRCxRQUFNcUUscUNBQU4sQ0FBNkNDLFVBQTdDLEVBQXlEO0FBQ3ZELFVBQU0xRSxPQUFPLEdBQUcsTUFBTUMsMEJBQVNDLDZCQUFULENBQXVDLEtBQUtMLElBQTVDLENBQXRCOztBQUNBLFFBQUk7QUFDRixZQUFNeUUsWUFBWSxHQUFHLE1BQU10RSxPQUFPLENBQUMyRSxnQkFBUixDQUF5QjtBQUFDQyxRQUFBQSxlQUFlLEVBQUU7QUFBbEIsT0FBekIsQ0FBM0I7QUFDQSxhQUFPQyxnQkFBRUMsTUFBRixDQUFTUixZQUFULEVBQXVCLENBQUNTLEdBQUQsRUFBTTtBQUFDQyxRQUFBQTtBQUFELE9BQU4sRUFBc0JDLEdBQXRCLEtBQThCO0FBQzFELFlBQUlELFlBQVksS0FBS04sVUFBckIsRUFBaUM7QUFDL0JLLFVBQUFBLEdBQUcsQ0FBQ0csSUFBSixDQUFTRCxHQUFUO0FBQ0Q7O0FBQ0QsZUFBT0YsR0FBUDtBQUNELE9BTE0sRUFLSixFQUxJLENBQVA7QUFNRCxLQVJELFNBUVU7QUFDUi9FLE1BQUFBLE9BQU8sQ0FBQ0ksS0FBUjtBQUNEO0FBQ0Y7O0FBRUQsUUFBTStFLGtCQUFOLEdBQTRCO0FBQzFCLFdBQU8sTUFBTUMsMkJBQVVDLFlBQVYsQ0FBdUIsS0FBS3hGLElBQTVCLENBQWI7QUFDRDs7QUE3SmE7O2VBZ0tERixTIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzICovXG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgc2VydmljZXMsIHV0aWxpdGllcyB9IGZyb20gJ2FwcGl1bS1pb3MtZGV2aWNlJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuXG5jb25zdCBBUFBMSUNBVElPTl9JTlNUQUxMRURfTk9USUZJQ0FUSU9OID0gJ2NvbS5hcHBsZS5tb2JpbGUuYXBwbGljYXRpb25faW5zdGFsbGVkJztcbmNvbnN0IElOU1RBTExBVElPTl9TVEFHSU5HX0RJUiA9ICdQdWJsaWNTdGFnaW5nJztcbmNvbnN0IERFRkFVTFRfSVRFTV9QVVNIX1RJTUVPVVQgPSAzMCAqIDEwMDA7XG5jb25zdCBBUFBMSUNBVElPTl9OT1RJRklDQVRJT05fVElNRU9VVCA9IDMwICogMTAwMDtcbmNvbnN0IElPU19ERVBMT1kgPSAnaW9zLWRlcGxveSc7XG5cbmNsYXNzIElPU0RlcGxveSB7XG5cbiAgY29uc3RydWN0b3IgKHVkaWQpIHtcbiAgICB0aGlzLnVkaWQgPSB1ZGlkO1xuICB9XG5cbiAgYXN5bmMgcmVtb3ZlIChidW5kbGVpZCkge1xuICAgIGNvbnN0IHNlcnZpY2UgPSBhd2FpdCBzZXJ2aWNlcy5zdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSh0aGlzLnVkaWQpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBzZXJ2aWNlLnVuaW5zdGFsbEFwcGxpY2F0aW9uKGJ1bmRsZWlkKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgc2VydmljZS5jbG9zZSgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHJlbW92ZUFwcCAoYnVuZGxlSWQpIHtcbiAgICBhd2FpdCB0aGlzLnJlbW92ZShidW5kbGVJZCk7XG4gIH1cblxuICBhc3luYyBpbnN0YWxsIChhcHAsIHRpbWVvdXQpIHtcbiAgICBjb25zdCBzdGFydCA9IHByb2Nlc3MuaHJ0aW1lKCk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGJ1bmRsZVBhdGhPblBob25lID0gYXdhaXQgdGhpcy5wdXNoQXBwQnVuZGxlKGFwcCwgdGltZW91dCk7XG4gICAgICBhd2FpdCB0aGlzLmluc3RhbGxBcHBsaWNhdGlvbihidW5kbGVQYXRoT25QaG9uZSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLndhcm4oYEZhbGxpbmcgYmFjayB0byAke0lPU19ERVBMT1l9IHVzYWdlYCwgZSk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBmcy53aGljaChJT1NfREVQTE9ZKTtcbiAgICAgIH0gY2F0Y2ggKGUxKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGluc3RhbGwgJyR7YXBwfSc6XFxuYCArXG4gICAgICAgICAgYCAgLSAke2UubWVzc2FnZX1cXG5gICtcbiAgICAgICAgICBgICAtICR7SU9TX0RFUExPWX0gdXRpbGl0eSBoYXMgbm90IGJlZW4gZm91bmQgaW4gUEFUSC4gSXMgaXQgaW5zdGFsbGVkP2ApO1xuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgZXhlYyhJT1NfREVQTE9ZLCBbXG4gICAgICAgICAgJy0taWQnLCB0aGlzLnVkaWQsXG4gICAgICAgICAgJy0tYnVuZGxlJywgYXBwLFxuICAgICAgICBdKTtcbiAgICAgIH0gY2F0Y2ggKGUxKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGluc3RhbGwgJyR7YXBwfSc6XFxuYCArXG4gICAgICAgICAgYCAgLSAke2UubWVzc2FnZX1cXG5gICtcbiAgICAgICAgICBgICAtICR7ZTEuc3RkZXJyIHx8IGUxLnN0ZG91dCB8fCBlMS5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBbc2Vjb25kcywgbmFub3NdID0gcHJvY2Vzcy5ocnRpbWUoc3RhcnQpO1xuICAgIGxvZy5pbmZvKGBBcHAgaW5zdGFsbGF0aW9uIHN1Y2NlZWRlZCBhZnRlciAkeyhzZWNvbmRzICsgbmFub3MgLyAxZTkpLnRvRml4ZWQoMyl9c2ApO1xuICB9XG5cbiAgYXN5bmMgaW5zdGFsbEFwcGxpY2F0aW9uIChidW5kbGVQYXRoT25QaG9uZSkge1xuICAgIGNvbnN0IG5vdGlmaWNhdGlvblNlcnZpY2UgPSBhd2FpdCBzZXJ2aWNlcy5zdGFydE5vdGlmaWNhdGlvblByb3h5U2VydmljZSh0aGlzLnVkaWQpO1xuICAgIGNvbnN0IGluc3RhbGxhdGlvblNlcnZpY2UgPSBhd2FpdCBzZXJ2aWNlcy5zdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSh0aGlzLnVkaWQpO1xuICAgIGNvbnN0IGFwcEluc3RhbGxlZE5vdGlmaWNhdGlvbiA9IG5ldyBCKChyZXNvbHZlKSA9PiB7XG4gICAgICBub3RpZmljYXRpb25TZXJ2aWNlLm9ic2VydmVOb3RpZmljYXRpb24oQVBQTElDQVRJT05fSU5TVEFMTEVEX05PVElGSUNBVElPTiwgeyBub3RpZmljYXRpb246IHJlc29sdmUgfSk7XG4gICAgfSk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGluc3RhbGxhdGlvblNlcnZpY2UuaW5zdGFsbEFwcGxpY2F0aW9uKGJ1bmRsZVBhdGhPblBob25lLCB7IFBhY2thZ2VUeXBlOiAnRGV2ZWxvcGVyJ30pO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgYXBwSW5zdGFsbGVkTm90aWZpY2F0aW9uLnRpbWVvdXQoQVBQTElDQVRJT05fTk9USUZJQ0FUSU9OX1RJTUVPVVQsIGBDb3VsZG4ndCBnZXQgdGhlIGFwcGxpY2F0aW9uIGluc3RhbGxlZCBub3RpZmljYXRpb24gd2l0aGluICR7QVBQTElDQVRJT05fTk9USUZJQ0FUSU9OX1RJTUVPVVR9bXMgYnV0IHdlIHdpbGwgY29udGludWVgKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nLndhcm4oYEZhaWxlZCB0byByZWNlaXZlIHRoZSBub3RpZmljYXRpb24uIEVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICB9IGZpbmFsbHkge1xuICAgICAgaW5zdGFsbGF0aW9uU2VydmljZS5jbG9zZSgpO1xuICAgICAgbm90aWZpY2F0aW9uU2VydmljZS5jbG9zZSgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHB1c2hBcHBCdW5kbGUgKGFwcCwgdGltZW91dCA9IERFRkFVTFRfSVRFTV9QVVNIX1RJTUVPVVQpIHtcbiAgICBjb25zdCBzdGFydCA9IG5ldyBEYXRlKCk7XG4gICAgY29uc3QgYWZjU2VydmljZSA9IGF3YWl0IHNlcnZpY2VzLnN0YXJ0QWZjU2VydmljZSh0aGlzLnVkaWQpO1xuICAgIC8vIFdlIGFyZSBwdXNoaW5nIHNlcmlhbGx5IGR1ZSB0byB0aGlzIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy8xMzExNS4gVGhlcmUgaXMgbm90aGluZyBlbHNlIHdlIGNhbiBkbyBiZXNpZGVzIHRoaXNcbiAgICB0cnkge1xuICAgICAgY29uc3QgYnVuZGxlUGF0aE9uUGhvbmUgPSBhd2FpdCB0aGlzLmNyZWF0ZUFwcFBhdGgoYWZjU2VydmljZSwgYXBwKTtcbiAgICAgIGF3YWl0IGZzLndhbGtEaXIoYXBwLCB0cnVlLCBhc3luYyAoaXRlbVBhdGgsIGlzRGlyKSA9PiB7XG4gICAgICAgIGNvbnN0IHBhdGhPblBob25lID0gcGF0aC5qb2luKGJ1bmRsZVBhdGhPblBob25lLCBwYXRoLnJlbGF0aXZlKGFwcCwgaXRlbVBhdGgpKTtcbiAgICAgICAgaWYgKGlzRGlyKSB7XG4gICAgICAgICAgYXdhaXQgYWZjU2VydmljZS5jcmVhdGVEaXJlY3RvcnkocGF0aE9uUGhvbmUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IHJlYWRTdHJlYW0gPSBmcy5jcmVhdGVSZWFkU3RyZWFtKGl0ZW1QYXRoLCB7YXV0b0Nsb3NlOiB0cnVlfSk7XG4gICAgICAgICAgY29uc3Qgd3JpdGVTdHJlYW0gPSBhd2FpdCBhZmNTZXJ2aWNlLmNyZWF0ZVdyaXRlU3RyZWFtKHBhdGhPblBob25lLCB7YXV0b0Rlc3Ryb3k6IHRydWUgfSk7XG4gICAgICAgICAgd3JpdGVTdHJlYW0ub24oJ2ZpbmlzaCcsIHdyaXRlU3RyZWFtLmRlc3Ryb3kpO1xuICAgICAgICAgIGNvbnN0IGl0ZW1QdXNoV2FpdCA9IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHdyaXRlU3RyZWFtLm9uKCdjbG9zZScsIHJlc29sdmUpO1xuICAgICAgICAgICAgd3JpdGVTdHJlYW0ub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICByZWFkU3RyZWFtLnBpcGUod3JpdGVTdHJlYW0pO1xuICAgICAgICAgIGF3YWl0IGl0ZW1QdXNoV2FpdC50aW1lb3V0KHRpbWVvdXQsXG4gICAgICAgICAgICBgQ291bGRuJ3QgcHVzaCAnJHtpdGVtUGF0aH0nIHdpdGhpbiB0aGUgdGltZW91dCBvZiAke3RpbWVvdXR9bXMuIGAgK1xuICAgICAgICAgICAgYENvbnNpZGVyIGluY3JlYXNpbmcgdGhlIHZhbHVlIG9mICdhcHBQdXNoVGltZW91dCcgY2FwYWJpbGl0eS5gKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBsb2cuZGVidWcoYFB1c2hlZCB0aGUgYXBwIGZpbGVzIHN1Y2Nlc3NmdWxseSBhZnRlciAke25ldyBEYXRlKCkgLSBzdGFydH1tc2ApO1xuICAgICAgcmV0dXJuIGJ1bmRsZVBhdGhPblBob25lO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBhZmNTZXJ2aWNlLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY3JlYXRlQXBwUGF0aCAoYWZjU2VydmljZSwgbG9jYWxBcHBQYXRoKSB7XG4gICAgY29uc3QgYmFzZW5hbWUgPSBwYXRoLmJhc2VuYW1lKGxvY2FsQXBwUGF0aCk7XG4gICAgY29uc3QgcmVsYXRpdmVQYXRoID0gcGF0aC5qb2luKElOU1RBTExBVElPTl9TVEFHSU5HX0RJUiwgYmFzZW5hbWUpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBhZmNTZXJ2aWNlLmRlbGV0ZURpcmVjdG9yeShyZWxhdGl2ZVBhdGgpO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICBhd2FpdCBhZmNTZXJ2aWNlLmNyZWF0ZURpcmVjdG9yeShyZWxhdGl2ZVBhdGgpO1xuICAgIHJldHVybiByZWxhdGl2ZVBhdGg7XG4gIH1cblxuICBhc3luYyBpbnN0YWxsQXBwIChhcHAsIHRpbWVvdXQpIHtcbiAgICBhd2FpdCB0aGlzLmluc3RhbGwoYXBwLCB0aW1lb3V0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gYW4gYXBwbGljYXRpb24gb2JqZWN0IGlmIHRlc3QgYXBwIGhhcyAnYnVuZGxlaWQnLlxuICAgKiBUaGUgdGFyZ2V0IGJ1bmRsZWlkIGNhbiBiZSBVc2VyIGFuZCBTeXN0ZW0gYXBwcy5cbiAgICogQHBhcmFtIHtzdHJpbmd9IGJ1bmRsZWlkIFRoZSBidW5kbGVJZCB0byBlbnN1cmUgaXQgaXMgaW5zdGFsbGVkXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59IFJldHVybnMgVHJ1ZSBpZiB0aGUgYnVuZGxlaWQgZXhpc3RzIGluIHRoZSByZXN1bHQgb2YgJ2xpc3RBcHBsaWNhdGlvbnMnIGxpa2U6XG4gICAqIHsgXCJjb20uYXBwbGUuUHJlZmVyZW5jZXNcIjp7XG4gICAqICAgXCJVSVJlcXVpcmVkRGV2aWNlQ2FwYWJpbGl0aWVzXCI6W1wiYXJtNjRcIl0sXG4gICAqICAgXCJVSVJlcXVpcmVzRnVsbFNjcmVlblwiOnRydWUsXG4gICAqICAgXCJDRkJ1bmRsZUluZm9EaWN0aW9uYXJ5VmVyc2lvblwiOlwiNi4wXCIsXG4gICAqICAgXCJFbnRpdGxlbWVudHNcIjpcbiAgICogICAgIHtcImNvbS5hcHBsZS5mcm9udGJvYXJkLmRlbGV0ZS1hcHBsaWNhdGlvbi1zbmFwc2hvdHNcIjp0cnVlLC4uXG4gICAqL1xuICBhc3luYyBpc0FwcEluc3RhbGxlZCAoYnVuZGxlaWQpIHtcbiAgICBjb25zdCBzZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgYXBwbGljYXRpb25zID0gYXdhaXQgc2VydmljZS5sb29rdXBBcHBsaWNhdGlvbnMoeyBidW5kbGVJZHM6IGJ1bmRsZWlkIH0pO1xuICAgICAgcmV0dXJuICEhYXBwbGljYXRpb25zW2J1bmRsZWlkXTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgc2VydmljZS5jbG9zZSgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gYnVuZGxlTmFtZSBUaGUgbmFtZSBvZiBDRkJ1bmRsZU5hbWUgaW4gSW5mby5wbGlzdFxuICAgKlxuICAgKiBAcmV0dXJucyB7QXJyYXk8c3RyaW5nPn0gQSBsaXN0IG9mIFVzZXIgbGV2ZWwgYXBwcycgYnVuZGxlIGlkcyB3aGljaCBoYXNcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICdDRkJ1bmRsZU5hbWUnIGF0dHJpYnV0ZSBhcyAnYnVuZGxlTmFtZScuXG4gICAqL1xuICBhc3luYyBnZXRVc2VySW5zdGFsbGVkQnVuZGxlSWRzQnlCdW5kbGVOYW1lIChidW5kbGVOYW1lKSB7XG4gICAgY29uc3Qgc2VydmljZSA9IGF3YWl0IHNlcnZpY2VzLnN0YXJ0SW5zdGFsbGF0aW9uUHJveHlTZXJ2aWNlKHRoaXMudWRpZCk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGFwcGxpY2F0aW9ucyA9IGF3YWl0IHNlcnZpY2UubGlzdEFwcGxpY2F0aW9ucyh7YXBwbGljYXRpb25UeXBlOiAnVXNlcid9KTtcbiAgICAgIHJldHVybiBfLnJlZHVjZShhcHBsaWNhdGlvbnMsIChhY2MsIHtDRkJ1bmRsZU5hbWV9LCBrZXkpID0+IHtcbiAgICAgICAgaWYgKENGQnVuZGxlTmFtZSA9PT0gYnVuZGxlTmFtZSkge1xuICAgICAgICAgIGFjYy5wdXNoKGtleSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0sIFtdKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgc2VydmljZS5jbG9zZSgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldFBsYXRmb3JtVmVyc2lvbiAoKSB7XG4gICAgcmV0dXJuIGF3YWl0IHV0aWxpdGllcy5nZXRPU1ZlcnNpb24odGhpcy51ZGlkKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBJT1NEZXBsb3k7XG4iXSwiZmlsZSI6ImxpYi9pb3MtZGVwbG95LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
