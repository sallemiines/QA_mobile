"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.WebDriverAgent = exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _url2 = _interopRequireDefault(require("url"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("./logger"));

var _noSessionProxy = require("./no-session-proxy");

var _utils = require("./utils");

var _xcodebuild = _interopRequireDefault(require("./xcodebuild"));

var _teen_process = require("teen_process");

var _asyncLock = _interopRequireDefault(require("async-lock"));

var _checkDependencies = require("./check-dependencies");

var _constants = require("./constants");

const WDA_LAUNCH_TIMEOUT = 60 * 1000;
const WDA_AGENT_PORT = 8100;
const WDA_BASE_URL = 'http://localhost';
const WDA_CF_BUNDLE_NAME = 'WebDriverAgentRunner-Runner';
const SHARED_RESOURCES_GUARD = new _asyncLock.default();

class WebDriverAgent {
  constructor(xcodeVersion, args = {}) {
    this.xcodeVersion = xcodeVersion;
    this.args = _lodash.default.clone(args);
    this.device = args.device;
    this.platformVersion = args.platformVersion;
    this.platformName = args.platformName;
    this.iosSdkVersion = args.iosSdkVersion;
    this.host = args.host;
    this.isRealDevice = !!args.realDevice;
    this.idb = (args.device || {}).idb;
    this.setWDAPaths(args.bootstrapPath, args.agentPath);
    this.wdaLocalPort = args.wdaLocalPort;
    this.wdaRemotePort = args.wdaLocalPort || WDA_AGENT_PORT;
    this.wdaBaseUrl = args.wdaBaseUrl || WDA_BASE_URL;
    this.prebuildWDA = args.prebuildWDA;
    this.webDriverAgentUrl = args.webDriverAgentUrl;
    this.started = false;
    this.wdaConnectionTimeout = args.wdaConnectionTimeout;
    this.useCarthageSsl = _lodash.default.isBoolean(args.useCarthageSsl) && args.useCarthageSsl;
    this.useXctestrunFile = args.useXctestrunFile;
    this.usePrebuiltWDA = args.usePrebuiltWDA;
    this.derivedDataPath = args.derivedDataPath;
    this.mjpegServerPort = args.mjpegServerPort;
    this.updatedWDABundleId = args.updatedWDABundleId;
    this.xcodebuild = new _xcodebuild.default(this.xcodeVersion, this.device, {
      platformVersion: this.platformVersion,
      platformName: this.platformName,
      iosSdkVersion: this.iosSdkVersion,
      agentPath: this.agentPath,
      bootstrapPath: this.bootstrapPath,
      realDevice: this.isRealDevice,
      showXcodeLog: args.showXcodeLog,
      xcodeConfigFile: args.xcodeConfigFile,
      xcodeOrgId: args.xcodeOrgId,
      xcodeSigningId: args.xcodeSigningId,
      keychainPath: args.keychainPath,
      keychainPassword: args.keychainPassword,
      useSimpleBuildTest: args.useSimpleBuildTest,
      usePrebuiltWDA: args.usePrebuiltWDA,
      updatedWDABundleId: this.updatedWDABundleId,
      launchTimeout: args.wdaLaunchTimeout || WDA_LAUNCH_TIMEOUT,
      wdaRemotePort: this.wdaRemotePort,
      useXctestrunFile: this.useXctestrunFile,
      derivedDataPath: args.derivedDataPath,
      mjpegServerPort: this.mjpegServerPort
    });
  }

  setWDAPaths(bootstrapPath, agentPath) {
    this.bootstrapPath = bootstrapPath || _constants.BOOTSTRAP_PATH;

    _logger.default.info(`Using WDA path: '${this.bootstrapPath}'`);

    this.agentPath = agentPath || _path.default.resolve(this.bootstrapPath, 'WebDriverAgent.xcodeproj');

    _logger.default.info(`Using WDA agent: '${this.agentPath}'`);
  }

  async cleanupObsoleteProcesses() {
    const obsoletePids = await (0, _utils.getPIDsListeningOnPort)(this.url.port, cmdLine => cmdLine.includes('/WebDriverAgentRunner') && !cmdLine.toLowerCase().includes(this.device.udid.toLowerCase()));

    if (_lodash.default.isEmpty(obsoletePids)) {
      _logger.default.debug(`No obsolete cached processes from previous WDA sessions ` + `listening on port ${this.url.port} have been found`);

      return;
    }

    _logger.default.info(`Detected ${obsoletePids.length} obsolete cached process${obsoletePids.length === 1 ? '' : 'es'} ` + `from previous WDA sessions. Cleaning them up`);

    try {
      await (0, _teen_process.exec)('kill', obsoletePids);
    } catch (e) {
      _logger.default.warn(`Failed to kill obsolete cached process${obsoletePids.length === 1 ? '' : 'es'} '${obsoletePids}'. ` + `Original error: ${e.message}`);
    }
  }

  async isRunning() {
    return !!(await this.getStatus());
  }

  async getStatus() {
    const noSessionProxy = new _noSessionProxy.NoSessionProxy({
      server: this.url.hostname,
      port: this.url.port,
      base: '',
      timeout: 3000
    });

    try {
      return await noSessionProxy.command('/status', 'GET');
    } catch (err) {
      _logger.default.debug(`WDA is not listening at '${this.url.href}'`);

      return null;
    }
  }

  async uninstall() {
    try {
      const bundleIds = await this.device.getUserInstalledBundleIdsByBundleName(WDA_CF_BUNDLE_NAME);

      if (_lodash.default.isEmpty(bundleIds)) {
        _logger.default.debug('No WDAs on the device.');

        return;
      }

      _logger.default.debug(`Uninstalling WDAs: '${bundleIds}'`);

      for (const bundleId of bundleIds) {
        await this.device.removeApp(bundleId);
      }
    } catch (e) {
      _logger.default.warn(`WebDriverAgent uninstall failed. Perhaps, it is already uninstalled? Original error: ${JSON.stringify(e)}`);
    }
  }

  async launch(sessionId) {
    if (this.webDriverAgentUrl) {
      _logger.default.info(`Using provided WebdriverAgent at '${this.webDriverAgentUrl}'`);

      this.url = this.webDriverAgentUrl;
      this.setupProxies(sessionId);
      return await this.getStatus();
    }

    _logger.default.info('Launching WebDriverAgent on the device');

    this.setupProxies(sessionId);

    if (!this.useXctestrunFile && !(await _appiumSupport.fs.exists(this.agentPath))) {
      throw new Error(`Trying to use WebDriverAgent project at '${this.agentPath}' but the ` + 'file does not exist');
    }

    if (this.idb || this.useXctestrunFile || this.derivedDataPath && this.usePrebuiltWDA) {
      _logger.default.info('Skipped WDA dependencies resolution according to the provided capabilities');
    } else {
      const synchronizationKey = _path.default.normalize(this.bootstrapPath);

      await SHARED_RESOURCES_GUARD.acquire(synchronizationKey, async () => {
        const didPerformUpgrade = await (0, _checkDependencies.checkForDependencies)({
          useSsl: this.useCarthageSsl
        });

        if (didPerformUpgrade) {
          await this.xcodebuild.cleanProject();
        }
      });
    }

    await (0, _utils.resetTestProcesses)(this.device.udid, !this.isRealDevice);

    if (this.idb) {
      return await this.startWithIDB();
    }

    await this.xcodebuild.init(this.noSessionProxy);

    if (this.prebuildWDA) {
      await this.xcodebuild.prebuild();
    }

    return await this.xcodebuild.start();
  }

  async startWithIDB() {
    _logger.default.info('Will launch WDA with idb instead of xcodebuild since the corresponding flag is enabled');

    const {
      wdaBundleId,
      testBundleId
    } = await this.prepareWDA();
    const env = {
      USE_PORT: this.wdaRemotePort,
      WDA_PRODUCT_BUNDLE_IDENTIFIER: this.updatedWDABundleId
    };

    if (this.mjpegServerPort) {
      env.MJPEG_SERVER_PORT = this.mjpegServerPort;
    }

    return await this.idb.runXCUITest(wdaBundleId, wdaBundleId, testBundleId, {
      env
    });
  }

  async parseBundleId(wdaBundlePath) {
    const infoPlistPath = _path.default.join(wdaBundlePath, 'Info.plist');

    const infoPlist = await _appiumSupport.plist.parsePlist((await _appiumSupport.fs.readFile(infoPlistPath)));

    if (!infoPlist.CFBundleIdentifier) {
      throw new Error(`Couldn't find bundle id in ${infoPlistPath}`);
    }

    return infoPlist.CFBundleIdentifier;
  }

  async prepareWDA() {
    const wdaBundlePath = await this.fetchWDABundle();
    const wdaBundleId = await this.parseBundleId(wdaBundlePath);

    if (!(await this.device.isAppInstalled(wdaBundleId))) {
      await this.device.installApp(wdaBundlePath);
    }

    const testBundleId = await this.idb.installXCTestBundle(_path.default.join(wdaBundlePath, 'PlugIns', 'WebDriverAgentRunner.xctest'));
    return {
      wdaBundleId,
      testBundleId,
      wdaBundlePath
    };
  }

  async fetchWDABundle() {
    if (!this.derivedDataPath) {
      return await (0, _checkDependencies.bundleWDASim)();
    }

    const wdaBundlePath = await _appiumSupport.fs.walkDir(this.derivedDataPath, true, item => item.endsWith(_constants.WDA_RUNNER_APP));

    if (!wdaBundlePath) {
      throw new Error(`Couldn't find the WDA bundle in the ${this.derivedDataPath}`);
    }

    return wdaBundlePath;
  }

  async isSourceFresh() {
    for (const subPath of [_constants.CARTHAGE_ROOT, 'Resources', `Resources${_path.default.sep}WebDriverAgent.bundle`]) {
      if (!(await _appiumSupport.fs.exists(_path.default.resolve(this.bootstrapPath, subPath)))) {
        return true;
      }
    }

    return false;
  }

  setupProxies(sessionId) {
    const proxyOpts = {
      server: this.url.hostname,
      port: this.url.port,
      base: '',
      timeout: this.wdaConnectionTimeout,
      keepAlive: true
    };
    this.jwproxy = new _appiumBaseDriver.JWProxy(proxyOpts);
    this.jwproxy.sessionId = sessionId;
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    this.noSessionProxy = new _noSessionProxy.NoSessionProxy(proxyOpts);
  }

  async quit() {
    _logger.default.info('Shutting down sub-processes');

    await this.xcodebuild.quit();
    await this.xcodebuild.reset();

    if (this.jwproxy) {
      this.jwproxy.sessionId = null;
    }

    this.started = false;

    if (!this.args.webDriverAgentUrl) {
      this.webDriverAgentUrl = null;
    }
  }

  get url() {
    if (!this._url) {
      const port = this.wdaLocalPort || WDA_AGENT_PORT;

      const {
        protocol,
        hostname
      } = _url2.default.parse(this.wdaBaseUrl || WDA_BASE_URL);

      this._url = _url2.default.parse(`${protocol}//${hostname}:${port}`);
    }

    return this._url;
  }

  set url(_url) {
    this._url = _url2.default.parse(_url);
  }

  get fullyStarted() {
    return this.started;
  }

  set fullyStarted(started = false) {
    this.started = started;
  }

  async retrieveDerivedDataPath() {
    return await this.xcodebuild.retrieveDerivedDataPath();
  }

  async setupCaching() {
    const status = await this.getStatus();

    if (!status || !status.build) {
      _logger.default.debug('WDA is currently not running. There is nothing to cache');

      return;
    }

    const {
      productBundleIdentifier,
      upgradedAt
    } = status.build;

    if (_appiumSupport.util.hasValue(productBundleIdentifier) && _appiumSupport.util.hasValue(this.updatedWDABundleId) && this.updatedWDABundleId !== productBundleIdentifier) {
      _logger.default.info(`Will uninstall running WDA since it has different bundle id. The actual value is '${productBundleIdentifier}'.`);

      return await this.uninstall();
    }

    if (_appiumSupport.util.hasValue(productBundleIdentifier) && !_appiumSupport.util.hasValue(this.updatedWDABundleId) && _constants.WDA_RUNNER_BUNDLE_ID !== productBundleIdentifier) {
      _logger.default.info(`Will uninstall running WDA since its bundle id is not equal to the default value ${_constants.WDA_RUNNER_BUNDLE_ID}`);

      return await this.uninstall();
    }

    const actualUpgradeTimestamp = await (0, _utils.getWDAUpgradeTimestamp)(this.bootstrapPath);

    _logger.default.debug(`Upgrade timestamp of the currently bundled WDA: ${actualUpgradeTimestamp}`);

    _logger.default.debug(`Upgrade timestamp of the WDA on the device: ${upgradedAt}`);

    if (actualUpgradeTimestamp && upgradedAt && _lodash.default.toLower(`${actualUpgradeTimestamp}`) !== _lodash.default.toLower(`${upgradedAt}`)) {
      _logger.default.info('Will uninstall running WDA since it has different version in comparison to the one ' + `which is bundled with appium-xcuitest-driver module (${actualUpgradeTimestamp} != ${upgradedAt})`);

      return await this.uninstall();
    }

    const message = _appiumSupport.util.hasValue(productBundleIdentifier) ? `Will reuse previously cached WDA instance at '${this.url.href}' with '${productBundleIdentifier}'` : `Will reuse previously cached WDA instance at '${this.url.href}'`;

    _logger.default.info(`${message}. Set the wdaLocalPort capability to a value different from ${this.url.port} if this is an undesired behavior.`);

    this.webDriverAgentUrl = this.url.href;
  }

  async quitAndUninstall() {
    await this.quit();
    await this.uninstall();
  }

}

exports.WebDriverAgent = WebDriverAgent;
var _default = WebDriverAgent;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJkcml2ZXJhZ2VudC5qcyJdLCJuYW1lcyI6WyJXREFfTEFVTkNIX1RJTUVPVVQiLCJXREFfQUdFTlRfUE9SVCIsIldEQV9CQVNFX1VSTCIsIldEQV9DRl9CVU5ETEVfTkFNRSIsIlNIQVJFRF9SRVNPVVJDRVNfR1VBUkQiLCJBc3luY0xvY2siLCJXZWJEcml2ZXJBZ2VudCIsImNvbnN0cnVjdG9yIiwieGNvZGVWZXJzaW9uIiwiYXJncyIsIl8iLCJjbG9uZSIsImRldmljZSIsInBsYXRmb3JtVmVyc2lvbiIsInBsYXRmb3JtTmFtZSIsImlvc1Nka1ZlcnNpb24iLCJob3N0IiwiaXNSZWFsRGV2aWNlIiwicmVhbERldmljZSIsImlkYiIsInNldFdEQVBhdGhzIiwiYm9vdHN0cmFwUGF0aCIsImFnZW50UGF0aCIsIndkYUxvY2FsUG9ydCIsIndkYVJlbW90ZVBvcnQiLCJ3ZGFCYXNlVXJsIiwicHJlYnVpbGRXREEiLCJ3ZWJEcml2ZXJBZ2VudFVybCIsInN0YXJ0ZWQiLCJ3ZGFDb25uZWN0aW9uVGltZW91dCIsInVzZUNhcnRoYWdlU3NsIiwiaXNCb29sZWFuIiwidXNlWGN0ZXN0cnVuRmlsZSIsInVzZVByZWJ1aWx0V0RBIiwiZGVyaXZlZERhdGFQYXRoIiwibWpwZWdTZXJ2ZXJQb3J0IiwidXBkYXRlZFdEQUJ1bmRsZUlkIiwieGNvZGVidWlsZCIsIlhjb2RlQnVpbGQiLCJzaG93WGNvZGVMb2ciLCJ4Y29kZUNvbmZpZ0ZpbGUiLCJ4Y29kZU9yZ0lkIiwieGNvZGVTaWduaW5nSWQiLCJrZXljaGFpblBhdGgiLCJrZXljaGFpblBhc3N3b3JkIiwidXNlU2ltcGxlQnVpbGRUZXN0IiwibGF1bmNoVGltZW91dCIsIndkYUxhdW5jaFRpbWVvdXQiLCJCT09UU1RSQVBfUEFUSCIsImxvZyIsImluZm8iLCJwYXRoIiwicmVzb2x2ZSIsImNsZWFudXBPYnNvbGV0ZVByb2Nlc3NlcyIsIm9ic29sZXRlUGlkcyIsInVybCIsInBvcnQiLCJjbWRMaW5lIiwiaW5jbHVkZXMiLCJ0b0xvd2VyQ2FzZSIsInVkaWQiLCJpc0VtcHR5IiwiZGVidWciLCJsZW5ndGgiLCJlIiwid2FybiIsIm1lc3NhZ2UiLCJpc1J1bm5pbmciLCJnZXRTdGF0dXMiLCJub1Nlc3Npb25Qcm94eSIsIk5vU2Vzc2lvblByb3h5Iiwic2VydmVyIiwiaG9zdG5hbWUiLCJiYXNlIiwidGltZW91dCIsImNvbW1hbmQiLCJlcnIiLCJocmVmIiwidW5pbnN0YWxsIiwiYnVuZGxlSWRzIiwiZ2V0VXNlckluc3RhbGxlZEJ1bmRsZUlkc0J5QnVuZGxlTmFtZSIsImJ1bmRsZUlkIiwicmVtb3ZlQXBwIiwiSlNPTiIsInN0cmluZ2lmeSIsImxhdW5jaCIsInNlc3Npb25JZCIsInNldHVwUHJveGllcyIsImZzIiwiZXhpc3RzIiwiRXJyb3IiLCJzeW5jaHJvbml6YXRpb25LZXkiLCJub3JtYWxpemUiLCJhY3F1aXJlIiwiZGlkUGVyZm9ybVVwZ3JhZGUiLCJ1c2VTc2wiLCJjbGVhblByb2plY3QiLCJzdGFydFdpdGhJREIiLCJpbml0IiwicHJlYnVpbGQiLCJzdGFydCIsIndkYUJ1bmRsZUlkIiwidGVzdEJ1bmRsZUlkIiwicHJlcGFyZVdEQSIsImVudiIsIlVTRV9QT1JUIiwiV0RBX1BST0RVQ1RfQlVORExFX0lERU5USUZJRVIiLCJNSlBFR19TRVJWRVJfUE9SVCIsInJ1blhDVUlUZXN0IiwicGFyc2VCdW5kbGVJZCIsIndkYUJ1bmRsZVBhdGgiLCJpbmZvUGxpc3RQYXRoIiwiam9pbiIsImluZm9QbGlzdCIsInBsaXN0IiwicGFyc2VQbGlzdCIsInJlYWRGaWxlIiwiQ0ZCdW5kbGVJZGVudGlmaWVyIiwiZmV0Y2hXREFCdW5kbGUiLCJpc0FwcEluc3RhbGxlZCIsImluc3RhbGxBcHAiLCJpbnN0YWxsWENUZXN0QnVuZGxlIiwid2Fsa0RpciIsIml0ZW0iLCJlbmRzV2l0aCIsIldEQV9SVU5ORVJfQVBQIiwiaXNTb3VyY2VGcmVzaCIsInN1YlBhdGgiLCJDQVJUSEFHRV9ST09UIiwic2VwIiwicHJveHlPcHRzIiwia2VlcEFsaXZlIiwiandwcm94eSIsIkpXUHJveHkiLCJwcm94eVJlcVJlcyIsImJpbmQiLCJxdWl0IiwicmVzZXQiLCJfdXJsIiwicHJvdG9jb2wiLCJwYXJzZSIsImZ1bGx5U3RhcnRlZCIsInJldHJpZXZlRGVyaXZlZERhdGFQYXRoIiwic2V0dXBDYWNoaW5nIiwic3RhdHVzIiwiYnVpbGQiLCJwcm9kdWN0QnVuZGxlSWRlbnRpZmllciIsInVwZ3JhZGVkQXQiLCJ1dGlsIiwiaGFzVmFsdWUiLCJXREFfUlVOTkVSX0JVTkRMRV9JRCIsImFjdHVhbFVwZ3JhZGVUaW1lc3RhbXAiLCJ0b0xvd2VyIiwicXVpdEFuZFVuaW5zdGFsbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxrQkFBa0IsR0FBRyxLQUFLLElBQWhDO0FBQ0EsTUFBTUMsY0FBYyxHQUFHLElBQXZCO0FBQ0EsTUFBTUMsWUFBWSxHQUFHLGtCQUFyQjtBQUNBLE1BQU1DLGtCQUFrQixHQUFHLDZCQUEzQjtBQUVBLE1BQU1DLHNCQUFzQixHQUFHLElBQUlDLGtCQUFKLEVBQS9COztBQUVBLE1BQU1DLGNBQU4sQ0FBcUI7QUFDbkJDLEVBQUFBLFdBQVcsQ0FBRUMsWUFBRixFQUFnQkMsSUFBSSxHQUFHLEVBQXZCLEVBQTJCO0FBQ3BDLFNBQUtELFlBQUwsR0FBb0JBLFlBQXBCO0FBRUEsU0FBS0MsSUFBTCxHQUFZQyxnQkFBRUMsS0FBRixDQUFRRixJQUFSLENBQVo7QUFFQSxTQUFLRyxNQUFMLEdBQWNILElBQUksQ0FBQ0csTUFBbkI7QUFDQSxTQUFLQyxlQUFMLEdBQXVCSixJQUFJLENBQUNJLGVBQTVCO0FBQ0EsU0FBS0MsWUFBTCxHQUFvQkwsSUFBSSxDQUFDSyxZQUF6QjtBQUNBLFNBQUtDLGFBQUwsR0FBcUJOLElBQUksQ0FBQ00sYUFBMUI7QUFDQSxTQUFL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QVcsRUFBeEIsQ0FBdkYsRUFBbUg7QUFDakhsRyxzQkFBSUMsSUFBSixDQUFTLHdGQUNOLHdEQUF1RHFHLHNCQUF1QixPQUFNSixVQUFXLEdBRGxHOztBQUVBLGFBQU8sTUFBTSxLQUFLckUsU0FBTCxFQUFiO0FBQ0Q7O0FBRUQsVUFBTVosT0FBTyxHQUFHa0Ysb0JBQUtDLFFBQUwsQ0FBY0gsdUJBQWQsSUFDWCxpREFBZ0QsS0FBSzNGLEdBQUwsQ0FBU3NCLElBQUssV0FBVXFFLHVCQUF3QixHQURyRixHQUVYLGlEQUFnRCxLQUFLM0YsR0FBTCxDQUFTc0IsSUFBSyxHQUZuRTs7QUFHQTVCLG9CQUFJQyxJQUFKLENBQVUsR0FBRWdCLE9BQVEsK0RBQThELEtBQUtYLEdBQUwsQ0FBU0MsSUFBSyxvQ0FBaEc7O0FBQ0EsU0FBSzdCLGlCQUFMLEdBQXlCLEtBQUs0QixHQUFMLENBQVNzQixJQUFsQztBQUNEOztBQUtELFFBQU00RSxnQkFBTixHQUEwQjtBQUN4QixVQUFNLEtBQUtqQixJQUFMLEVBQU47QUFDQSxVQUFNLEtBQUsxRCxTQUFMLEVBQU47QUFDRDs7QUFqWmtCOzs7ZUFvWk54RSxjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHVybCBmcm9tICd1cmwnO1xuaW1wb3J0IHsgSldQcm94eSB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBmcywgdXRpbCwgcGxpc3QgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IE5vU2Vzc2lvblByb3h5IH0gZnJvbSAnLi9uby1zZXNzaW9uLXByb3h5JztcbmltcG9ydCB7IGdldFdEQVVwZ3JhZGVUaW1lc3RhbXAsIHJlc2V0VGVzdFByb2Nlc3NlcywgZ2V0UElEc0xpc3RlbmluZ09uUG9ydCB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IFhjb2RlQnVpbGQgZnJvbSAnLi94Y29kZWJ1aWxkJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IEFzeW5jTG9jayBmcm9tICdhc3luYy1sb2NrJztcbmltcG9ydCB7IGNoZWNrRm9yRGVwZW5kZW5jaWVzLCBidW5kbGVXREFTaW0gfSBmcm9tICcuL2NoZWNrLWRlcGVuZGVuY2llcyc7XG5pbXBvcnQgeyBCT09UU1RSQVBfUEFUSCwgV0RBX1JVTk5FUl9CVU5ETEVfSUQsIENBUlRIQUdFX1JPT1QsIFdEQV9SVU5ORVJfQVBQIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuXG5jb25zdCBXREFfTEFVTkNIX1RJTUVPVVQgPSA2MCAqIDEwMDA7XG5jb25zdCBXREFfQUdFTlRfUE9SVCA9IDgxMDA7XG5jb25zdCBXREFfQkFTRV9VUkwgPSAnaHR0cDovL2xvY2FsaG9zdCc7XG5jb25zdCBXREFfQ0ZfQlVORExFX05BTUUgPSAnV2ViRHJpdmVyQWdlbnRSdW5uZXItUnVubmVyJztcblxuY29uc3QgU0hBUkVEX1JFU09VUkNFU19HVUFSRCA9IG5ldyBBc3luY0xvY2soKTtcblxuY2xhc3MgV2ViRHJpdmVyQWdlbnQge1xuICBjb25zdHJ1Y3RvciAoeGNvZGVWZXJzaW9uLCBhcmdzID0ge30pIHtcbiAgICB0aGlzLnhjb2RlVmVyc2lvbiA9IHhjb2RlVmVyc2lvbjtcblxuICAgIHRoaXMuYXJncyA9IF8uY2xvbmUoYXJncyk7XG5cbiAgICB0aGlzLmRldmljZSA9IGFyZ3MuZGV2aWNlO1xuICAgIHRoaXMucGxhdGZvcm1WZXJzaW9uID0gYXJncy5wbGF0Zm9ybVZlcnNpb247XG4gICAgdGhpcy5wbGF0Zm9ybU5hbWUgPSBhcmdzLnBsYXRmb3JtTmFtZTtcbiAgICB0aGlzLmlvc1Nka1ZlcnNpb24gPSBhcmdzLmlvc1Nka1ZlcnNpb247XG4gICAgdGhpcy5ob3N0ID0gYXJncy5ob3N0O1xuICAgIHRoaXMuaXNSZWFsRGV2aWNlID0gISFhcmdzLnJlYWxEZXZpY2U7XG4gICAgdGhpcy5pZGIgPSAoYXJncy5kZXZpY2UgfHwge30pLmlkYjtcblxuICAgIHRoaXMuc2V0V0RBUGF0aHMoYXJncy5ib290c3RyYXBQYXRoLCBhcmdzLmFnZW50UGF0aCk7XG5cbiAgICB0aGlzLndkYUxvY2FsUG9ydCA9IGFyZ3Mud2RhTG9jYWxQb3J0O1xuICAgIHRoaXMud2RhUmVtb3RlUG9ydCA9IGFyZ3Mud2RhTG9jYWxQb3J0IHx8IFdEQV9BR0VOVF9QT1JUO1xuICAgIHRoaXMud2RhQmFzZVVybCA9IGFyZ3Mud2RhQmFzZVVybCB8fCBXREFfQkFTRV9VUkw7XG5cbiAgICB0aGlzLnByZWJ1aWxkV0RBID0gYXJncy5wcmVidWlsZFdEQTtcblxuICAgIHRoaXMud2ViRHJpdmVyQWdlbnRVcmwgPSBhcmdzLndlYkRyaXZlckFnZW50VXJsO1xuXG4gICAgdGhpcy5zdGFydGVkID0gZmFsc2U7XG5cbiAgICB0aGlzLndkYUNvbm5lY3Rpb25UaW1lb3V0ID0gYXJncy53ZGFDb25uZWN0aW9uVGltZW91dDtcblxuICAgIHRoaXMudXNlQ2FydGhhZ2VTc2wgPSBfLmlzQm9vbGVhbihhcmdzLnVzZUNhcnRoYWdlU3NsKSAmJiBhcmdzLnVzZUNhcnRoYWdlU3NsO1xuXG4gICAgdGhpcy51c2VYY3Rlc3RydW5GaWxlID0gYXJncy51c2VYY3Rlc3RydW5GaWxlO1xuICAgIHRoaXMudXNlUHJlYnVpbHRXREEgPSBhcmdzLnVzZVByZWJ1aWx0V0RBO1xuICAgIHRoaXMuZGVyaXZlZERhdGFQYXRoID0gYXJncy5kZXJpdmVkRGF0YVBhdGg7XG4gICAgdGhpcy5tanBlZ1NlcnZlclBvcnQgPSBhcmdzLm1qcGVnU2VydmVyUG9ydDtcblxuICAgIHRoaXMudXBkYXRlZFdEQUJ1bmRsZUlkID0gYXJncy51cGRhdGVkV0RBQnVuZGxlSWQ7XG5cbiAgICB0aGlzLnhjb2RlYnVpbGQgPSBuZXcgWGNvZGVCdWlsZCh0aGlzLnhjb2RlVmVyc2lvbiwgdGhpcy5kZXZpY2UsIHtcbiAgICAgIHBsYXRmb3JtVmVyc2lvbjogdGhpcy5wbGF0Zm9ybVZlcnNpb24sXG4gICAgICBwbGF0Zm9ybU5hbWU6IHRoaXMucGxhdGZvcm1OYW1lLFxuICAgICAgaW9zU2RrVmVyc2lvbjogdGhpcy5pb3NTZGtWZXJzaW9uLFxuICAgICAgYWdlbnRQYXRoOiB0aGlzLmFnZW50UGF0aCxcbiAgICAgIGJvb3RzdHJhcFBhdGg6IHRoaXMuYm9vdHN0cmFwUGF0aCxcbiAgICAgIHJlYWxEZXZpY2U6IHRoaXMuaXNSZWFsRGV2aWNlLFxuICAgICAgc2hvd1hjb2RlTG9nOiBhcmdzLnNob3dYY29kZUxvZyxcbiAgICAgIHhjb2RlQ29uZmlnRmlsZTogYXJncy54Y29kZUNvbmZpZ0ZpbGUsXG4gICAgICB4Y29kZU9yZ0lkOiBhcmdzLnhjb2RlT3JnSWQsXG4gICAgICB4Y29kZVNpZ25pbmdJZDogYXJncy54Y29kZVNpZ25pbmdJZCxcbiAgICAgIGtleWNoYWluUGF0aDogYXJncy5rZXljaGFpblBhdGgsXG4gICAgICBrZXljaGFpblBhc3N3b3JkOiBhcmdzLmtleWNoYWluUGFzc3dvcmQsXG4gICAgICB1c2VTaW1wbGVCdWlsZFRlc3Q6IGFyZ3MudXNlU2ltcGxlQnVpbGRUZXN0LFxuICAgICAgdXNlUHJlYnVpbHRXREE6IGFyZ3MudXNlUHJlYnVpbHRXREEsXG4gICAgICB1cGRhdGVkV0RBQnVuZGxlSWQ6IHRoaXMudXBkYXRlZFdEQUJ1bmRsZUlkLFxuICAgICAgbGF1bmNoVGltZW91dDogYXJncy53ZGFMYXVuY2hUaW1lb3V0IHx8IFdEQV9MQVVOQ0hfVElNRU9VVCxcbiAgICAgIHdkYVJlbW90ZVBvcnQ6IHRoaXMud2RhUmVtb3RlUG9ydCxcbiAgICAgIHVzZVhjdGVzdHJ1bkZpbGU6IHRoaXMudXNlWGN0ZXN0cnVuRmlsZSxcbiAgICAgIGRlcml2ZWREYXRhUGF0aDogYXJncy5kZXJpdmVkRGF0YVBhdGgsXG4gICAgICBtanBlZ1NlcnZlclBvcnQ6IHRoaXMubWpwZWdTZXJ2ZXJQb3J0LFxuICAgIH0pO1xuICB9XG5cbiAgc2V0V0RBUGF0aHMgKGJvb3RzdHJhcFBhdGgsIGFnZW50UGF0aCkge1xuICAgIC8vIGFsbG93IHRoZSB1c2VyIHRvIHNwZWNpZnkgYSBwbGFjZSBmb3IgV0RBLiBUaGlzIGlzIHVuZG9jdW1lbnRlZCBhbmRcbiAgICAvLyBvbmx5IGhlcmUgZm9yIHRoZSBwdXJwb3NlcyBvZiB0ZXN0aW5nIGRldmVsb3BtZW50IG9mIFdEQVxuICAgIHRoaXMuYm9vdHN0cmFwUGF0aCA9IGJvb3RzdHJhcFBhdGggfHwgQk9PVFNUUkFQX1BBVEg7XG4gICAgbG9nLmluZm8oYFVzaW5nIFdEQSBwYXRoOiAnJHt0aGlzLmJvb3RzdHJhcFBhdGh9J2ApO1xuXG4gICAgLy8gZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkgd2UgbmVlZCB0byBiZSBhYmxlIHRvIHNwZWNpZnkgYWdlbnRQYXRoIHRvb1xuICAgIHRoaXMuYWdlbnRQYXRoID0gYWdlbnRQYXRoIHx8IHBhdGgucmVzb2x2ZSh0aGlzLmJvb3RzdHJhcFBhdGgsICdXZWJEcml2ZXJBZ2VudC54Y29kZXByb2onKTtcbiAgICBsb2cuaW5mbyhgVXNpbmcgV0RBIGFnZW50OiAnJHt0aGlzLmFnZW50UGF0aH0nYCk7XG4gIH1cblxuICBhc3luYyBjbGVhbnVwT2Jzb2xldGVQcm9jZXNzZXMgKCkge1xuICAgIGNvbnN0IG9ic29sZXRlUGlkcyA9IGF3YWl0IGdldFBJRHNMaXN0ZW5pbmdPblBvcnQodGhpcy51cmwucG9ydCxcbiAgICAgIChjbWRMaW5lKSA9PiBjbWRMaW5lLmluY2x1ZGVzKCcvV2ViRHJpdmVyQWdlbnRSdW5uZXInKSAmJlxuICAgICAgICAhY21kTGluZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHRoaXMuZGV2aWNlLnVkaWQudG9Mb3dlckNhc2UoKSkpO1xuXG4gICAgaWYgKF8uaXNFbXB0eShvYnNvbGV0ZVBpZHMpKSB7XG4gICAgICBsb2cuZGVidWcoYE5vIG9ic29sZXRlIGNhY2hlZCBwcm9jZXNzZXMgZnJvbSBwcmV2aW91cyBXREEgc2Vzc2lvbnMgYCArXG4gICAgICAgIGBsaXN0ZW5pbmcgb24gcG9ydCAke3RoaXMudXJsLnBvcnR9IGhhdmUgYmVlbiBmb3VuZGApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxvZy5pbmZvKGBEZXRlY3RlZCAke29ic29sZXRlUGlkcy5sZW5ndGh9IG9ic29sZXRlIGNhY2hlZCBwcm9jZXNzJHtvYnNvbGV0ZVBpZHMubGVuZ3RoID09PSAxID8gJycgOiAnZXMnfSBgICtcbiAgICAgIGBmcm9tIHByZXZpb3VzIFdEQSBzZXNzaW9ucy4gQ2xlYW5pbmcgdGhlbSB1cGApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjKCdraWxsJywgb2Jzb2xldGVQaWRzKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cud2FybihgRmFpbGVkIHRvIGtpbGwgb2Jzb2xldGUgY2FjaGVkIHByb2Nlc3Mke29ic29sZXRlUGlkcy5sZW5ndGggPT09IDEgPyAnJyA6ICdlcyd9ICcke29ic29sZXRlUGlkc30nLiBgICtcbiAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIGJvb2xlYW4gaWYgV0RBIGlzIHJ1bm5pbmcgb3Igbm90XG4gICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgV0RBIGlzIHJ1bm5pbmdcbiAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBpbnZhbGlkIHJlc3BvbnNlIGNvZGUgb3IgYm9keVxuICAgKi9cbiAgYXN5bmMgaXNSdW5uaW5nICgpIHtcbiAgICByZXR1cm4gISEoYXdhaXQgdGhpcy5nZXRTdGF0dXMoKSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIGN1cnJlbnQgcnVubmluZyBXREEncyBzdGF0dXMgbGlrZSBiZWxvd1xuICAgKiB7XG4gICAqICAgXCJzdGF0ZVwiOiBcInN1Y2Nlc3NcIixcbiAgICogICBcIm9zXCI6IHtcbiAgICogICAgIFwibmFtZVwiOiBcImlPU1wiLFxuICAgKiAgICAgXCJ2ZXJzaW9uXCI6IFwiMTEuNFwiLFxuICAgKiAgICAgXCJzZGtWZXJzaW9uXCI6IFwiMTEuM1wiXG4gICAqICAgfSxcbiAgICogICBcImlvc1wiOiB7XG4gICAqICAgICBcInNpbXVsYXRvclZlcnNpb25cIjogXCIxMS40XCIsXG4gICAqICAgICBcImlwXCI6IFwiMTcyLjI1NC45OS4zNFwiXG4gICAqICAgfSxcbiAgICogICBcImJ1aWxkXCI6IHtcbiAgICogICAgIFwidGltZVwiOiBcIkp1biAyNCAyMDE4IDE3OjA4OjIxXCIsXG4gICAqICAgICBcInByb2R1Y3RCdW5kbGVJZGVudGlmaWVyXCI6IFwiY29tLmZhY2Vib29rLldlYkRyaXZlckFnZW50UnVubmVyXCJcbiAgICogICB9XG4gICAqIH1cbiAgICpcbiAgICogQHJldHVybiB7P29iamVjdH0gU3RhdGUgT2JqZWN0XG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgaW52YWxpZCByZXNwb25zZSBjb2RlIG9yIGJvZHlcbiAgICovXG4gIGFzeW5jIGdldFN0YXR1cyAoKSB7XG4gICAgY29uc3Qgbm9TZXNzaW9uUHJveHkgPSBuZXcgTm9TZXNzaW9uUHJveHkoe1xuICAgICAgc2VydmVyOiB0aGlzLnVybC5ob3N0bmFtZSxcbiAgICAgIHBvcnQ6IHRoaXMudXJsLnBvcnQsXG4gICAgICBiYXNlOiAnJyxcbiAgICAgIHRpbWVvdXQ6IDMwMDAsXG4gICAgfSk7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCBub1Nlc3Npb25Qcm94eS5jb21tYW5kKCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmRlYnVnKGBXREEgaXMgbm90IGxpc3RlbmluZyBhdCAnJHt0aGlzLnVybC5ocmVmfSdgKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBVbmluc3RhbGwgV0RBcyBmcm9tIHRoZSB0ZXN0IGRldmljZS5cbiAgICogT3ZlciBYY29kZSAxMSwgbXVsdGlwbGUgV0RBIGNhbiBiZSBpbiB0aGUgZGV2aWNlIHNpbmNlIFhjb2RlIDExIGdlbmVyYXRlcyBkaWZmZXJlbnQgV0RBLlxuICAgKiBBcHBpdW0gZG9lcyBub3QgZXhwZWN0IG11bHRpcGxlIFdEQXMgYXJlIHJ1bm5pbmcgb24gYSBkZXZpY2UuXG4gICAqL1xuICBhc3luYyB1bmluc3RhbGwgKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBidW5kbGVJZHMgPSBhd2FpdCB0aGlzLmRldmljZS5nZXRVc2VySW5zdGFsbGVkQnVuZGxlSWRzQnlCdW5kbGVOYW1lKFdEQV9DRl9CVU5ETEVfTkFNRSk7XG4gICAgICBpZiAoXy5pc0VtcHR5KGJ1bmRsZUlkcykpIHtcbiAgICAgICAgbG9nLmRlYnVnKCdObyBXREFzIG9uIHRoZSBkZXZpY2UuJyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgbG9nLmRlYnVnKGBVbmluc3RhbGxpbmcgV0RBczogJyR7YnVuZGxlSWRzfSdgKTtcbiAgICAgIGZvciAoY29uc3QgYnVuZGxlSWQgb2YgYnVuZGxlSWRzKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZGV2aWNlLnJlbW92ZUFwcChidW5kbGVJZCk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLndhcm4oYFdlYkRyaXZlckFnZW50IHVuaW5zdGFsbCBmYWlsZWQuIFBlcmhhcHMsIGl0IGlzIGFscmVhZHkgdW5pbnN0YWxsZWQ/IE9yaWdpbmFsIGVycm9yOiAke0pTT04uc3RyaW5naWZ5KGUpfWApO1xuICAgIH1cbiAgfVxuXG5cbiAgLyoqXG4gICAqIFJldHVybiBjdXJyZW50IHJ1bm5pbmcgV0RBJ3Mgc3RhdHVzIGxpa2UgYmVsb3cgYWZ0ZXIgbGF1bmNoaW5nIFdEQVxuICAgKiB7XG4gICAqICAgXCJzdGF0ZVwiOiBcInN1Y2Nlc3NcIixcbiAgICogICBcIm9zXCI6IHtcbiAgICogICAgIFwibmFtZVwiOiBcImlPU1wiLFxuICAgKiAgICAgXCJ2ZXJzaW9uXCI6IFwiMTEuNFwiLFxuICAgKiAgICAgXCJzZGtWZXJzaW9uXCI6IFwiMTEuM1wiXG4gICAqICAgfSxcbiAgICogICBcImlvc1wiOiB7XG4gICAqICAgICBcInNpbXVsYXRvclZlcnNpb25cIjogXCIxMS40XCIsXG4gICAqICAgICBcImlwXCI6IFwiMTcyLjI1NC45OS4zNFwiXG4gICAqICAgfSxcbiAgICogICBcImJ1aWxkXCI6IHtcbiAgICogICAgIFwidGltZVwiOiBcIkp1biAyNCAyMDE4IDE3OjA4OjIxXCIsXG4gICAqICAgICBcInByb2R1Y3RCdW5kbGVJZGVudGlmaWVyXCI6IFwiY29tLmZhY2Vib29rLldlYkRyaXZlckFnZW50UnVubmVyXCJcbiAgICogICB9XG4gICAqIH1cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHNlc3Npb25JZCBMYXVuY2ggV0RBIGFuZCBlc3RhYmxpc2ggdGhlIHNlc3Npb24gd2l0aCB0aGlzIHNlc3Npb25JZFxuICAgKiBAcmV0dXJuIHs/b2JqZWN0fSBTdGF0ZSBPYmplY3RcbiAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBpbnZhbGlkIHJlc3BvbnNlIGNvZGUgb3IgYm9keVxuICAgKi9cbiAgYXN5bmMgbGF1bmNoIChzZXNzaW9uSWQpIHtcbiAgICBpZiAodGhpcy53ZWJEcml2ZXJBZ2VudFVybCkge1xuICAgICAgbG9nLmluZm8oYFVzaW5nIHByb3ZpZGVkIFdlYmRyaXZlckFnZW50IGF0ICcke3RoaXMud2ViRHJpdmVyQWdlbnRVcmx9J2ApO1xuICAgICAgdGhpcy51cmwgPSB0aGlzLndlYkRyaXZlckFnZW50VXJsO1xuICAgICAgdGhpcy5zZXR1cFByb3hpZXMoc2Vzc2lvbklkKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFN0YXR1cygpO1xuICAgIH1cblxuICAgIGxvZy5pbmZvKCdMYXVuY2hpbmcgV2ViRHJpdmVyQWdlbnQgb24gdGhlIGRldmljZScpO1xuXG4gICAgdGhpcy5zZXR1cFByb3hpZXMoc2Vzc2lvbklkKTtcblxuICAgIGlmICghdGhpcy51c2VYY3Rlc3RydW5GaWxlICYmICFhd2FpdCBmcy5leGlzdHModGhpcy5hZ2VudFBhdGgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRyeWluZyB0byB1c2UgV2ViRHJpdmVyQWdlbnQgcHJvamVjdCBhdCAnJHt0aGlzLmFnZW50UGF0aH0nIGJ1dCB0aGUgYCArXG4gICAgICAgICAgICAgICAgICAgICAgJ2ZpbGUgZG9lcyBub3QgZXhpc3QnKTtcbiAgICB9XG5cbiAgICAvLyB1c2VYY3Rlc3RydW5GaWxlIGFuZCB1c2VQcmVidWlsdFdEQSB1c2UgZXhpc3RpbmcgZGVwZW5kZW5jaWVzXG4gICAgLy8gSXQgZGVwZW5kcyBvbiB1c2VyIHNpZGVcbiAgICBpZiAodGhpcy5pZGIgfHwgdGhpcy51c2VYY3Rlc3RydW5GaWxlIHx8ICh0aGlzLmRlcml2ZWREYXRhUGF0aCAmJiB0aGlzLnVzZVByZWJ1aWx0V0RBKSkge1xuICAgICAgbG9nLmluZm8oJ1NraXBwZWQgV0RBIGRlcGVuZGVuY2llcyByZXNvbHV0aW9uIGFjY29yZGluZyB0byB0aGUgcHJvdmlkZWQgY2FwYWJpbGl0aWVzJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIG1ha2Ugc3VyZSB0aGF0IHRoZSBXREEgZGVwZW5kZW5jaWVzIGhhdmUgYmVlbiBidWlsdFxuICAgICAgY29uc3Qgc3luY2hyb25pemF0aW9uS2V5ID0gcGF0aC5ub3JtYWxpemUodGhpcy5ib290c3RyYXBQYXRoKTtcbiAgICAgIGF3YWl0IFNIQVJFRF9SRVNPVVJDRVNfR1VBUkQuYWNxdWlyZShzeW5jaHJvbml6YXRpb25LZXksIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgZGlkUGVyZm9ybVVwZ3JhZGUgPSBhd2FpdCBjaGVja0ZvckRlcGVuZGVuY2llcyh7dXNlU3NsOiB0aGlzLnVzZUNhcnRoYWdlU3NsfSk7XG4gICAgICAgIGlmIChkaWRQZXJmb3JtVXBncmFkZSkge1xuICAgICAgICAgIC8vIE9ubHkgcGVyZm9ybSB0aGUgY2xlYW51cCBhZnRlciBXREEgdXBncmFkZVxuICAgICAgICAgIGF3YWl0IHRoaXMueGNvZGVidWlsZC5jbGVhblByb2plY3QoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIC8vIFdlIG5lZWQgdG8gcHJvdmlkZSBXREEgbG9jYWwgcG9ydCwgYmVjYXVzZSBpdCBtaWdodCBiZSBvY2N1cGllZCB3aXRoXG4gICAgYXdhaXQgcmVzZXRUZXN0UHJvY2Vzc2VzKHRoaXMuZGV2aWNlLnVkaWQsICF0aGlzLmlzUmVhbERldmljZSk7XG5cbiAgICBpZiAodGhpcy5pZGIpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnN0YXJ0V2l0aElEQigpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMueGNvZGVidWlsZC5pbml0KHRoaXMubm9TZXNzaW9uUHJveHkpO1xuXG4gICAgLy8gU3RhcnQgdGhlIHhjb2RlYnVpbGQgcHJvY2Vzc1xuICAgIGlmICh0aGlzLnByZWJ1aWxkV0RBKSB7XG4gICAgICBhd2FpdCB0aGlzLnhjb2RlYnVpbGQucHJlYnVpbGQoKTtcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMueGNvZGVidWlsZC5zdGFydCgpO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRXaXRoSURCICgpIHtcbiAgICBsb2cuaW5mbygnV2lsbCBsYXVuY2ggV0RBIHdpdGggaWRiIGluc3RlYWQgb2YgeGNvZGVidWlsZCBzaW5jZSB0aGUgY29ycmVzcG9uZGluZyBmbGFnIGlzIGVuYWJsZWQnKTtcbiAgICBjb25zdCB7d2RhQnVuZGxlSWQsIHRlc3RCdW5kbGVJZH0gPSBhd2FpdCB0aGlzLnByZXBhcmVXREEoKTtcbiAgICBjb25zdCBlbnYgPSB7XG4gICAgICBVU0VfUE9SVDogdGhpcy53ZGFSZW1vdGVQb3J0LFxuICAgICAgV0RBX1BST0RVQ1RfQlVORExFX0lERU5USUZJRVI6IHRoaXMudXBkYXRlZFdEQUJ1bmRsZUlkLFxuICAgIH07XG4gICAgaWYgKHRoaXMubWpwZWdTZXJ2ZXJQb3J0KSB7XG4gICAgICBlbnYuTUpQRUdfU0VSVkVSX1BPUlQgPSB0aGlzLm1qcGVnU2VydmVyUG9ydDtcbiAgICB9XG5cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5pZGIucnVuWENVSVRlc3Qod2RhQnVuZGxlSWQsIHdkYUJ1bmRsZUlkLCB0ZXN0QnVuZGxlSWQsIHtlbnZ9KTtcbiAgfVxuXG4gIGFzeW5jIHBhcnNlQnVuZGxlSWQgKHdkYUJ1bmRsZVBhdGgpIHtcbiAgICBjb25zdCBpbmZvUGxpc3RQYXRoID0gcGF0aC5qb2luKHdkYUJ1bmRsZVBhdGgsICdJbmZvLnBsaXN0Jyk7XG4gICAgY29uc3QgaW5mb1BsaXN0ID0gYXdhaXQgcGxpc3QucGFyc2VQbGlzdChhd2FpdCBmcy5yZWFkRmlsZShpbmZvUGxpc3RQYXRoKSk7XG4gICAgaWYgKCFpbmZvUGxpc3QuQ0ZCdW5kbGVJZGVudGlmaWVyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkbid0IGZpbmQgYnVuZGxlIGlkIGluICR7aW5mb1BsaXN0UGF0aH1gKTtcbiAgICB9XG4gICAgcmV0dXJuIGluZm9QbGlzdC5DRkJ1bmRsZUlkZW50aWZpZXI7XG4gIH1cblxuICBhc3luYyBwcmVwYXJlV0RBICgpIHtcbiAgICBjb25zdCB3ZGFCdW5kbGVQYXRoID0gYXdhaXQgdGhpcy5mZXRjaFdEQUJ1bmRsZSgpO1xuICAgIGNvbnN0IHdkYUJ1bmRsZUlkID0gYXdhaXQgdGhpcy5wYXJzZUJ1bmRsZUlkKHdkYUJ1bmRsZVBhdGgpO1xuICAgIGlmICghYXdhaXQgdGhpcy5kZXZpY2UuaXNBcHBJbnN0YWxsZWQod2RhQnVuZGxlSWQpKSB7XG4gICAgICBhd2FpdCB0aGlzLmRldmljZS5pbnN0YWxsQXBwKHdkYUJ1bmRsZVBhdGgpO1xuICAgIH1cbiAgICBjb25zdCB0ZXN0QnVuZGxlSWQgPSBhd2FpdCB0aGlzLmlkYi5pbnN0YWxsWENUZXN0QnVuZGxlKHBhdGguam9pbih3ZGFCdW5kbGVQYXRoLCAnUGx1Z0lucycsICdXZWJEcml2ZXJBZ2VudFJ1bm5lci54Y3Rlc3QnKSk7XG4gICAgcmV0dXJuIHt3ZGFCdW5kbGVJZCwgdGVzdEJ1bmRsZUlkLCB3ZGFCdW5kbGVQYXRofTtcbiAgfVxuXG4gIGFzeW5jIGZldGNoV0RBQnVuZGxlICgpIHtcbiAgICBpZiAoIXRoaXMuZGVyaXZlZERhdGFQYXRoKSB7XG4gICAgICByZXR1cm4gYXdhaXQgYnVuZGxlV0RBU2ltKCk7XG4gICAgfVxuICAgIGNvbnN0IHdkYUJ1bmRsZVBhdGggPSBhd2FpdCBmcy53YWxrRGlyKHRoaXMuZGVyaXZlZERhdGFQYXRoLCB0cnVlLCAoaXRlbSkgPT4gaXRlbS5lbmRzV2l0aChXREFfUlVOTkVSX0FQUCkpO1xuICAgIGlmICghd2RhQnVuZGxlUGF0aCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZG4ndCBmaW5kIHRoZSBXREEgYnVuZGxlIGluIHRoZSAke3RoaXMuZGVyaXZlZERhdGFQYXRofWApO1xuICAgIH1cbiAgICByZXR1cm4gd2RhQnVuZGxlUGF0aDtcbiAgfVxuXG4gIGFzeW5jIGlzU291cmNlRnJlc2ggKCkge1xuICAgIGZvciAoY29uc3Qgc3ViUGF0aCBvZiBbXG4gICAgICBDQVJUSEFHRV9ST09ULFxuICAgICAgJ1Jlc291cmNlcycsXG4gICAgICBgUmVzb3VyY2VzJHtwYXRoLnNlcH1XZWJEcml2ZXJBZ2VudC5idW5kbGVgLFxuICAgIF0pIHtcbiAgICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHBhdGgucmVzb2x2ZSh0aGlzLmJvb3RzdHJhcFBhdGgsIHN1YlBhdGgpKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgc2V0dXBQcm94aWVzIChzZXNzaW9uSWQpIHtcbiAgICBjb25zdCBwcm94eU9wdHMgPSB7XG4gICAgICBzZXJ2ZXI6IHRoaXMudXJsLmhvc3RuYW1lLFxuICAgICAgcG9ydDogdGhpcy51cmwucG9ydCxcbiAgICAgIGJhc2U6ICcnLFxuICAgICAgdGltZW91dDogdGhpcy53ZGFDb25uZWN0aW9uVGltZW91dCxcbiAgICAgIGtlZXBBbGl2ZTogdHJ1ZSxcbiAgICB9O1xuXG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEpXUHJveHkocHJveHlPcHRzKTtcbiAgICB0aGlzLmp3cHJveHkuc2Vzc2lvbklkID0gc2Vzc2lvbklkO1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xuXG4gICAgdGhpcy5ub1Nlc3Npb25Qcm94eSA9IG5ldyBOb1Nlc3Npb25Qcm94eShwcm94eU9wdHMpO1xuICB9XG5cbiAgYXN5bmMgcXVpdCAoKSB7XG4gICAgbG9nLmluZm8oJ1NodXR0aW5nIGRvd24gc3ViLXByb2Nlc3NlcycpO1xuXG4gICAgYXdhaXQgdGhpcy54Y29kZWJ1aWxkLnF1aXQoKTtcbiAgICBhd2FpdCB0aGlzLnhjb2RlYnVpbGQucmVzZXQoKTtcblxuICAgIGlmICh0aGlzLmp3cHJveHkpIHtcbiAgICAgIHRoaXMuandwcm94eS5zZXNzaW9uSWQgPSBudWxsO1xuICAgIH1cblxuICAgIHRoaXMuc3RhcnRlZCA9IGZhbHNlO1xuXG4gICAgaWYgKCF0aGlzLmFyZ3Mud2ViRHJpdmVyQWdlbnRVcmwpIHtcbiAgICAgIC8vIGlmIHdlIHBvcHVsYXRlZCB0aGUgdXJsIG91cnNlbHZlcyAoZHVyaW5nIGBzZXR1cENhY2hpbmdgIGNhbGwsIGZvciBpbnN0YW5jZSlcbiAgICAgIC8vIHRoZW4gY2xlYW4gdGhhdCB1cC4gSWYgdGhlIHVybCB3YXMgc3VwcGxpZWQsIHdlIHdhbnQgdG8ga2VlcCBpdFxuICAgICAgdGhpcy53ZWJEcml2ZXJBZ2VudFVybCA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgZ2V0IHVybCAoKSB7XG4gICAgaWYgKCF0aGlzLl91cmwpIHtcbiAgICAgIGNvbnN0IHBvcnQgPSB0aGlzLndkYUxvY2FsUG9ydCB8fCBXREFfQUdFTlRfUE9SVDtcbiAgICAgIGNvbnN0IHtwcm90b2NvbCwgaG9zdG5hbWV9ID0gdXJsLnBhcnNlKHRoaXMud2RhQmFzZVVybCB8fCBXREFfQkFTRV9VUkwpO1xuICAgICAgdGhpcy5fdXJsID0gdXJsLnBhcnNlKGAke3Byb3RvY29sfS8vJHtob3N0bmFtZX06JHtwb3J0fWApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fdXJsO1xuICB9XG5cbiAgc2V0IHVybCAoX3VybCkge1xuICAgIHRoaXMuX3VybCA9IHVybC5wYXJzZShfdXJsKTtcbiAgfVxuXG4gIGdldCBmdWxseVN0YXJ0ZWQgKCkge1xuICAgIHJldHVybiB0aGlzLnN0YXJ0ZWQ7XG4gIH1cblxuICBzZXQgZnVsbHlTdGFydGVkIChzdGFydGVkID0gZmFsc2UpIHtcbiAgICB0aGlzLnN0YXJ0ZWQgPSBzdGFydGVkO1xuICB9XG5cbiAgYXN5bmMgcmV0cmlldmVEZXJpdmVkRGF0YVBhdGggKCkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnhjb2RlYnVpbGQucmV0cmlldmVEZXJpdmVkRGF0YVBhdGgoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXVzZSBydW5uaW5nIFdEQSBpZiBpdCBoYXMgdGhlIHNhbWUgYnVuZGxlIGlkIHdpdGggdXBkYXRlZFdEQUJ1bmRsZUlkLlxuICAgKiBPciByZXVzZSBpdCBpZiBpdCBoYXMgdGhlIGRlZmF1bHQgaWQgd2l0aG91dCB1cGRhdGVkV0RBQnVuZGxlSWQuXG4gICAqIFVuaW5zdGFsbCBpdCBpZiB0aGUgbWV0aG9kIGZhY2VzIGFuIGV4Y2VwdGlvbiBmb3IgdGhlIGFib3ZlIHNpdHVhdGlvbi5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVwZGF0ZWRXREFCdW5kbGVJZCBCdW5kbGVJZCB5b3UnZCBsaWtlIHRvIHVzZVxuICAgKi9cbiAgYXN5bmMgc2V0dXBDYWNoaW5nICgpIHtcbiAgICBjb25zdCBzdGF0dXMgPSBhd2FpdCB0aGlzLmdldFN0YXR1cygpO1xuICAgIGlmICghc3RhdHVzIHx8ICFzdGF0dXMuYnVpbGQpIHtcbiAgICAgIGxvZy5kZWJ1ZygnV0RBIGlzIGN1cnJlbnRseSBub3QgcnVubmluZy4gVGhlcmUgaXMgbm90aGluZyB0byBjYWNoZScpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHtcbiAgICAgIHByb2R1Y3RCdW5kbGVJZGVudGlmaWVyLFxuICAgICAgdXBncmFkZWRBdCxcbiAgICB9ID0gc3RhdHVzLmJ1aWxkO1xuICAgIC8vIGZvciByZWFsIGRldmljZVxuICAgIGlmICh1dGlsLmhhc1ZhbHVlKHByb2R1Y3RCdW5kbGVJZGVudGlmaWVyKSAmJiB1dGlsLmhhc1ZhbHVlKHRoaXMudXBkYXRlZFdEQUJ1bmRsZUlkKSAmJiB0aGlzLnVwZGF0ZWRXREFCdW5kbGVJZCAhPT0gcHJvZHVjdEJ1bmRsZUlkZW50aWZpZXIpIHtcbiAgICAgIGxvZy5pbmZvKGBXaWxsIHVuaW5zdGFsbCBydW5uaW5nIFdEQSBzaW5jZSBpdCBoYXMgZGlmZmVyZW50IGJ1bmRsZSBpZC4gVGhlIGFjdHVhbCB2YWx1ZSBpcyAnJHtwcm9kdWN0QnVuZGxlSWRlbnRpZmllcn0nLmApO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudW5pbnN0YWxsKCk7XG4gICAgfVxuICAgIC8vIGZvciBzaW11bGF0b3JcbiAgICBpZiAodXRpbC5oYXNWYWx1ZShwcm9kdWN0QnVuZGxlSWRlbnRpZmllcikgJiYgIXV0aWwuaGFzVmFsdWUodGhpcy51cGRhdGVkV0RBQnVuZGxlSWQpICYmIFdEQV9SVU5ORVJfQlVORExFX0lEICE9PSBwcm9kdWN0QnVuZGxlSWRlbnRpZmllcikge1xuICAgICAgbG9nLmluZm8oYFdpbGwgdW5pbnN0YWxsIHJ1bm5pbmcgV0RBIHNpbmNlIGl0cyBidW5kbGUgaWQgaXMgbm90IGVxdWFsIHRvIHRoZSBkZWZhdWx0IHZhbHVlICR7V0RBX1JVTk5FUl9CVU5ETEVfSUR9YCk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy51bmluc3RhbGwoKTtcbiAgICB9XG5cbiAgICBjb25zdCBhY3R1YWxVcGdyYWRlVGltZXN0YW1wID0gYXdhaXQgZ2V0V0RBVXBncmFkZVRpbWVzdGFtcCh0aGlzLmJvb3RzdHJhcFBhdGgpO1xuICAgIGxvZy5kZWJ1ZyhgVXBncmFkZSB0aW1lc3RhbXAgb2YgdGhlIGN1cnJlbnRseSBidW5kbGVkIFdEQTogJHthY3R1YWxVcGdyYWRlVGltZXN0YW1wfWApO1xuICAgIGxvZy5kZWJ1ZyhgVXBncmFkZSB0aW1lc3RhbXAgb2YgdGhlIFdEQSBvbiB0aGUgZGV2aWNlOiAke3VwZ3JhZGVkQXR9YCk7XG4gICAgaWYgKGFjdHVhbFVwZ3JhZGVUaW1lc3RhbXAgJiYgdXBncmFkZWRBdCAmJiBfLnRvTG93ZXIoYCR7YWN0dWFsVXBncmFkZVRpbWVzdGFtcH1gKSAhPT0gXy50b0xvd2VyKGAke3VwZ3JhZGVkQXR9YCkpIHtcbiAgICAgIGxvZy5pbmZvKCdXaWxsIHVuaW5zdGFsbCBydW5uaW5nIFdEQSBzaW5jZSBpdCBoYXMgZGlmZmVyZW50IHZlcnNpb24gaW4gY29tcGFyaXNvbiB0byB0aGUgb25lICcgK1xuICAgICAgICBgd2hpY2ggaXMgYnVuZGxlZCB3aXRoIGFwcGl1bS14Y3VpdGVzdC1kcml2ZXIgbW9kdWxlICgke2FjdHVhbFVwZ3JhZGVUaW1lc3RhbXB9ICE9ICR7dXBncmFkZWRBdH0pYCk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy51bmluc3RhbGwoKTtcbiAgICB9XG5cbiAgICBjb25zdCBtZXNzYWdlID0gdXRpbC5oYXNWYWx1ZShwcm9kdWN0QnVuZGxlSWRlbnRpZmllcilcbiAgICAgID8gYFdpbGwgcmV1c2UgcHJldmlvdXNseSBjYWNoZWQgV0RBIGluc3RhbmNlIGF0ICcke3RoaXMudXJsLmhyZWZ9JyB3aXRoICcke3Byb2R1Y3RCdW5kbGVJZGVudGlmaWVyfSdgXG4gICAgICA6IGBXaWxsIHJldXNlIHByZXZpb3VzbHkgY2FjaGVkIFdEQSBpbnN0YW5jZSBhdCAnJHt0aGlzLnVybC5ocmVmfSdgO1xuICAgIGxvZy5pbmZvKGAke21lc3NhZ2V9LiBTZXQgdGhlIHdkYUxvY2FsUG9ydCBjYXBhYmlsaXR5IHRvIGEgdmFsdWUgZGlmZmVyZW50IGZyb20gJHt0aGlzLnVybC5wb3J0fSBpZiB0aGlzIGlzIGFuIHVuZGVzaXJlZCBiZWhhdmlvci5gKTtcbiAgICB0aGlzLndlYkRyaXZlckFnZW50VXJsID0gdGhpcy51cmwuaHJlZjtcbiAgfVxuXG4gIC8qKlxuICAgKiBRdWl0IGFuZCB1bmluc3RhbGwgcnVubmluZyBXREEuXG4gICAqL1xuICBhc3luYyBxdWl0QW5kVW5pbnN0YWxsICgpIHtcbiAgICBhd2FpdCB0aGlzLnF1aXQoKTtcbiAgICBhd2FpdCB0aGlzLnVuaW5zdGFsbCgpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFdlYkRyaXZlckFnZW50O1xuZXhwb3J0IHsgV2ViRHJpdmVyQWdlbnQgfTtcbiJdLCJmaWxlIjoibGliL3dlYmRyaXZlcmFnZW50LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
