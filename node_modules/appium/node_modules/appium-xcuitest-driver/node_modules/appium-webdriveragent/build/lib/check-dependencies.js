"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.checkForDependencies = checkForDependencies;
exports.bundleWDASim = bundleWDASim;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _nodeSimctl = require("node-simctl");

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _os = require("os");

var _utils = require("./utils");

var _xcodebuild = _interopRequireDefault(require("./xcodebuild"));

var _constants = require("./constants");

var _logger = _interopRequireDefault(require("./logger"));

const execLogger = {
  logNonEmptyLines(data, fn) {
    data = Buffer.isBuffer(data) ? data.toString() : data;

    for (const line of data.split(_os.EOL)) {
      if (line) {
        fn(line);
      }
    }
  },

  debug(data) {
    this.logNonEmptyLines(data, _logger.default.debug.bind(_logger.default));
  },

  error(data) {
    this.logNonEmptyLines(data, _logger.default.error.bind(_logger.default));
  }

};
const IOS = 'iOS';
const TVOS = 'tvOS';
const CARTHAGE_CMD = 'carthage';
const CARTFILE = 'Cartfile.resolved';

async function hasTvOSSims() {
  const devices = _lodash.default.flatten(Object.values((await (0, _nodeSimctl.getDevices)(null, TVOS))));

  return !_lodash.default.isEmpty(devices);
}

function getCartfileLocations() {
  const cartfile = _path.default.resolve(_constants.BOOTSTRAP_PATH, CARTFILE);

  const installedCartfile = _path.default.resolve(_constants.BOOTSTRAP_PATH, _constants.CARTHAGE_ROOT, CARTFILE);

  return {
    cartfile,
    installedCartfile
  };
}

async function needsUpdate(cartfile, installedCartfile) {
  return !(await (0, _utils.fileCompare)(cartfile, installedCartfile));
}

async function fetchDependencies(useSsl = false) {
  _logger.default.info('Fetching dependencies');

  if (!(await _appiumSupport.fs.which(CARTHAGE_CMD))) {
    _logger.default.errorAndThrow('Please make sure that you have Carthage installed ' + '(https://github.com/Carthage/Carthage), and that it is ' + 'available in the PATH for the environment running Appium');
  }

  const {
    cartfile,
    installedCartfile
  } = getCartfileLocations();

  if (!(await needsUpdate(cartfile, installedCartfile))) {
    _logger.default.info('Dependencies up-to-date');

    return false;
  }

  let platforms = [IOS];

  if (await hasTvOSSims()) {
    platforms.push(TVOS);
  } else {
    _logger.default.debug('tvOS platform will not be included into Carthage bootstrap, because no Simulator devices have been created for it');
  }

  _logger.default.info(`Installing/updating dependencies for platforms ${platforms.map(p => `'${p}'`).join(', ')}`);

  let args = ['bootstrap'];

  if (useSsl) {
    args.push('--use-ssh');
  }

  args.push('--platform', platforms.join(','));

  try {
    await (0, _teen_process.exec)(CARTHAGE_CMD, args, {
      logger: execLogger,
      cwd: _constants.BOOTSTRAP_PATH
    });
  } catch (err) {
    await _appiumSupport.fs.rimraf(_path.default.resolve(_constants.BOOTSTRAP_PATH, _constants.CARTHAGE_ROOT));
    throw err;
  }

  await _appiumSupport.fs.copyFile(cartfile, installedCartfile);

  _logger.default.debug(`Finished fetching dependencies`);

  return true;
}

async function buildWDASim() {
  const args = ['-project', _constants.WDA_PROJECT, '-scheme', _constants.WDA_SCHEME, '-sdk', _constants.SDK_SIMULATOR, 'CODE_SIGN_IDENTITY=""', 'CODE_SIGNING_REQUIRED="NO"', 'GCC_TREAT_WARNINGS_AS_ERRORS=0'];
  await (0, _teen_process.exec)('xcodebuild', args);
}

async function checkForDependencies(opts = {}) {
  return await fetchDependencies(opts.useSsl);
}

async function bundleWDASim(opts) {
  const xcodebuild = new _xcodebuild.default();
  const derivedDataPath = await xcodebuild.retrieveDerivedDataPath();

  const wdaBundlePath = _path.default.join(derivedDataPath, 'Debug-iphonesimulator', _constants.WDA_RUNNER_APP);

  if (await _appiumSupport.fs.exists(wdaBundlePath)) {
    return wdaBundlePath;
  }

  await checkForDependencies(opts);
  await buildWDASim();
  return wdaBundlePath;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jaGVjay1kZXBlbmRlbmNpZXMuanMiXSwibmFtZXMiOlsiZXhlY0xvZ2dlciIsImxvZ05vbkVtcHR5TGluZXMiLCJkYXRhIiwiZm4iLCJCdWZmZXIiLCJpc0J1ZmZlciIsInRvU3RyaW5nIiwibGluZSIsInNwbGl0IiwiRU9MIiwiZGVidWciLCJsb2ciLCJiaW5kIiwiZXJyb3IiLCJJT1MiLCJUVk9TIiwiQ0FSVEhBR0VfQ01EIiwiQ0FSVEZJTEUiLCJoYXNUdk9TU2ltcyIsImRldmljZXMiLCJfIiwiZmxhdHRlbiIsIk9iamVjdCIsInZhbHVlcyIsImlzRW1wdHkiLCJnZXRDYXJ0ZmlsZUxvY2F0aW9ucyIsImNhcnRmaWxlIiwicGF0aCIsInJlc29sdmUiLCJCT09UU1RSQVBfUEFUSCIsImluc3RhbGxlZENhcnRmaWxlIiwiQ0FSVEhBR0VfUk9PVCIsIm5lZWRzVXBkYXRlIiwiZmV0Y2hEZXBlbmRlbmNpZXMiLCJ1c2VTc2wiLCJpbmZvIiwiZnMiLCJ3aGljaCIsImVycm9yQW5kVGhyb3ciLCJwbGF0Zm9ybXMiLCJwdXNoIiwibWFwIiwicCIsImpvaW4iLCJhcmdzIiwibG9nZ2VyIiwiY3dkIiwiZXJyIiwicmltcmFmIiwiY29weUZpbGUiLCJidWlsZFdEQVNpbSIsIldEQV9QUk9KRUNUIiwiV0RBX1NDSEVNRSIsIlNES19TSU1VTEFUT1IiLCJjaGVja0ZvckRlcGVuZGVuY2llcyIsIm9wdHMiLCJidW5kbGVXREFTaW0iLCJ4Y29kZWJ1aWxkIiwiWGNvZGVCdWlsZCIsImRlcml2ZWREYXRhUGF0aCIsInJldHJpZXZlRGVyaXZlZERhdGFQYXRoIiwid2RhQnVuZGxlUGF0aCIsIldEQV9SVU5ORVJfQVBQIiwiZXhpc3RzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFJQTs7QUFHQSxNQUFNQSxVQUFVLEdBQUc7QUFFakJDLEVBQUFBLGdCQUFnQixD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QU1FLFVBQVUsR0FBRyxJQUFJQyxtQkFBSixFQUFuQjtBQUNBLFFBQU1DLGVBQWUsR0FBRyxNQUFNRixVQUFVLENBQUNHLHVCQUFYLEVBQTlCOztBQUNBLFFBQU1DLGFBQWEsR0FBR2xDLGNBQUtnQixJQUFMLENBQVVnQixlQUFWLEVBQTJCLHVCQUEzQixFQUFvREcseUJBQXBELENBQXRCOztBQUNBLE1BQUksTUFBTTFCLGtCQUFHMkIsTUFBSCxDQUFVRixhQUFWLENBQVYsRUFBb0M7QUFDbEMsV0FBT0EsYUFBUDtBQUNEOztBQUNELFFBQU1QLG9CQUFvQixDQUFDQyxJQUFELENBQTFCO0FBQ0EsUUFBTUwsV0FBVyxFQUFqQjtBQUNBLFNBQU9XLGFBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgZ2V0RGV2aWNlcyB9IGZyb20gJ25vZGUtc2ltY3RsJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgRU9MIH0gZnJvbSAnb3MnO1xuaW1wb3J0IHsgZmlsZUNvbXBhcmUgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBYY29kZUJ1aWxkIGZyb20gJy4veGNvZGVidWlsZCc7XG5pbXBvcnQge1xuICBCT09UU1RSQVBfUEFUSCwgV0RBX1BST0pFQ1QsIFdEQV9TQ0hFTUUsIENBUlRIQUdFX1JPT1QsIFNES19TSU1VTEFUT1IsXG4gIFdEQV9SVU5ORVJfQVBQLFxufSBmcm9tICcuL2NvbnN0YW50cyc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcblxuXG5jb25zdCBleGVjTG9nZ2VyID0ge1xuICAvLyBsb2dnZXIgdGhhdCBnZXRzIHJpZCBvZiBlbXB0eSBsaW5lc1xuICBsb2dOb25FbXB0eUxpbmVzIChkYXRhLCBmbikge1xuICAgIGRhdGEgPSBCdWZmZXIuaXNCdWZmZXIoZGF0YSkgPyBkYXRhLnRvU3RyaW5nKCkgOiBkYXRhO1xuICAgIGZvciAoY29uc3QgbGluZSBvZiBkYXRhLnNwbGl0KEVPTCkpIHtcbiAgICAgIGlmIChsaW5lKSB7XG4gICAgICAgIGZuKGxpbmUpO1xuICAgICAgfVxuICAgIH1cbiAgfSxcbiAgZGVidWcgKGRhdGEpIHtcbiAgICB0aGlzLmxvZ05vbkVtcHR5TGluZXMoZGF0YSwgbG9nLmRlYnVnLmJpbmQobG9nKSk7XG4gIH0sXG4gIGVycm9yIChkYXRhKSB7XG4gICAgdGhpcy5sb2dOb25FbXB0eUxpbmVzKGRhdGEsIGxvZy5lcnJvci5iaW5kKGxvZykpO1xuICB9LFxufTtcblxuY29uc3QgSU9TID0gJ2lPUyc7XG5jb25zdCBUVk9TID0gJ3R2T1MnO1xuXG5jb25zdCBDQVJUSEFHRV9DTUQgPSAnY2FydGhhZ2UnO1xuY29uc3QgQ0FSVEZJTEUgPSAnQ2FydGZpbGUucmVzb2x2ZWQnO1xuXG5hc3luYyBmdW5jdGlvbiBoYXNUdk9TU2ltcyAoKSB7XG4gIGNvbnN0IGRldmljZXMgPSBfLmZsYXR0ZW4oT2JqZWN0LnZhbHVlcyhhd2FpdCBnZXREZXZpY2VzKG51bGwsIFRWT1MpKSk7XG4gIHJldHVybiAhXy5pc0VtcHR5KGRldmljZXMpO1xufVxuXG5mdW5jdGlvbiBnZXRDYXJ0ZmlsZUxvY2F0aW9ucyAoKSB7XG4gIGNvbnN0IGNhcnRmaWxlID0gcGF0aC5yZXNvbHZlKEJPT1RTVFJBUF9QQVRILCBDQVJURklMRSk7XG4gIGNvbnN0IGluc3RhbGxlZENhcnRmaWxlID0gcGF0aC5yZXNvbHZlKEJPT1RTVFJBUF9QQVRILCBDQVJUSEFHRV9ST09ULCBDQVJURklMRSk7XG5cbiAgcmV0dXJuIHtcbiAgICBjYXJ0ZmlsZSxcbiAgICBpbnN0YWxsZWRDYXJ0ZmlsZSxcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gbmVlZHNVcGRhdGUgKGNhcnRmaWxlLCBpbnN0YWxsZWRDYXJ0ZmlsZSkge1xuICByZXR1cm4gIWF3YWl0IGZpbGVDb21wYXJlKGNhcnRmaWxlLCBpbnN0YWxsZWRDYXJ0ZmlsZSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZldGNoRGVwZW5kZW5jaWVzICh1c2VTc2wgPSBmYWxzZSkge1xuICBsb2cuaW5mbygnRmV0Y2hpbmcgZGVwZW5kZW5jaWVzJyk7XG4gIGlmICghYXdhaXQgZnMud2hpY2goQ0FSVEhBR0VfQ01EKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdQbGVhc2UgbWFrZSBzdXJlIHRoYXQgeW91IGhhdmUgQ2FydGhhZ2UgaW5zdGFsbGVkICcgK1xuICAgICAgICAgICAgICAgICAgICAgICcoaHR0cHM6Ly9naXRodWIuY29tL0NhcnRoYWdlL0NhcnRoYWdlKSwgYW5kIHRoYXQgaXQgaXMgJyArXG4gICAgICAgICAgICAgICAgICAgICAgJ2F2YWlsYWJsZSBpbiB0aGUgUEFUSCBmb3IgdGhlIGVudmlyb25tZW50IHJ1bm5pbmcgQXBwaXVtJyk7XG4gIH1cblxuICAvLyBjaGVjayB0aGF0IHRoZSBkZXBlbmRlbmNpZXMgZG8gbm90IG5lZWQgdG8gYmUgdXBkYXRlZFxuICBjb25zdCB7XG4gICAgY2FydGZpbGUsXG4gICAgaW5zdGFsbGVkQ2FydGZpbGUsXG4gIH0gPSBnZXRDYXJ0ZmlsZUxvY2F0aW9ucygpO1xuXG4gIGlmICghYXdhaXQgbmVlZHNVcGRhdGUoY2FydGZpbGUsIGluc3RhbGxlZENhcnRmaWxlKSkge1xuICAgIC8vIGZpbGVzIGFyZSBpZGVudGljYWxcbiAgICBsb2cuaW5mbygnRGVwZW5kZW5jaWVzIHVwLXRvLWRhdGUnKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBsZXQgcGxhdGZvcm1zID0gW0lPU107XG4gIGlmIChhd2FpdCBoYXNUdk9TU2ltcygpKSB7XG4gICAgcGxhdGZvcm1zLnB1c2goVFZPUyk7XG4gIH0gZWxzZSB7XG4gICAgbG9nLmRlYnVnKCd0dk9TIHBsYXRmb3JtIHdpbGwgbm90IGJlIGluY2x1ZGVkIGludG8gQ2FydGhhZ2UgYm9vdHN0cmFwLCBiZWNhdXNlIG5vIFNpbXVsYXRvciBkZXZpY2VzIGhhdmUgYmVlbiBjcmVhdGVkIGZvciBpdCcpO1xuICB9XG5cbiAgbG9nLmluZm8oYEluc3RhbGxpbmcvdXBkYXRpbmcgZGVwZW5kZW5jaWVzIGZvciBwbGF0Zm9ybXMgJHtwbGF0Zm9ybXMubWFwKChwKSA9PiBgJyR7cH0nYCkuam9pbignLCAnKX1gKTtcblxuICBsZXQgYXJncyA9IFsnYm9vdHN0cmFwJ107XG4gIGlmICh1c2VTc2wpIHtcbiAgICBhcmdzLnB1c2goJy0tdXNlLXNzaCcpO1xuICB9XG4gIGFyZ3MucHVzaCgnLS1wbGF0Zm9ybScsIHBsYXRmb3Jtcy5qb2luKCcsJykpO1xuICB0cnkge1xuICAgIGF3YWl0IGV4ZWMoQ0FSVEhBR0VfQ01ELCBhcmdzLCB7XG4gICAgICBsb2dnZXI6IGV4ZWNMb2dnZXIsXG4gICAgICBjd2Q6IEJPT1RTVFJBUF9QQVRILFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICAvLyByZW1vdmUgdGhlIGNhcnRoYWdlIGRpcmVjdG9yeSwgb3IgZWxzZSBzdWJzZXF1ZW50IHJ1bnMgd2lsbCBzZWUgaXQgYW5kXG4gICAgLy8gYXNzdW1lIHRoZSBkZXBlbmRlbmNpZXMgYXJlIGFscmVhZHkgZG93bmxvYWRlZFxuICAgIGF3YWl0IGZzLnJpbXJhZihwYXRoLnJlc29sdmUoQk9PVFNUUkFQX1BBVEgsIENBUlRIQUdFX1JPT1QpKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cblxuICAvLyBwdXQgdGhlIHJlc29sdmVkIGNhcnRmaWxlIGludG8gdGhlIENhcnRoYWdlIGRpcmVjdG9yeVxuICBhd2FpdCBmcy5jb3B5RmlsZShjYXJ0ZmlsZSwgaW5zdGFsbGVkQ2FydGZpbGUpO1xuXG4gIGxvZy5kZWJ1ZyhgRmluaXNoZWQgZmV0Y2hpbmcgZGVwZW5kZW5jaWVzYCk7XG4gIHJldHVybiB0cnVlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBidWlsZFdEQVNpbSAoKSB7XG4gIGNvbnN0IGFyZ3MgPSBbXG4gICAgJy1wcm9qZWN0JywgV0RBX1BST0pFQ1QsXG4gICAgJy1zY2hlbWUnLCBXREFfU0NIRU1FLFxuICAgICctc2RrJywgU0RLX1NJTVVMQVRPUixcbiAgICAnQ09ERV9TSUdOX0lERU5USVRZPVwiXCInLFxuICAgICdDT0RFX1NJR05JTkdfUkVRVUlSRUQ9XCJOT1wiJyxcbiAgICAnR0NDX1RSRUFUX1dBUk5JTkdTX0FTX0VSUk9SUz0wJyxcbiAgXTtcbiAgYXdhaXQgZXhlYygneGNvZGVidWlsZCcsIGFyZ3MpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjaGVja0ZvckRlcGVuZGVuY2llcyAob3B0cyA9IHt9KSB7XG4gIHJldHVybiBhd2FpdCBmZXRjaERlcGVuZGVuY2llcyhvcHRzLnVzZVNzbCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGJ1bmRsZVdEQVNpbSAob3B0cykge1xuICBjb25zdCB4Y29kZWJ1aWxkID0gbmV3IFhjb2RlQnVpbGQoKTtcbiAgY29uc3QgZGVyaXZlZERhdGFQYXRoID0gYXdhaXQgeGNvZGVidWlsZC5yZXRyaWV2ZURlcml2ZWREYXRhUGF0aCgpO1xuICBjb25zdCB3ZGFCdW5kbGVQYXRoID0gcGF0aC5qb2luKGRlcml2ZWREYXRhUGF0aCwgJ0RlYnVnLWlwaG9uZXNpbXVsYXRvcicsIFdEQV9SVU5ORVJfQVBQKTtcbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyh3ZGFCdW5kbGVQYXRoKSkge1xuICAgIHJldHVybiB3ZGFCdW5kbGVQYXRoO1xuICB9XG4gIGF3YWl0IGNoZWNrRm9yRGVwZW5kZW5jaWVzKG9wdHMpO1xuICBhd2FpdCBidWlsZFdEQVNpbSgpO1xuICByZXR1cm4gd2RhQnVuZGxlUGF0aDtcbn1cblxuZXhwb3J0IHsgY2hlY2tGb3JEZXBlbmRlbmNpZXMsIGJ1bmRsZVdEQVNpbSB9O1xuIl0sImZpbGUiOiJsaWIvY2hlY2stZGVwZW5kZW5jaWVzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
