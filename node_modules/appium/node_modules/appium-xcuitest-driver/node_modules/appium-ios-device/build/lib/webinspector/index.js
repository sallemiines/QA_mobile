"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.WEB_INSPECTOR_SERVICE_NAME = exports.WebInspectorService = void 0;

require("source-map-support/register");

var _webinspectorDecoder = _interopRequireDefault(require("./transformer/webinspector-decoder"));

var _webinspectorEncoder = _interopRequireDefault(require("./transformer/webinspector-encoder"));

var _plistServiceDecoder = _interopRequireDefault(require("../plist-service/transformer/plist-service-decoder"));

var _plistServiceEncoder = _interopRequireDefault(require("../plist-service/transformer/plist-service-encoder"));

var _lengthBasedSplitter = _interopRequireDefault(require("../util/transformer/length-based-splitter"));

var _streamLogger = _interopRequireDefault(require("../util/transformer/stream-logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _constants = require("../constants");

var _logger = _interopRequireDefault(require("../logger"));

var _baseService = require("../base-service");

const WEB_INSPECTOR_SERVICE_NAME = 'com.apple.webinspector';
exports.WEB_INSPECTOR_SERVICE_NAME = WEB_INSPECTOR_SERVICE_NAME;
const PARTIAL_MESSAGE_SUPPORT_DEPRECATION_VERSION = 11;
const MAX_FRAME_SIZE = 20000000;

class WebInspectorService extends _baseService.BaseServiceSocket {
  constructor(opts = {}) {
    const {
      majorOsVersion,
      isSimulator = false,
      socketChunkSize,
      verbose = false,
      verboseHexDump = false,
      socketClient
    } = opts;
    super(socketClient);

    if (_lodash.default.isFunction(socketClient.setMaxSendFragment) && !_lodash.default.isNil(socketChunkSize) && socketChunkSize > 0) {
      if (socketClient.setMaxSendFragment(socketChunkSize)) {
        _logger.default.debug(`Maximum TLS fragment size set to '${socketChunkSize}'`);
      } else {
        _logger.default.warn(`Unable to set TLS fragment size to '${socketChunkSize}'`);
      }
    }

    this._verbose = verbose;
    this._isSimulator = isSimulator;

    if (!isSimulator && majorOsVersion < PARTIAL_MESSAGE_SUPPORT_DEPRECATION_VERSION) {
      this._initializePartialMessageSupport(verboseHexDump);
    } else {
      this._initializeFullMessageSupport(verboseHexDump);
    }
  }

  _initializeFullMessageSupport(verbose) {
    this._decoder = new _plistServiceDecoder.default();

    this._socketClient.pipe(new _streamLogger.default(_streamLogger.default.RECEIVE, verbose)).pipe(new _lengthBasedSplitter.default(false, MAX_FRAME_SIZE, 0, 4, 4)).pipe(this._decoder);

    this._encoder = new _plistServiceEncoder.default();

    this._encoder.pipe(new _streamLogger.default(_streamLogger.default.SEND, verbose)).pipe(this._socketClient);
  }

  _initializePartialMessageSupport(verbose) {
    this._decoder = new _webinspectorDecoder.default(_constants.MB);

    this._socketClient.pipe(new _streamLogger.default(_streamLogger.default.RECEIVE, verbose)).pipe(new _lengthBasedSplitter.default(false, MAX_FRAME_SIZE, 0, 4, 4)).pipe(new _plistServiceDecoder.default()).pipe(this._decoder);

    this._encoder = new _webinspectorEncoder.default();

    this._encoder.pipe(new _plistServiceEncoder.default()).pipe(new _streamLogger.default(_streamLogger.default.SEND, verbose)).pipe(this._socketClient);
  }

  sendMessage(rpcObject) {
    if (_lodash.default.isNil(rpcObject)) {
      throw new Error('Cannot send a null object');
    }

    if (this._verbose) {
      _logger.default.debug('Sending message to Web Inspector:');

      _logger.default.debug(_appiumSupport.util.jsonStringify(rpcObject));
    }

    this._encoder.write(rpcObject);

    if (!this._isSimulator) {
      this._encoder.write(' ');
    }
  }

  listenMessage(onData) {
    this._decoder.on('data', data => {
      if (this._verbose) {
        _logger.default.debug('Received message from Web Inspector:');

        _logger.default.debug(_appiumSupport.util.jsonStringify(data));
      }

      onData(data);
    });
  }

}

exports.WebInspectorService = WebInspectorService;
var _default = WebInspectorService;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJpbnNwZWN0b3IvaW5kZXguanMiXSwibmFtZXMiOlsiV0VCX0lOU1BFQ1RPUl9TRVJWSUNFX05BTUUiLCJQQVJUSUFMX01FU1NBR0VfU1VQUE9SVF9ERVBSRUNBVElPTl9WRVJTSU9OIiwiTUFYX0ZSQU1FX1NJWkUiLCJXZWJJbnNwZWN0b3JTZXJ2aWNlIiwiQmFzZVNlcnZpY2VTb2NrZXQiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJtYWpvck9zVmVyc2lvbiIsImlzU2ltdWxhdG9yIiwic29ja2V0Q2h1bmtTaXplIiwidmVyYm9zZSIsInZlcmJvc2VIZXhEdW1wIiwic29ja2V0Q2xpZW50IiwiXyIsImlzRnVuY3Rpb24iLCJzZXRNYXhTZW5kRnJhZ21lbnQiLCJpc05pbCIsImxvZyIsImRlYnVnIiwid2FybiIsIl92ZXJib3NlIiwiX2lzU2ltdWxhdG9yIiwiX2luaXRpYWxpemVQYXJ0aWFsTWVzc2FnZVN1cHBvcnQiLCJfaW5pdGlhbGl6ZUZ1bGxNZXNzYWdlU3VwcG9ydCIsIl9kZWNvZGVyIiwiUGxpc3RTZXJ2aWNlRGVjb2RlciIsIl9zb2NrZXRDbGllbnQiLCJwaXBlIiwiU3RyZWFtTG9nZ2VyIiwiUkVDRUlWRSIsIkxlbmd0aEJhc2VkU3BsaXR0ZXIiLCJfZW5jb2RlciIsIlBsaXN0U2VydmljZUVuY29kZXIiLCJTRU5EIiwiV2ViSW5zcGVjdG9yRGVjb2RlciIsIk1CIiwiV2ViSW5zcGVjdG9yRW5jb2RlciIsInNlbmRNZXNzYWdlIiwicnBjT2JqZWN0IiwiRXJyb3IiLCJ1dGlsIiwianNvblN0cmluZ2lmeSIsIndyaXRlIiwibGlzdGVuTWVzc2FnZSIsIm9uRGF0YSIsIm9uIiwiZGF0YSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSwwQkFBMEIsR0FBRyx3QkFBbkM7O0FBRUEsTUFBTUMsMkNBQTJD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QVFzQixTQUFSLENBQUosRUFBd0I7QUFDdEIsWUFBTSxJQUFJQyxLQUFKLENBQVUsMkJBQVYsQ0FBTjtBQUNEOztBQUVELFFBQUksS0FBS25CLFFBQVQsRUFBbUI7QUFDakJILHNCQUFJQyxLQUFKLENBQVUsbUNBQVY7O0FBQ0FELHNCQUFJQyxLQUFKLENBQVVzQixvQkFBS0MsYUFBTCxDQUFtQkgsU0FBbkIsQ0FBVjtBQUNEOztBQUVELFNBQUtQLFFBQUwsQ0FBY1csS0FBZCxDQUFvQkosU0FBcEI7O0FBS0EsUUFBSSxDQUFDLEtBQUtqQixZQUFWLEVBQXdCO0FBQ3RCLFdBQUtVLFFBQUwsQ0FBY1csS0FBZCxDQUFvQixHQUFwQjtBQUNEO0FBQ0Y7O0FBWURDLEVBQUFBLGFBQWEsQ0FBRUMsTUFBRixFQUFVO0FBQ3JCLFNBQUtwQixRQUFMLENBQWNxQixFQUFkLENBQWlCLE1BQWpCLEVBQTBCQyxJQUFELElBQVU7QUFDakMsVUFBSSxLQUFLMUIsUUFBVCxFQUFtQjtBQUNqQkgsd0JBQUlDLEtBQUosQ0FBVSxzQ0FBVjs7QUFDQUQsd0JBQUlDLEtBQUosQ0FBVXNCLG9CQUFLQyxhQUFMLENBQW1CSyxJQUFuQixDQUFWO0FBQ0Q7O0FBQ0RGLE1BQUFBLE1BQU0sQ0FBQ0UsSUFBRCxDQUFOO0FBQ0QsS0FORDtBQU9EOztBQTNIaUQ7OztlQStIckMzQyxtQiIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLWNhbGxiYWNrcyAqL1xuaW1wb3J0IFdlYkluc3BlY3RvckRlY29kZXIgZnJvbSAnLi90cmFuc2Zvcm1lci93ZWJpbnNwZWN0b3ItZGVjb2Rlcic7XG5pbXBvcnQgV2ViSW5zcGVjdG9yRW5jb2RlciBmcm9tICcuL3RyYW5zZm9ybWVyL3dlYmluc3BlY3Rvci1lbmNvZGVyJztcbmltcG9ydCBQbGlzdFNlcnZpY2VEZWNvZGVyIGZyb20gJy4uL3BsaXN0LXNlcnZpY2UvdHJhbnNmb3JtZXIvcGxpc3Qtc2VydmljZS1kZWNvZGVyJztcbmltcG9ydCBQbGlzdFNlcnZpY2VFbmNvZGVyIGZyb20gJy4uL3BsaXN0LXNlcnZpY2UvdHJhbnNmb3JtZXIvcGxpc3Qtc2VydmljZS1lbmNvZGVyJztcbmltcG9ydCBMZW5ndGhCYXNlZFNwbGl0dGVyIGZyb20gJy4uL3V0aWwvdHJhbnNmb3JtZXIvbGVuZ3RoLWJhc2VkLXNwbGl0dGVyJztcbmltcG9ydCBTdHJlYW1Mb2dnZXIgZnJvbSAnLi4vdXRpbC90cmFuc2Zvcm1lci9zdHJlYW0tbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgTUIgfSBmcm9tICcuLi9jb25zdGFudHMnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgQmFzZVNlcnZpY2VTb2NrZXQgfSBmcm9tICcuLi9iYXNlLXNlcnZpY2UnO1xuXG5cbmNvbnN0IFdFQl9JTlNQRUNUT1JfU0VSVklDRV9OQU1FID0gJ2NvbS5hcHBsZS53ZWJpbnNwZWN0b3InO1xuXG5jb25zdCBQQVJUSUFMX01FU1NBR0VfU1VQUE9SVF9ERVBSRUNBVElPTl9WRVJTSU9OID0gMTE7XG5cbmNvbnN0IE1BWF9GUkFNRV9TSVpFID0gMjAwMDAwMDA7XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gV2ViSW5zcGVjdG9yU2VydmljZU9wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkge251bWJlcn0gbWFqb3JPc1ZlcnNpb24gVGhlIG1ham9yIHZlcnNpb24gb2YgdGhlIG9zIHZlcnNpb25cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNTaW11bGF0b3IgV2hldGhlciB0aGUgZGV2aWNlIGlzIGEgc2ltdWxhdG9yXG4gKiBAcHJvcGVydHkgez9udW1iZXJ9IHNvY2tldENodW5rU2l6ZSBTaXplLCBpbiBieXRlcyBvZiB0aGUgY2h1bmtzIHRvIHNlbmQgdG9cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWwgZGV2aWNlIChvbmx5IGlPUyAxMSspLiBEZWZhdWx0cyB0b1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMTYzODQgYnl0ZXMgKHRoZSBUTFNTb2NrZXQgbWF4KS5cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdmVyYm9zZSBUdXJuIG9uIGxvZ2dpbmcgb2YgZWFjaCBtZXNzYWdlIHNlbnQgb3IgcmVjZWl2ZWQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdHMgdG8gZmFsc2VcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdmVyYm9zZUhleER1bXAgVHVybiBvbiBsb2dnaW5nIG9mIF9hbGxfIGNvbW11bmljYXRpb24gYXNcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGV4IGR1bXAuIERlZmF1bHRzIHRvIGZhbHNlXG4gKiBAcHJvcGVydHkgeyp9IHNvY2tldENsaWVudCBUaGUgc29ja2V0IGNsaWVudCB3aGVyZSB0aGUgY29tbXVuaWNhdGlvbiB3aWxsIGhhcHBlblxuICovXG5cbmNsYXNzIFdlYkluc3BlY3RvclNlcnZpY2UgZXh0ZW5kcyBCYXNlU2VydmljZVNvY2tldCB7XG4gIC8qKlxuICAgKiBUaGUgbWFpbiBzZXJ2aWNlIGZvciBjb21tdW5pY2F0aW9uIHdpdGggdGhlIHdlYmluc3BlY3RvcmRcbiAgICpcbiAgICogQHBhcmFtIHtXZWJJbnNwZWN0b3JTZXJ2aWNlT3B0aW9uc31cbiAgICovXG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBjb25zdCB7XG4gICAgICBtYWpvck9zVmVyc2lvbixcbiAgICAgIGlzU2ltdWxhdG9yID0gZmFsc2UsXG4gICAgICBzb2NrZXRDaHVua1NpemUsXG4gICAgICB2ZXJib3NlID0gZmFsc2UsXG4gICAgICB2ZXJib3NlSGV4RHVtcCA9IGZhbHNlLFxuICAgICAgc29ja2V0Q2xpZW50LFxuICAgIH0gPSBvcHRzO1xuXG4gICAgc3VwZXIoc29ja2V0Q2xpZW50KTtcblxuICAgIC8vIHNldCB0aGUgbGFyZ2VzdCBmcmFnbWVudCBzaXplIGZvciB0aGUgc29ja2V0LCBpZiB0aGUgb3B0aW9uIGlzIHRoZXJlXG4gICAgaWYgKF8uaXNGdW5jdGlvbihzb2NrZXRDbGllbnQuc2V0TWF4U2VuZEZyYWdtZW50KSAmJiAhXy5pc05pbChzb2NrZXRDaHVua1NpemUpICYmIHNvY2tldENodW5rU2l6ZSA+IDApIHtcbiAgICAgIGlmIChzb2NrZXRDbGllbnQuc2V0TWF4U2VuZEZyYWdtZW50KHNvY2tldENodW5rU2l6ZSkpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBNYXhpbXVtIFRMUyBmcmFnbWVudCBzaXplIHNldCB0byAnJHtzb2NrZXRDaHVua1NpemV9J2ApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gYW55dGhpbmcgb3ZlciB0aGUgX2FjdHVhbF8gbWF4aW11bSB3aWxsIGZhaWwsIGFuZCB0aGluZ3Mgd2lsbCByZW1haW4gdGhlIHNhbWVcbiAgICAgICAgbG9nLndhcm4oYFVuYWJsZSB0byBzZXQgVExTIGZyYWdtZW50IHNpemUgdG8gJyR7c29ja2V0Q2h1bmtTaXplfSdgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLl92ZXJib3NlID0gdmVyYm9zZTtcbiAgICB0aGlzLl9pc1NpbXVsYXRvciA9IGlzU2ltdWxhdG9yO1xuXG4gICAgaWYgKCFpc1NpbXVsYXRvciAmJiBtYWpvck9zVmVyc2lvbiA8IFBBUlRJQUxfTUVTU0FHRV9TVVBQT1JUX0RFUFJFQ0FUSU9OX1ZFUlNJT04pIHtcbiAgICAgIHRoaXMuX2luaXRpYWxpemVQYXJ0aWFsTWVzc2FnZVN1cHBvcnQodmVyYm9zZUhleER1bXApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9pbml0aWFsaXplRnVsbE1lc3NhZ2VTdXBwb3J0KHZlcmJvc2VIZXhEdW1wKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW50aWFsaXplcyB0aGUgZGF0YSBmbG93IGZvciBpT1MgMTErLlxuICAgKlxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IHZlcmJvc2UgLSB3aGV0aGVyIHRvIHByaW50IG91dCB0aGUgaGV4IGR1bXAgZm9yIGNvbW11bmljYXRpb25cbiAgICovXG4gIF9pbml0aWFsaXplRnVsbE1lc3NhZ2VTdXBwb3J0ICh2ZXJib3NlKSB7XG4gICAgdGhpcy5fZGVjb2RlciA9IG5ldyBQbGlzdFNlcnZpY2VEZWNvZGVyKCk7XG4gICAgdGhpcy5fc29ja2V0Q2xpZW50XG4gICAgICAvLyBsb2cgZmlyc3QsIGluIGNhc2UgdGhlcmUgaXMgYSBwcm9ibGVtIGluIHByb2Nlc3NpbmdcbiAgICAgIC5waXBlKG5ldyBTdHJlYW1Mb2dnZXIoU3RyZWFtTG9nZ2VyLlJFQ0VJVkUsIHZlcmJvc2UpKVxuICAgICAgLnBpcGUobmV3IExlbmd0aEJhc2VkU3BsaXR0ZXIoZmFsc2UsIE1BWF9GUkFNRV9TSVpFLCAwLCA0LCA0KSlcbiAgICAgIC5waXBlKHRoaXMuX2RlY29kZXIpO1xuXG4gICAgdGhpcy5fZW5jb2RlciA9IG5ldyBQbGlzdFNlcnZpY2VFbmNvZGVyKCk7XG4gICAgdGhpcy5fZW5jb2RlclxuICAgICAgLnBpcGUobmV3IFN0cmVhbUxvZ2dlcihTdHJlYW1Mb2dnZXIuU0VORCwgdmVyYm9zZSkpXG4gICAgICAucGlwZSh0aGlzLl9zb2NrZXRDbGllbnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEludGlhbGl6ZXMgdGhlIGRhdGEgZmxvdyBmb3IgaU9TIDwgMTEsIHdoZXJlIGRhdGEgaXMgc2VwYXJhdGVkIGludG8gcGFydGlhbFxuICAgKiBtZXNzYWdlcyBiZWZvcmUgc2VuZGluZy5cbiAgICpcbiAgICogQHBhcmFtIHtib29sZWFufSB2ZXJib3NlIC0gd2hldGhlciB0byBwcmludCBvdXQgdGhlIGhleCBkdW1wIGZvciBjb21tdW5pY2F0aW9uXG4gICAqL1xuICBfaW5pdGlhbGl6ZVBhcnRpYWxNZXNzYWdlU3VwcG9ydCAodmVyYm9zZSkge1xuICAgIC8vIDFNQiBhcyBidWZmZXIgZm9yIGJ1bGRpbmcgd2ViaW5zcGVjdG9yIGZ1bGwgbWVzc2FnZXMuIFdlIGNhbiBpbmNyZWFzZSB0aGUgdmFsdWUgaWYgbW9yZSBidWZmZXIgaXMgbmVlZGVkXG4gICAgdGhpcy5fZGVjb2RlciA9IG5ldyBXZWJJbnNwZWN0b3JEZWNvZGVyKE1CKTtcbiAgICB0aGlzLl9zb2NrZXRDbGllbnRcbiAgICAgIC8vIGxvZyBmaXJzdCwgaW4gY2FzZSB0aGVyZSBpcyBhIHByb2JsZW0gaW4gcHJvY2Vzc2luZ1xuICAgICAgLnBpcGUobmV3IFN0cmVhbUxvZ2dlcihTdHJlYW1Mb2dnZXIuUkVDRUlWRSwgdmVyYm9zZSkpXG4gICAgICAucGlwZShuZXcgTGVuZ3RoQmFzZWRTcGxpdHRlcihmYWxzZSwgTUFYX0ZSQU1FX1NJWkUsIDAsIDQsIDQpKVxuICAgICAgLnBpcGUobmV3IFBsaXN0U2VydmljZURlY29kZXIoKSlcbiAgICAgIC5waXBlKHRoaXMuX2RlY29kZXIpO1xuXG4gICAgdGhpcy5fZW5jb2RlciA9IG5ldyBXZWJJbnNwZWN0b3JFbmNvZGVyKCk7XG4gICAgdGhpcy5fZW5jb2RlclxuICAgICAgLnBpcGUobmV3IFBsaXN0U2VydmljZUVuY29kZXIoKSlcbiAgICAgIC5waXBlKG5ldyBTdHJlYW1Mb2dnZXIoU3RyZWFtTG9nZ2VyLlNFTkQsIHZlcmJvc2UpKVxuICAgICAgLnBpcGUodGhpcy5fc29ja2V0Q2xpZW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZW5kcyBhbiBvYmplY3QgdG8gdGhlIHdlYmluc3BlY3RvcmQgc29ja2V0XG4gICAqIEBwYXJhbSB7T2JqZWN0fSBycGNPYmplY3QgVGhlIG9iamVjdCB0aGF0IHdpbGwgYmUgc2VudFxuICAgKiBAdGhyb3dzIFdpbGwgdGhyb3cgYW4gZXJyb3Igd2hlbiB0aGUgb2JqZWN0IGlzIG51bGwgb3IgdW5kZWZpbmVkXG4gICAqL1xuICBzZW5kTWVzc2FnZSAocnBjT2JqZWN0KSB7XG4gICAgaWYgKF8uaXNOaWwocnBjT2JqZWN0KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3Qgc2VuZCBhIG51bGwgb2JqZWN0Jyk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX3ZlcmJvc2UpIHtcbiAgICAgIGxvZy5kZWJ1ZygnU2VuZGluZyBtZXNzYWdlIHRvIFdlYiBJbnNwZWN0b3I6Jyk7XG4gICAgICBsb2cuZGVidWcodXRpbC5qc29uU3RyaW5naWZ5KHJwY09iamVjdCkpO1xuICAgIH1cblxuICAgIHRoaXMuX2VuY29kZXIud3JpdGUocnBjT2JqZWN0KTtcblxuICAgIC8vIHdyaXRlIGFuIGVtcHR5IG1lc3NhZ2UsIHdoaWNoIG9uIHJlYWwgZGV2aWNlcyBlbnN1cmVzIHRoZSBhY3R1YWwgbWVzc2FnZVxuICAgIC8vIGdldHMgc2VudCB0byB0aGUgZGV2aWNlLiB3aXRob3V0IHRoaXMgaXQgd2lsbCBwZXJpb2RpY2FsbHkgaGFuZyB3aXRoXG4gICAgLy8gbm90aGluZyBzZW50XG4gICAgaWYgKCF0aGlzLl9pc1NpbXVsYXRvcikge1xuICAgICAgdGhpcy5fZW5jb2Rlci53cml0ZSgnICcpO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gd2hpY2ggd2lsbCBiZSBjYWxsZWQgZHVyaW5nIG1lc3NhZ2UgbGlzdGVuaW5nXG4gICAqIEBuYW1lIE1lc3NhZ2VDYWxsYmFja1xuICAgKiBAZnVuY3Rpb25cbiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgcnBjIG9iamVjdCB0aGF0IGlzIHNlbnQgZnJvbSB0aGUgd2ViaW5zcGVjdG9yZFxuICAqL1xuXG4gIC8qKlxuICAgKiBMaXN0ZW4gdG8gbWVzc2FnZXMgY29taW5nIGZyb20gd2ViaW5zcGVjdG9yZFxuICAgKiBAcGFyYW0ge01lc3NhZ2VDYWxsYmFja30gY2FsbGJhY2tcbiAgICovXG4gIGxpc3Rlbk1lc3NhZ2UgKG9uRGF0YSkge1xuICAgIHRoaXMuX2RlY29kZXIub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xuICAgICAgaWYgKHRoaXMuX3ZlcmJvc2UpIHtcbiAgICAgICAgbG9nLmRlYnVnKCdSZWNlaXZlZCBtZXNzYWdlIGZyb20gV2ViIEluc3BlY3RvcjonKTtcbiAgICAgICAgbG9nLmRlYnVnKHV0aWwuanNvblN0cmluZ2lmeShkYXRhKSk7XG4gICAgICB9XG4gICAgICBvbkRhdGEoZGF0YSk7XG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IHsgV2ViSW5zcGVjdG9yU2VydmljZSwgV0VCX0lOU1BFQ1RPUl9TRVJWSUNFX05BTUUgfTtcbmV4cG9ydCBkZWZhdWx0IFdlYkluc3BlY3RvclNlcnZpY2U7XG4iXSwiZmlsZSI6ImxpYi93ZWJpbnNwZWN0b3IvaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
