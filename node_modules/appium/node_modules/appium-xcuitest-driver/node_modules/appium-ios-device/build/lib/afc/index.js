"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.AFC_SERVICE_NAME = exports.AfcService = exports.default = void 0;

require("source-map-support/register");

var _lengthBasedSplitter = _interopRequireDefault(require("../util/transformer/length-based-splitter"));

var _protocol = require("./protocol");

var _streams = require("./streams");

var _afcencoder = _interopRequireDefault(require("./transformer/afcencoder"));

var _afcdecoder = _interopRequireDefault(require("./transformer/afcdecoder"));

var _constants = require("../constants");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash"));

var _baseService = require("../base-service");

const AFC_SERVICE_NAME = 'com.apple.afc';
exports.AFC_SERVICE_NAME = AFC_SERVICE_NAME;
const NULL_DELIMETER_CODE = 0x00;
const IGNORED_PATHS = ['.', '..'];

class AfcService extends _baseService.BaseServiceSocket {
  constructor(socketClient) {
    super(socketClient);
    this._splitter = new _lengthBasedSplitter.default(true, _constants.MB, 8, 8, -8);
    this._decoder = new _afcdecoder.default();

    this._socketClient.pipe(this._splitter).pipe(this._decoder);

    this._encoder = new _afcencoder.default();

    this._encoder.pipe(this._socketClient);

    this._responseCallbacks = {};
    this._packetNumber = 0;

    this._decoder.on('data', this._handleData.bind(this));
  }

  _handleData(data) {
    const cb = this._responseCallbacks[data.packetNumber] || _lodash.default.noop();

    cb(data);
  }

  async createDirectory(path) {
    const {
      packetNumber,
      response
    } = this._createPacketPromise(`Create directory '${path}'`);

    const data = {
      opCode: _protocol.Operations.MAKE_DIR,
      packetNumber,
      headerPayload: Buffer.from(path)
    };

    this._encoder.write(data);

    const res = await response;

    this._checkStatus(res);
  }

  async deleteDirectory(path) {
    const {
      packetNumber,
      response
    } = this._createPacketPromise(`Delete directory '${path}'`);

    const data = {
      opCode: _protocol.Operations.REMOVE_PATH_AND_CONTENTS,
      packetNumber,
      headerPayload: Buffer.from(path)
    };

    this._encoder.write(data);

    const res = await response;

    this._checkStatus(res);
  }

  async listDirectory(path) {
    const {
      packetNumber,
      response
    } = this._createPacketPromise(`List directory '${path}'`);

    const data = {
      opCode: _protocol.Operations.READ_DIR,
      packetNumber,
      headerPayload: Buffer.from(path)
    };

    this._encoder.write(data);

    const res = await response;

    if (res.opCode !== _protocol.Operations.DATA) {
      this._checkStatus(res);
    }

    return this._parseArray(res.content);
  }

  async openFile(path, mode) {
    const {
      packetNumber,
      response
    } = this._createPacketPromise(`Open file '${path}'`);

    const pathPayload = Buffer.from(path);
    const fileModePayload = Buffer.alloc(8);
    fileModePayload.writeUInt32LE(mode, 0);
    const data = {
      opCode: _protocol.Operations.FILE_OPEN,
      packetNumber,
      headerPayload: Buffer.concat([fileModePayload, pathPayload])
    };

    this._encoder.write(data);

    const res = await response;

    if (res.opCode !== _protocol.Operations.FILE_OPEN_RES) {
      this._checkStatus(res);
    }

    return res.headerPayload.readUInt32LE(0);
  }

  async createWriteStream(filePath, opts) {
    const fileHandle = await this.openFile(filePath, _protocol.FileModes.w);
    return new _streams.AfcWritableFileStream(fileHandle, this, opts);
  }

  async createReadStream(filePath, options) {
    const fileHandle = await this.openFile(filePath, _protocol.FileModes.r);
    return new _streams.AfcReadableFileStream(fileHandle, this, options);
  }

  async closeFileHandle(fileHandle) {
    const {
      packetNumber,
      response
    } = this._createPacketPromise(`Close file handle '${fileHandle}'`);

    const fileModePayload = Buffer.alloc(8);
    fileModePayload.writeUInt32LE(fileHandle, 0);
    const data = {
      opCode: _protocol.Operations.FILE_CLOSE,
      packetNumber,
      headerPayload: fileModePayload
    };

    this._encoder.write(data);

    const res = await response;

    this._checkStatus(res);
  }

  async writeFile(fileHandle, buffer) {
    const {
      packetNumber,
      response
    } = this._createPacketPromise(`Write to file handle '${fileHandle}'`);

    const headerPayload = Buffer.alloc(8);
    headerPayload.writeUInt32LE(fileHandle, 0);
    const data = {
      opCode: _protocol.Operations.FILE_WRITE,
      packetNumber,
      headerPayload,
      content: buffer
    };

    this._encoder.write(data);

    const res = await response;

    this._checkStatus(res);
  }

  async readFile(fileHandle, length) {
    const {
      packetNumber,
      response
    } = this._createPacketPromise(`Read from file handle '${fileHandle}'`);

    const headerPayload = Buffer.alloc(16);
    headerPayload.writeUInt32LE(fileHandle, 0);
    headerPayload.writeUInt32LE(length, 8);
    const data = {
      opCode: _protocol.Operations.FILE_READ,
      packetNumber,
      headerPayload
    };

    this._encoder.write(data);

    const res = await response;

    if (res.opCode !== _protocol.Operations.DATA) {
      this._checkStatus(res);
    }

    return res.content;
  }

  async getFileInfo(path) {
    const {
      packetNumber,
      response
    } = this._createPacketPromise(`Get file info '${path}'`);

    const data = {
      opCode: _protocol.Operations.GET_FILE_INFO,
      packetNumber,
      headerPayload: Buffer.from(path)
    };

    this._encoder.write(data);

    const res = await response;

    if (res.opCode !== _protocol.Operations.DATA) {
      this._checkStatus(res);
    }

    return new FileInfo(this._parseObject(res.content));
  }

  async walkDir(dir, recursive, callback) {
    for (const file of await this.listDirectory(dir)) {
      if (IGNORED_PATHS.includes(file)) {
        continue;
      }

      const relativePath = _path.default.posix.join(dir, file);

      const fileInfo = await this.getFileInfo(relativePath);
      const isDirectory = fileInfo.isDirectory();
      await callback(relativePath, isDirectory);

      if (isDirectory && recursive) {
        await this.walkDir(relativePath, recursive, callback);
      }
    }
  }

  _checkStatus(res) {
    if (res.opCode !== _protocol.Operations.STATUS) {
      throw new Error(`Unexpected response ${(0, _protocol.operationCode)(res.opCode)}`);
    }

    if (_lodash.default.isEmpty(res.headerPayload)) {
      throw new Error('Header payload cant be empty for a status response');
    }

    if (res.headerPayload[0] !== _protocol.Errors.SUCCESS) {
      throw new Error(`Unexpected response ${(0, _protocol.errorCode)(res.headerPayload[0])}`);
    }
  }

  _parseArray(buffer) {
    const items = [];
    let start = 0;

    for (let end = 0; end < buffer.length; end++) {
      if (buffer[end] !== NULL_DELIMETER_CODE) {
        continue;
      }

      const item = buffer.toString('utf8', start, end);
      items.push(item);
      start = end + 1;
    }

    return items;
  }

  _parseObject(buffer) {
    const items = {};
    let start = 0;
    let currentKey;

    for (let end = 0; end < buffer.length; end++) {
      if (buffer[end] !== NULL_DELIMETER_CODE) {
        continue;
      }

      const item = buffer.toString('utf8', start, end);

      if (_lodash.default.isNil(currentKey)) {
        currentKey = item;
      } else {
        items[currentKey] = item;
        currentKey = null;
      }

      start = end + 1;
    }

    if (currentKey) {
      throw new Error(`Failed to parse correctly ${buffer}. Please investigate`);
    }

    return items;
  }

  _createPacketPromise(message, timeout = 10000) {
    const packetNumber = this._packetNumber++;
    const response = new _bluebird.default((resolve, reject) => {
      this._responseCallbacks[packetNumber] = data => resolve(data);

      setTimeout(() => reject(new Error(`Cound't finish the operation "${message}". Failed to receive any data within the timeout: ${timeout}`)), timeout);
    });
    return {
      packetNumber,
      response
    };
  }

}

exports.AfcService = AfcService;

class FileInfo {
  constructor({
    st_size,
    st_blocks,
    st_nlink,
    st_ifmt,
    st_mtime,
    st_birthtime
  }) {
    this.size = parseInt(st_size, 10);
    this.blocks = parseInt(st_blocks, 10);
    this.nlink = parseInt(st_nlink, 10);
    this.ifmt = st_ifmt;
    this.mtimeMs = parseInt(st_mtime, 10) / 1000000;
    this.birthtimeMs = parseInt(st_birthtime, 10) / 1000000;
  }

  isDirectory() {
    return this.ifmt === 'S_IFDIR';
  }

  isFile() {
    return this.ifmt === 'S_IFREG';
  }

}

var _default = AfcService;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9hZmMvaW5kZXguanMiXSwibmFtZXMiOlsiQUZDX1NFUlZJQ0VfTkFNRSIsIk5VTExfREVMSU1FVEVSX0NPREUiLCJJR05PUkVEX1BBVEhTIiwiQWZjU2VydmljZSIsIkJhc2VTZXJ2aWNlU29ja2V0IiwiY29uc3RydWN0b3IiLCJzb2NrZXRDbGllbnQiLCJfc3BsaXR0ZXIiLCJMZW5ndGhCYXNlZFNwbGl0dGVyIiwiTUIiLCJfZGVjb2RlciIsIkFmY0RlY29kZXIiLCJfc29ja2V0Q2xpZW50IiwicGlwZSIsIl9lbmNvZGVyIiwiQWZjRW5jb2RlciIsIl9yZXNwb25zZUNhbGxiYWNrcyIsIl9wYWNrZXROdW1iZXIiLCJvbiIsIl9oYW5kbGVEYXRhIiwiYmluZCIsImRhdGEiLCJjYiIsInBhY2tldE51bWJlciIsIl8iLCJub29wIiwiY3JlYXRlRGlyZWN0b3J5IiwicGF0aCIsInJlc3BvbnNlIiwiX2NyZWF0ZVBhY2tldFByb21pc2UiLCJvcENvZGUiLCJPcGVyYXRpb25zIiwiTUFLRV9ESVIiLCJoZWFkZXJQYXlsb2FkIiwiQnVmZmVyIiwiZnJvbSIsIndyaXRlIiwicmVzIiwiX2NoZWNrU3RhdHVzIiwiZGVsZXRlRGlyZWN0b3J5IiwiUkVNT1ZFX1BBVEhfQU5EX0NPTlRFTlRTIiwibGlzdERpcmVjdG9yeSIsIlJFQURfRElSIiwiREFUQSIsIl9wYXJzZUFycmF5IiwiY29udGVudCIsIm9wZW5GaWxlIiwibW9kZSIsInBhdGhQYXlsb2FkIiwiZmlsZU1vZGVQYXlsb2FkIiwiYWxsb2MiLCJ3cml0ZVVJbnQzMkxFIiwiRklMRV9PUEVOIiwiY29uY2F0IiwiRklMRV9PUEVOX1JFUyIsInJlYWRVSW50MzJMRSIsImNyZWF0ZVdyaXRlU3RyZWFtIiwiZmlsZVBhdGgiLCJvcHRzIiwiZmlsZUhhbmRsZSIsIkZpbGVNb2RlcyIsInciLCJBZmNXcml0YWJsZUZpbGVTdHJlYW0iLCJjcmVhdGVSZWFkU3RyZWFtIiwib3B0aW9ucyIsInIiLCJBZmNSZWFkYWJsZUZpbGVTdHJlYW0iLCJjbG9zZUZpbGVIYW5kbGUiLCJGSUxFX0NMT1NFIiwid3JpdGVGaWxlIiwiYnVmZmVyIiwiRklMRV9XUklURSIsInJlYWRGaWxlIiwibGVuZ3RoIiwiRklMRV9SRUFEIiwiZ2V0RmlsZUluZm8iLCJHRVRfRklMRV9JTkZPIiwiRmlsZUluZm8iLCJfcGFyc2VPYmplY3QiLCJ3YWxrRGlyIiwiZGlyIiwicmVjdXJzaXZlIiwiY2FsbGJhY2siLCJmaWxlIiwiaW5jbHVkZXMiLCJyZWxhdGl2ZVBhdGgiLCJwb3NpeCIsImpvaW4iLCJmaWxlSW5mbyIsImlzRGlyZWN0b3J5IiwiU1RBVFVTIiwiRXJyb3IiLCJpc0VtcHR5IiwiRXJyb3JzIiwiU1VDQ0VTUyIsIml0ZW1zIiwic3RhcnQiLCJlbmQiLCJpdGVtIiwidG9TdHJpbmciLCJwdXNoIiwiY3VycmVudEtleSIsImlzTmlsIiwibWVzc2FnZSIsInRpbWVvdXQiLCJCIiwicmVzb2x2ZSIsInJlamVjdCIsInNldFRpbWVvdXQiLCJzdF9zaXplIiwic3RfYmxvY2tzIiwic3RfbmxpbmsiLCJzdF9pZm10Iiwic3RfbXRpbWUiLCJzdF9iaXJ0aHRpbWUiLCJzaXplIiwicGFyc2VJbnQiLCJibG9ja3MiLCJubGluayIsImlmbXQiLCJtdGltZU1zIiwiYmlydGh0aW1lTXMiLCJpc0ZpbGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsZ0JBQWdCLEdBQUcsZUFBekI7O0FBRUEsTUFBTUMsbUJBQW1CLEdBQUcsSUFBNUI7QUFDQSxNQUFNQyxhQUFhLEdBQUcsQ0FBQyxHQUFELEVBQU0sSUFBTixDQUF0Qjs7QUFFQSxNQUFNQyxVQUFOLFNBQXlCQyw4QkFBekIsQ0FBMkM7QUFDekNDLEVBQUFBLFdBQVcsQ0FBRUMsWUFBRixFQUFnQjtBQUN6QixVQUFNQSxZQUFOO0FBRUEsU0FBS0MsU0FBTCxHQUFpQixJQUFJQyw0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QUFBQSxNQUFNLEdBQUk7QUFDUixXQUFPLEtBQUtILElBQUwsS0FBYyxTQUFyQjtBQUNEOztBQWxCWTs7ZUFxQkFwSCxVIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzICovXG5pbXBvcnQgTGVuZ3RoQmFzZWRTcGxpdHRlciBmcm9tICcuLi91dGlsL3RyYW5zZm9ybWVyL2xlbmd0aC1iYXNlZC1zcGxpdHRlcic7XG5pbXBvcnQgeyBPcGVyYXRpb25zLCBvcGVyYXRpb25Db2RlLCBFcnJvcnMsIGVycm9yQ29kZSwgRmlsZU1vZGVzIH0gZnJvbSAnLi9wcm90b2NvbCc7XG5pbXBvcnQgeyBBZmNXcml0YWJsZUZpbGVTdHJlYW0sIEFmY1JlYWRhYmxlRmlsZVN0cmVhbSB9IGZyb20gJy4vc3RyZWFtcyc7XG5pbXBvcnQgQWZjRW5jb2RlciBmcm9tICcuL3RyYW5zZm9ybWVyL2FmY2VuY29kZXInO1xuaW1wb3J0IEFmY0RlY29kZXIgZnJvbSAnLi90cmFuc2Zvcm1lci9hZmNkZWNvZGVyJztcbmltcG9ydCB7IE1CIH0gZnJvbSAnLi4vY29uc3RhbnRzJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IEJhc2VTZXJ2aWNlU29ja2V0IH0gZnJvbSAnLi4vYmFzZS1zZXJ2aWNlJztcblxuXG5jb25zdCBBRkNfU0VSVklDRV9OQU1FID0gJ2NvbS5hcHBsZS5hZmMnO1xuXG5jb25zdCBOVUxMX0RFTElNRVRFUl9DT0RFID0gMHgwMDtcbmNvbnN0IElHTk9SRURfUEFUSFMgPSBbJy4nLCAnLi4nXTtcblxuY2xhc3MgQWZjU2VydmljZSBleHRlbmRzIEJhc2VTZXJ2aWNlU29ja2V0IHtcbiAgY29uc3RydWN0b3IgKHNvY2tldENsaWVudCkge1xuICAgIHN1cGVyKHNvY2tldENsaWVudCk7XG5cbiAgICB0aGlzLl9zcGxpdHRlciA9IG5ldyBMZW5ndGhCYXNlZFNwbGl0dGVyKHRydWUsIE1CLCA4LCA4LCAtOCk7XG4gICAgdGhpcy5fZGVjb2RlciA9IG5ldyBBZmNEZWNvZGVyKCk7XG4gICAgdGhpcy5fc29ja2V0Q2xpZW50LnBpcGUodGhpcy5fc3BsaXR0ZXIpLnBpcGUodGhpcy5fZGVjb2Rlcik7XG5cbiAgICB0aGlzLl9lbmNvZGVyID0gbmV3IEFmY0VuY29kZXIoKTtcbiAgICB0aGlzLl9lbmNvZGVyLnBpcGUodGhpcy5fc29ja2V0Q2xpZW50KTtcblxuICAgIHRoaXMuX3Jlc3BvbnNlQ2FsbGJhY2tzID0ge307XG5cbiAgICB0aGlzLl9wYWNrZXROdW1iZXIgPSAwO1xuICAgIHRoaXMuX2RlY29kZXIub24oJ2RhdGEnLCB0aGlzLl9oYW5kbGVEYXRhLmJpbmQodGhpcykpO1xuICB9XG5cbiAgX2hhbmRsZURhdGEgKGRhdGEpIHtcbiAgICBjb25zdCBjYiA9IHRoaXMuX3Jlc3BvbnNlQ2FsbGJhY2tzW2RhdGEucGFja2V0TnVtYmVyXSB8fCBfLm5vb3AoKTtcbiAgICBjYihkYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGEgZGlyZWN0b3J5IHJlbGF0aXZlIHRvIGFuIGFscmVhZHkgZXhpc3RpbmcgZGlyZWN0b3J5XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIFRoZSBwYXRoIGluIHVuaXggZm9ybWF0XG4gICAqL1xuICBhc3luYyBjcmVhdGVEaXJlY3RvcnkgKHBhdGgpIHtcbiAgICBjb25zdCB7cGFja2V0TnVtYmVyLCByZXNwb25zZX0gPSB0aGlzLl9jcmVhdGVQYWNrZXRQcm9taXNlKGBDcmVhdGUgZGlyZWN0b3J5ICcke3BhdGh9J2ApO1xuXG4gICAgY29uc3QgZGF0YSA9IHtcbiAgICAgIG9wQ29kZTogT3BlcmF0aW9ucy5NQUtFX0RJUixcbiAgICAgIHBhY2tldE51bWJlcixcbiAgICAgIGhlYWRlclBheWxvYWQ6IEJ1ZmZlci5mcm9tKHBhdGgpXG4gICAgfTtcbiAgICB0aGlzLl9lbmNvZGVyLndyaXRlKGRhdGEpO1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlc3BvbnNlO1xuICAgIHRoaXMuX2NoZWNrU3RhdHVzKHJlcyk7XG4gIH1cblxuICAvKipcbiAgICogRGVsZXRlcyBhcmUgZGlyZWN0b3J5IGNvbXBsZXRlbHkgZXZlbiBpdCBoYXMgY29udGVudCBpbnNpZGUuIFRoaXMgaXMgYW4gaW1wbGVtZW50YXRpb24gb2YgJ3JtIC1yIHtwYXRofSdcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggVGhlIHBhdGggaW4gdW5peCBmb3JtYXRcbiAgICovXG4gIGFzeW5jIGRlbGV0ZURpcmVjdG9yeSAocGF0aCkge1xuICAgIGNvbnN0IHtwYWNrZXROdW1iZXIsIHJlc3BvbnNlfSA9IHRoaXMuX2NyZWF0ZVBhY2tldFByb21pc2UoYERlbGV0ZSBkaXJlY3RvcnkgJyR7cGF0aH0nYCk7XG5cbiAgICBjb25zdCBkYXRhID0ge1xuICAgICAgb3BDb2RlOiBPcGVyYXRpb25zLlJFTU9WRV9QQVRIX0FORF9DT05URU5UUyxcbiAgICAgIHBhY2tldE51bWJlcixcbiAgICAgIGhlYWRlclBheWxvYWQ6IEJ1ZmZlci5mcm9tKHBhdGgpXG4gICAgfTtcbiAgICB0aGlzLl9lbmNvZGVyLndyaXRlKGRhdGEpO1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlc3BvbnNlO1xuICAgIHRoaXMuX2NoZWNrU3RhdHVzKHJlcyk7XG4gIH1cblxuICAvKipcbiAgICogTGlzdHMgYSBkaXJlY3RvcnkncyBjb250ZW50cyBhbmQgcmV0dXJucyB0aGVtIGluIGFuIGFycmF5XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIFRoZSBwYXRoIGluIHVuaXggZm9ybWF0XG4gICAqIEByZXR1cm4ge0FycmF5LjxzdHJpbmc+fVxuICAgKi9cbiAgYXN5bmMgbGlzdERpcmVjdG9yeSAocGF0aCkge1xuICAgIGNvbnN0IHtwYWNrZXROdW1iZXIsIHJlc3BvbnNlfSA9IHRoaXMuX2NyZWF0ZVBhY2tldFByb21pc2UoYExpc3QgZGlyZWN0b3J5ICcke3BhdGh9J2ApO1xuXG4gICAgY29uc3QgZGF0YSA9IHtcbiAgICAgIG9wQ29kZTogT3BlcmF0aW9ucy5SRUFEX0RJUixcbiAgICAgIHBhY2tldE51bWJlcixcbiAgICAgIGhlYWRlclBheWxvYWQ6IEJ1ZmZlci5mcm9tKHBhdGgpXG4gICAgfTtcbiAgICB0aGlzLl9lbmNvZGVyLndyaXRlKGRhdGEpO1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlc3BvbnNlO1xuICAgIGlmIChyZXMub3BDb2RlICE9PSBPcGVyYXRpb25zLkRBVEEpIHtcbiAgICAgIHRoaXMuX2NoZWNrU3RhdHVzKHJlcyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX3BhcnNlQXJyYXkocmVzLmNvbnRlbnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIE9wZW5zIGEgZmlsZSBhbmQgY3JlYXRlcyBhIGZpbGUgaGFuZGxlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIFRoZSBwYXRoIGluIHVuaXggZm9ybWF0XG4gICAqIEBwYXJhbSB7bnVtYmVyfSBtb2RlIFRoZSBmaWxlIG1vZGUgdGhhdCB3aWxsIGJlIHVzZWRcbiAgICogQHJldHVybiB7bnVtYmVyfVxuICAgKi9cbiAgYXN5bmMgb3BlbkZpbGUgKHBhdGgsIG1vZGUpIHtcbiAgICBjb25zdCB7cGFja2V0TnVtYmVyLCByZXNwb25zZX0gPSB0aGlzLl9jcmVhdGVQYWNrZXRQcm9taXNlKGBPcGVuIGZpbGUgJyR7cGF0aH0nYCk7XG5cbiAgICBjb25zdCBwYXRoUGF5bG9hZCA9IEJ1ZmZlci5mcm9tKHBhdGgpO1xuICAgIGNvbnN0IGZpbGVNb2RlUGF5bG9hZCA9IEJ1ZmZlci5hbGxvYyg4KTtcbiAgICBmaWxlTW9kZVBheWxvYWQud3JpdGVVSW50MzJMRShtb2RlLCAwKTtcblxuICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICBvcENvZGU6IE9wZXJhdGlvbnMuRklMRV9PUEVOLFxuICAgICAgcGFja2V0TnVtYmVyLFxuICAgICAgaGVhZGVyUGF5bG9hZDogQnVmZmVyLmNvbmNhdChbZmlsZU1vZGVQYXlsb2FkLCBwYXRoUGF5bG9hZF0pXG4gICAgfTtcbiAgICB0aGlzLl9lbmNvZGVyLndyaXRlKGRhdGEpO1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlc3BvbnNlO1xuICAgIGlmIChyZXMub3BDb2RlICE9PSBPcGVyYXRpb25zLkZJTEVfT1BFTl9SRVMpIHtcbiAgICAgIHRoaXMuX2NoZWNrU3RhdHVzKHJlcyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlcy5oZWFkZXJQYXlsb2FkLnJlYWRVSW50MzJMRSgwKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVucyBhIGZpbGUgYW5kIGNyZWF0ZXMgYSBub2RlanMgd3JpdGUgc3RyZWFtXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBmaWxlUGF0aCBUaGUgcGF0aCBpbiB1bml4IGZvcm1hdFxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0cyBUaGUgcmVndWxhciBvcHRpb25zIHRoYXQgYXJlIHBhc3NlZCB0byBhIFN0cmVhbS5Xcml0YWJsZVxuICAgKiBAcmV0dXJuIHtBZmNXcml0YWJsZUZpbGVTdHJlYW19XG4gICAqL1xuICBhc3luYyBjcmVhdGVXcml0ZVN0cmVhbSAoZmlsZVBhdGgsIG9wdHMpIHtcbiAgICBjb25zdCBmaWxlSGFuZGxlID0gYXdhaXQgdGhpcy5vcGVuRmlsZShmaWxlUGF0aCwgRmlsZU1vZGVzLncpO1xuICAgIHJldHVybiBuZXcgQWZjV3JpdGFibGVGaWxlU3RyZWFtKGZpbGVIYW5kbGUsIHRoaXMsIG9wdHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIE9wZW5zIGEgZmlsZSBhbmQgY3JlYXRlcyBhIG5vZGVqcyByZWFkIHN0cmVhbVxuICAgKiBAcGFyYW0ge3N0cmluZ30gZmlsZVBhdGggVGhlIHBhdGggaW4gdW5peCBmb3JtYXRcbiAgICogQHBhcmFtIHtPYmplY3R9IG9wdHMgVGhlIHJlZ3VsYXIgb3B0aW9ucyB0aGF0IGFyZSBwYXNzZWQgdG8gYSBTdHJlYW0uUmVhZGFibGVcbiAgICogQHJldHVybiB7QWZjUmVhZGFibGVGaWxlU3RyZWFtfVxuICAgKi9cbiAgYXN5bmMgY3JlYXRlUmVhZFN0cmVhbSAoZmlsZVBhdGgsIG9wdGlvbnMpIHtcbiAgICBjb25zdCBmaWxlSGFuZGxlID0gYXdhaXQgdGhpcy5vcGVuRmlsZShmaWxlUGF0aCwgRmlsZU1vZGVzLnIpO1xuICAgIHJldHVybiBuZXcgQWZjUmVhZGFibGVGaWxlU3RyZWFtKGZpbGVIYW5kbGUsIHRoaXMsIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIENsb3NlcyB0aGUgZmlsZSBoYW5kbGVcbiAgICogQHBhcmFtIHtudW1iZXJ9IGZpbGVIYW5kbGUgdGhlIGZpbGUgaGFuZGxlIHRvIGJlIGNsb3NlZFxuICAgKi9cbiAgYXN5bmMgY2xvc2VGaWxlSGFuZGxlIChmaWxlSGFuZGxlKSB7XG4gICAgY29uc3Qge3BhY2tldE51bWJlciwgcmVzcG9uc2V9ID0gdGhpcy5fY3JlYXRlUGFja2V0UHJvbWlzZShgQ2xvc2UgZmlsZSBoYW5kbGUgJyR7ZmlsZUhhbmRsZX0nYCk7XG5cbiAgICBjb25zdCBmaWxlTW9kZVBheWxvYWQgPSBCdWZmZXIuYWxsb2MoOCk7XG4gICAgZmlsZU1vZGVQYXlsb2FkLndyaXRlVUludDMyTEUoZmlsZUhhbmRsZSwgMCk7XG5cbiAgICBjb25zdCBkYXRhID0ge1xuICAgICAgb3BDb2RlOiBPcGVyYXRpb25zLkZJTEVfQ0xPU0UsXG4gICAgICBwYWNrZXROdW1iZXIsXG4gICAgICBoZWFkZXJQYXlsb2FkOiBmaWxlTW9kZVBheWxvYWRcbiAgICB9O1xuICAgIHRoaXMuX2VuY29kZXIud3JpdGUoZGF0YSk7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgcmVzcG9uc2U7XG4gICAgdGhpcy5fY2hlY2tTdGF0dXMocmVzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXcml0ZXMgdGhlIGJ1ZmZlciBpbnRvIHRoZSBnaXZlbiBmaWxlIGhhbmRsZVxuICAgKiBAcGFyYW0ge251bWJlcn0gZmlsZUhhbmRsZSBUaGUgZmlsZSBoYW5kbGUgdG8gYmUgdXNlZFxuICAgKiBAcGFyYW0ge0J1ZmZlcn0gYnVmZmVyIFRoZSBidWZmZXIgdGhhdCB3aWxsIGJlIHdyaXR0ZW5cbiAgICovXG4gIGFzeW5jIHdyaXRlRmlsZSAoZmlsZUhhbmRsZSwgYnVmZmVyKSB7XG4gICAgY29uc3Qge3BhY2tldE51bWJlciwgcmVzcG9uc2V9ID0gdGhpcy5fY3JlYXRlUGFja2V0UHJvbWlzZShgV3JpdGUgdG8gZmlsZSBoYW5kbGUgJyR7ZmlsZUhhbmRsZX0nYCk7XG5cbiAgICBjb25zdCBoZWFkZXJQYXlsb2FkID0gQnVmZmVyLmFsbG9jKDgpO1xuICAgIGhlYWRlclBheWxvYWQud3JpdGVVSW50MzJMRShmaWxlSGFuZGxlLCAwKTtcblxuICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICBvcENvZGU6IE9wZXJhdGlvbnMuRklMRV9XUklURSxcbiAgICAgIHBhY2tldE51bWJlcixcbiAgICAgIGhlYWRlclBheWxvYWQsXG4gICAgICBjb250ZW50OiBidWZmZXJcbiAgICB9O1xuICAgIHRoaXMuX2VuY29kZXIud3JpdGUoZGF0YSk7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgcmVzcG9uc2U7XG4gICAgdGhpcy5fY2hlY2tTdGF0dXMocmVzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWFkIGEgY2VydGFpbiBsZW5ndGggb2YgYnVmZmVyIGZyb20gdGhlIGZpbGUgaGFuZGxlXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBmaWxlSGFuZGxlIFRoZSBmaWxlIGhhbmRsZSB0byBiZSB1c2VkXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBsZW5ndGggVGhlIGxlbmd0aCB0aGF0IHdhbnRzIHRvIGJlIHJlYWQgZnJvbSB0aGUgZmlsZSBoYW5kbGVcbiAgICogQHJldHVybiB7QnVmZmVyfVxuICAgKi9cbiAgYXN5bmMgcmVhZEZpbGUgKGZpbGVIYW5kbGUsIGxlbmd0aCkge1xuICAgIGNvbnN0IHtwYWNrZXROdW1iZXIsIHJlc3BvbnNlfSA9IHRoaXMuX2NyZWF0ZVBhY2tldFByb21pc2UoYFJlYWQgZnJvbSBmaWxlIGhhbmRsZSAnJHtmaWxlSGFuZGxlfSdgKTtcblxuICAgIGNvbnN0IGhlYWRlclBheWxvYWQgPSBCdWZmZXIuYWxsb2MoMTYpO1xuICAgIGhlYWRlclBheWxvYWQud3JpdGVVSW50MzJMRShmaWxlSGFuZGxlLCAwKTtcbiAgICBoZWFkZXJQYXlsb2FkLndyaXRlVUludDMyTEUobGVuZ3RoLCA4KTtcblxuICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICBvcENvZGU6IE9wZXJhdGlvbnMuRklMRV9SRUFELFxuICAgICAgcGFja2V0TnVtYmVyLFxuICAgICAgaGVhZGVyUGF5bG9hZFxuICAgIH07XG4gICAgdGhpcy5fZW5jb2Rlci53cml0ZShkYXRhKTtcbiAgICBjb25zdCByZXMgPSBhd2FpdCByZXNwb25zZTtcbiAgICBpZiAocmVzLm9wQ29kZSAhPT0gT3BlcmF0aW9ucy5EQVRBKSB7XG4gICAgICB0aGlzLl9jaGVja1N0YXR1cyhyZXMpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzLmNvbnRlbnQ7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBmaWxlIGluZm8gb2YgdGhlIGdpdmVuIHBhdGhcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggVGhlIHBhdGggaW4gdW5peCBmb3JtYXRcbiAgICogQHJldHVybiB7RmlsZUluZm99XG4gICAqL1xuICBhc3luYyBnZXRGaWxlSW5mbyAocGF0aCkge1xuICAgIGNvbnN0IHtwYWNrZXROdW1iZXIsIHJlc3BvbnNlfSA9IHRoaXMuX2NyZWF0ZVBhY2tldFByb21pc2UoYEdldCBmaWxlIGluZm8gJyR7cGF0aH0nYCk7XG5cbiAgICBjb25zdCBkYXRhID0ge1xuICAgICAgb3BDb2RlOiBPcGVyYXRpb25zLkdFVF9GSUxFX0lORk8sXG4gICAgICBwYWNrZXROdW1iZXIsXG4gICAgICBoZWFkZXJQYXlsb2FkOiBCdWZmZXIuZnJvbShwYXRoKVxuICAgIH07XG4gICAgdGhpcy5fZW5jb2Rlci53cml0ZShkYXRhKTtcbiAgICBjb25zdCByZXMgPSBhd2FpdCByZXNwb25zZTtcbiAgICBpZiAocmVzLm9wQ29kZSAhPT0gT3BlcmF0aW9ucy5EQVRBKSB7XG4gICAgICB0aGlzLl9jaGVja1N0YXR1cyhyZXMpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IEZpbGVJbmZvKHRoaXMuX3BhcnNlT2JqZWN0KHJlcy5jb250ZW50KSk7XG4gIH1cblxuICAvKiogVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdoaWNoIHdpbGwgYmUgY2FsbGVkIGR1cmluZyB0aGUgZGlyZWN0b3J5IHdhbGtpbmdcbiAgICogQG5hbWUgV2Fsa0RpckNhbGxiYWNrXG4gICAqIEBmdW5jdGlvblxuICAgKiBAcGFyYW0ge3N0cmluZ30gaXRlbVBhdGggVGhlIHBhdGggb2YgdGhlIGZpbGUgb3IgZm9sZGVyXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNEaXJlY3RvcnkgU2hvd3MgaWYgaXQgaXMgYSBkaXJlY3Rvcnkgb3IgYSBmaWxlXG4gICovXG5cbiAgLyoqXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBkaXIgVGhlIHBhdGggaW4gdW5peCBmb3JtYXRcbiAgICogQHBhcmFtIHtib29sZWFufSByZWN1cnNpdmUgU2V0cyB3aGV0aGVyIHRvIGZvbGxvdyBzdWIgZGlyZWN0b3JpZXMgb3Igbm90XG4gICAqIEBwYXJhbSB7V2Fsa0RpckNhbGxiYWNrfSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgdG8gYmUgY2FsbGVkIHdoZW4gYSBuZXcgcGF0aCBpcyBmb3VuZFxuICAgKi9cbiAgYXN5bmMgd2Fsa0RpciAoZGlyLCByZWN1cnNpdmUsIGNhbGxiYWNrKSB7XG4gICAgZm9yIChjb25zdCBmaWxlIG9mIGF3YWl0IHRoaXMubGlzdERpcmVjdG9yeShkaXIpKSB7XG4gICAgICBpZiAoSUdOT1JFRF9QQVRIUy5pbmNsdWRlcyhmaWxlKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHJlbGF0aXZlUGF0aCA9IHBhdGgucG9zaXguam9pbihkaXIsIGZpbGUpO1xuICAgICAgY29uc3QgZmlsZUluZm8gPSBhd2FpdCB0aGlzLmdldEZpbGVJbmZvKHJlbGF0aXZlUGF0aCk7XG4gICAgICBjb25zdCBpc0RpcmVjdG9yeSA9IGZpbGVJbmZvLmlzRGlyZWN0b3J5KCk7XG4gICAgICBhd2FpdCBjYWxsYmFjayhyZWxhdGl2ZVBhdGgsIGlzRGlyZWN0b3J5KTtcbiAgICAgIGlmIChpc0RpcmVjdG9yeSAmJiByZWN1cnNpdmUpIHtcbiAgICAgICAgYXdhaXQgdGhpcy53YWxrRGlyKHJlbGF0aXZlUGF0aCwgcmVjdXJzaXZlLCBjYWxsYmFjayk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgX2NoZWNrU3RhdHVzIChyZXMpIHtcbiAgICBpZiAocmVzLm9wQ29kZSAhPT0gT3BlcmF0aW9ucy5TVEFUVVMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCByZXNwb25zZSAke29wZXJhdGlvbkNvZGUocmVzLm9wQ29kZSl9YCk7XG4gICAgfVxuICAgIGlmIChfLmlzRW1wdHkocmVzLmhlYWRlclBheWxvYWQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0hlYWRlciBwYXlsb2FkIGNhbnQgYmUgZW1wdHkgZm9yIGEgc3RhdHVzIHJlc3BvbnNlJyk7XG4gICAgfVxuICAgIGlmIChyZXMuaGVhZGVyUGF5bG9hZFswXSAhPT0gRXJyb3JzLlNVQ0NFU1MpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCByZXNwb25zZSAke2Vycm9yQ29kZShyZXMuaGVhZGVyUGF5bG9hZFswXSl9YCk7XG4gICAgfVxuICB9XG5cbiAgX3BhcnNlQXJyYXkgKGJ1ZmZlcikge1xuICAgIGNvbnN0IGl0ZW1zID0gW107XG4gICAgbGV0IHN0YXJ0ID0gMDtcbiAgICBmb3IgKGxldCBlbmQgPSAwOyBlbmQgPCBidWZmZXIubGVuZ3RoOyBlbmQrKykge1xuICAgICAgaWYgKGJ1ZmZlcltlbmRdICE9PSBOVUxMX0RFTElNRVRFUl9DT0RFKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgY29uc3QgaXRlbSA9IGJ1ZmZlci50b1N0cmluZygndXRmOCcsIHN0YXJ0LCBlbmQpO1xuICAgICAgaXRlbXMucHVzaChpdGVtKTtcbiAgICAgIC8vIFdlIHNraXAgdGhlIG51bGwgZGVsaW1ldGVyXG4gICAgICBzdGFydCA9IGVuZCArIDE7XG4gICAgfVxuICAgIHJldHVybiBpdGVtcztcbiAgfVxuXG4gIF9wYXJzZU9iamVjdCAoYnVmZmVyKSB7XG4gICAgY29uc3QgaXRlbXMgPSB7fTtcbiAgICBsZXQgc3RhcnQgPSAwO1xuICAgIGxldCBjdXJyZW50S2V5O1xuICAgIGZvciAobGV0IGVuZCA9IDA7IGVuZCA8IGJ1ZmZlci5sZW5ndGg7IGVuZCsrKSB7XG4gICAgICBpZiAoYnVmZmVyW2VuZF0gIT09IE5VTExfREVMSU1FVEVSX0NPREUpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBjb25zdCBpdGVtID0gYnVmZmVyLnRvU3RyaW5nKCd1dGY4Jywgc3RhcnQsIGVuZCk7XG4gICAgICBpZiAoXy5pc05pbChjdXJyZW50S2V5KSkge1xuICAgICAgICBjdXJyZW50S2V5ID0gaXRlbTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGl0ZW1zW2N1cnJlbnRLZXldID0gaXRlbTtcbiAgICAgICAgY3VycmVudEtleSA9IG51bGw7XG4gICAgICB9XG4gICAgICAvLyBXZSBza2lwIHRoZSBudWxsIGRlbGltZXRlclxuICAgICAgc3RhcnQgPSBlbmQgKyAxO1xuICAgIH1cbiAgICBpZiAoY3VycmVudEtleSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gcGFyc2UgY29ycmVjdGx5ICR7YnVmZmVyfS4gUGxlYXNlIGludmVzdGlnYXRlYCk7XG4gICAgfVxuICAgIHJldHVybiBpdGVtcztcbiAgfVxuXG4gIF9jcmVhdGVQYWNrZXRQcm9taXNlIChtZXNzYWdlLCB0aW1lb3V0ID0gMTAwMDApIHtcbiAgICBjb25zdCBwYWNrZXROdW1iZXIgPSB0aGlzLl9wYWNrZXROdW1iZXIrKztcbiAgICBjb25zdCByZXNwb25zZSA9IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuX3Jlc3BvbnNlQ2FsbGJhY2tzW3BhY2tldE51bWJlcl0gPSAoZGF0YSkgPT4gcmVzb2x2ZShkYXRhKTtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gcmVqZWN0KG5ldyBFcnJvcihgQ291bmQndCBmaW5pc2ggdGhlIG9wZXJhdGlvbiBcIiR7bWVzc2FnZX1cIi4gRmFpbGVkIHRvIHJlY2VpdmUgYW55IGRhdGEgd2l0aGluIHRoZSB0aW1lb3V0OiAke3RpbWVvdXR9YCkpLCB0aW1lb3V0KTtcbiAgICB9KTtcbiAgICByZXR1cm4geyBwYWNrZXROdW1iZXIsIHJlc3BvbnNlIH07XG4gIH1cbn1cblxuY2xhc3MgRmlsZUluZm8ge1xuICBjb25zdHJ1Y3RvciAoeyBzdF9zaXplLCBzdF9ibG9ja3MsIHN0X25saW5rLCBzdF9pZm10LCBzdF9tdGltZSwgc3RfYmlydGh0aW1lIH0pIHtcbiAgICB0aGlzLnNpemUgPSBwYXJzZUludChzdF9zaXplLCAxMCk7XG4gICAgdGhpcy5ibG9ja3MgPSBwYXJzZUludChzdF9ibG9ja3MsIDEwKTtcbiAgICB0aGlzLm5saW5rID0gcGFyc2VJbnQoc3RfbmxpbmssIDEwKTtcbiAgICB0aGlzLmlmbXQgPSBzdF9pZm10O1xuICAgIC8vIG5zIHRvIG1zXG4gICAgdGhpcy5tdGltZU1zID0gcGFyc2VJbnQoc3RfbXRpbWUsIDEwKSAvIDEwMDAwMDA7XG4gICAgLy8gbnMgdG8gbXNcbiAgICB0aGlzLmJpcnRodGltZU1zID0gcGFyc2VJbnQoc3RfYmlydGh0aW1lLCAxMCkgLyAxMDAwMDAwO1xuICB9XG5cbiAgaXNEaXJlY3RvcnkgKCkge1xuICAgIHJldHVybiB0aGlzLmlmbXQgPT09ICdTX0lGRElSJztcbiAgfVxuXG4gIGlzRmlsZSAoKSB7XG4gICAgcmV0dXJuIHRoaXMuaWZtdCA9PT0gJ1NfSUZSRUcnO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEFmY1NlcnZpY2U7XG5leHBvcnQgeyBBZmNTZXJ2aWNlLCBBRkNfU0VSVklDRV9OQU1FIH07XG4iXSwiZmlsZSI6ImxpYi9hZmMvaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
