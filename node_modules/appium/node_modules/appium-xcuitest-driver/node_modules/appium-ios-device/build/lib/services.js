"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.startSyslogService = startSyslogService;
exports.startWebInspectorService = startWebInspectorService;
exports.startInstallationProxyService = startInstallationProxyService;
exports.startSimulateLocationService = startSimulateLocationService;
exports.startAfcService = startAfcService;
exports.startNotificationProxyService = startNotificationProxyService;
exports.startHouseArrestService = startHouseArrestService;

require("source-map-support/register");

var _utilities = require("./utilities");

var _syslog = require("./syslog");

var _simulatelocation = require("./simulatelocation");

var _webinspector = require("./webinspector");

var _installationProxy = require("./installation-proxy");

var _afc = require("./afc");

var _notificationProxy = require("./notification-proxy");

var _houseArrest = require("./house-arrest");

var _plistService = _interopRequireDefault(require("./plist-service"));

var _semver = _interopRequireDefault(require("semver"));

async function startSyslogService(udid, opts = {}) {
  return new _syslog.SyslogService((await startService(udid, _syslog.SYSLOG_SERVICE_NAME, opts.socket)));
}

async function startSimulateLocationService(udid, opts = {}) {
  return new _simulatelocation.SimulateLocationService((await startService(udid, _simulatelocation.SIMULATE_LOCATION_SERVICE_NAME, opts.socket)));
}

async function startWebInspectorService(udid, opts = {}) {
  const osVersion = opts.osVersion || (await (0, _utilities.getOSVersion)(udid, opts.socket));
  const isSimulator = !!opts.isSimulator;
  const verbose = !!opts.verbose;
  const verboseHexDump = !!opts.verboseHexDump;
  const socketChunkSize = opts.socketChunkSize;

  const semverVersion = _semver.default.coerce(osVersion);

  if (!semverVersion) {
    throw new Error(`Could not create a semver version out of '${osVersion}'`);
  }

  const socketClient = opts.socket || (await startService(udid, _webinspector.WEB_INSPECTOR_SERVICE_NAME));
  return new _webinspector.WebInspectorService({
    majorOsVersion: semverVersion.major,
    isSimulator,
    socketChunkSize,
    verbose,
    verboseHexDump,
    socketClient
  });
}

async function startInstallationProxyService(udid, opts = {}) {
  return new _installationProxy.InstallationProxyService(new _plistService.default((await startService(udid, _installationProxy.INSTALLATION_PROXY_SERVICE_NAME, opts.socket))));
}

async function startAfcService(udid, opts = {}) {
  return new _afc.AfcService((await startService(udid, _afc.AFC_SERVICE_NAME, opts.socket)));
}

async function startNotificationProxyService(udid, opts = {}) {
  return new _notificationProxy.NotificationProxyService((await startService(udid, _notificationProxy.NOTIFICATION_PROXY_SERVICE_NAME, opts.socket)));
}

async function startHouseArrestService(udid, opts = {}) {
  return new _houseArrest.HouseArrestService((await startService(udid, _houseArrest.HOUSE_ARREST_SERVICE_NAME, opts.socket)));
}

async function startService(udid, serviceName, socket) {
  const lockdown = await (0, _utilities.startLockdownSession)(udid, socket);

  try {
    const service = await lockdown.startService(serviceName);

    if (service.EnableServiceSSL) {
      return await (0, _utilities.connectPortSSL)(udid, service.Port, socket);
    } else {
      return await (0, _utilities.connectPort)(udid, service.Port, socket);
    }
  } finally {
    lockdown.close();
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy5qcyJdLCJuYW1lcyI6WyJzdGFydFN5c2xvZ1NlcnZpY2UiLCJ1ZGlkIiwib3B0cyIsIlN5c2xvZ1NlcnZpY2UiLCJzdGFydFNlcnZpY2UiLCJTWVNMT0dfU0VSVklDRV9OQU1FIiwic29ja2V0Iiwic3RhcnRTaW11bGF0ZUxvY2F0aW9uU2VydmljZSIsIlNpbXVsYXRlTG9jYXRpb25TZXJ2aWNlIiwiU0lNVUxBVEVfTE9DQVRJT05fU0VSVklDRV9OQU1FIiwic3RhcnRXZWJJbnNwZWN0b3JTZXJ2aWNlIiwib3NWZXJzaW9uIiwiaXNTaW11bGF0b3IiLCJ2ZXJib3NlIiwidmVyYm9zZUhleER1bXAiLCJzb2NrZXRDaHVua1NpemUiLCJzZW12ZXJWZXJzaW9uIiwic2VtdmVyIiwiY29lcmNlIiwiRXJyb3IiLCJzb2NrZXRDbGllbnQiLCJXRUJfSU5TUEVDVE9SX1NFUlZJQ0VfTkFNRSIsIldlYkluc3BlY3RvclNlcnZpY2UiLCJtYWpvck9zVmVyc2lvbiIsIm1ham9yIiwic3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UiLCJJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UiLCJQbGlzdFNlcnZpY2UiLCJJTlNUQUxMQVRJT05fUFJPWFlfU0VSVklDRV9OQU1FIiwic3RhcnRBZmNTZXJ2aWNlIiwiQWZjU2VydmljZSIsIkFGQ19TRVJWSUNFX05BTUUiLCJzdGFydE5vdGlmaWNhdGlvblByb3h5U2VydmljZSIsIk5vdGlmaWNhdGlvblByb3h5U2VydmljZSIsIk5PVElGSUNBVElPTl9QUk9YWV9TRVJWSUNFX05BTUUiLCJzdGFydEhvdXNlQXJyZXN0U2VydmljZSIsIkhvdXNlQXJyZXN0U2VydmljZSIsIkhPVVNFX0FSUkVTVF9TRVJWSUNFX05BTUUiLCJzZXJ2aWNlTmFtZSIsImxvY2tkb3duIiwic2VydmljZSIsIkVuYWJsZVNlcnZpY2VTU0wiLCJQb3J0IiwiY2xvc2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7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QUFDSSxNQUF2QyxDQUF6QyxFQUFQO0FBQ0Q7O0FBRUQsZUFBZUYsWUFBZixDQUE2QkgsSUFBN0IsRUFBbUNxQyxXQUFuQyxFQUFnRGhDLE1BQWhELEVBQXdEO0FBQ3RELFFBQU1pQyxRQUFRLEdBQUcsTUFBTSxxQ0FBcUJ0QyxJQUFyQixFQUEyQkssTUFBM0IsQ0FBdkI7O0FBQ0EsTUFBSTtBQUNGLFVBQU1rQyxPQUFPLEdBQUcsTUFBTUQsUUFBUSxDQUFDbkMsWUFBVCxDQUFzQmtDLFdBQXRCLENBQXRCOztBQUNBLFFBQUlFLE9BQU8sQ0FBQ0MsZ0JBQVosRUFBOEI7QUFDNUIsYUFBTyxNQUFNLCtCQUFleEMsSUFBZixFQUFxQnVDLE9BQU8sQ0FBQ0UsSUFBN0IsRUFBbUNwQyxNQUFuQyxDQUFiO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsYUFBTyxNQUFNLDRCQUFZTCxJQUFaLEVBQWtCdUMsT0FBTyxDQUFDRSxJQUExQixFQUFnQ3BDLE1BQWhDLENBQWI7QUFDRDtBQUNGLEdBUEQsU0FPVTtBQUNSaUMsSUFBQUEsUUFBUSxDQUFDSSxLQUFUO0FBQ0Q7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvbm5lY3RQb3J0LCBjb25uZWN0UG9ydFNTTCwgc3RhcnRMb2NrZG93blNlc3Npb24sIGdldE9TVmVyc2lvbiB9IGZyb20gJy4vdXRpbGl0aWVzJztcbmltcG9ydCB7IFN5c2xvZ1NlcnZpY2UsIFNZU0xPR19TRVJWSUNFX05BTUUgfSBmcm9tICcuL3N5c2xvZyc7XG5pbXBvcnQgeyBTaW11bGF0ZUxvY2F0aW9uU2VydmljZSwgU0lNVUxBVEVfTE9DQVRJT05fU0VSVklDRV9OQU1FIH0gZnJvbSAnLi9zaW11bGF0ZWxvY2F0aW9uJztcbmltcG9ydCB7IFdlYkluc3BlY3RvclNlcnZpY2UsIFdFQl9JTlNQRUNUT1JfU0VSVklDRV9OQU1FIH0gZnJvbSAnLi93ZWJpbnNwZWN0b3InO1xuaW1wb3J0IHsgSW5zdGFsbGF0aW9uUHJveHlTZXJ2aWNlLCBJTlNUQUxMQVRJT05fUFJPWFlfU0VSVklDRV9OQU1FIH0gZnJvbSAnLi9pbnN0YWxsYXRpb24tcHJveHknO1xuaW1wb3J0IHsgQWZjU2VydmljZSwgQUZDX1NFUlZJQ0VfTkFNRSB9IGZyb20gJy4vYWZjJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvblByb3h5U2VydmljZSwgTk9USUZJQ0FUSU9OX1BST1hZX1NFUlZJQ0VfTkFNRSB9IGZyb20gJy4vbm90aWZpY2F0aW9uLXByb3h5JztcbmltcG9ydCB7IEhvdXNlQXJyZXN0U2VydmljZSwgSE9VU0VfQVJSRVNUX1NFUlZJQ0VfTkFNRSB9IGZyb20gJy4vaG91c2UtYXJyZXN0JztcbmltcG9ydCBQbGlzdFNlcnZpY2UgZnJvbSAnLi9wbGlzdC1zZXJ2aWNlJztcbmltcG9ydCBzZW12ZXIgZnJvbSAnc2VtdmVyJztcblxuYXN5bmMgZnVuY3Rpb24gc3RhcnRTeXNsb2dTZXJ2aWNlICh1ZGlkLCBvcHRzID0ge30pIHtcbiAgcmV0dXJuIG5ldyBTeXNsb2dTZXJ2aWNlKGF3YWl0IHN0YXJ0U2VydmljZSh1ZGlkLCBTWVNMT0dfU0VSVklDRV9OQU1FLCBvcHRzLnNvY2tldCkpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzdGFydFNpbXVsYXRlTG9jYXRpb25TZXJ2aWNlICh1ZGlkLCBvcHRzID0ge30pIHtcbiAgcmV0dXJuIG5ldyBTaW11bGF0ZUxvY2F0aW9uU2VydmljZShhd2FpdCBzdGFydFNlcnZpY2UodWRpZCwgU0lNVUxBVEVfTE9DQVRJT05fU0VSVklDRV9OQU1FLCBvcHRzLnNvY2tldCkpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzdGFydFdlYkluc3BlY3RvclNlcnZpY2UgKHVkaWQsIG9wdHMgPSB7fSkge1xuICBjb25zdCBvc1ZlcnNpb24gPSBvcHRzLm9zVmVyc2lvbiB8fCBhd2FpdCBnZXRPU1ZlcnNpb24odWRpZCwgb3B0cy5zb2NrZXQpO1xuICBjb25zdCBpc1NpbXVsYXRvciA9ICEhb3B0cy5pc1NpbXVsYXRvcjtcbiAgY29uc3QgdmVyYm9zZSA9ICEhb3B0cy52ZXJib3NlO1xuICBjb25zdCB2ZXJib3NlSGV4RHVtcCA9ICEhb3B0cy52ZXJib3NlSGV4RHVtcDtcbiAgY29uc3Qgc29ja2V0Q2h1bmtTaXplID0gb3B0cy5zb2NrZXRDaHVua1NpemU7XG4gIGNvbnN0IHNlbXZlclZlcnNpb24gPSBzZW12ZXIuY29lcmNlKG9zVmVyc2lvbik7XG4gIGlmICghc2VtdmVyVmVyc2lvbikge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGNyZWF0ZSBhIHNlbXZlciB2ZXJzaW9uIG91dCBvZiAnJHtvc1ZlcnNpb259J2ApO1xuICB9XG4gIGNvbnN0IHNvY2tldENsaWVudCA9IG9wdHMuc29ja2V0IHx8IGF3YWl0IHN0YXJ0U2VydmljZSh1ZGlkLCBXRUJfSU5TUEVDVE9SX1NFUlZJQ0VfTkFNRSk7XG4gIHJldHVybiBuZXcgV2ViSW5zcGVjdG9yU2VydmljZSh7XG4gICAgbWFqb3JPc1ZlcnNpb246IHNlbXZlclZlcnNpb24ubWFqb3IsXG4gICAgaXNTaW11bGF0b3IsXG4gICAgc29ja2V0Q2h1bmtTaXplLFxuICAgIHZlcmJvc2UsXG4gICAgdmVyYm9zZUhleER1bXAsXG4gICAgc29ja2V0Q2xpZW50LFxuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UgKHVkaWQsIG9wdHMgPSB7fSkge1xuICByZXR1cm4gbmV3IEluc3RhbGxhdGlvblByb3h5U2VydmljZShuZXcgUGxpc3RTZXJ2aWNlKGF3YWl0IHN0YXJ0U2VydmljZSh1ZGlkLCBJTlNUQUxMQVRJT05fUFJPWFlfU0VSVklDRV9OQU1FLCBvcHRzLnNvY2tldCkpKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc3RhcnRBZmNTZXJ2aWNlICh1ZGlkLCBvcHRzID0ge30pIHtcbiAgcmV0dXJuIG5ldyBBZmNTZXJ2aWNlKGF3YWl0IHN0YXJ0U2VydmljZSh1ZGlkLCBBRkNfU0VSVklDRV9OQU1FLCBvcHRzLnNvY2tldCkpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzdGFydE5vdGlmaWNhdGlvblByb3h5U2VydmljZSAodWRpZCwgb3B0cyA9IHt9KSB7XG4gIHJldHVybiBuZXcgTm90aWZpY2F0aW9uUHJveHlTZXJ2aWNlKGF3YWl0IHN0YXJ0U2VydmljZSh1ZGlkLCBOT1RJRklDQVRJT05fUFJPWFlfU0VSVklDRV9OQU1FLCBvcHRzLnNvY2tldCkpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzdGFydEhvdXNlQXJyZXN0U2VydmljZSAodWRpZCwgb3B0cyA9IHt9KSB7XG4gIHJldHVybiBuZXcgSG91c2VBcnJlc3RTZXJ2aWNlKGF3YWl0IHN0YXJ0U2VydmljZSh1ZGlkLCBIT1VTRV9BUlJFU1RfU0VSVklDRV9OQU1FLCBvcHRzLnNvY2tldCkpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzdGFydFNlcnZpY2UgKHVkaWQsIHNlcnZpY2VOYW1lLCBzb2NrZXQpIHtcbiAgY29uc3QgbG9ja2Rvd24gPSBhd2FpdCBzdGFydExvY2tkb3duU2Vzc2lvbih1ZGlkLCBzb2NrZXQpO1xuICB0cnkge1xuICAgIGNvbnN0IHNlcnZpY2UgPSBhd2FpdCBsb2NrZG93bi5zdGFydFNlcnZpY2Uoc2VydmljZU5hbWUpO1xuICAgIGlmIChzZXJ2aWNlLkVuYWJsZVNlcnZpY2VTU0wpIHtcbiAgICAgIHJldHVybiBhd2FpdCBjb25uZWN0UG9ydFNTTCh1ZGlkLCBzZXJ2aWNlLlBvcnQsIHNvY2tldCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBhd2FpdCBjb25uZWN0UG9ydCh1ZGlkLCBzZXJ2aWNlLlBvcnQsIHNvY2tldCk7XG4gICAgfVxuICB9IGZpbmFsbHkge1xuICAgIGxvY2tkb3duLmNsb3NlKCk7XG4gIH1cbn1cblxuZXhwb3J0IHtcbiAgc3RhcnRTeXNsb2dTZXJ2aWNlLCBzdGFydFdlYkluc3BlY3RvclNlcnZpY2UsXG4gIHN0YXJ0SW5zdGFsbGF0aW9uUHJveHlTZXJ2aWNlLCBzdGFydFNpbXVsYXRlTG9jYXRpb25TZXJ2aWNlLFxuICBzdGFydEFmY1NlcnZpY2UsIHN0YXJ0Tm90aWZpY2F0aW9uUHJveHlTZXJ2aWNlLFxuICBzdGFydEhvdXNlQXJyZXN0U2VydmljZVxufTtcbiJdLCJmaWxlIjoibGliL3NlcnZpY2VzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
