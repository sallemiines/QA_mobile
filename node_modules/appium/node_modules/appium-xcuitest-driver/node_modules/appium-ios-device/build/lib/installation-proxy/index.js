"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.INSTALLATION_PROXY_SERVICE_NAME = exports.InstallationProxyService = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _baseService = require("../base-service");

const INSTALLATION_PROXY_SERVICE_NAME = 'com.apple.mobile.installation_proxy';
exports.INSTALLATION_PROXY_SERVICE_NAME = INSTALLATION_PROXY_SERVICE_NAME;

class InstallationProxyService extends _baseService.BaseServicePlist {
  async installApplication(path, clientOptions = {}, timeout = 60000) {
    const request = {
      Command: 'Install',
      PackagePath: path,
      ClientOptions: clientOptions
    };

    this._plistService.sendPlist(request);

    return await this._waitMessageCompletion(timeout);
  }

  async listApplications(opts = {}) {
    const request = {
      Command: 'Browse',
      ClientOptions: {}
    };

    if (opts.applicationType) {
      request.ClientOptions.ApplicationType = opts.applicationType;
    }

    if (opts.returnAttributes) {
      request.ClientOptions.ReturnAttributes = opts.returnAttributes;
    }

    this._plistService.sendPlist(request);

    const messages = await this._waitMessageCompletion();
    return messages.reduce((acc, message) => {
      if (!message.CurrentList) {
        return acc;
      }

      message.CurrentList.forEach(app => {
        acc[app.CFBundleIdentifier] = app;
      });
      return acc;
    }, {});
  }

  async lookupApplications(opts = {}) {
    const request = {
      Command: 'Lookup',
      ClientOptions: {}
    };

    if (opts.bundleIds) {
      request.ClientOptions.BundleIDs = _lodash.default.isString(opts.bundleIds) ? [opts.bundleIds] : opts.bundleIds;
    }

    if (opts.applicationType) {
      request.ClientOptions.ApplicationType = opts.applicationType;
    }

    if (opts.returnAttributes) {
      request.ClientOptions.ReturnAttributes = opts.returnAttributes;
    }

    this._plistService.sendPlist(request);

    const messages = await this._waitMessageCompletion();

    for (const message of messages) {
      if (message.LookupResult) {
        return message.LookupResult;
      }
    }

    throw new Error(`Could not find LookupResult in the response: Response: ${JSON.stringify(messages)}`);
  }

  async uninstallApplication(bundleId, timeout = 20000) {
    const request = {
      Command: 'Uninstall',
      ApplicationIdentifier: bundleId
    };

    this._plistService.sendPlist(request);

    return await this._waitMessageCompletion(timeout);
  }

  async _waitMessageCompletion(timeout) {
    let messages = [];

    for (let i = 0; i < Number.MAX_SAFE_INTEGER; i++) {
      const data = await this._plistService.receivePlist(timeout);
      messages.push(data);

      if (this._isFinished(data)) {
        return messages;
      }
    }
  }

  _isFinished(response) {
    if (response.Error) {
      throw new Error(`Unexpected data: ${JSON.stringify(response)}`);
    }

    if (!response.Status) {
      return false;
    }

    return response.Status === 'Complete';
  }

}

exports.InstallationProxyService = InstallationProxyService;
var _default = InstallationProxyService;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0YWxsYXRpb24tcHJveHkvaW5kZXguanMiXSwibmFtZXMiOlsiSU5TVEFMTEFUSU9OX1BST1hZX1NFUlZJQ0VfTkFNRSIsIkluc3RhbGxhdGlvblByb3h5U2VydmljZSIsIkJhc2VTZXJ2aWNlUGxpc3QiLCJpbnN0YWxsQXBwbGljYXRpb24iLCJwYXRoIiwiY2xpZW50T3B0aW9ucyIsInRpbWVvdXQiLCJyZXF1ZXN0IiwiQ29tbWFuZCIsIlBhY2thZ2VQYXRoIiwiQ2xpZW50T3B0aW9ucyIsIl9wbGlzdFNlcnZpY2UiLCJzZW5kUGxpc3QiLCJfd2FpdE1lc3NhZ2VDb21wbGV0aW9uIiwibGlzdEFwcGxpY2F0aW9ucyIsIm9wdHMiLCJhcHBsaWNhdGlvblR5cGUiLCJBcHBsaWNhdGlvblR5cGUiLCJyZXR1cm5BdHRyaWJ1dGVzIiwiUmV0dXJuQXR0cmlidXRlcyIsIm1lc3NhZ2VzIiwicmVkdWNlIiwiYWNjIiwibWVzc2FnZSIsIkN1cnJlbnRMaXN0IiwiZm9yRWFjaCIsImFwcCIsIkNGQnVuZGxlSWRlbnRpZmllciIsImxvb2t1cEFwcGxpY2F0aW9ucyIsImJ1bmRsZUlkcyIsIkJ1bmRsZUlEcyIsIl8iLCJpc1N0cmluZyIsIkxvb2t1cFJlc3VsdCIsIkVycm9yIiwiSlNPTiIsInN0cmluZ2lmeSIsInVuaW5zdGFsbEFwcGxpY2F0aW9uIiwiYnVuZGxlSWQiLCJBcHBsaWNhdGlvbklkZW50aWZpZXIiLCJpIiwiTnVtYmVyIiwiTUFYX1NBRkVfSU5URUdFUiIsImRhdGEiLCJyZWNlaXZlUGxpc3QiLCJwdXNoIiwiX2lzRmluaXNoZWQiLCJyZXNwb25zZSIsIlN0YXR1cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQSxNQUFNQSwrQkFBK0IsR0FBRyxxQ0FBeEM7OztBQUVBLE1BQU1DLHdCQUFOLFNBQXVDQyw2QkFBdkMsQ0FBd0Q7QUFPdEQsUUFBTUMsa0JBQU4sQ0FBMEJDLElBQTFCLEVBQWdDQyxhQUFhLEdBQUcs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dCB7IEJhc2VTZXJ2aWNlUGxpc3QgfSBmcm9tICcuLi9iYXNlLXNlcnZpY2UnO1xuXG5jb25zdCBJTlNUQUxMQVRJT05fUFJPWFlfU0VSVklDRV9OQU1FID0gJ2NvbS5hcHBsZS5tb2JpbGUuaW5zdGFsbGF0aW9uX3Byb3h5JztcblxuY2xhc3MgSW5zdGFsbGF0aW9uUHJveHlTZXJ2aWNlIGV4dGVuZHMgQmFzZVNlcnZpY2VQbGlzdCB7XG4gIC8qKlxuICAgKiBJbnN0YWxsIHRoZSBhcHBsaWNhdGlvbiBvbiB0aGUgcmVsYXRpdmUgcGF0aCBvbiB0aGUgcGhvbmVcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggVGhlIHBhdGggd2hlcmUgdGhlIC5hcHAgYW5kIC5pcGEgaXMgbG9jYXRlZCBhdCBvbiB0aGUgcGhvbmVcbiAgICogQHBhcmFtIHtPYmplY3R9IGNsaWVudE9wdGlvbnMgVGhlIGV4dHJhIG9wdGlvbnMgdGhhdCB3YW50cyB0byBiZSBwYXNzZWQgdG8gdGhlIGluc3RhbGxkXG4gICAqIEBwYXJhbSB7bnVtYmVyfSB0aW1lb3V0IFs2MDAwMF0gVGhlIHRpbWVvdXQgYmV0d2VlbiBtZXNzYWdlcyByZWNlaXZlZCBmcm9tIHRoZSBwaG9uZSBhcyBzdGF0dXMgdXBkYXRlc1xuICAgKi9cbiAgYXN5bmMgaW5zdGFsbEFwcGxpY2F0aW9uIChwYXRoLCBjbGllbnRPcHRpb25zID0ge30sIHRpbWVvdXQgPSA2MDAwMCkge1xuICAgIGNvbnN0IHJlcXVlc3QgPSB7XG4gICAgICBDb21tYW5kOiAnSW5zdGFsbCcsXG4gICAgICBQYWNrYWdlUGF0aDogcGF0aCxcbiAgICAgIENsaWVudE9wdGlvbnM6IGNsaWVudE9wdGlvbnNcbiAgICB9O1xuXG4gICAgdGhpcy5fcGxpc3RTZXJ2aWNlLnNlbmRQbGlzdChyZXF1ZXN0KTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5fd2FpdE1lc3NhZ2VDb21wbGV0aW9uKHRpbWVvdXQpO1xuICB9XG5cbiAgLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBMaXN0QXBwbGljYXRpb25PcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHtzdHJpbmd9IGFwcGxpY2F0aW9uVHlwZSBvZiB0aGUgd2hpY2ggZ3JvdXAgeW91IHdhbnQgdG8gbGlzdC4gVGhlc2UgY2FuIGJlIFVzZXIsIFN5c3RlbSBvciBsZWF2ZSBpdCBlbXB0eSBmb3IgYm90aFxuICogQHByb3BlcnR5IHtBcnJheX0gcmV0dXJuQXR0cmlidXRlcyB0aGUgZmllbGRzIHdoaWNoIHNob3VsZCBiZSBmaWx0ZXJlZCBhbmQgcmV0dXJuZWQgdG8gdGhlIGNsaWVudC4gTGVhdmUgdGhpcyBwYXJhbWV0ZXIgZW1wdHkgaWYgeW91IGRvbid0IHdhbnQgdG8gZmlsdGVyXG4gKi9cblxuICAvKipcbiAgICogTGlzdHMgYXBwbGljYXRpb25zIGFjY29yZGluZyB0byB0aGUgb3B0cyBhbmQgcmV0dXJucyB0aGVtIGFzIGEgbWFwXG4gICAqIEBwYXJhbSB7TGlzdEFwcGxpY2F0aW9uT3B0aW9uc30gb3B0cyB0aGUgbGlzdGluZyBvcHRpb25zIHRoYXQgd2FudHMgdG8gYmUgcGFzc2VkXG4gICAqIEByZXR1cm5zIEEgbWFwIG9mIHRoZSBhcHBsaWNhdGlvbnMgd2hpY2ggdGhlIGtleSBpcyB0aGUgYnVuZGxlSWRcbiAgICovXG4gIGFzeW5jIGxpc3RBcHBsaWNhdGlvbnMgKG9wdHMgPSB7fSkge1xuICAgIGNvbnN0IHJlcXVlc3QgPSB7XG4gICAgICBDb21tYW5kOiAnQnJvd3NlJyxcbiAgICAgIENsaWVudE9wdGlvbnM6IHt9XG4gICAgfTtcblxuICAgIGlmIChvcHRzLmFwcGxpY2F0aW9uVHlwZSkge1xuICAgICAgcmVxdWVzdC5DbGllbnRPcHRpb25zLkFwcGxpY2F0aW9uVHlwZSA9IG9wdHMuYXBwbGljYXRpb25UeXBlO1xuICAgIH1cbiAgICBpZiAob3B0cy5yZXR1cm5BdHRyaWJ1dGVzKSB7XG4gICAgICByZXF1ZXN0LkNsaWVudE9wdGlvbnMuUmV0dXJuQXR0cmlidXRlcyA9IG9wdHMucmV0dXJuQXR0cmlidXRlcztcbiAgICB9XG5cbiAgICB0aGlzLl9wbGlzdFNlcnZpY2Uuc2VuZFBsaXN0KHJlcXVlc3QpO1xuICAgIGNvbnN0IG1lc3NhZ2VzID0gYXdhaXQgdGhpcy5fd2FpdE1lc3NhZ2VDb21wbGV0aW9uKCk7XG4gICAgcmV0dXJuIG1lc3NhZ2VzLnJlZHVjZSgoYWNjLCBtZXNzYWdlKSA9PiB7XG4gICAgICBpZiAoIW1lc3NhZ2UuQ3VycmVudExpc3QpIHtcbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH1cbiAgICAgIG1lc3NhZ2UuQ3VycmVudExpc3QuZm9yRWFjaChhcHAgPT4ge1xuICAgICAgICBhY2NbYXBwLkNGQnVuZGxlSWRlbnRpZmllcl0gPSBhcHA7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBhY2M7XG4gICAgfSwge30pO1xuICB9XG5cbiAgLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBMb29rdXBBcHBsaWNhdGlvbk9wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkge3N0cmluZ30gYXBwbGljYXRpb25UeXBlIG9mIHRoZSB3aGljaCBncm91cCB5b3Ugd2FudCB0byBsaXN0LiBUaGVzZSBjYW4gYmUgVXNlciwgU3lzdGVtIG9yIGxlYXZlIGl0IGVtcHR5IGZvciBib3RoXG4gKiBAcHJvcGVydHkge0FycmF5fSByZXR1cm5BdHRyaWJ1dGVzIHRoZSBmaWVsZHMgd2hpY2ggc2hvdWxkIGJlIGZpbHRlcmVkIGFuZCByZXR1cm5lZCB0byB0aGUgY2xpZW50LiBMZWF2ZSB0aGlzIHBhcmFtZXRlciBlbXB0eSBpZiB5b3UgZG9uJ3Qgd2FudCB0byBmaWx0ZXJcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfEFycmF5fSBidW5kbGVJZHMgQnVuZGxlIElkcyBvZiB0aGUgYXBwcyB0aGF0IHNob3VsZCBiZSBzZWFyY2hlZFxuICovXG5cbiAgLyoqXG4gICAqIExpc3RzIGFwcGxpY2F0aW9ucyBhY2NvcmRpbmcgdG8gdGhlIG9wdHMgYW5kIHJldHVybnMgdGhlbSBhcyBhIG1hcFxuICAgKiBAcGFyYW0ge0xvb2t1cEFwcGxpY2F0aW9uT3B0aW9uc30gb3B0cyB0aGUgbG9va3VwIG9wdGlvbnMgdGhhdCB3YW50cyB0byBiZSBwYXNzZWRcbiAgICogQHJldHVybnMgQSBtYXAgb2YgdGhlIGFwcGxpY2F0aW9ucyB3aGljaCB0aGUga2V5IGlzIHRoZSBidW5kbGVJZFxuICAgKi9cbiAgYXN5bmMgbG9va3VwQXBwbGljYXRpb25zIChvcHRzID0ge30pIHtcbiAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgQ29tbWFuZDogJ0xvb2t1cCcsXG4gICAgICBDbGllbnRPcHRpb25zOiB7fVxuICAgIH07XG4gICAgaWYgKG9wdHMuYnVuZGxlSWRzKSB7XG4gICAgICByZXF1ZXN0LkNsaWVudE9wdGlvbnMuQnVuZGxlSURzID0gXy5pc1N0cmluZyhvcHRzLmJ1bmRsZUlkcykgPyBbb3B0cy5idW5kbGVJZHNdIDogb3B0cy5idW5kbGVJZHM7XG4gICAgfVxuICAgIGlmIChvcHRzLmFwcGxpY2F0aW9uVHlwZSkge1xuICAgICAgcmVxdWVzdC5DbGllbnRPcHRpb25zLkFwcGxpY2F0aW9uVHlwZSA9IG9wdHMuYXBwbGljYXRpb25UeXBlO1xuICAgIH1cbiAgICBpZiAob3B0cy5yZXR1cm5BdHRyaWJ1dGVzKSB7XG4gICAgICByZXF1ZXN0LkNsaWVudE9wdGlvbnMuUmV0dXJuQXR0cmlidXRlcyA9IG9wdHMucmV0dXJuQXR0cmlidXRlcztcbiAgICB9XG5cbiAgICB0aGlzLl9wbGlzdFNlcnZpY2Uuc2VuZFBsaXN0KHJlcXVlc3QpO1xuICAgIGNvbnN0IG1lc3NhZ2VzID0gYXdhaXQgdGhpcy5fd2FpdE1lc3NhZ2VDb21wbGV0aW9uKCk7XG4gICAgZm9yIChjb25zdCBtZXNzYWdlIG9mIG1lc3NhZ2VzKSB7XG4gICAgICBpZiAobWVzc2FnZS5Mb29rdXBSZXN1bHQpIHtcbiAgICAgICAgcmV0dXJuIG1lc3NhZ2UuTG9va3VwUmVzdWx0O1xuICAgICAgfVxuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBmaW5kIExvb2t1cFJlc3VsdCBpbiB0aGUgcmVzcG9uc2U6IFJlc3BvbnNlOiAke0pTT04uc3RyaW5naWZ5KG1lc3NhZ2VzKX1gKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVbmluc3RhbGxzIGFuIGFwcGxpY2F0aW9uIGFjY29yZGluZyB0byB0aGUgZ2l2ZW4gYnVuZGxlSWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IGJ1bmRsZUlkIG9mIHRoZSBhcHAgdGhhdCBuZWVkcyB0byBiZSBwYXNzZWQgZm9yIHVuaW5zdGFsbGF0aW9uXG4gICAqIEBwYXJhbSB7bnVtYmVyfSB0aW1lb3V0IFRoZSB0aW1lb3V0IGJldHdlZW4gbWVzc2FnZXMgcmVjZWl2ZWQgZnJvbSB0aGUgcGhvbmUgYXMgc3RhdHVzIHVwZGF0ZXNcbiAgICovXG4gIGFzeW5jIHVuaW5zdGFsbEFwcGxpY2F0aW9uIChidW5kbGVJZCwgdGltZW91dCA9IDIwMDAwKSB7XG4gICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgIENvbW1hbmQ6ICdVbmluc3RhbGwnLFxuICAgICAgQXBwbGljYXRpb25JZGVudGlmaWVyOiBidW5kbGVJZFxuICAgIH07XG5cbiAgICB0aGlzLl9wbGlzdFNlcnZpY2Uuc2VuZFBsaXN0KHJlcXVlc3QpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLl93YWl0TWVzc2FnZUNvbXBsZXRpb24odGltZW91dCk7XG4gIH1cblxuICBhc3luYyBfd2FpdE1lc3NhZ2VDb21wbGV0aW9uICh0aW1lb3V0KSB7XG4gICAgbGV0IG1lc3NhZ2VzID0gW107XG4gICAgLy8gSnVzdCBhZGRlZCBmb3Igc2FmZXR5LiBUaGlzIHNob3VsZG4ndCBoYXBwZW5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSOyBpKyspIHtcbiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLl9wbGlzdFNlcnZpY2UucmVjZWl2ZVBsaXN0KHRpbWVvdXQpO1xuICAgICAgbWVzc2FnZXMucHVzaChkYXRhKTtcbiAgICAgIGlmICh0aGlzLl9pc0ZpbmlzaGVkKGRhdGEpKSB7XG4gICAgICAgIHJldHVybiBtZXNzYWdlcztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBfaXNGaW5pc2hlZCAocmVzcG9uc2UpIHtcbiAgICBpZiAocmVzcG9uc2UuRXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBkYXRhOiAke0pTT04uc3RyaW5naWZ5KHJlc3BvbnNlKX1gKTtcbiAgICB9XG5cbiAgICBpZiAoIXJlc3BvbnNlLlN0YXR1cykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gcmVzcG9uc2UuU3RhdHVzID09PSAnQ29tcGxldGUnO1xuICB9XG59XG5cbmV4cG9ydCB7IEluc3RhbGxhdGlvblByb3h5U2VydmljZSwgSU5TVEFMTEFUSU9OX1BST1hZX1NFUlZJQ0VfTkFNRSB9O1xuZXhwb3J0IGRlZmF1bHQgSW5zdGFsbGF0aW9uUHJveHlTZXJ2aWNlO1xuIl0sImZpbGUiOiJsaWIvaW5zdGFsbGF0aW9uLXByb3h5L2luZGV4LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
