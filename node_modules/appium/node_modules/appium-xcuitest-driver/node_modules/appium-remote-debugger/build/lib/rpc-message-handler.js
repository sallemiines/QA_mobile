"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

const IGNORED_EVENTS = ['Page.defaultAppearanceDidChange', 'Page.domContentEventFired', 'Page.frameStartedLoading', 'Page.frameStoppedLoading', 'Page.frameScheduledNavigation', 'Page.frameClearedScheduledNavigation', 'Page.loadEventFired', 'Console.messagesCleared', 'Debugger.scriptParsed', 'Debugger.globalObjectCleared', 'Runtime.executionContextCreated', 'Heap.garbageCollected'];

class RpcMessageHandler {
  constructor(specialHandlers, isTargetBased = false) {
    this.setHandlers();
    this.errorHandlers = {};
    this.specialHandlers = _lodash.default.clone(specialHandlers);
    this.dataHandlers = {};
    this.isTargetBased = isTargetBased;
  }

  setCommunicationProtocol(isTargetBased) {
    this.isTargetBased = isTargetBased;
  }

  setDataMessageHandler(key, errorHandler, handler) {
    this.errorHandlers[key] = errorHandler;
    this.dataHandlers[key] = handler;
  }

  setSpecialMessageHandler(key, errorHandler, handler) {
    this.errorHandlers[key] = errorHandler;
    this.specialHandlers[key] = handler;
  }

  getSpecialMessageHandler(key) {
    return this.specialHandlers[key];
  }

  setTimelineEventHandler(timelineEventHandler) {
    this.timelineEventHandler = timelineEventHandler;
  }

  setConsoleLogEventHandler(consoleLogEventHandler) {
    this.consoleLogEventHandler = consoleLogEventHandler;
  }

  setNetworkEventHandler(networkLogEventHandler) {
    this.networkLogEventHandler = networkLogEventHandler;
  }

  hasErrorHandler(key) {
    return _lodash.default.has(this.errorHandlers, key);
  }

  hasSpecialMessageHandler(key) {
    return _lodash.default.has(this.specialHandlers, key);
  }

  async handleMessage(plist) {
    const selector = plist.__selector;

    if (!selector) {
      _logger.default.debug('Got an invalid plist');

      return;
    }

    if (_lodash.default.has(this.handlers, selector)) {
      await this.handlers[selector](plist);
    } else {
      _logger.default.debug(`Debugger got a message for '${selector}' and have no ` + `handler, doing nothing.`);
    }
  }

  async handleSpecialMessage(handler, ...args) {
    const fn = this.specialHandlers[handler];

    if (fn) {
      if (handler !== '_rpc_forwardGetListing:' && handler !== '_rpc_applicationDisconnected:' && handler !== '_rpc_applicationConnected:' && handler !== '_rpc_applicationUpdated:' && handler !== '_rpc_reportConnectedDriverList:') {
        this.specialHandlers[handler] = null;
      }

      await fn(...args);
    } else {
      _logger.default.warn(`Tried to access special message handler '${handler}' ` + `but none was found`);
    }
  }

  parseDataKey(plist) {
    try {
      return JSON.parse(plist.__argument.WIRMessageDataKey.toString('utf8'));
    } catch (err) {
      _logger.default.error(`Unparseable message data: ${_lodash.default.truncate(JSON.stringify(plist), {
        length: 100
      })}`);

      throw new Error(`Unable to parse message data: ${err.message}`);
    }
  }

  async dispatchDataMessage(msgId, method, params, result, error) {
    if (!_lodash.default.isEmpty(msgId)) {
      _logger.default.debug(`Handling message (id: '${msgId}')`);
    }

    if (method === 'Profiler.resetProfiles') {
      _logger.default.debug('Device is telling us to reset profiles. Should probably ' + 'do some kind of callback here');
    } else if (method === 'Page.frameNavigated' || method === 'Page.frameStoppedLoading') {
      if (_lodash.default.isFunction(this.specialHandlers['Page.frameNavigated'])) {
        await this.specialHandlers['Page.frameNavigated'](`'${method}' event`);
        this.specialHandlers['Page.frameNavigated'] = null;
      }
    } else if (IGNORED_EVENTS.includes(method)) {} else if (method === 'Page.frameDetached' && _lodash.default.isFunction(this.specialHandlers.frameDetached)) {
      await this.specialHandlers.frameDetached();
    } else if (method === 'Timeline.eventRecorded' && _lodash.default.isFunction(this.timelineEventHandler)) {
      this.timelineEventHandler(params || params.record);
    } else if (method === 'Console.messageAdded' && _lodash.default.isFunction(this.consoleLogEventHandler)) {
      this.consoleLogEventHandler(params.message);
    } else if (method === 'Console.messageRepeatCountUpdated' && _lodash.default.isFunction(this.consoleLogEventHandler)) {
      this.consoleLogEventHandler(params);
    } else if (method && method.startsWith('Network.') && _lodash.default.isFunction(this.networkLogEventHandler)) {
      this.networkLogEventHandler(method, params);
    } else if (_lodash.default.isFunction(this.dataHandlers[msgId])) {
      if (result.result && result.result.value) {
        result = result.result.value;
      }

      this.dataHandlers[msgId](result);
      this.dataHandlers[msgId] = null;
    } else if (this.dataHandlers[msgId] === null) {
      _logger.default.error(`Debugger returned data for message '${msgId}' ` + `but we already ran that callback! WTF??`);
    } else {
      if (msgId || result || error) {
        _logger.default.error(`Debugger returned data for message '${msgId}' ` + `but we were not waiting for that message! ` + `result: '${JSON.stringify(result)}'; ` + `error: '${error}'`);
      }
    }
  }

  async handleDataMessage(plist) {
    const dataKey = this.parseDataKey(plist);
    let msgId = (dataKey.id || '').toString();
    let result = dataKey.result;
    let method = dataKey.method;
    let params;

    if (method === 'Target.targetCreated') {
      const app = plist.__argument.WIRApplicationIdentifierKey;
      const targetInfo = dataKey.params.targetInfo;
      await this.specialHandlers.targetCreated(app, targetInfo);
      return;
    } else if (method === 'Target.targetDestroyed') {
      const app = plist.__argument.WIRApplicationIdentifierKey;
      const targetInfo = dataKey.params.targetInfo || {
        targetId: dataKey.params.targetId
      };
      await this.specialHandlers.targetDestroyed(app, targetInfo);
      return;
    }

    if (!dataKey.error && this.isTargetBased) {
      if (dataKey.method !== 'Target.dispatchMessageFromTarget') {
        return;
      }

      let message;

      try {
        message = JSON.parse(dataKey.params.message);
        msgId = message.id;
        method = message.method;
        result = message.result || message;
        params = result.params;
      } catch (err) {
        _logger.default.error(`Unexpected message format from Web Inspector:`);

        this.warn(_appiumSupport.util.jsonStringify(plist));
        throw err;
      }
    } else {
      params = dataKey.params;
    }

    let error = dataKey.error || null;

    if (result && result.wasThrown) {
      const message = result.result && (result.result.value || result.result.description) ? result.result.value || result.result.description : 'Error occurred in handling data message';
      error = new Error(message);
    }

    if (!error) {
      return await this.dispatchDataMessage(msgId, method, params, result, error);
    }

    if (this.hasErrorHandler(msgId)) {
      this.errorHandlers[msgId](error);
    } else {
      _logger.default.error(`Error occurred in handling data message: ${error}`);

      _logger.default.error('No error handler present, ignoring');
    }
  }

  setHandlers() {
    this.handlers = {
      '_rpc_reportSetup:': async plist => {
        await this.handleSpecialMessage('_rpc_reportIdentifier:', plist.__argument.WIRSimulatorNameKey, plist.__argument.WIRSimulatorBuildKey, plist.__argument.WIRSimulatorProductVersionKey);
      },
      '_rpc_reportConnectedApplicationList:': async plist => {
        await this.handleSpecialMessage('_rpc_reportConnectedApplicationList:', plist.__argument.WIRApplicationDictionaryKey);
      },
      '_rpc_applicationSentListing:': async plist => {
        await this.handleSpecialMessage('_rpc_forwardGetListing:', plist.__argument.WIRApplicationIdentifierKey, plist.__argument.WIRListingKey);
      },
      '_rpc_applicationConnected:': async plist => {
        await this.handleSpecialMessage('_rpc_applicationConnected:', plist.__argument);
      },
      '_rpc_applicationDisconnected:': async plist => {
        await this.handleSpecialMessage('_rpc_applicationDisconnected:', plist.__argument);
      },
      '_rpc_applicationUpdated:': async plist => {
        await this.handleSpecialMessage('_rpc_applicationUpdated:', plist.__argument);
      },
      '_rpc_reportConnectedDriverList:': async plist => {
        await this.handleSpecialMessage('_rpc_reportConnectedDriverList:', plist.__argument);
      },
      '_rpc_applicationSentData:': async plist => {
        await this.handleDataMessage(plist);
      }
    };
  }

}

exports.default = RpcMessageHandler;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9ycGMtbWVzc2FnZS1oYW5kbGVyLmpzIl0sIm5hbWVzIjpbIklHTk9SRURfRVZFTlRTIiwiUnBjTWVzc2FnZUhhbmRsZXIiLCJjb25zdHJ1Y3RvciIsInNwZWNpYWxIYW5kbGVycyIsImlzVGFyZ2V0QmFzZWQiLCJzZXRIYW5kbGVycyIsImVycm9ySGFuZGxlcnMiLCJfIiwiY2xvbmUiLCJkYXRhSGFuZGxlcnMiLCJzZXRDb21tdW5pY2F0aW9uUHJvdG9jb2wiLCJzZXREYXRhTWVzc2FnZUhhbmRsZXIiLCJrZXkiLCJlcnJvckhhbmRsZXIiLCJoYW5kbGVyIiwic2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyIiwiZ2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyIiwic2V0VGltZWxpbmVFdmVudEhhbmRsZXIiLCJ0aW1lbGluZUV2ZW50SGFuZGxlciIsInNldENvbnNvbGVMb2dFdmVudEhhbmRsZXIiLCJjb25zb2xlTG9nRXZlbnRIYW5kbGVyIiwic2V0TmV0d29ya0V2ZW50SGFuZGxlciIsIm5ldHdvcmtMb2dFdmVudEhhbmRsZXIiLCJoYXNFcnJvckhhbmRsZXIiLCJoYXMiLCJoYXNTcGVjaWFsTWVzc2FnZUhhbmRsZXIiLCJoYW5kbGVNZXNzYWdlIiwicGxpc3QiLCJzZWxlY3RvciIsIl9fc2VsZWN0b3IiLCJsb2ciLCJkZWJ1ZyIsImhhbmRsZXJzIiwiaGFuZGxlU3BlY2lhbE1lc3NhZ2UiLCJhcmdzIiwiZm4iLCJ3YXJuIiwicGFyc2VEYXRhS2V5IiwiSlNPTiIsInBhcnNlIiwiX19hcmd1bWVudCIsIldJUk1lc3NhZ2VEYXRhS2V5IiwidG9TdHJpbmciLCJlcnIiLCJlcnJvciIsInRydW5jYXRlIiwic3RyaW5naWZ5IiwibGVuZ3RoIiwiRXJyb3IiLCJtZXNzYWdlIiwiZGlzcGF0Y2hEYXRhTWVzc2FnZSIsIm1zZ0lkIiwibWV0aG9kIiwicGFyYW1zIiwicmVzdWx0IiwiaXNFbXB0eSIsImlzRnVuY3Rpb24iLCJpbmNsdWRlcyIsImZyYW1lRGV0YWNoZWQiLCJyZWNvcmQiLCJzdGFydHNXaXRoIiwidmFsdWUiLCJoYW5kbGVEYXRhTWVzc2FnZSIsImRhdGFLZXkiLCJpZCIsImFwcCIsIldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleSIsInRhcmdldEluZm8iLCJ0YXJnZXRDcmVhdGVkIiwidGFyZ2V0SWQiLCJ0YXJnZXREZXN0cm95ZWQiLCJ1dGlsIiwianNvblN0cmluZ2lmeSIsIndhc1Rocm93biIsImRlc2NyaXB0aW9uIiwiV0lSU2ltdWxhdG9yTmFtZUtleSIsIldJUlNpbXVsYXRvckJ1aWxkS2V5IiwiV0lSU2ltdWxhdG9yUHJvZHVjdFZlcnNpb25LZXkiLCJXSVJBcHBsaWNhdGlvbkRpY3Rpb25hcnlLZXkiLCJXSVJMaXN0aW5nS2V5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUtBLE1BQU1BLGNBQWMsR0FBRyxDQUNyQixpQ0FEcUIsRUFFckIsMkJBRnFCLEVBR3JCLDBCQUhxQixFQUlyQiwwQkFKcUIsRUFLckIsK0JBTHFCLEVBTXJCLHNDQU5xQixFQU9yQixxQkFQcUIsRUFRckIseUJBUnFCLEVBU3JCLHVCQVRxQixFQVVyQiw4QkFWcUIsRUFXckIsaUNBWHFCLEVBWXJCLHVCQVpxQixDQUF2Qjs7QUFlZSxNQUFNQyxpQkFBTixDQUF3QjtBQUNyQ0MsRUFBQUEsV0FBVyxDQUFFQyxlQUFGLEVBQW1CQyxhQUFhLEdBQUcsS0FBbkMsRUFBMEM7QUFDbkQsU0FBS0MsV0FBTDtBQUNBLFNBQUtDLGFBQUwsR0FBcUIsRUFBckI7QUFDQSxTQUFLSCxlQUFMLEdBQXVCSSxnQkFBRUMsS0FBRixDQUFRTCxlQUFSLENBQXZCO0FBQ0EsU0FBS00sWUFBTCxHQUFvQixFQUFwQjtBQUVBLFNBQUtMLGFBQUwsR0FBcUJBLGFBQXJCO0FBQ0Q7O0FBRURNLEVBQUFBLHdCQUF3QixDQUFFTixhQUFGLEVBQWlCO0FBQ3ZDLFNBQUtBLGFBQUwsR0FBcUJBLGFBQXJCO0FBQ0Q7O0FBRURPLEVBQUFBLHFCQUFxQixDQUFFQyxH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QUVKdkMsS0FBSyxDQUFDYSxVQUFOLENBQWlCdUMsYUFGYixDQUFOO0FBR0QsT0FmYTtBQWdCZCxvQ0FBOEIsTUFBT3BELEtBQVAsSUFBaUI7QUFDN0MsY0FBTSxLQUFLTSxvQkFBTCxDQUEwQiw0QkFBMUIsRUFDSk4sS0FBSyxDQUFDYSxVQURGLENBQU47QUFFRCxPQW5CYTtBQW9CZCx1Q0FBaUMsTUFBT2IsS0FBUCxJQUFpQjtBQUNoRCxjQUFNLEtBQUtNLG9CQUFMLENBQTBCLCtCQUExQixFQUNKTixLQUFLLENBQUNhLFVBREYsQ0FBTjtBQUVELE9BdkJhO0FBd0JkLGtDQUE0QixNQUFPYixLQUFQLElBQWlCO0FBQzNDLGNBQU0sS0FBS00sb0JBQUwsQ0FBMEIsMEJBQTFCLEVBQ0pOLEtBQUssQ0FBQ2EsVUFERixDQUFOO0FBRUQsT0EzQmE7QUE0QmQseUNBQW1DLE1BQU9iLEtBQVAsSUFBaUI7QUFDbEQsY0FBTSxLQUFLTSxvQkFBTCxDQUEwQixpQ0FBMUIsRUFDSk4sS0FBSyxDQUFDYSxVQURGLENBQU47QUFFRCxPQS9CYTtBQWdDZCxtQ0FBNkIsTUFBT2IsS0FBUCxJQUFpQjtBQUM1QyxjQUFNLEtBQUttQyxpQkFBTCxDQUF1Qm5DLEtBQXZCLENBQU47QUFDRDtBQWxDYSxLQUFoQjtBQW9DRDs7QUF0UG9DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxuXG4vLyB3ZSB3aWxsIHJlY2VpdmUgZXZlbnRzIHRoYXQgd2UgZG8gbm90IGxpc3RlbiB0by5cbi8vIGlmIHdlIHN0YXJ0IHRvIGxpc3RlbiB0byBvbmUgb2YgdGhlc2UsIHJlbW92ZSBpdCBmcm9tIHRoZSBsaXN0XG5jb25zdCBJR05PUkVEX0VWRU5UUyA9IFtcbiAgJ1BhZ2UuZGVmYXVsdEFwcGVhcmFuY2VEaWRDaGFuZ2UnLFxuICAnUGFnZS5kb21Db250ZW50RXZlbnRGaXJlZCcsXG4gICdQYWdlLmZyYW1lU3RhcnRlZExvYWRpbmcnLFxuICAnUGFnZS5mcmFtZVN0b3BwZWRMb2FkaW5nJyxcbiAgJ1BhZ2UuZnJhbWVTY2hlZHVsZWROYXZpZ2F0aW9uJyxcbiAgJ1BhZ2UuZnJhbWVDbGVhcmVkU2NoZWR1bGVkTmF2aWdhdGlvbicsXG4gICdQYWdlLmxvYWRFdmVudEZpcmVkJyxcbiAgJ0NvbnNvbGUubWVzc2FnZXNDbGVhcmVkJyxcbiAgJ0RlYnVnZ2VyLnNjcmlwdFBhcnNlZCcsXG4gICdEZWJ1Z2dlci5nbG9iYWxPYmplY3RDbGVhcmVkJyxcbiAgJ1J1bnRpbWUuZXhlY3V0aW9uQ29udGV4dENyZWF0ZWQnLFxuICAnSGVhcC5nYXJiYWdlQ29sbGVjdGVkJyxcbl07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJwY01lc3NhZ2VIYW5kbGVyIHtcbiAgY29uc3RydWN0b3IgKHNwZWNpYWxIYW5kbGVycywgaXNUYXJnZXRCYXNlZCA9IGZhbHNlKSB7XG4gICAgdGhpcy5zZXRIYW5kbGVycygpO1xuICAgIHRoaXMuZXJyb3JIYW5kbGVycyA9IHt9O1xuICAgIHRoaXMuc3BlY2lhbEhhbmRsZXJzID0gXy5jbG9uZShzcGVjaWFsSGFuZGxlcnMpO1xuICAgIHRoaXMuZGF0YUhhbmRsZXJzID0ge307XG5cbiAgICB0aGlzLmlzVGFyZ2V0QmFzZWQgPSBpc1RhcmdldEJhc2VkO1xuICB9XG5cbiAgc2V0Q29tbXVuaWNhdGlvblByb3RvY29sIChpc1RhcmdldEJhc2VkKSB7XG4gICAgdGhpcy5pc1RhcmdldEJhc2VkID0gaXNUYXJnZXRCYXNlZDtcbiAgfVxuXG4gIHNldERhdGFNZXNzYWdlSGFuZGxlciAoa2V5LCBlcnJvckhhbmRsZXIsIGhhbmRsZXIpIHtcbiAgICB0aGlzLmVycm9ySGFuZGxlcnNba2V5XSA9IGVycm9ySGFuZGxlcjtcbiAgICB0aGlzLmRhdGFIYW5kbGVyc1trZXldID0gaGFuZGxlcjtcbiAgfVxuXG4gIHNldFNwZWNpYWxNZXNzYWdlSGFuZGxlciAoa2V5LCBlcnJvckhhbmRsZXIsIGhhbmRsZXIpIHtcbiAgICB0aGlzLmVycm9ySGFuZGxlcnNba2V5XSA9IGVycm9ySGFuZGxlcjtcbiAgICB0aGlzLnNwZWNpYWxIYW5kbGVyc1trZXldID0gaGFuZGxlcjtcbiAgfVxuXG4gIGdldFNwZWNpYWxNZXNzYWdlSGFuZGxlciAoa2V5KSB7XG4gICAgcmV0dXJuIHRoaXMuc3BlY2lhbEhhbmRsZXJzW2tleV07XG4gIH1cblxuICBzZXRUaW1lbGluZUV2ZW50SGFuZGxlciAodGltZWxpbmVFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLnRpbWVsaW5lRXZlbnRIYW5kbGVyID0gdGltZWxpbmVFdmVudEhhbmRsZXI7XG4gIH1cblxuICBzZXRDb25zb2xlTG9nRXZlbnRIYW5kbGVyIChjb25zb2xlTG9nRXZlbnRIYW5kbGVyKSB7XG4gICAgdGhpcy5jb25zb2xlTG9nRXZlbnRIYW5kbGVyID0gY29uc29sZUxvZ0V2ZW50SGFuZGxlcjtcbiAgfVxuXG4gIHNldE5ldHdvcmtFdmVudEhhbmRsZXIgKG5ldHdvcmtMb2dFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLm5ldHdvcmtMb2dFdmVudEhhbmRsZXIgPSBuZXR3b3JrTG9nRXZlbnRIYW5kbGVyO1xuICB9XG5cbiAgaGFzRXJyb3JIYW5kbGVyIChrZXkpIHtcbiAgICByZXR1cm4gXy5oYXModGhpcy5lcnJvckhhbmRsZXJzLCBrZXkpO1xuICB9XG5cbiAgaGFzU3BlY2lhbE1lc3NhZ2VIYW5kbGVyIChrZXkpIHtcbiAgICByZXR1cm4gXy5oYXModGhpcy5zcGVjaWFsSGFuZGxlcnMsIGtleSk7XG4gIH1cblxuICBhc3luYyBoYW5kbGVNZXNzYWdlIChwbGlzdCkge1xuICAgIGNvbnN0IHNlbGVjdG9yID0gcGxpc3QuX19zZWxlY3RvcjtcbiAgICBpZiAoIXNlbGVjdG9yKSB7XG4gICAgICBsb2cuZGVidWcoJ0dvdCBhbiBpbnZhbGlkIHBsaXN0Jyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKF8uaGFzKHRoaXMuaGFuZGxlcnMsIHNlbGVjdG9yKSkge1xuICAgICAgYXdhaXQgdGhpcy5oYW5kbGVyc1tzZWxlY3Rvcl0ocGxpc3QpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZGVidWcoYERlYnVnZ2VyIGdvdCBhIG1lc3NhZ2UgZm9yICcke3NlbGVjdG9yfScgYW5kIGhhdmUgbm8gYCArXG4gICAgICAgICAgICAgICAgYGhhbmRsZXIsIGRvaW5nIG5vdGhpbmcuYCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaGFuZGxlU3BlY2lhbE1lc3NhZ2UgKGhhbmRsZXIsIC4uLmFyZ3MpIHtcbiAgICBjb25zdCBmbiA9IHRoaXMuc3BlY2lhbEhhbmRsZXJzW2hhbmRsZXJdO1xuXG4gICAgaWYgKGZuKSB7XG4gICAgICAvLyBtb3N0IHJlc3BvbnNlcyBhcmUgb25seSB0byBiZSBjYWxsZWQgb25jZSwgdGhlblxuICAgICAgLy8gcmVtb3ZlZC4gQnV0IG5vdCB0aGUgb25lcyBiZWxvdywgd2hpY2ggaGFuZGxlXG4gICAgICAvLyBwYWdlIGNoYW5nZSBhbmQgYXBwIGNvbm5lY3QvZGlzY29ubmVjdFxuICAgICAgaWYgKGhhbmRsZXIgIT09ICdfcnBjX2ZvcndhcmRHZXRMaXN0aW5nOicgJiZcbiAgICAgICAgICBoYW5kbGVyICE9PSAnX3JwY19hcHBsaWNhdGlvbkRpc2Nvbm5lY3RlZDonICYmXG4gICAgICAgICAgaGFuZGxlciAhPT0gJ19ycGNfYXBwbGljYXRpb25Db25uZWN0ZWQ6JyAmJlxuICAgICAgICAgIGhhbmRsZXIgIT09ICdfcnBjX2FwcGxpY2F0aW9uVXBkYXRlZDonICYmXG4gICAgICAgICAgaGFuZGxlciAhPT0gJ19ycGNfcmVwb3J0Q29ubmVjdGVkRHJpdmVyTGlzdDonKSB7XG4gICAgICAgIHRoaXMuc3BlY2lhbEhhbmRsZXJzW2hhbmRsZXJdID0gbnVsbDtcbiAgICAgIH1cbiAgICAgIGF3YWl0IGZuKC4uLmFyZ3MpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cud2FybihgVHJpZWQgdG8gYWNjZXNzIHNwZWNpYWwgbWVzc2FnZSBoYW5kbGVyICcke2hhbmRsZXJ9JyBgICtcbiAgICAgICAgICAgICAgIGBidXQgbm9uZSB3YXMgZm91bmRgKTtcbiAgICB9XG4gIH1cblxuICBwYXJzZURhdGFLZXkgKHBsaXN0KSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBKU09OLnBhcnNlKHBsaXN0Ll9fYXJndW1lbnQuV0lSTWVzc2FnZURhdGFLZXkudG9TdHJpbmcoJ3V0ZjgnKSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZXJyb3IoYFVucGFyc2VhYmxlIG1lc3NhZ2UgZGF0YTogJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KHBsaXN0KSwge2xlbmd0aDogMTAwfSl9YCk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBwYXJzZSBtZXNzYWdlIGRhdGE6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZGlzcGF0Y2hEYXRhTWVzc2FnZSAobXNnSWQsIG1ldGhvZCwgcGFyYW1zLCByZXN1bHQsIGVycm9yKSB7XG4gICAgaWYgKCFfLmlzRW1wdHkobXNnSWQpKSB7XG4gICAgICBsb2cuZGVidWcoYEhhbmRsaW5nIG1lc3NhZ2UgKGlkOiAnJHttc2dJZH0nKWApO1xuICAgIH1cbiAgICBpZiAobWV0aG9kID09PSAnUHJvZmlsZXIucmVzZXRQcm9maWxlcycpIHtcbiAgICAgIGxvZy5kZWJ1ZygnRGV2aWNlIGlzIHRlbGxpbmcgdXMgdG8gcmVzZXQgcHJvZmlsZXMuIFNob3VsZCBwcm9iYWJseSAnICtcbiAgICAgICAgICAgICAgICAnZG8gc29tZSBraW5kIG9mIGNhbGxiYWNrIGhlcmUnKTtcbiAgICB9IGVsc2UgaWYgKG1ldGhvZCA9PT0gJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnIHx8IG1ldGhvZCA9PT0gJ1BhZ2UuZnJhbWVTdG9wcGVkTG9hZGluZycpIHtcbiAgICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy5zcGVjaWFsSGFuZGxlcnNbJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnXSkpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5zcGVjaWFsSGFuZGxlcnNbJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnXShgJyR7bWV0aG9kfScgZXZlbnRgKTtcbiAgICAgICAgdGhpcy5zcGVjaWFsSGFuZGxlcnNbJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnXSA9IG51bGw7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChJR05PUkVEX0VWRU5UUy5pbmNsdWRlcyhtZXRob2QpKSB7XG4gICAgICAvLyBwYXNzXG4gICAgfSBlbHNlIGlmIChtZXRob2QgPT09ICdQYWdlLmZyYW1lRGV0YWNoZWQnICYmIF8uaXNGdW5jdGlvbih0aGlzLnNwZWNpYWxIYW5kbGVycy5mcmFtZURldGFjaGVkKSkge1xuICAgICAgYXdhaXQgdGhpcy5zcGVjaWFsSGFuZGxlcnMuZnJhbWVEZXRhY2hlZCgpO1xuICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAnVGltZWxpbmUuZXZlbnRSZWNvcmRlZCcgJiYgXy5pc0Z1bmN0aW9uKHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIpKSB7XG4gICAgICB0aGlzLnRpbWVsaW5lRXZlbnRIYW5kbGVyKHBhcmFtcyB8fCBwYXJhbXMucmVjb3JkKTtcbiAgICB9IGVsc2UgaWYgKG1ldGhvZCA9PT0gJ0NvbnNvbGUubWVzc2FnZUFkZGVkJyAmJiBfLmlzRnVuY3Rpb24odGhpcy5jb25zb2xlTG9nRXZlbnRIYW5kbGVyKSkge1xuICAgICAgdGhpcy5jb25zb2xlTG9nRXZlbnRIYW5kbGVyKHBhcmFtcy5tZXNzYWdlKTtcbiAgICB9IGVsc2UgaWYgKG1ldGhvZCA9PT0gJ0NvbnNvbGUubWVzc2FnZVJlcGVhdENvdW50VXBkYXRlZCcgJiYgXy5pc0Z1bmN0aW9uKHRoaXMuY29uc29sZUxvZ0V2ZW50SGFuZGxlcikpIHtcbiAgICAgIHRoaXMuY29uc29sZUxvZ0V2ZW50SGFuZGxlcihwYXJhbXMpO1xuICAgIH0gZWxzZSBpZiAobWV0aG9kICYmIG1ldGhvZC5zdGFydHNXaXRoKCdOZXR3b3JrLicpICYmIF8uaXNGdW5jdGlvbih0aGlzLm5ldHdvcmtMb2dFdmVudEhhbmRsZXIpKSB7XG4gICAgICB0aGlzLm5ldHdvcmtMb2dFdmVudEhhbmRsZXIobWV0aG9kLCBwYXJhbXMpO1xuICAgIH0gZWxzZSBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuZGF0YUhhbmRsZXJzW21zZ0lkXSkpIHtcbiAgICAgIC8vIHdlIHdpbGwgZWl0aGVyIGdldCBiYWNrIGEgcmVzdWx0IG9iamVjdCB0aGF0IGhhcyBhIHJlc3VsdC52YWx1ZVxuICAgICAgLy8gaW4gd2hpY2ggY2FzZSB0aGF0IGlzIHdoYXQgd2Ugd2FudCxcbiAgICAgIC8vIG9yIGVsc2Ugd2UgcmV0dXJuIHRoZSB3aG9sZSB0aGluZ1xuICAgICAgaWYgKHJlc3VsdC5yZXN1bHQgJiYgcmVzdWx0LnJlc3VsdC52YWx1ZSkge1xuICAgICAgICByZXN1bHQgPSByZXN1bHQucmVzdWx0LnZhbHVlO1xuICAgICAgfVxuICAgICAgdGhpcy5kYXRhSGFuZGxlcnNbbXNnSWRdKHJlc3VsdCk7XG4gICAgICB0aGlzLmRhdGFIYW5kbGVyc1ttc2dJZF0gPSBudWxsO1xuICAgIH0gZWxzZSBpZiAodGhpcy5kYXRhSGFuZGxlcnNbbXNnSWRdID09PSBudWxsKSB7XG4gICAgICBsb2cuZXJyb3IoYERlYnVnZ2VyIHJldHVybmVkIGRhdGEgZm9yIG1lc3NhZ2UgJyR7bXNnSWR9JyBgICtcbiAgICAgICAgICAgICAgICBgYnV0IHdlIGFscmVhZHkgcmFuIHRoYXQgY2FsbGJhY2shIFdURj8/YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChtc2dJZCB8fCByZXN1bHQgfHwgZXJyb3IpIHtcbiAgICAgICAgbG9nLmVycm9yKGBEZWJ1Z2dlciByZXR1cm5lZCBkYXRhIGZvciBtZXNzYWdlICcke21zZ0lkfScgYCArXG4gICAgICAgICAgICAgICAgICBgYnV0IHdlIHdlcmUgbm90IHdhaXRpbmcgZm9yIHRoYXQgbWVzc2FnZSEgYCArXG4gICAgICAgICAgICAgICAgICBgcmVzdWx0OiAnJHtKU09OLnN0cmluZ2lmeShyZXN1bHQpfSc7IGAgK1xuICAgICAgICAgICAgICAgICAgYGVycm9yOiAnJHtlcnJvcn0nYCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaGFuZGxlRGF0YU1lc3NhZ2UgKHBsaXN0KSB7XG4gICAgY29uc3QgZGF0YUtleSA9IHRoaXMucGFyc2VEYXRhS2V5KHBsaXN0KTtcbiAgICBsZXQgbXNnSWQgPSAoZGF0YUtleS5pZCB8fCAnJykudG9TdHJpbmcoKTtcbiAgICBsZXQgcmVzdWx0ID0gZGF0YUtleS5yZXN1bHQ7XG5cbiAgICBsZXQgbWV0aG9kID0gZGF0YUtleS5tZXRob2Q7XG4gICAgbGV0IHBhcmFtcztcblxuICAgIGlmIChtZXRob2QgPT09ICdUYXJnZXQudGFyZ2V0Q3JlYXRlZCcpIHtcbiAgICAgIC8vIHRoaXMgaXMgaW4gcmVzcG9uc2UgdG8gYSBgX3JwY19mb3J3YXJkU29ja2V0U2V0dXA6YCBjYWxsXG4gICAgICAvLyB0YXJnZXRJbmZvOiB7IHRhcmdldElkOiAncGFnZS0xJywgdHlwZTogJ3BhZ2UnIH1cbiAgICAgIGNvbnN0IGFwcCA9IHBsaXN0Ll9fYXJndW1lbnQuV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5O1xuICAgICAgY29uc3QgdGFyZ2V0SW5mbyA9IGRhdGFLZXkucGFyYW1zLnRhcmdldEluZm87XG4gICAgICBhd2FpdCB0aGlzLnNwZWNpYWxIYW5kbGVycy50YXJnZXRDcmVhdGVkKGFwcCwgdGFyZ2V0SW5mbyk7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIGlmIChtZXRob2QgPT09ICdUYXJnZXQudGFyZ2V0RGVzdHJveWVkJykge1xuICAgICAgY29uc3QgYXBwID0gcGxpc3QuX19hcmd1bWVudC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk7XG4gICAgICBjb25zdCB0YXJnZXRJbmZvID0gZGF0YUtleS5wYXJhbXMudGFyZ2V0SW5mbyB8fCB7dGFyZ2V0SWQ6IGRhdGFLZXkucGFyYW1zLnRhcmdldElkfTtcbiAgICAgIGF3YWl0IHRoaXMuc3BlY2lhbEhhbmRsZXJzLnRhcmdldERlc3Ryb3llZChhcHAsIHRhcmdldEluZm8pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghZGF0YUtleS5lcnJvciAmJiB0aGlzLmlzVGFyZ2V0QmFzZWQpIHtcbiAgICAgIGlmIChkYXRhS2V5Lm1ldGhvZCAhPT0gJ1RhcmdldC5kaXNwYXRjaE1lc3NhZ2VGcm9tVGFyZ2V0Jykge1xuICAgICAgICAvLyB0aGlzIHNvcnQgb2YgbWVzc2FnZSwgYXQgdGhpcyBwb2ludCwgaXMganVzdCBhbiBhY2tub3dsZWRnZW1lbnRcbiAgICAgICAgLy8gdGhhdCB0aGUgb3JpZ2luYWwgbWVzc2FnZSB3YXMgcmVjZWl2ZWRcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBhdCB0aGlzIHBvaW50LCB3ZSBoYXZlIGEgVGFyZ2V0LWJhc2VkIG1lc3NhZ2Ugd3JhcHBpbmcgYSBwcm90b2NvbCBtZXNzYWdlXG4gICAgICBsZXQgbWVzc2FnZTtcbiAgICAgIHRyeSB7XG4gICAgICAgIG1lc3NhZ2UgPSBKU09OLnBhcnNlKGRhdGFLZXkucGFyYW1zLm1lc3NhZ2UpO1xuICAgICAgICBtc2dJZCA9IG1lc3NhZ2UuaWQ7XG4gICAgICAgIG1ldGhvZCA9IG1lc3NhZ2UubWV0aG9kO1xuICAgICAgICByZXN1bHQgPSBtZXNzYWdlLnJlc3VsdCB8fCBtZXNzYWdlO1xuICAgICAgICBwYXJhbXMgPSByZXN1bHQucGFyYW1zO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIC8vIGlmIHRoaXMgaGFwcGVucyB0aGVuIHNvbWUgYXNwZWN0IG9mIHRoZSBwcm90b2NvbCBpcyBtaXNzaW5nIHRvIHVzXG4gICAgICAgIC8vIHNvIHByaW50IHRoZSBlbnRpcmUgbWVzc2FnZSB0byBnZXQgdmlzaWJpaXR5IGludG8gd2hhdCBpcyBnb2luZyBvblxuICAgICAgICBsb2cuZXJyb3IoYFVuZXhwZWN0ZWQgbWVzc2FnZSBmb3JtYXQgZnJvbSBXZWIgSW5zcGVjdG9yOmApO1xuICAgICAgICB0aGlzLndhcm4odXRpbC5qc29uU3RyaW5naWZ5KHBsaXN0KSk7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcGFyYW1zID0gZGF0YUtleS5wYXJhbXM7XG4gICAgfVxuXG4gICAgLy8gd2UgY2FuIGdldCBhbiBlcnJvciwgb3Igd2UgY2FuIGdldCBhIHJlc3BvbnNlIHRoYXQgaXMgYW4gZXJyb3JcbiAgICBsZXQgZXJyb3IgPSBkYXRhS2V5LmVycm9yIHx8IG51bGw7XG4gICAgaWYgKHJlc3VsdCAmJiByZXN1bHQud2FzVGhyb3duKSB7XG4gICAgICBjb25zdCBtZXNzYWdlID0gKHJlc3VsdC5yZXN1bHQgJiYgKHJlc3VsdC5yZXN1bHQudmFsdWUgfHwgcmVzdWx0LnJlc3VsdC5kZXNjcmlwdGlvbikpXG4gICAgICAgID8gKHJlc3VsdC5yZXN1bHQudmFsdWUgfHwgcmVzdWx0LnJlc3VsdC5kZXNjcmlwdGlvbilcbiAgICAgICAgOiAnRXJyb3Igb2NjdXJyZWQgaW4gaGFuZGxpbmcgZGF0YSBtZXNzYWdlJztcbiAgICAgIGVycm9yID0gbmV3IEVycm9yKG1lc3NhZ2UpO1xuICAgIH1cblxuICAgIGlmICghZXJyb3IpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmRpc3BhdGNoRGF0YU1lc3NhZ2UobXNnSWQsIG1ldGhvZCwgcGFyYW1zLCByZXN1bHQsIGVycm9yKTtcbiAgICB9XG5cbiAgICAvLyBoYW5kbGUgdGhlIGVycm9yXG4gICAgaWYgKHRoaXMuaGFzRXJyb3JIYW5kbGVyKG1zZ0lkKSkge1xuICAgICAgdGhpcy5lcnJvckhhbmRsZXJzW21zZ0lkXShlcnJvcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5lcnJvcihgRXJyb3Igb2NjdXJyZWQgaW4gaGFuZGxpbmcgZGF0YSBtZXNzYWdlOiAke2Vycm9yfWApO1xuICAgICAgbG9nLmVycm9yKCdObyBlcnJvciBoYW5kbGVyIHByZXNlbnQsIGlnbm9yaW5nJyk7XG4gICAgfVxuICB9XG5cbiAgc2V0SGFuZGxlcnMgKCkge1xuICAgIHRoaXMuaGFuZGxlcnMgPSB7XG4gICAgICAnX3JwY19yZXBvcnRTZXR1cDonOiBhc3luYyAocGxpc3QpID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5oYW5kbGVTcGVjaWFsTWVzc2FnZSgnX3JwY19yZXBvcnRJZGVudGlmaWVyOicsXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudC5XSVJTaW11bGF0b3JOYW1lS2V5LFxuICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQuV0lSU2ltdWxhdG9yQnVpbGRLZXksXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudC5XSVJTaW11bGF0b3JQcm9kdWN0VmVyc2lvbktleSk7XG4gICAgICB9LFxuICAgICAgJ19ycGNfcmVwb3J0Q29ubmVjdGVkQXBwbGljYXRpb25MaXN0Oic6IGFzeW5jIChwbGlzdCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX3JlcG9ydENvbm5lY3RlZEFwcGxpY2F0aW9uTGlzdDonLFxuICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQuV0lSQXBwbGljYXRpb25EaWN0aW9uYXJ5S2V5KTtcbiAgICAgIH0sXG4gICAgICAnX3JwY19hcHBsaWNhdGlvblNlbnRMaXN0aW5nOic6IGFzeW5jIChwbGlzdCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX2ZvcndhcmRHZXRMaXN0aW5nOicsXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXksXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudC5XSVJMaXN0aW5nS2V5KTtcbiAgICAgIH0sXG4gICAgICAnX3JwY19hcHBsaWNhdGlvbkNvbm5lY3RlZDonOiBhc3luYyAocGxpc3QpID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5oYW5kbGVTcGVjaWFsTWVzc2FnZSgnX3JwY19hcHBsaWNhdGlvbkNvbm5lY3RlZDonLFxuICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQpO1xuICAgICAgfSxcbiAgICAgICdfcnBjX2FwcGxpY2F0aW9uRGlzY29ubmVjdGVkOic6IGFzeW5jIChwbGlzdCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX2FwcGxpY2F0aW9uRGlzY29ubmVjdGVkOicsXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudCk7XG4gICAgICB9LFxuICAgICAgJ19ycGNfYXBwbGljYXRpb25VcGRhdGVkOic6IGFzeW5jIChwbGlzdCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX2FwcGxpY2F0aW9uVXBkYXRlZDonLFxuICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQpO1xuICAgICAgfSxcbiAgICAgICdfcnBjX3JlcG9ydENvbm5lY3RlZERyaXZlckxpc3Q6JzogYXN5bmMgKHBsaXN0KSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuaGFuZGxlU3BlY2lhbE1lc3NhZ2UoJ19ycGNfcmVwb3J0Q29ubmVjdGVkRHJpdmVyTGlzdDonLFxuICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQpO1xuICAgICAgfSxcbiAgICAgICdfcnBjX2FwcGxpY2F0aW9uU2VudERhdGE6JzogYXN5bmMgKHBsaXN0KSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuaGFuZGxlRGF0YU1lc3NhZ2UocGxpc3QpO1xuICAgICAgfSxcbiAgICB9O1xuICB9XG59XG4iXSwiZmlsZSI6ImxpYi9ycGMtbWVzc2FnZS1oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
