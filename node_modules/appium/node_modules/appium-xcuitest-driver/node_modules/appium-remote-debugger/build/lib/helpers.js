"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.appInfoFromDict = appInfoFromDict;
exports.pageArrayFromDict = pageArrayFromDict;
exports.getDebuggerAppKey = getDebuggerAppKey;
exports.getPossibleDebuggerAppKeys = getPossibleDebuggerAppKeys;
exports.checkParams = checkParams;
exports.wrapScriptForFrame = wrapScriptForFrame;
exports.getScriptForAtom = getScriptForAtom;
exports.simpleStringify = simpleStringify;
exports.deferredPromise = deferredPromise;
exports.getElapsedTime = getElapsedTime;
exports.convertResult = convertResult;
exports.RESPONSE_LOG_LENGTH = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _atoms = _interopRequireDefault(require("./atoms"));

var _lodash = _interopRequireDefault(require("lodash"));

var _assert = _interopRequireDefault(require("assert"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumBaseDriver = require("appium-base-driver");

const WEB_CONTENT_BUNDLE_ID = 'com.apple.WebKit.WebContent';
const WILDCARD_BUNDLE_ID = '*';
const RESPONSE_LOG_LENGTH = 100;
exports.RESPONSE_LOG_LENGTH = RESPONSE_LOG_LENGTH;

function appInfoFromDict(dict) {
  const id = dict.WIRApplicationIdentifierKey;
  const isProxy = _lodash.default.isString(dict.WIRIsApplicationProxyKey) ? dict.WIRIsApplicationProxyKey.toLowerCase() === 'true' : dict.WIRIsApplicationProxyKey;
  let isAutomationEnabled = !!dict.WIRRemoteAutomationEnabledKey;

  if (_lodash.default.has(dict, 'WIRAutomationAvailabilityKey')) {
    if (_lodash.default.isString(dict.WIRAutomationAvailabilityKey)) {
      isAutomationEnabled = dict.WIRAutomationAvailabilityKey === 'WIRAutomationAvailabilityUnknown' ? 'Unknown' : dict.WIRAutomationAvailabilityKey === 'WIRAutomationAvailabilityAvailable';
    } else {
      isAutomationEnabled = !!dict.WIRAutomationAvailabilityKey;
    }
  }

  const entry = {
    id,
    isProxy,
    name: dict.WIRApplicationNameKey,
    bundleId: dict.WIRApplicationBundleIdentifierKey,
    hostId: dict.WIRHostApplicationIdentifierKey,
    isActive: dict.WIRIsApplicationActiveKey,
    isAutomationEnabled
  };
  return [id, entry];
}

function pageArrayFromDict(pageDict) {
  if (pageDict.id) {
    return [pageDict];
  }

  let newPageArray = [];

  for (const dict of _lodash.default.values(pageDict)) {
    if (_lodash.default.isUndefined(dict.WIRTypeKey) || dict.WIRTypeKey === 'WIRTypeWeb') {
      newPageArray.push({
        id: dict.WIRPageIdentifierKey,
        title: dict.WIRTitleKey,
        url: dict.WIRURLKey,
        isKey: !_lodash.default.isUndefined(dict.WIRConnectionIdentifierKey)
      });
    }
  }

  return newPageArray;
}

function getDebuggerAppKey(bundleId, appDict) {
  let appId;

  for (const [key, data] of _lodash.default.toPairs(appDict)) {
    if (data.bundleId === bundleId) {
      appId = key;
      break;
    }
  }

  if (appId) {
    _logger.default.debug(`Found app id key '${appId}' for bundle '${bundleId}'`);

    let proxyAppId;

    for (const [key, data] of _lodash.default.toPairs(appDict)) {
      if (data.isProxy && data.hostId === appId) {
        _logger.default.debug(`Found separate bundleId '${data.bundleId}' ` + `acting as proxy for '${bundleId}', with app id '${key}'`);

        proxyAppId = key;
      }
    }

    if (proxyAppId) {
      appId = proxyAppId;

      _logger.default.debug(`Using proxied app id '${appId}'`);
    }
  }

  return appId;
}

function appIdForBundle(bundleId, appDict) {
  let appId;

  for (const [key, data] of _lodash.default.toPairs(appDict)) {
    if (data.bundleId.endsWith(bundleId)) {
      appId = key;
      break;
    }
  }

  if (!appId && bundleId !== WEB_CONTENT_BUNDLE_ID) {
    return appIdForBundle(WEB_CONTENT_BUNDLE_ID, appDict);
  }

  return appId;
}

function getPossibleDebuggerAppKeys(bundleIds, appDict) {
  let proxiedAppIds = [];
  const possibleBundleIds = [...bundleIds, WILDCARD_BUNDLE_ID];

  _logger.default.debug(`Checking for bundle identifiers: ${possibleBundleIds.join(', ')}`);

  for (const bundleId of possibleBundleIds) {
    const appId = appIdForBundle(bundleId, appDict);

    if (appId) {
      proxiedAppIds.push(appId);

      _logger.default.debug(`Found app id key '${appId}' for bundle '${bundleId}'`);

      for (const [key, data] of _lodash.default.toPairs(appDict)) {
        if (data.isProxy && data.hostId === appId) {
          _logger.default.debug(`Found separate bundleId '${data.bundleId}' ` + `acting as proxy for '${bundleId}', with app id '${key}'`);

          proxiedAppIds.push(key);
        }
      }
    }
  }

  return proxiedAppIds;
}

function checkParams(params) {
  let errors = [];

  for (const [param, value] of _lodash.default.toPairs(params)) {
    try {
      _assert.default.ok(value);
    } catch (err) {
      errors.push(param);
    }
  }

  if (errors.length) {
    return errors;
  }
}

async function wrapScriptForFrame(script, frame) {
  _logger.default.debug(`Wrapping script for frame '${frame}'`);

  let elFromCache = await (0, _atoms.default)('get_element_from_cache');
  return `(function (window) { var document = window.document; ` + `return (${script}); })((${elFromCache.toString('utf8')})(${JSON.stringify(frame)}))`;
}

async function getScriptForAtom(atom, args, frames, asyncCallBack = null) {
  let atomSrc = await (0, _atoms.default)(atom);
  let script;

  if (frames.length > 0) {
    script = atomSrc;

    for (const frame of frames) {
      script = await wrapScriptForFrame(script, frame);
    }
  } else {
    _logger.default.debug(`Executing '${atom}' atom in default context`);

    script = `(${atomSrc})`;
  }

  args = args.map(JSON.stringify);

  if (asyncCallBack) {
    script += `(${args.join(',')}, ${asyncCallBack}, true )`;
  } else {
    script += `(${args.join(',')})`;
  }

  return script;
}

function simpleStringify(value, multiline = false) {
  if (!value) {
    return JSON.stringify(value);
  }

  let cleanValue = _lodash.default.clone(value);

  for (const property of ['ceil', 'clone', 'floor', 'round', 'scale', 'toString']) {
    delete cleanValue[property];
  }

  return multiline ? JSON.stringify(cleanValue, null, 2) : JSON.stringify(cleanValue);
}

function deferredPromise() {
  let resolve;
  let reject;
  const promise = new _bluebird.default((res, rej) => {
    resolve = res;
    reject = rej;
  });
  return {
    promise,
    resolve,
    reject
  };
}

function getElapsedTime(startTime) {
  const endTime = process.hrtime(startTime);
  return parseInt((endTime[0] * 1e9 + endTime[1]) / 1e6, 10);
}

function convertResult(res) {
  if (_lodash.default.isUndefined(res)) {
    throw new Error(`Did not get OK result from remote debugger. Result was: ${_lodash.default.truncate(simpleStringify(res), {
      length: RESPONSE_LOG_LENGTH
    })}`);
  } else if (_lodash.default.isString(res)) {
    try {
      res = JSON.parse(res);
    } catch (err) {}
  } else if (!_lodash.default.isObject(res)) {
    throw new Error(`Result has unexpected type: (${typeof res}).`);
  }

  if (res.status && res.status !== 0) {
    throw (0, _appiumBaseDriver.errorFromMJSONWPStatusCode)(res.status, res.value.message || res.value);
  }

  return _lodash.default.has(res, 'value') ? res.value : res;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9oZWxwZXJzLmpzIl0sIm5hbWVzIjpbIldFQl9DT05URU5UX0JVTkRMRV9JRCIsIldJTERDQVJEX0JVTkRMRV9JRCIsIlJFU1BPTlNFX0xPR19MRU5HVEgiLCJhcHBJbmZvRnJvbURpY3QiLCJkaWN0IiwiaWQiLCJXSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXkiLCJpc1Byb3h5IiwiXyIsImlzU3RyaW5nIiwiV0lSSXNBcHBsaWNhdGlvblByb3h5S2V5IiwidG9Mb3dlckNhc2UiLCJpc0F1dG9tYXRpb25FbmFibGVkIiwiV0lSUmVtb3RlQXV0b21hdGlvbkVuYWJsZWRLZXkiLCJoYXMiLCJXSVJBdXRvbWF0aW9uQXZhaWxhYmlsaXR5S2V5IiwiZW50cnkiLCJuYW1lIiwiV0lSQXBwbGljYXRpb25OYW1lS2V5IiwiYnVuZGxlSWQiLCJXSVJBcHBsaWNhdGlvbkJ1bmRsZUlkZW50aWZpZXJLZXkiLCJob3N0SWQiLCJXSVJIb3N0QXBwbGljYXRpb25JZGVudGlmaWVyS2V5IiwiaXNBY3RpdmUiLCJXSVJJc0FwcGxpY2F0aW9uQWN0aXZlS2V5IiwicGFnZUFycmF5RnJvbURpY3QiLCJwYWdlRGljdCIsIm5ld1BhZ2VBcnJheSIsInZhbHVlcyIsImlzVW5kZWZpbmVkIiwiV0lSVHlwZUtleSIsInB1c2giLCJXSVJQYWdlSWRlbnRpZmllcktleSIsInRpdGxlIiwiV0lSVGl0bGVLZXkiLCJ1cmwiLCJXSVJVUkxLZXkiLCJpc0tleSIsIldJUkNvbm5lY3Rpb25JZGVudGlmaWVyS2V5IiwiZ2V0RGVidWdnZXJBcHBLZXkiLCJhcHBEaWN0IiwiYXBwSWQiLCJrZXkiLCJkYXRhIiwidG9QYWlycyIsImxvZyIsImRlYnVnIiwicHJveHlBcHBJZCIsImFwcElkRm9yQnVuZGxlIiwiZW5kc1dpdGgiLCJnZXRQb3NzaWJsZURlYnVnZ2VyQXBwS2V5cyIsImJ1bmRsZUlkcyIsInByb3hpZWRBcHBJZHMiLCJwb3NzaWJsZUJ1bmRsZUlkcyIsImpvaW4iLCJjaGVja1BhcmFtcyIsInBhcmFtcyIsImVycm9ycyIsInBhcmFtIiwidmFsdWUiLCJhc3NlcnQiLCJvayIsImVyciIsImxlbmd0aCIsIndyYXBTY3JpcHRGb3JGcmFtZSIsInNjcmlwdCIsImZyYW1lIiwiZWxGcm9tQ2FjaGUiLCJ0b1N0cmluZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJnZXRTY3JpcHRGb3JBdG9tIiwiYXRvbSIsImFyZ3MiLCJmcmFtZXMiLCJhc3luY0NhbGxCYWNrIiwiYXRvbVNyYyIsIm1hcCIsInNpbXBsZVN0cmluZ2lmeSIsIm11bHRpbGluZSIsImNsZWFuVmFsdWUiLCJjbG9uZSIsInByb3BlcnR5IiwiZGVmZXJyZWRQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInByb21pc2UiLCJCIiwicmVzIiwicmVqIiwiZ2V0RWxhcHNlZFRpbWUiLCJzdGFydFRpbWUiLCJlbmRUaW1lIiwicHJvY2VzcyIsImhydGltZSIsInBhcnNlSW50IiwiY29udmVydFJlc3VsdCIsIkVycm9yIiwidHJ1bmNhdGUiLCJwYXJzZSIsImlzT2JqZWN0Iiwic3RhdHVzIiwibWVzc2FnZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLHFCQUFxQixHQUFHLDZCQUE5QjtBQUNBLE1BQU1DLGtCQUFrQixHQUFHLEdBQTNCO0FBRUEsTUFBTUMsbUJBQW1CLEdBQUcsR0FBNUI7OztBQU1BLFNBQVNDLGVBQVQsQ0FBMEJDLElBQTFCLEVBQWdDO0FBQzlCLFFBQU1DLEVBQUUsR0FBR0QsSUFBSSxDQUFDRSwyQkFBaEI7QUFDQSxRQUFNQyxPQUFPLEdBQUdDLGdCQUFFQyxRQUFGLENBQVdMLElBQUksQ0FBQ00sd0JBQWhCLElBQ1pOLElBQUksQ0FBQ00sd0JBQUwsQ0FBOEJDLFdBQTlCLE9BQWdELE1BRHBDLEdBRVpQLElBQUksQ0FBQ00sd0JBRlQ7QUFNQSxNQUFJRSxtQkFBbUIsR0FBRyxDQUFDLENBQUNSLElBQUksQ0FB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QixXQUFGLENBQWMyRCxHQUFkLENBQUosRUFBd0I7QUFDdEIsVUFBTSxJQUFJUyxLQUFKLENBQVcsMkRBQTBEekYsZ0JBQUUwRixRQUFGLENBQVdwQixlQUFlLENBQUNVLEdBQUQsQ0FBMUIsRUFBaUM7QUFBQ3pCLE1BQUFBLE1BQU0sRUFBRTdEO0FBQVQsS0FBakMsQ0FBZ0UsRUFBckksQ0FBTjtBQUNELEdBRkQsTUFFTyxJQUFJTSxnQkFBRUMsUUFBRixDQUFXK0UsR0FBWCxDQUFKLEVBQXFCO0FBQzFCLFFBQUk7QUFDRkEsTUFBQUEsR0FBRyxHQUFHbkIsSUFBSSxDQUFDOEIsS0FBTCxDQUFXWCxHQUFYLENBQU47QUFDRCxLQUZELENBRUUsT0FBTzFCLEdBQVAsRUFBWSxDQUdiO0FBQ0YsR0FQTSxNQU9BLElBQUksQ0FBQ3RELGdCQUFFNEYsUUFBRixDQUFXWixHQUFYLENBQUwsRUFBc0I7QUFDM0IsVUFBTSxJQUFJUyxLQUFKLENBQVcsZ0NBQStCLE9BQU9ULEdBQUksSUFBckQsQ0FBTjtBQUNEOztBQUVELE1BQUlBLEdBQUcsQ0FBQ2EsTUFBSixJQUFjYixHQUFHLENBQUNhLE1BQUosS0FBZSxDQUFqQyxFQUFvQztBQUVsQyxVQUFNLGtEQUEyQmIsR0FBRyxDQUFDYSxNQUEvQixFQUF1Q2IsR0FBRyxDQUFDN0IsS0FBSixDQUFVMkMsT0FBVixJQUFxQmQsR0FBRyxDQUFDN0IsS0FBaEUsQ0FBTjtBQUNEOztBQUlELFNBQU9uRCxnQkFBRU0sR0FBRixDQUFNMEUsR0FBTixFQUFXLE9BQVgsSUFBc0JBLEdBQUcsQ0FBQzdCLEtBQTFCLEdBQWtDNkIsR0FBekM7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IGdldEF0b20gZnJvbSAnLi9hdG9tcyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGFzc2VydCBmcm9tICdhc3NlcnQnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgZXJyb3JGcm9tTUpTT05XUFN0YXR1c0NvZGUgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuXG5cbmNvbnN0IFdFQl9DT05URU5UX0JVTkRMRV9JRCA9ICdjb20uYXBwbGUuV2ViS2l0LldlYkNvbnRlbnQnO1xuY29uc3QgV0lMRENBUkRfQlVORExFX0lEID0gJyonO1xuXG5jb25zdCBSRVNQT05TRV9MT0dfTEVOR1RIID0gMTAwO1xuXG4vKlxuICogVGFrZXMgYSBkaWN0aW9uYXJ5IGZyb20gdGhlIHJlbW90ZSBkZWJ1Z2dlciBhbmQgbWFrZXMgYSBtb3JlIG1hbmFnZWFibGVcbiAqIGRpY3Rpb25hcnkgd2hvc2Uga2V5cyBhcmUgdW5kZXJzdGFuZGFibGVcbiAqL1xuZnVuY3Rpb24gYXBwSW5mb0Zyb21EaWN0IChkaWN0KSB7XG4gIGNvbnN0IGlkID0gZGljdC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk7XG4gIGNvbnN0IGlzUHJveHkgPSBfLmlzU3RyaW5nKGRpY3QuV0lSSXNBcHBsaWNhdGlvblByb3h5S2V5KVxuICAgID8gZGljdC5XSVJJc0FwcGxpY2F0aW9uUHJveHlLZXkudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnXG4gICAgOiBkaWN0LldJUklzQXBwbGljYXRpb25Qcm94eUtleTtcbiAgLy8gYXV0b21hdGlvbiBlbmFibGVkIGNhbiBiZSBlaXRoZXIgZnJvbSB0aGUga2V5c1xuICAvLyAgIC0gV0lSUmVtb3RlQXV0b21hdGlvbkVuYWJsZWRLZXkgKGJvb2xlYW4pXG4gIC8vICAgLSBXSVJBdXRvbWF0aW9uQXZhaWxhYmlsaXR5S2V5IChzdHJpbmcgb3IgYm9vbGVhbilcbiAgbGV0IGlzQXV0b21hdGlvbkVuYWJsZWQgPSAhIWRpY3QuV0lSUmVtb3RlQXV0b21hdGlvbkVuYWJsZWRLZXk7XG4gIGlmIChfLmhhcyhkaWN0LCAnV0lSQXV0b21hdGlvbkF2YWlsYWJpbGl0eUtleScpKSB7XG4gICAgaWYgKF8uaXNTdHJpbmcoZGljdC5XSVJBdXRvbWF0aW9uQXZhaWxhYmlsaXR5S2V5KSkge1xuICAgICAgaXNBdXRvbWF0aW9uRW5hYmxlZCA9IGRpY3QuV0lSQXV0b21hdGlvbkF2YWlsYWJpbGl0eUtleSA9PT0gJ1dJUkF1dG9tYXRpb25BdmFpbGFiaWxpdHlVbmtub3duJ1xuICAgICAgICA/ICdVbmtub3duJ1xuICAgICAgICA6IGRpY3QuV0lSQXV0b21hdGlvbkF2YWlsYWJpbGl0eUtleSA9PT0gJ1dJUkF1dG9tYXRpb25BdmFpbGFiaWxpdHlBdmFpbGFibGUnO1xuICAgIH0gZWxzZSB7XG4gICAgICBpc0F1dG9tYXRpb25FbmFibGVkID0gISFkaWN0LldJUkF1dG9tYXRpb25BdmFpbGFiaWxpdHlLZXk7XG4gICAgfVxuICB9XG4gIGNvbnN0IGVudHJ5ID0ge1xuICAgIGlkLFxuICAgIGlzUHJveHksXG4gICAgbmFtZTogZGljdC5XSVJBcHBsaWNhdGlvbk5hbWVLZXksXG4gICAgYnVuZGxlSWQ6IGRpY3QuV0lSQXBwbGljYXRpb25CdW5kbGVJZGVudGlmaWVyS2V5LFxuICAgIGhvc3RJZDogZGljdC5XSVJIb3N0QXBwbGljYXRpb25JZGVudGlmaWVyS2V5LFxuICAgIGlzQWN0aXZlOiBkaWN0LldJUklzQXBwbGljYXRpb25BY3RpdmVLZXksXG4gICAgaXNBdXRvbWF0aW9uRW5hYmxlZCxcbiAgfTtcblxuICByZXR1cm4gW2lkLCBlbnRyeV07XG59XG5cbi8qXG4gKiBUYWtlIGEgZGljdGlvbmFyeSBmcm9tIHRoZSByZW1vdGUgZGVidWdnZXIgYW5kIG1ha2VzIGEgbW9yZSBtYW5hZ2VhYmxlXG4gKiBkaWN0aW9uYXJ5IG9mIHBhZ2VzIGF2YWlsYWJsZS5cbiAqL1xuZnVuY3Rpb24gcGFnZUFycmF5RnJvbURpY3QgKHBhZ2VEaWN0KSB7XG4gIGlmIChwYWdlRGljdC5pZCkge1xuICAgIC8vIHRoZSBwYWdlIGlzIGFscmVhZHkgdHJhbnNsYXRlZCwgc28gd3JhcCBpbiBhbiBhcnJheSBhbmQgcGFzcyBiYWNrXG4gICAgcmV0dXJuIFtwYWdlRGljdF07XG4gIH1cbiAgbGV0IG5ld1BhZ2VBcnJheSA9IFtdO1xuICBmb3IgKGNvbnN0IGRpY3Qgb2YgXy52YWx1ZXMocGFnZURpY3QpKSB7XG4gICAgLy8gY291bnQgb25seSBXSVJUeXBlV2ViIHBhZ2VzIGFuZCBpZ25vcmUgYWxsIG90aGVycyAoV0lSVHlwZUphdmFTY3JpcHQgZXRjKVxuICAgIGlmIChfLmlzVW5kZWZpbmVkKGRpY3QuV0lSVHlwZUtleSkgfHwgZGljdC5XSVJUeXBlS2V5ID09PSAnV0lSVHlwZVdlYicpIHtcbiAgICAgIG5ld1BhZ2VBcnJheS5wdXNoKHtcbiAgICAgICAgaWQ6IGRpY3QuV0lSUGFnZUlkZW50aWZpZXJLZXksXG4gICAgICAgIHRpdGxlOiBkaWN0LldJUlRpdGxlS2V5LFxuICAgICAgICB1cmw6IGRpY3QuV0lSVVJMS2V5LFxuICAgICAgICBpc0tleTogIV8uaXNVbmRlZmluZWQoZGljdC5XSVJDb25uZWN0aW9uSWRlbnRpZmllcktleSksXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG5ld1BhZ2VBcnJheTtcbn1cblxuLypcbiAqIEdpdmVuIGEgYnVuZGxlIGlkLCBmaW5kcyB0aGUgY29ycmVjdCByZW1vdGUgZGVidWdnZXIgYXBwIHRoYXQgaXNcbiAqIGNvbm5lY3RlZC5cbiAqL1xuZnVuY3Rpb24gZ2V0RGVidWdnZXJBcHBLZXkgKGJ1bmRsZUlkLCBhcHBEaWN0KSB7XG4gIGxldCBhcHBJZDtcbiAgZm9yIChjb25zdCBba2V5LCBkYXRhXSBvZiBfLnRvUGFpcnMoYXBwRGljdCkpIHtcbiAgICBpZiAoZGF0YS5idW5kbGVJZCA9PT0gYnVuZGxlSWQpIHtcbiAgICAgIGFwcElkID0ga2V5O1xuICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG4gIC8vIG5vdyB3ZSBuZWVkIHRvIGRldGVybWluZSBpZiB3ZSBzaG91bGQgcGljayBhIHByb3h5IGZvciB0aGlzIGluc3RlYWRcbiAgaWYgKGFwcElkKSB7XG4gICAgbG9nLmRlYnVnKGBGb3VuZCBhcHAgaWQga2V5ICcke2FwcElkfScgZm9yIGJ1bmRsZSAnJHtidW5kbGVJZH0nYCk7XG4gICAgbGV0IHByb3h5QXBwSWQ7XG4gICAgZm9yIChjb25zdCBba2V5LCBkYXRhXSBvZiBfLnRvUGFpcnMoYXBwRGljdCkpIHtcbiAgICAgIGlmIChkYXRhLmlzUHJveHkgJiYgZGF0YS5ob3N0SWQgPT09IGFwcElkKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgRm91bmQgc2VwYXJhdGUgYnVuZGxlSWQgJyR7ZGF0YS5idW5kbGVJZH0nIGAgK1xuICAgICAgICAgICAgICAgICAgYGFjdGluZyBhcyBwcm94eSBmb3IgJyR7YnVuZGxlSWR9Jywgd2l0aCBhcHAgaWQgJyR7a2V5fSdgKTtcbiAgICAgICAgLy8gc2V0IHRoZSBhcHAgaWQuLi4gdGhlIGxhc3Qgb25lIHdpbGwgYmUgdXNlZCwgc28ganVzdCBrZWVwIHJlLWFzc2lnbmluZ1xuICAgICAgICBwcm94eUFwcElkID0ga2V5O1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAocHJveHlBcHBJZCkge1xuICAgICAgYXBwSWQgPSBwcm94eUFwcElkO1xuICAgICAgbG9nLmRlYnVnKGBVc2luZyBwcm94aWVkIGFwcCBpZCAnJHthcHBJZH0nYCk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGFwcElkO1xufVxuXG5mdW5jdGlvbiBhcHBJZEZvckJ1bmRsZSAoYnVuZGxlSWQsIGFwcERpY3QpIHtcbiAgbGV0IGFwcElkO1xuICBmb3IgKGNvbnN0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgIGlmIChkYXRhLmJ1bmRsZUlkLmVuZHNXaXRoKGJ1bmRsZUlkKSkge1xuICAgICAgYXBwSWQgPSBrZXk7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICAvLyBpZiBub3RoaW5nIGlzIGZvdW5kLCB0cnkgdG8gZ2V0IHRoZSBnZW5lcmljIGFwcFxuICBpZiAoIWFwcElkICYmIGJ1bmRsZUlkICE9PSBXRUJfQ09OVEVOVF9CVU5ETEVfSUQpIHtcbiAgICByZXR1cm4gYXBwSWRGb3JCdW5kbGUoV0VCX0NPTlRFTlRfQlVORExFX0lELCBhcHBEaWN0KTtcbiAgfVxuXG4gIHJldHVybiBhcHBJZDtcbn1cblxuZnVuY3Rpb24gZ2V0UG9zc2libGVEZWJ1Z2dlckFwcEtleXMgKGJ1bmRsZUlkcywgYXBwRGljdCkge1xuICBsZXQgcHJveGllZEFwcElkcyA9IFtdO1xuXG4gIC8vIGdvIHRocm91Z2ggdGhlIHBvc3NpYmxlIGJ1bmRsZSBpZGVudGlmaWVycywgYWxvbmcgd2l0aCB0aGUgd2lsZGNhcmRcbiAgY29uc3QgcG9zc2libGVCdW5kbGVJZHMgPSBbLi4uYnVuZGxlSWRzLCBXSUxEQ0FSRF9CVU5ETEVfSURdO1xuICBsb2cuZGVidWcoYENoZWNraW5nIGZvciBidW5kbGUgaWRlbnRpZmllcnM6ICR7cG9zc2libGVCdW5kbGVJZHMuam9pbignLCAnKX1gKTtcbiAgZm9yIChjb25zdCBidW5kbGVJZCBvZiBwb3NzaWJsZUJ1bmRsZUlkcykge1xuICAgIGNvbnN0IGFwcElkID0gYXBwSWRGb3JCdW5kbGUoYnVuZGxlSWQsIGFwcERpY3QpO1xuXG4gICAgLy8gbm93IHdlIG5lZWQgdG8gZGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBwaWNrIGEgcHJveHkgZm9yIHRoaXMgaW5zdGVhZFxuICAgIGlmIChhcHBJZCkge1xuICAgICAgcHJveGllZEFwcElkcy5wdXNoKGFwcElkKTtcbiAgICAgIGxvZy5kZWJ1ZyhgRm91bmQgYXBwIGlkIGtleSAnJHthcHBJZH0nIGZvciBidW5kbGUgJyR7YnVuZGxlSWR9J2ApO1xuICAgICAgZm9yIChjb25zdCBba2V5LCBkYXRhXSBvZiBfLnRvUGFpcnMoYXBwRGljdCkpIHtcbiAgICAgICAgaWYgKGRhdGEuaXNQcm94eSAmJiBkYXRhLmhvc3RJZCA9PT0gYXBwSWQpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYEZvdW5kIHNlcGFyYXRlIGJ1bmRsZUlkICcke2RhdGEuYnVuZGxlSWR9JyBgICtcbiAgICAgICAgICAgICAgICAgICAgYGFjdGluZyBhcyBwcm94eSBmb3IgJyR7YnVuZGxlSWR9Jywgd2l0aCBhcHAgaWQgJyR7a2V5fSdgKTtcbiAgICAgICAgICBwcm94aWVkQXBwSWRzLnB1c2goa2V5KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBwcm94aWVkQXBwSWRzO1xufVxuXG5mdW5jdGlvbiBjaGVja1BhcmFtcyAocGFyYW1zKSB7XG4gIGxldCBlcnJvcnMgPSBbXTtcbiAgZm9yIChjb25zdCBbcGFyYW0sIHZhbHVlXSBvZiBfLnRvUGFpcnMocGFyYW1zKSkge1xuICAgIHRyeSB7XG4gICAgICBhc3NlcnQub2sodmFsdWUpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgZXJyb3JzLnB1c2gocGFyYW0pO1xuICAgIH1cbiAgfVxuICBpZiAoZXJyb3JzLmxlbmd0aCkge1xuICAgIHJldHVybiBlcnJvcnM7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gd3JhcFNjcmlwdEZvckZyYW1lIChzY3JpcHQsIGZyYW1lKSB7XG4gIGxvZy5kZWJ1ZyhgV3JhcHBpbmcgc2NyaXB0IGZvciBmcmFtZSAnJHtmcmFtZX0nYCk7XG4gIGxldCBlbEZyb21DYWNoZSA9IGF3YWl0IGdldEF0b20oJ2dldF9lbGVtZW50X2Zyb21fY2FjaGUnKTtcbiAgcmV0dXJuIGAoZnVuY3Rpb24gKHdpbmRvdykgeyB2YXIgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQ7IGAgK1xuICAgICAgICAgYHJldHVybiAoJHtzY3JpcHR9KTsgfSkoKCR7ZWxGcm9tQ2FjaGUudG9TdHJpbmcoJ3V0ZjgnKX0pKCR7SlNPTi5zdHJpbmdpZnkoZnJhbWUpfSkpYDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0U2NyaXB0Rm9yQXRvbSAoYXRvbSwgYXJncywgZnJhbWVzLCBhc3luY0NhbGxCYWNrID0gbnVsbCkge1xuICBsZXQgYXRvbVNyYyA9IGF3YWl0IGdldEF0b20oYXRvbSk7XG4gIGxldCBzY3JpcHQ7XG4gIGlmIChmcmFtZXMubGVuZ3RoID4gMCkge1xuICAgIHNjcmlwdCA9IGF0b21TcmM7XG4gICAgZm9yIChjb25zdCBmcmFtZSBvZiBmcmFtZXMpIHtcbiAgICAgIHNjcmlwdCA9IGF3YWl0IHdyYXBTY3JpcHRGb3JGcmFtZShzY3JpcHQsIGZyYW1lKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbG9nLmRlYnVnKGBFeGVjdXRpbmcgJyR7YXRvbX0nIGF0b20gaW4gZGVmYXVsdCBjb250ZXh0YCk7XG4gICAgc2NyaXB0ID0gYCgke2F0b21TcmN9KWA7XG4gIH1cblxuICAvLyBhZGQgdGhlIGFyZ3VtZW50cywgYXMgc3RyaW5nc1xuICBhcmdzID0gYXJncy5tYXAoSlNPTi5zdHJpbmdpZnkpO1xuICBpZiAoYXN5bmNDYWxsQmFjaykge1xuICAgIHNjcmlwdCArPSBgKCR7YXJncy5qb2luKCcsJyl9LCAke2FzeW5jQ2FsbEJhY2t9LCB0cnVlIClgO1xuICB9IGVsc2Uge1xuICAgIHNjcmlwdCArPSBgKCR7YXJncy5qb2luKCcsJyl9KWA7XG4gIH1cblxuICByZXR1cm4gc2NyaXB0O1xufVxuXG5mdW5jdGlvbiBzaW1wbGVTdHJpbmdpZnkgKHZhbHVlLCBtdWx0aWxpbmUgPSBmYWxzZSkge1xuICBpZiAoIXZhbHVlKSB7XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcbiAgfVxuXG4gIC8vIHdlIGdldCBiYWNrIG9iamVjdHMgc29tZXRpbWVzIHdpdGggc3RyaW5nIHZlcnNpb25zIG9mIGZ1bmN0aW9uc1xuICAvLyB3aGljaCBtdWRkeSB0aGUgbG9nc1xuICBsZXQgY2xlYW5WYWx1ZSA9IF8uY2xvbmUodmFsdWUpO1xuICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIFsnY2VpbCcsICdjbG9uZScsICdmbG9vcicsICdyb3VuZCcsICdzY2FsZScsICd0b1N0cmluZyddKSB7XG4gICAgZGVsZXRlIGNsZWFuVmFsdWVbcHJvcGVydHldO1xuICB9XG4gIHJldHVybiBtdWx0aWxpbmUgPyBKU09OLnN0cmluZ2lmeShjbGVhblZhbHVlLCBudWxsLCAyKSA6IEpTT04uc3RyaW5naWZ5KGNsZWFuVmFsdWUpO1xufVxuXG5mdW5jdGlvbiBkZWZlcnJlZFByb21pc2UgKCkge1xuICAvLyBodHRwOi8vYmx1ZWJpcmRqcy5jb20vZG9jcy9hcGkvZGVmZXJyZWQtbWlncmF0aW9uLmh0bWxcbiAgbGV0IHJlc29sdmU7XG4gIGxldCByZWplY3Q7XG4gIGNvbnN0IHByb21pc2UgPSBuZXcgQigocmVzLCByZWopID0+IHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBwcm9taXNlL3BhcmFtLW5hbWVzXG4gICAgcmVzb2x2ZSA9IHJlcztcbiAgICByZWplY3QgPSByZWo7XG4gIH0pO1xuICByZXR1cm4ge1xuICAgIHByb21pc2UsXG4gICAgcmVzb2x2ZSxcbiAgICByZWplY3RcbiAgfTtcbn1cblxuZnVuY3Rpb24gZ2V0RWxhcHNlZFRpbWUgKHN0YXJ0VGltZSkge1xuICBjb25zdCBlbmRUaW1lID0gcHJvY2Vzcy5ocnRpbWUoc3RhcnRUaW1lKTtcbiAgcmV0dXJuIHBhcnNlSW50KChlbmRUaW1lWzBdICogMWU5ICsgZW5kVGltZVsxXSkgLyAxZTYsIDEwKTtcbn1cblxuZnVuY3Rpb24gY29udmVydFJlc3VsdCAocmVzKSB7XG4gIGlmIChfLmlzVW5kZWZpbmVkKHJlcykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYERpZCBub3QgZ2V0IE9LIHJlc3VsdCBmcm9tIHJlbW90ZSBkZWJ1Z2dlci4gUmVzdWx0IHdhczogJHtfLnRydW5jYXRlKHNpbXBsZVN0cmluZ2lmeShyZXMpLCB7bGVuZ3RoOiBSRVNQT05TRV9MT0dfTEVOR1RIfSl9YCk7XG4gIH0gZWxzZSBpZiAoXy5pc1N0cmluZyhyZXMpKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJlcyA9IEpTT04ucGFyc2UocmVzKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIHdlIG1pZ2h0IGdldCBhIHNlcmlhbGl6ZWQgb2JqZWN0LCBidXQgd2UgbWlnaHQgbm90XG4gICAgICAvLyBpZiB3ZSBnZXQgaGVyZSwgaXQgaXMganVzdCBhIHZhbHVlXG4gICAgfVxuICB9IGVsc2UgaWYgKCFfLmlzT2JqZWN0KHJlcykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFJlc3VsdCBoYXMgdW5leHBlY3RlZCB0eXBlOiAoJHt0eXBlb2YgcmVzfSkuYCk7XG4gIH1cblxuICBpZiAocmVzLnN0YXR1cyAmJiByZXMuc3RhdHVzICE9PSAwKSB7XG4gICAgLy8gd2UgZ290IHNvbWUgZm9ybSBvZiBlcnJvci5cbiAgICB0aHJvdyBlcnJvckZyb21NSlNPTldQU3RhdHVzQ29kZShyZXMuc3RhdHVzLCByZXMudmFsdWUubWVzc2FnZSB8fCByZXMudmFsdWUpO1xuICB9XG5cbiAgLy8gd2l0aCBlaXRoZXIgaGF2ZSBhbiBvYmplY3Qgd2l0aCBhIGB2YWx1ZWAgcHJvcGVydHkgKGV2ZW4gaWYgYG51bGxgKSxcbiAgLy8gb3IgYSBwbGFpbiBvYmplY3RcbiAgcmV0dXJuIF8uaGFzKHJlcywgJ3ZhbHVlJykgPyByZXMudmFsdWUgOiByZXM7XG59XG5cbmV4cG9ydCB7XG4gIGFwcEluZm9Gcm9tRGljdCwgcGFnZUFycmF5RnJvbURpY3QsIGdldERlYnVnZ2VyQXBwS2V5LFxuICBnZXRQb3NzaWJsZURlYnVnZ2VyQXBwS2V5cywgY2hlY2tQYXJhbXMsIHdyYXBTY3JpcHRGb3JGcmFtZSwgZ2V0U2NyaXB0Rm9yQXRvbSxcbiAgc2ltcGxlU3RyaW5naWZ5LCBkZWZlcnJlZFByb21pc2UsIGdldEVsYXBzZWRUaW1lLFxuICBjb252ZXJ0UmVzdWx0LCBSRVNQT05TRV9MT0dfTEVOR1RILFxufTtcbiJdLCJmaWxlIjoibGliL2hlbHBlcnMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
