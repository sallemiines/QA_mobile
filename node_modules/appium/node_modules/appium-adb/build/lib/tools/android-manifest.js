"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger.js"));

var _helpers = require("../helpers.js");

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _shellQuote = require("shell-quote");

var _adbkitApkreader = _interopRequireDefault(require("adbkit-apkreader"));

let manifestMethods = {};

manifestMethods.packageAndLaunchActivityFromManifest = async function packageAndLaunchActivityFromManifest(appPath) {
  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  const apkReader = await _adbkitApkreader.default.open(appPath);
  const manifest = await apkReader.readManifest();
  const {
    pkg,
    activity
  } = (0, _helpers.parseManifest)(manifest);

  _logger.default.info(`Package name: '${pkg}'`);

  _logger.default.info(`Main activity name: '${activity}'`);

  return {
    apkPackage: pkg,
    apkActivity: activity
  };
};

manifestMethods.targetSdkVersionFromManifest = async function targetSdkVersionFromManifest(appPath) {
  const originalAppPath = appPath;

  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  _logger.default.info('Extracting target SDK version from the manifest');

  try {
    const apkanalyzerPath = await (0, _helpers.getApkanalyzerForOs)(this);
    const {
      stdout
    } = await (0, _teen_process.exec)(apkanalyzerPath, ['manifest', 'target-sdk', appPath], {
      shell: true,
      cwd: _path.default.dirname(apkanalyzerPath)
    });

    if (isNaN(_lodash.default.trim(stdout))) {
      throw new Error(`Cannot parse the minimum SDK version from '${stdout}'`);
    }

    return parseInt(_lodash.default.trim(stdout), 10);
  } catch (e) {
    _logger.default.info(`Cannot extract targetSdkVersion using apkanalyzer. Falling back to aapt. ` + `Original error: ${e.message}`);

    await this.initAapt();
    const args = ['dump', 'badging', appPath];
    let output;

    try {
      const {
        stdout
      } = await (0, _teen_process.exec)(this.binaries.aapt, args);
      output = stdout;
    } catch (e) {
      throw new Error(`Fetching targetSdkVersion from '${originalAppPath}' failed. ` + `Original error: ${e.message}`);
    }

    const targetSdkVersion = new RegExp(/targetSdkVersion:'([^']+)'/g).exec(output);

    if (!targetSdkVersion) {
      throw new Error(`targetSdkVersion is not specified in the '${originalAppPath}' application`);
    }

    return parseInt(targetSdkVersion[1], 10);
  }
};

manifestMethods.targetSdkVersionUsingPKG = async function targetSdkVersionUsingPKG(pkg, cmdOutput = null) {
  let stdout = cmdOutput || (await this.shell(['dumpsys', 'package', pkg]));
  let targetSdkVersion = new RegExp(/targetSdk=([^\s\s]+)/g).exec(stdout);

  if (targetSdkVersion && targetSdkVersion.length >= 2) {
    targetSdkVersion = targetSdkVersion[1];
  } else {
    targetSdkVersion = 0;
  }

  return parseInt(targetSdkVersion, 10);
};

manifestMethods.compileManifest = async function compileManifest(manifest, manifestPackage, targetPackage) {
  const {
    platform,
    platformPath
  } = await (0, _helpers.getAndroidPlatformAndPath)();

  if (!platform) {
    throw new Error('Cannot compile the manifest. The required platform does not exist (API level >= 17)');
  }

  const resultPath = `${manifest}.apk`;

  const androidJarPath = _path.default.resolve(platformPath, 'android.jar');

  if (await _appiumSupport.fs.exists(resultPath)) {
    await _appiumSupport.fs.rimraf(resultPath);
  }

  try {
    await this.initAapt2();
    const args = ['link', '-o', resultPath, '--manifest', manifest, '--rename-manifest-package', manifestPackage, '--rename-instrumentation-target-package', targetPackage, '-I', androidJarPath, '-v'];

    _logger.default.debug(`Compiling the manifest using '${(0, _shellQuote.quote)([this.binaries.aapt2, ...args])}'`);

    await (0, _teen_process.exec)(this.binaries.aapt2, args);
  } catch (e) {
    _logger.default.debug('Cannot compile the manifest using aapt2. Defaulting to aapt. ' + `Original error: ${e.stderr || e.message}`);

    await this.initAapt();
    const args = ['package', '-M', manifest, '--rename-manifest-package', manifestPackage, '--rename-instrumentation-target-package', targetPackage, '-I', androidJarPath, '-F', resultPath, '-f'];

    _logger.default.debug(`Compiling the manifest using '${(0, _shellQuote.quote)([this.binaries.aapt, ...args])}'`);

    try {
      await (0, _teen_process.exec)(this.binaries.aapt, args);
    } catch (e1) {
      throw new Error(`Cannot compile the manifest. Original error: ${e1.stderr || e1.message}`);
    }
  }

  _logger.default.debug(`Compiled the manifest at '${resultPath}'`);
};

manifestMethods.insertManifest = async function insertManifest(manifest, srcApk, dstApk) {
  _logger.default.debug(`Inserting manifest '${manifest}', src: '${srcApk}', dst: '${dstApk}'`);

  await _appiumSupport.zip.assertValidZip(srcApk);
  await (0, _helpers.unzipFile)(`${manifest}.apk`);

  const manifestName = _path.default.basename(manifest);

  try {
    await this.initAapt();
    await _appiumSupport.fs.copyFile(srcApk, dstApk);

    _logger.default.debug('Moving manifest');

    try {
      await (0, _teen_process.exec)(this.binaries.aapt, ['remove', dstApk, manifestName]);
    } catch (ign) {}

    await (0, _teen_process.exec)(this.binaries.aapt, ['add', dstApk, manifestName], {
      cwd: _path.default.dirname(manifest)
    });
  } catch (e) {
    _logger.default.debug('Cannot insert manifest using aapt. Defaulting to zip. ' + `Original error: ${e.stderr || e.message}`);

    const tmpRoot = await _appiumSupport.tempDir.openDir();

    try {
      _logger.default.debug(`Extracting the source apk at '${srcApk}'`);

      await _appiumSupport.zip.extractAllTo(srcApk, tmpRoot);

      _logger.default.debug('Moving manifest');

      await _appiumSupport.fs.mv(manifest, _path.default.resolve(tmpRoot, manifestName));

      _logger.default.debug(`Collecting the destination apk at '${dstApk}'`);

      await _appiumSupport.zip.toArchive(dstApk, {
        cwd: tmpRoot
      });
    } finally {
      await _appiumSupport.fs.rimraf(tmpRoot);
    }
  }

  _logger.default.debug(`Manifest insertion into '${dstApk}' is completed`);
};

manifestMethods.hasInternetPermissionFromManifest = async function hasInternetPermissionFromManifest(appPath) {
  _logger.default.debug(`Checking if '${appPath}' requires internet access permission in the manifest`);

  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  const apkReader = await _adbkitApkreader.default.open(appPath);
  const manifest = await apkReader.readManifest();
  return (manifest.usesPermissions || []).some(({
    name
  }) => name === 'android.permission.INTERNET');
};

var _default = manifestMethods;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9hbmRyb2lkLW1hbmlmZXN0LmpzIl0sIm5hbWVzIjpbIm1hbmlmZXN0TWV0aG9kcyIsInBhY2thZ2VBbmRMYXVuY2hBY3Rpdml0eUZyb21NYW5pZmVzdCIsImFwcFBhdGgiLCJlbmRzV2l0aCIsIkFQS1NfRVhURU5TSU9OIiwiZXh0cmFjdEJhc2VBcGsiLCJhcGtSZWFkZXIiLCJBcGtSZWFkZXIiLCJvcGVuIiwibWFuaWZlc3QiLCJyZWFkTWFuaWZlc3QiLCJwa2ciLCJhY3Rpdml0eSIsImxvZyIsImluZm8iLCJhcGtQYWNrYWdlIiwiYXBrQWN0aXZpdHkiLCJ0YXJnZXRTZGtWZXJzaW9uRnJvbU1hbmlmZXN0Iiwib3JpZ2luYWxBcHBQYXRoIiwiYXBrYW5hbHl6ZXJQYXRoIiwic3Rkb3V0Iiwic2hlbGwiLCJjd2QiLCJwYXRoIiwiZGlybmFtZSIsImlzTmFOIiwiXyIsInRyaW0iLCJFcnJvciIsInBhcnNlSW50IiwiZSIsIm1lc3NhZ2UiLCJpbml0QWFwdCIsImFyZ3MiLCJvdXRwdXQiLCJiaW5hcmllcyIsImFhcHQiLCJ0YXJnZXRTZGtWZXJzaW9uIiwiUmVnRXhwIiwiZXhlYyIsInRhcmdldFNka1ZlcnNpb25Vc2luZ1BLRyIsImNtZE91dHB1dCIsImxlbmd0aCIsImNvbXBpbGVNYW5pZmVzdCIsIm1hbmlmZXN0UGFja2FnZSIsInRhcmdldFBhY2thZ2UiLCJwbGF0Zm9ybSIsInBsYXRmb3JtUGF0aCIsInJlc3VsdFBhdGgiLCJhbmRyb2lkSmFyUGF0aCIsInJlc29sdmUiLCJmcyIsImV4aXN0cyIsInJpbXJhZiIsImluaXRBYXB0MiIsImRlYnVnIiwiYWFwdDIiLCJzdGRlcnIiLCJlMSIsImluc2VydE1hbmlmZXN0Iiwic3JjQXBrIiwiZHN0QXBrIiwiemlwIiwiYXNzZXJ0VmFsaWRaaXAiLCJtYW5pZmVzdE5hbWUiLCJiYXNlbmFtZSIsImNvcHlGaWxlIiwiaWduIiwidG1wUm9vdCIsInRlbXBEaXIiLCJvcGVuRGlyIiwiZXh0cmFjdEFsbFRvIiwibXYiLCJ0b0FyY2hpdmUiLCJoYXNJbnRlcm5ldFBlcm1pc3Npb25Gcm9tTWFuaWZlc3QiLCJ1c2VzUGVybWlzc2lvbnMiLCJzb21lIiwibmFtZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFJQSxlQUFlLEdBQUcsRUFBdEI7O0FBZ0JBQSxlQUFlLENBQUNDLG9DQUFoQixHQUF1RCxlQUFlQSxvQ0FBZixDQUFxREMsT0FBckQsRUFBOEQ7QUFDbkgsTUFBSUEsT0FBTyxDQUFDQyxRQUFSLENBQWlCQyx1QkFBakIsQ0FBSixFQUFzQztBQUNwQ0YsSUFBQUEsT0FBTyxHQUFHLE1BQU0sS0FBS0csY0FBTCxDQUFvQkgsT0FBcEIsQ0FBaEI7QUFDRDs7QUFFRCxRQUFNSSxTQUFTLEdBQUcsTUFBTUMseUJBQVVDLElBQVYsQ0FBZU4sT0FBZixDQUF4QjtBQUNBLFFBQU1PLFFBQVEsR0FBRyxNQUFNSCxTQUFTLENBQUNJLFlBQVYsRUFBdkI7QUFDQSxRQUFNO0FBQUNDLElBQUFBLEdBQUQ7QUFBTUMsSUFBQUE7QUFBTixNQUFrQiw0QkFBY0gsUUFBZCxDQUF4Qjs7QUFDQUksa0JBQUlDLElBQUosQ0FBVSxrQkFBaUJILEdBQUksR0FBL0I7O0FBQ0FFLGtCQUFJQyxJQUFKLENBQVUsd0JBQXVCRixRQUFTLEdBQTFDOztBQUNBLFNBQU87QUFDTEcsSUFBQUEsVUFBVSxFQUFFSixHQURQO0FBRUxLLElBQUFBLFdBQVcsRUFBRUo7QUFGUixHQUFQO0FBSUQsQ0FkRDs7QUF3QkFaLGVBQWUsQ0FBQ2lCLDRCQUFoQixHQUErQyxlQUFlQSw0QkFBZixDQUE2Q2YsT0FBN0MsRUFBc0Q7QUFDbkcsUUFBTWdCLGVBQWUsR0FBR2hCLE9BQXhCOztBQUNBLE1BQUlBLE9BQU8sQ0FBQ0MsUUFBUixDQUFpQkMsdUJBQWpCLENBQUosRUFBc0M7QUFDcENGLElBQUFBLE9BQU8sR0FBRyxNQUFNLEtBQUtHLGNBQUws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Q0FBQzBFLGlDQUFoQixHQUFvRCxlQUFlQSxpQ0FBZixDQUFrRHhFLE9BQWxELEVBQTJEO0FBQzdHVyxrQkFBSTBDLEtBQUosQ0FBVyxnQkFBZXJELE9BQVEsdURBQWxDOztBQUNBLE1BQUlBLE9BQU8sQ0FBQ0MsUUFBUixDQUFpQkMsdUJBQWpCLENBQUosRUFBc0M7QUFDcENGLElBQUFBLE9BQU8sR0FBRyxNQUFNLEtBQUtHLGNBQUwsQ0FBb0JILE9BQXBCLENBQWhCO0FBQ0Q7O0FBRUQsUUFBTUksU0FBUyxHQUFHLE1BQU1DLHlCQUFVQyxJQUFWLENBQWVOLE9BQWYsQ0FBeEI7QUFDQSxRQUFNTyxRQUFRLEdBQUcsTUFBTUgsU0FBUyxDQUFDSSxZQUFWLEVBQXZCO0FBQ0EsU0FBTyxDQUFDRCxRQUFRLENBQUNrRSxlQUFULElBQTRCLEVBQTdCLEVBQWlDQyxJQUFqQyxDQUFzQyxDQUFDO0FBQUNDLElBQUFBO0FBQUQsR0FBRCxLQUFZQSxJQUFJLEtBQUssNkJBQTNELENBQVA7QUFDRCxDQVREOztlQVdlN0UsZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXIuanMnO1xuaW1wb3J0IHtcbiAgZ2V0QW5kcm9pZFBsYXRmb3JtQW5kUGF0aCwgdW56aXBGaWxlLFxuICBnZXRBcGthbmFseXplckZvck9zLCBBUEtTX0VYVEVOU0lPTiwgcGFyc2VNYW5pZmVzdCB9IGZyb20gJy4uL2hlbHBlcnMuanMnO1xuaW1wb3J0IHsgZnMsIHppcCwgdGVtcERpciB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHF1b3RlIH0gZnJvbSAnc2hlbGwtcXVvdGUnO1xuaW1wb3J0IEFwa1JlYWRlciBmcm9tICdhZGJraXQtYXBrcmVhZGVyJztcblxubGV0IG1hbmlmZXN0TWV0aG9kcyA9IHt9O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IEFQS0luZm9cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBhcGtQYWNrYWdlIC0gVGhlIG5hbWUgb2YgYXBwbGljYXRpb24gcGFja2FnZSwgZm9yIGV4YW1wbGUgJ2NvbS5hY21lLmFwcCcuXG4gKiBAcHJvcGVydHkge3N0cmluZ30gYXBrQWN0aXZpdHkgLSBUaGUgbmFtZSBvZiBtYWluIGFwcGxpY2F0aW9uIGFjdGl2aXR5LlxuICovXG5cbi8qKlxuICogRXh0cmFjdCBwYWNrYWdlIGFuZCBtYWluIGFjdGl2aXR5IG5hbWUgZnJvbSBhcHBsaWNhdGlvbiBtYW5pZmVzdC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBwUGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gYXBwbGljYXRpb24gLmFwayhzKSBwYWNrYWdlXG4gKiBAcmV0dXJuIHtBUEtJbmZvfSBUaGUgcGFyc2VkIGFwcGxpY2F0aW9uIGluZm8uXG4gKiBAdGhyb3dzIHtlcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGdldHRpbmcgdGhlIGRhdGEgZnJvbSB0aGUgZ2l2ZW5cbiAqICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbiBwYWNrYWdlLlxuICovXG5tYW5pZmVzdE1ldGhvZHMucGFja2FnZUFuZExhdW5jaEFjdGl2aXR5RnJvbU1hbmlmZXN0ID0gYXN5bmMgZnVuY3Rpb24gcGFja2FnZUFuZExhdW5jaEFjdGl2aXR5RnJvbU1hbmlmZXN0IChhcHBQYXRoKSB7XG4gIGlmIChhcHBQYXRoLmVuZHNXaXRoKEFQS1NfRVhURU5TSU9OKSkge1xuICAgIGFwcFBhdGggPSBhd2FpdCB0aGlzLmV4dHJhY3RCYXNlQXBrKGFwcFBhdGgpO1xuICB9XG5cbiAgY29uc3QgYXBrUmVhZGVyID0gYXdhaXQgQXBrUmVhZGVyLm9wZW4oYXBwUGF0aCk7XG4gIGNvbnN0IG1hbmlmZXN0ID0gYXdhaXQgYXBrUmVhZGVyLnJlYWRNYW5pZmVzdCgpO1xuICBjb25zdCB7cGtnLCBhY3Rpdml0eX0gPSBwYXJzZU1hbmlmZXN0KG1hbmlmZXN0KTtcbiAgbG9nLmluZm8oYFBhY2thZ2UgbmFtZTogJyR7cGtnfSdgKTtcbiAgbG9nLmluZm8oYE1haW4gYWN0aXZpdHkgbmFtZTogJyR7YWN0aXZpdHl9J2ApO1xuICByZXR1cm4ge1xuICAgIGFwa1BhY2thZ2U6IHBrZyxcbiAgICBhcGtBY3Rpdml0eTogYWN0aXZpdHksXG4gIH07XG59O1xuXG4vKipcbiAqIEV4dHJhY3QgdGFyZ2V0IFNESyB2ZXJzaW9uIGZyb20gYXBwbGljYXRpb24gbWFuaWZlc3QuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwcFBhdGggLSBUaGUgZnVsbCBwYXRoIHRvIC5hcGsocykgcGFja2FnZS5cbiAqIEByZXR1cm4ge251bWJlcn0gVGhlIHZlcnNpb24gb2YgdGhlIHRhcmdldCBTREsuXG4gKiBAdGhyb3dzIHtlcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGdldHRpbmcgdGhlIGRhdGEgZnJvbSB0aGUgZ2l2ZW5cbiAqICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbiBwYWNrYWdlLlxuICovXG5tYW5pZmVzdE1ldGhvZHMudGFyZ2V0U2RrVmVyc2lvbkZyb21NYW5pZmVzdCA9IGFzeW5jIGZ1bmN0aW9uIHRhcmdldFNka1ZlcnNpb25Gcm9tTWFuaWZlc3QgKGFwcFBhdGgpIHtcbiAgY29uc3Qgb3JpZ2luYWxBcHBQYXRoID0gYXBwUGF0aDtcbiAgaWYgKGFwcFBhdGguZW5kc1dpdGgoQVBLU19FWFRFTlNJT04pKSB7XG4gICAgYXBwUGF0aCA9IGF3YWl0IHRoaXMuZXh0cmFjdEJhc2VBcGsoYXBwUGF0aCk7XG4gIH1cblxuICBsb2cuaW5mbygnRXh0cmFjdGluZyB0YXJnZXQgU0RLIHZlcnNpb24gZnJvbSB0aGUgbWFuaWZlc3QnKTtcbiAgdHJ5IHtcbiAgICBjb25zdCBhcGthbmFseXplclBhdGggPSBhd2FpdCBnZXRBcGthbmFseXplckZvck9zKHRoaXMpO1xuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyhhcGthbmFseXplclBhdGgsIFsnbWFuaWZlc3QnLCAndGFyZ2V0LXNkaycsIGFwcFBhdGhdLCB7XG4gICAgICBzaGVsbDogdHJ1ZSxcbiAgICAgIGN3ZDogcGF0aC5kaXJuYW1lKGFwa2FuYWx5emVyUGF0aCksXG4gICAgfSk7XG4gICAgaWYgKGlzTmFOKF8udHJpbShzdGRvdXQpKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcGFyc2UgdGhlIG1pbmltdW0gU0RLIHZlcnNpb24gZnJvbSAnJHtzdGRvdXR9J2ApO1xuICAgIH1cbiAgICByZXR1cm4gcGFyc2VJbnQoXy50cmltKHN0ZG91dCksIDEwKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5pbmZvKGBDYW5ub3QgZXh0cmFjdCB0YXJnZXRTZGtWZXJzaW9uIHVzaW5nIGFwa2FuYWx5emVyLiBGYWxsaW5nIGJhY2sgdG8gYWFwdC4gYCArXG4gICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgIGF3YWl0IHRoaXMuaW5pdEFhcHQoKTtcbiAgICBjb25zdCBhcmdzID0gWydkdW1wJywgJ2JhZGdpbmcnLCBhcHBQYXRoXTtcbiAgICBsZXQgb3V0cHV0O1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy5hYXB0LCBhcmdzKTtcbiAgICAgIG91dHB1dCA9IHN0ZG91dDtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEZldGNoaW5nIHRhcmdldFNka1ZlcnNpb24gZnJvbSAnJHtvcmlnaW5hbEFwcFBhdGh9JyBmYWlsZWQuIGAgK1xuICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgICBjb25zdCB0YXJnZXRTZGtWZXJzaW9uID0gbmV3IFJlZ0V4cCgvdGFyZ2V0U2RrVmVyc2lvbjonKFteJ10rKScvZykuZXhlYyhvdXRwdXQpO1xuICAgIGlmICghdGFyZ2V0U2RrVmVyc2lvbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGB0YXJnZXRTZGtWZXJzaW9uIGlzIG5vdCBzcGVjaWZpZWQgaW4gdGhlICcke29yaWdpbmFsQXBwUGF0aH0nIGFwcGxpY2F0aW9uYCk7XG4gICAgfVxuICAgIHJldHVybiBwYXJzZUludCh0YXJnZXRTZGtWZXJzaW9uWzFdLCAxMCk7XG4gIH1cbn07XG5cbi8qKlxuICogRXh0cmFjdCB0YXJnZXQgU0RLIHZlcnNpb24gZnJvbSBwYWNrYWdlIGluZm9ybWF0aW9uLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBwa2cgLSBUaGUgY2xhc3MgbmFtZSBvZiB0aGUgcGFja2FnZSBpbnN0YWxsZWQgb24gdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogQHBhcmFtIHs/c3RyaW5nfSBjbWRPdXRwdXQgLSBPcHRpb25hbCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgb3V0cHV0IG9mXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9kdW1wc3lzIHBhY2thZ2VfIGNvbW1hbmQuIEl0IG1heSBzcGVlZCB1cCB0aGUgbWV0aG9kIGV4ZWN1dGlvbi5cbiAqIEByZXR1cm4ge251bWJlcn0gVGhlIHZlcnNpb24gb2YgdGhlIHRhcmdldCBTREsuXG4gKi9cbm1hbmlmZXN0TWV0aG9kcy50YXJnZXRTZGtWZXJzaW9uVXNpbmdQS0cgPSBhc3luYyBmdW5jdGlvbiB0YXJnZXRTZGtWZXJzaW9uVXNpbmdQS0cgKHBrZywgY21kT3V0cHV0ID0gbnVsbCkge1xuICBsZXQgc3Rkb3V0ID0gY21kT3V0cHV0IHx8IGF3YWl0IHRoaXMuc2hlbGwoWydkdW1wc3lzJywgJ3BhY2thZ2UnLCBwa2ddKTtcbiAgbGV0IHRhcmdldFNka1ZlcnNpb24gPSBuZXcgUmVnRXhwKC90YXJnZXRTZGs9KFteXFxzXFxzXSspL2cpLmV4ZWMoc3Rkb3V0KTtcbiAgaWYgKHRhcmdldFNka1ZlcnNpb24gJiYgdGFyZ2V0U2RrVmVyc2lvbi5sZW5ndGggPj0gMikge1xuICAgIHRhcmdldFNka1ZlcnNpb24gPSB0YXJnZXRTZGtWZXJzaW9uWzFdO1xuICB9IGVsc2Uge1xuICAgIC8vIHRhcmdldFNkayBub3QgZm91bmQgaW4gdGhlIGR1bXAsIGFzc2lnbmluZyAwIHRvIHRhcmdldFNka1ZlcnNpb25cbiAgICB0YXJnZXRTZGtWZXJzaW9uID0gMDtcbiAgfVxuICByZXR1cm4gcGFyc2VJbnQodGFyZ2V0U2RrVmVyc2lvbiwgMTApO1xufTtcblxuLyoqXG4gKiBDcmVhdGUgYmluYXJ5IHJlcHJlc2VudGF0aW9uIG9mIHBhY2thZ2UgbWFuaWZlc3QgKHVzdWFsbHkgQW5kcm9pZE1hbmlmZXN0LnhtbCkuXG4gKiBgJHttYW5pZmVzdH0uYXBrYCBmaWxlIHdpbGwgYmUgY3JlYXRlZCBhcyB0aGUgcmVzdWx0IG9mIHRoaXMgbWV0aG9kXG4gKiBjb250YWluaW5nIHRoZSBjb21waWxlZCBtYW5pZmVzdC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gbWFuaWZlc3QgLSBGdWxsIHBhdGggdG8gdGhlIGluaXRpYWwgbWFuaWZlc3QgdGVtcGxhdGVcbiAqIEBwYXJhbSB7c3RyaW5nfSBtYW5pZmVzdFBhY2thZ2UgLSBUaGUgbmFtZSBvZiB0aGUgbWFuaWZlc3QgcGFja2FnZVxuICogQHBhcmFtIHtzdHJpbmd9IHRhcmdldFBhY2thZ2UgLSBUaGUgbmFtZSBvZiB0aGUgZGVzdGluYXRpb24gcGFja2FnZVxuICovXG5tYW5pZmVzdE1ldGhvZHMuY29tcGlsZU1hbmlmZXN0ID0gYXN5bmMgZnVuY3Rpb24gY29tcGlsZU1hbmlmZXN0IChtYW5pZmVzdCwgbWFuaWZlc3RQYWNrYWdlLCB0YXJnZXRQYWNrYWdlKSB7XG4gIGNvbnN0IHtwbGF0Zm9ybSwgcGxhdGZvcm1QYXRofSA9IGF3YWl0IGdldEFuZHJvaWRQbGF0Zm9ybUFuZFBhdGgoKTtcbiAgaWYgKCFwbGF0Zm9ybSkge1xuICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGNvbXBpbGUgdGhlIG1hbmlmZXN0LiBUaGUgcmVxdWlyZWQgcGxhdGZvcm0gZG9lcyBub3QgZXhpc3QgKEFQSSBsZXZlbCA+PSAxNyknKTtcbiAgfVxuICBjb25zdCByZXN1bHRQYXRoID0gYCR7bWFuaWZlc3R9LmFwa2A7XG4gIGNvbnN0IGFuZHJvaWRKYXJQYXRoID0gcGF0aC5yZXNvbHZlKHBsYXRmb3JtUGF0aCwgJ2FuZHJvaWQuamFyJyk7XG4gIGlmIChhd2FpdCBmcy5leGlzdHMocmVzdWx0UGF0aCkpIHtcbiAgICBhd2FpdCBmcy5yaW1yYWYocmVzdWx0UGF0aCk7XG4gIH1cbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmluaXRBYXB0MigpO1xuICAgIC8vIGh0dHBzOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3N0dWRpby9jb21tYW5kLWxpbmUvYWFwdDJcbiAgICBjb25zdCBhcmdzID0gW1xuICAgICAgJ2xpbmsnLFxuICAgICAgJy1vJywgcmVzdWx0UGF0aCxcbiAgICAgICctLW1hbmlmZXN0JywgbWFuaWZlc3QsXG4gICAgICAnLS1yZW5hbWUtbWFuaWZlc3QtcGFja2FnZScsIG1hbmlmZXN0UGFja2FnZSxcbiAgICAgICctLXJlbmFtZS1pbnN0cnVtZW50YXRpb24tdGFyZ2V0LXBhY2thZ2UnLCB0YXJnZXRQYWNrYWdlLFxuICAgICAgJy1JJywgYW5kcm9pZEphclBhdGgsXG4gICAgICAnLXYnLFxuICAgIF07XG4gICAgbG9nLmRlYnVnKGBDb21waWxpbmcgdGhlIG1hbmlmZXN0IHVzaW5nICcke3F1b3RlKFt0aGlzLmJpbmFyaWVzLmFhcHQyLCAuLi5hcmdzXSl9J2ApO1xuICAgIGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy5hYXB0MiwgYXJncyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZGVidWcoJ0Nhbm5vdCBjb21waWxlIHRoZSBtYW5pZmVzdCB1c2luZyBhYXB0Mi4gRGVmYXVsdGluZyB0byBhYXB0LiAnICtcbiAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLnN0ZGVyciB8fCBlLm1lc3NhZ2V9YCk7XG4gICAgYXdhaXQgdGhpcy5pbml0QWFwdCgpO1xuICAgIGNvbnN0IGFyZ3MgPSBbXG4gICAgICAncGFja2FnZScsXG4gICAgICAnLU0nLCBtYW5pZmVzdCxcbiAgICAgICctLXJlbmFtZS1tYW5pZmVzdC1wYWNrYWdlJywgbWFuaWZlc3RQYWNrYWdlLFxuICAgICAgJy0tcmVuYW1lLWluc3RydW1lbnRhdGlvbi10YXJnZXQtcGFja2FnZScsIHRhcmdldFBhY2thZ2UsXG4gICAgICAnLUknLCBhbmRyb2lkSmFyUGF0aCxcbiAgICAgICctRicsIHJlc3VsdFBhdGgsXG4gICAgICAnLWYnLFxuICAgIF07XG4gICAgbG9nLmRlYnVnKGBDb21waWxpbmcgdGhlIG1hbmlmZXN0IHVzaW5nICcke3F1b3RlKFt0aGlzLmJpbmFyaWVzLmFhcHQsIC4uLmFyZ3NdKX0nYCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy5hYXB0LCBhcmdzKTtcbiAgICB9IGNhdGNoIChlMSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgY29tcGlsZSB0aGUgbWFuaWZlc3QuIE9yaWdpbmFsIGVycm9yOiAke2UxLnN0ZGVyciB8fCBlMS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuICBsb2cuZGVidWcoYENvbXBpbGVkIHRoZSBtYW5pZmVzdCBhdCAnJHtyZXN1bHRQYXRofSdgKTtcbn07XG5cbi8qKlxuICogUmVwbGFjZS9pbnNlcnQgdGhlIHNwZWNpYWxseSBwcmVjb21waWxlZCBtYW5pZmVzdCBmaWxlIGludG8gdGhlXG4gKiBwYXJ0aWN1bGFyIHBhY2thZ2UuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IG1hbmlmZXN0IC0gRnVsbCBwYXRoIHRvIHRoZSBwcmVjb21waWxlZCBtYW5pZmVzdFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlZCBieSBgY29tcGlsZU1hbmlmZXN0YCBtZXRob2QgY2FsbFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aG91dCAuYXBrIGV4dGVuc2lvblxuICogQHBhcmFtIHtzdHJpbmd9IHNyY0FwayAtIEZ1bGwgcGF0aCB0byB0aGUgZXhpc3RpbmcgdmFsaWQgYXBwbGljYXRpb24gcGFja2FnZSwgd2hlcmVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzIG1hbmlmZXN0IGhhcyB0byBiZSBpbnNldHJlZCB0by4gVGhpcyBwYWNrYWdlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgd2lsbCBOT1QgYmUgbW9kaWZpZWQuXG4gKiBAcGFyYW0ge3N0cmluZ30gZHN0QXBrIC0gRnVsbCBwYXRoIHRvIHRoZSByZXN1bHRpbmcgcGFja2FnZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZmlsZSB3aWxsIGJlIG92ZXJyaWRkZW4gaWYgaXQgYWxyZWFkeSBleGlzdHMuXG4gKi9cbm1hbmlmZXN0TWV0aG9kcy5pbnNlcnRNYW5pZmVzdCA9IGFzeW5jIGZ1bmN0aW9uIGluc2VydE1hbmlmZXN0IChtYW5pZmVzdCwgc3JjQXBrLCBkc3RBcGspIHtcbiAgbG9nLmRlYnVnKGBJbnNlcnRpbmcgbWFuaWZlc3QgJyR7bWFuaWZlc3R9Jywgc3JjOiAnJHtzcmNBcGt9JywgZHN0OiAnJHtkc3RBcGt9J2ApO1xuICBhd2FpdCB6aXAuYXNzZXJ0VmFsaWRaaXAoc3JjQXBrKTtcbiAgYXdhaXQgdW56aXBGaWxlKGAke21hbmlmZXN0fS5hcGtgKTtcbiAgY29uc3QgbWFuaWZlc3ROYW1lID0gcGF0aC5iYXNlbmFtZShtYW5pZmVzdCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5pbml0QWFwdCgpO1xuICAgIGF3YWl0IGZzLmNvcHlGaWxlKHNyY0FwaywgZHN0QXBrKTtcbiAgICBsb2cuZGVidWcoJ01vdmluZyBtYW5pZmVzdCcpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjKHRoaXMuYmluYXJpZXMuYWFwdCwgW1xuICAgICAgICAncmVtb3ZlJywgZHN0QXBrLCBtYW5pZmVzdE5hbWVcbiAgICAgIF0pO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICBhd2FpdCBleGVjKHRoaXMuYmluYXJpZXMuYWFwdCwgW1xuICAgICAgJ2FkZCcsIGRzdEFwaywgbWFuaWZlc3ROYW1lXG4gICAgXSwge2N3ZDogcGF0aC5kaXJuYW1lKG1hbmlmZXN0KX0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmRlYnVnKCdDYW5ub3QgaW5zZXJ0IG1hbmlmZXN0IHVzaW5nIGFhcHQuIERlZmF1bHRpbmcgdG8gemlwLiAnICtcbiAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLnN0ZGVyciB8fCBlLm1lc3NhZ2V9YCk7XG4gICAgY29uc3QgdG1wUm9vdCA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICAgIHRyeSB7XG4gICAgICAvLyBVbmZvcnR1bmF0ZWx5IE5vZGVKUyBkb2VzIG5vdCBwcm92aWRlIGFueSByZWxpYWJsZSBtZXRob2RzXG4gICAgICAvLyB0byByZXBsYWNlIGZpbGVzIGluc2lkZSB6aXAgYXJjaGl2ZXMgd2l0aG91dCBsb2FkaW5nIHRoZVxuICAgICAgLy8gd2hvbGUgYXJjaGl2ZSBjb250ZW50IGludG8gUkFNXG4gICAgICBsb2cuZGVidWcoYEV4dHJhY3RpbmcgdGhlIHNvdXJjZSBhcGsgYXQgJyR7c3JjQXBrfSdgKTtcbiAgICAgIGF3YWl0IHppcC5leHRyYWN0QWxsVG8oc3JjQXBrLCB0bXBSb290KTtcbiAgICAgIGxvZy5kZWJ1ZygnTW92aW5nIG1hbmlmZXN0Jyk7XG4gICAgICBhd2FpdCBmcy5tdihtYW5pZmVzdCwgcGF0aC5yZXNvbHZlKHRtcFJvb3QsIG1hbmlmZXN0TmFtZSkpO1xuICAgICAgbG9nLmRlYnVnKGBDb2xsZWN0aW5nIHRoZSBkZXN0aW5hdGlvbiBhcGsgYXQgJyR7ZHN0QXBrfSdgKTtcbiAgICAgIGF3YWl0IHppcC50b0FyY2hpdmUoZHN0QXBrLCB7XG4gICAgICAgIGN3ZDogdG1wUm9vdCxcbiAgICAgIH0pO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYodG1wUm9vdCk7XG4gICAgfVxuICB9XG4gIGxvZy5kZWJ1ZyhgTWFuaWZlc3QgaW5zZXJ0aW9uIGludG8gJyR7ZHN0QXBrfScgaXMgY29tcGxldGVkYCk7XG59O1xuXG4vKipcbiAqIENoZWNrIHdoZXRoZXIgcGFja2FnZSBtYW5pZmVzdCBjb250YWlucyBJbnRlcm5ldCBwZXJtaXNzaW9ucy5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBwUGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gLmFwayhzKSBwYWNrYWdlLlxuICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgbWFuaWZlc3QgcmVxdWlyZXMgSW50ZXJuZXQgYWNjZXNzIHBlcm1pc3Npb24uXG4gKi9cbm1hbmlmZXN0TWV0aG9kcy5oYXNJbnRlcm5ldFBlcm1pc3Npb25Gcm9tTWFuaWZlc3QgPSBhc3luYyBmdW5jdGlvbiBoYXNJbnRlcm5ldFBlcm1pc3Npb25Gcm9tTWFuaWZlc3QgKGFwcFBhdGgpIHtcbiAgbG9nLmRlYnVnKGBDaGVja2luZyBpZiAnJHthcHBQYXRofScgcmVxdWlyZXMgaW50ZXJuZXQgYWNjZXNzIHBlcm1pc3Npb24gaW4gdGhlIG1hbmlmZXN0YCk7XG4gIGlmIChhcHBQYXRoLmVuZHNXaXRoKEFQS1NfRVhURU5TSU9OKSkge1xuICAgIGFwcFBhdGggPSBhd2FpdCB0aGlzLmV4dHJhY3RCYXNlQXBrKGFwcFBhdGgpO1xuICB9XG5cbiAgY29uc3QgYXBrUmVhZGVyID0gYXdhaXQgQXBrUmVhZGVyLm9wZW4oYXBwUGF0aCk7XG4gIGNvbnN0IG1hbmlmZXN0ID0gYXdhaXQgYXBrUmVhZGVyLnJlYWRNYW5pZmVzdCgpO1xuICByZXR1cm4gKG1hbmlmZXN0LnVzZXNQZXJtaXNzaW9ucyB8fCBbXSkuc29tZSgoe25hbWV9KSA9PiBuYW1lID09PSAnYW5kcm9pZC5wZXJtaXNzaW9uLklOVEVSTkVUJyk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBtYW5pZmVzdE1ldGhvZHM7XG4iXSwiZmlsZSI6ImxpYi90b29scy9hbmRyb2lkLW1hbmlmZXN0LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
