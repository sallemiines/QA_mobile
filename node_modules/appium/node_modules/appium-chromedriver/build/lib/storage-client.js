"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _utils = require("./utils");

var _lodash = _interopRequireDefault(require("lodash"));

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _request = _interopRequireDefault(require("request"));

var _xpath = _interopRequireDefault(require("xpath"));

var _xmldom = require("xmldom");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

const STORAGE_URL = 'https://chromedriver.storage.googleapis.com';
const TIMEOUT_MS = 15000;
const MAX_PARALLEL_DOWNLOADS = 5;

const log = _appiumSupport.logger.getLogger('ChromedriverStorageClient');

async function getOsInfo() {
  let name = 'linux';

  if (_appiumSupport.system.isWindows()) {
    name = 'win';
  } else if (_appiumSupport.system.isMac()) {
    name = 'mac';
  }

  return {
    name,
    arch: await _appiumSupport.system.arch()
  };
}

async function isCrcOk(src, checksum) {
  const md5 = await _appiumSupport.fs.hash(src, 'md5');
  return _lodash.default.toLower(md5) === _lodash.default.toLower(checksum);
}

function findChildNode(parent, childName = null, text = null) {
  if (!childName && !text) {
    return null;
  }

  if (!parent.hasChildNodes()) {
    return null;
  }

  for (let childNodeIdx = 0; childNodeIdx < parent.childNodes.length; childNodeIdx++) {
    const childNode = parent.childNodes[childNodeIdx];

    if (childName && !text && childName === childNode.localName) {
      return childNode;
    }

    if (text) {
      const childText = extractNodeText(childNode);

      if (!childText) {
        continue;
      }

      if (childName && childName === childNode.localName && text === childText) {
        return childNode;
      }

      if (!childName && text === childText) {
        return childNode;
      }
    }
  }

  return null;
}

function extractNodeText(node) {
  return !node || !node.firstChild || !_appiumSupport.util.hasValue(node.firstChild.nodeValue) ? null : node.firstChild.nodeValue;
}

class ChromedriverStorageClient {
  constructor(args = {}) {
    const {
      chromedriverDir = (0, _utils.getChromedriverDir)(),
      timeout = TIMEOUT_MS
    } = args;
    this.chromedriverDir = chromedriverDir;
    this.timeout = timeout;
    this.mapping = {};
  }

  parseNotes(content) {
    const result = {};
    const versionMatch = /^\s*[-]+ChromeDriver[\D]+([\d.]+)/im.exec(content);

    if (versionMatch) {
      result.version = versionMatch[1];
    }

    const minBrowserVersionMatch = /^\s*Supports Chrome[\D]+(\d+)/im.exec(content);

    if (minBrowserVersionMatch) {
      result.minBrowserVersion = minBrowserVersionMatch[1];
    }

    return result;
  }

  async retrieveAdditionalDriverInfo(driverKey, notesUrl, infoDict) {
    const response = await (0, _requestPromise.default)({
      url: notesUrl,
      method: 'GET',
      headers: {
        'user-agent': 'appium',
        accept: '*/*'
      },
      resolveWithFullResponse: true,
      timeout: this.timeout
    });
    const {
      minBrowserVersion
    } = this.parseNotes(response.body);

    if (!minBrowserVersion) {
      log.debug(`The driver '${driverKey}' does not contain valid release notes at ${notesUrl}. ` + `Skipping it`);
      return;
    }

    infoDict.minBrowserVersion = minBrowserVersion;
  }

  async parseStorageXml(doc, shouldParseNotes = true) {
    const driverNodes = _xpath.default.select(`//*[local-name(.)='Contents']`, doc);

    log.debug(`Parsed ${driverNodes.length} entries from storage XML`);

    if (_lodash.default.isEmpty(driverNodes)) {
      return;
    }

    const promises = [];

    for (const driverNode of driverNodes) {
      const key = extractNodeText(findChildNode(driverNode, 'Key'));

      if (!_lodash.default.includes(key, '/chromedriver_')) {
        continue;
      }

      log.debug(`Processing chromedriver entry '${key}'`);
      const etag = extractNodeText(findChildNode(driverNode, 'ETag'));

      if (!etag) {
        log.debug(`The entry '${key}' does not contain the checksum. Skipping it`);
        continue;
      }

      const cdInfo = {
        url: `${STORAGE_URL}/${key}`,
        etag: _lodash.default.trim(etag, '"'),
        version: _lodash.default.first(key.split('/'))
      };
      this.mapping[key] = cdInfo;
      const notesPath = `${cdInfo.version}/notes.txt`;
      const isNotesPresent = !!driverNodes.reduce((acc, node) => acc || findChildNode(node, 'Key', notesPath), false);

      if (!isNotesPresent) {
        cdInfo.minBrowserVersion = null;

        if (shouldParseNotes) {
          log.info(`The entry '${key}' does not contain any notes. Skipping it`);
        }

        continue;
      } else if (!shouldParseNotes) {
        continue;
      }

      promises.push(this.retrieveAdditionalDriverInfo(key, `${STORAGE_URL}/${notesPath}`, cdInfo));

      if (promises.length % MAX_PARALLEL_DOWNLOADS === 0) {
        await _bluebird.default.all(promises);
      }
    }

    await _bluebird.default.all(promises);
    log.info(`The total count of entries in the mapping: ${_lodash.default.size(this.mapping)}`);
  }

  async retrieveMapping(shouldParseNotes = true) {
    const response = await (0, _requestPromise.default)({
      url: STORAGE_URL,
      method: 'GET',
      headers: {
        'user-agent': 'appium',
        accept: 'application/xml, */*'
      },
      resolveWithFullResponse: true,
      timeout: this.timeout
    });
    const doc = new _xmldom.DOMParser().parseFromString(response.body);
    await this.parseStorageXml(doc, shouldParseNotes);
    return _lodash.default.cloneDeep(this.mapping);
  }

  async unzipDriver(src, dst) {
    const tmpRoot = await _appiumSupport.tempDir.openDir();

    try {
      await _appiumSupport.zip.extractAllTo(src, tmpRoot);
      const chromedriverPath = await _appiumSupport.fs.walkDir(tmpRoot, true, (itemPath, isDirectory) => !isDirectory && _lodash.default.toLower(_path.default.parse(itemPath).name) === 'chromedriver');

      if (!chromedriverPath) {
        throw new Error('The archive was unzipped properly, but we could not find any chromedriver executable');
      }

      log.debug(`Moving the extracted '${_path.default.basename(chromedriverPath)}' to '${dst}'`);
      await _appiumSupport.fs.mv(chromedriverPath, dst, {
        mkdirp: true
      });
    } finally {
      await _appiumSupport.fs.rimraf(tmpRoot);
    }
  }

  selectMatchingDrivers(osInfo, opts = {}) {
    const {
      minBrowserVersion,
      versions = []
    } = opts;

    let driversToSync = _lodash.default.keys(this.mapping);

    if (!_lodash.default.isEmpty(versions)) {
      log.debug(`Selecting chromedrivers whose versions match to ${versions}`);
      driversToSync = driversToSync.filter(x => versions.includes(`${this.mapping[x].version}`));
      log.debug(`Got ${driversToSync.length} item${driversToSync.length === 1 ? '' : 's'}`);
    }

    if (minBrowserVersion) {
      log.debug(`Selecting chromedrivers whose minimum supported browser version matches to ${minBrowserVersion}`);
      driversToSync = driversToSync.reduce((acc, x) => this.mapping[x].minBrowserVersion === `${minBrowserVersion}` ? [...acc, x] : acc, []);
      log.debug(`Got ${driversToSync.length} item${driversToSync.length === 1 ? '' : 's'}`);
    }

    let {
      name,
      arch
    } = osInfo;

    if (arch === '64' && !driversToSync.some(x => x.includes(`_${name}64`))) {
      arch = '32';
    }

    log.debug(`Selecting chromedrivers whose platform matches to ${name}${arch}`);
    driversToSync = driversToSync.filter(x => x.includes(`_${name}${arch}`));
    log.debug(`Got ${driversToSync.length} item${driversToSync.length === 1 ? '' : 's'}`);
    return driversToSync;
  }

  async retrieveDriver(index, driverKey, archivesRoot, isStrict = false) {
    const {
      url,
      etag,
      version
    } = this.mapping[driverKey];

    const archivePath = _path.default.resolve(archivesRoot, `${index}.zip`);

    log.debug(`Retrieving '${url}' to '${archivePath}'`);

    try {
      await new _bluebird.default((resolve, reject) => {
        (0, _request.default)(url).on('error', reject).on('response', res => {
          if (res.statusCode >= 400) {
            return reject(`Error downloading chromedriver at ${url}: ${res.statusCode}`);
          }
        }).pipe(_appiumSupport.fs.createWriteStream(archivePath)).on('close', resolve);
      });
    } catch (e) {
      const msg = `Cannot download chromedriver archive. Original error: ${e.message}`;

      if (isStrict) {
        throw new Error(msg);
      }

      log.error(msg);
      return false;
    }

    if (!(await isCrcOk(archivePath, etag))) {
      const msg = `The checksum for the downloaded chromedriver '${driverKey}' did not match`;

      if (isStrict) {
        throw new Error(msg);
      }

      log.error(msg);
      return false;
    }

    const fileName = `${_path.default.parse(url).name}_v${version}` + (_appiumSupport.system.isWindows() ? '.exe' : '');

    const targetPath = _path.default.resolve(this.chromedriverDir, fileName);

    try {
      await this.unzipDriver(archivePath, targetPath);
    } catch (e) {
      if (isStrict) {
        throw e;
      }

      log.error(e.message);
      return false;
    }

    return true;
  }

  async syncDrivers(opts = {}) {
    if (_lodash.default.isEmpty(this.mapping)) {
      await this.retrieveMapping(!!opts.minBrowserVersion);
    }

    if (_lodash.default.isEmpty(this.mapping)) {
      throw new Error('Cannot retrieve chromedrivers mapping from Google storage');
    }

    const driversToSync = this.selectMatchingDrivers((await getOsInfo()), opts);

    if (_lodash.default.isEmpty(driversToSync)) {
      log.debug(`There are no drivers to sync. Exiting`);
      return [];
    }

    log.debug(`Got ${driversToSync.length} driver(s) to sync: ${driversToSync}`);
    const synchronizedDrivers = [];
    const promises = [];
    const archivesRoot = await _appiumSupport.tempDir.openDir();

    try {
      for (const [idx, driverKey] of driversToSync.entries()) {
        promises.push((async () => {
          if (await this.retrieveDriver(idx, driverKey, archivesRoot, !_lodash.default.isEmpty(opts))) {
            synchronizedDrivers.push(driverKey);
          }
        })());

        if (promises.length % MAX_PARALLEL_DOWNLOADS === 0) {
          await _bluebird.default.all(promises);
        }
      }

      await _bluebird.default.all(promises);
    } finally {
      await _appiumSupport.fs.rimraf(archivesRoot);
    }

    if (!_lodash.default.isEmpty(synchronizedDrivers)) {
      log.info(`Successfully synchronized ${synchronizedDrivers.length} ` + `chromedriver${synchronizedDrivers.length === 1 ? '' : 's'}`);
    } else {
      log.info(`No chromedrivers were synchronized`);
    }

    return synchronizedDrivers;
  }

}

var _default = ChromedriverStorageClient;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zdG9yYWdlLWNsaWVudC5qcyJdLCJuYW1lcyI6WyJTVE9SQUdFX1VSTCIsIlRJTUVPVVRfTVMiLCJNQVhfUEFSQUxMRUxfRE9XTkxPQURTIiwibG9nIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwiZ2V0T3NJbmZvIiwibmFtZSIsInN5c3RlbSIsImlzV2luZG93cyIsImlzTWFjIiwiYXJjaCIsImlzQ3JjT2siLCJzcmMiLCJjaGVja3N1bSIsIm1kNSIsImZzIiwiaGFzaCIsIl8iLCJ0b0xvd2VyIiwiZmluZENoaWxkTm9kZSIsInBhcmVudCIsImNoaWxkTmFtZSIsInRleHQiLCJoYXNDaGlsZE5vZGVzIiwiY2hpbGROb2RlSWR4IiwiY2hpbGROb2RlcyIsImxlbmd0aCIsImNoaWxkTm9kZSIsImxvY2FsTmFtZSIsImNoaWxkVGV4dCIsImV4dHJhY3ROb2RlVGV4dCIsIm5vZGUiLCJmaXJzdENoaWxkIiwidXRpbCIsImhhc1ZhbHVlIiwibm9kZVZhbHVlIiwiQ2hyb21lZHJpdmVyU3RvcmFnZUNsaWVudCIsImNvbnN0cnVjdG9yIiwiYXJncyIsImNocm9tZWRyaXZlckRpciIsInRpbWVvdXQiLCJtYXBwaW5nIiwicGFyc2VOb3RlcyIsImNvbnRlbnQiLCJyZXN1bHQiLCJ2ZXJzaW9uTWF0Y2giLCJleGVjIiwidmVyc2lvbiIsIm1pbkJyb3dzZXJWZXJzaW9uTWF0Y2giLCJtaW5Ccm93c2VyVmVyc2lvbiIsInJldHJpZXZlQWRkaXRpb25hbERyaXZlckluZm8iLCJkcml2ZXJLZXkiLCJub3Rlc1VybCIsImluZm9EaWN0IiwicmVzcG9uc2UiLCJ1cmwiLCJtZXRob2QiLCJoZWFkZXJzIiwiYWNjZXB0IiwicmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2UiLCJib2R5IiwiZGVidWciLCJwYXJzZVN0b3JhZ2VYbWwiLCJkb2MiLCJzaG91bGRQYXJzZU5vdGVzIiwiZHJpdmVyTm9kZXMiLCJ4cGF0aCIsInNlbGVjdCIsImlzRW1wdHkiLCJwcm9taXNlcyIsImRyaXZlck5vZGUiLCJrZXkiLCJpbmNsdWRlcyIsImV0YWciLCJjZEluZm8iLCJ0cmltIiwiZmlyc3QiLCJzcGxpdCIsIm5vdGVzUGF0aCIsImlzTm90ZXNQcmVzZW50IiwicmVkdWNlIiwiYWNjIiwiaW5mbyIsInB1c2giLCJCIiwiYWxsIiwic2l6ZSIsInJldHJpZXZlTWFwcGluZyIsIkRPTVBhcnNlciIsInBhcnNlRnJvbVN0cmluZyIsImNsb25lRGVlcCIsInVuemlwRHJpdmVyIiwiZHN0IiwidG1wUm9vdCIsInRlbXBEaXIiLCJvcGVuRGlyIiwiemlwIiwiZXh0cmFjdEFsbFRvIiwiY2hyb21lZHJpdmVyUGF0aCIsIndhbGtEaXIiLCJpdGVtUGF0aCIsImlzRGlyZWN0b3J5IiwicGF0aCIsInBhcnNlIiwiRXJyb3IiLCJiYXNlbmFtZSIsIm12IiwibWtkaXJwIiwicmltcmFmIiwic2VsZWN0TWF0Y2hpbmdEcml2ZXJzIiwib3NJbmZvIiwib3B0cyIsInZlcnNpb25zIiwiZHJpdmVyc1RvU3luYyIsImtleXMiLCJmaWx0ZXIiLCJ4Iiwic29tZSIsInJldHJpZXZlRHJpdmVyIiwiaW5kZXgiLCJhcmNoaXZlc1Jvb3QiLCJpc1N0cmljdCIsImFyY2hpdmVQYXRoIiwicmVzb2x2ZSIsInJlamVjdCIsIm9uIiwicmVzIiwic3RhdHVzQ29kZSIsInBpcGUiLCJjcmVhdGVXcml0ZVN0cmVhbSIsImUiLCJtc2ciLCJtZXNzYWdlIiwiZXJyb3IiLCJmaWxlTmFtZSIsInRhcmdldFBhdGgiLCJzeW5jRHJpdmVycyIsInN5bmNocm9uaXplZERyaXZlcnMiLCJpZHgiLCJlbnRyaWVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLFdBQVcsR0FBRyw2Q0FBcEI7QUFDQSxNQUFNQyxVQUFVLEdBQUcsS0FBbkI7QUFDQSxNQUFNQyxzQkFBc0IsR0FBRyxDQUEvQjs7QUFFQSxNQUFNQyxHQUFHLEdBQUdDLHNC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QUFMLEVBQXFDO0FBQ25DdkksTUFBQUEsR0FBRyxDQUFDZ0YsSUFBSixDQUFVLDZCQUE0QnVELG1CQUFtQixDQUFDL0csTUFBTyxHQUF4RCxHQUNOLGVBQWMrRyxtQkFBbUIsQ0FBQy9HLE1BQXBCLEtBQStCLENBQS9CLEdBQW1DLEVBQW5DLEdBQXdDLEdBQUksRUFEN0Q7QUFFRCxLQUhELE1BR087QUFDTHhCLE1BQUFBLEdBQUcsQ0FBQ2dGLElBQUosQ0FBVSxvQ0FBVjtBQUNEOztBQUNELFdBQU91RCxtQkFBUDtBQUNEOztBQWxYNkI7O2VBcVhqQnJHLHlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2V0Q2hyb21lZHJpdmVyRGlyIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHJlcXVlc3RQcm9taXNlIGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0JztcbmltcG9ydCB4cGF0aCBmcm9tICd4cGF0aCc7XG5pbXBvcnQgeyBET01QYXJzZXIgfSBmcm9tICd4bWxkb20nO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBzeXN0ZW0sIGZzLCBsb2dnZXIsIHRlbXBEaXIsIHppcCwgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxuXG5jb25zdCBTVE9SQUdFX1VSTCA9ICdodHRwczovL2Nocm9tZWRyaXZlci5zdG9yYWdlLmdvb2dsZWFwaXMuY29tJztcbmNvbnN0IFRJTUVPVVRfTVMgPSAxNTAwMDtcbmNvbnN0IE1BWF9QQVJBTExFTF9ET1dOTE9BRFMgPSA1O1xuXG5jb25zdCBsb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKCdDaHJvbWVkcml2ZXJTdG9yYWdlQ2xpZW50Jyk7XG5cblxuYXN5bmMgZnVuY3Rpb24gZ2V0T3NJbmZvICgpIHtcbiAgbGV0IG5hbWUgPSAnbGludXgnO1xuICBpZiAoc3lzdGVtLmlzV2luZG93cygpKSB7XG4gICAgbmFtZSA9ICd3aW4nO1xuICB9IGVsc2UgaWYgKHN5c3RlbS5pc01hYygpKSB7XG4gICAgbmFtZSA9ICdtYWMnO1xuICB9XG4gIHJldHVybiB7XG4gICAgbmFtZSxcbiAgICBhcmNoOiBhd2FpdCBzeXN0ZW0uYXJjaCgpLFxuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBpc0NyY09rIChzcmMsIGNoZWNrc3VtKSB7XG4gIGNvbnN0IG1kNSA9IGF3YWl0IGZzLmhhc2goc3JjLCAnbWQ1Jyk7XG4gIHJldHVybiBfLnRvTG93ZXIobWQ1KSA9PT0gXy50b0xvd2VyKGNoZWNrc3VtKTtcbn1cblxuZnVuY3Rpb24gZmluZENoaWxkTm9kZSAocGFyZW50LCBjaGlsZE5hbWUgPSBudWxsLCB0ZXh0ID0gbnVsbCkge1xuICBpZiAoIWNoaWxkTmFtZSAmJiAhdGV4dCkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG4gIGlmICghcGFyZW50Lmhhc0NoaWxkTm9kZXMoKSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgZm9yIChsZXQgY2hpbGROb2RlSWR4ID0gMDsgY2hpbGROb2RlSWR4IDwgcGFyZW50LmNoaWxkTm9kZXMubGVuZ3RoOyBjaGlsZE5vZGVJZHgrKykge1xuICAgIGNvbnN0IGNoaWxkTm9kZSA9IHBhcmVudC5jaGlsZE5vZGVzW2NoaWxkTm9kZUlkeF07XG4gICAgaWYgKGNoaWxkTmFtZSAmJiAhdGV4dCAmJiBjaGlsZE5hbWUgPT09IGNoaWxkTm9kZS5sb2NhbE5hbWUpIHtcbiAgICAgIHJldHVybiBjaGlsZE5vZGU7XG4gICAgfVxuICAgIGlmICh0ZXh0KSB7XG4gICAgICBjb25zdCBjaGlsZFRleHQgPSBleHRyYWN0Tm9kZVRleHQoY2hpbGROb2RlKTtcbiAgICAgIGlmICghY2hpbGRUZXh0KSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKGNoaWxkTmFtZSAmJiBjaGlsZE5hbWUgPT09IGNoaWxkTm9kZS5sb2NhbE5hbWUgJiYgdGV4dCA9PT0gY2hpbGRUZXh0KSB7XG4gICAgICAgIHJldHVybiBjaGlsZE5vZGU7XG4gICAgICB9XG4gICAgICBpZiAoIWNoaWxkTmFtZSAmJiB0ZXh0ID09PSBjaGlsZFRleHQpIHtcbiAgICAgICAgcmV0dXJuIGNoaWxkTm9kZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIGV4dHJhY3ROb2RlVGV4dCAobm9kZSkge1xuICByZXR1cm4gKCFub2RlIHx8ICFub2RlLmZpcnN0Q2hpbGQgfHwgIXV0aWwuaGFzVmFsdWUobm9kZS5maXJzdENoaWxkLm5vZGVWYWx1ZSkpXG4gICAgPyBudWxsXG4gICAgOiBub2RlLmZpcnN0Q2hpbGQubm9kZVZhbHVlO1xufVxuXG5cbmNsYXNzIENocm9tZWRyaXZlclN0b3JhZ2VDbGllbnQge1xuICBjb25zdHJ1Y3RvciAoYXJncyA9IHt9KSB7XG4gICAgY29uc3Qge1xuICAgICAgY2hyb21lZHJpdmVyRGlyID0gZ2V0Q2hyb21lZHJpdmVyRGlyKCksXG4gICAgICB0aW1lb3V0ID0gVElNRU9VVF9NUyxcbiAgICB9ID0gYXJncztcbiAgICB0aGlzLmNocm9tZWRyaXZlckRpciA9IGNocm9tZWRyaXZlckRpcjtcbiAgICB0aGlzLnRpbWVvdXQgPSB0aW1lb3V0O1xuICAgIHRoaXMubWFwcGluZyA9IHt9O1xuICB9XG5cbiAgLyoqXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IEFkZGl0aW9uYWxEcml2ZXJEZXRhaWxzXG4gICAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdmVyc2lvbiAtIENocm9tZWRyaXZlciB2ZXJzaW9uXG4gICAqIG9yIGBudWxsYCBpZiBpdCBjYW5ub3QgYmUgZm91bmRcbiAgICogQHByb3BlcnR5IHs/c3RyaW5nfSBtaW5Ccm93c2VyVmVyc2lvbiAtIFRoZSBtaW5pbXVtIGJyb3dzZXIgdmVyc2lvblxuICAgKiBzdXBwb3J0ZWQgYnkgY2hyb21lZHJpdmVyIG9yIGBudWxsYCBpZiBpdCBjYW5ub3QgYmUgZm91bmRcbiAgICovXG5cbiAgLyoqXG4gICAqIEdldHMgYWRkaXRpb25hbCBjaHJvbWVkcml2ZXIgZGV0YWlscyBmcm9tIGNocm9tZWRyaXZlclxuICAgKiByZWxlYXNlIG5vdGVzXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjb250ZW50IC0gUmVsZWFzZSBub3RlcyBvZiB0aGUgY29ycmVzcG9uZGluZyBjaHJvbWVkcml2ZXJcbiAgICogQHJldHVybnMge0FkZGl0aW9uYWxEcml2ZXJEZXRhaWxzfVxuICAgKi9cbiAgcGFyc2VOb3RlcyAoY29udGVudCkge1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIGNvbnN0IHZlcnNpb25NYXRjaCA9IC9eXFxzKlstXStDaHJvbWVEcml2ZXJbXFxEXSsoW1xcZC5dKykvaW0uZXhlYyhjb250ZW50KTtcbiAgICBpZiAodmVyc2lvbk1hdGNoKSB7XG4gICAgICByZXN1bHQudmVyc2lvbiA9IHZlcnNpb25NYXRjaFsxXTtcbiAgICB9XG4gICAgY29uc3QgbWluQnJvd3NlclZlcnNpb25NYXRjaCA9IC9eXFxzKlN1cHBvcnRzIENocm9tZVtcXERdKyhcXGQrKS9pbS5leGVjKGNvbnRlbnQpO1xuICAgIGlmIChtaW5Ccm93c2VyVmVyc2lvbk1hdGNoKSB7XG4gICAgICByZXN1bHQubWluQnJvd3NlclZlcnNpb24gPSBtaW5Ccm93c2VyVmVyc2lvbk1hdGNoWzFdO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgLyoqXG4gICAqIERvd25sb2FkcyBjaHJvbWVkcml2ZXIgcmVsZWFzZSBub3RlcyBhbmQgcHV0cyB0aGVtXG4gICAqIGludG8gdGhlIGRpY3Rpb25hcnkgYXJndW1lbnRcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGRyaXZlcktleSAtIERyaXZlciB2ZXJzaW9uIHBsdXMgYXJjaGl2ZSBuYW1lXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBub3Rlc1VybCAtIFRoZSBVUkwgb2YgY2hyb21lZHJpdmVyIG5vdGVzXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBpbmZvRGljdCAtIFRoZSBkaWN0aW9uYXJ5IGNvbnRhaW5pbmcgZHJpdmVyIGluZm8uXG4gICAqIFRoZSBtZXRob2QgY2FsbCBtdXRhdGVzIGJ5IG1lcmdpbmcgYEFkZGl0aW9uYWxEcml2ZXJEZXRhaWxzYFxuICAgKiBAdGhyb3dzIHtFcnJvcn0gaWYgdGhlIHJlbGVhc2Ugbm90ZXMgY2Fubm90IGJlIGRvd25sb2FkZWRcbiAgICovXG4gIGFzeW5jIHJldHJpZXZlQWRkaXRpb25hbERyaXZlckluZm8gKGRyaXZlcktleSwgbm90ZXNVcmwsIGluZm9EaWN0KSB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0UHJvbWlzZSh7XG4gICAgICB1cmw6IG5vdGVzVXJsLFxuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ3VzZXItYWdlbnQnOiAnYXBwaXVtJyxcbiAgICAgICAgYWNjZXB0OiAnKi8qJyxcbiAgICAgIH0sXG4gICAgICByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZSxcbiAgICAgIHRpbWVvdXQ6IHRoaXMudGltZW91dCxcbiAgICB9KTtcbiAgICBjb25zdCB7IG1pbkJyb3dzZXJWZXJzaW9uIH0gPSB0aGlzLnBhcnNlTm90ZXMocmVzcG9uc2UuYm9keSk7XG4gICAgaWYgKCFtaW5Ccm93c2VyVmVyc2lvbikge1xuICAgICAgbG9nLmRlYnVnKGBUaGUgZHJpdmVyICcke2RyaXZlcktleX0nIGRvZXMgbm90IGNvbnRhaW4gdmFsaWQgcmVsZWFzZSBub3RlcyBhdCAke25vdGVzVXJsfS4gYCArXG4gICAgICAgIGBTa2lwcGluZyBpdGApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpbmZvRGljdC5taW5Ccm93c2VyVmVyc2lvbiA9IG1pbkJyb3dzZXJWZXJzaW9uO1xuICB9XG5cbiAgLyoqXG4gICAqIFBhcnNlcyBjaHJvbWVkcml2ZXIgc3RvcmFnZSBYTUwgYW5kIHN0b3Jlc1xuICAgKiB0aGUgcGFyc2VkIHJlc3VsdHMgaW50byBgdGhpcy5tYXBwaW5nYFxuICAgKlxuICAgKiBAcGFyYW0ge0RPTURvY3VtZW50fSBkb2MgLSBUaGUgRE9NIHJlcHJlc2VudGF0aW9uXG4gICAqIG9mIHRoZSBjaHJvbWVkcml2ZXIgc3RvcmFnZSBYTUxcbiAgICogQHBhcmFtIHtib29sZWFufSBzaG91bGRQYXJzZU5vdGVzIFt0cnVlXSAtIElmIHNldCB0byBgdHJ1ZWBcbiAgICogdGhlbiBhZGRpdGlvbmFsIGRyaXZlcnMgaW5mb3JtYXRpb24gaXMgZ29pbmcgdG8gYmUgcGFyc2VkXG4gICAqIGFuZCBhc3NpZ25lZCB0byBgdGhpcy5tYXBwaW5nYFxuICAgKi9cbiAgYXN5bmMgcGFyc2VTdG9yYWdlWG1sIChkb2MsIHNob3VsZFBhcnNlTm90ZXMgPSB0cnVlKSB7XG4gICAgY29uc3QgZHJpdmVyTm9kZXMgPSB4cGF0aC5zZWxlY3QoYC8vKltsb2NhbC1uYW1lKC4pPSdDb250ZW50cyddYCwgZG9jKTtcbiAgICBsb2cuZGVidWcoYFBhcnNlZCAke2RyaXZlck5vZGVzLmxlbmd0aH0gZW50cmllcyBmcm9tIHN0b3JhZ2UgWE1MYCk7XG4gICAgaWYgKF8uaXNFbXB0eShkcml2ZXJOb2RlcykpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBwcm9taXNlcyA9IFtdO1xuICAgIGZvciAoY29uc3QgZHJpdmVyTm9kZSBvZiBkcml2ZXJOb2Rlcykge1xuICAgICAgY29uc3Qga2V5ID0gZXh0cmFjdE5vZGVUZXh0KGZpbmRDaGlsZE5vZGUoZHJpdmVyTm9kZSwgJ0tleScpKTtcbiAgICAgIGlmICghXy5pbmNsdWRlcyhrZXksICcvY2hyb21lZHJpdmVyXycpKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBsb2cuZGVidWcoYFByb2Nlc3NpbmcgY2hyb21lZHJpdmVyIGVudHJ5ICcke2tleX0nYCk7XG4gICAgICBjb25zdCBldGFnID0gZXh0cmFjdE5vZGVUZXh0KGZpbmRDaGlsZE5vZGUoZHJpdmVyTm9kZSwgJ0VUYWcnKSk7XG4gICAgICBpZiAoIWV0YWcpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBUaGUgZW50cnkgJyR7a2V5fScgZG9lcyBub3QgY29udGFpbiB0aGUgY2hlY2tzdW0uIFNraXBwaW5nIGl0YCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBjZEluZm8gPSB7XG4gICAgICAgIHVybDogYCR7U1RPUkFHRV9VUkx9LyR7a2V5fWAsXG4gICAgICAgIGV0YWc6IF8udHJpbShldGFnLCAnXCInKSxcbiAgICAgICAgdmVyc2lvbjogXy5maXJzdChrZXkuc3BsaXQoJy8nKSksXG4gICAgICB9O1xuICAgICAgdGhpcy5tYXBwaW5nW2tleV0gPSBjZEluZm87XG5cbiAgICAgIGNvbnN0IG5vdGVzUGF0aCA9IGAke2NkSW5mby52ZXJzaW9ufS9ub3Rlcy50eHRgO1xuICAgICAgY29uc3QgaXNOb3Rlc1ByZXNlbnQgPSAhIWRyaXZlck5vZGVzXG4gICAgICAgIC5yZWR1Y2UoKGFjYywgbm9kZSkgPT4gYWNjIHx8IGZpbmRDaGlsZE5vZGUobm9kZSwgJ0tleScsIG5vdGVzUGF0aCksIGZhbHNlKTtcbiAgICAgIGlmICghaXNOb3Rlc1ByZXNlbnQpIHtcbiAgICAgICAgY2RJbmZvLm1pbkJyb3dzZXJWZXJzaW9uID0gbnVsbDtcbiAgICAgICAgaWYgKHNob3VsZFBhcnNlTm90ZXMpIHtcbiAgICAgICAgICBsb2cuaW5mbyhgVGhlIGVudHJ5ICcke2tleX0nIGRvZXMgbm90IGNvbnRhaW4gYW55IG5vdGVzLiBTa2lwcGluZyBpdGApO1xuICAgICAgICB9XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfSBlbHNlIGlmICghc2hvdWxkUGFyc2VOb3Rlcykge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLnJldHJpZXZlQWRkaXRpb25hbERyaXZlckluZm8oa2V5LCBgJHtTVE9SQUdFX1VSTH0vJHtub3Rlc1BhdGh9YCwgY2RJbmZvKSk7XG4gICAgICBpZiAocHJvbWlzZXMubGVuZ3RoICUgTUFYX1BBUkFMTEVMX0RPV05MT0FEUyA9PT0gMCkge1xuICAgICAgICBhd2FpdCBCLmFsbChwcm9taXNlcyk7XG4gICAgICB9XG4gICAgfVxuICAgIGF3YWl0IEIuYWxsKHByb21pc2VzKTtcbiAgICBsb2cuaW5mbyhgVGhlIHRvdGFsIGNvdW50IG9mIGVudHJpZXMgaW4gdGhlIG1hcHBpbmc6ICR7Xy5zaXplKHRoaXMubWFwcGluZyl9YCk7XG4gIH1cblxuICAvKipcbiAgICogQHR5cGVkZWYge09iamVjdH0gRHJpdmVyRGV0YWlsc1xuICAgKiBAcHJvcGVydHkge3N0cmluZ30gdXJsIC0gVGhlIGZ1bGwgdXJsIHRvIHRoZSBjb3JyZXNwb25kaW5nIGRyaXZlciBpblxuICAgKiB0aGUgcmVtb3RlIHN0b3JhZ2VcbiAgICogQHByb3BlcnR5IHtzdHJpbmd9IGV0YWcgLSBUaGUgQ1JDIG9mIHRoZSBkcml2ZXIgYXJjaGl2ZVxuICAgKiBAcHJvcGVydHkge3N0cmluZ30gdmVyc2lvbiAtIENocm9tZWRyaXZlciB2ZXJzaW9uXG4gICAqL1xuXG4gIC8qKlxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBDaHJvbWVkcml2ZXJzTWFwcGluZ1xuICAgKiBAcHJvcGVydHkge0RyaXZlckRldGFpbHN9IC0gVGhlIGtleXMgYXJlIHVuaXF1ZSBkcml2ZXIgaWRlbnRpZmllcnNcbiAgICogKHZlcnNpb24vYXJjaGl2ZSBuYW1lKS4gVGhlIGNvcnJlc3BvbmRpbmcgdmFsdWVzIGhhdmUgYERyaXZlckRldGFpbHNgXG4gICAqIGNvbnRhaW5pbmcgY2hyb21lZHJpdmVyIGRldGFpbHNcbiAgICovXG5cbiAgLyoqXG4gICAqIFJldHJpZXZlcyBjaHJvbWVkcml2ZXIgbWFwcGluZyBmcm9tIHRoZSBzdG9yYWdlXG4gICAqXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gc2hvdWxkUGFyc2VOb3RlcyBbdHJ1ZV0gLSBpZiBzZXQgdG8gYHRydWVgXG4gICAqIHRoZW4gYWRkaXRpb25hbCBjaHJvbWVkcml2ZXJzIGluZm8gaXMgZ29pbmcgdG8gYmUgcmV0cmlldmVkIGFuZFxuICAgKiBwYXJzZWQgZnJvbSByZWxlYXNlIG5vdGVzXG4gICAqIEByZXR1cm5zIHtDaHJvbWVkcml2ZXJzTWFwcGluZ31cbiAgICovXG4gIGFzeW5jIHJldHJpZXZlTWFwcGluZyAoc2hvdWxkUGFyc2VOb3RlcyA9IHRydWUpIHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3RQcm9taXNlKHtcbiAgICAgIHVybDogU1RPUkFHRV9VUkwsXG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAndXNlci1hZ2VudCc6ICdhcHBpdW0nLFxuICAgICAgICBhY2NlcHQ6ICdhcHBsaWNhdGlvbi94bWwsICovKicsXG4gICAgICB9LFxuICAgICAgcmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2U6IHRydWUsXG4gICAgICB0aW1lb3V0OiB0aGlzLnRpbWVvdXQsXG4gICAgfSk7XG4gICAgY29uc3QgZG9jID0gbmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhyZXNwb25zZS5ib2R5KTtcbiAgICBhd2FpdCB0aGlzLnBhcnNlU3RvcmFnZVhtbChkb2MsIHNob3VsZFBhcnNlTm90ZXMpO1xuICAgIHJldHVybiBfLmNsb25lRGVlcCh0aGlzLm1hcHBpbmcpO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhY3RzIGRvd25sb2FkZWQgY2hyb21lZHJpdmVyIGFyY2hpdmVcbiAgICogaW50byB0aGUgZ2l2ZW4gZGVzdGluYXRpb25cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHNyYyAtIFRoZSBzb3VyY2UgYXJjaGl2ZSBwYXRoXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBkc3QgLSBUaGUgZGVzdGluYXRpb24gY2hyb21lZHJpdmVyIHBhdGhcbiAgICovXG4gIGFzeW5jIHVuemlwRHJpdmVyIChzcmMsIGRzdCkge1xuICAgIGNvbnN0IHRtcFJvb3QgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgemlwLmV4dHJhY3RBbGxUbyhzcmMsIHRtcFJvb3QpO1xuICAgICAgY29uc3QgY2hyb21lZHJpdmVyUGF0aCA9IGF3YWl0IGZzLndhbGtEaXIodG1wUm9vdCwgdHJ1ZSwgKGl0ZW1QYXRoLCBpc0RpcmVjdG9yeSkgPT5cbiAgICAgICAgIWlzRGlyZWN0b3J5ICYmIF8udG9Mb3dlcihwYXRoLnBhcnNlKGl0ZW1QYXRoKS5uYW1lKSA9PT0gJ2Nocm9tZWRyaXZlcicpO1xuICAgICAgaWYgKCFjaHJvbWVkcml2ZXJQYXRoKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIGFyY2hpdmUgd2FzIHVuemlwcGVkIHByb3Blcmx5LCBidXQgd2UgY291bGQgbm90IGZpbmQgYW55IGNocm9tZWRyaXZlciBleGVjdXRhYmxlJyk7XG4gICAgICB9XG4gICAgICBsb2cuZGVidWcoYE1vdmluZyB0aGUgZXh0cmFjdGVkICcke3BhdGguYmFzZW5hbWUoY2hyb21lZHJpdmVyUGF0aCl9JyB0byAnJHtkc3R9J2ApO1xuICAgICAgYXdhaXQgZnMubXYoY2hyb21lZHJpdmVyUGF0aCwgZHN0LCB7XG4gICAgICAgIG1rZGlycDogdHJ1ZVxuICAgICAgfSk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGF3YWl0IGZzLnJpbXJhZih0bXBSb290KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQHR5cGVkZWYge09iamVjdH0gT1NJbmZvXG4gICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGhvc3QgT1NcbiAgICogQ2FuIGJlIGVpdGhlciBgbWFjYCwgYHdpbmRvd3NgIG9yIGBsaW51eGBcbiAgICogQHByb3BlcnR5IHtzdHJpbmd9IGFyY2ggLSBUaGUgYXJjaGl0ZWN0dXJlIG9mIHRoZSBob3N0IE9ELlxuICAgKiBDYW4gYmUgZWl0aGVyIGAzMmAgb3IgYDY0YFxuICAgKi9cblxuICAvKipcbiAgICogRmlsdGVycyBgdGhpcy5tYXBwaW5nYCB0byBvbmx5IHNlbGVjdCBtYXRjaGluZ1xuICAgKiBjaHJvbWVkcml2ZXIgZW50cmllcyBieSBvcGVyYXRpbmcgc3lzdGVtIGluZm9ybWF0aW9uXG4gICAqIGFuZC9vciBhZGRpdGlvbmFsIHN5bmNocm9uaXphdGlvbiBvcHRpb25zIChpZiBwcm92aWRlZClcbiAgICpcbiAgICogQHBhcmFtIHtPU0luZm99IG9zSW5mb1xuICAgKiBAcGFyYW0gez9TeW5jT3B0aW9uc30gb3B0c1xuICAgKiBAcmV0dXJucyB7QXJyYXk8U3RyaW5nPn0gVGhlIGxpc3Qgb2YgZmlsdGVyZWQgY2hyb21lZHJpdmVyXG4gICAqIGVudHJ5IG5hbWVzICh2ZXJzaW9uL2FyY2hpdmUgbmFtZSlcbiAgICovXG4gIHNlbGVjdE1hdGNoaW5nRHJpdmVycyAob3NJbmZvLCBvcHRzID0ge30pIHtcbiAgICBjb25zdCB7XG4gICAgICBtaW5Ccm93c2VyVmVyc2lvbixcbiAgICAgIHZlcnNpb25zID0gW10sXG4gICAgfSA9IG9wdHM7XG4gICAgbGV0IGRyaXZlcnNUb1N5bmMgPSBfLmtleXModGhpcy5tYXBwaW5nKTtcblxuICAgIGlmICghXy5pc0VtcHR5KHZlcnNpb25zKSkge1xuICAgICAgLy8gSGFuZGxlIG9ubHkgc2VsZWN0ZWQgdmVyc2lvbnMgaWYgcmVxdWVzdGVkXG4gICAgICBsb2cuZGVidWcoYFNlbGVjdGluZyBjaHJvbWVkcml2ZXJzIHdob3NlIHZlcnNpb25zIG1hdGNoIHRvICR7dmVyc2lvbnN9YCk7XG4gICAgICBkcml2ZXJzVG9TeW5jID0gZHJpdmVyc1RvU3luY1xuICAgICAgICAuZmlsdGVyKCh4KSA9PiB2ZXJzaW9ucy5pbmNsdWRlcyhgJHt0aGlzLm1hcHBpbmdbeF0udmVyc2lvbn1gKSk7XG4gICAgICBsb2cuZGVidWcoYEdvdCAke2RyaXZlcnNUb1N5bmMubGVuZ3RofSBpdGVtJHtkcml2ZXJzVG9TeW5jLmxlbmd0aCA9PT0gMSA/ICcnIDogJ3MnfWApO1xuICAgIH1cblxuICAgIGlmIChtaW5Ccm93c2VyVmVyc2lvbikge1xuICAgICAgLy8gT25seSBzZWxlY3QgZHJpdmVycywgd2hlcmUgdGhlIGdpdmVuIGJyb3dzZXIgdmVyc2lvbiBpcyBzZXQgYXMgdGhlIG1pbmltYWwgb25lXG4gICAgICBsb2cuZGVidWcoYFNlbGVjdGluZyBjaHJvbWVkcml2ZXJzIHdob3NlIG1pbmltdW0gc3VwcG9ydGVkIGJyb3dzZXIgdmVyc2lvbiBtYXRjaGVzIHRvICR7bWluQnJvd3NlclZlcnNpb259YCk7XG4gICAgICBkcml2ZXJzVG9TeW5jID0gZHJpdmVyc1RvU3luYy5yZWR1Y2UoXG4gICAgICAgIChhY2MsIHgpID0+IHRoaXMubWFwcGluZ1t4XS5taW5Ccm93c2VyVmVyc2lvbiA9PT0gYCR7bWluQnJvd3NlclZlcnNpb259YCA/IFsuLi5hY2MsIHhdIDogYWNjLCBbXSk7XG4gICAgICBsb2cuZGVidWcoYEdvdCAke2RyaXZlcnNUb1N5bmMubGVuZ3RofSBpdGVtJHtkcml2ZXJzVG9TeW5jLmxlbmd0aCA9PT0gMSA/ICcnIDogJ3MnfWApO1xuICAgIH1cblxuICAgIC8vIEZpbHRlciBvdXQgZHJpdmVyIGZvciB1bnN1cHBvcnRlZCBzeXN0ZW0gYXJjaGl0ZWN0dXJlc1xuICAgIGxldCB7bmFtZSwgYXJjaH0gPSBvc0luZm87XG4gICAgaWYgKGFyY2ggPT09ICc2NCcgJiYgIWRyaXZlcnNUb1N5bmMuc29tZSgoeCkgPT4geC5pbmNsdWRlcyhgXyR7bmFtZX02NGApKSkge1xuICAgICAgLy8gRmFsbCBiYWNrIHRvIHg4NiBidWlsZCBpZiB4NjQgb25lIGlzIG5vdCBhdmFpbGFibGUgZm9yIHRoZSBnaXZlbiBPU1xuICAgICAgYXJjaCA9ICczMic7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgU2VsZWN0aW5nIGNocm9tZWRyaXZlcnMgd2hvc2UgcGxhdGZvcm0gbWF0Y2hlcyB0byAke25hbWV9JHthcmNofWApO1xuICAgIGRyaXZlcnNUb1N5bmMgPSBkcml2ZXJzVG9TeW5jLmZpbHRlcigoeCkgPT4geC5pbmNsdWRlcyhgXyR7bmFtZX0ke2FyY2h9YCkpO1xuICAgIGxvZy5kZWJ1ZyhgR290ICR7ZHJpdmVyc1RvU3luYy5sZW5ndGh9IGl0ZW0ke2RyaXZlcnNUb1N5bmMubGVuZ3RoID09PSAxID8gJycgOiAncyd9YCk7XG5cbiAgICByZXR1cm4gZHJpdmVyc1RvU3luYztcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRyaWV2ZXMgdGhlIGdpdmVuIGNocm9tZWRyaXZlciBmcm9tIHRoZSBzdG9yYWdlXG4gICAqIGFuZCB1bnBhY2tzIGl0IGludG8gYHRoaXMuY2hyb21lZHJpdmVyRGlyYCBmb2xkZXJcbiAgICpcbiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIHVuaXF1ZSBkcml2ZXIgaW5kZXhcbiAgICogQHBhcmFtIHtzdHJpbmd9IGRyaXZlcktleSAtIFRoZSBkcml2ZXIga2V5IGluIGB0aGlzLm1hcHBpbmdgXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBhcmNoaXZlc1Jvb3QgLSBUaGUgdGVtcG9yYXJ5IGZvbGRlciBwYXRoIHRvIGV4dHJhY3RcbiAgICogZG93bmxvYWRlZCBhcmNoaXZlcyB0b1xuICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzU3RyaWN0IFt0cnVlXSAtIFdoZXRoZXIgdG8gdGhyb3cgYW4gZXJyb3IgKGB0cnVlYClcbiAgICogb3IgcmV0dXJuIGEgYm9vbGVhbiByZXN1bHQgaWYgdGhlIGRyaXZlciByZXRyaWV2YWwgcHJvY2VzcyBmYWlsc1xuICAgKiBAdGhyb3dzIHtFcnJvcn0gaWYgdGhlcmUgd2FzIGEgZmFpbHVyZSB3aGlsZSByZXRyaWV2aW5nIHRoZSBkcml2ZXJcbiAgICogYW5kIGBpc1N0cmljdGAgaXMgc2V0IHRvIGB0cnVlYFxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gaWYgYHRydWVgIHRoZW4gdGhlIGNocm9tZWRyaXZlciBpcyBzdWNjZXNzZnVsbHlcbiAgICogZG93bmxvYWRlZCBhbmQgZXh0cmFjdGVkXG4gICAqL1xuICBhc3luYyByZXRyaWV2ZURyaXZlciAoaW5kZXgsIGRyaXZlcktleSwgYXJjaGl2ZXNSb290LCBpc1N0cmljdCA9IGZhbHNlKSB7XG4gICAgY29uc3QgeyB1cmwsIGV0YWcsIHZlcnNpb24gfSA9IHRoaXMubWFwcGluZ1tkcml2ZXJLZXldO1xuICAgIGNvbnN0IGFyY2hpdmVQYXRoID0gcGF0aC5yZXNvbHZlKGFyY2hpdmVzUm9vdCwgYCR7aW5kZXh9LnppcGApO1xuICAgIGxvZy5kZWJ1ZyhgUmV0cmlldmluZyAnJHt1cmx9JyB0byAnJHthcmNoaXZlUGF0aH0nYCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgcmVxdWVzdCh1cmwpXG4gICAgICAgICAgLm9uKCdlcnJvcicsIHJlamVjdClcbiAgICAgICAgICAub24oJ3Jlc3BvbnNlJywgKHJlcykgPT4ge1xuICAgICAgICAgICAgLy8gaGFuZGxlIHJlc3BvbnNlcyB0aGF0IGZhaWwsIGxpa2UgNDA0c1xuICAgICAgICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlID49IDQwMCkge1xuICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGBFcnJvciBkb3dubG9hZGluZyBjaHJvbWVkcml2ZXIgYXQgJHt1cmx9OiAke3Jlcy5zdGF0dXNDb2RlfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgICAgLnBpcGUoZnMuY3JlYXRlV3JpdGVTdHJlYW0oYXJjaGl2ZVBhdGgpKVxuICAgICAgICAgIC5vbignY2xvc2UnLCByZXNvbHZlKTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnN0IG1zZyA9IGBDYW5ub3QgZG93bmxvYWQgY2hyb21lZHJpdmVyIGFyY2hpdmUuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gO1xuICAgICAgaWYgKGlzU3RyaWN0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihtc2cpO1xuICAgICAgfVxuICAgICAgbG9nLmVycm9yKG1zZyk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmICghYXdhaXQgaXNDcmNPayhhcmNoaXZlUGF0aCwgZXRhZykpIHtcbiAgICAgIGNvbnN0IG1zZyA9IGBUaGUgY2hlY2tzdW0gZm9yIHRoZSBkb3dubG9hZGVkIGNocm9tZWRyaXZlciAnJHtkcml2ZXJLZXl9JyBkaWQgbm90IG1hdGNoYDtcbiAgICAgIGlmIChpc1N0cmljdCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTtcbiAgICAgIH1cbiAgICAgIGxvZy5lcnJvcihtc2cpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBjb25zdCBmaWxlTmFtZSA9IGAke3BhdGgucGFyc2UodXJsKS5uYW1lfV92JHt2ZXJzaW9ufWAgK1xuICAgICAgKHN5c3RlbS5pc1dpbmRvd3MoKSA/ICcuZXhlJyA6ICcnKTtcbiAgICBjb25zdCB0YXJnZXRQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMuY2hyb21lZHJpdmVyRGlyLCBmaWxlTmFtZSk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMudW56aXBEcml2ZXIoYXJjaGl2ZVBhdGgsIHRhcmdldFBhdGgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChpc1N0cmljdCkge1xuICAgICAgICB0aHJvdyBlO1xuICAgICAgfVxuICAgICAgbG9nLmVycm9yKGUubWVzc2FnZSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IFN5bmNPcHRpb25zXG4gICAqIEBwcm9wZXJ0eSB7QXJyYXk8U3RyaW5nPn0gdmVyc2lvbnMgLSBUaGUgbGlzdCBvZiBjaHJvbWVkcml2ZXJcbiAgICogdmVyc2lvbnMgdG8gc3luYy4gSWYgZW1wdHkgKHRoZSBkZWZhdWx0IHZhbHVlKSB0aGVuIGFsbCBhdmFpbGFibGVcbiAgICogY2hyb21lZHJpdmVycyBhcmUgZ29pbmcgdG8gYmUgZG93bmxvYWRlZCBhbmQgZXh0cmFjdGVkXG4gICAqIEBwcm9wZXJ0eSB7c3RyaW5nfG51bWJlcn0gbWluQnJvd3NlclZlcnNpb24gLSBUaGUgbWludW11bSBzdXBwb3J0ZWRcbiAgICogQ2hyb21lIHZlcnNpb24gdGhhdCBkb3dubG9hZGVkIGNocm9tZWRyaXZlcnMgc2hvdWxkIHN1cHBvcnQuIENhbiBtYXRjaFxuICAgKiBtdWx0aXBsZSBkcml2ZXJzLlxuICAgKi9cblxuICAvKipcbiAgICogUmV0cmlldmVzIGNocm9tZWRyaXZlcnMgZnJvbSB0aGUgcmVtb3RlIHN0b3JhZ2VcbiAgICogdG8gdGhlIGxvY2FsIGZpbGUgc3lzdGVtXG4gICAqXG4gICAqIEBwYXJhbSB7P1N5bmNPcHRpb25zfSBvcHRzXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBpZiB0aGVyZSB3YXMgYSBwcm9ibGVtIHdoaWxlIHJldHJpZXZpbmdcbiAgICogdGhlIGRyaXZlcnNcbiAgICogQHJldHVybnMge0FycmF5PFN0cmluZ30gVGhlIGxpc3Qgb2Ygc3VjY2Vzc2Z1bGx5IHN5bmNocm9uaXplZCBkcml2ZXIga2V5c1xuICAgKi9cbiAgYXN5bmMgc3luY0RyaXZlcnMgKG9wdHMgPSB7fSkge1xuICAgIGlmIChfLmlzRW1wdHkodGhpcy5tYXBwaW5nKSkge1xuICAgICAgYXdhaXQgdGhpcy5yZXRyaWV2ZU1hcHBpbmcoISFvcHRzLm1pbkJyb3dzZXJWZXJzaW9uKTtcbiAgICB9XG4gICAgaWYgKF8uaXNFbXB0eSh0aGlzLm1hcHBpbmcpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCByZXRyaWV2ZSBjaHJvbWVkcml2ZXJzIG1hcHBpbmcgZnJvbSBHb29nbGUgc3RvcmFnZScpO1xuICAgIH1cblxuICAgIGNvbnN0IGRyaXZlcnNUb1N5bmMgPSB0aGlzLnNlbGVjdE1hdGNoaW5nRHJpdmVycyhhd2FpdCBnZXRPc0luZm8oKSwgb3B0cyk7XG4gICAgaWYgKF8uaXNFbXB0eShkcml2ZXJzVG9TeW5jKSkge1xuICAgICAgbG9nLmRlYnVnKGBUaGVyZSBhcmUgbm8gZHJpdmVycyB0byBzeW5jLiBFeGl0aW5nYCk7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgR290ICR7ZHJpdmVyc1RvU3luYy5sZW5ndGh9IGRyaXZlcihzKSB0byBzeW5jOiAke2RyaXZlcnNUb1N5bmN9YCk7XG5cbiAgICBjb25zdCBzeW5jaHJvbml6ZWREcml2ZXJzID0gW107XG4gICAgY29uc3QgcHJvbWlzZXMgPSBbXTtcbiAgICBjb25zdCBhcmNoaXZlc1Jvb3QgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgICB0cnkge1xuICAgICAgZm9yIChjb25zdCBbaWR4LCBkcml2ZXJLZXldIG9mIGRyaXZlcnNUb1N5bmMuZW50cmllcygpKSB7XG4gICAgICAgIHByb21pc2VzLnB1c2goKGFzeW5jICgpID0+IHtcbiAgICAgICAgICBpZiAoYXdhaXQgdGhpcy5yZXRyaWV2ZURyaXZlcihpZHgsIGRyaXZlcktleSwgYXJjaGl2ZXNSb290LCAhXy5pc0VtcHR5KG9wdHMpKSkge1xuICAgICAgICAgICAgc3luY2hyb25pemVkRHJpdmVycy5wdXNoKGRyaXZlcktleSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KSgpKTtcblxuICAgICAgICBpZiAocHJvbWlzZXMubGVuZ3RoICUgTUFYX1BBUkFMTEVMX0RPV05MT0FEUyA9PT0gMCkge1xuICAgICAgICAgIGF3YWl0IEIuYWxsKHByb21pc2VzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgYXdhaXQgQi5hbGwocHJvbWlzZXMpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYoYXJjaGl2ZXNSb290KTtcbiAgICB9XG4gICAgaWYgKCFfLmlzRW1wdHkoc3luY2hyb25pemVkRHJpdmVycykpIHtcbiAgICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgc3luY2hyb25pemVkICR7c3luY2hyb25pemVkRHJpdmVycy5sZW5ndGh9IGAgK1xuICAgICAgICBgY2hyb21lZHJpdmVyJHtzeW5jaHJvbml6ZWREcml2ZXJzLmxlbmd0aCA9PT0gMSA/ICcnIDogJ3MnfWApO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuaW5mbyhgTm8gY2hyb21lZHJpdmVycyB3ZXJlIHN5bmNocm9uaXplZGApO1xuICAgIH1cbiAgICByZXR1cm4gc3luY2hyb25pemVkRHJpdmVycztcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBDaHJvbWVkcml2ZXJTdG9yYWdlQ2xpZW50OyJdLCJmaWxlIjoibGliL3N0b3JhZ2UtY2xpZW50LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
