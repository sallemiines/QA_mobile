"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault.js");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _simulatorXcode = require("./simulator-xcode-6");

var _simulatorXcode2 = _interopRequireDefault(require("./simulator-xcode-7"));

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _asyncbox = require("asyncbox");

var _teen_process = require("teen_process");

var _nodeSimctl = require("node-simctl");

var _geolocation = require("./geolocation");

const STARTUP_TIMEOUT = 120 * 1000;
const SAFARI_STARTUP_TIMEOUT = 25 * 1000;
const MOBILE_SAFARI_BUNDLE_ID = 'com.apple.mobilesafari';

const PROCESS_LAUNCH_OK_PATTERN = bundleId => new RegExp(`${bundleId.replace('.', '\\.')}:\\s+\\d+`);

class SimulatorXcode8 extends _simulatorXcode2.default {
  constructor(udid, xcodeVersion) {
    super(udid, xcodeVersion);
    this.isFreshFiles = ['Library/Cookies', 'Library/Preferences/.GlobalPreferences.plist', 'Library/Preferences/com.apple.springboard.plist', 'var/run/syslog.pid'];
    this._idb = null;
  }

  set idb(value) {
    this._idb = value;
  }

  get idb() {
    return this._idb;
  }

  async killUIClient(opts = {}) {
    let {
      pid,
      signal = 2
    } = opts;
    pid = pid || (await this.getUIClientPid());

    if (!pid) {
      return false;
    }

    _logger.default.debug(`Sending ${signal} kill signal to Simulator UI client with PID ${pid}`);

    try {
      await (0, _teen_process.exec)('kill', [`-${signal}`, pid]);
      return true;
    } catch (e) {
      if (e.code === 1) {
        return false;
      }

      throw new Error(`Cannot kill the Simulator UI client. Original error: ${e.message}`);
    }
  }

  async isAppInstalled(bundleId) {
    try {
      const appContainer = await (0, _nodeSimctl.getAppContainer)(this.udid, bundleId, false);
      return appContainer.endsWith('.app');
    } catch (err) {
      try {
        const info = await (0, _nodeSimctl.appInfo)(this.udid, bundleId);
        return info.includes('ApplicationType');
      } catch (e) {
        return false;
      }
    }
  }

  get startupTimeout() {
    return STARTUP_TIMEOUT;
  }

  async waitForBoot(startupTimeout) {
    await (0, _nodeSimctl.startBootMonitor)(this.udid, {
      timeout: startupTimeout
    });
    this.emit(_simulatorXcode.BOOT_COMPLETED_EVENT);
  }

  async openUrl(url) {
    if (!(await this.isRunning())) {
      throw new Error(`Tried to open ${url}, but Simulator is not in Booted state`);
    }

    const launchTimestamp = process.hrtime();
    let lastError = null;

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        try {
          const {
            stdout
          } = await (0, _teen_process.exec)('xcrun', ['simctl', 'launch', this.udid, MOBILE_SAFARI_BUNDLE_ID]);

          if (PROCESS_LAUNCH_OK_PATTERN(MOBILE_SAFARI_BUNDLE_ID).test(stdout)) {
            await (0, _nodeSimctl.openUrl)(this.udid, url);
            return true;
          }
        } catch (err) {
          _logger.default.error(`Failed to open '${url}' in Safari. Retrying...`);

          lastError = err.stderr || err.message;
        }

        return false;
      }, {
        waitMs: SAFARI_STARTUP_TIMEOUT,
        intervalMs: 500
      });
    } catch (err) {
      _logger.default.errorAndThrow(`Safari cannot open '${url}' after ${process.hrtime(launchTimestamp)[0]} seconds ` + `because of: ${lastError || 'an unknown error'}`);
    }

    _logger.default.debug(`Safari has successfully opened '${url}' in ${process.hrtime(launchTimestamp)[0]} seconds`);
  }

  async cleanSafari(keepPrefs = true) {
    try {
      if (await this.isRunning()) {
        await (0, _nodeSimctl.terminate)(this.udid, MOBILE_SAFARI_BUNDLE_ID);
      }
    } catch (ign) {}

    await super.cleanSafari(keepPrefs);
  }

  async cleanCustomApp(appFile, appBundleId, scrub = false) {
    try {
      await (0, _nodeSimctl.terminate)(this.udid, appBundleId);
    } catch (ign) {}

    await super.cleanCustomApp(appFile, appBundleId, scrub);
  }

  async shake() {
    _logger.default.info(`Performing shake gesture on ${this.udid} Simulator`);

    await (0, _nodeSimctl.spawn)(this.udid, ['notifyutil', '-p', 'com.apple.UIKit.SimulatorShake']);
  }

  async _activateWindow() {
    if (this.idb) {
      return await this.idb.focusSimulator();
    }

    _logger.default.warn(`Cannot focus Simulator window with idb. Defaulting to AppleScript`);

    return await super._activateWindow();
  }

  async isBiometricEnrolled() {
    const output = await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "Toggle Enrolled State" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          set isChecked to (value of attribute "AXMenuItemMarkChar" of dstMenuItem) is "✓"
        end tell
      end tell
    `);

    _logger.default.debug(`Touch ID enrolled state: ${output}`);

    return _lodash.default.isString(output) && output.trim() === 'true';
  }

  async enrollBiometric(isEnabled = true) {
    await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "Toggle Enrolled State" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          set isChecked to (value of attribute "AXMenuItemMarkChar" of dstMenuItem) is "✓"
          if ${isEnabled ? 'not ' : ''}isChecked then
            click dstMenuItem
          end if
        end tell
      end tell
    `);
  }

  async sendBiometricMatch(shouldMatch = true) {
    await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "${shouldMatch ? 'Matching Touch' : 'Non-matching Touch'}" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          click dstMenuItem
        end tell
      end tell
    `);
  }

  async setGeolocation(latitude, longitude) {
    const locationSetters = [async () => await (0, _geolocation.setLocationWithLyft)(this.udid, latitude, longitude), async () => await (0, _geolocation.setLocationWithIdb)(this.idb, latitude, longitude), async () => await (0, _geolocation.setLocationWithAppleScript)(this, latitude, longitude)];
    let lastError;

    for (const setter of locationSetters) {
      try {
        await setter();
        return true;
      } catch (e) {
        _logger.default.info(e.message);

        lastError = e;
      }
    }

    throw lastError;
  }

}

var _default = SimulatorXcode8;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtOC5qcyJdLCJuYW1lcyI6WyJTVEFSVFVQX1RJTUVPVVQiLCJTQUZBUklfU1RBUlRVUF9USU1FT1VUIiwiTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQiLCJQUk9DRVNTX0xBVU5DSF9PS19QQVRURVJOIiwiYnVuZGxlSWQiLCJSZWdFeHAiLCJyZXBsYWNlIiwiU2ltdWxhdG9yWGNvZGU4IiwiU2ltdWxhdG9yWGNvZGU3IiwiY29uc3RydWN0b3IiLCJ1ZGlkIiwieGNvZGVWZXJzaW9uIiwiaXNGcmVzaEZpbGVzIiwiX2lkYiIsImlkYiIsInZhbHVlIiwia2lsbFVJQ2xpZW50Iiwib3B0cyIsInBpZCIsInNpZ25hbCIsImdldFVJQ2xpZW50UGlkIiwibG9nIiwiZGVidWciLCJlIiwiY29kZSIsIkVycm9yIiwibWVzc2FnZSIsImlzQXBwSW5zdGFsbGVkIiwiYXBwQ29udGFpbmVyIiwiZW5kc1dpdGgiLCJlcnIiLCJpbmZvIiwiaW5jbHVkZXMiLCJzdGFydHVwVGltZW91dCIsIndhaXRGb3JCb290IiwidGltZW91dCIsImVtaXQiLCJCT09UX0NPTVBMRVRFRF9FVkVOVCIsIm9wZW5VcmwiLCJ1cmwiLCJpc1J1bm5pbmciLCJsYXVuY2hUaW1lc3RhbXAiLCJwcm9jZXNzIiwiaHJ0aW1lIiwibGFzdEVycm9yIiwic3Rkb3V0IiwidGVzdCIsImVycm9yIiwic3RkZXJyIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImVycm9yQW5kVGhyb3ciLCJjbGVhblNhZmFyaSIsImtlZXBQcmVmcyIsImlnbiIsImNsZWFuQ3VzdG9tQXBwIiwiYXBwRmlsZSIsImFwcEJ1bmRsZUlkIiwic2NydWIiLCJzaGFrZSIsIl9hY3RpdmF0ZVdpbmRvdyIsImZvY3VzU2ltdWxhdG9yIiwid2FybiIsImlzQmlvbWV0cmljRW5yb2xsZWQiLCJvdXRwdXQiLCJleGVjdXRlVUlDbGllbnRTY3JpcHQiLCJfIiwiaXNTdHJpbmciLCJ0cmltIiwiZW5yb2xsQmlvbWV0cmljIiwiaXNFbmFibGVkIiwic2VuZEJpb21ldHJpY01hdGNoIiwic2hvdWxkTWF0Y2giLCJzZXRHZW9sb2NhdGlvbiIsImxhdGl0dWRlIiwibG9uZ2l0dWRlIiwibG9jYXRpb25TZXR0ZXJzIiwic2V0dGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQU1BLE1BQU1BLGVBQWUsR0FBRyxNQUFNLElBQTlCO0FBQ0EsTUFBTUMsc0JBQXNCLEdBQUcsS0FBSyxJQUFwQztBQUNBLE1BQU1DLHVCQUF1QixHQUFHLHdCQUFoQzs7QUFDQSxNQUFNQyx5QkFBeUIsR0FBSUMsUUFBRCxJQUFjLElBQUlDLE1BQUosQ0FBWSxHQUFFRCxRQUFRLENBQUNFLE9BQVQsQ0FBaUIsR0FBakIsRUFBc0IsS0FBdEIsQ0FBNkIsV0FBM0MsQ0FBaEQ7O0FBRUEsTUFBTUMsZUFBTixTQUE4QkMsd0JBQTlCLENBQThDO0FBQzVDQyxFQUFBQSxXQUFXLENBQUVDLElBQUYsRUFBUUMsWUFBUixFQUFzQjtBQUMvQixVQUFNRCxJQUFOLEVBQVlDLFlBQVo7QUFLQSxTQUFLQyxZQUFMLEdBQW9CLENBQ2xCLGlCQURrQixFQUVsQiw4Q0FGa0IsRUFHbEIsaURBSGtCLEVBSWxCLG9CQUprQixDQUFwQjtBQU1BLFNBQUtDLElBQUwsR0FBWSxJQUFaO0FBQ0Q7O0FBT0QsTUFBSUMsR0FBSixDQUFTQyxLQUFULEVBQWdCO0FBQ2QsU0FBS0YsSUFBTCxHQUFZRSxLQUFaO0FBQ0Q7O0FBS0QsTUFBSUQsR0FBSixHQUFXO0FBQ1QsV0FBTyxLQUFLRCxJQUFaO0FBQ0Q7O0FBaUJELFFBQU1HLFlBQU4sQ0FBb0JDLElBQUksR0FBRyxFQUEzQixFQUErQjtBQUM3QixRQUFJO0FBQ0ZDLE1BQUFBLEdBREU7QUFFRkMsTUFBQUEsTUFBTSxHQUFHO0FBRlAsUUFHQUYsSUFISjtBQUlBQyxJQUFBQSxHQUFHLEdBQUdBLEdBQUcsS0FBSSxNQUFNLEtBQUtFLGNBQUws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QUFaO0FBQ0EsZUFBTyxJQUFQO0FBQ0QsT0FIRCxDQUdFLE9BQU90RCxDQUFQLEVBQVU7QUFDVkYsd0JBQUlVLElBQUosQ0FBU1IsQ0FBQyxDQUFDRyxPQUFYOztBQUNBa0IsUUFBQUEsU0FBUyxHQUFHckIsQ0FBWjtBQUNEO0FBQ0Y7O0FBQ0QsVUFBTXFCLFNBQU47QUFDRDs7QUE5UjJDOztlQWlTL0JyQyxlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQk9PVF9DT01QTEVURURfRVZFTlQgfSBmcm9tICcuL3NpbXVsYXRvci14Y29kZS02JztcbmltcG9ydCBTaW11bGF0b3JYY29kZTcgZnJvbSAnLi9zaW11bGF0b3IteGNvZGUtNyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBnZXRBcHBDb250YWluZXIsIG9wZW5VcmwgYXMgc2ltY3RsT3BlblVybCwgdGVybWluYXRlLFxuICAgICAgICAgYXBwSW5mbywgc3Bhd24sIHN0YXJ0Qm9vdE1vbml0b3IgfSBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQge1xuICBzZXRMb2NhdGlvbldpdGhMeWZ0LFxuICBzZXRMb2NhdGlvbldpdGhJZGIsXG4gIHNldExvY2F0aW9uV2l0aEFwcGxlU2NyaXB0IH0gZnJvbSAnLi9nZW9sb2NhdGlvbic7XG5cbi8vIHRoZXNlIHNpbXMgYXJlIHNsb29vb29vb293XG5jb25zdCBTVEFSVFVQX1RJTUVPVVQgPSAxMjAgKiAxMDAwO1xuY29uc3QgU0FGQVJJX1NUQVJUVVBfVElNRU9VVCA9IDI1ICogMTAwMDtcbmNvbnN0IE1PQklMRV9TQUZBUklfQlVORExFX0lEID0gJ2NvbS5hcHBsZS5tb2JpbGVzYWZhcmknO1xuY29uc3QgUFJPQ0VTU19MQVVOQ0hfT0tfUEFUVEVSTiA9IChidW5kbGVJZCkgPT4gbmV3IFJlZ0V4cChgJHtidW5kbGVJZC5yZXBsYWNlKCcuJywgJ1xcXFwuJyl9OlxcXFxzK1xcXFxkK2ApO1xuXG5jbGFzcyBTaW11bGF0b3JYY29kZTggZXh0ZW5kcyBTaW11bGF0b3JYY29kZTcge1xuICBjb25zdHJ1Y3RvciAodWRpZCwgeGNvZGVWZXJzaW9uKSB7XG4gICAgc3VwZXIodWRpZCwgeGNvZGVWZXJzaW9uKTtcblxuICAgIC8vIGxpc3Qgb2YgZmlsZXMgdG8gY2hlY2sgZm9yIHdoZW4gc2VlaW5nIGlmIGEgc2ltdWxhdG9yIGlzIFwiZnJlc2hcIlxuICAgIC8vIChtZWFuaW5nIGl0IGhhcyBuZXZlciBiZWVuIGJvb3RlZCkuXG4gICAgLy8gSWYgdGhlc2UgZmlsZXMgYXJlIHByZXNlbnQsIHdlIGFzc3VtZSBpdCdzIGJlZW4gc3VjY2Vzc2Z1bGx5IGJvb3RlZFxuICAgIHRoaXMuaXNGcmVzaEZpbGVzID0gW1xuICAgICAgJ0xpYnJhcnkvQ29va2llcycsXG4gICAgICAnTGlicmFyeS9QcmVmZXJlbmNlcy8uR2xvYmFsUHJlZmVyZW5jZXMucGxpc3QnLFxuICAgICAgJ0xpYnJhcnkvUHJlZmVyZW5jZXMvY29tLmFwcGxlLnNwcmluZ2JvYXJkLnBsaXN0JyxcbiAgICAgICd2YXIvcnVuL3N5c2xvZy5waWQnXG4gICAgXTtcbiAgICB0aGlzLl9pZGIgPSBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIElEQiBpbnN0YW5jZSBzZXR0ZXJcbiAgICpcbiAgICogQHBhcmFtIHtJREJ9IHZhbHVlXG4gICAqL1xuICBzZXQgaWRiICh2YWx1ZSkge1xuICAgIHRoaXMuX2lkYiA9IHZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm4ge0lEQn0gaWRiIGluc3RhbmNlXG4gICAqL1xuICBnZXQgaWRiICgpIHtcbiAgICByZXR1cm4gdGhpcy5faWRiO1xuICB9XG5cbiAgLyoqXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IGtpbGxPcHRzXG4gICAqIEBwcm9wZXJ0eSB7P251bWJlcnxzdHJpbmd9IHBpZCAtIFByb2Nlc3MgaWQgb2YgdGhlIFVJIFNpbXVsYXRvciB3aW5kb3dcbiAgICogQHByb3BlcnR5IHtudW1iZXJ8c3RyaW5nfSBzaWduYWwgWzJdIC0gVGhlIHNpZ25hbCBudW1iZXIgdG8gc2VuZCB0byB0aGVcbiAgICogYGtpbGxgIGNvbW1hbmRcbiAgICovXG5cbiAgLyoqXG4gICAqIEtpbGwgdGhlIFVJIGNsaWVudCBpZiBpdCBpcyBydW5uaW5nLlxuICAgKlxuICAgKiBAcGFyYW0gez9raWxsT3B0c30gb3B0c1xuICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBVSSBjbGllbnQgd2FzIHN1Y2Nlc3NmdWxseSBraWxsZWQgb3IgZmFsc2VcbiAgICogICAgICAgICAgICAgICAgICAgaWYgaXQgaXMgbm90IHJ1bm5pbmcuXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzZW5kaW5nIHRoZSBzaWduYWwgdG8gdGhlIGNsaWVudCBwcm9jZXNzIGZhaWxzXG4gICAqL1xuICBhc3luYyBraWxsVUlDbGllbnQgKG9wdHMgPSB7fSkge1xuICAgIGxldCB7XG4gICAgICBwaWQsXG4gICAgICBzaWduYWwgPSAyLFxuICAgIH0gPSBvcHRzO1xuICAgIHBpZCA9IHBpZCB8fCBhd2FpdCB0aGlzLmdldFVJQ2xpZW50UGlkKCk7XG4gICAgaWYgKCFwaWQpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYFNlbmRpbmcgJHtzaWduYWx9IGtpbGwgc2lnbmFsIHRvIFNpbXVsYXRvciBVSSBjbGllbnQgd2l0aCBQSUQgJHtwaWR9YCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4ZWMoJ2tpbGwnLCBbYC0ke3NpZ25hbH1gLCBwaWRdKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlLmNvZGUgPT09IDEpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3Qga2lsbCB0aGUgU2ltdWxhdG9yIFVJIGNsaWVudC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZnkgd2hldGhlciB0aGUgcGFydGljdWxhciBhcHBsaWNhdGlvbiBpcyBpbnN0YWxsZWQgb24gU2ltdWxhdG9yLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGJ1bmRsZUlkIC0gVGhlIGJ1bmRsZSBpZCBvZiB0aGUgYXBwbGljYXRpb24gdG8gYmUgY2hlY2tlZC5cbiAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZ2l2ZW4gYXBwbGljYXRpb24gaXMgaW5zdGFsbGVkLlxuICAgKi9cbiAgYXN5bmMgaXNBcHBJbnN0YWxsZWQgKGJ1bmRsZUlkKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGFwcENvbnRhaW5lciA9IGF3YWl0IGdldEFwcENvbnRhaW5lcih0aGlzLnVkaWQsIGJ1bmRsZUlkLCBmYWxzZSk7XG4gICAgICByZXR1cm4gYXBwQ29udGFpbmVyLmVuZHNXaXRoKCcuYXBwJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBnZXRfYXBwX2NvbnRhaW5lciBzdWJjb21tYW5kIGZhaWxzIGZvciBzeXN0ZW0gYXBwbGljYXRpb25zLFxuICAgICAgLy8gc28gd2UgdHJ5IHRoZSBoaWRkZW4gYXBwaW5mbyBzdWJjb21tYW5kLCB3aGljaCBwcmludHMgY29ycmVjdCBpbmZvIGZvclxuICAgICAgLy8gc3lzdGVtL2hpZGRlbiBhcHBzXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBpbmZvID0gYXdhaXQgYXBwSW5mbyh0aGlzLnVkaWQsIGJ1bmRsZUlkKTtcbiAgICAgICAgcmV0dXJuIGluZm8uaW5jbHVkZXMoJ0FwcGxpY2F0aW9uVHlwZScpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm4ge251bWJlcn0gVGhlIG1heCBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdW50aWwgU2ltdWxhdG9yIGJvb3RpbmcgaXMgY29tcGxldGVkLlxuICAgKi9cbiAgZ2V0IHN0YXJ0dXBUaW1lb3V0ICgpIHtcbiAgICByZXR1cm4gU1RBUlRVUF9USU1FT1VUO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmeSB3aGV0aGVyIHRoZSBTaW11bGF0b3IgYm9vdGluZyBpcyBjb21wbGV0ZWQgYW5kL29yIHdhaXQgZm9yIGl0XG4gICAqIHVudGlsIHRoZSB0aW1lb3V0IGV4cGlyZXMuXG4gICAqIEBvdmVycmlkZVxuICAgKlxuICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnR1cFRpbWVvdXQgLSB0aGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0IHVudGlsIGJvb3RpbmcgaXMgY29tcGxldGVkLlxuICAgKiBAZW1pdHMgQk9PVF9DT01QTEVURURfRVZFTlQgaWYgdGhlIGN1cnJlbnQgU2ltdWxhdG9yIGlzIHJlYWR5IHRvIGFjY2VwdCBzaW1jdGwgY29tbWFuZHMsIGxpa2UgJ2luc3RhbGwnLlxuICAgKi9cbiAgYXN5bmMgd2FpdEZvckJvb3QgKHN0YXJ0dXBUaW1lb3V0KSB7XG4gICAgYXdhaXQgc3RhcnRCb290TW9uaXRvcih0aGlzLnVkaWQsIHt0aW1lb3V0OiBzdGFydHVwVGltZW91dH0pO1xuICAgIHRoaXMuZW1pdChCT09UX0NPTVBMRVRFRF9FVkVOVCk7XG4gIH1cblxuICAvKipcbiAgICogT3BlbiB0aGUgZ2l2ZW4gVVJMIGluIG1vYmlsZSBTYWZhcmkgYnJvd3Nlci5cbiAgICogVGhlIGJyb3dzZXIgd2lsbCBiZSBzdGFydGVkIGF1dG9tYXRpY2FsbHkgaWYgaXQgaXMgbm90IHJ1bm5pbmcuXG4gICAqIEBvdmVycmlkZVxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVGhlIFVSTCB0byBiZSBvcGVuZWQuXG4gICAqL1xuICBhc3luYyBvcGVuVXJsICh1cmwpIHtcbiAgICBpZiAoIWF3YWl0IHRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVHJpZWQgdG8gb3BlbiAke3VybH0sIGJ1dCBTaW11bGF0b3IgaXMgbm90IGluIEJvb3RlZCBzdGF0ZWApO1xuICAgIH1cbiAgICBjb25zdCBsYXVuY2hUaW1lc3RhbXAgPSBwcm9jZXNzLmhydGltZSgpO1xuICAgIGxldCBsYXN0RXJyb3IgPSBudWxsO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAvLyBUaGlzIGlzIHRvIG1ha2Ugc3VyZSBTYWZhcmkgaXMgYWxyZWFkeSBydW5uaW5nXG4gICAgICAgICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKCd4Y3J1bicsIFsnc2ltY3RsJywgJ2xhdW5jaCcsIHRoaXMudWRpZCwgTU9CSUxFX1NBRkFSSV9CVU5ETEVfSURdKTtcbiAgICAgICAgICBpZiAoUFJPQ0VTU19MQVVOQ0hfT0tfUEFUVEVSTihNT0JJTEVfU0FGQVJJX0JVTkRMRV9JRCkudGVzdChzdGRvdXQpKSB7XG4gICAgICAgICAgICBhd2FpdCBzaW1jdGxPcGVuVXJsKHRoaXMudWRpZCwgdXJsKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbG9nLmVycm9yKGBGYWlsZWQgdG8gb3BlbiAnJHt1cmx9JyBpbiBTYWZhcmkuIFJldHJ5aW5nLi4uYCk7XG4gICAgICAgICAgbGFzdEVycm9yID0gZXJyLnN0ZGVyciB8fCBlcnIubWVzc2FnZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9LCB7d2FpdE1zOiBTQUZBUklfU1RBUlRVUF9USU1FT1VULCBpbnRlcnZhbE1zOiA1MDB9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBTYWZhcmkgY2Fubm90IG9wZW4gJyR7dXJsfScgYWZ0ZXIgJHtwcm9jZXNzLmhydGltZShsYXVuY2hUaW1lc3RhbXApWzBdfSBzZWNvbmRzIGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgYGJlY2F1c2Ugb2Y6ICR7bGFzdEVycm9yIHx8ICdhbiB1bmtub3duIGVycm9yJ31gKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBTYWZhcmkgaGFzIHN1Y2Nlc3NmdWxseSBvcGVuZWQgJyR7dXJsfScgaW4gJHtwcm9jZXNzLmhydGltZShsYXVuY2hUaW1lc3RhbXApWzBdfSBzZWNvbmRzYCk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW4gdXAgdGhlIGRpcmVjdG9yaWVzIGZvciBtb2JpbGUgU2FmYXJpLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHtib29sZWFufSBrZWVwUHJlZnMgLSBXaGV0aGVyIHRvIGtlZXAgU2FmYXJpIHByZWZlcmVuY2VzIGZyb20gYmVpbmcgZGVsZXRlZC5cbiAgICovXG4gIGFzeW5jIGNsZWFuU2FmYXJpIChrZWVwUHJlZnMgPSB0cnVlKSB7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChhd2FpdCB0aGlzLmlzUnVubmluZygpKSB7XG4gICAgICAgIGF3YWl0IHRlcm1pbmF0ZSh0aGlzLnVkaWQsIE1PQklMRV9TQUZBUklfQlVORExFX0lEKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgIC8vIGlnbm9yZSBlcnJvclxuICAgIH1cbiAgICBhd2FpdCBzdXBlci5jbGVhblNhZmFyaShrZWVwUHJlZnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFuL3NjcnViIHRoZSBwYXJ0aWN1bGFyIGFwcGxpY2F0aW9uIG9uIFNpbXVsYXRvci5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBhcHBGaWxlIC0gQXBwbGljYXRpb24gbmFtZSBtaW51cyBcIi5hcHBcIi5cbiAgICogQHBhcmFtIHtzdHJpbmd9IGFwcEJ1bmRsZUlkIC0gQnVuZGxlIGlkZW50aWZpZXIgb2YgdGhlIGFwcGxpY2F0aW9uLlxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IHNjcnViIC0gSWYgYHNjcnViYCBpcyBmYWxzZSwgd2Ugd2FudCB0byBjbGVhbiBieSBkZWxldGluZyB0aGUgYXBwIGFuZCBhbGxcbiAgICogICBmaWxlcyBhc3NvY2lhdGVkIHdpdGggaXQuIElmIGBzY3J1YmAgaXMgdHJ1ZSwgd2UganVzdCB3YW50IHRvIGRlbGV0ZSB0aGUgcHJlZmVyZW5jZXMgYW5kXG4gICAqICAgY2hhbmdlZCBmaWxlcy5cbiAgICovXG4gIGFzeW5jIGNsZWFuQ3VzdG9tQXBwIChhcHBGaWxlLCBhcHBCdW5kbGVJZCwgc2NydWIgPSBmYWxzZSkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0ZXJtaW5hdGUodGhpcy51ZGlkLCBhcHBCdW5kbGVJZCk7XG4gICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAvLyBpZ25vcmUgZXJyb3JcbiAgICB9XG4gICAgYXdhaXQgc3VwZXIuY2xlYW5DdXN0b21BcHAoYXBwRmlsZSwgYXBwQnVuZGxlSWQsIHNjcnViKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJmb3JtIFNoYWtlIGdlc3R1cmUgb24gU2ltdWxhdG9yIHdpbmRvdy5cbiAgICovXG4gIGFzeW5jIHNoYWtlICgpIHtcbiAgICBsb2cuaW5mbyhgUGVyZm9ybWluZyBzaGFrZSBnZXN0dXJlIG9uICR7dGhpcy51ZGlkfSBTaW11bGF0b3JgKTtcbiAgICBhd2FpdCBzcGF3bih0aGlzLnVkaWQsIFtcbiAgICAgICdub3RpZnl1dGlsJyxcbiAgICAgICctcCcsICdjb20uYXBwbGUuVUlLaXQuU2ltdWxhdG9yU2hha2UnXG4gICAgXSk7XG4gIH1cblxuICAvKipcbiAgICogQGluaGVyaXRkb2NcbiAgICogQG92ZXJyaWRlXG4gICAqIEBwcml2YXRlXG4gICAqL1xuICBhc3luYyBfYWN0aXZhdGVXaW5kb3cgKCkge1xuICAgIGlmICh0aGlzLmlkYikge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuaWRiLmZvY3VzU2ltdWxhdG9yKCk7XG4gICAgfVxuICAgIGxvZy53YXJuKGBDYW5ub3QgZm9jdXMgU2ltdWxhdG9yIHdpbmRvdyB3aXRoIGlkYi4gRGVmYXVsdGluZyB0byBBcHBsZVNjcmlwdGApO1xuICAgIHJldHVybiBhd2FpdCBzdXBlci5fYWN0aXZhdGVXaW5kb3coKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKiBAb3ZlcnJpZGVcbiAgICovXG4gIGFzeW5jIGlzQmlvbWV0cmljRW5yb2xsZWQgKCkge1xuICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IHRoaXMuZXhlY3V0ZVVJQ2xpZW50U2NyaXB0KGBcbiAgICAgIHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCJcbiAgICAgICAgdGVsbCBwcm9jZXNzIFwiU2ltdWxhdG9yXCJcbiAgICAgICAgICBzZXQgZHN0TWVudUl0ZW0gdG8gbWVudSBpdGVtIFwiVG9nZ2xlIEVucm9sbGVkIFN0YXRlXCIgb2YgbWVudSAxIG9mIG1lbnUgaXRlbSBcIlRvdWNoIElEXCIgb2YgbWVudSAxIG9mIG1lbnUgYmFyIGl0ZW0gXCJIYXJkd2FyZVwiIG9mIG1lbnUgYmFyIDFcbiAgICAgICAgICBzZXQgaXNDaGVja2VkIHRvICh2YWx1ZSBvZiBhdHRyaWJ1dGUgXCJBWE1lbnVJdGVtTWFya0NoYXJcIiBvZiBkc3RNZW51SXRlbSkgaXMgXCLinJNcIlxuICAgICAgICBlbmQgdGVsbFxuICAgICAgZW5kIHRlbGxcbiAgICBgKTtcbiAgICBsb2cuZGVidWcoYFRvdWNoIElEIGVucm9sbGVkIHN0YXRlOiAke291dHB1dH1gKTtcbiAgICByZXR1cm4gXy5pc1N0cmluZyhvdXRwdXQpICYmIG91dHB1dC50cmltKCkgPT09ICd0cnVlJztcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKiBAb3ZlcnJpZGVcbiAgICovXG4gIGFzeW5jIGVucm9sbEJpb21ldHJpYyAoaXNFbmFibGVkID0gdHJ1ZSkge1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZVVJQ2xpZW50U2NyaXB0KGBcbiAgICAgIHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCJcbiAgICAgICAgdGVsbCBwcm9jZXNzIFwiU2ltdWxhdG9yXCJcbiAgICAgICAgICBzZXQgZHN0TWVudUl0ZW0gdG8gbWVudSBpdGVtIFwiVG9nZ2xlIEVucm9sbGVkIFN0YXRlXCIgb2YgbWVudSAxIG9mIG1lbnUgaXRlbSBcIlRvdWNoIElEXCIgb2YgbWVudSAxIG9mIG1lbnUgYmFyIGl0ZW0gXCJIYXJkd2FyZVwiIG9mIG1lbnUgYmFyIDFcbiAgICAgICAgICBzZXQgaXNDaGVja2VkIHRvICh2YWx1ZSBvZiBhdHRyaWJ1dGUgXCJBWE1lbnVJdGVtTWFya0NoYXJcIiBvZiBkc3RNZW51SXRlbSkgaXMgXCLinJNcIlxuICAgICAgICAgIGlmICR7aXNFbmFibGVkID8gJ25vdCAnIDogJyd9aXNDaGVja2VkIHRoZW5cbiAgICAgICAgICAgIGNsaWNrIGRzdE1lbnVJdGVtXG4gICAgICAgICAgZW5kIGlmXG4gICAgICAgIGVuZCB0ZWxsXG4gICAgICBlbmQgdGVsbFxuICAgIGApO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgc2VuZEJpb21ldHJpY01hdGNoIChzaG91bGRNYXRjaCA9IHRydWUpIHtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVVSUNsaWVudFNjcmlwdChgXG4gICAgICB0ZWxsIGFwcGxpY2F0aW9uIFwiU3lzdGVtIEV2ZW50c1wiXG4gICAgICAgIHRlbGwgcHJvY2VzcyBcIlNpbXVsYXRvclwiXG4gICAgICAgICAgc2V0IGRzdE1lbnVJdGVtIHRvIG1lbnUgaXRlbSBcIiR7c2hvdWxkTWF0Y2ggPyAnTWF0Y2hpbmcgVG91Y2gnIDogJ05vbi1tYXRjaGluZyBUb3VjaCd9XCIgb2YgbWVudSAxIG9mIG1lbnUgaXRlbSBcIlRvdWNoIElEXCIgb2YgbWVudSAxIG9mIG1lbnUgYmFyIGl0ZW0gXCJIYXJkd2FyZVwiIG9mIG1lbnUgYmFyIDFcbiAgICAgICAgICBjbGljayBkc3RNZW51SXRlbVxuICAgICAgICBlbmQgdGVsbFxuICAgICAgZW5kIHRlbGxcbiAgICBgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgY3VzdG9tIGdlb2xvY2F0aW9uIHBhcmFtZXRlcnMgZm9yIHRoZSBnaXZlbiBTaW11bGF0b3IgdXNpbmcgQXBwbGVTY3JpcHQuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gbGF0aXR1ZGUgLSBUaGUgbGF0aXR1ZGUgdmFsdWUsIHdoaWNoIGlzIGdvaW5nIHRvIGJlIGVudGVyZWRcbiAgICogICBpbnRvIHRoZSBjb3JyZXNwb25kaW5nIGVkaXQgZmllbGQsIGZvciBleGFtcGxlICczOSwwMDA2Jy5cbiAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBsb25naXR1ZGUgLSBUaGUgbG9uZ2l0dWRlIHZhbHVlLCB3aGljaCBpcyBnb2luZyB0byBiZSBlbnRlcmVkXG4gICAqICAgaW50byB0aGUgY29ycmVzcG9uZGluZyBlZGl0IGZpZWxkLCBmb3IgZXhhbXBsZSAnMTksMDA2OCcuXG4gICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIHRoZSBnaXZlbiBwYXJhbWV0ZXJzIGhhdmUgY29ycmVjdCBmb3JtYXQgYW5kIHdlcmUgc3VjY2Vzc2Z1bGx5IGFjY2VwdGVkLlxuICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIHNldHRpbmcgdGhlIGxvY2F0aW9uXG4gICAqL1xuICBhc3luYyBzZXRHZW9sb2NhdGlvbiAobGF0aXR1ZGUsIGxvbmdpdHVkZSkge1xuICAgIGNvbnN0IGxvY2F0aW9uU2V0dGVycyA9IFtcbiAgICAgIGFzeW5jICgpID0+IGF3YWl0IHNldExvY2F0aW9uV2l0aEx5ZnQodGhpcy51ZGlkLCBsYXRpdHVkZSwgbG9uZ2l0dWRlKSxcbiAgICAgIGFzeW5jICgpID0+IGF3YWl0IHNldExvY2F0aW9uV2l0aElkYih0aGlzLmlkYiwgbGF0aXR1ZGUsIGxvbmdpdHVkZSksXG4gICAgICBhc3luYyAoKSA9PiBhd2FpdCBzZXRMb2NhdGlvbldpdGhBcHBsZVNjcmlwdCh0aGlzLCBsYXRpdHVkZSwgbG9uZ2l0dWRlKVxuICAgIF07XG5cbiAgICBsZXQgbGFzdEVycm9yO1xuICAgIGZvciAoY29uc3Qgc2V0dGVyIG9mIGxvY2F0aW9uU2V0dGVycykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgc2V0dGVyKCk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cuaW5mbyhlLm1lc3NhZ2UpO1xuICAgICAgICBsYXN0RXJyb3IgPSBlO1xuICAgICAgfVxuICAgIH1cbiAgICB0aHJvdyBsYXN0RXJyb3I7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgU2ltdWxhdG9yWGNvZGU4O1xuIl0sImZpbGUiOiJsaWIvc2ltdWxhdG9yLXhjb2RlLTguanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
