"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault.js");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.update = update;
exports.updateSettings = updateSettings;
exports.updateLocationSettings = updateLocationSettings;
exports.setReduceMotion = setReduceMotion;
exports.setDarkMode = setDarkMode;
exports.updateSafariUserSettings = updateSafariUserSettings;
exports.updateSafariGlobalSettings = updateSafariGlobalSettings;
exports.updateLocale = updateLocale;
exports.read = read;
exports.readSettings = readSettings;
exports.stub = stub;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _logger = _interopRequireDefault(require("./logger"));

var _semver = _interopRequireDefault(require("semver"));

var _bluebird = _interopRequireDefault(require("bluebird"));

async function plistPaths(sim, identifier) {
  let paths = [];
  let simDirectory = sim.getDir();

  switch (identifier) {
    case 'webInspector':
      paths.push(_path.default.resolve(simDirectory, 'Library', 'Preferences', 'com.apple.webInspector.plist'));
      break;

    case 'mobileSafari':
      paths.push(_path.default.resolve((await sim.getAppDir('com.apple.mobilesafari')), 'Library', 'Preferences', 'com.apple.mobilesafari.plist'));
      break;

    case 'globalMobileSafari':
      paths.push(_path.default.resolve(simDirectory, 'Library', 'Preferences', 'com.apple.mobilesafari.plist'));
      break;

    case 'webUI':
      paths.push(_path.default.resolve(simDirectory, 'Library', 'Preferences', 'com.apple.WebUI.plist'));
      break;

    case 'webFoundation':
      paths.push(_path.default.resolve(simDirectory, 'Library', 'Preferences', 'com.apple.WebFoundation.plist'));
      break;

    case 'preferences':
      paths.push(_path.default.resolve(simDirectory, 'Library', 'Preferences', 'com.apple.Preferences.plist'));
      break;

    case 'locationServices':
      paths.push(_path.default.resolve(simDirectory, 'Library', 'Preferences', 'com.apple.locationd.plist'));
      break;

    case 'locationClients':
      paths.push(_path.default.resolve(simDirectory, 'Library', 'Caches', 'locationd', 'clients.plist'));
      break;

    case 'locationCache':
      paths.push(_path.default.resolve(simDirectory, 'Library', 'Caches', 'locationd', 'cache.plist'));
      paths.push(_path.default.resolve(simDirectory, 'Library', 'Preferences', 'com.apple.locationd.plist'));
      break;

    case 'userSettings':
      if (_semver.default.lt(_semver.default.coerce(sim.xcodeVersion.versionString), _semver.default.coerce('7.3'))) {
        paths.push(_path.default.resolve(simDirectory, 'Library', 'ConfigurationProfiles', 'UserSettings.plist'));
        paths.push(_path.default.resolve(simDirectory, 'Library', 'ConfigurationProfiles', 'EffectiveUserSettings.plist'));
        paths.push(_path.default.resolve(simDirectory, 'Library', 'ConfigurationProfiles', 'PublicInfo', 'PublicEffectiveUserSettings.plist'));
      } else {
        paths.push(_path.default.resolve(simDirectory, 'Library', 'UserConfigurationProfiles', 'UserSettings.plist'));
        paths.push(_path.default.resolve(simDirectory, 'Library', 'UserConfigurationProfiles', 'EffectiveUserSettings.plist'));
        paths.push(_path.default.resolve(simDirectory, 'Library', 'UserConfigurationProfiles', 'PublicInfo', 'PublicEffectiveUserSettings.plist'));
      }

      break;

    case 'effectiveUserSettings':
      paths.push(_path.default.resolve(simDirectory, 'Library', 'ConfigurationProfiles', 'EffectiveUserSettings.plist'));
      paths.push(_path.default.resolve(simDirectory, 'Library', 'ConfigurationProfiles', 'PublicInfo', 'PublicEffectiveUserSettings.plist'));
      break;

    case 'accessibilitySettings':
      paths.push(_path.default.resolve(simDirectory, 'Library', 'Preferences', 'com.apple.Accessibility.plist'));
      break;

    case 'uiStyleSettings':
      paths.push(_path.default.resolve(simDirectory, 'Library', 'Preferences', 'com.apple.uikitservices.userInterfaceStyleMode.plist'));
      break;
  }

  return paths;
}

async function updateSettings(sim, plist, updates) {
  return await _bluebird.default.reduce((await plistPaths(sim, plist)), async function reducer(updated, path) {
    return (await update(path, updates)) || updated;
  }, false);
}

async function update(pathToPlist, updates) {
  const currentSettings = await read(pathToPlist);
  const newSettings = Object.assign({}, currentSettings, updates);

  if (_lodash.default.isEqual(currentSettings, newSettings)) {
    return false;
  }

  await _appiumSupport.plist.updatePlistFile(pathToPlist, newSettings, true, false);
  return true;
}

async function readSettings(sim, plist) {
  let settings = {};

  for (let path of await plistPaths(sim, plist)) {
    settings[path] = await read(path);
  }

  return settings;
}

async function read(pathToPlist) {
  return await _appiumSupport.plist.parsePlistFile(pathToPlist, false);
}

async function updateLocationSettings(sim, bundleId, authorized) {
  const newCachePrefs = {
    LastFenceActivityTimestamp: 412122103.232983,
    CleanShutdown: true
  };
  let updated = await updateSettings(sim, 'locationCache', {
    [bundleId]: newCachePrefs
  });
  const newClientPrefs = {
    BundleId: bundleId,
    Authorized: !!authorized,
    Whitelisted: false
  };

  for (const file of await plistPaths(sim, 'locationClients')) {
    _logger.default.debug(`Updating location client file: ${file}`);

    let updates = {};
    const plist = await read(file);
    const weirdLocKey = 'com.apple.locationd.bundle-/System/Library/' + 'PrivateFrameworks/AOSNotification.framework';

    if (!_lodash.default.has(plist, weirdLocKey)) {
      updates[weirdLocKey] = {
        BundlePath: '/System/Library/PrivateFrameworks/AOSNotification.framework',
        Whitelisted: false,
        Executable: '',
        Registered: ''
      };
    }

    const baseSetting = _lodash.default.has(plist, bundleId) ? plist[bundleId] : {};
    updates[bundleId] = _lodash.default.defaults(newClientPrefs, baseSetting);
    updates[bundleId].Executable = updates[bundleId].Executable || '';
    updates[bundleId].Registered = updates[bundleId].Registered || '';
    updated = (await update(file, updates)) || updated;
  }

  return updated;
}

async function setReduceMotion(sim, reduceMotion = true) {
  _logger.default.debug(`Updating reduce motion. Setting to ${reduceMotion}.`);

  const paths = await plistPaths(sim, 'accessibilitySettings');

  for (const file of paths) {
    await update(file, {
      ReduceMotionEnabled: reduceMotion ? 1 : 0
    });
  }
}

async function setDarkMode(sim, isEnabled = true) {
  _logger.default.debug(`Setting dark mode ${isEnabled ? 'on' : 'off'}`);

  const paths = await plistPaths(sim, 'uiStyleSettings');

  for (const file of paths) {
    await update(file, {
      UserInterfaceStyleMode: isEnabled ? 2 : 1
    });
  }
}

async function updateSafariGlobalSettings(sim, settingSet) {
  _logger.default.debug('Updating Safari global settings');

  let updated = false;

  for (const [file, safariSettingSet] of _lodash.default.toPairs((await readSettings(sim, 'globalMobileSafari')))) {
    let newSettings = {};

    for (const [key, value] of _lodash.default.toPairs(settingSet)) {
      if (safariSettingSet[key] !== value) {
        newSettings[key] = value;
      }
    }

    if (_lodash.default.isEmpty(newSettings)) {
      continue;
    }

    updated = (await update(file, newSettings)) || updated;
  }

  return updated;
}

async function updateSafariUserSettings(sim, settingSet) {
  _logger.default.debug('Updating Safari user settings');

  let newUserSettings = {};

  if (_lodash.default.has(settingSet, 'WebKitJavaScriptEnabled')) {
    newUserSettings.safariAllowJavaScript = settingSet.WebKitJavaScriptEnabled;
  }

  if (_lodash.default.has(settingSet, 'WebKitJavaScriptCanOpenWindowsAutomatically')) {
    newUserSettings.safariAllowPopups = settingSet.WebKitJavaScriptCanOpenWindowsAutomatically;
  }

  if (_lodash.default.has(settingSet, 'WarnAboutFraudulentWebsites')) {
    newUserSettings.safariForceFraudWarning = !settingSet.WarnAboutFraudulentWebsites;
  }

  if (_lodash.default.isEmpty(newUserSettings)) {
    return false;
  }

  let updated = false;

  for (const [file, userSettingSet] of _lodash.default.toPairs((await readSettings(sim, 'userSettings')))) {
    if (!_lodash.default.has(userSettingSet, 'restrictedBool')) {
      userSettingSet.restrictedBool = {};
    }

    for (let [key, value] of _lodash.default.toPairs(newUserSettings)) {
      userSettingSet.restrictedBool[key] = {
        value
      };
    }

    updated = (await update(file, userSettingSet)) || updated;
  }

  return updated;
}

async function updateLocale(sim, language, locale, calendarFormat) {
  let globalPrefs = _path.default.resolve(sim.getDir(), 'Library', 'Preferences', '.GlobalPreferences.plist');

  let data = await read(globalPrefs);
  let updates = {};

  if (language) {
    _logger.default.debug(`New language: ${language}`);

    let supportedLangs = data.AppleLanguages || [];

    if (supportedLangs.indexOf(language) !== 0) {
      updates.AppleLanguages = [language].concat(_lodash.default.without(supportedLangs, language));
    }
  }

  if (locale || calendarFormat) {
    let calSplit = '@calendar=';
    let curLocaleAndCal = data.AppleLocale || language || 'en';
    let split = curLocaleAndCal.split(calSplit);
    let curLoc = split[0];

    if (calendarFormat || split[1]) {
      calendarFormat = `${calSplit}${calendarFormat || split[1] || ''}`;
    }

    calendarFormat = calendarFormat || '';
    let newLocaleAndCal = locale ? locale : curLoc;

    if (calendarFormat) {
      newLocaleAndCal = `${newLocaleAndCal}${calendarFormat}`;
    }

    if (newLocaleAndCal !== curLocaleAndCal) {
      _logger.default.debug(`New locale: ${newLocaleAndCal}`);

      updates.AppleLocale = newLocaleAndCal;
    }
  }

  if (_lodash.default.size(updates) === 0) {
    _logger.default.debug('No locale updates necessary.');

    return false;
  }

  _logger.default.debug('Writing new locale plist data');

  await update(globalPrefs, updates);
  return true;
}

async function stub() {
  return await plistPaths;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zZXR0aW5ncy5qcyJdLCJuYW1lcyI6WyJwbGlzdFBhdGhzIiwic2ltIiwiaWRlbnRpZmllciIsInBhdGhzIiwic2ltRGlyZWN0b3J5IiwiZ2V0RGlyIiwicHVzaCIsInBhdGgiLCJyZXNvbHZlIiwiZ2V0QXBwRGlyIiwic2VtdmVyIiwibHQiLCJjb2VyY2UiLCJ4Y29kZVZlcnNpb24iLCJ2ZXJzaW9uU3RyaW5nIiwidXBkYXRlU2V0dGluZ3MiLCJwbGlzdCIsInVwZGF0ZXMiLCJCIiwicmVkdWNlIiwicmVkdWNlciIsInVwZGF0ZWQiLCJ1cGRhdGUiLCJwYXRoVG9QbGlzdCIsImN1cnJlbnRTZXR0aW5ncyIsInJlYWQiLCJuZXdTZXR0aW5ncyIsIk9iamVjdCIsImFzc2lnbiIsIl8iLCJpc0VxdWFsIiwidXBkYXRlUGxpc3RGaWxlIiwicmVhZFNldHRpbmdzIiwic2V0dGluZ3MiLCJwYXJzZVBsaXN0RmlsZSIsInVwZGF0ZUxvY2F0aW9uU2V0dGluZ3MiLCJidW5kbGVJZCIsImF1dGhvcml6ZWQiLCJuZXdDYWNoZVByZWZzIiwiTGFzdEZlbmNlQWN0aXZpdHlUaW1lc3RhbXAiLCJDbGVhblNodXRkb3duIiwibmV3Q2xpZW50UHJlZnMiLCJCdW5kbGVJZCIsIkF1dGhvcml6ZWQiLCJXaGl0ZWxpc3RlZCIsImZpbGUiLCJsb2ciLCJkZWJ1ZyIsIndlaXJkTG9jS2V5IiwiaGFzIiwiQnVuZGxlUGF0aCIsIkV4ZWN1dGFibGUiLCJSZWdpc3RlcmVkIiwiYmFzZVNldHRpbmciLCJkZWZhdWx0cyIsInNldFJlZHVjZU1vdGlvbiIsInJlZHVjZU1vdGlvbiIsIlJlZHVjZU1vdGlvbkVuYWJsZWQiLCJzZXREYXJrTW9kZSIsImlzRW5hYmxlZCIsIlVzZXJJbnRlcmZhY2VTdHlsZU1vZGUiLCJ1cGRhdGVTYWZhcmlHbG9iYWxTZXR0aW5ncyIsInNldHRpbmdTZXQiLCJzYWZhcmlTZXR0aW5nU2V0IiwidG9QYWlycyIsImtleSIsInZhbHVlIiwiaXNFbXB0eSIsInVwZGF0ZVNhZmFyaVVzZXJTZXR0aW5ncyIsIm5ld1VzZXJTZXR0aW5ncyIsInNhZmFyaUFsbG93SmF2YVNjcmlwdCIsIldlYktpdEphdmFTY3JpcHRFbmFibGVkIiwic2FmYXJpQWxsb3dQb3B1cHMiLCJXZWJLaXRKYXZhU2NyaXB0Q2FuT3BlbldpbmRvd3NBdXRvbWF0aWNhbGx5Iiwic2FmYXJpRm9yY2VGcmF1ZFdhcm5pbmciLCJXYXJuQWJvdXRGcmF1ZHVsZW50V2Vic2l0ZXMiLCJ1c2VyU2V0dGluZ1NldCIsInJlc3RyaWN0ZWRCb29sIiwidXBkYXRlTG9jYWxlIiwibGFuZ3VhZ2UiLCJsb2NhbGUiLCJjYWxlbmRhckZvcm1hdCIsImdsb2JhbFByZWZzIiwiZGF0YSIsInN1cHBvcnRlZExhbmdzIiwiQXBwbGVMYW5ndWFnZXMiLCJpbmRleE9mIiwiY29uY2F0Iiwid2l0aG91dCIsImNhbFNwbGl0IiwiY3VyTG9jYWxlQW5kQ2FsIiwiQXBwbGVMb2NhbGUiLCJzcGxpdCIsImN1ckxvYyIsIm5ld0xvY2FsZUFuZENhbCIsInNpemUiLCJzdHViIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFLQSxlQUFlQSxVQUFmLENBQTJCQyxHQUEzQixFQUFnQ0MsVUFBaEMsRUFBNEM7QUFDMUMsTUFBSUMsS0FBSyxHQUFHLEVBQVo7QUFDQSxNQUFJQyxZQUFZLEdBQUdILEdBQUcsQ0FBQ0ksTUFBSixFQUFuQjs7QUFFQSxVQUFRSCxVQUFSO0FBQ0UsU0FBSyxjQUFMO0FBQ0VDLE1BQUFBLEtBQUssQ0FBQ0csSUFBTixDQUFXQyxjQUFLQyxPQUFMLENBQWFKLFlBQWIsRUFBMkIsU0FBM0IsRUFBc0MsYUFBdEMsRUFBcUQsOEJBQXJELENBQVg7QUFDQTs7QUFDRixTQUFLLGNBQUw7QUFDRUQsTUFBQUEsS0FBSyxDQUFDRyxJQUFOLENBQVdDLGNBQUtDLE9BQUwsRUFBYSxNQUFNUCxHQUFHLENBQUNRLFNBQUosQ0FBYyx3QkFB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LFFBQUlhLGVBQWUsS0FBS0osZUFBeEIsRUFBeUM7QUFDdkM1QyxzQkFBSUMsS0FBSixDQUFXLGVBQWMrQyxlQUFnQixFQUF6Qzs7QUFDQTdFLE1BQUFBLE9BQU8sQ0FBQzBFLFdBQVIsR0FBc0JHLGVBQXRCO0FBQ0Q7QUFDRjs7QUFFRCxNQUFJakUsZ0JBQUVrRSxJQUFGLENBQU85RSxPQUFQLE1BQW9CLENBQXhCLEVBQTJCO0FBQ3pCNkIsb0JBQUlDLEtBQUosQ0FBVSw4QkFBVjs7QUFDQSxXQUFPLEtBQVA7QUFDRDs7QUFFREQsa0JBQUlDLEtBQUosQ0FBVSwrQkFBVjs7QUFDQSxRQUFNekIsTUFBTSxDQUFDNEQsV0FBRCxFQUFjakUsT0FBZCxDQUFaO0FBQ0EsU0FBTyxJQUFQO0FBQ0Q7O0FBRUQsZUFBZStFLElBQWYsR0FBdUI7QUFDckIsU0FBTyxNQUFNaEcsVUFBYjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHBsaXN0IH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBzZW12ZXIgZnJvbSAnc2VtdmVyJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuXG4vLyByZXR1cm5zIHBhdGggdG8gcGxpc3QgYmFzZWQgb24gaWQgZm9yIHBsaXN0LlxuLy8gdGhlc2UgaWRzIGFyZSBhcHBpdW0gdGVybXNcbmFzeW5jIGZ1bmN0aW9uIHBsaXN0UGF0aHMgKHNpbSwgaWRlbnRpZmllcikge1xuICBsZXQgcGF0aHMgPSBbXTtcbiAgbGV0IHNpbURpcmVjdG9yeSA9IHNpbS5nZXREaXIoKTtcblxuICBzd2l0Y2ggKGlkZW50aWZpZXIpIHtcbiAgICBjYXNlICd3ZWJJbnNwZWN0b3InOlxuICAgICAgcGF0aHMucHVzaChwYXRoLnJlc29sdmUoc2ltRGlyZWN0b3J5LCAnTGlicmFyeScsICdQcmVmZXJlbmNlcycsICdjb20uYXBwbGUud2ViSW5zcGVjdG9yLnBsaXN0JykpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnbW9iaWxlU2FmYXJpJzpcbiAgICAgIHBhdGhzLnB1c2gocGF0aC5yZXNvbHZlKGF3YWl0IHNpbS5nZXRBcHBEaXIoJ2NvbS5hcHBsZS5tb2JpbGVzYWZhcmknKSwgJ0xpYnJhcnknLCAnUHJlZmVyZW5jZXMnLCAnY29tLmFwcGxlLm1vYmlsZXNhZmFyaS5wbGlzdCcpKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ2dsb2JhbE1vYmlsZVNhZmFyaSc6XG4gICAgICBwYXRocy5wdXNoKHBhdGgucmVzb2x2ZShzaW1EaXJlY3RvcnksICdMaWJyYXJ5JywgJ1ByZWZlcmVuY2VzJywgJ2NvbS5hcHBsZS5tb2JpbGVzYWZhcmkucGxpc3QnKSk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICd3ZWJVSSc6XG4gICAgICBwYXRocy5wdXNoKHBhdGgucmVzb2x2ZShzaW1EaXJlY3RvcnksICdMaWJyYXJ5JywgJ1ByZWZlcmVuY2VzJywgJ2NvbS5hcHBsZS5XZWJVSS5wbGlzdCcpKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ3dlYkZvdW5kYXRpb24nOlxuICAgICAgcGF0aHMucHVzaChwYXRoLnJlc29sdmUoc2ltRGlyZWN0b3J5LCAnTGlicmFyeScsICdQcmVmZXJlbmNlcycsICdjb20uYXBwbGUuV2ViRm91bmRhdGlvbi5wbGlzdCcpKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ3ByZWZlcmVuY2VzJzpcbiAgICAgIHBhdGhzLnB1c2gocGF0aC5yZXNvbHZlKHNpbURpcmVjdG9yeSwgJ0xpYnJhcnknLCAnUHJlZmVyZW5jZXMnLCAnY29tLmFwcGxlLlByZWZlcmVuY2VzLnBsaXN0JykpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnbG9jYXRpb25TZXJ2aWNlcyc6XG4gICAgICBwYXRocy5wdXNoKHBhdGgucmVzb2x2ZShzaW1EaXJlY3RvcnksICdMaWJyYXJ5JywgJ1ByZWZlcmVuY2VzJywgJ2NvbS5hcHBsZS5sb2NhdGlvbmQucGxpc3QnKSk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdsb2NhdGlvbkNsaWVudHMnOlxuICAgICAgcGF0aHMucHVzaChwYXRoLnJlc29sdmUoc2ltRGlyZWN0b3J5LCAnTGlicmFyeScsICdDYWNoZXMnLCAnbG9jYXRpb25kJywgJ2NsaWVudHMucGxpc3QnKSk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdsb2NhdGlvbkNhY2hlJzpcbiAgICAgIHBhdGhzLnB1c2gocGF0aC5yZXNvbHZlKHNpbURpcmVjdG9yeSwgJ0xpYnJhcnknLCAnQ2FjaGVzJywgJ2xvY2F0aW9uZCcsICdjYWNoZS5wbGlzdCcpKTtcbiAgICAgIHBhdGhzLnB1c2gocGF0aC5yZXNvbHZlKHNpbURpcmVjdG9yeSwgJ0xpYnJhcnknLCAnUHJlZmVyZW5jZXMnLCAnY29tLmFwcGxlLmxvY2F0aW9uZC5wbGlzdCcpKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ3VzZXJTZXR0aW5ncyc6XG4gICAgICBpZiAoc2VtdmVyLmx0KHNlbXZlci5jb2VyY2Uoc2ltLnhjb2RlVmVyc2lvbi52ZXJzaW9uU3RyaW5nKSwgc2VtdmVyLmNvZXJjZSgnNy4zJykpKSB7XG4gICAgICAgIHBhdGhzLnB1c2gocGF0aC5yZXNvbHZlKHNpbURpcmVjdG9yeSwgJ0xpYnJhcnknLCAnQ29uZmlndXJhdGlvblByb2ZpbGVzJywgJ1VzZXJTZXR0aW5ncy5wbGlzdCcpKTtcbiAgICAgICAgcGF0aHMucHVzaChwYXRoLnJlc29sdmUoc2ltRGlyZWN0b3J5LCAnTGlicmFyeScsICdDb25maWd1cmF0aW9uUHJvZmlsZXMnLCAnRWZmZWN0aXZlVXNlclNldHRpbmdzLnBsaXN0JykpO1xuICAgICAgICBwYXRocy5wdXNoKHBhdGgucmVzb2x2ZShzaW1EaXJlY3RvcnksICdMaWJyYXJ5JywgJ0NvbmZpZ3VyYXRpb25Qcm9maWxlcycsICdQdWJsaWNJbmZvJywgJ1B1YmxpY0VmZmVjdGl2ZVVzZXJTZXR0aW5ncy5wbGlzdCcpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHBhdGhzLnB1c2gocGF0aC5yZXNvbHZlKHNpbURpcmVjdG9yeSwgJ0xpYnJhcnknLCAnVXNlckNvbmZpZ3VyYXRpb25Qcm9maWxlcycsICdVc2VyU2V0dGluZ3MucGxpc3QnKSk7XG4gICAgICAgIHBhdGhzLnB1c2gocGF0aC5yZXNvbHZlKHNpbURpcmVjdG9yeSwgJ0xpYnJhcnknLCAnVXNlckNvbmZpZ3VyYXRpb25Qcm9maWxlcycsICdFZmZlY3RpdmVVc2VyU2V0dGluZ3MucGxpc3QnKSk7XG4gICAgICAgIHBhdGhzLnB1c2gocGF0aC5yZXNvbHZlKHNpbURpcmVjdG9yeSwgJ0xpYnJhcnknLCAnVXNlckNvbmZpZ3VyYXRpb25Qcm9maWxlcycsICdQdWJsaWNJbmZvJywgJ1B1YmxpY0VmZmVjdGl2ZVVzZXJTZXR0aW5ncy5wbGlzdCcpKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ2VmZmVjdGl2ZVVzZXJTZXR0aW5ncyc6XG4gICAgICBwYXRocy5wdXNoKHBhdGgucmVzb2x2ZShzaW1EaXJlY3RvcnksICdMaWJyYXJ5JywgJ0NvbmZpZ3VyYXRpb25Qcm9maWxlcycsICdFZmZlY3RpdmVVc2VyU2V0dGluZ3MucGxpc3QnKSk7XG4gICAgICBwYXRocy5wdXNoKHBhdGgucmVzb2x2ZShzaW1EaXJlY3RvcnksICdMaWJyYXJ5JywgJ0NvbmZpZ3VyYXRpb25Qcm9maWxlcycsICdQdWJsaWNJbmZvJywgJ1B1YmxpY0VmZmVjdGl2ZVVzZXJTZXR0aW5ncy5wbGlzdCcpKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ2FjY2Vzc2liaWxpdHlTZXR0aW5ncyc6XG4gICAgICBwYXRocy5wdXNoKHBhdGgucmVzb2x2ZShzaW1EaXJlY3RvcnksICdMaWJyYXJ5JywgJ1ByZWZlcmVuY2VzJywgJ2NvbS5hcHBsZS5BY2Nlc3NpYmlsaXR5LnBsaXN0JykpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAndWlTdHlsZVNldHRpbmdzJzpcbiAgICAgIHBhdGhzLnB1c2gocGF0aC5yZXNvbHZlKHNpbURpcmVjdG9yeSwgJ0xpYnJhcnknLCAnUHJlZmVyZW5jZXMnLCAnY29tLmFwcGxlLnVpa2l0c2VydmljZXMudXNlckludGVyZmFjZVN0eWxlTW9kZS5wbGlzdCcpKTtcbiAgICAgIGJyZWFrO1xuICB9XG5cbiAgcmV0dXJuIHBhdGhzO1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVTZXR0aW5ncyAoc2ltLCBwbGlzdCwgdXBkYXRlcykge1xuICByZXR1cm4gYXdhaXQgQi5yZWR1Y2UoYXdhaXQgcGxpc3RQYXRocyhzaW0sIHBsaXN0KSwgYXN5bmMgZnVuY3Rpb24gcmVkdWNlciAodXBkYXRlZCwgcGF0aCkge1xuICAgIHJldHVybiBhd2FpdCB1cGRhdGUocGF0aCwgdXBkYXRlcykgfHwgdXBkYXRlZDtcbiAgfSwgZmFsc2UpO1xufVxuXG4vLyB1cGRhdGUgYSBwbGlzdCBmaWxlLCBsb2NhdGVkIGF0IHBhdGhUb1BsaXN0XG4vLyBwYXNzIGluIGFuIG9iamVjdCwgYWxsIHNldHRpbmdzIHNwZWNpZmllZCBpbiB0aGUgb2JqZWN0IHdpbGwgYmVcbi8vIHVwZGF0ZWQgb24gdGhlIHBsaXN0LCBhbGwgb3RoZXJzIGxlZnQgYXMtaXNcbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZSAocGF0aFRvUGxpc3QsIHVwZGF0ZXMpIHtcbiAgY29uc3QgY3VycmVudFNldHRpbmdzID0gYXdhaXQgcmVhZChwYXRoVG9QbGlzdCk7XG4gIGNvbnN0IG5ld1NldHRpbmdzID0gT2JqZWN0LmFzc2lnbih7fSwgY3VycmVudFNldHRpbmdzLCB1cGRhdGVzKTtcblxuICBpZiAoXy5pc0VxdWFsKGN1cnJlbnRTZXR0aW5ncywgbmV3U2V0dGluZ3MpKSB7XG4gICAgLy8gbm8gc2V0dGluZyBjaGFuZ2VzLCBzbyBkbyBub3RoaW5nXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgYXdhaXQgcGxpc3QudXBkYXRlUGxpc3RGaWxlKHBhdGhUb1BsaXN0LCBuZXdTZXR0aW5ncywgdHJ1ZSwgZmFsc2UpO1xuICByZXR1cm4gdHJ1ZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVhZFNldHRpbmdzIChzaW0sIHBsaXN0KSB7XG4gIGxldCBzZXR0aW5ncyA9IHt9O1xuICBmb3IgKGxldCBwYXRoIG9mIGF3YWl0IHBsaXN0UGF0aHMoc2ltLCBwbGlzdCkpIHtcbiAgICBzZXR0aW5nc1twYXRoXSA9IGF3YWl0IHJlYWQocGF0aCk7XG4gIH1cbiAgcmV0dXJuIHNldHRpbmdzO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZWFkIChwYXRoVG9QbGlzdCkge1xuICByZXR1cm4gYXdhaXQgcGxpc3QucGFyc2VQbGlzdEZpbGUocGF0aFRvUGxpc3QsIGZhbHNlKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlTG9jYXRpb25TZXR0aW5ncyAoc2ltLCBidW5kbGVJZCwgYXV0aG9yaXplZCkge1xuICAvLyB1cGRhdGUgbG9jYXRpb24gY2FjaGVcbiAgY29uc3QgbmV3Q2FjaGVQcmVmcyA9IHtcbiAgICBMYXN0RmVuY2VBY3Rpdml0eVRpbWVzdGFtcDogNDEyMTIyMTAzLjIzMjk4MyxcbiAgICBDbGVhblNodXRkb3duOiB0cnVlXG4gIH07XG4gIGxldCB1cGRhdGVkID0gYXdhaXQgdXBkYXRlU2V0dGluZ3Moc2ltLCAnbG9jYXRpb25DYWNoZScsIHtbYnVuZGxlSWRdOiBuZXdDYWNoZVByZWZzfSk7XG5cbiAgLy8gdXBkYXRlIGxvY2F0aW9uIGNsaWVudHNcbiAgY29uc3QgbmV3Q2xpZW50UHJlZnMgPSB7XG4gICAgQnVuZGxlSWQ6IGJ1bmRsZUlkLFxuICAgIEF1dGhvcml6ZWQ6ICEhYXV0aG9yaXplZCxcbiAgICBXaGl0ZWxpc3RlZDogZmFsc2UsXG4gIH07XG4gIGZvciAoY29uc3QgZmlsZSBvZiBhd2FpdCBwbGlzdFBhdGhzKHNpbSwgJ2xvY2F0aW9uQ2xpZW50cycpKSB7XG4gICAgbG9nLmRlYnVnKGBVcGRhdGluZyBsb2NhdGlvbiBjbGllbnQgZmlsZTogJHtmaWxlfWApO1xuXG4gICAgbGV0IHVwZGF0ZXMgPSB7fTtcblxuICAgIC8vIHNlZSBpZiB0aGUgYnVuZGxlIGlzIGFscmVhZHkgdGhlcmVcbiAgICBjb25zdCBwbGlzdCA9IGF3YWl0IHJlYWQoZmlsZSk7XG5cbiAgICAvLyByYW5kb20gZGF0YSB0aGF0IGFsd2F5cyBzZWVtcyB0byBiZSBpbiB0aGUgY2xpZW50cy5wbGlzdFxuICAgIGNvbnN0IHdlaXJkTG9jS2V5ID0gJ2NvbS5hcHBsZS5sb2NhdGlvbmQuYnVuZGxlLS9TeXN0ZW0vTGlicmFyeS8nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICdQcml2YXRlRnJhbWV3b3Jrcy9BT1NOb3RpZmljYXRpb24uZnJhbWV3b3JrJztcbiAgICBpZiAoIV8uaGFzKHBsaXN0LCB3ZWlyZExvY0tleSkpIHtcbiAgICAgIHVwZGF0ZXNbd2VpcmRMb2NLZXldID0ge1xuICAgICAgICBCdW5kbGVQYXRoOiAnL1N5c3RlbS9MaWJyYXJ5L1ByaXZhdGVGcmFtZXdvcmtzL0FPU05vdGlmaWNhdGlvbi5mcmFtZXdvcmsnLFxuICAgICAgICBXaGl0ZWxpc3RlZDogZmFsc2UsXG4gICAgICAgIEV4ZWN1dGFibGU6ICcnLFxuICAgICAgICBSZWdpc3RlcmVkOiAnJ1xuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBjcmVhdGUgdGhlIHVwZGF0ZSwgYW5kIG1ha2Ugc3VyZSBpdCBoYXMgc2Vuc2libGUgdmFsdWVzXG4gICAgY29uc3QgYmFzZVNldHRpbmcgPSBfLmhhcyhwbGlzdCwgYnVuZGxlSWQpID8gcGxpc3RbYnVuZGxlSWRdIDoge307XG4gICAgdXBkYXRlc1tidW5kbGVJZF0gPSBfLmRlZmF1bHRzKG5ld0NsaWVudFByZWZzLCBiYXNlU2V0dGluZyk7XG4gICAgdXBkYXRlc1tidW5kbGVJZF0uRXhlY3V0YWJsZSA9IHVwZGF0ZXNbYnVuZGxlSWRdLkV4ZWN1dGFibGUgfHwgJyc7XG4gICAgdXBkYXRlc1tidW5kbGVJZF0uUmVnaXN0ZXJlZCA9IHVwZGF0ZXNbYnVuZGxlSWRdLlJlZ2lzdGVyZWQgfHwgJyc7XG5cbiAgICB1cGRhdGVkID0gYXdhaXQgdXBkYXRlKGZpbGUsIHVwZGF0ZXMpIHx8IHVwZGF0ZWQ7XG4gIH1cblxuICByZXR1cm4gdXBkYXRlZDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0UmVkdWNlTW90aW9uIChzaW0sIHJlZHVjZU1vdGlvbiA9IHRydWUpIHtcbiAgbG9nLmRlYnVnKGBVcGRhdGluZyByZWR1Y2UgbW90aW9uLiBTZXR0aW5nIHRvICR7cmVkdWNlTW90aW9ufS5gKTtcbiAgY29uc3QgcGF0aHMgPSBhd2FpdCBwbGlzdFBhdGhzKHNpbSwgJ2FjY2Vzc2liaWxpdHlTZXR0aW5ncycpO1xuICBmb3IgKGNvbnN0IGZpbGUgb2YgcGF0aHMpIHtcbiAgICBhd2FpdCB1cGRhdGUoZmlsZSwge1xuICAgICAgUmVkdWNlTW90aW9uRW5hYmxlZDogcmVkdWNlTW90aW9uID8gMSA6IDBcbiAgICB9KTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzZXREYXJrTW9kZSAoc2ltLCBpc0VuYWJsZWQgPSB0cnVlKSB7XG4gIGxvZy5kZWJ1ZyhgU2V0dGluZyBkYXJrIG1vZGUgJHtpc0VuYWJsZWQgPyAnb24nIDogJ29mZid9YCk7XG4gIGNvbnN0IHBhdGhzID0gYXdhaXQgcGxpc3RQYXRocyhzaW0sICd1aVN0eWxlU2V0dGluZ3MnKTtcbiAgZm9yIChjb25zdCBmaWxlIG9mIHBhdGhzKSB7XG4gICAgYXdhaXQgdXBkYXRlKGZpbGUsIHtcbiAgICAgIFVzZXJJbnRlcmZhY2VTdHlsZU1vZGU6IGlzRW5hYmxlZCA/IDIgOiAxLFxuICAgIH0pO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVNhZmFyaUdsb2JhbFNldHRpbmdzIChzaW0sIHNldHRpbmdTZXQpIHtcbiAgbG9nLmRlYnVnKCdVcGRhdGluZyBTYWZhcmkgZ2xvYmFsIHNldHRpbmdzJyk7XG5cbiAgbGV0IHVwZGF0ZWQgPSBmYWxzZTtcbiAgZm9yIChjb25zdCBbZmlsZSwgc2FmYXJpU2V0dGluZ1NldF0gb2YgXy50b1BhaXJzKGF3YWl0IHJlYWRTZXR0aW5ncyhzaW0sICdnbG9iYWxNb2JpbGVTYWZhcmknKSkpIHtcbiAgICBsZXQgbmV3U2V0dGluZ3MgPSB7fTtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBfLnRvUGFpcnMoc2V0dGluZ1NldCkpIHtcbiAgICAgIGlmIChzYWZhcmlTZXR0aW5nU2V0W2tleV0gIT09IHZhbHVlKSB7XG4gICAgICAgIG5ld1NldHRpbmdzW2tleV0gPSB2YWx1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKF8uaXNFbXB0eShuZXdTZXR0aW5ncykpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIHVwZGF0ZWQgPSBhd2FpdCB1cGRhdGUoZmlsZSwgbmV3U2V0dGluZ3MpIHx8IHVwZGF0ZWQ7XG4gIH1cbiAgcmV0dXJuIHVwZGF0ZWQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVNhZmFyaVVzZXJTZXR0aW5ncyAoc2ltLCBzZXR0aW5nU2V0KSB7XG4gIGxvZy5kZWJ1ZygnVXBkYXRpbmcgU2FmYXJpIHVzZXIgc2V0dGluZ3MnKTtcblxuICAvLyBhZGQgZXh0cmEgc3R1ZmYgdG8gVXNlclNldHRpbmdzLnBsaXN0IGFuZCBFZmZlY3RpdmVVc2VyU2V0dGluZ3MucGxpc3RcbiAgbGV0IG5ld1VzZXJTZXR0aW5ncyA9IHt9O1xuICBpZiAoXy5oYXMoc2V0dGluZ1NldCwgJ1dlYktpdEphdmFTY3JpcHRFbmFibGVkJykpIHtcbiAgICBuZXdVc2VyU2V0dGluZ3Muc2FmYXJpQWxsb3dKYXZhU2NyaXB0ID0gc2V0dGluZ1NldC5XZWJLaXRKYXZhU2NyaXB0RW5hYmxlZDtcbiAgfVxuICBpZiAoXy5oYXMoc2V0dGluZ1NldCwgJ1dlYktpdEphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHknKSkge1xuICAgIG5ld1VzZXJTZXR0aW5ncy5zYWZhcmlBbGxvd1BvcHVwcyA9IHNldHRpbmdTZXQuV2ViS2l0SmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseTtcbiAgfVxuICBpZiAoXy5oYXMoc2V0dGluZ1NldCwgJ1dhcm5BYm91dEZyYXVkdWxlbnRXZWJzaXRlcycpKSB7XG4gICAgbmV3VXNlclNldHRpbmdzLnNhZmFyaUZvcmNlRnJhdWRXYXJuaW5nID0gIXNldHRpbmdTZXQuV2FybkFib3V0RnJhdWR1bGVudFdlYnNpdGVzO1xuICB9XG5cbiAgaWYgKF8uaXNFbXB0eShuZXdVc2VyU2V0dGluZ3MpKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgbGV0IHVwZGF0ZWQgPSBmYWxzZTtcbiAgZm9yIChjb25zdCBbZmlsZSwgdXNlclNldHRpbmdTZXRdIG9mIF8udG9QYWlycyhhd2FpdCByZWFkU2V0dGluZ3Moc2ltLCAndXNlclNldHRpbmdzJykpKSB7XG4gICAgLy8gdGhlIHVzZXIgc2V0dGluZ3MgcGxpc3QgaGFzIHR3byBidWNrZXRzLCBvbmUgZm9yXG4gICAgLy8gYm9vbGVhbiBzZXR0aW5ncyAoYHJlc3RyaWN0ZWRCb29sYCkgYW5kIG9uZSBmb3JcbiAgICAvLyBvdGhlciB2YWx1ZSBzZXR0aW5ncyAoYHJlc3RyaWN0ZWRWYWx1ZWApLiBJbiBlYWNoLCB0aGUgdmFsdWVcbiAgICAvLyBpcyBpbiBhIGB2YWx1ZWAgc3ViLWZpZWxkLlxuICAgIGlmICghXy5oYXModXNlclNldHRpbmdTZXQsICdyZXN0cmljdGVkQm9vbCcpKSB7XG4gICAgICB1c2VyU2V0dGluZ1NldC5yZXN0cmljdGVkQm9vbCA9IHt9O1xuICAgIH1cbiAgICBmb3IgKGxldCBba2V5LCB2YWx1ZV0gb2YgXy50b1BhaXJzKG5ld1VzZXJTZXR0aW5ncykpIHtcbiAgICAgIHVzZXJTZXR0aW5nU2V0LnJlc3RyaWN0ZWRCb29sW2tleV0gPSB7dmFsdWV9O1xuICAgIH1cblxuICAgIC8vIGFjdHVhbGx5IGRvIHRoZSB1cGRhdGVcbiAgICB1cGRhdGVkID0gYXdhaXQgdXBkYXRlKGZpbGUsIHVzZXJTZXR0aW5nU2V0KSB8fCB1cGRhdGVkO1xuICB9XG5cbiAgcmV0dXJuIHVwZGF0ZWQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUxvY2FsZSAoc2ltLCBsYW5ndWFnZSwgbG9jYWxlLCBjYWxlbmRhckZvcm1hdCkge1xuICBsZXQgZ2xvYmFsUHJlZnMgPSBwYXRoLnJlc29sdmUoc2ltLmdldERpcigpLCAnTGlicmFyeScsICdQcmVmZXJlbmNlcycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLkdsb2JhbFByZWZlcmVuY2VzLnBsaXN0Jyk7XG5cbiAgLy8gZ2V0IHRoZSBjdXJyZW50IGRhdGFcbiAgbGV0IGRhdGEgPSBhd2FpdCByZWFkKGdsb2JhbFByZWZzKTtcbiAgbGV0IHVwZGF0ZXMgPSB7fTtcblxuICAvLyBpZiB3ZSBhcmUgc2V0dGluZyB0aGUgbGFuZ3VhZ2UsIGFkZCBpdCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBsaXN0IG9mIGxhbmd1YWdlc1xuICBpZiAobGFuZ3VhZ2UpIHtcbiAgICBsb2cuZGVidWcoYE5ldyBsYW5ndWFnZTogJHtsYW5ndWFnZX1gKTtcbiAgICBsZXQgc3VwcG9ydGVkTGFuZ3MgPSBkYXRhLkFwcGxlTGFuZ3VhZ2VzIHx8IFtdO1xuICAgIC8vIGlmIHRoZSBsYW5ndWFnZSBpcyBmaXJzdCwgd2UgZG9uJ3QgbmVlZCB0byBkbyBhbnl0aGluZ1xuICAgIGlmIChzdXBwb3J0ZWRMYW5ncy5pbmRleE9mKGxhbmd1YWdlKSAhPT0gMCkge1xuICAgICAgdXBkYXRlcy5BcHBsZUxhbmd1YWdlcyA9IFtsYW5ndWFnZV0uY29uY2F0KF8ud2l0aG91dChzdXBwb3J0ZWRMYW5ncywgbGFuZ3VhZ2UpKTtcbiAgICB9XG4gIH1cbiAgLy8gaWYgd2UgYXJlIHNldHRpbmcgdGhlIGxvY2FsZSBvciBjYWxlbmRhciBmb3JtYXQsIHNldCB0aGVtIGFzIGFwcHJvcHJpYXRlXG4gIGlmIChsb2NhbGUgfHwgY2FsZW5kYXJGb3JtYXQpIHtcbiAgICBsZXQgY2FsU3BsaXQgPSAnQGNhbGVuZGFyPSc7XG4gICAgbGV0IGN1ckxvY2FsZUFuZENhbCA9IGRhdGEuQXBwbGVMb2NhbGUgfHwgbGFuZ3VhZ2UgfHwgJ2VuJztcblxuICAgIGxldCBzcGxpdCA9IGN1ckxvY2FsZUFuZENhbC5zcGxpdChjYWxTcGxpdCk7XG4gICAgbGV0IGN1ckxvYyA9IHNwbGl0WzBdO1xuICAgIGlmIChjYWxlbmRhckZvcm1hdCB8fCBzcGxpdFsxXSkge1xuICAgICAgY2FsZW5kYXJGb3JtYXQgPSBgJHtjYWxTcGxpdH0ke2NhbGVuZGFyRm9ybWF0IHx8IHNwbGl0WzFdIHx8ICcnfWA7XG4gICAgfVxuICAgIGNhbGVuZGFyRm9ybWF0ID0gY2FsZW5kYXJGb3JtYXQgfHwgJyc7XG4gICAgbGV0IG5ld0xvY2FsZUFuZENhbCA9IGxvY2FsZSA/IGxvY2FsZSA6IGN1ckxvYztcbiAgICBpZiAoY2FsZW5kYXJGb3JtYXQpIHtcbiAgICAgIG5ld0xvY2FsZUFuZENhbCA9IGAke25ld0xvY2FsZUFuZENhbH0ke2NhbGVuZGFyRm9ybWF0fWA7XG4gICAgfVxuICAgIC8vIG9ubHkgbmVlZCB0byB1cGRhdGUgaWYgaXQgaGFzIGNoYW5nZWRcbiAgICBpZiAobmV3TG9jYWxlQW5kQ2FsICE9PSBjdXJMb2NhbGVBbmRDYWwpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgTmV3IGxvY2FsZTogJHtuZXdMb2NhbGVBbmRDYWx9YCk7XG4gICAgICB1cGRhdGVzLkFwcGxlTG9jYWxlID0gbmV3TG9jYWxlQW5kQ2FsO1xuICAgIH1cbiAgfVxuXG4gIGlmIChfLnNpemUodXBkYXRlcykgPT09IDApIHtcbiAgICBsb2cuZGVidWcoJ05vIGxvY2FsZSB1cGRhdGVzIG5lY2Vzc2FyeS4nKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBsb2cuZGVidWcoJ1dyaXRpbmcgbmV3IGxvY2FsZSBwbGlzdCBkYXRhJyk7XG4gIGF3YWl0IHVwZGF0ZShnbG9iYWxQcmVmcywgdXBkYXRlcyk7XG4gIHJldHVybiB0cnVlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzdHViICgpIHtcbiAgcmV0dXJuIGF3YWl0IHBsaXN0UGF0aHM7XG59XG5cbmV4cG9ydCB7XG4gIHVwZGF0ZSwgdXBkYXRlU2V0dGluZ3MsIHVwZGF0ZUxvY2F0aW9uU2V0dGluZ3MsIHNldFJlZHVjZU1vdGlvbiwgc2V0RGFya01vZGUsXG4gIHVwZGF0ZVNhZmFyaVVzZXJTZXR0aW5ncywgdXBkYXRlU2FmYXJpR2xvYmFsU2V0dGluZ3MsIHVwZGF0ZUxvY2FsZSwgcmVhZCxcbiAgcmVhZFNldHRpbmdzLCBzdHViLFxufTtcbiJdLCJmaWxlIjoibGliL3NldHRpbmdzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
