'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _teen_process = require('teen_process');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _loggerJs = require('../logger.js');

var _loggerJs2 = _interopRequireDefault(_loggerJs);

var _appiumSupport = require('appium-support');

var _helpersJs = require('../helpers.js');

var apkSigningMethods = {};

/**
 * (Re)sign the given apk file on the local file system with the default certificate.
 *
 * @param {string} apk - The full path to the local apk file.
 * @throws {Error} If signing fails.
 */
apkSigningMethods.signWithDefaultCert = function callee$0$0(apk) {
  var java, signPath;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        java = (0, _helpersJs.getJavaForOs)();
        signPath = _path2['default'].resolve(this.helperJarPath, 'sign.jar');

        _loggerJs2['default'].debug("Resigning apk.");
        context$1$0.prev = 3;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(apk));

      case 6:
        if (context$1$0.sent) {
          context$1$0.next = 8;
          break;
        }

        throw new Error(apk + ' file doesn\'t exist.');

      case 8:
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(java, ['-jar', signPath, apk, '--override']));

      case 10:
        context$1$0.next = 15;
        break;

      case 12:
        context$1$0.prev = 12;
        context$1$0.t0 = context$1$0['catch'](3);

        _loggerJs2['default'].errorAndThrow('Could not sign with default certificate. Original error ' + context$1$0.t0.message);

      case 15:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[3, 12]]);
};

/**
 * (Re)sign the given apk file on the local file system with a custom certificate.
 *
 * @param {string} apk - The full path to the local apk file.
 * @throws {Error} If signing fails.
 */
apkSigningMethods.signWithCustomCert = function callee$0$0(apk) {
  var java, javaHome, jarsigner;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _loggerJs2['default'].debug('Signing \'' + apk + '\' with custom cert');
        java = (0, _helpersJs.getJavaForOs)();
        javaHome = (0, _helpersJs.getJavaHome)();
        jarsigner = _path2['default'].resolve(javaHome, 'bin', 'jarsigner');

        if (_appiumSupport.system.isWindows()) {
          jarsigner = jarsigner + '.exe';
        }
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.keystorePath));

      case 7:
        if (context$1$0.sent) {
          context$1$0.next = 9;
          break;
        }

        throw new Error('Keystore: ' + this.keystorePath + ' doesn\'t exist.');

      case 9:
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(apk));

      case 11:
        if (context$1$0.sent) {
          context$1$0.next = 13;
          break;
        }

        throw new Error(apk + ' file doesn\'t exist.');

      case 13:
        context$1$0.prev = 13;

        _loggerJs2['default'].debug("Unsigning apk.");
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(java, ['-jar', _path2['default'].resolve(this.helperJarPath, 'unsign.jar'), apk]));

      case 17:
        _loggerJs2['default'].debug("Signing apk.");
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(jarsigner, ['-sigalg', 'MD5withRSA', '-digestalg', 'SHA1', '-keystore', this.keystorePath, '-storepass', this.keystorePassword, '-keypass', this.keyPassword, apk, this.keyAlias]));

      case 20:
        context$1$0.next = 25;
        break;

      case 22:
        context$1$0.prev = 22;
        context$1$0.t0 = context$1$0['catch'](13);

        _loggerJs2['default'].errorAndThrow('Could not sign with custom certificate. Original error ' + context$1$0.t0.message);

      case 25:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[13, 22]]);
};

/**
 * (Re)sign the given apk file on the local file system with either
 * custom or default certificate based on _this.useKeystore_ property value
 * and Zip-aligns it after signing.
 *
 * @param {string} apk - The full path to the local apk file.
 * @throws {Error} If signing fails.
 */
apkSigningMethods.sign = function callee$0$0(apk) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.useKeystore) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.signWithCustomCert(apk));

      case 3:
        context$1$0.next = 7;
        break;

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.signWithDefaultCert(apk));

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.zipAlignApk(apk));

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * Perform zip-aligning to the given local apk file.
 *
 * @param {string} apk - The full path to the local apk file.
 * @throws {Error} If zip-align fails.
 */
apkSigningMethods.zipAlignApk = function callee$0$0(apk) {
  var alignedApk;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _loggerJs2['default'].debug('Zip-aligning \'' + apk + '\'');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.initZipAlign());

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.tempDir.path({ prefix: 'appium', suffix: '.tmp' }));

      case 5:
        alignedApk = context$1$0.sent;
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(_path2['default'].dirname(alignedApk)));

      case 8:
        _loggerJs2['default'].debug("Zip-aligning apk.");
        context$1$0.prev = 9;
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(this.binaries.zipalign, ['-f', '4', apk, alignedApk]));

      case 12:
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mv(alignedApk, apk, { mkdirp: true }));

      case 14:
        context$1$0.next = 19;
        break;

      case 16:
        context$1$0.prev = 16;
        context$1$0.t0 = context$1$0['catch'](9);

        _loggerJs2['default'].errorAndThrow('zipAlignApk failed. Original error: ' + context$1$0.t0.message);

      case 19:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[9, 16]]);
};

/**
 * Check if the app is already signed.
 *
 * @param {string} apk - The full path to the local apk file.
 * @param {string} pgk - The name of application package.
 * @return {boolean} True if given application is already signed.
 */
apkSigningMethods.checkApkCert = function callee$0$0(apk, pkg) {
  var java;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        java = (0, _helpersJs.getJavaForOs)();
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(apk));

      case 3:
        if (context$1$0.sent) {
          context$1$0.next = 6;
          break;
        }

        _loggerJs2['default'].debug('APK doesn\'t exist. ' + apk);
        return context$1$0.abrupt('return', false);

      case 6:
        if (!this.useKeystore) {
          context$1$0.next = 10;
          break;
        }

        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.checkCustomApkCert(apk, pkg));

      case 9:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 10:
        _loggerJs2['default'].debug('Checking app cert for ' + apk + '.');
        context$1$0.prev = 11;
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(java, ['-jar', _path2['default'].resolve(this.helperJarPath, 'verify.jar'), apk]));

      case 14:
        _loggerJs2['default'].debug("App already signed.");
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(this.zipAlignApk(apk));

      case 17:
        return context$1$0.abrupt('return', true);

      case 20:
        context$1$0.prev = 20;
        context$1$0.t0 = context$1$0['catch'](11);

        _loggerJs2['default'].debug("App not signed with debug cert.");
        return context$1$0.abrupt('return', false);

      case 24:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[11, 20]]);
};

/**
 * Check if the app is already signed with a custom certificate.
 *
 * @param {string} apk - The full path to the local apk file.
 * @param {string} pgk - The name of application package.
 * @return {boolean} True if given application is already signed with a custom certificate.
 */
apkSigningMethods.checkCustomApkCert = function callee$0$0(apk, pkg) {
  var h, md5Str, md5, javaHome, keytool, keystoreHash;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _loggerJs2['default'].debug('Checking custom app cert for ' + apk);
        h = "a-fA-F0-9";
        md5Str = ['.*MD5.*((?:[' + h + ']{2}:){15}[' + h + ']{2})'];
        md5 = new RegExp(md5Str, 'mi');
        javaHome = (0, _helpersJs.getJavaHome)();
        keytool = _path2['default'].resolve(javaHome, 'bin', 'keytool');

        keytool = _appiumSupport.system.isWindows() ? keytool + '.exe' : keytool;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.getKeystoreMd5(keytool, md5));

      case 9:
        keystoreHash = context$1$0.sent;
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(this.checkApkKeystoreMatch(keytool, md5, keystoreHash, pkg, apk));

      case 12:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * Get the MD5 hash of the keystore.
 *
 * @param {string} keytool - The name of the keytool utility.
 * @param {RegExp} md5re - The pattern used to match the result in _keytool_ output.
 * @return {?string} Keystore MD5 hash or _null_ if the hash cannot be parsed.
 * @throws {Error} If getting keystore MD5 hash fails.
 */
apkSigningMethods.getKeystoreMd5 = function callee$0$0(keytool, md5re) {
  var keystoreHash, _ref, stdout;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        keystoreHash = undefined;

        _loggerJs2['default'].debug("Printing keystore md5.");
        context$1$0.prev = 2;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(keytool, ['-v', '-list', '-alias', this.keyAlias, '-keystore', this.keystorePath, '-storepass', this.keystorePassword]));

      case 5:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;

        keystoreHash = md5re.exec(stdout);
        keystoreHash = keystoreHash ? keystoreHash[1] : null;
        _loggerJs2['default'].debug('Keystore MD5: ' + keystoreHash);
        return context$1$0.abrupt('return', keystoreHash);

      case 13:
        context$1$0.prev = 13;
        context$1$0.t0 = context$1$0['catch'](2);

        _loggerJs2['default'].errorAndThrow('getKeystoreMd5 failed. Original error: ' + context$1$0.t0.message);

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2, 13]]);
};

/**
 * Check if the MD5 hash of the particular application matches to the given hash.
 *
 * @param {string} keytool - The name of the keytool utility.
 * @param {RegExp} md5re - The pattern used to match the result in _keytool_ output.
 * @param {string} keystoreHash - The expected hash value.
 * @param {string} pkg - The name of the installed package.
 * @param {string} apk - The full path to the existing apk file.
 * @return {boolean} True if both hashes are equal.
 * @throws {Error} If getting keystore MD5 hash fails.
 */
apkSigningMethods.checkApkKeystoreMatch = function callee$0$0(keytool, md5re, keystoreHash, pkg, apk) {
  var entryHash, rsa, foundKeystoreMatch;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        entryHash = null;
        rsa = /^META-INF\/.*\.[rR][sS][aA]$/;
        foundKeystoreMatch = false;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.zip.readEntries(apk, function callee$1$0(_ref2) {
          var entry = _ref2.entry;
          var extractEntryTo = _ref2.extractEntryTo;

          var entryPath, entryFile, _ref3, stdout, matchesKeystore;

          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                entry = entry.fileName;

                if (rsa.test(entry)) {
                  context$2$0.next = 3;
                  break;
                }

                return context$2$0.abrupt('return');

              case 3:
                _loggerJs2['default'].debug('Entry: ' + entry);
                entryPath = _path2['default'].join(this.tmpDir, pkg, 'cert');

                _loggerJs2['default'].debug('entryPath: ' + entryPath);
                entryFile = _path2['default'].join(entryPath, entry);

                _loggerJs2['default'].debug('entryFile: ' + entryFile);
                // ensure /tmp/pkg/cert/ doesn't exist or extract will fail.
                context$2$0.next = 10;
                return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(entryPath));

              case 10:
                context$2$0.next = 12;
                return _regeneratorRuntime.awrap(extractEntryTo(entryPath));

              case 12:
                _loggerJs2['default'].debug("extracted!");
                // check for match
                _loggerJs2['default'].debug("Printing apk md5.");
                context$2$0.next = 16;
                return _regeneratorRuntime.awrap((0, _teen_process.exec)(keytool, ['-v', '-printcert', '-file', entryFile]));

              case 16:
                _ref3 = context$2$0.sent;
                stdout = _ref3.stdout;

                entryHash = md5re.exec(stdout);
                entryHash = entryHash ? entryHash[1] : null;
                _loggerJs2['default'].debug('entryHash MD5: ' + entryHash);
                _loggerJs2['default'].debug('keystore MD5: ' + keystoreHash);
                matchesKeystore = entryHash && entryHash === keystoreHash;

                _loggerJs2['default'].debug('Matches keystore? ' + matchesKeystore);

                // If we have a keystore match, stop iterating

                if (!matchesKeystore) {
                  context$2$0.next = 27;
                  break;
                }

                foundKeystoreMatch = true;
                return context$2$0.abrupt('return', false);

              case 27:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        }));

      case 5:
        return context$1$0.abrupt('return', foundKeystoreMatch);

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

exports['default'] = apkSigningMethods;
module.exports = exports['default'];

//for (let entry of entries) {
// META-INF/CERT.RSA
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9hcGstc2lnbmluZy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OzRCQUFxQixjQUFjOztvQkFDbEIsTUFBTTs7Ozt3QkFDUCxjQUFjOzs7OzZCQUNtQixnQkFBZ0I7O3lCQUN2QixlQUFlOztBQUV6RCxJQUFJLGlCQUFpQixHQUFHLEVBQUUsQ0FBQzs7Ozs7Ozs7QUFRM0IsaUJBQWlCLENBQUMsbUJBQW1CLEdBQUcsb0JBQWdCLEdBQUc7TUFDbkQsSUFBSSxFQUNOLFFBQVE7Ozs7QUFETixZQUFJLEdBQUcsOEJBQWM7QUFDdkIsZ0JBQVEsR0FBRyxrQkFBSyxPQUFPLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxVQUFVLENBQUM7O0FBQzNELDhCQUFJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDOzs7eUNBRWQsa0JBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQzs7Ozs7Ozs7Y0FDbEIsSUFBSSxLQUFLLENBQUksR0FBRywyQkFBdUI7Ozs7eUNBRXpDLHdCQUFLLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLFlBQVksQ0FBQyxDQUFDOzs7Ozs7Ozs7O0FBRXZELDhCQUFJLGFBQWEsOERBQTRELGVBQUUsT0FBTyxDQUFHLENBQUM7Ozs7Ozs7Q0FFN0YsQ0FBQzs7Ozs7Ozs7QUFRRixpQkFBaUIsQ0FBQyxrQkFBa0IsR0FBRyxvQkFBZ0IsR0FBRztNQUVsRCxJQUFJLEVBQ04sUUFBUSxFQUNSLFNBQVM7Ozs7QUFIYiw4QkFBSSxLQUFLLGdCQUFhLEdBQUcseUJBQXFCLENBQUM7QUFDekMsWUFBSSxHQUFHLDhCQUFjO0FBQ3ZCLGdCQUFRLEdBQUcsNkJBQWE7QUFDeEIsaUJBQVMsR0FBRyxrQkFBSyxPQUFPLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxXQUFXLENBQUM7O0FBQzFELFlBQUksc0JBQU8sU0FBUyxFQUFFLEVBQUU7QUFDdEIsbUJBQVMsR0FBRyxTQUFTLEdBQUcsTUFBTSxD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QUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLENBQUM7O0FBQ25ELHNDQUFJLEtBQUssaUJBQWUsU0FBUyxDQUFHLENBQUM7QUFDakMseUJBQVMsR0FBRyxrQkFBSyxJQUFJLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQzs7QUFDM0Msc0NBQUksS0FBSyxpQkFBZSxTQUFTLENBQUcsQ0FBQzs7O2lEQUUvQixrQkFBRyxNQUFNLENBQUMsU0FBUyxDQUFDOzs7O2lEQUVwQixjQUFjLENBQUMsU0FBUyxDQUFDOzs7QUFDL0Isc0NBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDOztBQUV4QixzQ0FBSSxLQUFLLENBQUMsbUJBQW1CLENBQUMsQ0FBQzs7aURBQ1Ysd0JBQUssT0FBTyxFQUFFLENBQUMsSUFBSSxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUM7Ozs7QUFBdkUsc0JBQU0sU0FBTixNQUFNOztBQUNYLHlCQUFTLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMvQix5QkFBUyxHQUFHLFNBQVMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO0FBQzVDLHNDQUFJLEtBQUsscUJBQW1CLFNBQVMsQ0FBRyxDQUFDO0FBQ3pDLHNDQUFJLEtBQUssb0JBQWtCLFlBQVksQ0FBRyxDQUFDO0FBQ3ZDLCtCQUFlLEdBQUcsU0FBUyxJQUFJLFNBQVMsS0FBSyxZQUFZOztBQUM3RCxzQ0FBSSxLQUFLLHdCQUFzQixlQUFlLENBQUcsQ0FBQzs7OztxQkFHOUMsZUFBZTs7Ozs7QUFDakIsa0NBQWtCLEdBQUcsSUFBSSxDQUFDO29EQUNuQixLQUFLOzs7Ozs7O1NBRWYsQ0FBQzs7OzRDQUNLLGtCQUFrQjs7Ozs7OztDQUMxQixDQUFDOztxQkFFYSxpQkFBaUIiLCJmaWxlIjoibGliL3Rvb2xzL2Fway1zaWduaW5nLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyLmpzJztcbmltcG9ydCB7IHRlbXBEaXIsIHN5c3RlbSwgbWtkaXJwLCBmcywgemlwIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgZ2V0SmF2YUZvck9zLCBnZXRKYXZhSG9tZSB9IGZyb20gJy4uL2hlbHBlcnMuanMnO1xuXG5sZXQgYXBrU2lnbmluZ01ldGhvZHMgPSB7fTtcblxuLyoqXG4gKiAoUmUpc2lnbiB0aGUgZ2l2ZW4gYXBrIGZpbGUgb24gdGhlIGxvY2FsIGZpbGUgc3lzdGVtIHdpdGggdGhlIGRlZmF1bHQgY2VydGlmaWNhdGUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwayAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGxvY2FsIGFwayBmaWxlLlxuICogQHRocm93cyB7RXJyb3J9IElmIHNpZ25pbmcgZmFpbHMuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLnNpZ25XaXRoRGVmYXVsdENlcnQgPSBhc3luYyBmdW5jdGlvbiAoYXBrKSB7XG4gIGNvbnN0IGphdmEgPSBnZXRKYXZhRm9yT3MoKTtcbiAgbGV0IHNpZ25QYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMuaGVscGVySmFyUGF0aCwgJ3NpZ24uamFyJyk7XG4gIGxvZy5kZWJ1ZyhcIlJlc2lnbmluZyBhcGsuXCIpO1xuICB0cnkge1xuICAgIGlmICghKGF3YWl0IGZzLmV4aXN0cyhhcGspKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke2Fwa30gZmlsZSBkb2Vzbid0IGV4aXN0LmApO1xuICAgIH1cbiAgICBhd2FpdCBleGVjKGphdmEsIFsnLWphcicsIHNpZ25QYXRoLCBhcGssICctLW92ZXJyaWRlJ10pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYENvdWxkIG5vdCBzaWduIHdpdGggZGVmYXVsdCBjZXJ0aWZpY2F0ZS4gT3JpZ2luYWwgZXJyb3IgJHtlLm1lc3NhZ2V9YCk7XG4gIH1cbn07XG5cbi8qKlxuICogKFJlKXNpZ24gdGhlIGdpdmVuIGFwayBmaWxlIG9uIHRoZSBsb2NhbCBmaWxlIHN5c3RlbSB3aXRoIGEgY3VzdG9tIGNlcnRpZmljYXRlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGsgLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBsb2NhbCBhcGsgZmlsZS5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzaWduaW5nIGZhaWxzLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5zaWduV2l0aEN1c3RvbUNlcnQgPSBhc3luYyBmdW5jdGlvbiAoYXBrKSB7XG4gIGxvZy5kZWJ1ZyhgU2lnbmluZyAnJHthcGt9JyB3aXRoIGN1c3RvbSBjZXJ0YCk7XG4gIGNvbnN0IGphdmEgPSBnZXRKYXZhRm9yT3MoKTtcbiAgbGV0IGphdmFIb21lID0gZ2V0SmF2YUhvbWUoKTtcbiAgbGV0IGphcnNpZ25lciA9IHBhdGgucmVzb2x2ZShqYXZhSG9tZSwgJ2JpbicsICdqYXJzaWduZXInKTtcbiAgaWYgKHN5c3RlbS5pc1dpbmRvd3MoKSkge1xuICAgIGphcnNpZ25lciA9IGphcnNpZ25lciArICcuZXhlJztcbiAgfVxuICBpZiAoIShhd2FpdCBmcy5leGlzdHModGhpcy5rZXlzdG9yZVBhdGgpKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgS2V5c3RvcmU6ICR7dGhpcy5rZXlzdG9yZVBhdGh9IGRvZXNuJ3QgZXhpc3QuYCk7XG4gIH1cbiAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKGFwaykpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGAke2Fwa30gZmlsZSBkb2Vzbid0IGV4aXN0LmApO1xuICB9XG4gIHRyeSB7XG4gICAgbG9nLmRlYnVnKFwiVW5zaWduaW5nIGFway5cIik7XG4gICAgYXdhaXQgZXhlYyhqYXZhLCBbJy1qYXInLCBwYXRoLnJlc29sdmUodGhpcy5oZWxwZXJKYXJQYXRoLCAndW5zaWduLmphcicpLCBhcGtdKTtcbiAgICBsb2cuZGVidWcoXCJTaWduaW5nIGFway5cIik7XG4gICAgYXdhaXQgZXhlYyhqYXJzaWduZXIsIFsnLXNpZ2FsZycsICdNRDV3aXRoUlNBJywgJy1kaWdlc3RhbGcnLCAnU0hBMScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAnLWtleXN0b3JlJywgdGhpcy5rZXlzdG9yZVBhdGgsICctc3RvcmVwYXNzJywgdGhpcy5rZXlzdG9yZVBhc3N3b3JkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgJy1rZXlwYXNzJywgdGhpcy5rZXlQYXNzd29yZCwgYXBrLCB0aGlzLmtleUFsaWFzXSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ291bGQgbm90IHNpZ24gd2l0aCBjdXN0b20gY2VydGlmaWNhdGUuIE9yaWdpbmFsIGVycm9yICR7ZS5tZXNzYWdlfWApO1xuICB9XG59O1xuXG4vKipcbiAqIChSZSlzaWduIHRoZSBnaXZlbiBhcGsgZmlsZSBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW0gd2l0aCBlaXRoZXJcbiAqIGN1c3RvbSBvciBkZWZhdWx0IGNlcnRpZmljYXRlIGJhc2VkIG9uIF90aGlzLnVzZUtleXN0b3JlXyBwcm9wZXJ0eSB2YWx1ZVxuICogYW5kIFppcC1hbGlnbnMgaXQgYWZ0ZXIgc2lnbmluZy5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgYXBrIGZpbGUuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgc2lnbmluZyBmYWlscy5cbiAqL1xuYXBrU2lnbmluZ01ldGhvZHMuc2lnbiA9IGFzeW5jIGZ1bmN0aW9uIChhcGspIHtcbiAgaWYgKHRoaXMudXNlS2V5c3RvcmUpIHtcbiAgICBhd2FpdCB0aGlzLnNpZ25XaXRoQ3VzdG9tQ2VydChhcGspO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IHRoaXMuc2lnbldpdGhEZWZhdWx0Q2VydChhcGspO1xuICB9XG4gIGF3YWl0IHRoaXMuemlwQWxpZ25BcGsoYXBrKTtcbn07XG5cbi8qKlxuICogUGVyZm9ybSB6aXAtYWxpZ25pbmcgdG8gdGhlIGdpdmVuIGxvY2FsIGFwayBmaWxlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGsgLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBsb2NhbCBhcGsgZmlsZS5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB6aXAtYWxpZ24gZmFpbHMuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLnppcEFsaWduQXBrID0gYXN5bmMgZnVuY3Rpb24gKGFwaykge1xuICBsb2cuZGVidWcoYFppcC1hbGlnbmluZyAnJHthcGt9J2ApO1xuICBhd2FpdCB0aGlzLmluaXRaaXBBbGlnbigpO1xuICBsZXQgYWxpZ25lZEFwayA9IGF3YWl0IHRlbXBEaXIucGF0aCh7cHJlZml4OiAnYXBwaXVtJywgc3VmZml4OiAnLnRtcCd9KTtcbiAgYXdhaXQgbWtkaXJwKHBhdGguZGlybmFtZShhbGlnbmVkQXBrKSk7XG4gIGxvZy5kZWJ1ZyhcIlppcC1hbGlnbmluZyBhcGsuXCIpO1xuICB0cnkge1xuICAgIGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy56aXBhbGlnbiwgWyctZicsICc0JywgYXBrLCBhbGlnbmVkQXBrXSk7XG4gICAgYXdhaXQgZnMubXYoYWxpZ25lZEFwaywgYXBrLCB7IG1rZGlycDogdHJ1ZSB9KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGB6aXBBbGlnbkFwayBmYWlsZWQuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgfVxufTtcblxuLyoqXG4gKiBDaGVjayBpZiB0aGUgYXBwIGlzIGFscmVhZHkgc2lnbmVkLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGsgLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBsb2NhbCBhcGsgZmlsZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBwZ2sgLSBUaGUgbmFtZSBvZiBhcHBsaWNhdGlvbiBwYWNrYWdlLlxuICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBnaXZlbiBhcHBsaWNhdGlvbiBpcyBhbHJlYWR5IHNpZ25lZC5cbiAqL1xuYXBrU2lnbmluZ01ldGhvZHMuY2hlY2tBcGtDZXJ0ID0gYXN5bmMgZnVuY3Rpb24gKGFwaywgcGtnKSB7XG4gIGNvbnN0IGphdmEgPSBnZXRKYXZhRm9yT3MoKTtcbiAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKGFwaykpKSB7XG4gICAgbG9nLmRlYnVnKGBBUEsgZG9lc24ndCBleGlzdC4gJHthcGt9YCk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIGlmICh0aGlzLnVzZUtleXN0b3JlKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuY2hlY2tDdXN0b21BcGtDZXJ0KGFwaywgcGtnKTtcbiAgfVxuICBsb2cuZGVidWcoYENoZWNraW5nIGFwcCBjZXJ0IGZvciAke2Fwa30uYCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYyhqYXZhLCBbJy1qYXInLCBwYXRoLnJlc29sdmUodGhpcy5oZWxwZXJKYXJQYXRoLCAndmVyaWZ5LmphcicpLCBhcGtdKTtcbiAgICBsb2cuZGVidWcoXCJBcHAgYWxyZWFkeSBzaWduZWQuXCIpO1xuICAgIGF3YWl0IHRoaXMuemlwQWxpZ25BcGsoYXBrKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5kZWJ1ZyhcIkFwcCBub3Qgc2lnbmVkIHdpdGggZGVidWcgY2VydC5cIik7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59O1xuXG4vKipcbiAqIENoZWNrIGlmIHRoZSBhcHAgaXMgYWxyZWFkeSBzaWduZWQgd2l0aCBhIGN1c3RvbSBjZXJ0aWZpY2F0ZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgYXBrIGZpbGUuXG4gKiBAcGFyYW0ge3N0cmluZ30gcGdrIC0gVGhlIG5hbWUgb2YgYXBwbGljYXRpb24gcGFja2FnZS5cbiAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgZ2l2ZW4gYXBwbGljYXRpb24gaXMgYWxyZWFkeSBzaWduZWQgd2l0aCBhIGN1c3RvbSBjZXJ0aWZpY2F0ZS5cbiAqL1xuYXBrU2lnbmluZ01ldGhvZHMuY2hlY2tDdXN0b21BcGtDZXJ0ID0gYXN5bmMgZnVuY3Rpb24gKGFwaywgcGtnKSB7XG4gIGxvZy5kZWJ1ZyhgQ2hlY2tpbmcgY3VzdG9tIGFwcCBjZXJ0IGZvciAke2Fwa31gKTtcbiAgbGV0IGggPSBcImEtZkEtRjAtOVwiO1xuICBsZXQgbWQ1U3RyID0gW2AuKk1ENS4qKCg/Olske2h9XXsyfTopezE1fVske2h9XXsyfSlgXTtcbiAgbGV0IG1kNSA9IG5ldyBSZWdFeHAobWQ1U3RyLCAnbWknKTtcbiAgbGV0IGphdmFIb21lID0gZ2V0SmF2YUhvbWUoKTtcbiAgbGV0IGtleXRvb2wgPSBwYXRoLnJlc29sdmUoamF2YUhvbWUsICdiaW4nLCAna2V5dG9vbCcpO1xuICBrZXl0b29sID0gc3lzdGVtLmlzV2luZG93cygpID8gYCR7a2V5dG9vbH0uZXhlYCA6IGtleXRvb2w7XG4gIGxldCBrZXlzdG9yZUhhc2ggPSBhd2FpdCB0aGlzLmdldEtleXN0b3JlTWQ1KGtleXRvb2wsIG1kNSk7XG4gIHJldHVybiBhd2FpdCB0aGlzLmNoZWNrQXBrS2V5c3RvcmVNYXRjaChrZXl0b29sLCBtZDUsIGtleXN0b3JlSGFzaCwgcGtnLCBhcGspO1xufTtcblxuLyoqXG4gKiBHZXQgdGhlIE1ENSBoYXNoIG9mIHRoZSBrZXlzdG9yZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30ga2V5dG9vbCAtIFRoZSBuYW1lIG9mIHRoZSBrZXl0b29sIHV0aWxpdHkuXG4gKiBAcGFyYW0ge1JlZ0V4cH0gbWQ1cmUgLSBUaGUgcGF0dGVybiB1c2VkIHRvIG1hdGNoIHRoZSByZXN1bHQgaW4gX2tleXRvb2xfIG91dHB1dC5cbiAqIEByZXR1cm4gez9zdHJpbmd9IEtleXN0b3JlIE1ENSBoYXNoIG9yIF9udWxsXyBpZiB0aGUgaGFzaCBjYW5ub3QgYmUgcGFyc2VkLlxuICogQHRocm93cyB7RXJyb3J9IElmIGdldHRpbmcga2V5c3RvcmUgTUQ1IGhhc2ggZmFpbHMuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLmdldEtleXN0b3JlTWQ1ID0gYXN5bmMgZnVuY3Rpb24gKGtleXRvb2wsIG1kNXJlKSB7XG4gIGxldCBrZXlzdG9yZUhhc2g7XG4gIGxvZy5kZWJ1ZyhcIlByaW50aW5nIGtleXN0b3JlIG1kNS5cIik7XG4gIHRyeSB7XG4gICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyhrZXl0b29sLCBbJy12JywgJy1saXN0JywgJy1hbGlhcycsIHRoaXMua2V5QWxpYXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAnLWtleXN0b3JlJywgdGhpcy5rZXlzdG9yZVBhdGgsICctc3RvcmVwYXNzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmtleXN0b3JlUGFzc3dvcmRdKTtcbiAgICBrZXlzdG9yZUhhc2ggPSBtZDVyZS5leGVjKHN0ZG91dCk7XG4gICAga2V5c3RvcmVIYXNoID0ga2V5c3RvcmVIYXNoID8ga2V5c3RvcmVIYXNoWzFdIDogbnVsbDtcbiAgICBsb2cuZGVidWcoYEtleXN0b3JlIE1ENTogJHtrZXlzdG9yZUhhc2h9YCk7XG4gICAgcmV0dXJuIGtleXN0b3JlSGFzaDtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBnZXRLZXlzdG9yZU1kNSBmYWlsZWQuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgfVxufTtcblxuLyoqXG4gKiBDaGVjayBpZiB0aGUgTUQ1IGhhc2ggb2YgdGhlIHBhcnRpY3VsYXIgYXBwbGljYXRpb24gbWF0Y2hlcyB0byB0aGUgZ2l2ZW4gaGFzaC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30ga2V5dG9vbCAtIFRoZSBuYW1lIG9mIHRoZSBrZXl0b29sIHV0aWxpdHkuXG4gKiBAcGFyYW0ge1JlZ0V4cH0gbWQ1cmUgLSBUaGUgcGF0dGVybiB1c2VkIHRvIG1hdGNoIHRoZSByZXN1bHQgaW4gX2tleXRvb2xfIG91dHB1dC5cbiAqIEBwYXJhbSB7c3RyaW5nfSBrZXlzdG9yZUhhc2ggLSBUaGUgZXhwZWN0ZWQgaGFzaCB2YWx1ZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBwa2cgLSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFsbGVkIHBhY2thZ2UuXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgZXhpc3RpbmcgYXBrIGZpbGUuXG4gKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGJvdGggaGFzaGVzIGFyZSBlcXVhbC5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBnZXR0aW5nIGtleXN0b3JlIE1ENSBoYXNoIGZhaWxzLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5jaGVja0Fwa0tleXN0b3JlTWF0Y2ggPSBhc3luYyBmdW5jdGlvbiAoa2V5dG9vbCwgbWQ1cmUsIGtleXN0b3JlSGFzaCxcbiAgICBwa2csIGFwaykge1xuICBsZXQgZW50cnlIYXNoID0gbnVsbDtcbiAgbGV0IHJzYSA9IC9eTUVUQS1JTkZcXC8uKlxcLltyUl1bc1NdW2FBXSQvO1xuICBsZXQgZm91bmRLZXlzdG9yZU1hdGNoID0gZmFsc2U7XG5cbiAgLy9mb3IgKGxldCBlbnRyeSBvZiBlbnRyaWVzKSB7XG4gIGF3YWl0IHppcC5yZWFkRW50cmllcyhhcGssIGFzeW5jICh7ZW50cnksIGV4dHJhY3RFbnRyeVRvfSkgPT4ge1xuICAgIGVudHJ5ID0gZW50cnkuZmlsZU5hbWU7XG4gICAgaWYgKCFyc2EudGVzdChlbnRyeSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBFbnRyeTogJHtlbnRyeX1gKTtcbiAgICBsZXQgZW50cnlQYXRoID0gcGF0aC5qb2luKHRoaXMudG1wRGlyLCBwa2csICdjZXJ0Jyk7XG4gICAgbG9nLmRlYnVnKGBlbnRyeVBhdGg6ICR7ZW50cnlQYXRofWApO1xuICAgIGxldCBlbnRyeUZpbGUgPSBwYXRoLmpvaW4oZW50cnlQYXRoLCBlbnRyeSk7XG4gICAgbG9nLmRlYnVnKGBlbnRyeUZpbGU6ICR7ZW50cnlGaWxlfWApO1xuICAgIC8vIGVuc3VyZSAvdG1wL3BrZy9jZXJ0LyBkb2Vzbid0IGV4aXN0IG9yIGV4dHJhY3Qgd2lsbCBmYWlsLlxuICAgIGF3YWl0IGZzLnJpbXJhZihlbnRyeVBhdGgpO1xuICAgIC8vIE1FVEEtSU5GL0NFUlQuUlNBXG4gICAgYXdhaXQgZXh0cmFjdEVudHJ5VG8oZW50cnlQYXRoKTtcbiAgICBsb2cuZGVidWcoXCJleHRyYWN0ZWQhXCIpO1xuICAgIC8vIGNoZWNrIGZvciBtYXRjaFxuICAgIGxvZy5kZWJ1ZyhcIlByaW50aW5nIGFwayBtZDUuXCIpO1xuICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoa2V5dG9vbCwgWyctdicsICctcHJpbnRjZXJ0JywgJy1maWxlJywgZW50cnlGaWxlXSk7XG4gICAgZW50cnlIYXNoID0gbWQ1cmUuZXhlYyhzdGRvdXQpO1xuICAgIGVudHJ5SGFzaCA9IGVudHJ5SGFzaCA/IGVudHJ5SGFzaFsxXSA6IG51bGw7XG4gICAgbG9nLmRlYnVnKGBlbnRyeUhhc2ggTUQ1OiAke2VudHJ5SGFzaH1gKTtcbiAgICBsb2cuZGVidWcoYGtleXN0b3JlIE1ENTogJHtrZXlzdG9yZUhhc2h9YCk7XG4gICAgbGV0IG1hdGNoZXNLZXlzdG9yZSA9IGVudHJ5SGFzaCAmJiBlbnRyeUhhc2ggPT09IGtleXN0b3JlSGFzaDtcbiAgICBsb2cuZGVidWcoYE1hdGNoZXMga2V5c3RvcmU/ICR7bWF0Y2hlc0tleXN0b3JlfWApO1xuXG4gICAgLy8gSWYgd2UgaGF2ZSBhIGtleXN0b3JlIG1hdGNoLCBzdG9wIGl0ZXJhdGluZ1xuICAgIGlmIChtYXRjaGVzS2V5c3RvcmUpIHtcbiAgICAgIGZvdW5kS2V5c3RvcmVNYXRjaCA9IHRydWU7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIGZvdW5kS2V5c3RvcmVNYXRjaDtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGFwa1NpZ25pbmdNZXRob2RzO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
